<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Linux运维笔记">
    <meta name="keyword"  content="sunday,sundayhk,sundayle,sunday博客,Linxu,运维">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
          zabbix 3.4 监控入门实践 - Sunday博客 | Sunday Blog
        
    </title>

    <link rel="canonical" href="http://www.sundayle.com/zabbix-monitor/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">SundayLE</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/archives/">Archives</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    
<!-- Image to hack wechat -->
<!-- <img src="http://www.sundayle.com/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="{{ site.baseurl }}/{% if page.header-img %}{{ page.header-img }}{% else %}{{ site.header-img }}{% endif %}" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        background-image: url('/img/home-bg.jpg')
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                          <a class="tag" href="/tags/#zabbix" title="zabbix">zabbix</a>
                        
                    </div>
                    <h1>zabbix 3.4 监控入门实践</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        Posted by Sunday on
                        2018-05-18
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>zabbix 是一个企业级的分布式开源监控方案，能够监控各种网络参数以及服务器健康性和完整性的软件，支持自定义配置和自定义告警，并且可以实现邮件、短信等方式的告警，<br>zabbix基本组件如下：</p>
<ul>
<li>zabbix_server: zabbix服务端守护进程，所有的监控数据都会统一汇总给server。</li>
<li>zabbix_agentd: 客户端守护进程，负责执行server命令，收集客户端各种参数，如cpu负载，内存，硬盘io等。</li>
<li>zabbix_get: zabbix的一个工具，通常用于从server或者proxy获取远程客户端的信息，以及故障排查等。</li>
<li>zabbix_sender: zabbix的一个工具，用于发送数据给server或者proxy，通常用于耗时比较长的检查。</li>
<li>zabbix_proxy: zabbix代理守护进程，功能类似server，作为中转站将收集到的数据转发给server，主要就是用于分布式集群中分担server的负担，构成类似分布式的server架构，但是最终数据还是要提交给server来汇总。</li>
</ul>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>官方安装<br><a href="https://www.zabbix.com/documentation/3.4/zh/manual/installation/install_from_packages" target="_blank" rel="noopener">https://www.zabbix.com/documentation/3.4/zh/manual/installation/install_from_packages</a><br>这里使用源码安装</p>
<h2 id="下载源代码"><a href="#下载源代码" class="headerlink" title="下载源代码"></a>下载源代码</h2><p><a href="https://www.zabbix.com/download_sources" target="_blank" rel="noopener">https://www.zabbix.com/download_sources</a><br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">tar</span> <span class="selector-tag">xf</span> <span class="selector-tag">zabbix-3</span><span class="selector-class">.4</span><span class="selector-class">.9</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br><span class="line"><span class="selector-tag">cd</span> <span class="selector-tag">zabbix-3</span><span class="selector-class">.4</span><span class="selector-class">.9</span></span><br></pre></td></tr></table></figure></p>
<h2 id="创建用户账户"><a href="#创建用户账户" class="headerlink" title="创建用户账户"></a>创建用户账户</h2><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">groupadd zabbix</span><br><span class="line">useradd -g zabbix zabbix -s <span class="regexp">/sbin/</span><span class="keyword">false</span> -M</span><br></pre></td></tr></table></figure>
<p>注：如果Zabbix server 和 agent 运行在同一台计算机上，建议使用不同的账户运行Server和Agent</p>
<h2 id="要求"><a href="#要求" class="headerlink" title="要求"></a>要求</h2><p>php版本 &gt;=5.4.0<br>php.ini<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">memory_limit = 128M</span><br><span class="line">post_max_size = 16M</span><br><span class="line">upload_max_filesize = 2M</span><br><span class="line">max_execution_time = 300</span><br><span class="line">max_input_time = 300</span><br><span class="line">session.auto_start = 0</span><br><span class="line">mbstring.func_overload = 0</span><br><span class="line">always_populate_raw_post_data = -1</span><br><span class="line">date.timezone = <span class="string">"Asia/Shanghai"</span></span><br></pre></td></tr></table></figure></p>
<h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apt-get install libsnmp-dev libevent-dev libpcre3-dev libcurl4-openssl-dev -y</span><br><span class="line"><span class="string">./configure</span> <span class="params">--prefix=/usr/local/zabbix</span> <span class="params">--enable-server</span> <span class="params">--enable-agent</span> <span class="params">--enable-java</span> <span class="params">--with-mysql</span> <span class="params">--with-net-snmp</span> <span class="params">--with-libcurl</span> <span class="params">--with-libxml2</span> <span class="params">--enable-proxy</span></span><br><span class="line">make -j 4 &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<h2 id="创建zabbix数据库"><a href="#创建zabbix数据库" class="headerlink" title="创建zabbix数据库"></a>创建zabbix数据库</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">授权</span><br><span class="line"> mysql -uroot -p&lt;password&gt;</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> create database zabbix character <span class="built_in">set</span> utf8 collate utf8_bin;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> grant all privileges on zabbix.* to zabbix@localhost identified by <span class="string">'&lt;password&gt;'</span>;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> flush privileges;</span></span><br><span class="line"></span><br><span class="line">cd database/mysql</span><br><span class="line">mysql -uzabbix -hlocalhost -p zabbix &lt; schema.sql</span><br><span class="line">mysql -zabbix  -hlocalhost -p zabbix &lt; images.sql</span><br><span class="line">mysql -zabbix  -hlocalhost -p zabbix &lt; data.sql</span><br></pre></td></tr></table></figure>
<p>导入schema.sql会很久很久，请耐心等候，images.sql,data.sql则很快</p>
<h2 id="启动设置"><a href="#启动设置" class="headerlink" title="启动设置"></a>启动设置</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ln -sv <span class="regexp">/usr/</span>local<span class="regexp">/zabbix/</span>etc <span class="regexp">/etc/</span>zabbix</span><br><span class="line">cp misc<span class="regexp">/init.d/</span>debian<span class="regexp">/&#123;zabbix-agent,zabbix-server&#125; /</span>etc<span class="regexp">/init.d/</span></span><br><span class="line">sed -i <span class="string">'s#DAEMON=/usr/sbin#/usr/local/zabbix/sbin#'</span> <span class="regexp">/etc/</span>init.d/zabbix-agent</span><br><span class="line">sed -i <span class="string">'s#DAEMON=/usr/sbin#/usr/local/zabbix/sbin#'</span> <span class="regexp">/etc/</span>init.d/zabbix-server</span><br></pre></td></tr></table></figure>
<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><p>#配置zabbix_server文件<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/zabbix/zabbix_server.conf</span><br><span class="line">DBHost=localhost    <span class="comment">#数据库所在主机</span></span><br><span class="line">DBName=zabbix       <span class="comment">#数据库名</span></span><br><span class="line">DBUser=zabbix       <span class="comment">#数据库用户</span></span><br><span class="line">DBPassword=123456   <span class="comment">#数据库密码 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#配置zabbix_agent</span></span><br><span class="line">vim /etc/zabbix/zabbix_server.conf</span><br><span class="line">Server=127.0.0.1       修改Server端的IP地址（被动模式IP地址）</span><br><span class="line">ServerActive=127.0.0.1     主动模式，主动向server端报告</span><br><span class="line"><span class="comment">#注：这里本机才指定127.0.0.1,其他客户端需要指定内网IP</span></span><br></pre></td></tr></table></figure></p>
<h2 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h2><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/zabbix_agent <span class="literal">start</span></span><br><span class="line">/etc/init.d/zabbix_server <span class="literal">start</span></span><br></pre></td></tr></table></figure>
<h2 id="前端配置"><a href="#前端配置" class="headerlink" title="前端配置"></a>前端配置</h2><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> <span class="attribute">cp</span> frontends/php /www/web/zabbix -r</span><br><span class="line"></span><br><span class="line"><span class="comment">#nginx.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span> zabbix.sundayle.com; </span><br><span class="line">        <span class="attribute">root</span> /www/web/zabbix/;</span><br><span class="line">        <span class="attribute">index</span> index.php;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> /&#123;</span><br><span class="line">      <span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.php?<span class="variable">$args</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~ \.php$</span> &#123;</span><br><span class="line">        <span class="attribute">try_files</span> <span class="variable">$uri</span> =<span class="number">404</span>;</span><br><span class="line">        <span class="attribute">fastcgi_pass</span> <span class="number">127.0.0.1:9000</span>; </span><br><span class="line">        <span class="attribute">fastcgi_index</span> index.php;</span><br><span class="line">        <span class="attribute">include</span> fastcgi.conf;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">access_log</span> /www/logs/nginx/zabbix.log;</span><br></pre></td></tr></table></figure>
<p><img src="/images/zabbix-setup.jpg" alt="11"><br><img src="/images/zabbix-pre-requisits.jpg" alt="11"><br><img src="/images/zabbix-db-connection.jpg" alt="11"><br><img src="/images/zabbix-server-details.jpg" alt="11"><br><img src="/images/zabbix-summary.jpg" alt="11"><br><img src="/images/zabbix-install-ok.jpg" alt="11"><br><img src="/images/zabbix-login.jpg" alt="11"><br>Zabbix前端已经就绪！默认的用户名是Admin，密码是zabbix.</p>
<h1 id="WEB界面"><a href="#WEB界面" class="headerlink" title="WEB界面"></a>WEB界面</h1><h2 id="激活客户端"><a href="#激活客户端" class="headerlink" title="激活客户端"></a>激活客户端</h2><p><img src="/images/zabbix-enable-agent.jpg" alt="11"></p>
<h2 id="查看cpu负载"><a href="#查看cpu负载" class="headerlink" title="查看cpu负载"></a>查看cpu负载</h2><p><img src="/images/zabbix-cpu-load.jpg" alt="11"></p>
<h2 id="修改密码"><a href="#修改密码" class="headerlink" title="修改密码"></a>修改密码</h2><p><img src="/images/zabbix-password.jpg" alt="11"></p>
<h2 id="设置中文"><a href="#设置中文" class="headerlink" title="设置中文"></a>设置中文</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">上传微软雅黑( msyh.ttf</span><br><span class="line">)到/www/web/zabbix/fonts/</span><br><span class="line"></span><br><span class="line">/www/web/zabbix/<span class="keyword">include</span>/locales.inc.php <span class="comment">#检测启用：true</span></span><br><span class="line"><span class="string">'zh_CN'</span> =&gt; [<span class="string">'name'</span> =&gt; _(<span class="string">'Chinese (zh_CN)'</span>), <span class="string">'display'</span> =&gt; <span class="keyword">true</span>],</span><br><span class="line"><span class="comment">//define('ZBX_FONT_NAME', 'DejaVuSans');</span></span><br><span class="line">define(<span class="string">'ZBX_FONT_NAME'</span>, <span class="string">'msyh'</span>);</span><br><span class="line"></span><br><span class="line"> apt-get install language-pack-zh-hant language-pack-zh-hans</span><br><span class="line"> dpkg-reconfigure locales <span class="comment"># 选择的 en_US.UTF-8/zh_CN.UTF-8 </span></span><br><span class="line"> /etc/init.d/php7 restart</span><br><span class="line"> /etc/init.d/nginx restart</span><br></pre></td></tr></table></figure>
<p><img src="/images/zabbix-chinese.jpg" alt="11"></p>
<h1 id="监控部署"><a href="#监控部署" class="headerlink" title="监控部署"></a>监控部署</h1><p><a href="https://www.zabbix.com/download?zabbix=3.4&amp;os_distribution=ubuntu&amp;os_version=xenial&amp;db=MySQL" target="_blank" rel="noopener">https://www.zabbix.com/download?zabbix=3.4&amp;os_distribution=ubuntu&amp;os_version=xenial&amp;db=MySQL</a></p>
<h2 id="安装客户端-web36"><a href="#安装客户端-web36" class="headerlink" title="安装客户端 web36"></a>安装客户端 web36</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> wget http://repo.zabbix.com/zabbix/3.4/ubuntu/pool/main/z/zabbix-<span class="keyword">release</span>/zabbix-release_3<span class="number">.4</span><span class="number">-1</span>+xenial_all.deb</span><br><span class="line"> dpkg -i zabbix-release_3<span class="number">.4</span><span class="number">-1</span>+xenial_all.deb</span><br><span class="line"> apt <span class="keyword">update</span></span><br><span class="line"> apt <span class="keyword">install</span> zabbix-<span class="keyword">agent</span></span><br><span class="line"> systemctl <span class="keyword">enable</span> zabbix-<span class="keyword">agent</span></span><br><span class="line"> vim /etc/zabbix/zabbix_agent.conf</span><br><span class="line"><span class="keyword">Server</span>=<span class="number">192.168</span><span class="number">.1</span><span class="number">.39</span></span><br><span class="line">ServerActive=<span class="number">192.168</span><span class="number">.1</span><span class="number">.39</span></span><br><span class="line">Hostname=web36</span><br></pre></td></tr></table></figure>
<h1 id="添加监控主机及设置"><a href="#添加监控主机及设置" class="headerlink" title="添加监控主机及设置"></a>添加监控主机及设置</h1><p><img src="/images/zabbix-create-host.jpg" alt="11"><br><img src="/images/zabbix-add-templates.jpg" alt="11"><br><img src="/images/zabbix-green-zbx.jpg" alt="11"></p>
<h1 id="自定义监控-Nginx-Status"><a href="#自定义监控-Nginx-Status" class="headerlink" title="自定义监控 Nginx Status"></a>自定义监控 Nginx Status</h1><p>客户端web36 添加ginx_status.conf配置文件</p>
<blockquote>
<p>cat /etc/nginx/vhost/nginx_status.conf</p>
</blockquote>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span>  <span class="number">80</span>;</span><br><span class="line">  <span class="attribute">server_name</span> localhost;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">location</span> /nginx_status &#123;</span><br><span class="line">    <span class="attribute">stub_status</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">access_log</span> <span class="literal">off</span>;</span><br><span class="line">    <span class="attribute">allow</span> <span class="number">127.0.0.1</span>;</span><br><span class="line">    <span class="attribute">deny</span> all;</span><br><span class="line">  &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查看nginx_status状态</p>
<blockquote>
<p>curl <a href="http://localhost/nginx_status" target="_blank" rel="noopener">http://localhost/nginx_status</a></p>
</blockquote>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Active connections: 7 </span><br><span class="line">server accepts handled requests</span><br><span class="line"> 10956239 10956239 12048178 </span><br><span class="line">Reading: 0 Writing: 1 Waiting: 5</span><br></pre></td></tr></table></figure>
<p>添加Include</p>
<blockquote>
<p>vim /etc/zabbix/zabbix_agentd.conf<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Include</span>=<span class="regexp">/etc/</span>zabbix<span class="regexp">/zabbix_agentd.conf.d/</span>*.conf</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>vim /etc/zabbix/zabbix_agentd.conf.d/scripts/nginx_status.sh<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#auther: sunday</span></span><br><span class="line"><span class="comment">#Date: 2018-05-27</span></span><br><span class="line"></span><br><span class="line">HOST=<span class="string">"localhost"</span></span><br><span class="line">PORT=<span class="string">"80"</span></span><br><span class="line">STATUS=<span class="string">"nginx_status"</span></span><br><span class="line"></span><br><span class="line">[ <span class="variable">$#</span> -ne 1 ] &amp;&amp; <span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> Usage:(active|reading|writing|waiting|accpets|handled|requests)"</span> &amp;&amp; <span class="built_in">exit</span> 0</span><br><span class="line"></span><br><span class="line"><span class="comment">#检测nginx进程是否存在</span></span><br><span class="line"><span class="keyword">function</span> ping &#123;</span><br><span class="line">    /sbin/pidof nginx | wc -l</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment"># 检测nginx性能</span></span><br><span class="line"><span class="keyword">function</span> active &#123;</span><br><span class="line">    /usr/bin/curl <span class="string">"http://<span class="variable">$HOST</span>:<span class="variable">$PORT</span>/<span class="variable">$STATUS</span>/"</span> 2&gt;/dev/null| grep <span class="string">'Active'</span> | awk <span class="string">'&#123;print $NF&#125;'</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">function</span> reading &#123;</span><br><span class="line">    /usr/bin/curl <span class="string">"http://<span class="variable">$HOST</span>:<span class="variable">$PORT</span>/<span class="variable">$STATUS</span>/"</span> 2&gt;/dev/null| grep <span class="string">'Reading'</span>| awk <span class="string">'&#123;print $2&#125;'</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">function</span> writing &#123;</span><br><span class="line">    /usr/bin/curl <span class="string">"http://<span class="variable">$HOST</span>:<span class="variable">$PORT</span>/<span class="variable">$STATUS</span>/"</span> 2&gt;/dev/null| grep <span class="string">'Writing'</span>| awk <span class="string">'&#123;print $4&#125;'</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">function</span> waiting &#123;</span><br><span class="line">    /usr/bin/curl <span class="string">"http://<span class="variable">$HOST</span>:<span class="variable">$PORT</span>/<span class="variable">$STATUS</span>/"</span> 2&gt;/dev/null| grep <span class="string">'Waiting'</span>| awk <span class="string">'&#123;print $6&#125;'</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">function</span> accepts &#123;</span><br><span class="line">    /usr/bin/curl <span class="string">"http://<span class="variable">$HOST</span>:<span class="variable">$PORT</span>/<span class="variable">$STATUS</span>/"</span> 2&gt;/dev/null| awk NR==3 | awk <span class="string">'&#123;print $1&#125;'</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">function</span> handled &#123;</span><br><span class="line">    /usr/bin/curl <span class="string">"http://<span class="variable">$HOST</span>:<span class="variable">$PORT</span>/<span class="variable">$STATUS</span>/"</span> 2&gt;/dev/null| awk NR==3 | awk <span class="string">'&#123;print $2&#125;'</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">function</span> requests &#123;</span><br><span class="line">    /usr/bin/curl <span class="string">"http://<span class="variable">$HOST</span>:<span class="variable">$PORT</span>/<span class="variable">$STATUS</span>/"</span> 2&gt;/dev/null| awk NR==3 | awk <span class="string">'&#123;print $3&#125;'</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">#执行function</span></span><br><span class="line"><span class="variable">$1</span></span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>chmod +x /etc/zabbix/zabbix_agentd.conf.d/scripts/nginx_status.sh<br>cat /etc/zabbix/zabbix_agent.conf.d/nginx_status.conf<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">UserParameter</span>=nginx_status[*],/etc/zabbix/zabbix_agentd.d/scripts/nginx_status.sh <span class="variable">$1</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>修改完配置文件需要重启zabbix-agent<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/etc/i</span>nit.d<span class="regexp">/zabbix-agent restart</span></span><br></pre></td></tr></table></figure></p>
<p>服务端操作<br>zabbix-get测试 是否可以获取到agent上的值<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> zabbix_get -s <span class="number">192.168</span><span class="number">.1</span><span class="number">.36</span> -k 'nginx.status[requests]'</span><br><span class="line"><span class="number">12053819</span></span><br></pre></td></tr></table></figure></p>
<h1 id="创建项目-Item"><a href="#创建项目-Item" class="headerlink" title="创建项目 Item"></a>创建项目 Item</h1><p>Configuration &gt; hosts &gt; Item &gt; Create item<br><img src="/images/zabbix-create-item.jpg" alt="11"><br><img src="/images/zabbix-item-1.jpg" alt="11"><br>Update interval：监控项刷新时间间隔（一般不要低于60秒）<br>Custom intervals：自定义时间间隔<br><img src="/images/zabbix-item-2.jpg" alt="11"><br>History storage period：历史数据存储多久<br>Trend storage perod：趋势图存储多久<br>New application：应用名<br>Populates host inventory field : 资产类型</p>
<p>Configuration &gt; Hosts &gt; items &gt; APPLICATIONS:nginx &gt; Nginx.status[active] &gt; clone<br>修改其他的Name,Key<br><img src="/images/zabbix-nginx1.jpg" alt="11"></p>
<h1 id="创建图形-Graphs"><a href="#创建图形-Graphs" class="headerlink" title="创建图形 Graphs"></a>创建图形 Graphs</h1><p>Configuration &gt; hosts &gt; Graphs<br><img src="/images/zabbix-create-graph.jpg" alt="11"><br><img src="/images/zabbix-graphs-nginx.jpg" alt="11"></p>
<p>ab -c 100 -n 1000 <a href="https://www.sundayhk.com/index.php" target="_blank" rel="noopener">https://www.sundayhk.com/index.php</a><br><img src="/images/zabbix-graphs-nginx-look.jpg" alt="11"></p>
<h1 id="创建聚合图形-Screens"><a href="#创建聚合图形-Screens" class="headerlink" title="创建聚合图形 Screens"></a>创建聚合图形 Screens</h1><p>Monitoring &gt; Screens &gt; Create screen<br><img src="/images/zabbix-create-screen.jpg" alt="11"><br><img src="/images/zabbix-screen-xwx.jpg" alt="11"><br>点击xwx screen &gt; Edit screen<br><img src="/images/zabbix-edit-screen.jpg" alt="11"><br><img src="/images/zabbix-screen-select.jpg" alt="11"><br><img src="/images/zabbix-screen-updated.jpg" alt="11"></p>
<h1 id="编辑地图-Maps"><a href="#编辑地图-Maps" class="headerlink" title="编辑地图 Maps"></a>编辑地图 Maps</h1><p>Monitoring &gt; Maps &gt; Local network &gt; Edit map<br>显示zabbix41输出到zabbix41 网卡网速<br><img src="/images/zabbix-map-addhost1.jpg" alt="11"><br><img src="/images/zabbix-map-line.jpg" alt="11"><br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;web41:net<span class="selector-class">.if</span><span class="selector-class">.out</span>[eno2].last(<span class="number">0</span>)&#125;</span><br><span class="line">web41:主机名</span><br><span class="line">net<span class="selector-class">.if</span><span class="selector-class">.out</span>[out2]: item<span class="selector-class">.key</span> 网卡<span class="number">2</span>输出</span><br><span class="line">last&#123;<span class="number">0</span>&#125; 获取最新数据</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/zabbix-item-key.jpg" alt="11"><br><img src="/images/zabbix-map-network-update.jpg" alt="11"></p>
<h1 id="创建模板"><a href="#创建模板" class="headerlink" title="创建模板"></a>创建模板</h1><p>Configuration &gt; Templates &gt; Create Templates<br><img src="/images/zabbix-create-template.jpg" alt="11"><br><img src="/images/zabbix-templates-nginx-status.jpg" alt="11"><br><img src="/images/zabbix-templates-nginx-status-1.jpg" alt="11"><br><img src="/images/zabbix-templates-nginx-status-2.jpg" alt="11"></p>
<h1 id="中文显示乱码"><a href="#中文显示乱码" class="headerlink" title="中文显示乱码"></a>中文显示乱码</h1><p>zabbix对中文的支持不是很好，但为了管理方面有时候我们还是会选择中文，在zabbix监控的web界面，图形图标下面的中文会显示一个个小方块，这样是不正确的，需要下载字体。<br>如将C:\Windows\Fonts\Microsoft YaHei UI\Microsoft YaHei UI 常规  复制出来命名为”msyh.ttf”上传到/zabbix/fonts/字体下<br>修改/www/web/zabbix/include/defines.inc.php文件中的两处<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">define</span></span>(<span class="string">'ZBX_GRAPH_FONT_NAME'</span>, <span class="string">'DejaVuSans'</span>);</span><br><span class="line"><span class="class"><span class="keyword">define</span></span>(<span class="string">'ZBX_FONT_NAME'</span>, <span class="string">'DejaVuSans'</span>);</span><br></pre></td></tr></table></figure></p>
<p>修改成<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">define</span></span>(<span class="string">'ZBX_GRAPH_FONT_NAME'</span>, <span class="string">'msyh'</span>);</span><br><span class="line"><span class="class"><span class="keyword">define</span></span>(<span class="string">'ZBX_FONT_NAME'</span>, <span class="string">'msyh'</span>);</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/zabbix-chinese-1.jpg" alt="11"><br><img src="/images/zabbix-chinese-2.jpg" alt="11"></p>
<h1 id="安装Graphtree"><a href="#安装Graphtree" class="headerlink" title="安装Graphtree"></a>安装Graphtree</h1><p><a href="https://github.com/OneOaaS/graphtrees" target="_blank" rel="noopener">https://github.com/OneOaaS/graphtrees</a><br>zabbix-web目录:/www/web/zabbix<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd /www/web/zabbix</span><br><span class="line">wget https:<span class="comment">//raw.githubusercontent.com/OneOaaS/graphtrees/master/graphtree3.0.4.patch</span></span><br><span class="line"><span class="selector-id">#yum</span> install patch -y</span><br><span class="line"><span class="selector-id">#apt-get</span> install patch -y</span><br><span class="line">patch  -Np0 &lt;graphtree3.<span class="number">0.4</span>.patch</span><br><span class="line">chown -R www<span class="selector-class">.www</span> oneoaas</span><br></pre></td></tr></table></figure></p>
<p>查看<br>Monitoring &gt; Graphtree<br><img src="/images/zabbix-graphtree1.jpg" alt="11"><br><img src="/images/zabbix-graphtree2.jpg" alt="11"></p>
<h1 id="邮件报警"><a href="#邮件报警" class="headerlink" title="邮件报警"></a>邮件报警</h1><h2 id="设置报警媒介"><a href="#设置报警媒介" class="headerlink" title="设置报警媒介"></a>设置报警媒介</h2><p>Administrator &gt; Media types &gt; email<br><img src="/images/zabbix-email-1.jpg" alt="11"><br><img src="/images/zabbix-email-password.jpg" alt="11"><br><img src="/images/zabbix-email-set.jpg" alt="11"><br><img src="/images/zabbix-email-password2.jpg" alt="11"></p>
<h2 id="设置发送邮件动作"><a href="#设置发送邮件动作" class="headerlink" title="设置发送邮件动作"></a>设置发送邮件动作</h2><p>Configuration &gt; Actions<br><img src="/images/zabbix-actions.jpg" alt="11"><br><img src="/images/zabbix-active-operations.jpg" alt="11"><br><img src="/images/zabbix-action-operations1.jpg" alt="11"><br><img src="/images/zabbix-recovery-messages.jpg" alt="11"><br><img src="/images/zabbix-actions-oprations-edit.jpg" alt="11"></p>
<h2 id="设置收件人"><a href="#设置收件人" class="headerlink" title="设置收件人"></a>设置收件人</h2><p>Administration &gt; User &gt; Admin<br><img src="/images/zabbix-user-admin.jpg" alt="11"><br><img src="/images/zabbix-media-email.jpg" alt="11"></p>
<p>测试：关闭http或监控WEB实例 将200修改201<br><img src="/images/zabbix-web-triggers2.jpg" alt="11"><br><img src="/images/zabbix-qq-mail-1.jpg" alt="11"></p>
<h1 id="邮件报警方式2（脚本）"><a href="#邮件报警方式2（脚本）" class="headerlink" title="邮件报警方式2（脚本）"></a>邮件报警方式2（脚本）</h1><p>zabbix-server操作<br>vim /etc/zabbix/zabbix_server.conf<br>AlertScriptsPath=/etc/zabbix/alertscripts<br><a href="http://localhost:4000/2018/05/22/s-nail/" target="_blank" rel="noopener">邮件配置</a> </p>
<blockquote>
<p>/etc/zabbix/alertscripts# cat mailx.sh</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">email_File=/tmp/email.log</span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">main</span></span>()&#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$3</span>"</span> &gt;<span class="variable">$email_File</span></span><br><span class="line">        /usr/bin/dos2unix <span class="variable">$email_File</span></span><br><span class="line">        /usr//bin/mailx -s <span class="string">"<span class="variable">$2</span>"</span> <span class="string">"<span class="variable">$1</span>"</span> &lt;<span class="variable">$email_File</span></span><br><span class="line">&#125;</span><br><span class="line">main <span class="string">"<span class="variable">$1</span>"</span> <span class="string">"<span class="variable">$2</span>"</span> <span class="string">"<span class="variable">$3</span>"</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>chmod +x /etc/zabbix/alertscripts/mailx.sh<br>chown zabbix.zabbix /etc/zabbix/alertscripts/mailx.sh</p>
</blockquote>
<h2 id="创建媒体"><a href="#创建媒体" class="headerlink" title="创建媒体"></a>创建媒体</h2><p>Administration&gt; Media types&gt; Create media type<br><img src="/images/mail-email-shell.jpg" alt="11"></p>
<h2 id="用户选择媒体"><a href="#用户选择媒体" class="headerlink" title="用户选择媒体"></a>用户选择媒体</h2><p>Administration&gt; Users&gt; Admin<br><img src="/images/zabbix-media-mailx.jpg" alt="11"></p>
<h2 id="条件和媒体选择"><a href="#条件和媒体选择" class="headerlink" title="条件和媒体选择"></a>条件和媒体选择</h2><p><img src="/images/zabbix-actions-conditions2.jpg" alt="11"><br><img src="/images/zabbix-actions-mailx-send.jpg" alt="11"></p>
<h2 id="设置动作"><a href="#设置动作" class="headerlink" title="设置动作"></a>设置动作</h2><p>Configuration&gt; Actions&gt;  Report problems to Zabbix administrators</p>
<h1 id="微信报警"><a href="#微信报警" class="headerlink" title="微信报警"></a>微信报警</h1><h2 id="微信企业号申请"><a href="#微信企业号申请" class="headerlink" title="微信企业号申请"></a>微信企业号申请</h2><p>注册微信企业号（团队类型） 点击注册   或    注册企业号微信 <a href="https://work.weixin.qq.com/）
![11](/images/qyweixin.jpg" target="_blank" rel="noopener">点击注册</a></p>
<h2 id="安装组件"><a href="#安装组件" class="headerlink" title="安装组件"></a>安装组件</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apt <span class="keyword">install</span> python-pip</span><br><span class="line">pip <span class="keyword">install</span> apt <span class="keyword">install</span> python-pip</span><br><span class="line">pip <span class="keyword">install</span> requests</span><br></pre></td></tr></table></figure>
<p>下载wechat.py<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone http<span class="variable">s:</span>//github.<span class="keyword">com</span>/<span class="keyword">X</span>-Mars/Zabbix-Alert-WeChat.git</span><br><span class="line"><span class="keyword">cp</span> Zabbix-Alert-WeChat/wechat.<span class="keyword">py</span> /etc/zabbix/alertscripts/</span><br><span class="line">chmod +<span class="keyword">x</span> wechat.<span class="keyword">py</span> &amp;&amp; chown zabbix:zabbix wechat.<span class="keyword">py</span></span><br></pre></td></tr></table></figure></p>
<h2 id="调试wechat-py"><a href="#调试wechat-py" class="headerlink" title="调试wechat.py"></a>调试wechat.py</h2><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python2.7</span></span><br><span class="line"><span class="comment">#_*_coding:utf-8 _*_</span></span><br><span class="line"><span class="comment">#auther:火星小刘</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">import</span> requests,sys,json</span><br><span class="line"><span class="built_in">import</span> urllib3</span><br><span class="line">urllib3.disable_warnings()</span><br><span class="line"></span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding('utf-<span class="number">8</span>')</span><br><span class="line"></span><br><span class="line">def GetToken(Corpid,Secret):</span><br><span class="line">    <span class="attr">Url</span> = <span class="string">"https://qyapi.weixin.qq.com/cgi-bin/gettoken"</span></span><br><span class="line">    <span class="attr">Data</span> = &#123;</span><br><span class="line">        <span class="string">"corpid"</span>:Corpid,</span><br><span class="line">        <span class="string">"corpsecret"</span>:Secret</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attr">r</span> = requests.get(<span class="attr">url=Url,params=Data,verify=False)</span></span><br><span class="line">    <span class="attr">Token</span> = r.json()['access_token']</span><br><span class="line">    return Token</span><br><span class="line"></span><br><span class="line">def SendMessage(Token,User,Agentid,Subject,Content):</span><br><span class="line">    <span class="attr">Url</span> = <span class="string">"https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=%s"</span> % Token</span><br><span class="line">    <span class="attr">Data</span> = &#123;</span><br><span class="line">        <span class="string">"touser"</span>: <span class="string">"shaopeng0329"</span>,                       <span class="comment"># 企业号中的微信帐号，在zabbix用户Media中配置，如果配置不正常，将按部门发送。（修改1）</span></span><br><span class="line">        <span class="comment">#"totag": Tagid,                                # 企业号中的部门id，群发时使用。</span></span><br><span class="line">        <span class="string">"msgtype"</span>: <span class="string">"text"</span>,                              <span class="comment"># 消息类型。</span></span><br><span class="line">        <span class="string">"agentid"</span>: <span class="number">1</span>,                                   <span class="comment"># 企业号中的应用id。（修改2）</span></span><br><span class="line">        <span class="string">"text"</span>: &#123;</span><br><span class="line">            <span class="string">"content"</span>: Subject + '\n' + Content</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"safe"</span>: <span class="string">"0"</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attr">r</span> = requests.post(<span class="attr">url=Url,data=json.dumps(Data),verify=False)</span></span><br><span class="line">    return r.text</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="attr">__name__</span> == '__main__':</span><br><span class="line">    <span class="attr">User</span> = sys.argv[<span class="number">1</span>]                                                              <span class="comment"># zabbix传过来的第一个参数</span></span><br><span class="line">    <span class="attr">Subject</span> = sys.argv[<span class="number">2</span>]                                                           <span class="comment"># zabbix传过来的第二个参数</span></span><br><span class="line">    <span class="attr">Content</span> = sys.argv[<span class="number">3</span>]                                                           <span class="comment"># zabbix传过来的第三个参数</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">Corpid</span> = <span class="string">"wx588xxxxxc708f28e"</span>                                                    <span class="comment"># CorpID是企业号的标识 （修改3）</span></span><br><span class="line">    <span class="attr">Secret</span> = <span class="string">"2maj0M2TBRfGlx3vs8AEOexxxxxxxxxxx2fsC-2Clk4BBFyBe6ugz1AQ"</span>              <span class="comment"># Secret是管理组凭证密钥 （修改4）</span></span><br><span class="line">    <span class="comment">#Tagid = "1"                                                                     # 通讯录标签ID</span></span><br><span class="line">    <span class="attr">Agentid</span> = <span class="string">"2"</span>                                                                    <span class="comment"># 应用ID （修改5）</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">Token</span> = GetToken(Corpid, Secret)</span><br><span class="line">    <span class="attr">Status</span> = SendMessage(Token,User,Agentid,Subject,Content)</span><br><span class="line">    print Status</span><br></pre></td></tr></table></figure>
<p>修改1-5<br>测试</p>
<blockquote>
<p> /etc/zabbix/alertscripts# python wechat.py sunday hello world<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">"errcode"</span>:<span class="number">0</span>,<span class="string">"errmsg"</span>:<span class="string">"ok"</span>,<span class="string">"invaliduser"</span>:<span class="string">""</span>&#125;</span><br><span class="line"><span class="meta">#三个参数（sunday hello world）可以随意。</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<p><img src="/images/zabbix-weixin-helloworld.jpg" alt="11"></p>
<h2 id="微信企业号设置"><a href="#微信企业号设置" class="headerlink" title="微信企业号设置"></a>微信企业号设置</h2><p>通讯录设置<br>登陆微信企业号控制台<br>点击左侧“通讯录”，新增部门（技术部）与子部门（运维部），并添加用户<br>点击（运维部）后方的三角，修改部门，记录部门ID<br><img src="/images/zabbix-weixin-id2.jpg" alt="11"></p>
<p>创建应用<br>点击左侧“企业应用”，创建应用，应用名称为“zabbix报警”<br>点击“zabbix报警”,“可见范围”，添加刚刚新建的子部门（运维部）<br>记录Agentld和Secret<br><img src="/images/zabbix-weixin-app-info.jpg" alt="11"></p>
<p>应用权限设置<br>点击左侧“我的企业”，权限管理，新建管理组，名称填写“zabbix报警组”<br>点击修改“通讯录权限”，勾选（技术部）后方的管理<br>点击修改“应用权限”，勾选刚刚创建的“zabbix报警”<br>点击刚刚创建的“zabbix报警组”，记录Secret<br><img src="/images/zabbix-weixin-qx.jpg" alt="11"><br><img src="/images/zabbix-weixin-authority.jpg" alt="11"></p>
<p>我的企业 企业信息 记录CorpID<br><img src="/images/zabbix-weixin-corpid.jpg" alt="11"></p>
<p>收集微信相关信息<br>成员账号<br>记录应用ID<br>记录CorpID与Secret<br>记录子部门（运维部）ID</p>
<h2 id="修改zabbix-conf"><a href="#修改zabbix-conf" class="headerlink" title="修改zabbix.conf"></a>修改zabbix.conf</h2><blockquote>
<p>vim /etc/zabbix/zabbix_server.conf<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">AlertScriptsPath</span>=/etc/zabbix/alertscripts</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>/etc/init.d/zabbix-server restart </p>
</blockquote>
<h2 id="zabbix-web设置"><a href="#zabbix-web设置" class="headerlink" title="zabbix web设置"></a>zabbix web设置</h2><p>添加示警媒介<br>Administration&gt; Media types&gt;　Create media types<br>名称填写wechat，类型选择脚本，脚本名称填写wechat.py<br><img src="/images/zabbix-weixin-media.jpg" alt="11">}<br>Administration&gt; User&gt; Admin&gt; Media<br>类型选择wechat，收件人添加微信企业号通讯录内的微信帐号</p>
<blockquote>
<p>注：若使用其他用户使用wechat,请设置User Groups: Zabbix administrators,Permissions: Zabbix Super Admin,要不然无法wechat.py。</p>
</blockquote>
<p>当然最简单就是使用Admin啦。</p>
<p><img src="/images/zabbix-weixin-user-media.jpg" alt="11"></p>
<p>Configuration&gt; Actions&gt; Create action<br><img src="/images/zabbix-weixin-action.jpg" alt="11"><br>故障信息与恢复信息：<br><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Hostname: &#123;HOST.NAME&#125;</span><br><span class="line"><span class="keyword">Time:</span> &#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125;</span><br><span class="line">Level: &#123;TRIGGER.SEVERITY&#125;</span><br><span class="line">Message: &#123;TRIGGER.NAME&#125;</span><br><span class="line">Event: &#123;ITEM.NAME&#125;:&#123;ITEM.VALUE&#125;</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/zabbix-weixin-action-operations.jpg" alt="11"><br><img src="/images/zabbix-weixin-action-recovery.jpg" alt="11"></p>
<h1 id="监控TCP状态"><a href="#监控TCP状态" class="headerlink" title="监控TCP状态"></a>监控TCP状态</h1><p>cat /etc/zabbix/zabbix_agentd.d/scripts/tcp_status.sh</p>
<h2 id="tcp-status-shell-脚本"><a href="#tcp-status-shell-脚本" class="headerlink" title="tcp_status shell 脚本"></a>tcp_status shell 脚本</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#Author: sunday</span></span><br><span class="line"><span class="comment">#Date: 2018-06-17</span></span><br><span class="line"><span class="comment">#Description: monitor tcp status</span></span><br><span class="line">LOGFILE=<span class="string">'/tmp/tcp_status.txt'</span></span><br><span class="line">[ <span class="variable">$#</span> -ne 1 ] &amp;&amp; <span class="built_in">echo</span> <span class="string">"USAGE:<span class="variable">$0</span> (CLOSE-WAIT|CLOSED|CLOSING|ESTAB|FIN-WAIT-1|FIN-WAIT-2|LAST-ACK|LISTEN|SYN-RECV|SYN-SENT|TIME-WAIT)"</span> &amp;&amp; <span class="built_in">exit</span> 1</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">TCP_STATUS_FUN</span></span>()&#123;</span><br><span class="line">   ss -ant | awk <span class="string">'NR&gt;1 &#123;++S[$1]&#125; END &#123;for (k in S) print a,S[a]&#125;'</span> &gt; <span class="variable">$LOGFILE</span></span><br><span class="line">   TCP_VALUE=$(grep <span class="string">"<span class="variable">$1</span>"</span> <span class="variable">$LOGFILE</span> | cut -d <span class="string">' '</span> -f2)</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$TCP_VALUE</span>"</span> ];<span class="keyword">then</span></span><br><span class="line">      TCP_VALUE=0</span><br><span class="line">   <span class="keyword">fi</span></span><br><span class="line">   </span><br><span class="line">   <span class="built_in">echo</span> <span class="variable">$TCP_VALUE</span></span><br><span class="line">&#125;</span><br><span class="line">TCP_STATUS_FUN <span class="variable">$1</span>;</span><br></pre></td></tr></table></figure>
<p>添加执行权限</p>
<blockquote>
<p>chmod +x /etc/zabbix/zabbix_agentd.d/scripts/tcp_status.sh</p>
</blockquote>
<h2 id="tcp-status-conf-配置"><a href="#tcp-status-conf-配置" class="headerlink" title="tcp_status.conf 配置"></a>tcp_status.conf 配置</h2><blockquote>
<p>cat /etc/zabbix/zabbix_agentd.d/tcp_status.conf<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">UserParameter</span>=tcp_status[*],/etc/zabbix/zabbix_agentd.d/scripts/tcp_status.sh <span class="string">"<span class="variable">$1</span>"</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="重启-zabbbix-agent-修改配置文件重启才会生效的"><a href="#重启-zabbbix-agent-修改配置文件重启才会生效的" class="headerlink" title="重启 zabbbix-agent 修改配置文件重启才会生效的"></a>重启 zabbbix-agent 修改配置文件重启才会生效的</h2><blockquote>
<p>systemctl restart zabbix-agent</p>
</blockquote>
<h2 id="server测试获取agent值"><a href="#server测试获取agent值" class="headerlink" title="server测试获取agent值"></a>server测试获取agent值</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">zabbix_get</span> <span class="selector-tag">-s</span> 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.36</span> <span class="selector-tag">-k</span> <span class="selector-tag">tcp_status</span><span class="selector-attr">[LISTEN]</span></span><br><span class="line"><span class="selector-tag">LISTEN</span> 17</span><br></pre></td></tr></table></figure>
<h2 id="导入模板-3-4-关联主机"><a href="#导入模板-3-4-关联主机" class="headerlink" title="导入模板(3.4) 关联主机"></a>导入模板(3.4) 关联主机</h2><p><a href="https://github.com/sundayle/Zabbix/blob/master/zabbix_agentd.d/templates/zbx_export_templates_tcp_status.xml" target="_blank" rel="noopener">https://github.com/sundayle/Zabbix/blob/master/zabbix_agentd.d/templates/zbx_export_templates_tcp_status.xml</a><br><img src="/images/Snipaste_2018-06-27_14-41-13.jpg" alt="11"></p>
<h2 id="压力测试"><a href="#压力测试" class="headerlink" title="压力测试"></a>压力测试</h2><blockquote>
<p>ab -c 1000 -n 10000 <a href="http://www.sundayle.com/index.php">http://www.sundayle.com/index.php</a></p>
</blockquote>
<h2 id="图表效果"><a href="#图表效果" class="headerlink" title="图表效果"></a>图表效果</h2><p><img src="/images/Snipaste_2018-06-27_14-43-51.jpg" alt="11"></p>
<h1 id="监控Nginx-Status"><a href="#监控Nginx-Status" class="headerlink" title="监控Nginx Status"></a>监控Nginx Status</h1><h2 id="启用Nginx-Status"><a href="#启用Nginx-Status" class="headerlink" title="启用Nginx Status"></a>启用Nginx Status</h2><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">cat</span> /etc/nginx/vhost/nginx_status.conf</span><br><span class="line">server &#123;</span><br><span class="line">  <span class="attribute">listen</span>  <span class="number">80</span>;</span><br><span class="line">  <span class="attribute">server_name</span> localhost;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">location</span> /nginx_status &#123;</span><br><span class="line">    <span class="attribute">stub_status</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">access_log</span> <span class="literal">off</span>;</span><br><span class="line">    <span class="attribute">allow</span> <span class="number">127.0.0.1</span>;</span><br><span class="line">    <span class="attribute">deny</span> all;</span><br><span class="line">  &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="访问Nginx-Status"><a href="#访问Nginx-Status" class="headerlink" title="访问Nginx Status"></a>访问Nginx Status</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="string">http:</span><span class="comment">//localhost/nginx_status</span></span><br><span class="line">Active <span class="string">connections:</span> <span class="number">2</span> </span><br><span class="line">server accepts handled requests</span><br><span class="line"> <span class="number">14495358</span> <span class="number">14495358</span> <span class="number">16049208</span> </span><br><span class="line"><span class="string">Reading:</span> <span class="number">0</span> <span class="string">Writing:</span> <span class="number">2</span> <span class="string">Waiting:</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>
<h2 id="Nginx状态解释"><a href="#Nginx状态解释" class="headerlink" title="Nginx状态解释"></a>Nginx状态解释</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Active connections  Nginx正处理的活动链接数1个</span><br><span class="line">server              Nginx启动到现在共处理了1个连接。</span><br><span class="line">accepts             Nginx启动到现在共成功创建1次握手。 </span><br><span class="line">handled requests    Nginx总共处理了1次请求。</span><br><span class="line">Reading             Nginx读取到客户端的 Header 信息数。</span><br><span class="line">Writing             Nginx返回给客户端的 Header 信息数。</span><br><span class="line">Waiting             Nginx已经处理完正在等候下一次请求指令的驻留链接，开启。</span><br><span class="line"></span><br><span class="line">Keep-alive的情况下，这个值等于active-（reading + writing）。</span><br><span class="line">请求丢失数=(握手数-连接数)可以看出,本次状态显示没有丢失请求。</span><br></pre></td></tr></table></figure>
<h2 id="Nginx-Status脚本"><a href="#Nginx-Status脚本" class="headerlink" title="Nginx Status脚本"></a>Nginx Status脚本</h2><blockquote>
<p>cat /etc/zabbix/zabbix_agentd.d/scripts/nginx_status.sh</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#auther: sunday</span></span><br><span class="line"><span class="comment">#Date: 2018-05-27</span></span><br><span class="line"></span><br><span class="line">HOST=<span class="string">"localhost"</span></span><br><span class="line">PORT=<span class="string">"80"</span></span><br><span class="line">STATUS=<span class="string">"nginx_status"</span></span><br><span class="line"></span><br><span class="line">[ <span class="variable">$#</span> -ne 1 ] &amp;&amp; <span class="built_in">echo</span> <span class="string">"Usage:(active|reading|writing|waiting|accpets|handled|requests)"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#检测nginx进程是否存在</span></span><br><span class="line"><span class="keyword">function</span> ping &#123;</span><br><span class="line">    /sbin/pidof nginx | wc -l</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment"># 检测nginx性能</span></span><br><span class="line"><span class="keyword">function</span> active &#123;</span><br><span class="line">    /usr/bin/curl <span class="string">"http://<span class="variable">$HOST</span>:<span class="variable">$PORT</span>/<span class="variable">$STATUS</span>/"</span> 2&gt;/dev/null| grep <span class="string">'Active'</span> | awk <span class="string">'&#123;print $NF&#125;'</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">function</span> reading &#123;</span><br><span class="line">    /usr/bin/curl <span class="string">"http://<span class="variable">$HOST</span>:<span class="variable">$PORT</span>/<span class="variable">$STATUS</span>/"</span> 2&gt;/dev/null| grep <span class="string">'Reading'</span>| awk <span class="string">'&#123;print $2&#125;'</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">function</span> writing &#123;</span><br><span class="line">    /usr/bin/curl <span class="string">"http://<span class="variable">$HOST</span>:<span class="variable">$PORT</span>/<span class="variable">$STATUS</span>/"</span> 2&gt;/dev/null| grep <span class="string">'Writing'</span>| awk <span class="string">'&#123;print $4&#125;'</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">function</span> waiting &#123;</span><br><span class="line">    /usr/bin/curl <span class="string">"http://<span class="variable">$HOST</span>:<span class="variable">$PORT</span>/<span class="variable">$STATUS</span>/"</span> 2&gt;/dev/null| grep <span class="string">'Waiting'</span>| awk <span class="string">'&#123;print $6&#125;'</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">function</span> accepts &#123;</span><br><span class="line">    /usr/bin/curl <span class="string">"http://<span class="variable">$HOST</span>:<span class="variable">$PORT</span>/<span class="variable">$STATUS</span>/"</span> 2&gt;/dev/null| awk NR==3 | awk <span class="string">'&#123;print $1&#125;'</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">function</span> handled &#123;</span><br><span class="line">    /usr/bin/curl <span class="string">"http://<span class="variable">$HOST</span>:<span class="variable">$PORT</span>/<span class="variable">$STATUS</span>/"</span> 2&gt;/dev/null| awk NR==3 | awk <span class="string">'&#123;print $2&#125;'</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">function</span> requests &#123;</span><br><span class="line">    /usr/bin/curl <span class="string">"http://<span class="variable">$HOST</span>:<span class="variable">$PORT</span>/<span class="variable">$STATUS</span>/"</span> 2&gt;/dev/null| awk NR==3 | awk <span class="string">'&#123;print $3&#125;'</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">#执行function</span></span><br><span class="line"><span class="variable">$1</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>chmod +x /etc/zabbix/zabbix_agentd.d/scripts/nginx_status.sh</p>
</blockquote>
<h2 id="监控项nginx-status-conf配置"><a href="#监控项nginx-status-conf配置" class="headerlink" title="监控项nginx_status.conf配置"></a>监控项nginx_status.conf配置</h2><blockquote>
<p>cat /etc/zabbix/zabbix_agentd.d/nginx_status.conf<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">UserParameter</span>=nginx_status[*],/etc/zabbix/zabbix_agentd.d/scripts/nginx_status.sh <span class="variable">$1</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="重启zabbix-agent"><a href="#重启zabbix-agent" class="headerlink" title="重启zabbix_agent"></a>重启zabbix_agent</h2><blockquote>
<p>systemctl restart zabbix-agent</p>
</blockquote>
<h2 id="Server-zabbix-get-获取值"><a href="#Server-zabbix-get-获取值" class="headerlink" title="Server zabbix_get 获取值"></a>Server zabbix_get 获取值</h2><blockquote>
<p>zabbix_get -s 192.168.1.36 -k nginx_status[accepts]<br>14496190</p>
</blockquote>
<h2 id="导入模板-关联主机"><a href="#导入模板-关联主机" class="headerlink" title="导入模板 关联主机"></a>导入模板 关联主机</h2><p><a href="https://github.com/sundayle/Zabbix/blob/master/zabbix_agentd.d/templates/zbx_export_templates_tcp_status.xml" target="_blank" rel="noopener">https://github.com/sundayle/Zabbix/blob/master/zabbix_agentd.d/templates/zbx_export_templates_tcp_status.xml</a><br><img src="/images/Snipaste_2018-06-27_16-27-46.jpg" alt="11"></p>
<h2 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h2><p><img src="/images/Snipaste_2018-06-27_16-26-03.jpg" alt="11"></p>
<h1 id="监控Redis"><a href="#监控Redis" class="headerlink" title="监控Redis"></a>监控Redis</h1><h2 id="监控脚本"><a href="#监控脚本" class="headerlink" title="监控脚本"></a>监控脚本</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line">#auther: sunday</span><br><span class="line">#date: 2018-06-29</span><br><span class="line"></span><br><span class="line">R_COMMAND=&quot;$1&quot;</span><br><span class="line">R_CLI=&quot;/usr/local/webserver/redis/bin/redis-cli&quot;</span><br><span class="line">R_PORT=&quot;6379&quot;  #根据实际情况调整端口</span><br><span class="line">R_HOST=&quot;127.0.0.1&quot;  #根据具体情况调整IP地址</span><br><span class="line">PASSWD=&quot;u31K+e07GyJ4gvYw+Rx5V417ly46oMq3Heh+n7Em2VsQ6/m6Tfyq+Q=&quot;    #如果没有设置Redis密码,为空即可</span><br><span class="line"></span><br><span class="line">[ $# -ne 1 ] &amp;&amp; echo &quot;$0 Usage:(use_cpu_sys|used_cpu_user|used_cpu_sys_children|used_cpu_user_children|.....)&quot; &amp;&amp; exit 0</span><br><span class="line"></span><br><span class="line">REDIS_INFO()&#123;</span><br><span class="line">   $R_CLI -h $R_HOST -p $R_PORT -a $PASSWD info</span><br><span class="line">&#125;</span><br><span class="line">case $R_COMMAND in</span><br><span class="line"># Server</span><br><span class="line">    uptime_in_seconds)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    uptime_in_days)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    lru_clock)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line"># Clients</span><br><span class="line">    connected_clients)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    client_longest_output_list)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    client_biggest_input_buf)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    blocked_clients)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line"># Memory</span><br><span class="line">    used_memory)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos; | awk &apos;NR==1&apos;</span><br><span class="line">    ;;</span><br><span class="line">    used_memory_rss)</span><br><span class="line">    REDIS_INFO | grep -w &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos; </span><br><span class="line">    ;;</span><br><span class="line">    used_memory_peak)</span><br><span class="line">    REDIS_INFO | grep -w &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    used_memory_lua)</span><br><span class="line">    REDIS_INFO | grep -w &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    mem_fragmentation_ratio)</span><br><span class="line">    REDIS_INFO | grep -w &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line"># RDB</span><br><span class="line">    rdb_changes_since_last_save)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    rdb_bgsave_in_progress)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    rdb_last_save_time)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    rdb_last_bgsave_status)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos; | grep -c ok</span><br><span class="line">    ;;</span><br><span class="line">    rdb_last_bgsave_time_sec)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    rdb_current_bgsave_time_sec)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line"># AOF</span><br><span class="line">    aof_enabled)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    aof_rewrite_in_progress)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    aof_rewrite_scheduled)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    aof_last_rewrite_time_sec)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    aof_current_rewrite_time_sec)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    aof_last_bgrewrite_status)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos; | grep -c ok</span><br><span class="line">    ;;</span><br><span class="line">    aof_last_write_status)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos; | grep -c ok</span><br><span class="line">    ;;</span><br><span class="line"># Stats</span><br><span class="line">    total_connections_received)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    total_commands_processed)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    instantaneous_ops_per_sec)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    total_net_input_bytes)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    total_net_output_bytes)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    instantaneous_input_kbps)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    instantaneous_output_kbps)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    rejected_connections)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    sync_full)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    sync_partial_ok)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    sync_partial_err)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    expired_keys)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    evicted_keys)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    keyspace_hits)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    keyspace_misses)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    pubsub_channels)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    pubsub_patterns)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    latest_fork_usec)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    migrate_cached_sockets)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line"># Replication</span><br><span class="line">    repl_role)</span><br><span class="line">    REDIS_INFO | grep &quot;role&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos; | grep -c &apos;master&apos;</span><br><span class="line">    ;;</span><br><span class="line">    repl_connected_slaves)</span><br><span class="line">    REDIS_INFO | grep &quot;connected_slaves&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    repl_master_repl_offset)</span><br><span class="line">    REDIS_INFO | grep &quot;master_repl_offset&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    repl_backlog_active)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    repl_backlog_size)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    repl_backlog_first_byte_offset)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    repl_backlog_histlen)</span><br><span class="line">    REDIS_INFO | grep &quot;$R_COMMAND&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line"># KeySpace</span><br><span class="line">    keys)</span><br><span class="line">    REDIS_INFO | grep -w &quot;$R_COMMAND&quot; | awk -F&apos;=|,&apos; &apos;&#123;print $2&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    expires)</span><br><span class="line">    REDIS_INFO | grep -w &quot;$R_COMMAND&quot; | awk -F&apos;=|,&apos; &apos;&#123;print $4&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    avg_ttl)</span><br><span class="line">    REDIS_INFO | grep -w &quot;$R_COMMAND&quot; | awk -F&apos;=|,&apos; &apos;&#123;print $6&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line"># CPU</span><br><span class="line">    used_cpu_sys)</span><br><span class="line">    REDIS_INFO | grep -w &quot;used_cpu_sys&quot; | awk -F&apos;:&apos; &apos;&#123;print $2&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    used_cpu_user)</span><br><span class="line">    REDIS_INFO | grep -w &quot;used_cpu_user&quot; | awk -F&apos;:&apos; &apos;&#123;print $2&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    used_cpu_sys_children)</span><br><span class="line">    REDIS_INFO | grep -w &quot;used_cpu_sys_children&quot; | awk -F&apos;:&apos; &apos;&#123;print $2&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    used_cpu_user_children)</span><br><span class="line">    REDIS_INFO | grep -w &quot;used_cpu_user_children&quot; | awk -F&apos;:&apos; &apos;&#123;print $2&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line"># Cluster</span><br><span class="line">    cluster)</span><br><span class="line">    REDIS_INFO | grep &quot;cluster&quot; | awk -F&apos;:&apos; &apos;&#123;print $NF&#125;&apos;</span><br><span class="line">    ;;</span><br><span class="line">    *)</span><br><span class="line">    esac</span><br></pre></td></tr></table></figure>
<h2 id="Redis状态参数解释"><a href="#Redis状态参数解释" class="headerlink" title="Redis状态参数解释"></a>Redis状态参数解释</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">server :</span> Redis 服务器信息，包含以下域：</span><br><span class="line"><span class="string">redis_version :</span> Redis 服务器版本</span><br><span class="line"><span class="string">redis_git_sha1 :</span> Git SHA1</span><br><span class="line"><span class="string">redis_git_dirty :</span> Git dirty flag</span><br><span class="line"><span class="string">os :</span> Redis 服务器的宿主操作系统</span><br><span class="line"><span class="string">arch_bits :</span> 架构（<span class="number">32</span> 或 <span class="number">64</span> 位）</span><br><span class="line"><span class="string">multiplexing_api :</span> Redis 所使用的事件处理机制</span><br><span class="line"><span class="string">gcc_version :</span> 编译 Redis 时所使用的 GCC 版本</span><br><span class="line"><span class="string">process_id :</span> 服务器进程的 PID</span><br><span class="line"><span class="string">run_id :</span> Redis 服务器的随机标识符（用于 Sentinel 和集群）</span><br><span class="line"><span class="string">tcp_port :</span> TCP/IP 监听端口</span><br><span class="line"><span class="string">uptime_in_seconds :</span> 自 Redis 服务器启动以来，经过的秒数</span><br><span class="line"><span class="string">uptime_in_days :</span> 自 Redis 服务器启动以来，经过的天数</span><br><span class="line"><span class="string">lru_clock :</span> 以分钟为单位进行自增的时钟，用于 LRU 管理</span><br><span class="line"><span class="string">clients :</span> 已连接客户端信息，包含以下域：</span><br><span class="line"><span class="string">connected_clients :</span> 已连接客户端的数量（不包括通过从属服务器连接的客户端）</span><br><span class="line"><span class="string">client_longest_output_list :</span> 当前连接的客户端当中，最长的输出列表</span><br><span class="line"><span class="string">client_longest_input_buf :</span> 当前连接的客户端当中，最大输入缓存</span><br><span class="line"><span class="string">blocked_clients :</span> 正在等待阻塞命令（BLPOP、BRPOP、BRPOPLPUSH）的客户端的数量</span><br><span class="line"><span class="string">memory :</span> 内存信息，包含以下域：</span><br><span class="line"><span class="string">used_memory :</span> 由 Redis 分配器分配的内存总量，以字节（<span class="keyword">byte</span>）为单位</span><br><span class="line"><span class="string">used_memory_human :</span> 以人类可读的格式返回 Redis 分配的内存总量</span><br><span class="line"><span class="string">used_memory_rss :</span> 从操作系统的角度，返回 Redis 已分配的内存总量（俗称常驻集大小）。这个值和 top 、 ps 等命令的输出一致。</span><br><span class="line"><span class="string">used_memory_peak :</span> Redis 的内存消耗峰值（以字节为单位）</span><br><span class="line"><span class="string">used_memory_peak_human :</span> 以人类可读的格式返回 Redis 的内存消耗峰值</span><br><span class="line"><span class="string">used_memory_lua :</span> Lua 引擎所使用的内存大小（以字节为单位）</span><br><span class="line"><span class="string">mem_fragmentation_ratio :</span> used_memory_rss 和 used_memory 之间的比率</span><br><span class="line"><span class="string">persistence :</span> RDB 和 AOF 的相关信息</span><br><span class="line"><span class="string">stats :</span> 一般统计信息</span><br><span class="line"><span class="string">replication :</span> 主/从复制信息</span><br><span class="line"><span class="string">cpu :</span> CPU 计算量统计信息</span><br><span class="line"><span class="string">commandstats :</span> Redis 命令统计信息</span><br><span class="line"><span class="string">cluster :</span> Redis 集群信息</span><br><span class="line"><span class="string">keyspace :</span> 数据库相关的统计信息</span><br><span class="line">参数还可以是下面这两个：</span><br><span class="line"><span class="string">all :</span> 返回所有信息</span><br><span class="line"><span class="string">default :</span> 返回默认选择的信息</span><br><span class="line">当不带参数直接调用 INFO 命令时，使用 <span class="keyword">default</span> 作为默认参数。</span><br></pre></td></tr></table></figure>
<p>添加执行权限 安装nc</p>
<blockquote>
<p>chmod +x /etc/zabbix/zabbix_agentd.d/scripts/redis_status.sh</p>
</blockquote>
<h2 id="监控项redis-status-conf配置"><a href="#监控项redis-status-conf配置" class="headerlink" title="监控项redis_status.conf配置"></a>监控项redis_status.conf配置</h2><blockquote>
<p> cat /etc/zabbix/zabbix_agentd.d/redis_status.conf<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">UserParameter</span>=redis_status[*],/etc/zabbix/zabbix_agentd.d/scripts/redis_status.sh <span class="variable">$1</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="重启zabbix-agent-1"><a href="#重启zabbix-agent-1" class="headerlink" title="重启zabbix_agent"></a>重启zabbix_agent</h2><blockquote>
<p>systemctl restart zabbix-agent</p>
</blockquote>
<h2 id="Server-zabbix-get-获取值-1"><a href="#Server-zabbix-get-获取值-1" class="headerlink" title="Server zabbix_get 获取值"></a>Server zabbix_get 获取值</h2><blockquote>
<p>zabbix_get -s 192.168.1.36 -k redis_status[used_cpu_sys]<br>1706.41</p>
</blockquote>
<h2 id="导入模板-3-4-关联主机-1"><a href="#导入模板-3-4-关联主机-1" class="headerlink" title="导入模板(3.4) 关联主机"></a>导入模板(3.4) 关联主机</h2><p><a href="https://github.com/sundayle/Zabbix/blob/master/zabbix_agentd.d/templates/zbx_export_templates_redis_status.xml" target="_blank" rel="noopener">https://github.com/sundayle/Zabbix/blob/master/zabbix_agentd.d/templates/zbx_export_templates_redis_status.xml</a><br><img src="/images/Snipaste_2018-06-29_13-26-00.jpg" alt="11"></p>
<h2 id="效果图-1"><a href="#效果图-1" class="headerlink" title="效果图"></a>效果图</h2><p><img src="/images/Snipaste_2018-06-29_13-27-52.jpg" alt="11"></p>
<h1 id="监控PHP-FPM"><a href="#监控PHP-FPM" class="headerlink" title="监控PHP-FPM"></a>监控PHP-FPM</h1><h2 id="php-statusfpm开启status"><a href="#php-statusfpm开启status" class="headerlink" title="php_statusfpm开启status"></a>php_statusfpm开启status</h2><blockquote>
<p>vim /etc/php7/php-fpm.d/<a href="http://www.conf" target="_blank" rel="noopener">www.conf</a><br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pm<span class="selector-class">.status_path</span> = /php_status</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="配置nginx"><a href="#配置nginx" class="headerlink" title="配置nginx"></a>配置nginx</h2><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  <span class="attribute">location</span> <span class="regexp">~ ^/(php_status)$</span> &#123;</span><br><span class="line">    <span class="attribute">include</span> fastcgi.conf;</span><br><span class="line">    <span class="attribute">fastcgi_pass</span> <span class="number">127.0.0.1:9000</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="访问测试"><a href="#访问测试" class="headerlink" title="访问测试"></a>访问测试</h2><blockquote>
<p>curl <a href="http://localhost/php_status" target="_blank" rel="noopener">http://localhost/php_status</a><br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">pool:</span>                 www</span><br><span class="line">process <span class="string">manager:</span>      <span class="keyword">static</span></span><br><span class="line">start <span class="string">time:</span>           <span class="number">27</span><span class="regexp">/Jun/</span><span class="number">2018</span>:<span class="number">17</span>:<span class="number">47</span>:<span class="number">24</span> +<span class="number">0800</span></span><br><span class="line">start <span class="string">since:</span>          <span class="number">160</span></span><br><span class="line">accepted <span class="string">conn:</span>        <span class="number">15</span></span><br><span class="line">listen <span class="string">queue:</span>         <span class="number">0</span></span><br><span class="line">max listen <span class="string">queue:</span>     <span class="number">0</span></span><br><span class="line">listen queue <span class="string">len:</span>     <span class="number">511</span></span><br><span class="line">idle <span class="string">processes:</span>       <span class="number">29</span></span><br><span class="line">active <span class="string">processes:</span>     <span class="number">1</span></span><br><span class="line">total <span class="string">processes:</span>      <span class="number">30</span></span><br><span class="line">max active <span class="string">processes:</span> <span class="number">1</span></span><br><span class="line">max children <span class="string">reached:</span> <span class="number">0</span></span><br><span class="line">slow <span class="string">requests:</span>        <span class="number">0</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="PHP-FPM状态解释"><a href="#PHP-FPM状态解释" class="headerlink" title="PHP-FPM状态解释"></a>PHP-FPM状态解释</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pool #fpm池名称,大多数为www</span><br><span class="line">process manager #进程管理方式dynamic或者static</span><br><span class="line">start time #启动日志,如果reload了fpm，时间会更新</span><br><span class="line">start since #运行时间</span><br><span class="line">accepted conn #当前池接受的请求数</span><br><span class="line">listen<span class="built_in"> queue </span>#请求等待队列,如果这个值不为0,那么需要增加FPM的进程数量</span><br><span class="line">max listen<span class="built_in"> queue </span>#请求等待队列最高的数量</span><br><span class="line">listen<span class="built_in"> queue </span>len #socket等待队列长度</span><br><span class="line">idle processes #空闲进程数量</span><br><span class="line">active processes #活跃进程数量</span><br><span class="line">total processes #总进程数量</span><br><span class="line">max active processes #最大的活跃进程数量（FPM启动开始计算）</span><br><span class="line">max children reached #程最大数量限制的次数，如果这个数量不为0，那说明你的最大进程数量过小,可以适当调整。</span><br></pre></td></tr></table></figure>
<h2 id="phpfpm-shell"><a href="#phpfpm-shell" class="headerlink" title="phpfpm shell"></a>phpfpm shell</h2><figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment">#auther: sunday</span></span><br><span class="line"><span class="comment">#Date: 2018-05-27</span></span><br><span class="line"></span><br><span class="line">HOST=<span class="string">"localhost"</span></span><br><span class="line">PORT=<span class="string">"80"</span></span><br><span class="line">STATUS=<span class="string">"php_status"</span></span><br><span class="line"></span><br><span class="line">[ $<span class="comment"># -ne 1 ] &amp;&amp; echo "USAGE:$0 (start_since|accepted_conn|listen_queue|max_listen_queue|listen_queue_len|idle_processes|active_processes|total_processes|max_active_processes|max_children_reached)" &amp;&amp; exit 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#检测php-fpm进程是否存在</span></span><br><span class="line">function <span class="keyword">ping</span> &#123;</span><br><span class="line">    /sbin/pidof php-fpm | wc -l</span><br><span class="line">    &#125;</span><br><span class="line"># 检测php-fpm性能</span><br><span class="line">function <span class="keyword">start_since</span> &#123;</span><br><span class="line">    /usr/bin/curl <span class="string">"http://<span class="variable">$HOST</span>:<span class="variable">$PORT</span>/<span class="variable">$STATUS</span>"</span> <span class="number">2</span>&gt;/dev/null | awk <span class="string">'/^start since:/ &#123;print <span class="variable">$NF</span>&#125;'</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">function</span> <span class="keyword">accepted_conn</span> &#123;</span><br><span class="line">    /usr/bin/curl <span class="string">"http://<span class="variable">$HOST</span>:<span class="variable">$PORT</span>/<span class="variable">$STATUS</span>"</span> <span class="number">2</span>&gt;/dev/null | awk <span class="string">'/^accepted conn:/ &#123;print <span class="variable">$NF</span>&#125;'</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">function</span> <span class="keyword">listen_queue</span> &#123;</span><br><span class="line">    /usr/bin/curl <span class="string">"http://<span class="variable">$HOST</span>:<span class="variable">$PORT</span>/<span class="variable">$STATUS</span>"</span> <span class="number">2</span>&gt;/dev/null |awk <span class="string">'/^listen queue:/ &#123;print <span class="variable">$NF</span>&#125;'</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">function</span> <span class="keyword">max_listen_queue</span> &#123;</span><br><span class="line">    /usr/bin/curl <span class="string">"http://<span class="variable">$HOST</span>:<span class="variable">$PORT</span>/<span class="variable">$STATUS</span>"</span> <span class="number">2</span>&gt;/dev/null | awk <span class="string">'/^max listen queue:/ &#123;print <span class="variable">$NF</span>&#125;'</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">function</span> <span class="keyword">listen_queue_len</span> &#123;</span><br><span class="line">    /usr/bin/curl <span class="string">"http://<span class="variable">$HOST</span>:<span class="variable">$PORT</span>/<span class="variable">$STATUS</span>"</span> <span class="number">2</span>&gt;/dev/null| awk <span class="string">'/^listen queue len:/ &#123;print <span class="variable">$NF</span>&#125;'</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">function</span> <span class="keyword">idle_processes</span> &#123;</span><br><span class="line">    /usr/bin/curl <span class="string">"http://<span class="variable">$HOST</span>:<span class="variable">$PORT</span>/<span class="variable">$STATUS</span>"</span> <span class="number">2</span>&gt;/dev/null|awk <span class="string">'/^idle processes:/ &#123;print <span class="variable">$NF</span>&#125;'</span></span><br><span class="line">   &#125;</span><br><span class="line"><span class="keyword">function</span> <span class="keyword">active_processes</span> &#123;</span><br><span class="line">    /usr/bin/curl <span class="string">"http://<span class="variable">$HOST</span>:<span class="variable">$PORT</span>/<span class="variable">$STATUS</span>"</span> <span class="number">2</span>&gt;/dev/null| awk <span class="string">'/^active processes:/ &#123;print <span class="variable">$NF</span>&#125;'</span></span><br><span class="line">   &#125;</span><br><span class="line"><span class="keyword">function</span> <span class="keyword">max_active_processes</span> &#123;</span><br><span class="line">    /usr/bin/curl <span class="string">"http://<span class="variable">$HOST</span>:<span class="variable">$PORT</span>/<span class="variable">$STATUS</span>"</span> <span class="number">2</span>&gt;/dev/null| awk <span class="string">'/^max active processes:/ &#123;print <span class="variable">$NF</span>&#125;'</span></span><br><span class="line">   &#125;   </span><br><span class="line"><span class="keyword">function</span> <span class="keyword">max_children_reached</span> &#123;</span><br><span class="line">    /usr/bin/curl <span class="string">"http://<span class="variable">$HOST</span>:<span class="variable">$PORT</span>/<span class="variable">$STATUS</span>"</span> <span class="number">2</span>&gt;/dev/null| awk <span class="string">'/^max children reached:/ &#123;print <span class="variable">$NF</span>&#125;'</span></span><br><span class="line">   &#125;</span><br><span class="line"><span class="keyword">function</span> <span class="keyword">slow_requests</span> &#123;</span><br><span class="line">    /usr/bin/curl <span class="string">"http://<span class="variable">$HOST</span>:<span class="variable">$PORT</span>/<span class="variable">$STATUS</span>"</span> <span class="number">2</span>&gt;/dev/null| awk <span class="string">'/^slow requests:/ &#123;print <span class="variable">$NF</span>&#125;'</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">#执行function</span><br><span class="line">$1</span><br></pre></td></tr></table></figure>
<blockquote>
<p>chmod +x /etc/zabbix/zabbix_agentd.d/scripts/php_status.sh </p>
</blockquote>
<h2 id="监控项nginx-status-conf配置-1"><a href="#监控项nginx-status-conf配置-1" class="headerlink" title="监控项nginx_status.conf配置"></a>监控项nginx_status.conf配置</h2><blockquote>
<p>cat /etc/zabbix/zabbix_agentd.d/php_status.conf<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">UserParameter</span>=php_status[*],/etc/zabbix/zabbix_agentd.d/scripts/php_status.sh <span class="string">"<span class="variable">$1</span>"</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="重启zabbix-agent-2"><a href="#重启zabbix-agent-2" class="headerlink" title="重启zabbix_agent"></a>重启zabbix_agent</h2><blockquote>
<p>systemctl restart zabbix-agent</p>
</blockquote>
<h2 id="Server-zabbix-get-获取值-2"><a href="#Server-zabbix-get-获取值-2" class="headerlink" title="Server zabbix_get 获取值"></a>Server zabbix_get 获取值</h2><blockquote>
<p>zabbix_get -s 192.168.1.36 -k php_status[accepted_conn]<br>350</p>
</blockquote>
<h2 id="导入模板-3-4-关联主机-2"><a href="#导入模板-3-4-关联主机-2" class="headerlink" title="导入模板(3.4) 关联主机"></a>导入模板(3.4) 关联主机</h2><p><a href="https://github.com/sundayle/Zabbix/blob/master/zabbix_agentd.d/templates/zbx_export_templates_php_status.xml" target="_blank" rel="noopener">https://github.com/sundayle/Zabbix/blob/master/zabbix_agentd.d/templates/zbx_export_templates_php_status.xml</a><br><img src="/images/Snipaste_2018-06-28_11-49-38.jpg" alt="11"></p>
<h2 id="效果图-2"><a href="#效果图-2" class="headerlink" title="效果图"></a>效果图</h2><p><img src="/images/Snipaste_2018-06-28_11-51-05.jpg" alt="11"></p>
<h1 id="监控MySQL"><a href="#监控MySQL" class="headerlink" title="监控MySQL"></a>监控MySQL</h1><p>#ubuntu<br>使用Percona Monitoring Plugins for Zabbix<br><a href="https://www.percona.com/doc/percona-monitoring-plugins/LATEST/zabbix/index.html" target="_blank" rel="noopener">https://www.percona.com/doc/percona-monitoring-plugins/LATEST/zabbix/index.html</a></p>
<p>Percona Monitoring Plugins 需要安装在agent端(web36)</p>
<p>#ubuntu<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget http<span class="variable">s:</span>//repo.percona.<span class="keyword">com</span>/apt/percona-release_0.<span class="number">1</span>-<span class="number">4</span>.$(lsb_release -sc)_all.<span class="keyword">deb</span></span><br><span class="line">dpkg -i percona-release_0.<span class="number">1</span>-<span class="number">4</span>.$(lsb_release -sc)_all.<span class="keyword">deb</span></span><br><span class="line">sudo apt-<span class="built_in">get</span> <span class="keyword">update</span></span><br><span class="line">apt-<span class="built_in">get</span> install percona-zabbix-templates</span><br></pre></td></tr></table></figure></p>
<p>#centos<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> <span class="keyword">http</span>://www.percona.com/downloads/percona-<span class="keyword">release</span>/redhat/<span class="number">0.1</span><span class="number">-4</span>/percona-<span class="keyword">release</span><span class="number">-0.1</span><span class="number">-4.</span>noarch.rpm</span><br><span class="line">yum <span class="keyword">install</span> percona-zabbix-templates</span><br></pre></td></tr></table></figure></p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">dpkg -L percona-zabbix-templates</span><br><span class="line">/.</span><br><span class="line">/var</span><br><span class="line">/var/<span class="class"><span class="keyword">lib</span></span></span><br><span class="line">/var/<span class="class"><span class="keyword">lib</span>/<span class="title">zabbix</span></span></span><br><span class="line">/var/<span class="class"><span class="keyword">lib</span>/<span class="title">zabbix</span>/<span class="title">percona</span></span></span><br><span class="line">/var/<span class="class"><span class="keyword">lib</span>/<span class="title">zabbix</span>/<span class="title">percona</span>/<span class="title">templates</span></span></span><br><span class="line">/var/<span class="class"><span class="keyword">lib</span>/<span class="title">zabbix</span>/<span class="title">percona</span>/<span class="title">templates</span>/<span class="title">zabbix_agent_template_percona_mysql_server_ht_2</span>.0.9-<span class="title">sver1</span>.1.8.<span class="title">xml</span>    <span class="comment">#zabbix模板</span></span></span><br><span class="line">/var/<span class="class"><span class="keyword">lib</span>/<span class="title">zabbix</span>/<span class="title">percona</span>/<span class="title">templates</span>/<span class="title">userparameter_percona_mysql</span>.<span class="title">conf</span>   <span class="comment">#zabbix配置文件</span></span></span><br><span class="line">/var/<span class="class"><span class="keyword">lib</span>/<span class="title">zabbix</span>/<span class="title">percona</span>/<span class="title">scripts</span></span></span><br><span class="line">/var/<span class="class"><span class="keyword">lib</span>/<span class="title">zabbix</span>/<span class="title">percona</span>/<span class="title">scripts</span>/<span class="title">ss_get_mysql_stats</span>.<span class="title">php</span> <span class="comment">#获取mysql信息的php</span></span></span><br><span class="line">/var/<span class="class"><span class="keyword">lib</span>/<span class="title">zabbix</span>/<span class="title">percona</span>/<span class="title">scripts</span>/<span class="title">get_mysql_stats_wrapper</span>.<span class="title">sh</span> <span class="comment">#shell脚本</span></span></span><br></pre></td></tr></table></figure>
<h2 id="配置zabbix-agent文件"><a href="#配置zabbix-agent文件" class="headerlink" title="配置zabbix_agent文件"></a>配置zabbix_agent文件</h2><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cp /var/<span class="class"><span class="keyword">lib</span>/<span class="title">zabbix</span>/<span class="title">percona</span>/<span class="title">templates</span>/<span class="title">userparameter_percona_mysql</span>.<span class="title">conf</span> /<span class="title">etc</span>/<span class="title">zabbix</span>/<span class="title">zabbix_agentd</span>.<span class="title">d</span>/<span class="title">userparameter_percona_mysql</span>.<span class="title">conf</span></span></span><br><span class="line"><span class="comment">#确保/etc/zabbix_agentd.conf包含以下行：Include = /etc/zabbix/zabbix_agentd.d</span></span><br><span class="line">/etc/init.d/zabbix-agent restart</span><br><span class="line">chown zabbix.zabbix /tmp/localhost-mysql_cacti_stats.txt</span><br><span class="line">setfacl -m <span class="symbol">u:</span><span class="symbol">zabbix:</span>rwx /tmp</span><br></pre></td></tr></table></figure>
<h2 id="MySQL-配置"><a href="#MySQL-配置" class="headerlink" title="MySQL 配置"></a>MySQL 配置</h2><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; grant process,super,select,replication client on *.* to zabbix_mysql@'localhost' identified by '81f249c<span class="number">2450</span>b<span class="number">3583</span>ae3cc<span class="number">2670</span>f<span class="number">9228</span>';</span><br><span class="line">mysql&gt; flush privileges;</span><br></pre></td></tr></table></figure>
<h2 id="配置zabbix-percona-mysql-php"><a href="#配置zabbix-percona-mysql-php" class="headerlink" title="配置zabbix-percona-mysql php"></a>配置zabbix-percona-mysql php</h2><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /var/<span class="class"><span class="keyword">lib</span>/<span class="title">zabbix</span>/<span class="title">percona</span>/<span class="title">scripts</span>/<span class="title">ss_get_mysql_stats</span>.<span class="title">php</span> </span></span><br><span class="line">$mysql_user = <span class="string">'zabbix_mysql'</span>;</span><br><span class="line">$mysql_pass = <span class="string">'81f249c2450b3583ae3cc2670f9228'</span>;</span><br><span class="line">$mysql_port = <span class="number">3306</span>;</span><br><span class="line">$mysql_socket = <span class="string">'/tmp/mysql.sock'</span>;</span><br></pre></td></tr></table></figure>
<p>设置环境变量<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -sv <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/webserver/</span>php7<span class="meta-keyword">/bin/</span>php <span class="meta-keyword">/usr/</span>bin/php</span><br><span class="line">ln -sv <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/webserver/</span>mysql<span class="meta-keyword">/bin/</span>mysql <span class="meta-keyword">/bin/</span>mysql</span><br></pre></td></tr></table></figure></p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> cd /var/<span class="class"><span class="keyword">lib</span>/<span class="title">zabbix</span>/<span class="title">percona</span>/<span class="title">scripts</span></span></span><br><span class="line"> ./get_mysql_stats_wrapper.sh gg</span><br><span class="line"><span class="number">2321296871</span></span><br><span class="line"> ./get_mysql_stats_wrapper.sh mm</span><br><span class="line"><span class="number">21148771</span></span><br></pre></td></tr></table></figure>
<p>zabbix-server测试<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zabbix_get -s <span class="number">192.168</span><span class="number">.1</span><span class="number">.36</span> -k 'MySQL.Connections';</span><br><span class="line"><span class="number">1045</span></span><br></pre></td></tr></table></figure></p>
<p>官方zabbix_agent_template_percona_mysql_server_ht_2.0.9-sver1.1.8 导入错误。<br>使用修改版：<br><a href="https://github.com/sundayle/linux/blob/master/zabbix/zabbix_agent_template_percona_mysql_server_ht_2.0.9-sver1.1.7.xml" target="_blank" rel="noopener">https://github.com/sundayle/linux/blob/master/zabbix/zabbix_agent_template_percona_mysql_server_ht_2.0.9-sver1.1.7.xml</a></p>
<h2 id="导入模板"><a href="#导入模板" class="headerlink" title="导入模板"></a>导入模板</h2><p>Configuration &gt; Templates &gt; import<br><img src="/images/zabbix-templates-import1.jpg" alt="11"><br><img src="/images/zabbix-templates-import2.jpg" alt="11"></p>
<h2 id="使用模板"><a href="#使用模板" class="headerlink" title="使用模板"></a>使用模板</h2><p>Configuration &gt; Hosts &gt; zabbix36 &gt; Templates &gt; Select &gt; Group: Percona Templates &gt;Template Percona MySQL Server<br><img src="/images/zabbix-templates-select.jpg" alt="11"></p>
<h2 id="MySQL-running-slave-错误解决"><a href="#MySQL-running-slave-错误解决" class="headerlink" title="MySQL.running-slave 错误解决"></a>MySQL.running-slave 错误解决</h2><p>zabbix_get -s 192.168.1.36 -k MySQL.running-slave<br>ERROR 1045 (28000): Access denied for user ‘zabbix‘@’localhost’ (using password: YES)<br>0<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vim</span> /var/lib/zabbix/percona/scripts/<span class="keyword">vim</span> get_mysql_stats_wrapper.<span class="keyword">sh</span> </span><br><span class="line">RES=`HOME=~zabbix mysql -<span class="keyword">e</span> <span class="string">'SHOW SLAVE STATUS\G'</span> | egrep <span class="string">'(Slave_IO_Running|Slave_SQL_Running):'</span> | awk -F: <span class="string">'&#123;print $2&#125;'</span> | <span class="keyword">tr</span> <span class="string">'\n'</span> <span class="string">','</span>`</span><br><span class="line">修改为</span><br><span class="line">RES=`HOME=~zabbix mysql --defaults-extra-<span class="keyword">file</span>=$DIR/config.<span class="keyword">cnf</span> -<span class="keyword">e</span> <span class="string">'SHOW SLAVE STATUS\G'</span> | egrep <span class="string">'(Slave_IO_Run    ning|Slave_SQL_Running):'</span> | awk -F: <span class="string">'&#123;print $2&#125;'</span> | <span class="keyword">tr</span> <span class="string">'\n'</span> <span class="string">','</span>`</span><br></pre></td></tr></table></figure></p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat  /var/<span class="class"><span class="keyword">lib</span>/<span class="title">zabbix</span>/<span class="title">percona</span>/<span class="title">scripts</span>/<span class="title">config</span>.<span class="title">cnf</span> </span></span><br><span class="line">[client]</span><br><span class="line">user = <span class="string">'zabbix_mysql'</span></span><br><span class="line">host = localhost</span><br><span class="line">password = <span class="string">'81f249c2450b3583ae3cc2670f9228'</span></span><br></pre></td></tr></table></figure>
<p>注: mysql slave stop 是监控Slave_IO_Running|Slave_SQL_Running的，所以正确的操作是：<br>主库Slave is stopped on {HOST.NAME} Triggers:disable<br>从库Slave is stopped on {HOST.NAME} Triggers:enable</p>
<h1 id="监控WEB"><a href="#监控WEB" class="headerlink" title="监控WEB"></a>监控WEB</h1><p>Configuration &gt; Hosts &gt; zabbix36 &gt; Web &gt; Create web scenario<br><img src="/images/zabbix-host-web.jpg" alt="11"></p>
<p>查看效果<br>Monitoring &gt; Web &gt; nginx web monitor<br><img src="/images/zabbix-web-nginx-look.jpg" alt="11"><br>添加触发器<br><img src="/images/zabbix-web-nginx-triggers.jpg" alt="11"><br><img src="/images/zabbix-web-nginx-triggers2.jpg" alt="11"></p>
<h1 id="监控Tomcat"><a href="#监控Tomcat" class="headerlink" title="监控Tomcat"></a>监控Tomcat</h1><p>监控JMX是通过java gateway来监控Java的。<br>业务量不大可以安装在zabbix_server服务器上。<br>zabbix-server: 192.168.1.39<br>zabbix-java-gateway: 192.168.1.39<br>tomcat : 192.168.1.37</p>
<h2 id="安装Java-gateway"><a href="#安装Java-gateway" class="headerlink" title="安装Java-gateway"></a>安装Java-gateway</h2><p>源码版 编译激活java</p>
<blockquote>
<p>./configure –prefix=/usr/local/webserver/zabbix –enable-server –enable-agent –with-mysql –with-net-snmp –with-libcurl –with-libxml2 –enable-proxy<br>make -j 4 &amp;&amp; make install </p>
</blockquote>
<blockquote>
<p>/usr/local/zabbix/sbin/zabbix_java/startup.sh<br>/usr/local/zabbix/sbin/zabbix_java/shutdown.sh</p>
</blockquote>
<p>yum源版 #yum install -y zabbix-java-gateway java-1.8.0</p>
<h2 id="配置Zabbix-java-gateway"><a href="#配置Zabbix-java-gateway" class="headerlink" title="配置Zabbix-java-gateway"></a>配置Zabbix-java-gateway</h2><blockquote>
<p>cat /etc/zabbix/zabbix_java_gateway.conf </p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> LISTEN_IP=<span class="string">"0.0.0.0"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> LISTEN_PORT=10052</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> START_POLLERS=5   <span class="comment">#默认开启5个线程。</span></span></span><br><span class="line">TIMEOUT=3</span><br></pre></td></tr></table></figure>
<blockquote>
<p>/usr/local/webserver/zabbix/sbin/zabbix_java/startup.sh </p>
</blockquote>
<p> #yum ## systemctl start zabbix-java-gateway<br> ss -utnlp | grep 10052<br> <figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcp    LISTEN     0      50        *:10052                 *:*                   users:((<span class="string">"java"</span>,<span class="attribute">pid</span>=64631,fd=12))</span><br></pre></td></tr></table></figure></p>
<h2 id="Zabbix-server配置"><a href="#Zabbix-server配置" class="headerlink" title="Zabbix_server配置"></a>Zabbix_server配置</h2><blockquote>
<p>cat /etc/zabbix/zabbix-server.conf<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">JavaGateway=<span class="number">192.168</span><span class="number">.1</span><span class="number">.39</span> #zabbix-java-gateway服务器IP</span><br><span class="line"># JavaGatewayPort=<span class="number">10052</span></span><br><span class="line"># StartJavaPollers=<span class="number">0</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>systemctl restart zabbix-server </p>
<h2 id="Tomcat-环境"><a href="#Tomcat-环境" class="headerlink" title="Tomcat 环境"></a>Tomcat 环境</h2><p><a href="https://tomcat.apache.org/download-80.cgi" target="_blank" rel="noopener">https://tomcat.apache.org/download-80.cgi</a></p>
<blockquote>
<p>yum install -y java-1.8.0<br>wget <a href="http://mirror.bit.edu.cn/apache/tomcat/tomcat-8/v8.5.31/bin/apache-tomcat-8.5.31.tar.gz" target="_blank" rel="noopener">http://mirror.bit.edu.cn/apache/tomcat/tomcat-8/v8.5.31/bin/apache-tomcat-8.5.31.tar.gz</a><br>tar xf apache-tomcat-8.5.31.tar.gz.tar.gz<br>mv apache-tomcat-8.5.31 /usr/local/tomcal<br>ln -sv /usr/local/apache-tomcat-8.5.31 /usr/local/tomcat<br>cd /usr/local/tomcat/lib<br>wget <a href="http://archive.apache.org/dist/tomcat/tomcat-8/v8.5.31/bin/extras/catalina-jmx-remote.jar" target="_blank" rel="noopener">http://archive.apache.org/dist/tomcat/tomcat-8/v8.5.31/bin/extras/catalina-jmx-remote.jar</a><br>/usr/local/tomcat/bin/startup.sh<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Using <span class="string">CATALINA_BASE:</span>   <span class="regexp">/usr/</span>local/tomcat</span><br><span class="line">Using <span class="string">CATALINA_HOME:</span>   <span class="regexp">/usr/</span>local/tomcat</span><br><span class="line">Using <span class="string">CATALINA_TMPDIR:</span> <span class="regexp">/usr/</span>local<span class="regexp">/tomcat/</span>temp</span><br><span class="line">Using <span class="string">JRE_HOME:</span>        /usr</span><br><span class="line">Using <span class="string">CLASSPATH:</span>       <span class="regexp">/usr/</span>local<span class="regexp">/tomcat/</span>bin<span class="regexp">/bootstrap.jar:/</span>usr<span class="regexp">/local/</span>tomcat<span class="regexp">/bin/</span>tomcat-juli.jar</span><br><span class="line">Tomcat started.</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>ss -tunlp | grep -E “8009|8090|8005”<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tcp    LISTEN     <span class="number">0</span>      <span class="number">100</span>      :::<span class="number">8090</span>                 :::*                   users:((<span class="string">"java"</span>,pid=<span class="number">14462</span>,fd=<span class="number">52</span>))</span><br><span class="line">tcp    LISTEN     <span class="number">0</span>      <span class="number">1</span>      ::ffff:<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8005</span>                 :::*                   users:((<span class="string">"java"</span>,pid=<span class="number">14462</span>,fd=<span class="number">72</span>))</span><br><span class="line">tcp    LISTEN     <span class="number">0</span>      <span class="number">100</span>      :::<span class="number">8009</span>                 :::*                   users:((<span class="string">"java"</span>,pid=<span class="number">14462</span>,fd=<span class="number">56</span>))</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>/usr/local/tomcat/bin/shutdown.sh<br>关闭tomcat </p>
</blockquote>
<h2 id="配置JMX远程监控"><a href="#配置JMX远程监控" class="headerlink" title="配置JMX远程监控"></a>配置JMX远程监控</h2><p>官方文档：<a href="http://tomcat.apache.org/tomcat-8.0-doc/monitoring.html" target="_blank" rel="noopener">http://tomcat.apache.org/tomcat-8.0-doc/monitoring.html</a><br>JMX三种类型： 1.无密码认证 2.用户面密码认证 3.ssl<br>这里使用无密码认证</p>
<blockquote>
<p>cat /usr/local/tomcat/bin/catalina.sh<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CATALINA_OPTS="$CATALINA_OPTS </span><br><span class="line">-<span class="ruby">Dcom.sun.management.jmxremote </span></span><br><span class="line"><span class="ruby">-Djava.rmi.server.hostname=<span class="number">192.168</span>.<span class="number">1.37</span> </span></span><br><span class="line"><span class="ruby">-Dcom.sun.management.jmxremote.port=<span class="number">8088</span> </span></span><br><span class="line"><span class="ruby">-Dcom.sun.management.jmxremote.ssl=<span class="literal">false</span> </span></span><br><span class="line"><span class="ruby">-Dcom.sun.management.jmxremote.authenticate=<span class="literal">false</span><span class="string">"</span></span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby"><span class="comment"># ----- Execute The Requested Command -----------------------------------------</span></span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>在Execute The Requested Command前加入如下代码：(添加其他地方会出现乱七八糟的错误)<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CATALINA_OPTS="$CATALINA_OPTS </span><br><span class="line">-<span class="ruby">Dcom.sun.management.jmxremote </span></span><br><span class="line"><span class="ruby">-Djava.rmi.server.hostname=<span class="number">192.168</span>.<span class="number">1.37</span> </span></span><br><span class="line"><span class="ruby">-Dcom.sun.management.jmxremote.port=<span class="number">8088</span></span></span><br><span class="line"><span class="ruby">-Dcom.sun.management.jmxremote.ssl=<span class="literal">false</span> </span></span><br><span class="line"><span class="ruby">-Dcom.sun.management.jmxremote.authenticate=<span class="literal">false</span><span class="string">"</span></span></span><br></pre></td></tr></table></figure></p>
<p>其中的 hostname换成你本机的ip， port 默认为8088。<br><a href="https://blog.csdn.net/pinyitianle/article/details/51172087" target="_blank" rel="noopener">https://blog.csdn.net/pinyitianle/article/details/51172087</a></p>
<h2 id="使用cmdline-jmxclient-0-10-3-jar来检测是否可以取到数据"><a href="#使用cmdline-jmxclient-0-10-3-jar来检测是否可以取到数据" class="headerlink" title="使用cmdline-jmxclient-0.10.3.jar来检测是否可以取到数据"></a>使用cmdline-jmxclient-0.10.3.jar来检测是否可以取到数据</h2><p>方法一： Linux</p>
<blockquote>
<p>java -jar cmdline-jmxclient-0.10.3.jar - 192.168.1.37:8088 java.lang:type=Memory NonHeapMemoryUsage<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">06</span><span class="regexp">/28/</span><span class="number">2018</span> <span class="number">13</span>:<span class="number">26</span>:<span class="number">35</span> +<span class="number">0800</span> org.archive.jmx.Client <span class="string">NonHeapMemoryUsage:</span> </span><br><span class="line"><span class="string">committed:</span> <span class="number">31916032</span></span><br><span class="line"><span class="string">init:</span> <span class="number">2555904</span></span><br><span class="line"><span class="string">max:</span> <span class="number">-1</span></span><br><span class="line"><span class="string">used:</span> <span class="number">30721664</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>方法二：window<br>C:\Program Files\Java\jdk1.8.0_171\bin\jconsole.exe<br><img src="/images/tomcat-jmx-conn.jpg" alt="11"><br><img src="/images/tomcat-jmx.jpg" alt="11"></p>
<h2 id="Zabbix-WEB"><a href="#Zabbix-WEB" class="headerlink" title="Zabbix-WEB"></a>Zabbix-WEB</h2><p>Configuration &gt; Hosts &gt; zabbix37<br><img src="/images/Snipaste_2018-06-28_13-02-30.jpg" alt="11"><br><img src="/images/Snipaste_2018-06-28_13-14-31.jpg" alt="11"><br>查看效果<br><img src="/images/zabbix-jmx-graphs.jpg" alt="11"></p>
<h1 id="Zabbix-Proxy"><a href="#Zabbix-Proxy" class="headerlink" title="Zabbix Proxy"></a>Zabbix Proxy</h1><p><a href="https://www.zabbix.com/documentation/3.4/manual/distributed_monitoring/proxies" target="_blank" rel="noopener">https://www.zabbix.com/documentation/3.4/manual/distributed_monitoring/proxies</a><br><a href="https://www.abcdocker.com/abcdocker/1506" target="_blank" rel="noopener">https://www.abcdocker.com/abcdocker/1506</a></p>
<p><img src="/images/zabbix-proxy.png" alt="11"><br>Zabbix代理可以代表Zabbix服务器收集性能和可用性数据。这样，代理可以承担一部分收集数据的负担.</p>
<h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>常用于多机房情况或者监控主机特别多，几千台左右。这时候使用Zabbix Proxy 可以减轻服务器server的压力，还可以减轻Zabbix的维护。<br>最常用的特点是适用于多机房、网络不稳定的时候，因为如果直接由Zabbix-server发送信息可能agent没有收到，但是直接使用Zabbix-Proxy就不会遇到这个问题。 </p>
<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>zabbix server: 192.168.1.39<br>zabbix proxy: 192.168.1.38<br>zabbix agent: 192.168.1.37</p>
<h2 id="zabbix-proxy安装"><a href="#zabbix-proxy安装" class="headerlink" title="zabbix proxy安装"></a>zabbix proxy安装</h2><blockquote>
<p>apt-get install  -y zabbix-proxy zabbix-proxy-mysql mariadb-server\</p>
</blockquote>
<p>##zabbix proxy 数据库</p>
<blockquote>
<p>create database zabbix_proxy character set utf8;<br>grant all on zabbix_proxy.* to zabbix_proxy@localhost identified by ‘zabbix_proxy’;<br>cd /usr/share/doc/zabbix-proxy-mysql-3.4.9<br>zcat schema.sql.gz | mysql -uzabbix_proxy -p zabbix_proxy</p>
</blockquote>
<h2 id="配置zabbix-proxy-conf"><a href="#配置zabbix-proxy-conf" class="headerlink" title="配置zabbix_proxy.conf"></a>配置zabbix_proxy.conf</h2><blockquote>
<p>cat /etc/zabbix/zabbix_proxy.conf<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Server</span>=192.168.1.38</span><br><span class="line"><span class="attribute">Hostname</span>=Zabbix proxy</span><br><span class="line"><span class="attribute">DBName</span>=zabbix_proxy #数据库名称</span><br><span class="line"><span class="attribute">DBUser</span>=zabbix_proxy #用户名</span><br><span class="line"><span class="attribute">DBPassword</span>=zabbix_proxy #用户密码</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置文件中没有配置的内容如下：（有需要可以配置）</span></span><br><span class="line"><span class="comment"># ProxyLocalBuffer=0 #数据保留的时间（小时为单位）</span></span><br><span class="line"><span class="comment"># ProxyOfflineBuffer=1 #连不上Server，数据要保留多久（小时为单位，默认1小时）</span></span><br><span class="line"><span class="comment"># DataSenderFrequency=1 #数据的发送时间间隔（默认是1秒）</span></span><br><span class="line"><span class="comment"># StartPollers=5 #启动的线程数</span></span><br><span class="line"><span class="comment"># StartIPMIPollers=0 #启动IPMI的线程数</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>systemctl start zabbix-proxy</p>
</blockquote>
<h2 id="zabbix-web-配置proxies"><a href="#zabbix-web-配置proxies" class="headerlink" title="zabbix-web 配置proxies"></a>zabbix-web 配置proxies</h2><p>注：zabbix-proxy没有web的,使用的是zabbix-server-web</p>
<p>Administration &gt; Proxies &gt; Create Proxy<br><img src="/images/zabbix-proxies.jpg" alt="11"><br>添加zabbix37 客户端 选择代理监控 zabbix proxy<br><img src="/images/zabbix-add-host-proxy.jpg" alt="11"></p>
<h2 id="zabbix37-客户端修改配置"><a href="#zabbix37-客户端修改配置" class="headerlink" title="zabbix37 客户端修改配置"></a>zabbix37 客户端修改配置</h2><blockquote>
<p>cat /etc/zabbix/zabbix_agent.conf<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ServerActive=<span class="number">192.168</span><span class="number">.1</span><span class="number">.38</span></span><br><span class="line">#Server=<span class="number">192.168</span><span class="number">.1</span><span class="number">.38</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<p><a href="https://www.abcdocker.com/abcdocker/1506" target="_blank" rel="noopener">https://www.abcdocker.com/abcdocker/1506</a></p>
<h1 id="主动模式"><a href="#主动模式" class="headerlink" title="主动模式"></a>主动模式</h1><p>监控常遇到的问题：<br>1.监控主机多，性能跟不上，延迟大<br>2.多机房，防火墙因素<br>Zabbix可以调整模式提高性能，解决以上问题</p>
<p>Zabbix 模式介绍：<br>1、被动模式 （默认）<br>2、主动模式</p>
<p>新建item配置，如使用模板是无法修改成主动模式的，此时我们可以克隆模板自定义修改。<br><img src="/images/zabbix-agent-active.jpg" alt="11"><br>注意：<br>1、当监控主机超过300+，建议使用主动模式（此处是一个经验值，要根据服务器的硬件来进行考虑）<br>2、还需要保证Queue对列里面没有延迟的主机</p>
<p>Queue 对列介绍<br>如果此处的延迟主机有点多的话，我们就需要将被动模式修改为主动模式<br><img src="/images/zabbix-queue.jpg" alt="11"></p>
<p>主动模式配置<br>server: 192.168.1.39<br>agent: 192.168.1.37<br>agent操作</p>
<blockquote>
<p>cat /etc/zabbix/zabbix_agentd.conf<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Server=192.168.1.37 #我们需要注释Server，因为这个是被动模式用的</span></span><br><span class="line">StartAgents=0 <span class="comment">#设置为0之后就不会TCP端口，之前监听TCP端口是因为Server要去问agent信息所以需要开启</span></span><br><span class="line">ServerActive=192.168.1.39 <span class="comment">#zabbix-server IP或域名，他会连接10051端口</span></span><br><span class="line">Hostname=node1 <span class="comment">#唯一识别符</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>server操作<br>Configure &gt; Templates &gt; Template OS Linux &gt; Full Clone<br><img src="/images/zabbix-template-linux-full-clone.jpg" alt="11"><br><img src="/images/zabbix-template-linux-os-active.jpg" alt="11"><br>Configure &gt; Templates &gt; Template OS Linux Active &gt; Mass update<br>批量修改成 Zabbix agent (active)<br><img src="/images/zabbix-template-linux-active1.jpg" alt="11"><br><img src="/images/zabbix-template-linux-active2.jpg" alt="11"><br>![11](/images/zabbix-template-update.jpg}</p>
<p>Configuration &gt; Host &gt; Create host &gt; Templates<br>Select: Template OS Linux Active add<br><img src="/images/zabbix-host-active.jpg" alt="11"></p>
<h1 id="自动化监控"><a href="#自动化监控" class="headerlink" title="自动化监控"></a>自动化监控</h1><h2 id="自动化分类"><a href="#自动化分类" class="headerlink" title="自动化分类"></a>自动化分类</h2><p>1.自动注册：Zabbix agnet 自动添加<br>2.主动发现 ：自动发现 Discover 、zabbix api </p>
<h2 id="自动注册"><a href="#自动注册" class="headerlink" title="自动注册"></a>自动注册</h2><p>Server: 192.168.1.39<br>Agent: 192.168.1.35<br>zabbix_agent配置<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">grep ^[a-Z] /etc/zabbix/zabbix_agentd.conf</span><br><span class="line">PidFile=/var/run/zabbix/zabbix_agentd.pid</span><br><span class="line">LogFile=/var/log/zabbix-agent/zabbix_agentd.log</span><br><span class="line">LogFileSize=0</span><br><span class="line">Server=192.168.1.39</span><br><span class="line">ServerActive=192.168.1.39</span><br><span class="line">Hostname=store35</span><br><span class="line">HostMetadata=system.uname</span><br><span class="line">HostMetadataItem=system.uname</span><br><span class="line">Include=/etc/zabbix/zabbix_agentd.conf.d/*.conf</span><br></pre></td></tr></table></figure></p>
<p>zabbix web<br>Configration &gt; Actions &gt; Event source: Auto registration &gt; Create action<br><img src="/images/create-auto-action.jpg" alt="11"><br><img src="/images/zabbix-autoreg-actions-name.jpg" alt="11"><br><img src="/images/zabbix-autoreg-opertions.jpg" alt="11"><br>Configuration &gt; Hosts 查看效果<br><img src="/images/auto-host-add.jpg" alt="11"></p>
<h2 id="主动发现"><a href="#主动发现" class="headerlink" title="主动发现"></a>主动发现</h2><p>禁用自动注册，因为这会影响自动发现功能<br>Configuration &gt; Actions &gt; Agent Auto Registration<br><img src="/images/zabbix-auto-registration-disable.jpg" alt="11"></p>
<p>Configuration &gt; Discovery &gt; Create discovery rule<br><img src="/images/zabbix-discovery-create.jpg" alt="11"></p>
<p>Configuration &gt; Actions &gt; Auto discoyvery.Linux servers &gt; status : Enabled<br><img src="/images/zabbix-discovery-auto-enable.jpg" alt="11"><br><img src="/images/zabbix-discovery-auto-add-host.jpg" alt="11"></p>
<h1 id="API"><a href="#API" class="headerlink" title="API"></a>API</h1><p>官方说明文档：<a href="https://www.zabbix.com/documentation/3.4/manual/api" target="_blank" rel="noopener">https://www.zabbix.com/documentation/3.4/manual/api</a><br><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">curl -s -X POST -H <span class="symbol">'Content</span>-<span class="keyword">Type</span>:application/json-rpc' -d'</span><br><span class="line"> &#123;</span><br><span class="line">     <span class="string">"jsonrpc"</span>: <span class="string">"2.0"</span>,</span><br><span class="line">     <span class="string">"method"</span>: <span class="string">"user.login"</span>,</span><br><span class="line">     <span class="string">"params"</span>: &#123;</span><br><span class="line">         <span class="string">"user"</span>: <span class="string">"Admin"</span>,</span><br><span class="line">         <span class="string">"password"</span>: <span class="string">"xxxxx"</span></span><br><span class="line">     &#125;,</span><br><span class="line">     <span class="string">"id"</span>: <span class="number">1</span></span><br><span class="line"> &#125;' http://zabbix.sundayle.com/api_jsonrpc.php |  python -m json.tool</span><br><span class="line"><span class="comment">--------返回的结果--------</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"id"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">"jsonrpc"</span>: <span class="string">"2.0"</span>,</span><br><span class="line">    <span class="string">"result"</span>: <span class="string">"49bac97c4c27c195d4d7cfabc8811b08"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>-d 请求的内容<br>-H 类型<br>id 名字，类似一个标识 </p>
<h2 id="获取所有主机列表"><a href="#获取所有主机列表" class="headerlink" title="获取所有主机列表"></a>获取所有主机列表</h2><p><a href="https://www.zabbix.com/documentation/3.4/manual/api/reference/host/get" target="_blank" rel="noopener">https://www.zabbix.com/documentation/3.4/manual/api/reference/host/get</a><br><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">curl -s -X POST -H <span class="symbol">'Content</span>-<span class="keyword">Type</span>:application/json-rpc' -d'</span><br><span class="line">&gt; &#123;</span><br><span class="line">&gt;     <span class="string">"jsonrpc"</span>: <span class="string">"2.0"</span>,</span><br><span class="line">&gt;     <span class="string">"method"</span>: <span class="string">"host.get"</span>,</span><br><span class="line">&gt;     <span class="string">"params"</span>: &#123;</span><br><span class="line">&gt;         <span class="string">"output"</span>: [<span class="string">"host"</span>]</span><br><span class="line">&gt;     &#125;,</span><br><span class="line">&gt;     <span class="string">"auth"</span>: <span class="string">"49bac97c4c27c195d4d7cfabc8811b08"</span>,</span><br><span class="line">&gt;     <span class="string">"id"</span>: <span class="number">1</span></span><br><span class="line">&gt; &#125;' http://zabbix.sundayle.com/api_jsonrpc.php |  python -m json.tool</span><br><span class="line"><span class="comment">--------返回的结果--------</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"id"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">"jsonrpc"</span>: <span class="string">"2.0"</span>,</span><br><span class="line">    <span class="string">"result"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"host"</span>: <span class="string">"Zabbix server"</span>,</span><br><span class="line">            <span class="string">"hostid"</span>: <span class="string">"10084"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"host"</span>: <span class="string">"web36"</span>,</span><br><span class="line">            <span class="string">"hostid"</span>: <span class="string">"10256"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"host"</span>: <span class="string">"web41"</span>,</span><br><span class="line">            <span class="string">"hostid"</span>: <span class="string">"10257"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"host"</span>: <span class="string">"store42"</span>,</span><br><span class="line">            <span class="string">"hostid"</span>: <span class="string">"10258"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"host"</span>: <span class="string">"web37"</span>,</span><br><span class="line">            <span class="string">"hostid"</span>: <span class="string">"10259"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"host"</span>: <span class="string">"192.168.1.31"</span>,</span><br><span class="line">            <span class="string">"hostid"</span>: <span class="string">"10276"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"host"</span>: <span class="string">"store35"</span>,</span><br><span class="line">            <span class="string">"hostid"</span>: <span class="string">"10278"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="获取所有模板"><a href="#获取所有模板" class="headerlink" title="获取所有模板"></a>获取所有模板</h2><figure class="highlight sml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">curl -s -<span class="type">X</span> <span class="type">POST</span> -<span class="type">H</span> <span class="symbol">'Content</span>-<span class="type">Type</span>:application/json-rpc' -d'</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"jsonrpc"</span>: <span class="string">"2.0"</span>,</span><br><span class="line">    <span class="string">"method"</span>: <span class="string">"template.get"</span>,</span><br><span class="line">    <span class="string">"params"</span>: &#123;</span><br><span class="line">        <span class="string">"output"</span>: <span class="string">"extend"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"auth"</span>: <span class="string">"49bac97c4c27c195d4d7cfabc8811b08"</span>,</span><br><span class="line">    <span class="string">"id"</span>: <span class="number">1</span></span><br><span class="line">&#125;<span class="string">' http://zabbix.sundayle.com/api_jsonrpc.php |  python -m json.tool</span></span><br></pre></td></tr></table></figure>
<h2 id="获取-Template-OS-Linux"><a href="#获取-Template-OS-Linux" class="headerlink" title="获取 Template OS Linux"></a>获取 Template OS Linux</h2><figure class="highlight sml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">curl -s -<span class="type">X</span> <span class="type">POST</span> -<span class="type">H</span> <span class="symbol">'Content</span>-<span class="type">Type</span>:application/json-rpc' -d'</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"jsonrpc"</span>: <span class="string">"2.0"</span>,</span><br><span class="line">    <span class="string">"method"</span>: <span class="string">"template.get"</span>,</span><br><span class="line">    <span class="string">"params"</span>: &#123;</span><br><span class="line">        <span class="string">"output"</span>: <span class="string">"extend"</span>,</span><br><span class="line">         <span class="string">"filter"</span>: &#123;</span><br><span class="line">            <span class="string">"host"</span>: [</span><br><span class="line">                <span class="string">"Template OS Linux"</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"auth"</span>: <span class="string">"49bac97c4c27c195d4d7cfabc8811b08"</span>,</span><br><span class="line">    <span class="string">"id"</span>: <span class="number">1</span></span><br><span class="line">&#125;<span class="string">' http://zabbix.sundayle.com/api_jsonrpc.php |  python -m json.tool</span></span><br></pre></td></tr></table></figure>
<h2 id="快速获取auth-脚本"><a href="#快速获取auth-脚本" class="headerlink" title="快速获取auth 脚本"></a>快速获取auth 脚本</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env <span class="keyword">python</span></span><br><span class="line"># -*- codin<span class="variable">g:utf</span>-<span class="number">8</span> -*-</span><br><span class="line"> </span><br><span class="line">import requests</span><br><span class="line">import json</span><br><span class="line"> </span><br><span class="line">url = <span class="string">'http://zabbix.sundayle.com/api_jsonrpc.php'</span></span><br><span class="line">post_data = &#123;</span><br><span class="line">    <span class="string">"jsonrpc"</span>: <span class="string">"2.0"</span>,</span><br><span class="line">    <span class="string">"method"</span>: <span class="string">"user.login"</span>,</span><br><span class="line">    <span class="string">"params"</span>: &#123;</span><br><span class="line">        <span class="string">"user"</span>: <span class="string">"Admin"</span>,</span><br><span class="line">        <span class="string">"password"</span>: <span class="string">"star-xwx"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"id"</span>: <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line">post_header = &#123;<span class="string">'Content-Type'</span>: <span class="string">'application/json'</span>&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">ret</span> = requests.post(url, data=json.dumps(post_data), headers=post_header)</span><br><span class="line"> </span><br><span class="line">zabbix_ret = json.loads(<span class="keyword">ret</span>.text)</span><br><span class="line"><span class="keyword">if</span> not zabbix_ret.<span class="built_in">has_key</span>(<span class="string">'result'</span>):</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'login error'</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">print</span> zabbix_ret.<span class="built_in">get</span>(<span class="string">'result'</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apt-<span class="built_in">get</span> install <span class="keyword">python</span>-requests</span><br><span class="line">chmod +<span class="keyword">x</span> zabbix_auth.<span class="keyword">py</span></span><br><span class="line"><span class="keyword">python</span> zabbix_auth.<span class="keyword">py</span> </span><br><span class="line"><span class="number">7</span>dc4c5082132c74c70624a60403a6b76</span><br></pre></td></tr></table></figure>
<h2 id="API-添加-agent"><a href="#API-添加-agent" class="headerlink" title="API 添加 agent"></a>API 添加 agent</h2><p><a href="https://www.zabbix.com/documentation/3.4/manual/api/reference/host/create" target="_blank" rel="noopener">https://www.zabbix.com/documentation/3.4/manual/api/reference/host/create</a><br><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">curl -s -X POST -H <span class="symbol">'Content</span>-<span class="keyword">Type</span>:application/json-rpc' -d'</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"jsonrpc"</span>: <span class="string">"2.0"</span>,</span><br><span class="line">    <span class="string">"method"</span>: <span class="string">"host.create"</span>,</span><br><span class="line">    <span class="string">"params"</span>: &#123;</span><br><span class="line">        <span class="string">"host"</span>: <span class="string">"zabbix35"</span>,</span><br><span class="line">        <span class="string">"interfaces"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"type"</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="string">"main"</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="string">"useip"</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="string">"ip"</span>: <span class="string">"192.168.1.35"</span>,</span><br><span class="line">                <span class="string">"dns"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="string">"port"</span>: <span class="string">"10050"</span></span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"groups"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"groupid"</span>: <span class="string">"2"</span></span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"templates"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"templateid"</span>: <span class="string">"10001"</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"auth"</span>: <span class="string">"7dc4c5082132c74c70624a60403a6b76"</span>,</span><br><span class="line">    <span class="string">"id"</span>: <span class="number">1</span></span><br><span class="line">&#125;' http://zabbix.sundayle.com/api_jsonrpc.php |  python -m json.tool</span><br><span class="line"><span class="comment">--------返回的结果--------</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"id"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">"jsonrpc"</span>: <span class="string">"2.0"</span>,</span><br><span class="line">    <span class="string">"result"</span>: &#123;</span><br><span class="line">        <span class="string">"hostids"</span>: [</span><br><span class="line">            <span class="string">"10280"</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>groupid<br><img src="/images/zabbix-groupid.jpg" alt="11"><br>templateid<br><img src="/images/zabbix-templateid.jpg" alt="11"></p>
<p><a href="https://www.abcdocker.com/abcdocker/1510" target="_blank" rel="noopener">https://www.abcdocker.com/abcdocker/1510</a></p>


                <hr>

                

                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/ansible/" data-toggle="tooltip" data-placement="top" title="Ansible 自动化工具使用">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/mongodb-operation/" data-toggle="tooltip" data-placement="top" title="mongodb集群监控和运维">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                

                

            </div>
    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->

            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#zabbix" title="zabbix">zabbix</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="https://jaminzhang.github.io" target="_blank">JAMIN ZHANG</a></li>
                    
                        <li><a href="#" target="_blank">It helps SEO</a></li>
                    
                </ul>
                
            </div>

        </div>
    </div>
</article>







<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                

                

                

                
                    <li>
                        <a target="_blank"  href="https://github.com/sundayle">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; SundayLE 2019 
                    <br>
                    Theme by <a href="http://huangxuan.me">Hux</a> 
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span>
                    Ported by <a href="https://github.com/Kaijun/hexo-theme-huxblog">Kaijun</a>
            <!-- 
                    Ported by <a href="http://blog.kaijun.rocks">Kaijun</a> | 
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=kaijun&repo=hexo-theme-huxblog&type=star&count=true" >
                    </iframe>
            -->
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
     async("https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->


<script>
    // dynamic User by Hux
    var _gaId = 'UA-70699634-1';
    var _gaDomain = 'auto';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>




<!-- Baidu Tongji -->


<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog (selector) {
        var P = $('div.post-container'),a,n,t,l,i,c;
        a = P.find('h1,h2,h3,h4,h5,h6');
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#"+$(this).prop('id');
            t = $(this).text();
            c = $('<a href="'+i+'" rel="nofollow">'+t+'</a>');
            l = $('<li class="'+n+'_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;    
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function(e){
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>





<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
