<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Linux运维笔记">
    <meta name="keyword"  content="sunday,sundayhk,sundayle,sunday博客,Linxu,运维">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
          haproxy7层代理、负载均衡 - Sunday博客 | Sunday Blog
        
    </title>

    <link rel="canonical" href="http://www.sundayle.com/haproxy/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Sunday</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/archives/">Archives</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    
<!-- Image to hack wechat -->
<!-- <img src="http://www.sundayle.com/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="{{ site.baseurl }}/{% if page.header-img %}{{ page.header-img }}{% else %}{{ site.header-img }}{% endif %}" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        background-image: url('/img/home-bg.jpg')
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                          <a class="tag" href="/tags/#haproxy" title="haproxy">haproxy</a>
                        
                          <a class="tag" href="/tags/#高可用" title="高可用">高可用</a>
                        
                    </div>
                    <h1>haproxy7层代理、负载均衡</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        Posted by Sunday on
                        2018-06-25
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <h1 id="haproxy-简介"><a href="#haproxy-简介" class="headerlink" title="haproxy 简介"></a>haproxy 简介</h1><hr>
<p>HAProxy是一款提供高可用性、负载均衡以及基于TCP（第四层）和HTTP（第七层）应用的代理软件，HAProxy是完全免费的、借助HAProxy可以快速并且可靠的提供基于TCP和HTTP应用的代理解决方案。免费开源，稳定性也是非常好，这个可通过一些项目可以看出来，单Haproxy也跑得不错，稳定性可以与硬件级的F5相媲美；</p>
<h1 id="相比其他负载均衡调度器，优点有"><a href="#相比其他负载均衡调度器，优点有" class="headerlink" title="相比其他负载均衡调度器，优点有:"></a>相比其他负载均衡调度器，优点有:</h1><ul>
<li>HAProxy是支持虚拟主机的，通过frontend指令来实现</li>
<li>能够补充Nginx的一些缺点比如Session的保持，Cookie的引导等工作</li>
<li>支持url检测后端的服务器</li>
<li>它跟LVS一样，本身仅仅就只是一款负载均衡软件；单纯从效率上来讲HAProxy更会比Nginx有更出色的负载均衡速度，在并发处理上也是优于Nginx的。</li>
<li>HAProxy可以对Mysql读进行负载均衡，对后端的MySQL节点进行检测和负载均衡，不过在后端的MySQL slaves数量超过10台时性能不如LVS。</li>
<li>能对请求的url和header中的信息做匹配，有比lvs有更好的7层实现</li>
<li>精心调优，数据转发率可达 40G。双核 Xeon 1U 服务器，可获得 15000 ~ 40000 hits/s，2Gbps 的数据能力。</li>
</ul>
<h2 id="haproxy-性能特点"><a href="#haproxy-性能特点" class="headerlink" title="haproxy 性能特点"></a>haproxy 性能特点</h2><hr>
<p>HAProxy借助于OS上几种常见的技术来实现性能的最大化。<br>单进程、事件驱动模型显著降低了上下文切换的开销及内存占用。</p>
<ul>
<li>O(1)事件检查器(event checker)允许其在高并发连接中对任何连接的任何事件实现即时探测。在任何可用的情况下，单缓冲(single buffering)机制能以不复制任何数据的方式完成读写操作，这会节约大量的CPU时钟周期及内存带宽；</li>
<li>借助于Linux 2.6 (&gt;= 2.6.27.19)上的splice()系统调用，HAProxy可以实现零复制转发(Zero-copy forwarding)，在Linux 3.5及以上的OS中还可以实现零复制启动(zero-starting)；</li>
<li>MRU内存分配器在固定大小的内存池中可实现即时内存分配，这能够显著减少创建一个会话的时长；</li>
<li>树型存储：侧重于使用作者多年前开发的弹性二叉树，实现了以O(log(N))的低开销来保持计时器命令、保持运行队列命令及管理轮询及最少连接队列；</li>
<li>优化的HTTP首部分析：优化的首部分析功能避免了在HTTP首部分析过程中重读任何内存区域；</li>
<li>精心地降低了昂贵的系统调用，大部分工作都在用户空间完成，如时间读取、缓冲聚合及文件描述符的启用和禁用等；<br>所有的这些细微之处的优化实现了在中等规模负载之上依然有着相当低的CPU负载，甚至于在非常高的负载场景中，5%的用户空间占用率和95%的系统空间占用率也是非常普遍的现象，这意味着HAProxy进程消耗比系统空间消耗低20倍以上。</li>
</ul>
<p>从这个例子可看出，对OS进行性能调优是非常重要的。即使用户空间的占用率提高一倍，其CPU占用率也仅为10%，这也解释了为何7层处理对性能影响有限这一现象。由此，在高端系统上HAProxy的7层性能可轻易超过硬件负载均衡设备。</p>
<p>在生产环境中，在7层处理上使用HAProxy作为昂贵的高端硬件负载均衡设备故障故障时的紧急解决方案也时长可见。硬件负载均衡设备在“报文”级别处理请求，这在支持跨报文请求(request across multiple packets)有着较高的难度，并且它们不缓冲任何数据，因此有着较长的响应时间。对应地，软件负载均衡设备使用TCP缓冲，可建立极长的请求，且有着较大的响应时间。</p>
<h2 id="负载均衡器的性能评估因素"><a href="#负载均衡器的性能评估因素" class="headerlink" title="负载均衡器的性能评估因素"></a>负载均衡器的性能评估因素</h2><hr>
<p>三个重要因素：</p>
<h2 id="会话率-：单位时间内的处理的请求数"><a href="#会话率-：单位时间内的处理的请求数" class="headerlink" title="会话率 ：单位时间内的处理的请求数"></a>会话率 ：单位时间内的处理的请求数</h2><p>这个指标非常重要，因为它直接决定了一个均衡调度器是否能够将它所接收到的所有请求分发出去。这个性能通常依赖于 CPU。<br>对于 HTTP/1.0 和 HTTP/1.1 协议，当关闭了 keep-alive 连接保持功能，session/s 和 requests/s 或者 hits/s 是一样的。<br>对于 HTTP/1.0 和 HTTP/1.1 协议，当开启了 keep-alive 连接保持功能，requests/s 或者 hits/s 要高很多，因为服务器端的工作减轻了很多，减少了很多的连接创建、关闭的工作。但这对于互联网应用没有太多意义，因为用户总是打开大量连接，但平均每个连接只发送较少的请求。<br>这个指标根据响应报文的平均大小而变化，如果响应报文是 with HTTP 302, 304 or 404 response codes，在 Xeon E5 系统上，session/s 可达到 100,000 。</p>
<h2 id="会话并发能力：并发处理能力"><a href="#会话并发能力：并发处理能力" class="headerlink" title="会话并发能力：并发处理能力"></a>会话并发能力：并发处理能力</h2><p>这个指标与上一个指标相关联。当并发会话数上升时，session/s 会下降（除非使用了 epoll 或者 kqueue 机制）。<br>如果均衡调度器每秒接收了 10000 个会话，并且在 100ms 内响应，那么并发会话数为 1000。这个数字被内存以及系统允许的文件描述符数量所限制。<br>如果是 16KB buffer，HAProxy 的每个 session 需要 34KB，30000 sessions per GB of RAM。<br>在实践环境中，socket buffer 也需要一些内存，20000 sessions per GB of RAM 更为合理。</p>
<p>4层均衡代理一般声称支持百万并发会话，因为它们需要处理 TIME_WAIT socket，因为他们不处理数据，所以不需要 buffer，而且在直接路由模式下，只处理入站的请求，不处理出站的响应，所以它们必须在长时间维持会话，避免TCP连接关闭之前切断会话。</p>
<h2 id="数据率：处理数据能力"><a href="#数据率：处理数据能力" class="headerlink" title="数据率：处理数据能力"></a>数据率：处理数据能力</h2><p>这个指标一般是 session rate 的反面。使用 MB/s 或 GB/s 做为计量单位。当传输大的对象时，可获得更高的数据率，这时 session 的创建和销毁是最少的。large object 一般会增加并发会话数。大的数据率需要占用大量的 CPU 和 bus cycles，因为需要将数据从进入的网络接口拷贝到内存，然后拷贝到数据接口。硬件负载均衡倾向于直接将数据从入口复转接到出口，以获得更高的数据率，但这样就不能对它们进行处理。</p>
<p>2014 年的 Xeon E5 可获得 40Gpbs 的数据率。<br>这里列出的最高数据是根据具体情况来的（eg: empty objects for session rate, large objects for data rate）。因为很难告诉你在各种组合场景中准确的数字。实际中，数据会低于这里给出的上限，考虑取它们的中间值是比较合适的。</p>
<p><a href="http://www.jianshu.com/p/9290f1ccbc62" target="_blank" rel="noopener">http://www.jianshu.com/p/9290f1ccbc62</a></p>
<h1 id="HAProxy-配置文件详解"><a href="#HAProxy-配置文件详解" class="headerlink" title="HAProxy 配置文件详解"></a>HAProxy 配置文件详解</h1><hr>
<h2 id="配置文件的格式"><a href="#配置文件的格式" class="headerlink" title="配置文件的格式"></a>配置文件的格式</h2><p>HAProxy的配置处理3类来主要参数来源：</p>
<ul>
<li>最优先处理的命令行参数；</li>
<li>“global”配置段，用于设定全局配置参数；</li>
<li>proxy相关配置段，如“defaults”、“listen”、“frontend”和“backend”；</li>
</ul>
<h2 id="支持的时间格式"><a href="#支持的时间格式" class="headerlink" title="支持的时间格式"></a>支持的时间格式</h2><p>一些包含了值的参数表示时间，如超时时长。这些值一般以毫秒为单位，但也可以使用其它的时间单位后缀。<br><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">us: 微秒<span class="comment">(microseconds)</span>，即<span class="number">1</span>/<span class="number">1000000</span>秒；</span><br><span class="line">ms: 毫秒<span class="comment">(milliseconds)</span>，即<span class="number">1</span>/<span class="number">1000</span>秒；</span><br><span class="line">s: 秒<span class="comment">(seconds)</span>；</span><br><span class="line">m: 分钟<span class="comment">(minutes)</span>；</span><br><span class="line">h：小时<span class="comment">(hours)</span>；</span><br><span class="line">d: 天<span class="comment">(days)</span>；</span><br></pre></td></tr></table></figure></p>
<h2 id="简单案例"><a href="#简单案例" class="headerlink" title="简单案例"></a>简单案例</h2><p>下面的例子配置了一个监听在所有接口的 80 端口上 HTTP proxy服务，它转发所有的请求至后端监听在 127.0.0.1:8000上 的”server”。<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">global</span><br><span class="line">     daemon </span><br><span class="line">     maxconn 25600</span><br><span class="line"> defaults</span><br><span class="line">     mode http </span><br><span class="line">     timeout connect 5000ms </span><br><span class="line">     timeout<span class="built_in"> client </span>50000ms </span><br><span class="line">     timeout<span class="built_in"> server </span>50000ms</span><br><span class="line"> frontend http-in</span><br><span class="line">     bind *:80 </span><br><span class="line">     default_backend servers</span><br><span class="line"> backend servers</span><br><span class="line">    <span class="built_in"> server </span>server1 127.0.0.1:8080 maxconn 32</span><br></pre></td></tr></table></figure></p>
<p>执行如下命令检查配置：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo haproxy -f configuration<span class="selector-class">.conf</span> -c</span><br></pre></td></tr></table></figure></p>
<h2 id="全局配置"><a href="#全局配置" class="headerlink" title="全局配置"></a>全局配置</h2><p><em>注，“global”配置中的参数为进程级别的参数，且通常与其运行的OS相关。</em></p>
<h3 id="1-进程管理及安全相关的参数"><a href="#1-进程管理及安全相关的参数" class="headerlink" title="(1).进程管理及安全相关的参数"></a>(1).进程管理及安全相关的参数</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">chroot &lt;jail dir&gt;：修改 haproxy 的工作目录至指定的目录并在放弃权限之前执行chroot()操作，</span><br><span class="line">可以提升haproxy的安全级别，不过需要注意的是要确保指定的目录为空目录且任何用户均不能有写权限；</span><br><span class="line"></span><br><span class="line">daemon：让haproxy以守护进程的方式工作于后台，其等同于“-D”选项的功能，当然，也可以在命令行中以“-db”</span><br><span class="line">选项将其禁用；</span><br><span class="line"></span><br><span class="line">gid &lt;number&gt;：以指定的 GID 运行haproxy，建议使用专用于运行 haproxy 的 GID，以免因权限问题带来风险；</span><br><span class="line"></span><br><span class="line">group &lt;group name&gt;：同 gid，不过指定的组名；</span><br><span class="line"></span><br><span class="line">log &lt;address&gt; &lt;facility&gt; [max level [min level]]：定义全局的 syslog 服务器，最多可以定义两个；</span><br><span class="line">什么时候发生日志给定义的 syslog 服务器？1.HAProxy 启动和退出时；2.定义了 log global 的代理也会发送</span><br><span class="line">日志给全局定义的 syslog 服务器。</span><br><span class="line"></span><br><span class="line">&lt;address&gt;: </span><br><span class="line">    IPv4 + : + UDP 端口，默认端口为 514；</span><br><span class="line">    指向一个 Unix domain socket 的文件路径（位于 chroot 内，有可写权限）</span><br><span class="line">&lt;facility&gt;: 如下其中之一</span><br><span class="line">    kern  <span class="built_in"> user </span>  mail   daemon auth   syslog lpr    news</span><br><span class="line">    uucp   cron   auth2  ftp   <span class="built_in"> ntp </span>   audit  alert  cron2</span><br><span class="line">    local0 local1 local2 local3 local4 local5 local6 local7</span><br><span class="line"></span><br><span class="line">日志等级：默认发送所有日志信息，略 --&gt; 详；</span><br><span class="line">     emerg  alert  crit   err    <span class="builtin-name">warning</span> notice <span class="builtin-name">info</span>  debug</span><br><span class="line"></span><br><span class="line">log-send-hostname [&lt;string&gt;]：在syslog信息的首部添加当前主机名，可以为“string”指定的名称，也可以缺</span><br><span class="line">省使用当前主机名；</span><br><span class="line"></span><br><span class="line">nbproc &lt;number&gt;：指定启动的haproxy进程个数，只能用于守护进程模式的haproxy；默认只启动一个进程，鉴于调</span><br><span class="line">试困难等多方面的原因，一般只在单进程仅能打开少数文件描述符的场景中才使用多进程模式；</span><br><span class="line"></span><br><span class="line">pidfile：将所有进程的 pid 写入文件，启动进程的用户必须有权限访问此文件</span><br><span class="line"></span><br><span class="line">uid：以指定的 UID 身份运行haproxy进程；</span><br><span class="line"></span><br><span class="line">ulimit-n：设定每个进程所能够打开的最大文件描述符数目，默认情况下其会自动进行计算，因此不推荐修改此选项；</span><br><span class="line"></span><br><span class="line">user：同 uid，但使用的是用户名；</span><br><span class="line"></span><br><span class="line">stats：</span><br><span class="line"></span><br><span class="line">node：定义当前节点的名称，用于HA场景中多haproxy进程共享同一个IP地址时；</span><br><span class="line"></span><br><span class="line">description：当前实例的描述信息</span><br></pre></td></tr></table></figure>
<h3 id="2-性能调整相关的参数"><a href="#2-性能调整相关的参数" class="headerlink" title="(2).性能调整相关的参数"></a>(2).性能调整相关的参数</h3><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">maxconn &lt;number&gt;：设定每个 haproxy 进程所接受的最大并发连接数，其等同于命令行选项“n”；</span><br><span class="line">“ulimit n” 自动计算的结果正是参照此参数设定的；</span><br><span class="line"></span><br><span class="line">maxpipes &lt;number&gt;：haproxy 使用 pipe 完成基于内核的tcp报文重组，此选项则用于设定每进程所允许</span><br><span class="line">使用的最大pipe个数；每个pipe会打开两个文件描述符，因此，“ulimit n”自动计算时会根据需要调大此值；</span><br><span class="line">默认为maxconn/<span class="number">4</span>，其通常会显得过大；</span><br><span class="line"></span><br><span class="line">noepoll：在Linux系统上禁用epoll机制；</span><br><span class="line"></span><br><span class="line">nokqueue：在BSE系统上禁用kqueue机制；</span><br><span class="line"></span><br><span class="line">nopoll：禁用poll机制；</span><br><span class="line"></span><br><span class="line">nosepoll：在Linux禁用启发式epoll机制；</span><br><span class="line"></span><br><span class="line">nosplice：禁止在Linux套接字上使用内核 tcp 重组，这会导致更多的recv/send系统调用；不过，</span><br><span class="line">在Linux <span class="number">2.6</span><span class="number">.2528</span>系列的内核上，tcp 重组功能有bug存在；</span><br><span class="line"></span><br><span class="line">spreadchecks &lt;<span class="number">0.</span><span class="number">.50</span>, in percent&gt;：在haproxy后端有着众多服务器的场景中，在精确的时间间隔</span><br><span class="line">后统一对众服务器进行健康状况检查可能会带来意外问题；此选项用于将其检查的时间间隔长度上增加或减小一定的随机时长；</span><br><span class="line"></span><br><span class="line">tune.bufsize &lt;number&gt;：设定buffer的大小，同样的内存条件下，较小的值可以让haproxy有能力接受更多的并发连接，</span><br><span class="line">较大的值可以让某些应用程序使用较大的cookie信息；默认为<span class="number">16384</span>，其可以在编译时修改，不过强烈建议使用默认值；</span><br><span class="line"></span><br><span class="line">tune.chksize &lt;number&gt;：设定检查缓冲区的大小，单位为字节；更大的值有助于在较大的页面中完成基于字符串或模式</span><br><span class="line">的文本查找，但也会占用更多的系统资源；不建议修改;</span><br><span class="line"></span><br><span class="line">tune.maxaccept &lt;number&gt;：设定haproxy进程内核调度运行时一次性可以接受的连接的个数，较大的值可以带来较大</span><br><span class="line">的吞吐率，默认在单进程模式下为<span class="number">100</span>，多进程模式下为<span class="number">8</span>，设定为<span class="number">1</span>可以禁止此限制；一般不建议修改；</span><br><span class="line"></span><br><span class="line">tune.maxpollevents  &lt;number&gt;：设定一次系统调用可以处理的事件最大数，默认值取决于OS；其值小于<span class="number">200</span>时可节约带宽，</span><br><span class="line">但会略微增大网络延迟，而大于<span class="number">200</span>时会降低延迟，但会稍稍增加网络带宽的占用量；</span><br><span class="line"></span><br><span class="line">tune.maxrewrite &lt;number&gt;：设定为首部重写或追加而预留的缓冲空间，建议使用<span class="number">1024</span>左右的大小；在需要使用更大的空间时，</span><br><span class="line">haproxy会自动增加其值；      </span><br><span class="line"></span><br><span class="line">tune.rcvbuf.client &lt;number&gt;：</span><br><span class="line"></span><br><span class="line">tune.rcvbuf.server &lt;number&gt;：设定内核套接字中服务端或客户端接收缓冲的大小，单位为字节；强烈推荐使用默认值；</span><br><span class="line"></span><br><span class="line">tune.sndbuf.client：</span><br><span class="line"></span><br><span class="line">tune.sndbuf.server：</span><br></pre></td></tr></table></figure>
<h3 id="3-Debug相关的参数"><a href="#3-Debug相关的参数" class="headerlink" title="(3).Debug相关的参数"></a>(3).Debug相关的参数</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">debug</span><br><span class="line">quiet</span><br></pre></td></tr></table></figure>
<h2 id="代理"><a href="#代理" class="headerlink" title="代理"></a>代理</h2><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">代理相关的配置可以如下配置段中,</span><br><span class="line"></span><br><span class="line">defaults &lt;<span class="built_in">name</span>&gt;</span><br><span class="line">frontend &lt;<span class="built_in">name</span>&gt;</span><br><span class="line">backend &lt;<span class="built_in">name</span>&gt;</span><br><span class="line">listen &lt;<span class="built_in">name</span>&gt;</span><br></pre></td></tr></table></figure>
<p>“defaults”段用于为所有其它配置段提供默认参数，这配置默认配置参数可由下一个“defaults”所重新设定。</p>
<p>“frontend”段用于定义一系列监听的套接字，这些套接字可接受客户端请求并与之建立连接。</p>
<p>“backend”段用于定义一系列“后端”服务器，代理将会将对应客户端的请求转发至这些服务器。</p>
<p>“listen”段通过关联“前端”和“后端”定义了一个完整的代理，也就是直接在 listen 组合定义了前端和后端，通常用于定义 TCP 流量。例如：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">listen main *:80</span><br><span class="line">    balance roundrobin</span><br><span class="line">   <span class="built_in"> server </span>s1 192.168.0.71:80</span><br><span class="line">   <span class="built_in"> server </span>s1 192.168.0.72:80</span><br></pre></td></tr></table></figure></p>
<p>注，所有代理的名称只能使用大写字母、小写字母、数字、-(中线)、_(下划线)、.(点号)和:(冒号)。此外，ACL名称会区分字母大小写。更详细的配置信息，请查阅官方文档</p>
<p>HAProxy 的工作模式：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HAProxy 主要支持两种代理：tcp（<span class="number">4</span>层） 和 http（<span class="number">7</span>层）。</span><br><span class="line"></span><br><span class="line">在<span class="number">7</span>层代理模式中，HAProxy 可以解析 HTTP 报文，对请求和响应报文的任意部分做 增加、修改、删除 操作。</span><br><span class="line">对报文可 允许、拒绝、转发。解析报文，重新封装。</span><br><span class="line"></span><br><span class="line">在 <span class="number">4</span> 层代理模式中，直接在 TCP 层调度，在客户端和服务器端之间建立全双工的连接。（分别与客户端和服务端建立</span><br><span class="line">连接，并将两个连接合并到一起，转发 TCP 流量）</span><br></pre></td></tr></table></figure></p>
<p>注意 https 与 http 协议是两回事，使用 https 协议也只能使用 tcp 模式。</p>
<ul>
<li>1.4 版本 <a href="http://cbonte.github.io/haproxy-dconv/1.4/configuration.html" target="_blank" rel="noopener">http://cbonte.github.io/haproxy-dconv/1.4/configuration.html</a></li>
<li>1.5 版本 <a href="http://cbonte.github.io/haproxy-dconv/1.5/configuration.html" target="_blank" rel="noopener">http://cbonte.github.io/haproxy-dconv/1.5/configuration.html</a></li>
</ul>
<h1 id="HAProxy-安装配置"><a href="#HAProxy-安装配置" class="headerlink" title="HAProxy 安装配置"></a>HAProxy 安装配置</h1><h2 id="实验拓扑"><a href="#实验拓扑" class="headerlink" title="实验拓扑"></a>实验拓扑</h2><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">     node1(<span class="number">192.168</span><span class="number">.0</span><span class="number">.71</span>)</span><br><span class="line">    / </span><br><span class="line">HAProxy </span><br><span class="line">(<span class="number">192.168</span><span class="number">.0</span><span class="number">.120</span>)</span><br><span class="line">    \</span><br><span class="line">     node2(<span class="number">192.168</span><span class="number">.0</span><span class="number">.171</span>)</span><br></pre></td></tr></table></figure>
<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><p>操作系统：CentOS 6.8</p>
<p>软件版本： haproxy-1.5.4-3.el6.x86_64</p>
<p>安装 httpd:<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@node1</span> ~]<span class="meta"># yum install -y httpd</span></span><br><span class="line">[root<span class="symbol">@node2</span> ~]<span class="meta"># yum install -y httpd</span></span><br></pre></td></tr></table></figure></p>
<p>提供测试文件<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@node1</span> ~]<span class="comment"># cat /var/www/html/index.html</span></span><br><span class="line"><span class="variable">&lt;h1&gt;</span>node1.test.com<span class="variable">&lt;/h1&gt;</span></span><br><span class="line">[root<span class="meta">@node2</span> ~]<span class="comment"># cat /var/www/html/index.html</span></span><br><span class="line"><span class="variable">&lt;h1&gt;</span>node2.test.com<span class="variable">&lt;/h1&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>启动httpd<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]#<span class="built_in"> service </span>httpd start</span><br><span class="line">正在启动 httpd：                                           [确定]</span><br><span class="line">[root@node2 ~]#<span class="built_in"> service </span>httpd start</span><br><span class="line">正在启动 httpd：                                           [确定]</span><br></pre></td></tr></table></figure></p>
<p>测试一下：<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@vm_mac ~]<span class="meta"># curl http:<span class="comment">//node1.test.com</span></span></span><br><span class="line"><span class="params">&lt;h1&gt;</span>node1.test.com<span class="params">&lt;/h1&gt;</span></span><br><span class="line">[root@vm_mac ~]<span class="meta"># curl http:<span class="comment">//node2.test.com</span></span></span><br><span class="line"><span class="params">&lt;h1&gt;</span>node2.test.com<span class="params">&lt;/h1&gt;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="安装yum源"><a href="#安装yum源" class="headerlink" title="安装yum源"></a>安装yum源</h2><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="title">@node1</span> ~]# rpm -ivh http://download.fedoraproject.org/pub/epel/<span class="number">6</span>/<span class="keyword">x</span><span class="number">86</span>_<span class="number">64</span>/epel-<span class="keyword">release</span><span class="number">-6</span><span class="number">-8</span>.noarch.rpm</span><br><span class="line">[root<span class="title">@node2</span> ~]# rpm -ivh http://download.fedoraproject.org/pub/epel/<span class="number">6</span>/<span class="keyword">x</span><span class="number">86</span>_<span class="number">64</span>/epel-<span class="keyword">release</span><span class="number">-6</span><span class="number">-8</span>.noarch.rpm</span><br><span class="line">[root<span class="title">@haproxy</span> ~]# rpm -ivh http://download.fedoraproject.org/pub/epel/<span class="number">6</span>/<span class="keyword">x</span><span class="number">86</span>_<span class="number">64</span>/epel-<span class="keyword">release</span><span class="number">-6</span><span class="number">-8</span>.noarch.rpm</span><br></pre></td></tr></table></figure>
<h2 id="同步时间"><a href="#同步时间" class="headerlink" title="同步时间"></a>同步时间</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@node1 ~]</span># <span class="selector-tag">ntpdate</span> 202<span class="selector-class">.120</span><span class="selector-class">.2</span><span class="selector-class">.101</span></span><br><span class="line"><span class="selector-attr">[root@node2 ~]</span># <span class="selector-tag">ntpdate</span> 202<span class="selector-class">.120</span><span class="selector-class">.2</span><span class="selector-class">.101</span></span><br><span class="line"><span class="selector-attr">[root@haproxy ~]</span># <span class="selector-tag">ntpdate</span> 202<span class="selector-class">.120</span><span class="selector-class">.2</span><span class="selector-class">.101</span></span><br></pre></td></tr></table></figure>
<h2 id="关闭防火墙与SELinux"><a href="#关闭防火墙与SELinux" class="headerlink" title="关闭防火墙与SELinux"></a>关闭防火墙与SELinux</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]#<span class="built_in"> service </span>iptables stop</span><br><span class="line">[root@node1 ~]# chkconfig iptables off </span><br><span class="line">[root@node1 ~]# getenforce </span><br><span class="line">Disabled</span><br><span class="line">[root@node2 ~]#<span class="built_in"> service </span>iptables stop</span><br><span class="line">[root@node2 ~]# chkconfig iptables off </span><br><span class="line">[root@node2 ~]# getenforce </span><br><span class="line">Disabled</span><br><span class="line">[root@haproxy ~]#<span class="built_in"> service </span>iptables stop</span><br><span class="line">[root@haproxy ~]# chkconfig iptables off </span><br><span class="line">[root@haproxy ~]# getenforce </span><br><span class="line">Disabled</span><br></pre></td></tr></table></figure>
<h2 id="安装haproxy"><a href="#安装haproxy" class="headerlink" title="安装haproxy"></a>安装haproxy</h2><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@haproxy</span> ~]<span class="meta"># yum install -y haproxy</span></span><br></pre></td></tr></table></figure>
<h2 id="查看一下安装文件"><a href="#查看一下安装文件" class="headerlink" title="查看一下安装文件"></a>查看一下安装文件</h2><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@vm_mac ~]<span class="meta"># rpm -ql haproxy</span></span><br><span class="line"><span class="meta-keyword">/etc/</span>haproxy</span><br><span class="line"><span class="meta-keyword">/etc/</span>haproxy/haproxy.cfg</span><br><span class="line"><span class="meta-keyword">/etc/</span>logrotate.d/haproxy</span><br><span class="line"><span class="meta-keyword">/etc/</span>rc.d/init.d/haproxy</span><br><span class="line"><span class="meta-keyword">/etc/</span>sysconfig/haproxy</span><br><span class="line"><span class="meta-keyword">/usr/</span>bin/halog</span><br><span class="line"><span class="meta-keyword">/usr/</span>bin/iprange</span><br><span class="line"><span class="meta-keyword">/usr/</span>sbin/haproxy</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>haproxy<span class="number">-1.5</span><span class="number">.4</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h2 id="haproxy-命令详解"><a href="#haproxy-命令详解" class="headerlink" title="haproxy 命令详解"></a>haproxy 命令详解</h2><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@vm_mac ~]# haproxy -h</span><br><span class="line">HA-Proxy version 1.5.4 2014/09/02</span><br><span class="line">Copyright 2000-2014 Willy Tarreau &lt;w@1wt.eu&gt;</span><br><span class="line"></span><br><span class="line">Usage : haproxy [-f &lt;cfgfile&gt;]* [ -vdVD ] [ -n &lt;maxconn&gt; ] [ -N &lt;maxpconn&gt; ]</span><br><span class="line">        [ -p &lt;pidfile&gt; ] [ -m &lt;max megs&gt; ] [ -C &lt;dir&gt; ]</span><br><span class="line">        -<span class="ruby">v displays version ; -vv shows known build options.</span></span><br><span class="line"><span class="ruby">        -d enters debug mode ; -db only disables background mode.</span></span><br><span class="line"><span class="ruby">        -dM[&lt;byte&gt;] poisons memory with &lt;byte&gt; (defaults to )</span></span><br><span class="line"><span class="ruby">        -V enters verbose mode (disables quiet mode)</span></span><br><span class="line"><span class="ruby">        -D goes daemon ; -C changes to &lt;dir&gt; before loading files.</span></span><br><span class="line"><span class="ruby">        -q quiet mode : don<span class="string">'t display messages</span></span></span><br><span class="line"><span class="ruby">        -c check mode : only check config files <span class="keyword">and</span> exit</span></span><br><span class="line"><span class="ruby">        -n sets the maximum total <span class="comment"># of connections (2000)</span></span></span><br><span class="line"><span class="ruby">        -m limits the usable amount of memory (<span class="keyword">in</span> MB)</span></span><br><span class="line"><span class="ruby">        -N sets the default, per-proxy maximum <span class="comment"># of connections (2000)</span></span></span><br><span class="line"><span class="ruby">        -L set local peer name (default to hostname)</span></span><br><span class="line"><span class="ruby">        -p writes pids of all children to this file</span></span><br><span class="line"><span class="ruby">        -de disables epoll() usage even <span class="keyword">when</span> available</span></span><br><span class="line"><span class="ruby">        -dp disables poll() usage even <span class="keyword">when</span> available</span></span><br><span class="line"><span class="ruby">        -dS disables splice usage (broken on old kernels)</span></span><br><span class="line"><span class="ruby">        -dV disables SSL verify on servers side</span></span><br><span class="line"><span class="ruby">        -sf/-st [pid ]* finishes/terminates old pids. Must be last arguments.</span></span><br></pre></td></tr></table></figure>
<p>说明：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">haproxy [-f &lt; 配置文件&gt;] [ -vdVD ] [-n 最大并发连接总数] [-N 每个侦听的最大并发数]</span><br><span class="line">[ -p &lt;当前的PID文件&gt; ] [-m &lt;内存限制M&gt;]</span><br><span class="line">-<span class="ruby">v 显示当前版本信息；-vv 显示已知的创建选项</span></span><br><span class="line"><span class="ruby">-d 前台，debug模式；-db 禁用后台模式，程序跑在前台 </span></span><br><span class="line"><span class="ruby">-V 详细模式 </span></span><br><span class="line"><span class="ruby">-D daemon模式启动 </span></span><br><span class="line"><span class="ruby">-q 安静模式,不输出信息 </span></span><br><span class="line"><span class="ruby">-c 对配置文件进行语法检查 </span></span><br><span class="line"><span class="ruby">-n 最大并发连接总数 </span></span><br><span class="line"><span class="ruby">-m 限制的可用内存大小 </span></span><br><span class="line"><span class="ruby">-N 设置默认的连接数 </span></span><br><span class="line"><span class="ruby">-p 设置当前的PID文件 </span></span><br><span class="line"><span class="ruby">-de 不使用epoll </span></span><br><span class="line"><span class="ruby">-ds 不使用speculative epoll </span></span><br><span class="line"><span class="ruby">-dp 不使用poll </span></span><br><span class="line"><span class="ruby">-sf 程序启动后向pidlist里的进程发送FINISH信号，这个参数放在命令行的最后 </span></span><br><span class="line"><span class="ruby">-st 程序启动后向pidlist里的进程发送TERMINATE信号，这个参数放在命令行的最后</span></span><br></pre></td></tr></table></figure></p>
<h2 id="查看一下默认配置文件"><a href="#查看一下默认配置文件" class="headerlink" title="查看一下默认配置文件"></a>查看一下默认配置文件</h2><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">[root@haproxy haproxy]<span class="comment"># cat haproxy.cfg</span></span><br><span class="line"><span class="comment">#--------------------------------------------------------------------- </span></span><br><span class="line"><span class="comment"># Example configuration for a possible web application.  See the </span></span><br><span class="line"><span class="comment"># full configuration options online. </span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment">#   http://haproxy.1wt.eu/download/1.4/doc/configuration.txt  #官方配置文档，很详细，英文没问题的博友，可以看看</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Global settings #全局配置文件</span></span><br><span class="line"><span class="comment">#--------------------------------------------------------------------- </span></span><br><span class="line">global </span><br><span class="line">    <span class="comment"># to have these messages end up in /var/log/haproxy.log you will </span></span><br><span class="line">    <span class="comment"># need to:  #配置日志</span></span><br><span class="line">    <span class="comment"># </span></span><br><span class="line">    <span class="comment"># 1) configure syslog to accept network log events.  This is done </span></span><br><span class="line">    <span class="comment">#    by adding the '-r' option to the SYSLOGD_OPTIONS in </span></span><br><span class="line">    <span class="comment">#    /etc/sysconfig/syslog #修改syslog配置文件</span></span><br><span class="line">    <span class="comment"># </span></span><br><span class="line">    <span class="comment"># 2) configure local2 events to go to the /var/log/haproxy.log </span></span><br><span class="line">    <span class="comment">#   file. A line like the following can be added to </span></span><br><span class="line">    <span class="comment">#   /etc/sysconfig/syslog  #定义日志设备</span></span><br><span class="line">    <span class="comment"># </span></span><br><span class="line">    <span class="comment">#    local2.*                       /var/log/haproxy.log </span></span><br><span class="line">    <span class="comment"># </span></span><br><span class="line">    log         <span class="number">127.0</span>.<span class="number">0.1</span> local2 <span class="comment">#</span></span><br><span class="line"><span class="comment">#全局的日志配置 其中日志级别是[err warning info debug]</span></span><br><span class="line"><span class="comment">#local0 是日志设备，必须为如下24种标准syslog设备的一种:</span></span><br><span class="line"><span class="comment">#kern user mail daemon auth syslog lpr news</span></span><br><span class="line"><span class="comment">#uucp cron auth2 ftp ntp audit alert cron2</span></span><br><span class="line"><span class="comment">#local0 local1 local2 local3 local4 local5 local6 local7</span></span><br><span class="line">    chroot      /var/<span class="class"><span class="keyword">lib</span>/<span class="title">haproxy</span></span></span><br><span class="line">    pidfile     /var/run/haproxy.pid <span class="comment">#将所有进程的pid写入文件启动进程的用户必须有权限访问此文件。</span></span><br><span class="line">    maxconn     <span class="number">4000</span> <span class="comment">#最大连接数，默认4000</span></span><br><span class="line">    user        haproxy <span class="comment">#用户</span></span><br><span class="line">    group       haproxy <span class="comment">#组</span></span><br><span class="line">    daemon <span class="comment">##创建1个进程进入deamon模式运行。此参数要求将运行模式设置为"daemon"</span></span><br><span class="line">    <span class="comment"># turn on stats unix socket  #unix socket 文件</span></span><br><span class="line">    stats socket /var/<span class="class"><span class="keyword">lib</span>/<span class="title">haproxy</span>/<span class="title">stats</span></span></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># common defaults that all the 'listen' and 'backend' sections will </span></span><br><span class="line"><span class="comment"># use if not designated in their block  #默认的全局设置，这些参数可以被利用配置到frontend，backend，listen组件</span></span><br><span class="line"><span class="comment">#--------------------------------------------------------------------- </span></span><br><span class="line">defaults</span><br><span class="line">    mode                    http  <span class="comment">#默认的模式mode &#123; tcp|http|health &#125;，tcp是4层，http是7层，health只会返回OK</span></span><br><span class="line">    log                     global <span class="comment">#采用全局定义的日志</span></span><br><span class="line">    option                  httplog <span class="comment">#日志类别 http 日志格式</span></span><br><span class="line">    option                  dontlognull <span class="comment">#不记录健康检查的日志信息</span></span><br><span class="line">    option http-server-close <span class="comment">#每次请求完毕后主动关闭http通道</span></span><br><span class="line">    option forwardfor       except <span class="number">127.0</span>.<span class="number">0.0</span>/<span class="number">8</span> <span class="comment">#不记录本机转发的日志</span></span><br><span class="line">    option                  redispatch <span class="comment">#serverId 对应的服务器挂掉后,强制定向到其他健康的服务器</span></span><br><span class="line">    retries                 <span class="number">3</span> <span class="comment">#3次连接失败就认为服务不可用，也可以通过后面设置</span></span><br><span class="line">    timeout http-request    <span class="number">10</span>s  <span class="comment">#请求超时</span></span><br><span class="line">    timeout queue           <span class="number">1</span>m <span class="comment">#队列超时</span></span><br><span class="line">    timeout connect         <span class="number">10</span>s <span class="comment">#连接超时</span></span><br><span class="line">    timeout client          <span class="number">1</span>m <span class="comment">#客户端连接超时</span></span><br><span class="line">    timeout server          <span class="number">1</span>m <span class="comment">#服务器连接超时</span></span><br><span class="line">    timeout http-keep-alive <span class="number">10</span>s <span class="comment">#长连接超时</span></span><br><span class="line">    timeout check           <span class="number">10</span>s  <span class="comment">#检查超时</span></span><br><span class="line">    maxconn                 <span class="number">3000</span> <span class="comment">#最大连接数</span></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># main frontend which proxys to the backends #frontend 与backends  代理配置</span></span><br><span class="line"><span class="comment">#--------------------------------------------------------------------- </span></span><br><span class="line">frontend  main *:<span class="number">5000</span></span><br><span class="line"><span class="comment">#acl策略配置</span></span><br><span class="line">    acl url_static       path_beg       -i /static /images /javascript /stylesheets </span><br><span class="line">    acl url_static       path_end       -i .jpg .gif .png .css .js</span><br><span class="line">    use_backend static          <span class="keyword">if</span> url_static  <span class="comment">#满足策略要求，则响应策略定义的backend页面</span></span><br><span class="line">    default_backend             app <span class="comment">#不满足则响应 backend 的默认页面</span></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># static backend for serving up images, stylesheets and such #定义使用静态后端图像，样式表等</span></span><br><span class="line"><span class="comment">#--------------------------------------------------------------------- </span></span><br><span class="line">backend static </span><br><span class="line">    balance     roundrobin <span class="comment">#负载均衡模式轮询</span></span><br><span class="line">    server      static <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">4331</span> check <span class="comment">#服务器定义</span></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># round robin balancing between the various backends </span></span><br><span class="line"><span class="comment">#--------------------------------------------------------------------- </span></span><br><span class="line">backend app </span><br><span class="line">    balance     roundrobin <span class="comment">#负载均衡模式轮询</span></span><br><span class="line">    server  app1 <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">5001</span> check <span class="comment">#服务器定义，check进行健康检查</span></span><br><span class="line">    server  app2 <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">5002</span> check </span><br><span class="line">    server  app3 <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">5003</span> check </span><br><span class="line">    server  app4 <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">5004</span> check</span><br></pre></td></tr></table></figure>
<p>好了，默认的配置文件我们就说到这里，相信大家对配置文件已有了大致的了解，下面我们配置一个案例，让大家更深入的了解haproxy。</p>
<h2 id="haproxy-案例演示"><a href="#haproxy-案例演示" class="headerlink" title="haproxy 案例演示"></a>haproxy 案例演示</h2><h3 id="负载均衡Web服务器的案例"><a href="#负载均衡Web服务器的案例" class="headerlink" title="负载均衡Web服务器的案例"></a>负载均衡Web服务器的案例</h3><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Global settings</span></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="built_in">global</span></span><br><span class="line">    <span class="comment"># to have these messages end up in /var/log/haproxy.log you will</span></span><br><span class="line">    <span class="comment"># need to:</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># 1) configure syslog to accept network log events.  This is done</span></span><br><span class="line">    <span class="comment">#    by adding the '-r' option to the SYSLOGD_OPTIONS in</span></span><br><span class="line">    <span class="comment">#    /etc/sysconfig/syslog</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># 2) configure local2 events to go to the /var/log/haproxy.log</span></span><br><span class="line">    <span class="comment">#   file. A line like the following can be added to</span></span><br><span class="line">    <span class="comment">#   /etc/sysconfig/syslog</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#    local2.*                       /var/log/haproxy.log</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="built_in">log</span>         <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> local2</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     <span class="number">4000</span></span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    daemon</span><br><span class="line">defaults</span><br><span class="line">    mode                    <span class="keyword">http</span></span><br><span class="line">    <span class="built_in">log</span>                     <span class="built_in">global</span></span><br><span class="line">    option                  httplog</span><br><span class="line">    option                  dontlognull</span><br><span class="line">    option <span class="keyword">http</span>-server-<span class="built_in">close</span></span><br><span class="line">    option forwardfor       except <span class="number">127.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">8</span></span><br><span class="line">    option                  redispatch</span><br><span class="line">    retries                 <span class="number">3</span></span><br><span class="line">    timeout <span class="keyword">http</span>-request    <span class="number">10</span>s</span><br><span class="line">    timeout queue           <span class="number">1</span>m</span><br><span class="line">    timeout connect         <span class="number">10</span>s</span><br><span class="line">    timeout client          <span class="number">1</span>m</span><br><span class="line">    timeout server          <span class="number">1</span>m</span><br><span class="line">    timeout <span class="keyword">http</span>-keep-alive <span class="number">10</span>s</span><br><span class="line">    timeout check           <span class="number">10</span>s</span><br><span class="line">    maxconn                 <span class="number">30000</span></span><br><span class="line">listen stats</span><br><span class="line">    mode <span class="keyword">http</span></span><br><span class="line">    bind <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">1080</span></span><br><span class="line">    stats enable</span><br><span class="line">    stats hide-<span class="built_in">version</span></span><br><span class="line">    stats uri     /haproxyadmin?stats</span><br><span class="line">    stats realm   Haproxy\ Statistics</span><br><span class="line">    stats auth    admin:admin</span><br><span class="line">    stats admin <span class="keyword">if</span> <span class="literal">TRUE</span></span><br><span class="line">frontend <span class="keyword">http</span>-<span class="keyword">in</span></span><br><span class="line">    bind *:<span class="number">80</span></span><br><span class="line">    mode <span class="keyword">http</span></span><br><span class="line">    <span class="built_in">log</span> <span class="built_in">global</span></span><br><span class="line">    option httpclose</span><br><span class="line">    option logasap</span><br><span class="line">    option dontlognull</span><br><span class="line">    capture request  header Host <span class="built_in">len</span> <span class="number">20</span></span><br><span class="line">    capture request  header Referer <span class="built_in">len</span> <span class="number">60</span></span><br><span class="line">    default_backend servers</span><br><span class="line">frontend healthcheck</span><br><span class="line">    bind :<span class="number">1099</span></span><br><span class="line">    mode <span class="keyword">http</span></span><br><span class="line">    option httpclose</span><br><span class="line">    option forwardfor</span><br><span class="line">    default_backend servers</span><br><span class="line">backend servers</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server websrv1 <span class="number">192.168</span><span class="number">.0</span><span class="number">.71</span>:<span class="number">80</span> check maxconn <span class="number">2000</span></span><br><span class="line">    server websrv2 <span class="number">192.168</span><span class="number">.0</span><span class="number">.171</span>:<span class="number">80</span> check maxconn <span class="number">2000</span></span><br></pre></td></tr></table></figure>
<p>注，首先我们来配置一下日志，不然haproxy无法记录日志。</p>
<h3 id="配置haproxy日志"><a href="#配置haproxy日志" class="headerlink" title="配置haproxy日志"></a>配置haproxy日志</h3><p>注，配置方法配置文件中已说明，我们这里来演示一下</p>
<p><strong> (1).修改系统日志的配置文件 </strong><br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[root@haproxy ~]</span><span class="comment"># vim /etc/sysconfig/rsyslog</span></span><br><span class="line"><span class="comment"># Options for rsyslogd</span></span><br><span class="line"><span class="comment"># Syslogd options are deprecated since rsyslog v3.</span></span><br><span class="line"><span class="comment"># If you want to use them, switch to compatibility mode 2 by "-c 2"</span></span><br><span class="line"><span class="comment"># See rsyslogd(8) for more details</span></span><br><span class="line"><span class="attr">SYSLOGD_OPTIONS</span>=<span class="string">"-c 2 -r"</span></span><br></pre></td></tr></table></figure></p>
<p><strong> (2).增加日志设备 </strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@haproxy ~]# vim /etc/rsyslog.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> Provides TCP syslog reception</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使其接收 TCP 连接</span></span><br><span class="line"><span class="meta">$</span><span class="bash">ModLoad imtcp</span></span><br><span class="line"><span class="meta">$</span><span class="bash">InputTCPServerRun 514</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">增加一行</span></span><br><span class="line">local2.*</span><br></pre></td></tr></table></figure></p>
<pre><code>/var/log/haproxy.log
</code></pre><p><strong> (3).重新启动一下日志服务 </strong><br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@haproxy ~]#<span class="built_in"> service </span>rsyslog restart</span><br><span class="line">关闭系统日志记录器：                                       [确定]</span><br><span class="line">启动系统日志记录器：                                       [确定]</span><br><span class="line"></span><br><span class="line">[root@vm_mac haproxy]# ss -tnl</span><br><span class="line">LISTEN     0      25                                                    :::514                                                  :::*</span><br><span class="line">LISTEN     0      25                                                     *:514</span><br></pre></td></tr></table></figure></p>
<h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><p>如上：负载均衡Web服务器的案例</p>
<h3 id="查检一下配置文件"><a href="#查检一下配置文件" class="headerlink" title="查检一下配置文件"></a>查检一下配置文件</h3><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@haproxy ~]<span class="comment"># haproxy -c -f /etc/haproxy/haproxy.cfg</span></span><br><span class="line">Configuration <span class="built_in">file</span> <span class="keyword">is</span> valid</span><br></pre></td></tr></table></figure>
<h3 id="启动haproxy"><a href="#启动haproxy" class="headerlink" title="启动haproxy"></a>启动haproxy</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@haproxy ~]#<span class="built_in"> service </span>haproxy start</span><br><span class="line">正在启动 haproxy：</span><br></pre></td></tr></table></figure>
<h3 id="查看一下端口"><a href="#查看一下端口" class="headerlink" title="查看一下端口"></a>查看一下端口</h3><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@haproxy ~]# netstat -ntulp | grep :<span class="number">80</span></span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:<span class="number">80</span>                  <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:*                   LISTEN      <span class="number">3695</span>/haproxy</span><br></pre></td></tr></table></figure>
<h3 id="测试一下"><a href="#测试一下" class="headerlink" title="测试一下"></a>测试一下</h3><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@vm_mac haproxy]<span class="meta"># curl http:<span class="comment">//192.168.0.120</span></span></span><br><span class="line"><span class="params">&lt;h1&gt;</span>lamp1.guli.com<span class="params">&lt;/h1&gt;</span></span><br><span class="line">[root@vm_mac haproxy]<span class="meta"># curl http:<span class="comment">//192.168.0.120</span></span></span><br><span class="line"><span class="params">&lt;h1&gt;</span>vm1.guli.com<span class="params">&lt;/h1&gt;</span></span><br><span class="line">[root@vm_mac haproxy]<span class="meta"># curl http:<span class="comment">//192.168.0.120</span></span></span><br><span class="line"><span class="params">&lt;h1&gt;</span>lamp1.guli.com<span class="params">&lt;/h1&gt;</span></span><br><span class="line">[root@vm_mac haproxy]<span class="meta"># curl http:<span class="comment">//192.168.0.120</span></span></span><br><span class="line"><span class="params">&lt;h1&gt;</span>vm1.guli.com<span class="params">&lt;/h1&gt;</span></span><br><span class="line">[root@vm_mac haproxy]<span class="meta"># curl http:<span class="comment">//192.168.0.120</span></span></span><br><span class="line"><span class="params">&lt;h1&gt;</span>lamp1.guli.com<span class="params">&lt;/h1&gt;</span></span><br></pre></td></tr></table></figure>
<p>大家可以看到，你不断的刷新，node1与node2在不停的切换，说明我们的haproxy负载均衡配置成功。</p>
<h1 id="HAProxy-配置文件中的关键字参考"><a href="#HAProxy-配置文件中的关键字参考" class="headerlink" title="HAProxy 配置文件中的关键字参考"></a>HAProxy 配置文件中的关键字参考</h1><h2 id="balance"><a href="#balance" class="headerlink" title="balance"></a>balance</h2><p>格式：<br><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">balance &lt;algorithm&gt; [ &lt;arguments&gt; ]   </span><br><span class="line">balance url_param &lt;param&gt; [check_post <span class="meta">[&lt;max_wait&gt;]</span>]</span><br></pre></td></tr></table></figure></p>
<p>定义负载均衡算法，可用于“defaults”、“listen”和“backend”。<algorithm>用于在负载均衡场景中挑选一个server，其仅应用于持久信息不可用的条件下或需要将一个连接重新派发至另一个服务器时。支持的算法有：</algorithm></p>
<ul>
<li><p>roundrobin：基于权重进行轮叫，在服务器的处理时间保持均匀分布时，这是最平衡、最公平的算法。此算法是动态的，<br>这表示其权重可以在运行时进行调整，不过，在设计上，使用这种算法时，支持最多 4095 个后端服务器。<br>所谓运行时调整（on the fly），比如我们做灰度发布时，让一部分服务器下线，然后修改配置。这里让服务器下线，<br>是通过 HAProxy 的状态页，将其状态切换为维护状态，就可以让其下线了，然后修改配置即可。然后让其上线。<br>对于 roundrobin 算法，如果新上线一台服务器，负载不是一下子全部分给新服务器，而是慢慢让其承担负载，这就是所谓<br>的“慢启动”。</p>
</li>
<li><p>static-rr：基于权重进行轮叫，与roundrobin类似，但是为静态方法，在运行时调整其服务器权重不会生效；不过，<br>其在支持的后端服务器上没有限制；<br>对于 static-rr 算法，如果新增一台服务器，不会慢启动，负载会立即让其分担。</p>
</li>
<li><p>leastconn：新的连接请求被派发至具有最少连接数目的后端服务器；在有着较长会话时间的场景中推荐使用此算法，<br>如 LDAP、SQL 等，其并不太适用于较短会话的应用层协议，如 HTTP；此算法是动态的，可以在运行时调整其权重；</p>
</li>
<li><p>source：将请求的源地址进行 hash 运算，并由后端服务器的权重总数相除后派发至某匹配的服务器；这可以使得同一个<br>客户端IP的请求始终被派发至某特定的服务器；不过，当服务器权重总数发生变化时，如某服务器宕机或添加了新的服务器，<br>许多客户端的请求可能会被派发至与此前请求不同的服务器；常用于负载均衡无cookie功能的基于TCP的协议；其默认为静态，<br>不过也可以使用 hash-type 修改此特性（有一种是动态）；<br>相当于 lvs 的 sh 算法，也相当于 nginx 的 ip-hash 算法。建议用于 TCP 模式的调度，且不支持使用 cookie 插入<br>模式时使用。不适用于 HTTP 协议。</p>
</li>
<li><p>uri：对URI的左半部分(“?”标记之前的部分)或整个URI进行hash运算，并与服务器的总权重相除后派发至某匹配<br>的服务器；这可以使得对同一个URI的请求总是被派发至某特定的服务器，除非服务器的权重总数发生了变化；<br>此算法常用于代理缓存（后端服务器是 Cache server），可以提高缓存的命中率，或反向代理；<br>需要注意的是，此算法仅应用于HTTP后端服务器场景；其默认为静态算法，不过也可以使用 hash-type 修改此特性<br>（有一种是动态）；<br>支持两个参数，len 和 depth，比如 uri len 80 depth 4。不过这个很少用得到。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">URL 的语法格式：</span><br><span class="line">    <span class="tag">&lt;<span class="name">scheme</span>&gt;</span>://<span class="tag">&lt;<span class="name">user</span>&gt;</span>:<span class="tag">&lt;<span class="name">password</span>&gt;</span>@<span class="tag">&lt;<span class="name">host</span>&gt;</span>:<span class="tag">&lt;<span class="name">port</span>&gt;</span>/<span class="tag">&lt;<span class="name">paht</span>&gt;</span>;<span class="tag">&lt;<span class="name">params</span>&gt;</span>?<span class="tag">&lt;<span class="name">query</span>&gt;</span>#<span class="tag">&lt;<span class="name">frag</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    ;<span class="tag">&lt;<span class="name">params</span>&gt;</span></span><br><span class="line">        - ftp://downloads.sundayle.com/pub/gnu;type=d</span><br><span class="line">        - http://www.sundayle.com/hammers;sale=false/index.html;graphics=ture</span><br><span class="line">        </span><br><span class="line">        params 通常是用来填写表单的数据</span><br><span class="line">        </span><br><span class="line">    ?<span class="tag">&lt;<span class="name">query</span>&gt;</span></span><br><span class="line">        - 有一些资源，比如数据库服务，可以对其发起询问或查询，以缩小请求的资源类型的范围。</span><br><span class="line">          大致相当于 where 查询子句。</span><br></pre></td></tr></table></figure>
</li>
<li><p>url_param：检索每个 HTTP GET 请求中，URL 的请求参数，通过 URL 的请求参数进行调度。即上面所说的 ;<params> 部分。<br>Apache 的基本认证中，用户名和密码就是通过 ;<params> 发出去的。<br>这种调度方法，常用于后端服务器需要对用户进行认证的场景中。<br>如果找到了指定的参数且其通过等于号“=”被赋予了一个值，那么此值将被执行 hash 运算并被服务器的总权重相除后派发<br>至某匹配的服务器；<br>此算法可以通过追踪请求中的用户标识进而确保同一个用户ID的请求将被送往同一个特定的服务器，除非服务器的总权重发<br>生了变化；如果某请求中没有出现指定的参数或其没有有效值，则使用轮叫算法对相应请求进行调度；此算法默认为静态的，<br>不过其也可以使用hash-type修改此特性（有一种是动态）；</params></params></p>
</li>
<li><p>hdr(<name>)：对于每个HTTP请求，通过<name>指定的HTTP首部将会被检索；如果相应的首部没有出现或其没有有效值，<br>则使用轮叫算法对相应请求进行调度；如果后端服务器有很多虚拟主机，就可以基于 Host 首部字段做 hash。<br>其有一个可选选项“use_domain_only”，可在指定检索类似Host类的首部时仅计算<br>域名部分(比如通过<a href="http://www.test.com来说，仅计算test字符串的hash值)以降低hash算法的运算量；" target="_blank" rel="noopener">www.test.com来说，仅计算test字符串的hash值)以降低hash算法的运算量；</a><br>比如有几个虚拟主机都在一个真实服务器上，可以使用 use_domain_only 选项：<br>  <a href="http://www.sundayle.com">www.sundayle.com</a><br>  web.sundayle.com<br>  w<a href="http://www.sundayle.com">www.sundayle.com</a><br>此算法默认为静态的，不过其也可以使用hash-type修改此特性（有一种是动态）；      </name></name></p>
</li>
</ul>
<ul>
<li>rdp-cookie<br>rdp-cookie(name)<br>用于 Windows 的远程桌面协议，基本很少用到。</li>
</ul>
<p><strong>如果对 mysql 服务器进行调度，用什么算法？</strong></p>
<blockquote>
<p>leastconn</p>
</blockquote>
<p><strong>如果对 ssh 服务器进行调度，用什么算法？</strong></p>
<blockquote>
<p>leastconn</p>
</blockquote>
<p><strong>如果对图片服务器进行调度，使用什么算法？</strong></p>
<blockquote>
<p>rr，因为服务器是直接访问文件系统的。</p>
</blockquote>
<p><strong>如果对图片服务器之前的缓存服务器进行调度，使用什么算法？</strong></p>
<blockquote>
<p>uri</p>
</blockquote>
<p><strong>如果对 web 动态程序服务器进行调度，使用什么算法？</strong></p>
<blockquote>
<p>一般需要保持会话，可用 source</p>
</blockquote>
<p><strong>但其实要保持会话的话，最理想的方法是基于 cookie 进行调度。</strong></p>
<h2 id="bind"><a href="#bind" class="headerlink" title="bind"></a>bind</h2><p>格式：<br><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bind <span class="meta">[&lt;address&gt;]</span>:&lt;port_range&gt; [, ...]   </span><br><span class="line">bind <span class="meta">[&lt;address&gt;]</span>:&lt;port_range&gt; [, ...] <span class="keyword">interface</span> &lt;<span class="keyword">interface</span>&gt;</span><br></pre></td></tr></table></figure></p>
<p>此指令仅能用于 frontend 和 listen 区段，用于定义一个或几个监听的套接字。<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="selector-tag">address</span>&gt;：可选选项，其可以为主机名、<span class="selector-tag">IPv4</span>地址、<span class="selector-tag">IPv6</span>地址或*；省略此选项、将其指定为*或0<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.0</span>时，</span><br><span class="line">将监听当前系统的所有<span class="selector-tag">IPv4</span>地址；</span><br><span class="line"></span><br><span class="line">&lt;<span class="selector-tag">port_range</span>&gt;：可以是一个特定的<span class="selector-tag">TCP</span>端口，也可是一个端口范围(如5005<span class="selector-tag">-5010</span>)，代理服务器将通过指定的端口</span><br><span class="line">来接收客户端请求；需要注意的是，每组监听的套接字&lt;<span class="selector-tag">address</span><span class="selector-pseudo">:port</span>&gt;在同一个实例上只能使用一次，而且小于1024</span><br><span class="line">的端口需要有特定权限的用户才能使用，这可能需要通过 <span class="selector-tag">uid</span> 参数来定义；</span><br><span class="line"></span><br><span class="line">&lt;<span class="selector-tag">interface</span>&gt;：指定物理接口的名称，仅能在<span class="selector-tag">Linux</span>系统上使用；其不能使用接口别名，而仅能使用物理接口名称，而且</span><br><span class="line">只有管理有权限指定绑定的物理接口；</span><br><span class="line"></span><br><span class="line">例如：</span><br><span class="line"></span><br><span class="line">    <span class="selector-tag">listen</span> <span class="selector-tag">http_proxy</span></span><br><span class="line">        <span class="selector-tag">bind</span> <span class="selector-pseudo">:80</span>, <span class="selector-pseudo">:443</span></span><br><span class="line">        <span class="selector-tag">bind</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:10080</span>, 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:10443</span></span><br></pre></td></tr></table></figure></p>
<h2 id="mode"><a href="#mode" class="headerlink" title="mode"></a>mode</h2><p>格式：<br><figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mode &#123; tcp|<span class="keyword">http</span>|health &#125;</span><br><span class="line">设定实例的运行模式或协议。当实现内容交换时，前端和后端必须工作于同一种模式(一般说来都是HTTP模式)，否则将无法启动实例。</span><br><span class="line"></span><br><span class="line">tcp：实例运行于纯 TCP 模式，在客户端和服务器端之间将建立一个全双工的连接，且不会对<span class="number">7</span>层报文做任何类型的检查；</span><br><span class="line">此为默认模式，通常用于 SSL、SSH、SMTP 等应用；</span><br><span class="line"></span><br><span class="line"><span class="keyword">http</span>：实例运行于HTTP模式，客户端请求在转发至后端服务器之前将被深度分析，所有不与 RFC 格式兼容的请求都会被拒绝；</span><br><span class="line"></span><br><span class="line">health：实例工作于health模式，其对入站请求仅响应“OK”信息并关闭连接，且不会记录任何日志信息；此模式将用于响应</span><br><span class="line">外部组件的健康状态检查请求；目前来讲，此模式已经废弃，因为tcp或<span class="keyword">http</span>模式中的monitor关键字可完成类似功能；</span><br></pre></td></tr></table></figure></p>
<h2 id="hash-type"><a href="#hash-type" class="headerlink" title="hash-type"></a>hash-type</h2><p>格式：<br><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hash-<span class="keyword">type</span> &lt;<span class="function"><span class="keyword">method</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>定义用于将 hash 码映射至后端服务器的方法；不能用于 frontend 区段；可用方法有 map-based 和 consistent，<br>在大多数场景下推荐使用默认的 map-based 方法。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">map-based：<span class="built_in">hash</span>表是一个包含了所有在线服务器的静态数组。其<span class="built_in">hash</span>值将会非常平滑，会将权重考虑在列，</span><br><span class="line">但其为静态方法，对在线服务器的权重进行调整将不会生效，这意味着其不支持慢速启动。此外，挑选服务器是</span><br><span class="line">根据其在数组中的位置进行的，因此，当一台服务器宕机或添加了一台新的服务器时，大多数连接将会被重新派</span><br><span class="line">发至一个与此前不同的服务器上，对于缓存服务器的工作场景来说，此方法不甚适用。</span><br><span class="line"></span><br><span class="line">consistent：<span class="built_in">hash</span>表是一个由各服务器填充而成的树状结构；基于<span class="built_in">hash</span>键在<span class="built_in">hash</span>树中查找相应的服务器时，</span><br><span class="line">最近的服务器将被选中。此方法是动态的，支持在运行时修改服务器权重，因此兼容慢速启动的特性。添加一个</span><br><span class="line">新的服务器时，仅会对一小部分请求产生影响，因此，尤其适用于后端服务器为cache的场景。不过，此算法不</span><br><span class="line">甚平滑，派发至各服务器的请求未必能达到理想的均衡效果，因此，可能需要不时的调整服务器的权重以获得更</span><br><span class="line">好的均衡性。</span><br></pre></td></tr></table></figure></p>
<p><strong>推荐对 cache servers 执行负载均衡调度时的配置</strong><br><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">balance</span> uri</span><br><span class="line"><span class="title">hash</span>-<span class="keyword">type</span> consistent</span><br></pre></td></tr></table></figure></p>
<h2 id="log"><a href="#log" class="headerlink" title="log"></a>log</h2><p>格式：<br><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">log <span class="keyword">global</span>   </span><br><span class="line">log &lt;address&gt; &lt;facility&gt; <span class="meta">[&lt;level&gt; [&lt;minlevel&gt;]</span>]</span><br></pre></td></tr></table></figure></p>
<p>为每个实例启用事件和流量日志，因此可用于所有区段。每个实例最多可以指定两个log参数，不过，如果使用了“log global”且”global”段已经定了两个log参数时，多余了 log 参数将被忽略。</p>
<p>global：当前实例的日志系统参数同”global”段中的定义时，将使用此格式；每个实例仅能定义一次“log global”语句，且其没有任何额外参数；<br><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">&lt;address&gt;</span>：定义日志发往的位置，其格式之一可以为<span class="variable">&lt;IPv4_address:PORT&gt;</span>，其中的<span class="keyword">port</span>为UDP协议端口，</span><br><span class="line">默认为<span class="number">514</span>；格式之二为Unix套接字文件路径，但需要留心chroot应用及用户的读写权限；</span><br><span class="line"></span><br><span class="line"><span class="variable">&lt;facility&gt;</span>：可以为syslog系统的标准facility之一；</span><br><span class="line"></span><br><span class="line"><span class="variable">&lt;level&gt;</span>：定义日志级别，即输出信息过滤器，默认为所有信息；指定级别时，所有等于或高于此级别的日志信息将会被发送；</span><br></pre></td></tr></table></figure></p>
<h2 id="maxconn"><a href="#maxconn" class="headerlink" title="maxconn"></a>maxconn</h2><p>格式：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">maxconn <span class="tag">&lt;<span class="name">conns</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>设定一个前端的最大并发连接数，因此，其不能用于backend区段。对于大型站点来说，可以尽可能提高此值以便让haproxy管理连接队列，从而避免无法应答用户请求。当然，此最大值不能超出“global”段中的定义。此外，需要留心的是，haproxy会为每个连接维持两个缓冲，每个缓冲的大小为8KB，再加上其它的数据，每个连接将大约占用17KB的RAM空间。这意味着经过适当优化后，有着1GB的可用RAM空间时将能维护 40000-50000 并发连接。</p>
<p>如果为<conns>指定了一个过大值，极端场景下，其最终占据的空间可能会超出当前主机的可用内存，这可能会带来意想不到的结果；因此，将其设定了一个可接受值方为明智决定。其默认为2000。</conns></p>
<h2 id="default-backend"><a href="#default-backend" class="headerlink" title="default_backend"></a>default_backend</h2><p>格式：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">default_backend <span class="tag">&lt;<span class="name">backend</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>在没有匹配的”use_backend”规则时，为实例指定使用的默认后端，因此，其不可应用于backend区段。在”frontend”和”backend”之间进行内容交换时，通常使用”use-backend”定义其匹配规则；而没有被规则匹配到的请求将由此参数指定的后端接收。</p>
<p><backend>：指定使用的后端的名称；<br>使用案例：<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">use_backend     <span class="keyword">dynamic</span>  <span class="keyword">if</span>  url_dyn</span><br><span class="line">use_backend     <span class="keyword">static</span>   <span class="keyword">if</span>  url_css url_img extension_img</span><br><span class="line">default_backend <span class="keyword">dynamic</span></span><br></pre></td></tr></table></figure></backend></p>
<h2 id="server"><a href="#server" class="headerlink" title="server"></a>server</h2><p>格式：<br><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server <span class="variable">&lt;name&gt;</span> <span class="variable">&lt;address&gt;</span>[:<span class="keyword">port</span>] [param*]</span><br></pre></td></tr></table></figure></p>
<p>为后端声明一个server，因此，不能用于defaults和frontend区段。<br><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">&lt;name&gt;</span>：为此服务器指定的内部名称，其将出现在日志及警告信息中；如果设定了<span class="string">"http-send-server-name"</span>，它</span><br><span class="line">还将被添加至发往此后端服务器的请求首部中；</span><br><span class="line"></span><br><span class="line"><span class="variable">&lt;address&gt;</span>：此服务器的的IPv4地址，也支持使用可解析的主机名，只不过在启动时需要解析主机名至相应的IPv4地址；</span><br><span class="line"></span><br><span class="line">[:<span class="keyword">port</span>]：指定将连接请求所发往的此服务器时的目标端口，其为可选项；未设定时，将使用客户端请求时的同一相端口；</span><br><span class="line">当前端绑定了多个端口时（参考 bind 指令），就不要指定端口了。</span><br><span class="line"></span><br><span class="line">[param*]：为此服务器设定的一系参数；其可用的参数非常多，具体请参考官方文档中的说明，下面仅说明几个常用的参数；</span><br></pre></td></tr></table></figure></p>
<p>服务器或默认服务器参数 [param*]：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">backup</span>：设定为备用服务器，仅在负载均衡场景中的其它 <span class="keyword">server</span> 均不可用于启用此 <span class="keyword">server</span>；</span><br><span class="line"></span><br><span class="line"><span class="keyword">check</span>：启动对此<span class="keyword">server</span>执行健康状态检查，其可以借助于额外的其它参数完成更精细的设定，如：</span><br><span class="line">    </span><br><span class="line">    inter &lt;delay&gt;：设定健康状态检查的时间间隔，单位为毫秒，默认为<span class="number">2000</span>；也可以使用fastinter和downinter</span><br><span class="line">    来根据服务器端状态优化此时间延迟；      </span><br><span class="line"></span><br><span class="line">    rise &lt;<span class="keyword">count</span>&gt;：设定健康状态检查中，某离线的<span class="keyword">server</span>从离线状态转换至正常状态需要成功检查的次数；      </span><br><span class="line"></span><br><span class="line">    fall &lt;<span class="keyword">count</span>&gt;：确认<span class="keyword">server</span>从正常状态转换为不可用状态需要检查的次数；</span><br><span class="line"></span><br><span class="line">cookie &lt;<span class="keyword">value</span>&gt;：为指定<span class="keyword">server</span>设定cookie值，此处指定的值将在请求入站时被检查，第一次为此值挑选</span><br><span class="line">的<span class="keyword">server</span>将在后续的请求中被选中，其目的在于实现持久连接的功能；</span><br><span class="line"></span><br><span class="line">maxconn &lt;maxconn&gt;：指定此服务器接受的最大并发连接数；如果发往此服务器的连接数目高于此处指定的值，</span><br><span class="line">其将被放置于请求队列，以等待其它连接被释放；</span><br><span class="line"></span><br><span class="line">maxqueue &lt;maxqueue&gt;：设定请求队列的最大长度；</span><br><span class="line"></span><br><span class="line">observe &lt;<span class="keyword">mode</span>&gt;：通过观察服务器的通信状况来判定其健康状态，默认为禁用，其支持的类型有“layer4”和“layer7”，</span><br><span class="line">“layer7”仅能用于<span class="keyword">http</span>代理场景；</span><br><span class="line"></span><br><span class="line">redir &lt;prefix&gt;：启用重定向功能，将发往此服务器的<span class="keyword">GET</span>和<span class="keyword">HEAD</span>请求均以<span class="number">302</span>状态码响应；需要注意的是，</span><br><span class="line">在prefix后面不能使用/，且不能使用相对地址，以免造成循环；例如：<span class="keyword">server</span> srv1 <span class="number">172.16</span><span class="number">.100</span><span class="number">.6</span>:<span class="number">80</span> redir </span><br><span class="line"><span class="keyword">http</span>://imageserver.test.com <span class="keyword">check</span></span><br><span class="line"></span><br><span class="line">weight &lt;weight&gt;：权重，默认为<span class="number">1</span>，最大值为<span class="number">256</span>，<span class="number">0</span>表示不参与负载均衡；</span><br></pre></td></tr></table></figure></p>
<p>执行健康检查的方式，有多种方式，对于 web 服务器，使用 httpchk，对于 mysql 服务器可以使 mysql-check，<br>还有其他的 check 选项，请参考官方文档。<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">option httpchk </span><br><span class="line">    表示基于 HTTP 协议做7层检查。比如请求主页，得到 200 响应码就可以</span><br><span class="line"></span><br><span class="line">option httpchk &lt;uri&gt;    </span><br><span class="line">    指定请求的 uri，默认为 /</span><br><span class="line"></span><br><span class="line">option httpchk &lt;method&gt; &lt;uri&gt;    </span><br><span class="line">    指定请求的方法，默认方法为 OPTIONS，因为这个方法不需要太多的处理，而且容易从日志中过滤出来。</span><br><span class="line">    指定请求的 uri，默认为 /</span><br><span class="line"></span><br><span class="line">option httpchk &lt;method&gt; &lt;uri&gt; &lt;version&gt;：不能用于 frontend 段</span><br><span class="line">    指定请求的方法、uri、版本，例如：</span><br><span class="line"></span><br><span class="line"><span class="comment"># Relay HTTPS traffic to Apache instance and check service availability</span></span><br><span class="line"><span class="comment"># using HTTP request "OPTIONS * HTTP/1.1" on port 80.</span></span><br><span class="line">backend https_relay</span><br><span class="line">    mode tcp</span><br><span class="line">    option httpchk OPTIONS * HTTP/1.1\r\nHost:\ www.test.com</span><br><span class="line">   <span class="built_in"> server </span>apache1 192.168.1.1:443 check<span class="built_in"> port </span>80</span><br><span class="line">    </span><br><span class="line">HAProxy 的工作模式是 tcp 模式。但要使用 http 检查。这里要明确定义使用什么 method 进行检查。</span><br><span class="line">方法为 OPTIONS，uri 为 *，协议为 HTTP/1.1，因为 1.1 协议要求必须携带 Host首部，所以这里也</span><br><span class="line">进行了指定。</span><br></pre></td></tr></table></figure></p>
<p>使用案例：<br><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">server first  172.16.100.7:1080 cookie first <span class="built_in"> check </span>inter 1000</span><br><span class="line">server second 172.16.100.8:1080 cookie second<span class="built_in"> check </span>inter 1000</span><br></pre></td></tr></table></figure></p>
<h2 id="capture-request-header"><a href="#capture-request-header" class="headerlink" title="capture request header"></a>capture request header</h2><p>格式：<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">capture request header <span class="symbol">&lt;name&gt;</span> <span class="built_in">len</span> <span class="symbol">&lt;length&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>在日志中添加额外的信息。</p>
<p>捕获并在日志中记录指定的请求首部最近一次出现时的第一个值，仅能用于“frontend”和“listen”区段。</p>
<p>捕获的首部值使用花括号{}括起来后添加进日志中。如果需要捕获多个首部值，它们将以指定的次序出现在日志文件中，并以竖线“|”作为分隔符。</p>
<p>不存在的首部记录为空字符串，最常需要捕获的首部包括在虚拟主机环境中使用的“Host”、上传请求首部中的“Content-length”、快速区别真实用户和网络机器人的“User-agent”，以及代理环境中记录真实请求来源的“X-Forward-For”。<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="built_in">name</span>&gt;：要捕获的首部的名称，此名称不区分字符大小写，但建议与它们出现在首部中的格式相同，比如大写首字母。</span><br><span class="line">需要注意的是，记录在日志中的是首部对应的值，而非首部名称。</span><br><span class="line"></span><br><span class="line">&lt;<span class="built_in">length</span>&gt;：指定记录首部值时所记录的精确长度，超出的部分将会被忽略。</span><br><span class="line">可以捕获的请求首部的个数没有限制，但每个捕获最多只能记录<span class="number">64</span>个字符。为了保证同一个frontend中日志格式的统一性，首部捕获仅能在frontend中定义。</span><br></pre></td></tr></table></figure></p>
<p>示例：<br>capture request header Host len 15<br>capture request header X-Forwarded-For len 15<br>capture request header Referer len 15</p>
<h2 id="capture-response-header"><a href="#capture-response-header" class="headerlink" title="capture response header"></a>capture response header</h2><p>格式：<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">capture response header <span class="symbol">&lt;name&gt;</span> <span class="built_in">len</span> <span class="symbol">&lt;length&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>在日志中添加额外的信息。</p>
<p>捕获并记录响应首部，其格式和要点同请求首部。</p>
<p>示例：<br>capture response header Content-length len 9<br>capture response header Location len 15</p>
<h2 id="stats-enable"><a href="#stats-enable" class="headerlink" title="stats enable"></a>stats enable</h2><p>格式：</p>
<p>启用基于程序编译时默认设置的统计报告，不能用于“frontend”区段。只要没有另外的其它设定，它们就会使用如下的配置：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">stats <span class="string">uri   :</span> /haproxy?stats</span><br><span class="line">stats realm : <span class="string">"HAProxy Statistics"</span></span><br><span class="line">stats <span class="string">auth  :</span> no authentication</span><br><span class="line">stats <span class="string">scope :</span> no restriction</span><br></pre></td></tr></table></figure></p>
<p>尽管“stats enable”一条就能够启用统计报告，但还是建议设定其它所有的参数，以免其依赖于默认设定而<br>带来非预期后果。下面是一个配置案例。<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">backend public_www</span><br><span class="line"> <span class="built_in"> server </span>websrv1 172.16.100.11:80</span><br><span class="line">  stats enable</span><br><span class="line">  stats hide-version</span><br><span class="line">  stats scope   .</span><br><span class="line">  stats uri     /haproxyadmin?stats</span><br><span class="line">  stats realm   Haproxy\ Statistics</span><br><span class="line">  stats auth    statsadmin:password</span><br><span class="line">  stats auth    statsmaster:password</span><br></pre></td></tr></table></figure></p>
<h2 id="stats-hide-version"><a href="#stats-hide-version" class="headerlink" title="stats hide-version"></a>stats hide-version</h2><p>格式：<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stats <span class="keyword">hide</span>-<span class="keyword">version</span></span><br></pre></td></tr></table></figure></p>
<p>启用统计报告并隐藏 HAProxy 版本报告，不能用于“frontend”区段。默认情况下，统计页面会显示一些有用信息，<br>包括 HAProxy 的版本号，然而，向所有人公开HAProxy的精确版本号是非常有风险的，因为它能帮助恶意用户快速定<br>位版本的缺陷和漏洞。</p>
<p>尽管“stats hide-version”一条就能够启用统计报告，但还是建议设定其它所有的参数，以免其依赖于默认设定而<br>带来非期后果。具体请参照“stats enable”一节的说明。</p>
<h2 id="stats-realm"><a href="#stats-realm" class="headerlink" title="stats realm"></a>stats realm</h2><p>格式：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stats realm <span class="tag">&lt;<span class="name">realm</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>启用统计报告，并且设置认证领域，不能用于“frontend”区段。</p>
<p>haproxy在读取 realm 时会将其视作一个单词，因此，中间的任何空白字符都必须使用反斜线进行转义。<br>此参数仅在与“stats auth”配合使用时有意义。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">realm</span>&gt;</span>：实现HTTP基本认证时显示在浏览器中的领域名称，用于提示用户输入一个用户名和密码。</span><br></pre></td></tr></table></figure></p>
<p>尽管“stats realm”一条就能够启用统计报告，但还是建议设定其它所有的参数，以免其依赖于默认设定而带来<br>非期后果。具体请参照“stats enable”一节的说明。</p>
<p>示例：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># public access (limited to this backend only)</span></span><br><span class="line">backend public_www</span><br><span class="line">server srv1 192.168.0.1:80</span><br><span class="line">stats enable</span><br><span class="line">stats hide-version</span><br><span class="line">stats scope .</span><br><span class="line">stats uri /admin?stats</span><br><span class="line">stats realm Haproxy\ Statistics</span><br><span class="line">stats auth admin1:AdMiN123</span><br><span class="line">stats auth admin2:AdMiN321</span><br></pre></td></tr></table></figure></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># internal monitoring access (unlimited)</span></span><br><span class="line">backend private_monitoring</span><br><span class="line">    stats enable</span><br><span class="line">    stats uri     /admin?stats</span><br><span class="line">    stats refresh 5s</span><br></pre></td></tr></table></figure>
<h2 id="stats-scope"><a href="#stats-scope" class="headerlink" title="stats scope"></a>stats scope</h2><p>格式：<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stats <span class="class">scope </span>&#123; <span class="params">&lt;name&gt;</span> | <span class="string">"."</span> &#125;</span><br></pre></td></tr></table></figure></p>
<p>启用统计报告并限定报告的区段，不能用于 “frontend” 区段。</p>
<p>当指定此语句时，统计报告将仅显示其列举出区段的报告信息，所有其它区段的信息将被隐藏。如果需要显示多个区段的统计报告，此语句可以定义多次。需要注意的是，区段名称检测仅仅是以字符串比较的方式进行，它不会真检测指定的区段是否真正存在。</p>
<p><name>：可以是一个“listen”、“frontend”或“backend”区段的名称，而“.”则表示 stats scope<br>语句所定义的当前区段。<br>尽管“stats scope”一条就能够启用统计报告，但还是建议设定其它所有的参数，以免其依赖于默认设定而<br>带来非期后果。下面是一个配置案例。<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">backend private_monitoring</span><br><span class="line">    stats enable</span><br><span class="line">    stats uri     /haproxyadmin?stats</span><br><span class="line">    stats refresh 10s</span><br></pre></td></tr></table></figure></name></p>
<h2 id="stats-auth"><a href="#stats-auth" class="headerlink" title="stats auth"></a>stats auth</h2><p>格式：<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stats auth &lt;user&gt;<span class="symbol">:&lt;passwd&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>启用带认证的统计报告功能并授权一个用户帐号，其不能用于“frontend”区段。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">user</span>&gt;</span>：授权进行访问的用户名；</span><br><span class="line"><span class="tag">&lt;<span class="name">passwd</span>&gt;</span>：此用户的访问密码，明文格式；</span><br></pre></td></tr></table></figure></p>
<p>此语句将基于默认设定启用统计报告功能，并仅允许其定义的用户访问，其也可以定义多次以授权多个用户帐号。可以结合“stats realm”参数在提示用户认证时给出一个领域说明信息。在使用非法用户访问统计功能时，<br>其将会响应一个“401 Forbidden”页面。</p>
<p>其认证方式为HTTP Basic认证，密码传输会以明文方式进行，因此，配置文件中也使用明文方式存储以说明其非<br>保密信息故此不能相同于其它关键性帐号的密码。</p>
<p>尽管“stats auth”一条就能够启用统计报告，但还是建议设定其它所有的参数，以免其依赖于默认设定<br>而带来非期后果。</p>
<h2 id="stats-admin"><a href="#stats-admin" class="headerlink" title="stats admin"></a>stats admin</h2><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">stats admin </span><span class="template-variable">&#123; <span class="keyword">if</span> | unless &#125;</span><span class="xml"> <span class="tag">&lt;<span class="name">cond</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>开启管理功能。</p>
<p>在指定的条件满足时启用统计报告页面的管理级别功能，它允许通过web接口启用或禁用服务器，<br>不过，基于安全的角度考虑，统计报告页面应该尽可能为只读的。</p>
<p>此外，如果启用了HAProxy的多进程模式，启用此管理级别将有可能导致异常行为。</p>
<p>目前来说，POST 请求方法被限制于仅能使用缓冲区减去保留部分之外的空间，因此，服务器列表不能过长，否则，<br>此请求将无法正常工作。因此，建议一次仅调整少数几个服务器。下面是两个案例，第一个限制了仅能在本机打开报告页面时启用管理级别功能，第二个定义了仅允许通过认证的用户使用管理级别功能。<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">backend stats_localhost</span><br><span class="line">    stats enable</span><br><span class="line">    stats admin <span class="keyword">if</span> LOCALHOST</span><br><span class="line">backend stats_auth</span><br><span class="line">    stats enable</span><br><span class="line">    stats auth  haproxyadmin:password</span><br><span class="line">    stats admin <span class="keyword">if</span> <span class="literal">TRUE</span></span><br></pre></td></tr></table></figure></p>
<h2 id="option-httplog"><a href="#option-httplog" class="headerlink" title="option httplog"></a>option httplog</h2><p>格式：<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">option httplog <span class="string">[ clf ]</span></span><br></pre></td></tr></table></figure></p>
<p>启用记录 HTTP 请求、会话状态和计时器的功能。<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clf：使用<span class="built_in">CLF</span>格式来代替HAProxy默认的HTTP格式，通常在使用仅支持<span class="built_in">CLF</span>格式的特定日志分析器时才需要使用此格式。</span><br></pre></td></tr></table></figure></p>
<p>默认情况下，日志输入格式非常简陋，因为其仅包括源地址、目标地址和实例名称，而“option httplog”参数将会使得日志格式变得丰富许多，其通常包括但不限于HTTP请求、连接计时器、会话状态、连接数、捕获的首部及cookie、“frontend”、“backend”及服务器名称，当然也包括源地址和端口号等。</p>
<h2 id="option-logasap"><a href="#option-logasap" class="headerlink" title="option logasap"></a>option logasap</h2><p>格式：<br><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">option</span> logasap   </span><br><span class="line"><span class="keyword">no</span> <span class="keyword">option</span> logasap</span><br></pre></td></tr></table></figure></p>
<p>启用或禁用提前将HTTP请求记入日志，不能用于“backend”区段。</p>
<p>默认情况下，HTTP请求是在请求结束时进行记录，以便能将其整体传输时长和字节数记入日志，由此，传较大的对象时，其记入日志的时长可能会略有延迟。<br>“option logasap” 参数能够在服务器发送 complete 首部时即时记录日志，只不过，此时将不记录整体传输时长和字节数。此情形下，<br>捕获“Content-Length”响应首部来记录传输的字节数是一个较好选择。下面是一个例子。<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">listen</span> <span class="selector-tag">http_proxy</span> 0<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-pseudo">:80</span></span><br><span class="line">    <span class="selector-tag">mode</span> <span class="selector-tag">http</span></span><br><span class="line">    <span class="selector-tag">option</span> <span class="selector-tag">httplog</span></span><br><span class="line">    <span class="selector-tag">option</span> <span class="selector-tag">logasap</span></span><br><span class="line">    <span class="selector-tag">log</span> 172<span class="selector-class">.16</span><span class="selector-class">.100</span><span class="selector-class">.9</span> <span class="selector-tag">local2</span></span><br></pre></td></tr></table></figure></p>
<h2 id="option-forwardfor"><a href="#option-forwardfor" class="headerlink" title="option forwardfor"></a>option forwardfor</h2><p>格式：<br><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">option forwardfor [ except &lt;network&gt; ] [ header &lt;name&gt; ] [<span class="built_in"> if-none </span>]</span><br></pre></td></tr></table></figure></p>
<p>允许在发往后端服务器的请求首部中插入“X-Forwarded-For”首部。<br><figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;network&gt;：可选参数，当指定时，源地址为匹配至此网络中的请求都禁用此功能。</span><br><span class="line"></span><br><span class="line">&lt;<span class="keyword">name</span>&gt;：可选参数，可使用一个自定义的首部，如“X-Client”来替代“X-Forwarded-<span class="keyword">For</span>”。</span><br><span class="line">有些独特的web服务器的确需要用于一个独特的首部。</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>-none：仅在此首部不存在时才将其添加至请求报文中。</span><br></pre></td></tr></table></figure></p>
<p>HAProxy工作于反向代理模式，其发往服务器的请求中的客户端IP均为HAProxy主机的地址而非真正客户端的地址，这会使得服务器端的日志信息记录不了真正的请求来源。</p>
<p>“X-Forwarded-For”首部则可用于解决此问题。HAProxy可以向每个发往服务器的请求上添加此首部，并以客户端IP为其value。</p>
<p>需要注意的是，HAProxy工作于隧道模式，其仅检查每一个连接的第一个请求，因此，仅第一个请求报文被附加此首部。如果想为每一个请求都附加此首部，请确保同时使用了这几个option：<br><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">option</span> httpclose</span><br><span class="line"><span class="keyword">option</span> forceclose</span><br><span class="line"><span class="keyword">option</span> http-<span class="built_in">server</span>-close</span><br></pre></td></tr></table></figure></p>
<p>下面是一个例子。<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">frontend</span> <span class="selector-tag">www</span></span><br><span class="line">    <span class="selector-tag">mode</span> <span class="selector-tag">http</span></span><br><span class="line">    <span class="selector-tag">option</span> <span class="selector-tag">forwardfor</span> <span class="selector-tag">except</span> 127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span></span><br></pre></td></tr></table></figure></p>
<h2 id="errorfile"><a href="#errorfile" class="headerlink" title="errorfile"></a>errorfile</h2><p>格式：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">errorfile <span class="tag">&lt;<span class="name">code</span>&gt;</span> <span class="tag">&lt;<span class="name">file</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>在用户请求不存在的页面时，返回一个页面文件给客户端而非由haproxy生成的错误代码；可用于所有段中。<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;code&gt;：指定对HTTP的哪些状态码返回指定的页面；这里可用的状态码有<span class="number">200</span>、<span class="number">400</span>、<span class="number">403</span>、<span class="number">408</span>、<span class="number">500</span>、<span class="number">502</span>、<span class="number">503</span>和<span class="number">504</span>；</span><br><span class="line">&lt;file&gt;：指定用于响应的页面文件；</span><br></pre></td></tr></table></figure></p>
<p>例如：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">errorfile <span class="number">400</span> <span class="regexp">/etc/</span>haproxy<span class="regexp">/errorpages/</span><span class="number">400</span>badreq.http</span><br><span class="line">errorfile <span class="number">403</span> <span class="regexp">/etc/</span>haproxy<span class="regexp">/errorpages/</span><span class="number">403</span>forbid.http</span><br><span class="line">errorfile <span class="number">503</span> <span class="regexp">/etc/</span>haproxy<span class="regexp">/errorpages/</span><span class="number">503</span>sorry.http</span><br></pre></td></tr></table></figure></p>
<h2 id="errorloc-和-errorloc302"><a href="#errorloc-和-errorloc302" class="headerlink" title="errorloc 和 errorloc302"></a>errorloc 和 errorloc302</h2><p>格式：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">errorloc &lt;code&gt; &lt;url&gt;   </span><br><span class="line">errorloc302 &lt;code&gt; &lt;url&gt;   </span><br><span class="line">``` </span><br><span class="line">请求错误时，返回一个HTTP重定向至某URL的信息；可用于所有配置段中。</span><br><span class="line"></span><br><span class="line">&lt;code&gt;：指定对HTTP的哪些状态码返回指定的页面；这里可用的状态码有<span class="number">200</span>、<span class="number">400</span>、<span class="number">403</span>、<span class="number">408</span>、<span class="number">500</span>、<span class="number">502</span>、<span class="number">503</span>和<span class="number">504</span>；</span><br><span class="line"></span><br><span class="line">&lt;url&gt;：Location首部中指定的页面位置的具体路径，可以是在当前服务器上的页面的相对路径，也可以使用绝对路径；</span><br><span class="line">需要注意的是，如果URI自身错误时产生某特定状态码信息的话，有可能会导致循环定向；</span><br></pre></td></tr></table></figure></p>
<p>需要留意的是，这两个关键字都会返回302状态吗，这将使得客户端使用同样的HTTP方法获取指定的URL，对于非GET方法的场景(如POST)来说会产生问题，因为返回客户的URL是不允许使用GET以外的其它方法的。如果的确有这种问题，可以使用errorloc303来返回303状态码给客户端。</p>
<h2 id="errorloc303"><a href="#errorloc303" class="headerlink" title="errorloc303"></a>errorloc303</h2><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">errorloc303 &lt;code&gt; &lt;url&gt;</span><br><span class="line">请求错误时，返回一个HTTP重定向至某URL的信息给客户端；可用于所有配置段中。</span><br><span class="line"></span><br><span class="line">&lt;code&gt;：指定对HTTP的哪些状态码返回指定的页面；这里可用的状态码有<span class="number">400</span>、<span class="number">403</span>、<span class="number">408</span>、<span class="number">500</span>、<span class="number">502</span>、<span class="number">503</span>和<span class="number">504</span>；</span><br><span class="line"></span><br><span class="line">&lt;url&gt;：Location首部中指定的页面位置的具体路径，可以是在当前服务器上的页面的相对路径，也可以使用绝对路径；</span><br><span class="line">需要注意的是，如果URI自身错误时产生某特定状态码信息的话，有可能会导致循环定向；</span><br></pre></td></tr></table></figure>
<p>例如：<br><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">backend webserver</span><br><span class="line">  server 172.16.100.6 172.16.100.6:80<span class="built_in"> check </span>maxconn 3000 cookie srv01</span><br><span class="line">  server 172.16.100.7 172.16.100.7:80<span class="built_in"> check </span>maxconn 3000 cookie srv02</span><br><span class="line">  errorloc 403 /etc/haproxy/errorpages/sorry.htm</span><br><span class="line">  errorloc 503 /etc/haproxy/errorpages/sorry.htm</span><br></pre></td></tr></table></figure></p>
<h2 id="cookie"><a href="#cookie" class="headerlink" title="cookie"></a>cookie</h2><p>cookie <name> [ rewrite | insert | prefix ] [ indirect ] [ nocache ]<br>[ postonly ] [ preserve ] [ httponly ] [ secure ]<br>[ domain <domain> ]* [ maxidle <idle> ] [ maxlife <life> ]</life></idle></domain></name></p>
<p>在 backend 中激活基于 cookie 的持久连接。</p>
<p>适用于：default, listen, backend</p>
<p><strong> 参数说明</strong><br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;name&gt;</span><br><span class="line">指定 cookie 的名字。该 cookie 可能被监测、修改、插入信息。这个 cookie 由响应报文的 Set-Cookie header 发送给客户端（只发送一次）。客户端收到该 cookie 后，在其请求报文的 Cookie header 中携带该 cookie。</span><br><span class="line"></span><br><span class="line">应特别注意，不要使该 cookie 的名字与其他 cookie 冲突。</span><br><span class="line">不同的 backends 应使用不同的 cookie name</span><br><span class="line"></span><br><span class="line">在一个 HTTP backend 中之只能定义一个 persistent cookie。</span><br><span class="line"></span><br><span class="line">例如我们在一个 backend 中定义：</span><br><span class="line">    cookie SRV insert indirect nocache</span><br><span class="line"></span><br><span class="line">在该 backend 中，cookie 的值在<span class="built_in"> server </span>语句中定义：</span><br><span class="line">   <span class="built_in"> server </span>first  10.1.1.1:1080 cookie first  check inter 1000</span><br><span class="line">   <span class="built_in"> server </span>second 10.1.1.2:1080 cookie second check inter 1000</span><br><span class="line"></span><br><span class="line">如果第一次请求调度至第一个服务器，cookie 的值为 first；如果调度至第二个服务器，cookie 的值为 second；</span><br><span class="line"></span><br><span class="line">Set-Cookie 首部的内容包含：<span class="attribute">SRV</span>=first/second，客户端收到之后，以后向该域名路径发送的请求，都会携带有包含 </span><br><span class="line"><span class="attribute">SRV</span>=first/second 的 cookie。根据 cookie 的值为 first <span class="keyword">or</span> second，请求被调度至第一个或者</span><br><span class="line">第二个服务器。这就是基于 cookie 的连接保持。这时是根据 cookie 的值来调度的，不是基于算法，即使</span><br><span class="line">backend 的算法是 roundrobin 算法，也不会进行轮询调度。</span><br></pre></td></tr></table></figure></p>
<h2 id="redirect"><a href="#redirect" class="headerlink" title="redirect"></a>redirect</h2><p>语法：<br><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">redirect location <span class="tag">&lt;<span class="name">loc</span>&gt;</span> [code <span class="tag">&lt;<span class="name">code</span>&gt;</span>] <span class="tag">&lt;<span class="name">option</span>&gt;</span> [</span><span class="template-variable">&#123;<span class="keyword">if</span> | unless&#125;</span><span class="xml"> <span class="tag">&lt;<span class="name">condition</span>&gt;</span>]</span></span><br><span class="line"><span class="xml">redirect prefix   <span class="tag">&lt;<span class="name">pfx</span>&gt;</span> [code <span class="tag">&lt;<span class="name">code</span>&gt;</span>] <span class="tag">&lt;<span class="name">option</span>&gt;</span> [</span><span class="template-variable">&#123;<span class="keyword">if</span> | unless&#125;</span><span class="xml"> <span class="tag">&lt;<span class="name">condition</span>&gt;</span>]</span></span><br><span class="line"><span class="xml">redirect scheme   <span class="tag">&lt;<span class="name">sch</span>&gt;</span> [code <span class="tag">&lt;<span class="name">code</span>&gt;</span>] <span class="tag">&lt;<span class="name">option</span>&gt;</span> [</span><span class="template-variable">&#123;<span class="keyword">if</span> | unless&#125;</span><span class="xml"> <span class="tag">&lt;<span class="name">condition</span>&gt;</span>]</span></span><br></pre></td></tr></table></figure></p>
<p>使用范围： frontend, backend, listen</p>
<p>If/unless the condition is matched, the HTTP request will lead to a redirect<br>response. If no condition is specified, the redirect applies unconditionally.</p>
<p>如果/除非 条件满足，返回重定向给客户端；如果未指定条件，表示直接返回重定向。</p>
<p>参数说明：<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;loc&gt;</span></span><br><span class="line">redirect <span class="keyword">location</span> <span class="title">&lt;loc</span>&gt;；</span><br><span class="line">使 <span class="keyword">Location</span> <span class="title">首部的值等于 loc</span>;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;pfx&gt;</span></span><br><span class="line">redirect prefix <span class="tag">&lt;pfx&gt;</span>；</span><br><span class="line">构建 <span class="keyword">Location</span> <span class="title">首部为：&lt;pfx</span>&gt; + 完整的 URI path + query <span class="keyword">string</span>；</span><br><span class="line">如果使用了 <span class="string">"drop-query"</span> 选项，表示不添加 query <span class="keyword">string</span>；</span><br><span class="line">如果 <span class="tag">&lt;pfx&gt;</span> = /，那么不需要重新构建 URI；适用的场景：重定向至同一个 URL，但是插入一个 cookie；</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;sch&gt;</span></span><br><span class="line">redirect scheme <span class="tag">&lt;sch&gt;</span>；</span><br><span class="line">构建 <span class="keyword">Location</span> <span class="title">首部为：&lt;sch</span>&gt; + <span class="string">"://"</span> + 第一个 Host 首部字段的值 + URI path + query sting</span><br><span class="line">如果使用了 <span class="string">"drop-query"</span> 选项，表示不添加 query <span class="keyword">string</span>；</span><br><span class="line">如果没有给出 URI path，或者 path = *，则使用 <span class="string">"/"</span> 替代 URI path；</span><br><span class="line">如果找不到 Host 首部字段，则返回空的 Host 首部，大部分浏览器将其解释为：重定向到同一个 host；</span><br></pre></td></tr></table></figure></p>
<p><strong>常用于将 HTTP 重定向至 HTTPS</strong><br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;code&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;code&gt;</span> 是可选的；用于指定重定向的状态码，不同的重定向码表示不同的重定向类型，支持使用 <span class="number">301</span>, <span class="number">302</span>, <span class="number">303</span>, <span class="number">307</span> <span class="keyword">and</span> <span class="number">308</span>；</span><br><span class="line"><span class="number">302</span> 是默认状态码；</span><br><span class="line"><span class="number">301</span> 表示：<span class="string">"Moved permanently"</span> 永久重定向；浏览器可以将这个 <span class="keyword">Location</span> <span class="title">进行缓存</span></span><br><span class="line"><span class="title">302</span> 表示：<span class="string">"Moved temporarily"</span> 临时重定向；浏览器不应该缓存这个 Location</span><br><span class="line"><span class="number">303</span> 表示：与 <span class="number">302</span> 相同，但浏览器会使用 GET 方法获取 location</span><br><span class="line"><span class="number">307</span> 表示：与 <span class="number">302</span> 相同，但会明确让浏览器使用同一个 method</span><br><span class="line"><span class="number">308</span> 表示：与 <span class="number">301</span> 相同，但会明确让浏览器使用同一个 method</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;option&gt;</span></span><br><span class="line">选项是用于调整重定向的行为的：</span><br><span class="line"></span><br><span class="line"><span class="string">"drop-query"</span></span><br><span class="line">用于 prefix-based redirection 和 sch-based redirection，表示设置 <span class="keyword">Location</span> <span class="title">字段时，不添加 query</span> <span class="keyword">string</span>；</span><br><span class="line">使用场景举例：将用户导向一个非安全的页面；</span><br><span class="line"></span><br><span class="line"><span class="string">"append-slash"</span></span><br><span class="line">这个选项和 drop-query 合用时，可将不是以 '/' 重定向至同一个 <span class="keyword">Location</span> <span class="title">，但在尾部添加上 '/'；</span></span><br><span class="line"><span class="title">这个修改可确保搜索引擎只看到一个 URL</span>；</span><br><span class="line">这时最好使用 <span class="number">301</span> 作为状态码；</span><br><span class="line"></span><br><span class="line"><span class="string">"set-cookie NAME[=value]"</span></span><br><span class="line">在重定向响应中添加一个 <span class="string">"Set-Cookie"</span> 首部字段；</span><br><span class="line">这使得用户的下一次访问会携带 cookie，利用这一点可以防御某些类型的 DoS 攻击；</span><br><span class="line">因为没有添加其他的 cookie 选项，所以这里设置的 cookie 是唯一的 cookie，这是其成为一个 session cookie；</span><br><span class="line">注意，对于浏览器而言，一个不带 = 符号的 cookie name，和带了 = 符号的 cookie name 是不同的；</span><br><span class="line"></span><br><span class="line"><span class="string">"clear-cookie NAME[=]"</span></span><br><span class="line">在重定向响应中添加一个 <span class="string">"Set-Cookie"</span> 首部字段，但 <span class="string">"Max-Age"</span> 属性被设置为 <span class="number">0</span>，浏览器会删除这个 cookie；</span><br><span class="line">使用场景举例：访问了一个登出页面 logout page，表示要退出访问，这时为安全考虑最好删除 cookie，以免被人盗取，这对于提高安全性是有好处的；</span><br><span class="line"></span><br><span class="line">特别要注意，<span class="string">"clear-cookie NAME"</span> 和 <span class="string">"clear-cookie NAME="</span> 是不同的；前者不会删除这样的 cookie: <span class="string">"NAME=value"</span>，必须使用 <span class="string">"clear-cookie NAME="</span> 删除这样的 cookie，这一点不同是因为浏览器而产生的，因为浏览器对其进行不同的处理。</span><br></pre></td></tr></table></figure></p>
<p>示例1：Move the login URL only to HTTPS. 强制用户使用 HTTPS 协议访问登陆页面<br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">acl <span class="keyword">clear</span>      dst_port  80</span><br><span class="line">acl secure     dst_port  8080</span><br><span class="line">acl login_page url_beg   <span class="string">/login</span></span><br><span class="line">acl logout     url_beg   <span class="string">/logout</span></span><br><span class="line">acl uid_given  url_reg   <span class="string">/login</span>?userid=[^&amp;]+</span><br><span class="line">acl cookie_<span class="keyword">set</span> hdr_sub<span class="params">(cookie)</span> SEEN=1</span><br><span class="line"></span><br><span class="line">redirect prefix   https:<span class="string">//mysite.com</span> set-cookie SEEN=1 <span class="keyword">if</span> !cookie_<span class="keyword">set</span> <span class="comment"># 如果用户访问时不携带 cookie，让其重定向使用 HTTPS 访问，并且为其设置 cookie</span></span><br><span class="line">redirect prefix   https:<span class="string">//mysite.com</span>           <span class="keyword">if</span> login_page !secure <span class="comment"># 访问登陆页面，但不是访问的安全端口，重定向使用 HTTPS 协议</span></span><br><span class="line">redirect prefix   http:<span class="string">//mysite.com</span> drop-query <span class="keyword">if</span> login_page !uid_given <span class="comment"># 访问登陆页面，但没有给出 userid 信息，让用户重新填写登陆信息</span></span><br><span class="line">redirect location http:<span class="string">//mysite.com/</span>           <span class="keyword">if</span> !login_page secure <span class="comment"># 访问非登陆页面，但却要求使用安全端口，这没必要，让用户重定向到普通页面</span></span><br><span class="line">redirect location / clear-cookie USERID=       <span class="keyword">if</span> logout <span class="comment"># 登出之后，让浏览器删除 cookie USERID=value，且重定向到首页</span></span><br></pre></td></tr></table></figure></p>
<p>示例2：Send redirects for request for articles without a ‘/‘.<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">acl missing_slash path_reg ^/article/[^/]*$</span><br><span class="line">redirect code 301<span class="built_in"> prefix </span>/ drop-query append-slash <span class="keyword">if</span> missing_slash # 不改变 URI，改变默认状态码为 301，删除 query string，并在 URI 尾部添加 <span class="string">"/"</span></span><br></pre></td></tr></table></figure></p>
<p>示例3：Redirect all HTTP traffic to HTTPS when SSL is handled by haproxy.<br><figure class="highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">acl <span class="keyword">is</span><span class="number">_</span>ssl dst<span class="number">_p</span>ort <span class="number">8080</span></span><br><span class="line">redirect scheme https <span class="keyword">if</span> !<span class="keyword">is</span><span class="number">_</span>ssl</span><br></pre></td></tr></table></figure></p>
<h2 id="HAProxy-的-web-监控功能"><a href="#HAProxy-的-web-监控功能" class="headerlink" title="HAProxy 的 web 监控功能"></a>HAProxy 的 web 监控功能</h2><p>在上面的案例中我们已经配置了监控功能 ，下面我们就来访问一下吧。</p>
<p>1.浏览器访问一下</p>
<p><a href="http://192.168.0.120:1080/haproxyadmin?stats" target="_blank" rel="noopener">http://192.168.0.120:1080/haproxyadmin?stats</a></p>
<img src="http://owsi2j3f8.bkt.clouddn.com/static/images/1935392-5031cb0d946d1b40.png">
<p>可看到有两台服务器处于运行状态</p>
<p>模拟一下故障，关闭一台服务器：<br>[root@lamp1 ~]# service httpd stop<br>Stopping httpd: [ OK ]</p>
<p>再看看一下监控：<br><img src="http://owsi2j3f8.bkt.clouddn.com/static/images/1935392-6eeaaae54a69e45d.png"><br>可看到有一台服务器被标记为红色，表示已经下线</p>
<h1 id="HAProxy-负载均衡MySQL服务的配置示例"><a href="#HAProxy-负载均衡MySQL服务的配置示例" class="headerlink" title="HAProxy 负载均衡MySQL服务的配置示例"></a>HAProxy 负载均衡MySQL服务的配置示例</h1><p>这里的配置，是对 MySQL 的只读服务器进行负载均衡，这个配置其实很简单的，frontend 监听于 3306 端口，haproxy 工作于 tcp 模式，只有一个 backend，调度算法为最小连接数算法：<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Global settings</span></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">global</span></span><br><span class="line">    <span class="comment"># to have these messages end up in /var/log/haproxy.log you will</span></span><br><span class="line">    <span class="comment"># need to:</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># 1) configure syslog to accept network log events.  This is done</span></span><br><span class="line">    <span class="comment">#    by adding the '-r' option to the SYSLOGD_OPTIONS in</span></span><br><span class="line">    <span class="comment">#    /etc/sysconfig/syslog</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># 2) configure local2 events to go to the /var/log/haproxy.log</span></span><br><span class="line">    <span class="comment">#   file. A line like the following can be added to</span></span><br><span class="line">    <span class="comment">#   /etc/sysconfig/syslog</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#    local2.*                       /var/log/haproxy.log</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="built_in">log</span>         <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> local2</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/<span class="built_in">run</span>/haproxy.pid</span><br><span class="line">    maxconn     <span class="number">4000</span></span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    daemon</span><br><span class="line">defaults</span><br><span class="line">    mode                    tcp</span><br><span class="line">    <span class="built_in">log</span>                     <span class="keyword">global</span></span><br><span class="line">    option                  httplog</span><br><span class="line">    option                  dontlognull</span><br><span class="line">    retries                 <span class="number">3</span></span><br><span class="line">    <span class="keyword">timeout</span> http-request    <span class="number">10</span>s</span><br><span class="line">    <span class="keyword">timeout</span> queue           <span class="number">1</span>m</span><br><span class="line">    <span class="keyword">timeout</span> connect         <span class="number">10</span>s</span><br><span class="line">    <span class="keyword">timeout</span> client          <span class="number">1</span>m</span><br><span class="line">    <span class="keyword">timeout</span> server          <span class="number">1</span>m</span><br><span class="line">    <span class="keyword">timeout</span> http-keep-alive <span class="number">10</span>s</span><br><span class="line">    <span class="keyword">timeout</span> check           <span class="number">10</span>s</span><br><span class="line">    maxconn                 <span class="number">600</span></span><br><span class="line">listen stats</span><br><span class="line">    mode http</span><br><span class="line">    bind <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">1080</span></span><br><span class="line">    stats enable</span><br><span class="line">    stats hide-<span class="built_in">version</span></span><br><span class="line">    stats uri     /haproxyadmin?stats</span><br><span class="line">    stats realm   Haproxy\ Statistics</span><br><span class="line">    stats auth    admin:admin</span><br><span class="line">    stats admin <span class="keyword">if</span> TRUE</span><br><span class="line">frontend mysql</span><br><span class="line">    bind *:<span class="number">3306</span></span><br><span class="line">    mode tcp</span><br><span class="line">    <span class="built_in">log</span> <span class="keyword">global</span></span><br><span class="line">    default_backend mysqlservers</span><br><span class="line">backend mysqlservers</span><br><span class="line">    balance leastconn</span><br><span class="line">    mode tcp</span><br><span class="line">    server dbsrv1 <span class="number">192.168</span><span class="number">.10</span><span class="number">.11</span>:<span class="number">3306</span> check port <span class="number">3306</span> inter <span class="number">2</span> rise <span class="number">1</span> fall <span class="number">2</span> maxconn <span class="number">300</span></span><br><span class="line">    server dbsrv2 <span class="number">192.168</span><span class="number">.10</span><span class="number">.12</span>:<span class="number">3306</span> check port <span class="number">3306</span> inter <span class="number">2</span> rise <span class="number">1</span> fall <span class="number">2</span> maxconn <span class="number">300</span></span><br></pre></td></tr></table></figure></p>
<h1 id="HAProxy-的-ACLs-详解"><a href="#HAProxy-的-ACLs-详解" class="headerlink" title="HAProxy 的 ACLs 详解"></a>HAProxy 的 ACLs 详解</h1><p>注，现在大家再来看这个配置文件应该就很容易理解了。好了，下面我们来具体说一下。<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">[root@haproxy ~]<span class="comment"># cat /etc/haproxy/haproxy.cfg</span></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Global settings 全局配置</span></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">global</span> </span><br><span class="line">    <span class="comment"># to have these messages end up in /var/log/haproxy.log you will</span></span><br><span class="line">    <span class="comment"># need to:</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># 1) configure syslog to accept network log events.  This is done</span></span><br><span class="line">    <span class="comment">#    by adding the '-r' option to the SYSLOGD_OPTIONS in</span></span><br><span class="line">    <span class="comment">#    /etc/sysconfig/syslog</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># 2) configure local2 events to go to the /var/log/haproxy.log</span></span><br><span class="line">    <span class="comment">#   file. A line like the following can be added to</span></span><br><span class="line">    <span class="comment">#   /etc/sysconfig/syslog</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#    local2.*                       /var/log/haproxy.log</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line"><span class="comment">#上面的注释是告诉我们怎么配置日志的</span></span><br><span class="line">    <span class="built_in">log</span>         <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>  local2 <span class="comment">#定义日志</span></span><br><span class="line">    chroot      /var/lib/haproxy <span class="comment">#安全模式</span></span><br><span class="line">    pidfile     /var/<span class="built_in">run</span>/haproxy.pid <span class="comment">#pid文件</span></span><br><span class="line">    maxconn     <span class="number">4000</span> <span class="comment">#最大连接数</span></span><br><span class="line">    user        haproxy <span class="comment">#用户</span></span><br><span class="line">    group       haproxy <span class="comment">#组合</span></span><br><span class="line">    daemon</span><br><span class="line"> <span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Proxy settings 代理配置，下面全是代理配置</span></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line">defaults <span class="comment">#配置默认参数的，这些参数可以被利用配置到frontend，backend，listen组件</span></span><br><span class="line">    mode                    http <span class="comment">#默认的模式mode &#123; tcp|http|health &#125;，tcp是4层，http是7层，health只会返回OK（注，health已经废弃）</span></span><br><span class="line">    <span class="built_in">log</span>                     <span class="keyword">global</span> <span class="comment">#采用全局定义的日志</span></span><br><span class="line">    option                  httplog <span class="comment">#日志类别http日志格式</span></span><br><span class="line">    option                  dontlognull <span class="comment">#不记录健康检查的日志信息</span></span><br><span class="line">    option http-server-close <span class="comment">#每次请求完毕后主动关闭http通道</span></span><br><span class="line">    option forwardfor       except <span class="number">127.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">8</span> <span class="comment">#不记录本机转发的日志</span></span><br><span class="line">    option                  redispatch <span class="comment">#serverId 对应的服务器挂掉后,强制定向到其他健康的服务器</span></span><br><span class="line">    retries                 <span class="number">3</span> <span class="comment">#3次连接失败就认为服务不可用，也可以通过后面设置</span></span><br><span class="line">    <span class="keyword">timeout</span> http-request    <span class="number">10</span>s  <span class="comment">#请求超时</span></span><br><span class="line">    <span class="keyword">timeout</span> queue           <span class="number">1</span>m <span class="comment">#队列超时</span></span><br><span class="line">    <span class="keyword">timeout</span> connect         <span class="number">10</span>s <span class="comment">#连接超时</span></span><br><span class="line">    <span class="keyword">timeout</span> client          <span class="number">1</span>m <span class="comment">#客户端连接超时</span></span><br><span class="line">    <span class="keyword">timeout</span> server          <span class="number">1</span>m <span class="comment">#服务器连接超时</span></span><br><span class="line">    <span class="keyword">timeout</span> http-keep-alive <span class="number">10</span>s <span class="comment">#长连接超时</span></span><br><span class="line">    <span class="keyword">timeout</span> check           <span class="number">10</span>s  <span class="comment">#检查超时</span></span><br><span class="line">    maxconn                 <span class="number">30000</span> <span class="comment">#最大连接数</span></span><br><span class="line">listen stats <span class="comment">#listen是Frontend和Backend的组合体。这里定义的是haproxy监控！</span></span><br><span class="line">    mode http <span class="comment">#模式http</span></span><br><span class="line">    bind <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">1080</span> <span class="comment">#绑定的监控ip与端口</span></span><br><span class="line">    stats enable <span class="comment">#启用监控</span></span><br><span class="line">    stats hide-<span class="built_in">version</span> <span class="comment">#隐藏haproxy版本 </span></span><br><span class="line">    stats uri     /haproxyadmin?stats <span class="comment">#定义的uri</span></span><br><span class="line">    stats realm   Haproxy\ Statistics <span class="comment">#定义显示文字</span></span><br><span class="line">    stats auth    admin:admin <span class="comment">#认证</span></span><br><span class="line">    stats admin <span class="keyword">if</span> TRUE</span><br><span class="line">frontend http-<span class="keyword">in</span> <span class="comment">#接收请求的前端虚拟节点，Frontend可以根据规则直接指定具体使用后端的 backend(可动态选择)。这里定义的是http服务！</span></span><br><span class="line">    bind *:<span class="number">80</span>   <span class="comment">#绑定的监控ip与端口</span></span><br><span class="line">    mode http <span class="comment">#模式http</span></span><br><span class="line">    <span class="built_in">log</span> <span class="keyword">global</span> <span class="comment">#定义日志</span></span><br><span class="line">    option httpclose <span class="comment">#每次请求完毕后主动关闭http通道</span></span><br><span class="line">    option logasap <span class="comment">#</span></span><br><span class="line">    option dontlognull <span class="comment">##不记录健康检查的日志信息</span></span><br><span class="line">    capture request  header Host len <span class="number">20</span> </span><br><span class="line">    capture request  header Referer len <span class="number">60</span></span><br><span class="line">    default_backend servers <span class="comment">#定义的默认backend</span></span><br><span class="line">frontend healthcheck</span><br><span class="line">    bind :<span class="number">1099</span></span><br><span class="line">    mode http</span><br><span class="line">    option httpclose</span><br><span class="line">    option forwardfor</span><br><span class="line">    default_backend servers <span class="comment">#定义的默认backend</span></span><br><span class="line">backend servers <span class="comment">#后端服务集群的配置，是真实的服务器，一个Backend对应一个或者多个实体服务器。</span></span><br><span class="line">    balance roundrobin <span class="comment">#负载均衡方式为轮询</span></span><br><span class="line">    server websrv1 <span class="number">192.168</span><span class="number">.18</span><span class="number">.201</span>:<span class="number">80</span> check maxconn <span class="number">2000</span> <span class="comment">#定义server，check 健康检查，maxconn 定义最大连接数</span></span><br><span class="line">    server websrv2 <span class="number">192.168</span><span class="number">.18</span><span class="number">.202</span>:<span class="number">80</span> check maxconn <span class="number">2000</span></span><br></pre></td></tr></table></figure></p>
<p>动静分离示例<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">global</span><br><span class="line">    log         127.0.0.1 local2</span><br><span class="line"></span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">   <span class="built_in"> user </span>       haproxy</span><br><span class="line">   <span class="built_in"> group </span>      haproxy</span><br><span class="line">    daemon</span><br><span class="line"></span><br><span class="line">    # turn on stats unix socket</span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    mode                    http</span><br><span class="line">    log                     global</span><br><span class="line">    option                  httplog</span><br><span class="line">    option                  dontlognull</span><br><span class="line">    option http-server-close</span><br><span class="line">    option forwardfor       except 127.0.0.0/8</span><br><span class="line">    option                  redispatch</span><br><span class="line">    retries                 3</span><br><span class="line">    timeout http-request    10s</span><br><span class="line">    timeout<span class="built_in"> queue </span>          1m</span><br><span class="line">    timeout connect         10s</span><br><span class="line">    timeout<span class="built_in"> client </span>         1m</span><br><span class="line">    timeout<span class="built_in"> server </span>         1m</span><br><span class="line">    timeout http-keep-alive 10s</span><br><span class="line">    timeout check           10s</span><br><span class="line">    maxconn                 30000</span><br><span class="line"></span><br><span class="line">listen stats</span><br><span class="line">    mode http</span><br><span class="line">    bind 0.0.0.0:1080</span><br><span class="line">    stats enable</span><br><span class="line">    stats hide-version</span><br><span class="line">    stats uri     /haproxyadmin?stats</span><br><span class="line">    stats realm   Haproxy\ Statistics</span><br><span class="line">    stats auth    admin:admin</span><br><span class="line">    stats admin <span class="keyword">if</span> <span class="literal">TRUE</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">frontend http-in</span><br><span class="line">    bind *:80</span><br><span class="line">    mode http</span><br><span class="line">    log global</span><br><span class="line">    option httpclose</span><br><span class="line">    option logasap</span><br><span class="line">    option dontlognull</span><br><span class="line">    capture request  header Host len 20</span><br><span class="line">    capture request  header Referer len 60</span><br><span class="line">    acl url_static       path_beg       -i /static /images /javascript /stylesheets</span><br><span class="line">    acl url_static       path_end       -i .jpg .jpeg .gif .png .css .js</span><br><span class="line"></span><br><span class="line">    use_backend static_servers          <span class="keyword">if</span> url_static</span><br><span class="line">    default_backend dynamic_servers</span><br><span class="line"></span><br><span class="line">backend static_servers</span><br><span class="line">    balance roundrobin</span><br><span class="line">   <span class="built_in"> server </span>imgsrv1 172.16.200.7:80 check maxconn 6000</span><br><span class="line">   <span class="built_in"> server </span>imgsrv2 172.16.200.8:80 check maxconn 6000</span><br><span class="line"></span><br><span class="line">backend dynamic_servers</span><br><span class="line">    cookie srv insert nocache</span><br><span class="line">    balance roundrobin</span><br><span class="line">   <span class="built_in"> server </span>websrv1 172.16.200.7:80 check maxconn 1000 cookie websrv1</span><br><span class="line">   <span class="built_in"> server </span>websrv2 172.16.200.8:80 check maxconn 1000 cookie websrv2</span><br><span class="line">   <span class="built_in"> server </span>websrv3 172.16.200.9:80 check maxconn 1000 cookie websrv3</span><br></pre></td></tr></table></figure></p>
<p><a href="https://www.jianshu.com/p/17d06e354e65" target="_blank" rel="noopener">https://www.jianshu.com/p/17d06e354e65</a></p>


                <hr>

                

                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/cobbler/" data-toggle="tooltip" data-placement="top" title="Cobbler 自动化部署实践">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/top/" data-toggle="tooltip" data-placement="top" title="Linux 进程工具Top解析">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                

                

            </div>
    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->

            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#haproxy" title="haproxy">haproxy</a>
                        
                          <a class="tag" href="/tags/#高可用" title="高可用">高可用</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="https://jaminzhang.github.io" target="_blank">JAMIN ZHANG</a></li>
                    
                        <li><a href="#" target="_blank">It helps SEO</a></li>
                    
                </ul>
                
            </div>

        </div>
    </div>
</article>







<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                

                

                

                
                    <li>
                        <a target="_blank"  href="https://github.com/sundayle">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Sunday 2018 
                    <br>
                    Theme by <a href="http://huangxuan.me">Hux</a> 
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span>
                    Ported by <a href="https://github.com/Kaijun/hexo-theme-huxblog">Kaijun</a>
            <!-- 
                    Ported by <a href="http://blog.kaijun.rocks">Kaijun</a> | 
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=kaijun&repo=hexo-theme-huxblog&type=star&count=true" >
                    </iframe>
            -->
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
     async("https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->


<script>
    // dynamic User by Hux
    var _gaId = 'UA-70699634-1';
    var _gaDomain = 'auto';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>




<!-- Baidu Tongji -->


<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog (selector) {
        var P = $('div.post-container'),a,n,t,l,i,c;
        a = P.find('h1,h2,h3,h4,h5,h6');
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#"+$(this).prop('id');
            t = $(this).text();
            c = $('<a href="'+i+'" rel="nofollow">'+t+'</a>');
            l = $('<li class="'+n+'_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;    
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function(e){
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>





<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
