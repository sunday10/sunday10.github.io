<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Linux运维笔记">
    <meta name="keyword"  content="sunday,sundayhk,sundayle,sunday博客,Linxu,运维">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
          Linux Apache Tomcat 8.5 安装与配置 - Sunday博客 | Sunday Blog
        
    </title>

    <link rel="canonical" href="http://www.sundayle.com/tomcat/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Sunday</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/archives/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    
<!-- Image to hack wechat -->
<!-- <img src="http://www.sundayle.com/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="{{ site.baseurl }}/{% if page.header-img %}{{ page.header-img }}{% else %}{{ site.header-img }}{% endif %}" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        background-image: url('/img/home-bg.jpg')
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                          <a class="tag" href="/tags/#tomcat" title="tomcat">tomcat</a>
                        
                    </div>
                    <h1>Linux Apache Tomcat 8.5 安装与配置</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        Posted by Sunday on
                        2018-07-08
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><p>System: CentOS 7<br>Tomcat:  Apache Tomcat/8.5.32<br>Nginx proxy: 192.168.10.100 node0.sundayle.com<br>Tomcat node1: 192.168.10.101 node1.sundayle.com<br>Tomcat node2: 192.168.10.102 node1.sundayle.com</p>
<h1 id="Tomcat-安装与配置"><a href="#Tomcat-安装与配置" class="headerlink" title="Tomcat 安装与配置"></a>Tomcat 安装与配置</h1><h2 id="java安装"><a href="#java安装" class="headerlink" title="java安装"></a>java安装</h2><p><a href="https://www.sundayle.com/2018/01/30/java/">https://www.sundayle.com/2018/01/30/java/</a></p>
<blockquote>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install -y java-<span class="number">1.8</span>.<span class="number">0</span>-openjdk java-<span class="number">1.8</span>.<span class="number">0</span>-openjdk-devel</span><br><span class="line">ln -sv /usr/<span class="class"><span class="keyword">lib</span>/<span class="title">jvm</span>/<span class="title">java</span>-1.8.0-<span class="title">openjdk</span>-1.8.0.171-8.<span class="title">b10</span>.<span class="title">el7_5</span>.<span class="title">x86_64</span> /<span class="title">usr</span>/<span class="title">lib</span>/<span class="title">jvm</span>/<span class="title">latest</span></span></span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="Java环境"><a href="#Java环境" class="headerlink" title="Java环境"></a>Java环境</h2><blockquote>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF &gt; /etc/profile.d/java.sh</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">JAVA_HOME</span>=/usr/lib/jvm/latest</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">JRE_HOME</span>=\$JAVA_HOME/jre</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">PATH</span>=\$PATH:/JRE_HOME/bin</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">CLASSPATH</span>=\$JRE_HOME/lib</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>source /etc/profile.d/java.sh </p>
</blockquote>
<h2 id="tomcat安装"><a href="#tomcat安装" class="headerlink" title="tomcat安装"></a>tomcat安装</h2><blockquote>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">useradd -s <span class="regexp">/bin/</span><span class="literal">false</span> tomcat</span><br><span class="line">wget <span class="string">http:</span><span class="comment">//mirrors.shu.edu.cn/apache/tomcat/tomcat-8/v8.5.32/bin/apache-tomcat-8.5.32.tar.gz</span></span><br><span class="line">tar xf apache-tomcat<span class="number">-8.5</span><span class="number">.32</span>.tar.gz -C <span class="regexp">/usr/</span>local/tomcat</span><br><span class="line">chown -R tomcat.tomcat <span class="regexp">/usr/</span>local/tomcat</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">source</span> /etc/<span class="keyword">profile</span>.d/tomcat.<span class="keyword">sh</span></span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>启动<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">catalina<span class="selector-class">.sh</span> start</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="启动脚本"><a href="#启动脚本" class="headerlink" title="启动脚本"></a>启动脚本</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># chkconfig: 2345 74 44</span></span><br><span class="line"><span class="comment"># description: Tomcat is a Java Servlet Container</span></span><br><span class="line">. /etc/profile</span><br><span class="line">TOMCAT_HOME=/usr/<span class="built_in">local</span>/tomcat</span><br><span class="line"><span class="function"><span class="title">start</span></span> () &#123;</span><br><span class="line">TOMCAT_PID=`ps -ef |grep <span class="string">"<span class="variable">$TOMCAT_HOME</span>"</span> |grep -v <span class="string">"grep"</span> |awk <span class="string">'&#123;print $2&#125;'</span>`</span><br><span class="line"><span class="keyword">if</span> [ -z <span class="variable">$TOMCAT_PID</span> ];<span class="keyword">then</span></span><br><span class="line">    /bin/bash <span class="variable">$TOMCAT_HOME</span>/bin/startup.sh</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> is  running"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">stop</span></span> () &#123;</span><br><span class="line">TOMCAT_PID=`ps -ef |grep <span class="string">"<span class="variable">$TOMCAT_HOME</span>"</span> |grep -v <span class="string">"grep"</span> |awk <span class="string">'&#123;print $2&#125;'</span>`</span><br><span class="line"><span class="keyword">if</span> [ -z <span class="variable">$TOMCAT_PID</span> ];<span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> is not running"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"shutting down <span class="variable">$0</span>"</span></span><br><span class="line">        <span class="built_in">kill</span> -9 <span class="string">"<span class="variable">$TOMCAT_PID</span>"</span> &amp;&amp; <span class="built_in">echo</span> <span class="string">"PID <span class="variable">$TOMCAT_PID</span> killed."</span></span><br><span class="line">        rm -rf <span class="variable">$TOMCAT_HOME</span>/&#123;temp,work&#125;/* &amp;&amp; <span class="built_in">echo</span> <span class="string">"<span class="variable">$TOMCAT_HOME</span>/&#123;work,temp&#125;/*  was deleted successfully"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">status</span></span> () &#123;</span><br><span class="line">TOMCAT_PID=`ps -ef |grep <span class="string">"<span class="variable">$TOMCAT_HOME</span>"</span> |grep -v <span class="string">"grep"</span> |awk <span class="string">'&#123;print $2&#125;'</span>`</span><br><span class="line"><span class="keyword">if</span> [ -z <span class="variable">$TOMCAT_PID</span> ];<span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> is not running"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> is running PID is <span class="variable">$TOMCAT_PID</span>"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">start)</span><br><span class="line">start</span><br><span class="line"><span class="comment">#tail -f $TOMCAT_HOME/logs/catalina.out</span></span><br><span class="line">;;</span><br><span class="line">stop)</span><br><span class="line">stop</span><br><span class="line">;;</span><br><span class="line">status)</span><br><span class="line">status</span><br><span class="line">;;</span><br><span class="line">restart)</span><br><span class="line">stop</span><br><span class="line">start</span><br><span class="line"><span class="comment">#tail -f $TOMCAT_HOME/logs/catalina.out</span></span><br><span class="line">;;</span><br><span class="line">*)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Usage:<span class="variable">$0</span>  &#123;start|stop|status|restart&#125;."</span></span><br><span class="line">;;</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure>
<p>或system<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=Apache Tomcat <span class="number">8</span></span><br><span class="line"><span class="attr">After</span>=syslog.target network.target</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Type</span>=forking</span><br><span class="line"><span class="attr">User</span>=tomcat</span><br><span class="line"><span class="attr">Group</span>=tomcat</span><br><span class="line"></span><br><span class="line"><span class="attr">Environment</span>=JAVA_HOME=/usr/lib/jvm/latest</span><br><span class="line"><span class="attr">Environment</span>=CATALINA_PID=/usr/local/tomcat/temp/tomcat.pid</span><br><span class="line"><span class="attr">Environment</span>=CATALINA_HOME=/usr/local/tomcat</span><br><span class="line"><span class="attr">Environment</span>=CATALINA_BASE=/usr/local/tomcat</span><br><span class="line"><span class="attr">Environment</span>=<span class="string">'CATALINA_OPTS=-Xms4096M -Xmx4096M -server -XX:+UseParallelGC'</span></span><br><span class="line"><span class="attr">Environment</span>=<span class="string">'CATALINA_OPTS=-Dfile.encoding=UTF-8 -server -Xms2048m -Xmx2048m -Xmn1024m -XX:SurvivorRatio=10 -XX:MaxTenuringThreshold=15 -XX:NewRatio=2 -XX:+DisableExplicitGC'</span></span><br><span class="line"><span class="attr">Environment</span>=<span class="string">'JAVA_OPTS=-Djava.awt.headless=true -Djava.security.egd=file:/dev/./urandom'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ExecStart</span>=/usr/local/tomcat/bin/startup.sh</span><br><span class="line"><span class="attr">ExecStop</span>=/bin/kill -<span class="number">15</span> <span class="variable">$MAINPID</span></span><br><span class="line"><span class="attr">Restart</span>=<span class="literal">on</span>-failure</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="builtin-name">enable</span> tomcat </span><br><span class="line">systemctl start tomcat</span><br></pre></td></tr></table></figure>
<h2 id="shutdown-sh无法停止tomcat"><a href="#shutdown-sh无法停止tomcat" class="headerlink" title="shutdown.sh无法停止tomcat"></a>shutdown.sh无法停止tomcat</h2><blockquote>
<p>vim /usr/local/tomcat/bin/shutdown.sh<br>默认值：(最后一行)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span> <span class="string">"<span class="variable">$PRGDIR</span>"</span>/<span class="string">"<span class="variable">$EXECUTABLE</span>"</span> stop <span class="string">"<span class="variable">$@</span>"</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>修改为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span> <span class="string">"<span class="variable">$PRGDIR</span>"</span>/<span class="string">"<span class="variable">$EXECUTABLE</span>"</span> stop 10 -force</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h1 id="manager-用户权限管理"><a href="#manager-用户权限管理" class="headerlink" title="manager 用户权限管理"></a>manager 用户权限管理</h1><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  <span class="tag">&lt;<span class="name">user</span> <span class="attr">username</span>=<span class="string">"role1"</span> <span class="attr">password</span>=<span class="string">"&lt;must-be-changed&gt;"</span> <span class="attr">roles</span>=<span class="string">"role1"</span>/&gt;</span></span><br><span class="line">--&gt; #添加下列三行</span><br><span class="line">  <span class="tag">&lt;<span class="name">role</span> <span class="attr">rolename</span>=<span class="string">"manager-gui"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">role</span> <span class="attr">rolename</span>=<span class="string">"admin-gui"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">user</span> <span class="attr">username</span>=<span class="string">"Tomcat"</span> <span class="attr">password</span>=<span class="string">"sunday"</span> <span class="attr">roles</span>=<span class="string">"manager-gui,admin-gui"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Tomcat-users</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong> manager host-manager 403 解除ip限制 </strong><br>tomcat8.5之后的版本，已经增强远程登录安全过滤规则，默认不支持远程登录，需要修改配置文件。<br>修改文件</p>
<blockquote>
<p>vim /usr/local/tomcat/webapps/manager/META-INF/context.xml<br>vim /usr/local/tomcat/webapps/host-manager/META-INF/context.xml </p>
</blockquote>
<p>默认值：</p>
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;Valve className="org.apache.catalina.valves.RemoteAddrValve"</span><br><span class="line">       allow="127<span class="symbol">\.</span><span class="symbol">\d</span>+<span class="symbol">\.</span><span class="symbol">\d</span>+<span class="symbol">\.</span><span class="symbol">\d</span>+|::1|0:0:0:0:0:0:0:1" /&gt;</span><br></pre></td></tr></table></figure>
<p>修改为：<br><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;Valve className="org.apache.catalina.valves.RemoteAddrValve"</span><br><span class="line">       allow="192<span class="symbol">\.</span>168<span class="symbol">\.</span>10<span class="symbol">\.</span><span class="symbol">\d</span>+|127<span class="symbol">\.</span><span class="symbol">\d</span>+<span class="symbol">\.</span><span class="symbol">\d</span>+<span class="symbol">\.</span><span class="symbol">\d</span>+|::1|0:0:0:0:0:0:0:1" /&gt;</span><br></pre></td></tr></table></figure></p>
<p>允许192.168.10.x 127.x.x.x访问。</p>
<blockquote>
<p>catalina.sh stop &amp;&amp; catalina.sh start</p>
</blockquote>
<h1 id="添加虚拟主机"><a href="#添加虚拟主机" class="headerlink" title="添加虚拟主机"></a>添加虚拟主机</h1><blockquote>
<p>mkdir /data/Tomcat/ROOT -pv<br>vim /data/Tomcat/ROOT/index.jsp<br><figure class="highlight erb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">%</span></span></span><span class="ruby">@ page language=<span class="string">"java"</span> </span><span class="xml"><span class="tag">%&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">title</span>&gt;</span>TomcatA<span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span><span class="tag">&lt;<span class="name">font</span> <span class="attr">color</span>=<span class="string">"blue"</span>&gt;</span>TomcatA.sundayle.com<span class="tag">&lt;/<span class="name">font</span>&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">align</span>=<span class="string">"centre"</span> <span class="attr">border</span>=<span class="string">"1"</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>Session ID<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">%</span></span></span><span class="ruby"> session.setAttribute(<span class="string">"sundayle.com"</span>,<span class="string">"sundayle.com"</span>); </span><span class="xml"><span class="tag">%&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">%=</span></span></span><span class="ruby"> session.getId() </span><span class="xml"><span class="tag">%&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>Created on<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">%=</span></span></span><span class="ruby"> session.getCreationTime() </span><span class="xml"><span class="tag">%&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="xml">     <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>默认目录的话，除 ROOT外,子目录(如app)可以使用 <a href="http://server_name:8080/app" target="_blank" rel="noopener">http://server_name:8080/app</a> 访问<br>如修改目录位置配置，可以修改 Host name=”localhost”或添加 Host name=”node1.sundayle.com”</p>
<blockquote>
<p>vim /usr/local/tomcat/conf/server.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--  &lt;Engine name="Catalina" defaultHost="localhost"&gt; --&gt;</span> #Nginx 反向默认是访问localhost,需要修成下列配置</span><br><span class="line">      <span class="tag">&lt;<span class="name">Engine</span> <span class="attr">name</span>=<span class="string">"Catalina"</span> <span class="attr">defaultHost</span>=<span class="string">"node2.sundayle.com"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">"localhost"</span>  <span class="attr">appBase</span>=<span class="string">"webapps"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">unpackWARs</span>=<span class="string">"true"</span> <span class="attr">autoDeploy</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">"node1.sundayle.com"</span>  <span class="attr">appBase</span>=<span class="string">"/data/Tomcat"</span> <span class="attr">unpackWARs</span>=<span class="string">"true"</span> <span class="attr">autoDeploy</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">Context</span> <span class="attr">path</span>=<span class="string">""</span> <span class="attr">docBase</span>=<span class="string">"/data/Tomcat/ROOT"</span> <span class="attr">debug</span>=<span class="string">"0"</span> <span class="attr">reloadable</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.valves.AccessLogValve"</span> <span class="attr">directory</span>=<span class="string">"logs"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">prefix</span>=<span class="string">"node1.sundayle.com_access_log"</span> <span class="attr">suffix</span>=<span class="string">".txt"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">pattern</span>=<span class="string">"%h %l %u %t &amp;quot;%r&amp;quot; %s %b"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<h1 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h1><h2 id="Nginx反向代理Tomcat"><a href="#Nginx反向代理Tomcat" class="headerlink" title="Nginx反向代理Tomcat"></a>Nginx反向代理Tomcat</h2><blockquote>
<p>echo “192.168.10.101 node1.sundayle.com”<br>echo “192.168.10.102 node2.sundayle.com”<br>echo “192.168.10.100 <a href="http://www.sundayle.com&quot;">www.sundayle.com&quot;</a><br>cat /etc/Nginx/conf.d/Tomcat_proxy.conf<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">  <span class="attribute">upstream</span> Tomcats &#123;</span><br><span class="line">    <span class="attribute">hash</span> <span class="variable">$request_uri</span> consistent;</span><br><span class="line">    <span class="comment">#ip_hash;</span></span><br><span class="line">    <span class="comment">#hash $cookie_name consistent;</span></span><br><span class="line">    <span class="attribute">server</span>  node1.sundayle.com:<span class="number">8080</span>;</span><br><span class="line">    <span class="attribute">server</span>  node2.sundayle.com:<span class="number">8080</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">  <span class="attribute">server_name</span> www.sundayle.com;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">location</span> / &#123;</span><br><span class="line">  <span class="attribute">proxy_pass</span> http://Tomcats;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>systemctl restart nginx<br><img src="http://himg.sundayle.com/static/images/QQ20180708-234451@2x.png"></p>
</blockquote>
<h2 id="Http反向代理Tomcat"><a href="#Http反向代理Tomcat" class="headerlink" title="Http反向代理Tomcat"></a>Http反向代理Tomcat</h2><h3 id="单机代理Tomcat-http"><a href="#单机代理Tomcat-http" class="headerlink" title="单机代理Tomcat http"></a>单机代理Tomcat http</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">&lt;VirtualHost *:80&gt;</span></span><br><span class="line">  <span class="attribute"><span class="nomarkup">ServerName</span></span> node0.sundayle.com</span><br><span class="line">  <span class="attribute"><span class="nomarkup">DocumentRoot</span></span> <span class="string">"/data/Tomcat"</span></span><br><span class="line">  <span class="attribute">ProxyRequests</span> <span class="literal">Off</span></span><br><span class="line">  <span class="attribute">ProxyPreserveHost</span> <span class="literal">On</span></span><br><span class="line">  <span class="attribute">ProxyPass</span> / http://node2.sundayle.com:8080/</span><br><span class="line">  <span class="attribute">ProxyPassReverse</span> / http://node2.sundayle.com:8080/</span><br><span class="line">  <span class="comment">#ProxyPassReverse / http://node2.sundayle.com:8080/app1/</span></span><br><span class="line"></span><br><span class="line">  <span class="section">&lt;Location /&gt;</span></span><br><span class="line">    <span class="attribute">Require</span> <span class="literal">all</span> granted</span><br><span class="line">  <span class="section">&lt;/Location&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="section">&lt;Proxy *&gt;</span></span><br><span class="line">    <span class="attribute">Require</span> <span class="literal">all</span> granted</span><br><span class="line">  <span class="section">&lt;/Proxy&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="section">&lt;/VirtualHost&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="单机代理Tomcat-ajp"><a href="#单机代理Tomcat-ajp" class="headerlink" title="单机代理Tomcat ajp"></a>单机代理Tomcat ajp</h3><blockquote>
<p>httpd -M | grep proxy_ajp_module #确保 proxy_ajp_module装载<br><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxy_ajp_module (<span class="name">shared</span>)</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>cat /etc/httpd/conf.d/Tomcat_ajp_proxy.conf<br><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">&lt;VirtualHost *:80&gt;</span></span><br><span class="line">  <span class="attribute"><span class="nomarkup">ServerName</span></span> node0.sundayle.com</span><br><span class="line">  <span class="attribute"><span class="nomarkup">DocumentRoot</span></span> <span class="string">"/data/Tomcat"</span></span><br><span class="line">  <span class="attribute">ProxyRequests</span> <span class="literal">Off</span></span><br><span class="line">  <span class="attribute">ProxyPreserveHost</span> <span class="literal">On</span></span><br><span class="line">  <span class="attribute">ProxyPass</span> / ajp://node1.sundayle.com:8009/</span><br><span class="line">  <span class="attribute">ProxyPassReverse</span> / ajp://node1.sundayle.com:8009/</span><br><span class="line"></span><br><span class="line">  <span class="section">&lt;Location /&gt;</span></span><br><span class="line">    <span class="attribute">Require</span> <span class="literal">all</span> granted</span><br><span class="line">  <span class="section">&lt;/Location&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="section">&lt;Proxy *&gt;</span></span><br><span class="line">    <span class="attribute">Require</span> <span class="literal">all</span> granted</span><br><span class="line">  <span class="section">&lt;/Proxy&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="section">&lt;/VirtualHost&gt;</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<h3 id="负载均衡Tomcat集群"><a href="#负载均衡Tomcat集群" class="headerlink" title="负载均衡Tomcat集群"></a>负载均衡Tomcat集群</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">&lt;Proxy balancer://Tomcatcs&gt;</span></span><br><span class="line">  <span class="attribute">BalancerMember</span> http://node1.sundayle.com:8080</span><br><span class="line">  <span class="attribute">BalancerMember</span> http://node2.sundayle.com:8080</span><br><span class="line">  <span class="attribute">ProxySet</span> lbmethod=byrequests</span><br><span class="line"><span class="section">&lt;/Proxy&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="section">&lt;VirtualHost *:80&gt;</span></span><br><span class="line">  <span class="attribute"><span class="nomarkup">ServerName</span></span> node0.sundayle.com</span><br><span class="line">  <span class="attribute"><span class="nomarkup">DocumentRoot</span></span> <span class="string">"/data/Tomcat"</span></span><br><span class="line">  <span class="attribute">ProxyRequests</span> <span class="literal">Off</span></span><br><span class="line">  <span class="attribute">ProxyVia</span> <span class="literal">On</span></span><br><span class="line">  <span class="attribute">ProxyPreserveHost</span> <span class="literal">On</span></span><br><span class="line">  <span class="section">&lt;Proxy *&gt;</span></span><br><span class="line">    <span class="attribute">Require</span> <span class="literal">all</span> granted</span><br><span class="line">  <span class="section">&lt;/Proxy&gt;</span></span><br><span class="line">  <span class="comment">#ProxyPass / http://node2.sundayle.com:8080/</span></span><br><span class="line">  <span class="comment">#ProxyPassReverse / http://node2.sundayle.com:8080/</span></span><br><span class="line">  <span class="attribute">ProxyPass</span> / balancer://Tomcatcs/</span><br><span class="line">  <span class="attribute">ProxyPassReverse</span> / balancer://Tomcatcs/</span><br><span class="line"></span><br><span class="line">  <span class="section">&lt;Location /&gt;</span></span><br><span class="line">    <span class="attribute">Require</span> <span class="literal">all</span> granted</span><br><span class="line">  <span class="section">&lt;/Location&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="section">&lt;/VirtualHost&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="负载均衡Tomcat集群会话粘性及开启状态"><a href="#负载均衡Tomcat集群会话粘性及开启状态" class="headerlink" title="负载均衡Tomcat集群会话粘性及开启状态"></a>负载均衡Tomcat集群会话粘性及开启状态</h3><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Header add <span class="keyword">Set</span>-Cookie <span class="comment">"MYID=.%&#123;BALANCER_WORKER_ROUTE&#125;e; path=/"</span><span class="comment"> env=BALANCER_ROUTE_CHANGED</span></span><br><span class="line">&lt;Proxy <span class="comment">balancer:</span>//<span class="comment">Tomcatcs&gt;</span></span><br><span class="line">  BalancerMember <span class="comment">http:</span>//<span class="comment">node1.sundayle.com:8080 route=TomcatA loadfactor=5</span></span><br><span class="line">  BalancerMember <span class="comment">http:</span>//<span class="comment">node2.sundayle.com:8080 route=TomcatB loadfactor=2</span></span><br><span class="line">  ProxySet <span class="comment">lbmethod=byrequests</span></span><br><span class="line">  ProxySet <span class="comment">stickysession=MYID</span></span><br><span class="line">&lt;/Proxy&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:<span class="number">80</span>&gt;</span><br><span class="line">  ServerName node0.sundayle.com</span><br><span class="line">  ProxyRequests Off</span><br><span class="line">  ProxyVia On</span><br><span class="line">  ProxyPreserveHost On</span><br><span class="line"></span><br><span class="line">  &lt;Proxy *&gt;</span><br><span class="line">    Require <span class="keyword">all</span> granted</span><br><span class="line">  &lt;/Proxy&gt;</span><br><span class="line">  ProxyPass / balancer:<span class="comment">//Tomcatcs/</span></span><br><span class="line">  ProxyPassReverse /<span class="comment"> balancer:</span>//<span class="comment">Tomcatcs</span>/</span><br><span class="line"></span><br><span class="line">  &lt;Location /<span class="comment">&gt;</span></span><br><span class="line">    Require <span class="comment">all granted</span></span><br><span class="line">  &lt;/Location&gt;</span><br><span class="line"></span><br><span class="line">  &lt;Location /http-stats&gt;</span><br><span class="line">    SetHandler <span class="comment">balancer-manager</span></span><br><span class="line">    ProxyPass <span class="comment">!</span></span><br><span class="line">    Require <span class="comment">all granted</span></span><br><span class="line">  &lt;/Location&gt;</span><br><span class="line"></span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>
<img src="http://himg.sundayle.com/static/images/tomcat-httpd-proxy.gif">
<h3 id="http代理解释"><a href="#http代理解释" class="headerlink" title="http代理解释"></a>http代理解释</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ProxyRequests <span class="keyword">Off</span>                  <span class="comment"># 关闭正向代理</span></span><br><span class="line">ProxyVia   <span class="keyword">On</span>               <span class="comment"># 添加首部Via(由谁代理)--&gt; 有可能会httpd被取消掉 </span></span><br><span class="line">ProxyPreserveHost <span class="keyword">On</span>               <span class="comment"># 把主机头部发送到后端；保留代理服务器上虚拟主机的头部(域名)</span></span><br><span class="line">ProxyPass / balancer://Tomcatsrv/              <span class="comment"># 把/ 代理到后端服务器的地址</span></span><br><span class="line">ProxyPassReverse / balancer://Tomcatsrv/       <span class="comment"># 把重定向返回给客户端</span></span><br><span class="line">&lt;Location /&gt;     Require all granted                  <span class="comment"># 设置代理的/ 允许谁访问</span></span><br><span class="line">&lt;Location /http-stats&gt;                  <span class="comment"># 开启管理负载均衡的接口</span></span><br><span class="line">SetHandler balancer-manager         <span class="comment"># 启动balancer-manager这个內建功能</span></span><br><span class="line">ProxyPass !                         <span class="comment"># !表示 不反代，只在本机处理</span></span><br></pre></td></tr></table></figure>
<h1 id="Tomcat-会话保持"><a href="#Tomcat-会话保持" class="headerlink" title="Tomcat 会话保持"></a>Tomcat 会话保持</h1><h2 id="Nginx-Tomcat集群会话保持"><a href="#Nginx-Tomcat集群会话保持" class="headerlink" title="Nginx+Tomcat集群会话保持"></a>Nginx+Tomcat集群会话保持</h2><p><strong> Nginx </strong></p>
<blockquote>
<p>cat /etc/Nginx/conf.d/tomcat_lb_proxy.conf<br><figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">upstream <span class="keyword">tomcatcs</span> &#123;</span><br><span class="line">    ip_hash;</span><br><span class="line">    server  node1.sundayle.com:<span class="number">8080</span>;</span><br><span class="line">    server  node2.sundayle.com:<span class="number">8080</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">server</span> &#123;</span><br><span class="line">  listen <span class="number">80</span>;</span><br><span class="line">  server_name <span class="keyword">node</span><span class="number">0</span>.sundayle.com;</span><br><span class="line"></span><br><span class="line">  location / &#123;</span><br><span class="line">    proxy_pass http://tomcatcs;</span><br><span class="line">    proxy_set_header Host <span class="variable">$proxy_host</span>;</span><br><span class="line">    proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">    proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p><strong> Tomcat1 </strong></p>
<blockquote>
<p>mkdir /data/tomcat/ROOT -pv<br>vim /usr/local/tomcat/conf/server.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">  <span class="tag">&lt;<span class="name">Engine</span> <span class="attr">name</span>=<span class="string">"Catalina"</span> <span class="attr">defaultHost</span>=<span class="string">"node1.sundayle.com"</span>&gt;</span> #将localhost 修改成新的host name</span><br><span class="line">  <span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">"localhost"</span>  <span class="attr">appBase</span>=<span class="string">"webapps"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">unpackWARs</span>=<span class="string">"true"</span> <span class="attr">autoDeploy</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.valves.AccessLogValve"</span> <span class="attr">directory</span>=<span class="string">"logs"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">prefix</span>=<span class="string">"localhost_access_log"</span> <span class="attr">suffix</span>=<span class="string">".txt"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">pattern</span>=<span class="string">"%h %l %u %t &amp;quot;%r&amp;quot; %s %b"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Host</span>&gt;</span> #下列添加</span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">"node1.sundayle.com"</span>  <span class="attr">appBase</span>=<span class="string">"/data/tomcat"</span> <span class="attr">unpackWARs</span>=<span class="string">"true"</span> <span class="attr">autoDeploy</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">Context</span> <span class="attr">path</span>=<span class="string">""</span> <span class="attr">docBase</span>=<span class="string">"/data/tomcat/ROOT"</span> <span class="attr">debug</span>=<span class="string">"0"</span> <span class="attr">reloadable</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.valves.AccessLogValve"</span> <span class="attr">directory</span>=<span class="string">"logs"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">prefix</span>=<span class="string">"node1.sundayle.com_access_log"</span> <span class="attr">suffix</span>=<span class="string">".txt"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">pattern</span>=<span class="string">"%h %l %u %t &amp;quot;%r&amp;quot; %s %b"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Engine</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>cat /data/tomcats/ROOT/index.jsp<br><figure class="highlight erb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">%</span></span></span><span class="ruby">@ page language=<span class="string">"java"</span> </span><span class="xml"><span class="tag">%&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">title</span>&gt;</span>node1<span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span><span class="tag">&lt;<span class="name">font</span> <span class="attr">color</span>=<span class="string">"blue"</span>&gt;</span>node1.sundayle.com<span class="tag">&lt;/<span class="name">font</span>&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">align</span>=<span class="string">"centre"</span> <span class="attr">border</span>=<span class="string">"1"</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>Session ID<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">%</span></span></span><span class="ruby"> session.setAttribute(<span class="string">"sundayle.com"</span>,<span class="string">"sundayle.com"</span>); </span><span class="xml"><span class="tag">%&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">%=</span></span></span><span class="ruby"> session.getId() </span><span class="xml"><span class="tag">%&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>Created on<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">%=</span></span></span><span class="ruby"> session.getCreationTime() </span><span class="xml"><span class="tag">%&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="xml">     <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>scp /data/tomcat/ROOT/index.jsp <a href="mailto:root@node2.sundayle.com" target="_blank" rel="noopener">root@node2.sundayle.com</a>:/data/tomcat/ROOT/</p>
</blockquote>
<p><strong> Tomcat2 </strong><br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed -<span class="selector-tag">i</span> <span class="string">'s#node1#node2#g'</span> /data/tomcat/ROOT/index.jsp</span><br><span class="line">sed -<span class="selector-tag">i</span> <span class="string">'s#blue#red#g'</span> /data/tomcat/ROOT/index.jsp</span><br></pre></td></tr></table></figure></p>
<p>访问node0.sundayle.com 最终效果为：通过调度器分配了一台Tomcat服务器之后，除非IP变动，否则将一直调度在这台Tomcat服务器上。</p>
<h2 id="Httpd-Tomcat集群会话保持"><a href="#Httpd-Tomcat集群会话保持" class="headerlink" title="Httpd+Tomcat集群会话保持"></a>Httpd+Tomcat集群会话保持</h2><blockquote>
<p>cat /etc/httpd/conf.d/tomcat_lb_proxy.conf<br><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Header add <span class="keyword">Set</span>-Cookie <span class="comment">"MYID=.%&#123;BALANCER_WORKER_ROUTE&#125;e; path=/"</span><span class="comment"> env=BALANCER_ROUTE_CHANGED</span></span><br><span class="line">&lt;Proxy <span class="comment">balancer:</span>//<span class="comment">tomcatcs&gt;</span></span><br><span class="line">  BalancerMember <span class="comment">http:</span>//<span class="comment">node1.sundayle.com:8080 route=TomcatA loadfactor=5</span></span><br><span class="line">  BalancerMember <span class="comment">http:</span>//<span class="comment">node2.sundayle.com:8080 route=TomcatB loadfactor=2</span></span><br><span class="line">  ProxySet <span class="comment">lbmethod=byrequests</span></span><br><span class="line">  ProxySet <span class="comment">stickysession=MYID</span></span><br><span class="line">&lt;/Proxy&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:<span class="number">80</span>&gt;</span><br><span class="line">  ServerName node0.sundayle.com</span><br><span class="line">  ProxyRequests Off </span><br><span class="line">  ProxyVia On </span><br><span class="line">  ProxyPreserveHost On</span><br><span class="line"></span><br><span class="line">  &lt;Proxy *&gt;</span><br><span class="line">    Require <span class="keyword">all</span> granted</span><br><span class="line">  &lt;/Proxy&gt; </span><br><span class="line">  ProxyPass / balancer:<span class="comment">//tomcatcs/</span></span><br><span class="line">  ProxyPassReverse /<span class="comment"> balancer:</span>//<span class="comment">tomcatcs</span>/ </span><br><span class="line"></span><br><span class="line">  &lt;Location /<span class="comment">&gt;</span></span><br><span class="line">    Require <span class="comment">all granted</span></span><br><span class="line">  &lt;/Location&gt;</span><br><span class="line"></span><br><span class="line">  &lt;Location /http-stats&gt;</span><br><span class="line">    SetHandler <span class="comment">balancer-manager</span></span><br><span class="line">    ProxyPass <span class="comment">!</span></span><br><span class="line">    Require <span class="comment">all granted</span></span><br><span class="line">  &lt;/Location&gt;</span><br><span class="line"></span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>Tomcat主机如同Nginx的Tomcat无需修改配置，直接打开浏览器验证即可</p>
<h2 id="Tomcat集群原生会话复制"><a href="#Tomcat集群原生会话复制" class="headerlink" title="Tomcat集群原生会话复制"></a>Tomcat集群原生会话复制</h2><p>优点：<br>1 实现简单。<br>2 不需要使用共享数据库，节点少，降低了故障率。<br>缺点：<br>1 同步Session数据造成了网络带宽的开销。只要Session数据有变化，就需要将数据同步到所有其他机器上，机器越多，同步带来的网络带宽开销就越大。<br>2 每台Web服务器都要保存所有Session数据，如果整个集群的Session数据很多（很多人同时访问网站）的话，每台机器用于保存Session数据的内容占用会很严重。</p>
<p>实验之前，将nginx/httpd的会话保持的配置段删除，只保留调度功能<br><figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">  upstream <span class="keyword">tomcatcs</span> &#123;</span><br><span class="line">    ip_hash;</span><br><span class="line">    server  node1.sundayle.com:<span class="number">8080</span>;</span><br><span class="line">    server  node2.sundayle.com:<span class="number">8080</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">server</span> &#123;</span><br><span class="line">  listen <span class="number">80</span>;</span><br><span class="line">  server_name <span class="number">192.168</span>.<span class="number">10.100</span>;</span><br><span class="line">  server_name <span class="keyword">node</span><span class="number">0</span>.sundayle.com;</span><br><span class="line"></span><br><span class="line">  location / &#123;</span><br><span class="line">    proxy_pass http://tomcatcs;</span><br><span class="line">    proxy_set_header Host <span class="variable">$proxy_host</span>;</span><br><span class="line">    proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">    proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong> Tomcat server.xml </strong><br>修改tomcat的server.xml文件，增加Cluster配置，如果定义在Engine容器中，则表示对所有主机均启动用集群功能。如果定义在某Host容器中，则表示仅对此主机启用集群功能。此外，需要注意的是，Receiver中的address=”auto”一项的值最好改为当前部署tomcat主机所对应的网络接口的IP地址。<br><a href="http://tomcat.apache.org/tomcat-8.5-doc/cluster-howto.html" target="_blank" rel="noopener">http://tomcat.apache.org/tomcat-8.5-doc/cluster-howto.html</a><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Cluster</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.ha.tcp.SimpleTcpCluster"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">channelSendOptions</span>=<span class="string">"6"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">         <span class="tag">&lt;<span class="name">Manager</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.ha.session.BackupManager"</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">expireSessionsOnShutdown</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">notifyListenersOnReplication</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">mapSendOptions</span>=<span class="string">"6"</span>/&gt;</span></span><br><span class="line">         <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">         &lt;Manager className="org.apache.catalina.ha.session.DeltaManager"</span></span><br><span class="line"><span class="comment">                  expireSessionsOnShutdown="false"</span></span><br><span class="line"><span class="comment">                  notifyListenersOnReplication="true"/&gt;</span></span><br><span class="line"><span class="comment">         --&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">Channel</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.tribes.group.GroupChannel"</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">Membership</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.tribes.membership.McastService"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">address</span>=<span class="string">"228.0.0.4"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">port</span>=<span class="string">"45564"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">frequency</span>=<span class="string">"500"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">dropTime</span>=<span class="string">"3000"</span>/&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">Receiver</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.tribes.transport.nio.NioReceiver"</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">address</span>=<span class="string">"192.168.10.101"</span> #修改本机<span class="attr">ip</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">port</span>=<span class="string">"5000"</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">selectorTimeout</span>=<span class="string">"100"</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">maxThreads</span>=<span class="string">"6"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">           <span class="tag">&lt;<span class="name">Sender</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.tribes.transport.ReplicationTransmitter"</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="name">Transport</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.tribes.transport.nio.PooledParallelSender"</span>/&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">Sender</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">Interceptor</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.tribes.group.interceptors.TcpFailureDetector"</span>/&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">Interceptor</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.tribes.group.interceptors.MessageDispatchInterceptor"</span>/&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">Interceptor</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.tribes.group.interceptors.ThroughputInterceptor"</span>/&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">Channel</span>&gt;</span></span><br><span class="line"></span><br><span class="line">         <span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.ha.tcp.ReplicationValve"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">filter</span>=<span class="string">".*\.gif|.*\.js|.*\.jpeg|.*\.jpg|.*\.png|.*\.htm|.*\.html|.*\.css|.*\.txt"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">         <span class="tag">&lt;<span class="name">Deployer</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.ha.deploy.FarmWarDeployer"</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">tempDir</span>=<span class="string">"/tmp/war-temp/"</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">deployDir</span>=<span class="string">"/tmp/war-deploy/"</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">watchDir</span>=<span class="string">"/tmp/war-listen/"</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">watchEnabled</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">         <span class="tag">&lt;<span class="name">ClusterListener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.ha.session.ClusterSessionListener"</span>/&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">Cluster</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>java项目web.xml需要配置加入<br><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">&lt;distributable/&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>这里可以复制tomcat web.xml来测试</p>
<blockquote>
<p>cp /usr/local/tomcat/conf/web.xml /data/tomcat/ROOT/WEB-INF/web.xml<br>cat /data/tomcat/ROOT/WEB-INF/web.xml  #tomcat node2同样操作<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">distributable</span>/&gt;</span>     #在<span class="tag">&lt;<span class="name">servlet</span>&gt;</span>前添加<span class="tag">&lt;<span class="name">distributable</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>jsp<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.apache.jasper.servlet.JspServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<img src="http://himg.sundayle.com/static/images/tomcat-session-repl.gif">
<h2 id="Tomcat-Memcached-会话保持"><a href="#Tomcat-Memcached-会话保持" class="headerlink" title="Tomcat + Memcached 会话保持"></a>Tomcat + Memcached 会话保持</h2><p>tomcat+memcached实现分布式session共享，使用的是开源的memcached-session-manager，一个开源的高可用session解决方案。<br><a href="https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration" target="_blank" rel="noopener">https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration</a><br><strong> java默认序列化sticky sessions配置 </strong></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install -y memcached</span><br><span class="line">vim <span class="regexp">/etc/</span>sysconfig<span class="regexp">/memcached</span></span><br></pre></td></tr></table></figure>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PORT=<span class="string">"11211"</span>                <span class="comment"># 监听端口</span></span><br><span class="line">USER=<span class="string">"memcached"</span>            <span class="comment"># 运行时的用户</span></span><br><span class="line">MAXCONN=<span class="string">"2048"</span>              <span class="comment"># 最大连接数，默认为1024</span></span><br><span class="line">CACHESIZE=<span class="string">"1024"</span>            <span class="comment"># 缓存内存大小，默认为64M</span></span><br><span class="line">OPTIONS=<span class="string">""</span></span><br></pre></td></tr></table></figure>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="literal">start</span> memcached</span><br></pre></td></tr></table></figure>
<p><strong> 下载jar到/usr/local/tomcat/lib目录 </strong><br><a href="http://repo1.maven.org/maven2/de/javakaffee/msm/memcached-session-manager/2.3.0/" target="_blank" rel="noopener">memcached-session-manager</a><br><a href="http://repo1.maven.org/maven2/de/javakaffee/msm/memcached-session-manager-tc8/2.3.0/" target="_blank" rel="noopener">memcached-session-manager-tc8</a><br><a href="http://repo1.maven.org/maven2/net/spy/spymemcached/2.12.3/" target="_blank" rel="noopener">spymemcached</a></p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/tomcat/<span class="class"><span class="keyword">lib</span></span></span><br><span class="line">wget <span class="symbol">http:</span>/<span class="regexp">/repo1.maven.org/maven</span>2/de/javakaffee/msm/memcached-session-manager/<span class="number">2.3</span>.<span class="number">0</span>/memcached-session-manager-<span class="number">2.3</span>.<span class="number">0</span>.jar</span><br><span class="line">wget <span class="symbol">http:</span>/<span class="regexp">/repo1.maven.org/maven</span>2/de/javakaffee/msm/memcached-session-manager-tc8/<span class="number">2.3</span>.<span class="number">0</span>/memcached-session-manager-tc8-<span class="number">2.3</span>.<span class="number">0</span>.jar</span><br><span class="line">wget <span class="symbol">http:</span>/<span class="regexp">/repo1.maven.org/maven</span>2/net/spy/spymemcached/<span class="number">2.12</span>.<span class="number">3</span>/spymemcached-<span class="number">2.12</span>.<span class="number">3</span>.jar</span><br></pre></td></tr></table></figure>
<p><strong>在<code>&lt;Context&gt; &lt;/Context&gt;</code>中添加 </strong></p>
<blockquote>
<p>vim /usr/local/tomcat/conf/context.xml<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;Manager <span class="attribute">className</span>=<span class="string">"de.javakaffee.web.msm.MemcachedBackupSessionManager"</span></span><br><span class="line">   <span class="attribute">memcachedNodes</span>=<span class="string">"n1:192.168.10.101:11211,n2:192.168.10.102:11211"</span></span><br><span class="line">   <span class="attribute">failoverNodes</span>=<span class="string">"n1"</span></span><br><span class="line">   <span class="attribute">requestUriIgnorePattern</span>=<span class="string">".*\.(ico|png|gif|jpg|css|js)$"</span></span><br><span class="line">   <span class="attribute">transcoderFactoryClass</span>=<span class="string">"de.javakaffee.web.msm.JavaSerializationTranscoderFactory"</span></span><br><span class="line">   /&gt;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>scp /usr/local/tomcat/conf/context.xml <a href="mailto:root@192.168.10.102" target="_blank" rel="noopener">root@192.168.10.102</a>:/usr/local/tomcat/conf/</p>
</blockquote>
<p>Sticky session 粘性会话：参数failoverNodes=”n1” 是用来告诉 MSM 把session优先存储在 memcached2上，只有当memcached2挂了的时候才会把session存在memcache1,也就是配置文件的n1里。<br>假如tomcat1挂了，session还是可用，因为session是存在tomcat2的memcache2上，可以通过tomcat2对外提供服务。<br>tomcat2上的tomcat2的配置文件只要改成failoverNodes=”n2”即可。</p>
<h2 id="Tomcat-memcached-Redis-会话保持"><a href="#Tomcat-memcached-Redis-会话保持" class="headerlink" title="Tomcat + memcached + Redis 会话保持"></a>Tomcat + memcached + Redis 会话保持</h2><p>java默认序列化non-sticky sessions配置<br>非粘性session是不需要配置failoverNodes，因为会话由所有tomcats循环服务<br><a href="https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration#example-for-non-sticky-sessions--kryo" target="_blank" rel="noopener">https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration#example-for-non-sticky-sessions--kryo</a><br><strong> 下载jar到/usr/local/tomcat/lib目录 </strong></p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/tomcat/<span class="class"><span class="keyword">lib</span></span></span><br><span class="line">wget <span class="symbol">http:</span>/<span class="regexp">/repo1.maven.org/maven</span>2/de/javakaffee/msm/memcached-session-manager/<span class="number">2.3</span>.<span class="number">0</span>/memcached-session-manager-<span class="number">2.3</span>.<span class="number">0</span>.jar</span><br><span class="line">wget <span class="symbol">http:</span>/<span class="regexp">/repo1.maven.org/maven</span>2/de/javakaffee/msm/memcached-session-manager-tc8/<span class="number">2.3</span>.<span class="number">0</span>/memcached-session-manager-tc8-<span class="number">2.3</span>.<span class="number">0</span>.jar</span><br><span class="line">wget <span class="symbol">http:</span>/<span class="regexp">/repo1.maven.org/maven</span>2/net/spy/spymemcached/<span class="number">2.12</span>.<span class="number">3</span>/spymemcached-<span class="number">2.12</span>.<span class="number">3</span>.jar</span><br><span class="line">wget <span class="symbol">http:</span>/<span class="regexp">/central.maven.org/maven</span>2/redis/clients/jedis/<span class="number">2.9</span>.<span class="number">0</span>/jedis-<span class="number">2.9</span>.<span class="number">0</span>.jar</span><br></pre></td></tr></table></figure>
<p><strong>在<code>&lt;Context&gt; &lt;/Context&gt;</code>中添加 </strong><br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;Manager <span class="attribute">className</span>=<span class="string">"de.javakaffee.web.msm.MemcachedBackupSessionManager"</span></span><br><span class="line">  <span class="attribute">memcachedNodes</span>=<span class="string">"redis://192.168.10.101:6379"</span></span><br><span class="line">  <span class="attribute">sticky</span>=<span class="string">"false"</span></span><br><span class="line">  <span class="attribute">sessionBackupAsync</span>=<span class="string">"false"</span></span><br><span class="line">  <span class="attribute">lockingMode</span>=<span class="string">"uriPattern:/path1|/path2"</span></span><br><span class="line">  <span class="attribute">requestUriIgnorePattern</span>=<span class="string">".*\.(ico|png|gif|jpg|css|js)$"</span></span><br><span class="line">  <span class="attribute">transcoderFactoryClass</span>=<span class="string">"de.javakaffee.web.msm.JavaSerializationTranscoderFactory"</span></span><br><span class="line">  /&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="Tomcat-Redis-会话保持"><a href="#Tomcat-Redis-会话保持" class="headerlink" title="Tomcat + Redis 会话保持"></a>Tomcat + Redis 会话保持</h2><p><a href="https://www.jianshu.com/p/aa9f71d653af" target="_blank" rel="noopener">https://www.jianshu.com/p/aa9f71d653af</a></p>
<h1 id="Tomcat获取用户IP地址"><a href="#Tomcat获取用户IP地址" class="headerlink" title="Tomcat获取用户IP地址"></a>Tomcat获取用户IP地址</h1><p>在Tomcat配置文件/conf/server.xml下配置<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;Valve className=<span class="string">"org.apache.catalina.valves.AccessLogValve"</span> directory=<span class="string">"logs"</span></span><br><span class="line">    prefix=<span class="string">"localhost_access_log"</span> suffix=<span class="string">".txt"</span></span><br><span class="line">    pattern=<span class="string">"%h %l %u %t %r %s %b"</span> /&gt;</span><br><span class="line">前面有负载均衡的时候，获取真实IP可以使用下面的配置     </span><br><span class="line">&lt;Valve className=<span class="string">"org.apache.catalina.valves.AccessLogValve"</span> directory=<span class="string">"logs"</span></span><br><span class="line">    prefix=<span class="string">"localhost_access_log."</span> suffix=<span class="string">".txt"</span></span><br><span class="line">    pattern=<span class="string">"%&#123;X-Forwarded-For&#125;i %h %l %u %t %r %s %b"</span> /&gt;</span><br></pre></td></tr></table></figure></p>
<p><a href="http://maxiecloud.com/2017/07/01/tomcat/" target="_blank" rel="noopener">http://maxiecloud.com/2017/07/01/tomcat/</a><br><a href="http://maxiecloud.com/2017/07/03/tomcat-session-remains/" target="_blank" rel="noopener">http://maxiecloud.com/2017/07/03/tomcat-session-remains/</a><br><a href="http://tomcat.apache.org/tomcat-8.5-doc/index.html" target="_blank" rel="noopener">http://tomcat.apache.org/tomcat-8.5-doc/index.html</a></p>


                <hr>

                

                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/tomcat-optimization/" data-toggle="tooltip" data-placement="top" title="Apache Tomcat 8.5 安全配置与高并发优化">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/lsyncd/" data-toggle="tooltip" data-placement="top" title="Lsyncd实时同步搭建指南--取代rsync+inotify">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                

                

            </div>
    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->

            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#tomcat" title="tomcat">tomcat</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="https://jaminzhang.github.io" target="_blank">JAMIN ZHANG</a></li>
                    
                        <li><a href="#" target="_blank">It helps SEO</a></li>
                    
                </ul>
                
            </div>

        </div>
    </div>
</article>







<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                

                

                

                
                    <li>
                        <a target="_blank"  href="https://github.com/sundayle">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Sunday 2019 
                    <br>
                    Theme by <a href="http://huangxuan.me">Hux</a> 
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span>
                    Ported by <a href="https://github.com/Kaijun/hexo-theme-huxblog">Kaijun</a>
            <!-- 
                    Ported by <a href="http://blog.kaijun.rocks">Kaijun</a> | 
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=kaijun&repo=hexo-theme-huxblog&type=star&count=true" >
                    </iframe>
            -->
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
     async("https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->


<script>
    // dynamic User by Hux
    var _gaId = 'UA-70699634-1';
    var _gaDomain = 'auto';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>




<!-- Baidu Tongji -->


<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog (selector) {
        var P = $('div.post-container'),a,n,t,l,i,c;
        a = P.find('h1,h2,h3,h4,h5,h6');
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#"+$(this).prop('id');
            t = $(this).text();
            c = $('<a href="'+i+'" rel="nofollow">'+t+'</a>');
            l = $('<li class="'+n+'_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;    
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function(e){
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>





<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
