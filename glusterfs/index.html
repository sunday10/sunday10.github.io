<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Linux运维笔记">
    <meta name="keyword"  content="sunday,sundayhk,sundayle,sunday博客,Linxu,运维">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
          企业级分布式存储 Glusterfs - Sunday博客 | Sunday Blog
        
    </title>

    <link rel="canonical" href="http://www.sundayle.com/glusterfs/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">SundayLE</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/archives/">Archives</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    
<!-- Image to hack wechat -->
<!-- <img src="http://www.sundayle.com/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="{{ site.baseurl }}/{% if page.header-img %}{{ page.header-img }}{% else %}{{ site.header-img }}{% endif %}" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        background-image: url('/img/home-bg.jpg')
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                          <a class="tag" href="/tags/#分布式" title="分布式">分布式</a>
                        
                          <a class="tag" href="/tags/#glusterfs" title="glusterfs">glusterfs</a>
                        
                    </div>
                    <h1>企业级分布式存储 Glusterfs</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        Posted by Sunday on
                        2018-08-23
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <h1 id="1-理论基础"><a href="#1-理论基础" class="headerlink" title="1. 理论基础"></a>1. 理论基础</h1><h2 id="1-1-分布式文件系统出现"><a href="#1-1-分布式文件系统出现" class="headerlink" title="1.1 分布式文件系统出现"></a>1.1 分布式文件系统出现</h2><p>计算机通过文件系统管理、存储数据，而现在数据信息爆炸的时代中人们可以获取的数据成指数倍的增长，单纯通过增加硬盘个数来扩展计算机文件系统的存储容量的方式，已经不能满足目前的需求。</p>
<p>分布式文件系统可以有效解决数据的存储和管理难题，将固定于某个地点的某个文件系统，扩展到任意多个地点、多个文件系统，众多的节点组成一个文件系统网络。每个节点可以分布在不同的地点，通过网络进行节点间的通信和数据传输。人们在使用分布式文件系统时，无需关心数据是存储在哪个节点上、或者是从哪个节点获取的，只需要像使用本地文件系统一样管理和存储文件系统中的数据。</p>
<h2 id="1-2-典型代表-NFS"><a href="#1-2-典型代表-NFS" class="headerlink" title="1.2 典型代表 NFS"></a>1.2 典型代表 NFS</h2><p>NFS(Network File System) 即网络文件系统，它允许从网络中的计算机之间通过 TCP/IP 网络共享资源。在 NFS 的应用中，本地 NFS 的客户端应用可以透明地读写位于远端 NFS 服务器上的文件，就像访问本地文件一样。NFS 的优点如下：</p>
<p><strong>节约使用磁盘空间</strong><br>客户端经常使用的数据可以集中存放在一台机器上，并使用 NFS 发布，那么网络内的所有计算机可以通过网络访问，不必单独存储。</p>
<p><strong>节约硬件资源</strong><br>NFS 还可以共享软驱，CD-ROM 等存储设备，减少整个网络上的可移动设备数量。</p>
<p><strong>用户主目录设定</strong><br>对于特殊用户，如管理员等，为了管理的需要，可能会经常登录到网络中所有的计算机，若每个客户端，均保存这个用户的主目录很繁琐，而且不能保证数据的一致性。实际上，经过 NFS 服务的设定，然后在客户端指定这个用户的主目录位置，并自动挂载，就可以在任何计算机上使用用户主目录的文件。</p>
<h2 id="1-3-NFS-面临的问题"><a href="#1-3-NFS-面临的问题" class="headerlink" title="1.3 NFS 面临的问题"></a>1.3 NFS 面临的问题</h2><ul>
<li>存储空间不足，需要更大容量的存储</li>
<li>直接用 NFS 挂载存储，有一定的风险，存在单点故障</li>
<li>某些场景不能满足要求，大量的访问下磁盘 IO 是瓶颈</li>
</ul>
<h2 id="1-4-GlusterFS-概述"><a href="#1-4-GlusterFS-概述" class="headerlink" title="1.4 GlusterFS 概述"></a>1.4 GlusterFS 概述</h2><p>A STORAGE PLATFORM FOR PHYSICAL, VIRTUAL, AND CLOUD ENVIRONMENTS</p>
<p>Red Hat® Gluster Storage is an open, software-defined scale-out storage platform.<br>Use it to easily manage unstructured data for physical, virtual, and cloud environments.<br>Red Hat Gluster Storage combines both file and object storage with a scale-out architecture, designed to cost-effectively store and<br>manage petabyte-scale data growth. It delivers a continuous storage fabric across physical, virtual, and cloud resources,<br>which lets you transform your big, semi-structured, and unstructured data from a burden to an asset.</p>
<p>GlusterFS 是 Scale-Out 存储解决方案 Gluster 的核心，它是一个开源的分布式文件系统，具有强大的横向扩展能力，通过扩展能够支持数 PB 存储容量和处理数千客户端。 GlusterFS 借助 TCP/IP 或 InfiniBand RDMA 网络将物理分布的存储资源聚集在一起，使用单一全局命名空间来管理数据。GlusterFS 基于可堆叠的用户空间设计，可为各种不同的数据负载提供优异的性能。</p>
<p>GlusterFS 支持运行在任何 IP 网络上的标准应用程序的标准客户端，用户可以在全局统一的命名空间中使用 NFS/CIFS 等标准协议来访问应用数据。GlusterFS 使得用户可摆脱原有的独立、高成本的封闭存储系统，能够利用普通廉价的存储设备来部署可集中管理、横向扩展、虚拟化的存储池，存储容量可扩展至 TB/PB 级。</p>
<p>目前 GlusterFS 已被 Red Hat 收购，它的官网是：<a href="http://www.gluster.org/" target="_blank" rel="noopener">http://www.gluster.org/</a></p>
<h2 id="1-5-企业中的应用场景"><a href="#1-5-企业中的应用场景" class="headerlink" title="1.5 企业中的应用场景"></a>1.5 企业中的应用场景</h2><p>理论和实践上分析，GlusterFS 目前主要适用于大文件存储场景，对于小文件尤其是海量小文件，存储效率和访问性能都表现不佳。海量小文件 LOSF 问题是工业界和学术界公认的难题，GlusterFS 作为通用的分布式文件系统，并没有对小文件作额外的优化措施，性能不好也是可以理解的。</p>
<p>STORE VARIOUS KINDS OF UNSTRUCTURED DATA:</p>
<p>* Rich media content like videos, images and audio files<br>* Backup-images and Nearline archives<br>* Big data — Log files, RFID data, and other machine-generated data<br>* Virtual machine images</p>
<ul>
<li>Media - 文档、图片、音频、视频</li>
<li>Shared storage - 云存储、虚拟化存储、HPC(高性能计算)</li>
<li>Big data - 日志文件、RFID(射频识别)数据</li>
</ul>
<p>文件大小大于 1MB 适合 GlusterFS，如果更小可以选用其他文件系统，如 FastFS 等，或者配置 CDN。</p>
<h1 id="2-部署安装"><a href="#2-部署安装" class="headerlink" title="2. 部署安装"></a>2. 部署安装</h1><h2 id="2-1-GlusterFS-安装前的准备"><a href="#2-1-GlusterFS-安装前的准备" class="headerlink" title="2.1 GlusterFS 安装前的准备"></a>2.1 GlusterFS 安装前的准备</h2><p>服务器规划(采用 VMware Workstation 虚拟机环境)</p>
<table>
<thead>
<tr>
<th>操作系统</th>
<th>IP</th>
<th>主机名</th>
<th>数据盘(2 块)</th>
</tr>
</thead>
<tbody>
<tr>
<td>CentOS 6.8 x86_64</td>
<td>192.168.56.11</td>
<td>mystorage1</td>
<td>sdb:10G sdc:10G</td>
</tr>
<tr>
<td>CentOS 6.8 x86_64</td>
<td>192.168.56.12</td>
<td>mystorage2</td>
<td>sdb:10G sdc:10G</td>
</tr>
<tr>
<td>CentOS 6.8 x86_64</td>
<td>192.168.56.13</td>
<td>mystorage3</td>
<td>sdb:10G sdc:10G</td>
</tr>
<tr>
<td>CentOS 6.8 x86_64</td>
<td>192.168.56.14</td>
<td>mystorage4</td>
<td>sdb:10G sdc:10G</td>
</tr>
</tbody>
</table>
<h2 id="2-2-GlusterFS-安装"><a href="#2-2-GlusterFS-安装" class="headerlink" title="2.2 GlusterFS 安装"></a>2.2 GlusterFS 安装</h2><p><strong>2.2.1 修改主机名</strong><br>修改：/etc/sysconfig/network<br>分别在各台服务器上执行 hostname 临时生效，不用重启</p>
<p><strong>2.2.2 添加 hosts 文件实现集群主机之间相互能够解析</strong><br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo '<span class="number">192.168</span><span class="number">.56</span><span class="number">.11</span>   mystorage1 </span><br><span class="line"><span class="number">192.168</span><span class="number">.56</span><span class="number">.12</span>   mystorage2</span><br><span class="line"><span class="number">192.168</span><span class="number">.56</span><span class="number">.13</span>   mystorage3</span><br><span class="line"><span class="number">192.168</span><span class="number">.56</span><span class="number">.14</span>   mystorage4' &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure></p>
<p><strong>2.2.3 关闭 SELinux 和 防火墙</strong><br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sed -i 's<span class="comment">#SELINUX=enforcing#SELINUX=disabled#' /etc/selinux/config</span></span><br><span class="line"><span class="string">/etc/init.d/iptables</span> stop</span><br><span class="line"><span class="comment"># 检查</span></span><br><span class="line">getenforce</span><br><span class="line"><span class="string">/etc/init.d/iptables</span> status</span><br></pre></td></tr></table></figure></p>
<p><strong>2.2.4 安装 EPEL 源</strong><br>GlusterFS yum 源有部分包依赖 epel 源<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> epel-<span class="keyword">release</span> -y</span><br></pre></td></tr></table></figure></p>
<p><strong> 2.2.5 安装 GlusterFS 源及相关软件包</strong><br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">yum install centos-release-gluster37.noarch -y</span><br><span class="line">yum --enablerepo=centos-gluster*-test install glusterfs-server glusterfs-cli glusterfs-geo-replication -y</span><br><span class="line"></span><br><span class="line"># 安装完成后的包</span><br><span class="line">rpm -qa | grep gluster*</span><br><span class="line">centos-release-gluster37<span class="number">-1.0</span><span class="number">-4.</span>el6.centos.noarch</span><br><span class="line">glusterfs-api<span class="number">-3.7</span><span class="number">.13</span><span class="number">-1.</span>el6.x86_64</span><br><span class="line">glusterfs<span class="number">-3.7</span><span class="number">.13</span><span class="number">-1.</span>el6.x86_64</span><br><span class="line">glusterfs-client-xlators<span class="number">-3.7</span><span class="number">.13</span><span class="number">-1.</span>el6.x86_64</span><br><span class="line">glusterfs-fuse<span class="number">-3.7</span><span class="number">.13</span><span class="number">-1.</span>el6.x86_64</span><br><span class="line">glusterfs-server<span class="number">-3.7</span><span class="number">.13</span><span class="number">-1.</span>el6.x86_64</span><br><span class="line">glusterfs-libs<span class="number">-3.7</span><span class="number">.13</span><span class="number">-1.</span>el6.x86_64</span><br><span class="line">glusterfs-cli<span class="number">-3.7</span><span class="number">.13</span><span class="number">-1.</span>el6.x86_64</span><br><span class="line">glusterfs-geo-replication<span class="number">-3.7</span><span class="number">.13</span><span class="number">-1.</span>el6.x86_64</span><br></pre></td></tr></table></figure></p>
<h2 id="2-3-配置-GlusterFS"><a href="#2-3-配置-GlusterFS" class="headerlink" title="2.3 配置 GlusterFS"></a>2.3 配置 GlusterFS</h2><h2 id="2-3-1-查看-GlusterFS-版本信息"><a href="#2-3-1-查看-GlusterFS-版本信息" class="headerlink" title="2.3.1 查看 GlusterFS 版本信息"></a>2.3.1 查看 GlusterFS 版本信息</h2><p>使用 glusterfs -V 命令<br><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@mystorage1 ~]# glusterfs -V</span><br><span class="line">glusterfs <span class="number">3.7</span>.<span class="number">13</span> built <span class="keyword">on</span> Jul  <span class="number">8</span> <span class="number">2016</span> <span class="number">15</span>:<span class="number">25</span>:<span class="number">47</span></span><br><span class="line">Repository revision: git:<span class="comment">//git.gluster.com/glusterfs.git</span></span><br><span class="line">Copyright (c) <span class="number">2006</span>-<span class="number">2013</span> Red Hat, Inc. &lt;http:<span class="comment">//www.redhat.com/&gt;</span></span><br><span class="line">GlusterFS comes <span class="keyword">with</span> ABSOLUTELY NO WARRANTY.</span><br><span class="line">It <span class="keyword">is</span> licensed <span class="keyword">to</span> you under your choice <span class="keyword">of</span> the GNU Lesser</span><br><span class="line">General <span class="keyword">Public</span> License, version <span class="number">3</span> <span class="keyword">or</span> any later version (LGPLv3</span><br><span class="line"><span class="keyword">or</span> later), <span class="keyword">or</span> the GNU General <span class="keyword">Public</span> License, version <span class="number">2</span> (GPLv2),</span><br><span class="line"><span class="keyword">in</span> all cases <span class="keyword">as</span> <span class="keyword">published</span> <span class="keyword">by</span> the Free Software Foundation.</span><br></pre></td></tr></table></figure></p>
<h2 id="2-3-2-启动、停止服务"><a href="#2-3-2-启动、停止服务" class="headerlink" title="2.3.2 启动、停止服务"></a>2.3.2 启动、停止服务</h2><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/glusterd <span class="built_in">start</span></span><br><span class="line">/etc/init.d/glusterd status</span><br><span class="line">chkconfig glusterd <span class="keyword">on</span></span><br></pre></td></tr></table></figure>
<p>在 4 台服务器上都执行</p>
<h2 id="2-3-3-存储主机加入信任主机池"><a href="#2-3-3-存储主机加入信任主机池" class="headerlink" title="2.3.3 存储主机加入信任主机池"></a>2.3.3 存储主机加入信任主机池</h2><p>在一台主机上执行，将其他主机加入，如下是在 mystorage1 上执行<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@mystorage1 ~]# gluster<span class="built_in"> peer </span>probe mystorage2</span><br><span class="line">peer probe: success. </span><br><span class="line">[root@mystorage1 ~]# gluster<span class="built_in"> peer </span>probe mystorage3</span><br><span class="line">peer probe: success. </span><br><span class="line">[root@mystorage1 ~]# gluster<span class="built_in"> peer </span>probe mystorage4</span><br><span class="line">peer probe: success.</span><br></pre></td></tr></table></figure></p>
<h2 id="2-3-4-查看状态"><a href="#2-3-4-查看状态" class="headerlink" title="2.3.4 查看状态"></a>2.3.4 查看状态</h2><p>在另外的机器查看状态：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@mystorage2 ~]# gluster<span class="built_in"> peer </span>status</span><br><span class="line">Number of Peers: 3</span><br><span class="line"></span><br><span class="line">Hostname: mystorage1</span><br><span class="line">Uuid: 6e6a84af-ac7a-44eb-85c9-50f1f46acef1</span><br><span class="line">State:<span class="built_in"> Peer </span><span class="keyword">in</span> Cluster (Connected)</span><br><span class="line"></span><br><span class="line">Hostname: mystorage3</span><br><span class="line">Uuid: 36e4c45c-466f-47b0-b829-dcd4a69ca2e7</span><br><span class="line">State:<span class="built_in"> Peer </span><span class="keyword">in</span> Cluster (Connected)</span><br><span class="line"></span><br><span class="line">Hostname: mystorage4</span><br><span class="line">Uuid: c607f6c2-bdcb-4768-bc82-4bc2243b1b7a</span><br><span class="line">State:<span class="built_in"> Peer </span><span class="keyword">in</span> Cluster (Connected)</span><br></pre></td></tr></table></figure></p>
<h2 id="2-3-5-配置前的准备工作"><a href="#2-3-5-配置前的准备工作" class="headerlink" title="2.3.5 配置前的准备工作"></a>2.3.5 配置前的准备工作</h2><p>安装 xfs 支持包<br><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> xfsprogs -y</span><br></pre></td></tr></table></figure></p>
<p>fdisk -l 查看磁盘设备，确认新加的数据盘在线<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">如果磁盘大于 <span class="number">4</span>T 的话就用 parted 来分区，这里我们不会用分区（可以不分区）</span><br><span class="line">做分布式文件系统的时候数据盘一般不需要做 RAID，一般系统盘会做 RAID <span class="number">1</span></span><br><span class="line">如果磁盘有 RAID 卡(cache)，最好用上(RAID <span class="number">5</span>)</span><br><span class="line">也可以在单机做了 RAID <span class="number">5</span> 的基础上，再用 glusterfs 做成一个大的文件系统</span><br></pre></td></tr></table></figure></p>
<p>格式化创建文件系统<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkfs<span class="selector-class">.xfs</span> -f /dev/sdb</span><br></pre></td></tr></table></figure></p>
<p>在四台机器上创建挂载块设备的目录，挂载硬盘到目录：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p <span class="regexp">/storage/</span>brick1 <span class="regexp">/storage/</span>brick2</span><br><span class="line">mount <span class="regexp">/dev/</span>sdb <span class="regexp">/storage/</span>brick1</span><br><span class="line">df -h</span><br></pre></td></tr></table></figure></p>
<p>加入到 /etc/fstab<br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> “<span class="string">/dev/sdb</span> <span class="string">/storage/brick1</span> xfs defaults 0 0”  » <span class="string">/etc/fstab</span></span><br><span class="line">mount -a</span><br></pre></td></tr></table></figure></p>
<h2 id="2-3-6-创建-volume-及其他操作"><a href="#2-3-6-创建-volume-及其他操作" class="headerlink" title="2.3.6 创建 volume 及其他操作"></a>2.3.6 创建 volume 及其他操作</h2><p>GlusterFS 五种卷</p>
<ul>
<li>Distributed：分布式卷，文件通过 hash 算法随机分布到由 bricks 组成的卷上。</li>
<li>Replicated: 复制式卷，类似 RAID 1，replica 数必须等于 volume 中 brick 所包含的存储服务器数，可用性高。</li>
<li>Striped: 条带式卷，类似 RAID 0，stripe 数必须等于 volume 中 brick 所包含的存储服务器数，文件被分成数据块，以 Round Robin 的方式存储在 bricks 中，并发粒度是数据块，大文件性能好。</li>
<li>Distributed Striped: 分布式的条带卷，volume中 brick 所包含的存储服务器数必须是 stripe 的倍数（&gt;=2倍），兼顾分布式和条带式的功能。</li>
<li>Distributed Replicated: 分布式的复制卷，volume 中 brick 所包含的存储服务器数必须是 replica 的倍数（&gt;=2倍），兼顾分布式和复制式的功能。</li>
<li>glustfs 最常用的卷就是分布式复制卷。</li>
<li>striped 的目的就提高性能，读取更快。</li>
</ul>
<p>企业一般用后两种，大部分会用分布式复制（可用容量为 总容量/复制份数），通过网络传输的话最好用万兆交换机，万兆网卡来做。这样就会优化一部分性能。它们的数据都是通过网络来传输的。</p>
<p><strong>分布式卷</strong><br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建分布式卷</span></span><br><span class="line">[root@mystorage1 ~]<span class="comment"># gluster volume create gv1 mystorage1:/storage/brick1 mystorage2:/storage/brick1 force</span></span><br><span class="line">volume create: gv1: success: please start the volume to access data</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动创建的卷</span></span><br><span class="line">[root@mystorage1 ~]<span class="comment"># gluster volume start gv1</span></span><br><span class="line">volume start: gv1: success</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在另一台机器（mystorage4）查看卷信息</span></span><br><span class="line">[root@mystorage4 ~]<span class="comment"># gluster volume info</span></span><br><span class="line"> </span><br><span class="line">Volume Name: gv1</span><br><span class="line">Type: Distribute</span><br><span class="line">Volume ID: b6ec2f8a-d1f0-4d1b-806b-238efb6dcb84</span><br><span class="line">Status: Started</span><br><span class="line">Number of Bricks: 2</span><br><span class="line">Transport-type: tcp</span><br><span class="line">Bricks:</span><br><span class="line">Brick1: mystorage1:/storage/brick1</span><br><span class="line">Brick2: mystorage2:/storage/brick1</span><br><span class="line">Options Reconfigured:</span><br><span class="line">performance.readdir-ahead: on</span><br><span class="line"></span><br><span class="line"><span class="comment"># 挂载卷到目录</span></span><br><span class="line">[root@mystorage4 ~]<span class="comment"># mount -t glusterfs 127.0.0.1:/gv1 /mnt</span></span><br><span class="line">[root@mystorage4 ~]<span class="comment"># df -h</span></span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/sda3        33G  1.3G   30G   5% /</span><br><span class="line">tmpfs           242M    <span class="number"> 0 </span> 242M   0% /dev/shm</span><br><span class="line">/dev/sda1       976M   38M  888M   5% /boot</span><br><span class="line">/dev/sdb         10G   33M   10G   1% /storage/brick1</span><br><span class="line">127.0.0.1:/gv1   20G   65M   20G   1% /mnt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 mystorage1 创建测试文件</span></span><br><span class="line">[root@mystorage1 ~]<span class="comment"># touch /mnt/&#123;a..d&#125;</span></span><br><span class="line">[root@mystorage1 ~]<span class="comment"># ll /mnt</span></span><br><span class="line">total 0</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root root<span class="number"> 0 </span>Jul<span class="number"> 30 </span>00:54 a</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root root<span class="number"> 0 </span>Jul<span class="number"> 30 </span>00:54 b</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root root<span class="number"> 0 </span>Jul<span class="number"> 30 </span>00:54 c</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root root<span class="number"> 0 </span>Jul<span class="number"> 30 </span>00:54 d</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 mystorage4 也可看到新创建的文件，信任存储池中的每一台主机挂载这个卷后都可以看到</span></span><br><span class="line">[root@mystorage4 ~]<span class="comment"># ll /mnt/</span></span><br><span class="line">total 0</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root root<span class="number"> 0 </span>Jul<span class="number"> 30 </span>00:54 a</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root root<span class="number"> 0 </span>Jul<span class="number"> 30 </span>00:54 b</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root root<span class="number"> 0 </span>Jul<span class="number"> 30 </span>00:54 c</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root root<span class="number"> 0 </span>Jul<span class="number"> 30 </span>00:54 d</span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件实际存在位置</span></span><br><span class="line">[root@mystorage1 ~]<span class="comment"># ls /storage/brick1</span></span><br><span class="line">a  b  c  e</span><br><span class="line">[root@mystorage2 ~]<span class="comment"># ls /storage/brick1</span></span><br><span class="line">d</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上面可以看到文件根据 hash 算法随机分布到由不同的 brick 上</span></span><br></pre></td></tr></table></figure></p>
<p>使用 NFS 方式挂载<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@mystorage3 ~]<span class="comment"># mount -o mountproto=tcp -t nfs mystorage1:/gv1 /mnt/  # host可以写主机名</span></span><br><span class="line">[root@mystorage3 ~]<span class="comment"># ll /mnt</span></span><br><span class="line">total 0</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root root<span class="number"> 0 </span>Jul<span class="number"> 30 </span>00:54 a</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root root<span class="number"> 0 </span>Jul<span class="number"> 30 </span>00:54 b</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root root<span class="number"> 0 </span>Jul<span class="number"> 30 </span>00:54 c</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root root<span class="number"> 0 </span>Jul<span class="number"> 30 </span>00:54 d</span><br><span class="line"></span><br><span class="line">[root@mystorage2 ~]<span class="comment"># mount -o mountproto=tcp -t nfs 192.168.56.13:/gv1 /mnt/    </span></span><br><span class="line"><span class="comment"># host 可以写 IP，可以看到这个 mystorage3 的 IP，说明 gv1 是共享给信任存储池的所有主机的</span></span><br><span class="line">[root@mystorage2 ~]<span class="comment"># ll /mnt/</span></span><br><span class="line">total 0</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root root<span class="number"> 0 </span>Jul<span class="number"> 30 </span>00:54 a</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root root<span class="number"> 0 </span>Jul<span class="number"> 30 </span>00:54 b</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root root<span class="number"> 0 </span>Jul<span class="number"> 30 </span>00:54 c</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root root<span class="number"> 0 </span>Jul<span class="number"> 30 </span>00:54 d</span><br></pre></td></tr></table></figure></p>
<p><strong>复制式卷</strong><br><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建复制式卷</span></span><br><span class="line">[root@mystorage1 ~]<span class="comment"># gluster volume create gv2 replica 2 mystorage3:/storage/brick1 mystorage4:/storage/brick1 force</span></span><br><span class="line">volume create: gv2: success: please start the volume <span class="keyword">to</span> access data</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动创建的卷</span></span><br><span class="line">[root@mystorage1 ~]<span class="comment"># gluster volume start gv2</span></span><br><span class="line">volume start: gv2: success</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看卷信息</span></span><br><span class="line">[root@mystorage1 ~]<span class="comment"># gluster volume info gv2</span></span><br><span class="line"> </span><br><span class="line">Volume Name: gv2</span><br><span class="line">Type: Replicate</span><br><span class="line">Volume ID: <span class="number">11928696</span>-<span class="number">263a</span>-<span class="number">4c</span>7a-a155-<span class="number">5115af</span>29221f</span><br><span class="line">Status: Started</span><br><span class="line">Number <span class="keyword">of</span> Bricks: <span class="number">1</span> x <span class="number">2</span> = <span class="number">2</span></span><br><span class="line">Transport-type: tcp</span><br><span class="line">Bricks:</span><br><span class="line">Brick1: mystorage3:/storage/brick1</span><br><span class="line">Brick2: mystorage4:/storage/brick1</span><br><span class="line">Options Reconfigured:</span><br><span class="line">performance.readdir-ahead: <span class="literal">on</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 挂载卷到目录，创建测试文件</span></span><br><span class="line">[root@mystorage1 ~]<span class="comment"># mount -t glusterfs 127.0.0.1:/gv2 /opt</span></span><br><span class="line">[root@mystorage1 ~]<span class="comment"># touch /opt/&#123;a..d&#125;</span></span><br><span class="line">[root@mystorage1 ~]<span class="comment"># ls /opt</span></span><br><span class="line">a  b  c  d</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 mystorage3,4 可看到新创建的文件</span></span><br><span class="line">[root@mystorage3 ~]<span class="comment"># mount -t glusterfs 127.0.0.1:/gv2 /opt</span></span><br><span class="line">[root@mystorage3 ~]<span class="comment"># ls /opt/</span></span><br><span class="line">a  b  c  d</span><br><span class="line"></span><br><span class="line">[root@mystorage4 ~]<span class="comment"># mount -t glusterfs 127.0.0.1:/gv2 /opt</span></span><br><span class="line">[root@mystorage4 ~]<span class="comment"># ls /opt/</span></span><br><span class="line">a  b  c  d</span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件实际存在位置</span></span><br><span class="line">[root@mystorage3 ~]<span class="comment"># ls /storage/brick1</span></span><br><span class="line">a  b  c  d</span><br><span class="line">[root@mystorage4 ~]<span class="comment"># ls /storage/brick1</span></span><br><span class="line">a  b  c  d</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上面可以看到文件根据在 2 台机器上的 brick 上都有</span></span><br></pre></td></tr></table></figure></p>
<p>格式化挂载第二块硬盘<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkfs<span class="selector-class">.xfs</span> -f /dev/sdc</span><br><span class="line">mkdir -<span class="selector-tag">p</span> /storage/brick2</span><br><span class="line">echo <span class="string">"/dev/sdc  /storage/brick2  xfs defaults 0 0"</span>  &gt;&gt; /etc/fstab</span><br><span class="line">mount -a</span><br><span class="line">df -h</span><br></pre></td></tr></table></figure></p>
<p><strong>分布式条带卷</strong><br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建分布式条带卷</span></span><br><span class="line">[root@mystorage1 ~]<span class="comment"># gluster volume create gv3 stripe 2 mystorage3:/storage/brick2 mystorage4:/storage/brick2 force</span></span><br><span class="line">volume create: gv3: success: please start <span class="keyword">the</span> volume <span class="keyword">to</span> access data</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动创建的卷</span></span><br><span class="line">[root@mystorage1 ~]<span class="comment"># gluster volume start gv3</span></span><br><span class="line">volume start: gv3: success</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看卷信息</span></span><br><span class="line">[root@mystorage1 ~]<span class="comment"># gluster volume info gv3</span></span><br><span class="line"> </span><br><span class="line">Volume Name: gv3</span><br><span class="line">Type: Stripe</span><br><span class="line">Volume ID: <span class="number">2871801</span>f-b125<span class="number">-465</span>c-be3a<span class="number">-4</span>eeb2fb44916</span><br><span class="line">Status: Started</span><br><span class="line">Number <span class="keyword">of</span> Bricks: <span class="number">1</span> x <span class="number">2</span> = <span class="number">2</span></span><br><span class="line">Transport-type: tcp</span><br><span class="line">Bricks:</span><br><span class="line">Brick1: mystorage3:/storage/brick2</span><br><span class="line">Brick2: mystorage4:/storage/brick2</span><br><span class="line">Options Reconfigured:</span><br><span class="line">performance.readdir-ahead: <span class="keyword">on</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 挂载卷到目录，创建测试文件</span></span><br><span class="line">mkdir /gv3</span><br><span class="line">mount -t glusterfs <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:gv3 /gv3</span><br><span class="line">df -h</span><br><span class="line"></span><br><span class="line">dd <span class="keyword">if</span>=/dev/zero bs=<span class="number">1024</span> <span class="built_in">count</span>=<span class="number">10000</span> <span class="keyword">of</span>=/gv3/<span class="number">10</span>M.<span class="built_in">file</span></span><br><span class="line">dd <span class="keyword">if</span>=/dev/zero bs=<span class="number">1024</span> <span class="built_in">count</span>=<span class="number">20000</span> <span class="keyword">of</span>=/gv3/<span class="number">20</span>M.<span class="built_in">file</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看新创建的文件</span></span><br><span class="line">[root@mystorage1 ~]<span class="comment"># ll /gv3/</span></span><br><span class="line">total <span class="number">30000</span></span><br><span class="line">-rw-r<span class="comment">--r-- 1 root root 10240000 Jul 30 02:26 10M.file</span></span><br><span class="line">-rw-r<span class="comment">--r-- 1 root root 20480000 Jul 30 02:26 20M.file</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件实际存放位置</span></span><br><span class="line">[root@mystorage3 ~]<span class="comment"># ll -h /storage/brick2/</span></span><br><span class="line">total <span class="number">15</span>M</span><br><span class="line">-rw-r<span class="comment">--r-- 2 root root 4.9M Jul 30 02:26 10M.file</span></span><br><span class="line">-rw-r<span class="comment">--r-- 2 root root 9.8M Jul 30 02:26 20M.file</span></span><br><span class="line">[root@mystorage4 ~]<span class="comment"># ll -h /storage/brick2/</span></span><br><span class="line">total <span class="number">15</span>M</span><br><span class="line">-rw-r<span class="comment">--r-- 2 root root 4.9M Jul 30 02:25 10M.file</span></span><br><span class="line">-rw-r<span class="comment">--r-- 2 root root 9.8M Jul 30 02:26 20M.file</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 上面可以看到 10M 20M 的文件分别分成了 2 块（这是条带的特点），每块又分别在同的 brick 下（这是分布式的特点）</span></span><br></pre></td></tr></table></figure></p>
<p><strong>分布式复制卷</strong><br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看复制式卷的效果</span></span><br><span class="line">cd /gv2</span><br><span class="line">rm -f *</span><br><span class="line">dd <span class="keyword">if</span>=/dev/zero bs=<span class="number">1024</span> <span class="built_in">count</span>=<span class="number">10000</span> <span class="keyword">of</span>=/gv2/<span class="number">10</span>M.<span class="built_in">file</span></span><br><span class="line">dd <span class="keyword">if</span>=/dev/zero bs=<span class="number">1024</span> <span class="built_in">count</span>=<span class="number">20000</span> <span class="keyword">of</span>=/gv2/<span class="number">20</span>M.<span class="built_in">file</span></span><br><span class="line">dd <span class="keyword">if</span>=/dev/zero bs=<span class="number">1024</span> <span class="built_in">count</span>=<span class="number">30000</span> <span class="keyword">of</span>=/gv2/<span class="number">30</span>M.<span class="built_in">file</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@mystorage3 ~]<span class="comment"># ll -h /storage/brick1/</span></span><br><span class="line">total <span class="number">59</span>M</span><br><span class="line">-rw-r<span class="comment">--r-- 2 root root 9.8M Jul 30 02:41 10M.file</span></span><br><span class="line">-rw-r<span class="comment">--r-- 2 root root  20M Jul 30 02:41 20M.file</span></span><br><span class="line">-rw-r<span class="comment">--r-- 2 root root  30M Jul 30 02:41 30M.file</span></span><br><span class="line">[root@mystorage4 ~]<span class="comment"># ll -h /storage/brick1</span></span><br><span class="line">total <span class="number">59</span>M</span><br><span class="line">-rw-r<span class="comment">--r-- 2 root root 9.8M Jul 30 02:40 10M.file</span></span><br><span class="line">-rw-r<span class="comment">--r-- 2 root root  20M Jul 30 02:40 20M.file</span></span><br><span class="line">-rw-r<span class="comment">--r-- 2 root root  30M Jul 30 02:40 30M.file</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># gv2 添加 brick 进行扩容</span></span><br><span class="line">[root@mystorage1 ~]<span class="comment"># gluster volume stop gv2</span></span><br><span class="line">Stopping volume will make <span class="keyword">its</span> data inaccessible. Do you want <span class="keyword">to</span> <span class="keyword">continue</span>? (y/n) y</span><br><span class="line"></span><br><span class="line">[root@mystorage1 ~]<span class="comment"># gluster volume add-brick gv2 replica 2 mystorage1:/storage/brick2 mystorage2:/storage/brick2 force</span></span><br><span class="line">volume add-brick: success</span><br><span class="line"></span><br><span class="line">[root@mystorage1 ~]<span class="comment"># gluster volume start gv2</span></span><br><span class="line">volume start: gv2: success</span><br><span class="line"></span><br><span class="line">[root@mystorage1 ~]<span class="comment"># gluster volume info gv2</span></span><br><span class="line"> </span><br><span class="line">Volume Name: gv2</span><br><span class="line">Type: Distributed-Replicate             <span class="comment"># 这里显示是分布式复制卷，是在 gv2 复制卷的基础上增加 2 块 brick 形成的</span></span><br><span class="line">Volume ID: <span class="number">11928696</span><span class="number">-263</span>a<span class="number">-4</span>c7a-a155<span class="number">-5115</span>af29221f</span><br><span class="line">Status: Stopped</span><br><span class="line">Number <span class="keyword">of</span> Bricks: <span class="number">2</span> x <span class="number">2</span> = <span class="number">4</span></span><br><span class="line">Transport-type: tcp</span><br><span class="line">Bricks:</span><br><span class="line">Brick1: mystorage3:/storage/brick1</span><br><span class="line">Brick2: mystorage4:/storage/brick1</span><br><span class="line">Brick3: mystorage1:/storage/brick2</span><br><span class="line">Brick4: mystorage2:/storage/brick2</span><br><span class="line">Options Reconfigured:</span><br><span class="line">performance.readdir-ahead: <span class="keyword">on</span></span><br></pre></td></tr></table></figure></p>
<p>注意：当你给分布式复制卷和分布式条带卷增加 bricks 时，你增加的 bricks 数目必须是复制或条带数目的倍数，例如：你给一个分布式复制卷的 replica 为 2，你在增加 bricks 的时候数量必须为2、4、6、8等。 扩容后进行测试，发现文件都分布在扩容前的卷中。</p>
<p><strong>磁盘存储的平衡</strong></p>
<p>注意：平衡布局是很有必要的，因为布局结构是静态的，当新的 bricks 加入现有卷，新创建的文件会分布到旧的 bricks 中，所以需要平衡布局结构，使新加入的 bricks 生效。布局平衡只是使新布局生效，并不会在新的布局中移动老的数据，如果你想在新布局生效后，重新平衡卷中的数据，还需要对卷中的数据进行平衡。</p>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span> <span class="comment">再在</span> <span class="comment">/gv2</span> <span class="comment">下创建</span> <span class="comment">2</span> <span class="comment">个新的文件</span> <span class="comment">10M</span><span class="string">.</span><span class="comment">file1</span> <span class="comment">20M</span><span class="string">.</span><span class="comment">file1</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span><span class="title">[</span><span class="comment">root@mystorage1</span> <span class="comment">~</span><span class="title">]</span><span class="comment">#</span> <span class="comment">dd</span> <span class="comment">if=/dev/zero</span> <span class="comment">bs=1024</span> <span class="comment">count=10000</span> <span class="comment">of=/gv2/10M</span><span class="string">.</span><span class="comment">file1</span></span><br><span class="line"><span class="comment"></span><span class="title">[</span><span class="comment">root@mystorage1</span> <span class="comment">~</span><span class="title">]</span><span class="comment">#</span> <span class="comment">dd</span> <span class="comment">if=/dev/zero</span> <span class="comment">bs=1024</span> <span class="comment">count=20000</span> <span class="comment">of=/gv2/20M</span><span class="string">.</span><span class="comment">file1</span></span><br><span class="line"><span class="comment"></span><span class="title">[</span><span class="comment">root@mystorage1</span> <span class="comment">~</span><span class="title">]</span><span class="comment">#</span> <span class="comment">ll</span> <span class="literal">-</span><span class="comment">rht</span> <span class="comment">/gv2/</span></span><br><span class="line"><span class="comment">total</span> <span class="comment">88M</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="comment">rw</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span> <span class="comment">1</span> <span class="comment">root</span> <span class="comment">root</span> <span class="comment">9</span><span class="string">.</span><span class="comment">8M</span> <span class="comment">Jul</span> <span class="comment">30</span> <span class="comment">02:40</span> <span class="comment">10M</span><span class="string">.</span><span class="comment">file</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="comment">rw</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span> <span class="comment">1</span> <span class="comment">root</span> <span class="comment">root</span>  <span class="comment">20M</span> <span class="comment">Jul</span> <span class="comment">30</span> <span class="comment">02:40</span> <span class="comment">20M</span><span class="string">.</span><span class="comment">file</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="comment">rw</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span> <span class="comment">1</span> <span class="comment">root</span> <span class="comment">root</span>  <span class="comment">30M</span> <span class="comment">Jul</span> <span class="comment">30</span> <span class="comment">02:40</span> <span class="comment">30M</span><span class="string">.</span><span class="comment">file</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="comment">rw</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span> <span class="comment">1</span> <span class="comment">root</span> <span class="comment">root</span> <span class="comment">9</span><span class="string">.</span><span class="comment">8M</span> <span class="comment">Jul</span> <span class="comment">30</span> <span class="comment">03:10</span> <span class="comment">10M</span><span class="string">.</span><span class="comment">file1</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="comment">rw</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span> <span class="comment">1</span> <span class="comment">root</span> <span class="comment">root</span>  <span class="comment">20M</span> <span class="comment">Jul</span> <span class="comment">30</span> <span class="comment">03:10</span> <span class="comment">20M</span><span class="string">.</span><span class="comment">file1</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span><span class="title">[</span><span class="comment">root@mystorage1</span> <span class="comment">~</span><span class="title">]</span><span class="comment">#</span> <span class="comment">ll</span> <span class="comment">/storage/brick2</span></span><br><span class="line"><span class="comment">total</span> <span class="comment">0</span></span><br><span class="line"><span class="comment"></span><span class="title">[</span><span class="comment">root@mystorage2</span> <span class="comment">~</span><span class="title">]</span><span class="comment">#</span> <span class="comment">ll</span> <span class="comment">/storage/brick2</span></span><br><span class="line"><span class="comment">total</span> <span class="comment">0</span></span><br><span class="line"><span class="comment"></span><span class="title">[</span><span class="comment">root@mystorage3</span> <span class="comment">~</span><span class="title">]</span><span class="comment">#</span> <span class="comment">ll</span> <span class="literal">-</span><span class="comment">hrt</span> <span class="comment">/storage/brick1</span></span><br><span class="line"><span class="comment">total</span> <span class="comment">88M</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="comment">rw</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span> <span class="comment">2</span> <span class="comment">root</span> <span class="comment">root</span> <span class="comment">9</span><span class="string">.</span><span class="comment">8M</span> <span class="comment">Jul</span> <span class="comment">30</span> <span class="comment">02:41</span> <span class="comment">10M</span><span class="string">.</span><span class="comment">file</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="comment">rw</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span> <span class="comment">2</span> <span class="comment">root</span> <span class="comment">root</span>  <span class="comment">20M</span> <span class="comment">Jul</span> <span class="comment">30</span> <span class="comment">02:41</span> <span class="comment">20M</span><span class="string">.</span><span class="comment">file</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="comment">rw</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span> <span class="comment">2</span> <span class="comment">root</span> <span class="comment">root</span>  <span class="comment">30M</span> <span class="comment">Jul</span> <span class="comment">30</span> <span class="comment">02:41</span> <span class="comment">30M</span><span class="string">.</span><span class="comment">file</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="comment">rw</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span> <span class="comment">2</span> <span class="comment">root</span> <span class="comment">root</span> <span class="comment">9</span><span class="string">.</span><span class="comment">8M</span> <span class="comment">Jul</span> <span class="comment">30</span> <span class="comment">03:12</span> <span class="comment">10M</span><span class="string">.</span><span class="comment">file1</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="comment">rw</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span> <span class="comment">2</span> <span class="comment">root</span> <span class="comment">root</span>  <span class="comment">20M</span> <span class="comment">Jul</span> <span class="comment">30</span> <span class="comment">03:13</span> <span class="comment">20M</span><span class="string">.</span><span class="comment">file1</span></span><br><span class="line"><span class="comment"></span><span class="title">[</span><span class="comment">root@mystorage4</span> <span class="comment">~</span><span class="title">]</span><span class="comment">#</span> <span class="comment">ll</span> <span class="literal">-</span><span class="comment">hrt</span> <span class="comment">/storage/brick1</span></span><br><span class="line"><span class="comment">total</span> <span class="comment">88M</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="comment">rw</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span> <span class="comment">2</span> <span class="comment">root</span> <span class="comment">root</span> <span class="comment">9</span><span class="string">.</span><span class="comment">8M</span> <span class="comment">Jul</span> <span class="comment">30</span> <span class="comment">02:40</span> <span class="comment">10M</span><span class="string">.</span><span class="comment">file</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="comment">rw</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span> <span class="comment">2</span> <span class="comment">root</span> <span class="comment">root</span>  <span class="comment">20M</span> <span class="comment">Jul</span> <span class="comment">30</span> <span class="comment">02:40</span> <span class="comment">20M</span><span class="string">.</span><span class="comment">file</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="comment">rw</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span> <span class="comment">2</span> <span class="comment">root</span> <span class="comment">root</span>  <span class="comment">30M</span> <span class="comment">Jul</span> <span class="comment">30</span> <span class="comment">02:40</span> <span class="comment">30M</span><span class="string">.</span><span class="comment">file</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="comment">rw</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span> <span class="comment">2</span> <span class="comment">root</span> <span class="comment">root</span> <span class="comment">9</span><span class="string">.</span><span class="comment">8M</span> <span class="comment">Jul</span> <span class="comment">30</span> <span class="comment">03:10</span> <span class="comment">10M</span><span class="string">.</span><span class="comment">file1</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="comment">rw</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span> <span class="comment">2</span> <span class="comment">root</span> <span class="comment">root</span>  <span class="comment">20M</span> <span class="comment">Jul</span> <span class="comment">30</span> <span class="comment">03:10</span> <span class="comment">20M</span><span class="string">.</span><span class="comment">file1</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#</span> <span class="comment">从上面可以看到，新创建的文件还是在之前的</span> <span class="comment">bricks</span> <span class="comment">中，并没有分布中新加的</span> <span class="comment">bricks</span> <span class="comment">中</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#</span> <span class="comment">下面进行磁盘存储平衡</span></span><br><span class="line"><span class="comment"></span><span class="title">[</span><span class="comment">root@mystorage1</span> <span class="comment">~</span><span class="title">]</span><span class="comment">#</span> <span class="comment">gluster</span> <span class="comment">volume</span> <span class="comment">rebalance</span> <span class="comment">gv2</span> <span class="comment">start</span></span><br><span class="line"><span class="comment">volume</span> <span class="comment">rebalance:</span> <span class="comment">gv2:</span> <span class="comment">success:</span> <span class="comment">Rebalance</span> <span class="comment">on</span> <span class="comment">gv2</span> <span class="comment">has</span> <span class="comment">been</span> <span class="comment">started</span> <span class="comment">successfully</span><span class="string">.</span> <span class="comment">Use</span> <span class="comment">rebalance</span> <span class="comment">status</span> <span class="comment">command</span> <span class="comment">to</span> <span class="comment">check</span> <span class="comment">status</span> <span class="comment">of</span> <span class="comment">the</span> <span class="comment">rebalance</span> <span class="comment">process</span><span class="string">.</span></span><br><span class="line"><span class="comment">ID:</span> <span class="comment">e23213be</span><span class="literal">-</span><span class="comment">7771</span><span class="literal">-</span><span class="comment">4a2b</span><span class="literal">-</span><span class="comment">87b4</span><span class="literal">-</span><span class="comment">259fd048ec46</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span><span class="title">[</span><span class="comment">root@mystorage1</span> <span class="comment">~</span><span class="title">]</span><span class="comment">#</span> <span class="comment">gluster</span> <span class="comment">volume</span> <span class="comment">rebalance</span> <span class="comment">gv2</span> <span class="comment">status</span></span><br><span class="line"><span class="comment"></span>                                    <span class="comment">Node</span> <span class="comment">Rebalanced</span><span class="literal">-</span><span class="comment">files</span>          <span class="comment">size</span>       <span class="comment">scanned</span>      <span class="comment">failures</span>       <span class="comment">skipped</span>               <span class="comment">status</span>  <span class="comment">run</span> <span class="comment">time</span> <span class="comment">in</span> <span class="comment">h:m:s</span></span><br><span class="line"><span class="comment"></span>                               <span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span>      <span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span>   <span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span>   <span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span>   <span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span>   <span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span>         <span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span>     <span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span></span><br><span class="line">                               <span class="comment">localhost</span>                <span class="comment">0</span>        <span class="comment">0Bytes</span>             <span class="comment">0</span>             <span class="comment">0</span>             <span class="comment">0</span>            <span class="comment">completed</span>        <span class="comment">0:0:1</span></span><br><span class="line"><span class="comment"></span>                              <span class="comment">mystorage2</span>                <span class="comment">0</span>        <span class="comment">0Bytes</span>             <span class="comment">0</span>             <span class="comment">0</span>             <span class="comment">0</span>            <span class="comment">completed</span>        <span class="comment">0:0:0</span></span><br><span class="line"><span class="comment"></span>                              <span class="comment">mystorage3</span>                <span class="comment">2</span>        <span class="comment">39</span><span class="string">.</span><span class="comment">1MB</span>             <span class="comment">5</span>             <span class="comment">0</span>             <span class="comment">0</span>            <span class="comment">completed</span>        <span class="comment">0:0:2</span></span><br><span class="line"><span class="comment"></span>                              <span class="comment">mystorage4</span>                <span class="comment">0</span>        <span class="comment">0Bytes</span>             <span class="comment">0</span>             <span class="comment">0</span>             <span class="comment">0</span>            <span class="comment">completed</span>        <span class="comment">0:0:1</span></span><br><span class="line"><span class="comment">volume</span> <span class="comment">rebalance:</span> <span class="comment">gv2:</span> <span class="comment">success</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#</span> <span class="comment">查看磁盘存储平衡后文件在</span> <span class="comment">bricks</span> <span class="comment">中的分布情况</span></span><br><span class="line"><span class="comment"></span><span class="title">[</span><span class="comment">root@mystorage1</span> <span class="comment">~</span><span class="title">]</span><span class="comment">#</span> <span class="comment">ll</span> <span class="comment">/storage/brick2</span></span><br><span class="line"><span class="comment">total</span> <span class="comment">40000</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="comment">rw</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span> <span class="comment">2</span> <span class="comment">root</span> <span class="comment">root</span> <span class="comment">20480000</span> <span class="comment">Jul</span> <span class="comment">30</span> <span class="comment">02:41</span> <span class="comment">20M</span><span class="string">.</span><span class="comment">file</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="comment">rw</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span> <span class="comment">2</span> <span class="comment">root</span> <span class="comment">root</span> <span class="comment">20480000</span> <span class="comment">Jul</span> <span class="comment">30</span> <span class="comment">03:13</span> <span class="comment">20M</span><span class="string">.</span><span class="comment">file1</span></span><br><span class="line"><span class="comment"></span><span class="title">[</span><span class="comment">root@mystorage2</span> <span class="comment">~</span><span class="title">]</span><span class="comment">#</span> <span class="comment">ll</span> <span class="comment">/storage/brick2</span></span><br><span class="line"><span class="comment">total</span> <span class="comment">40000</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="comment">rw</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span> <span class="comment">2</span> <span class="comment">root</span> <span class="comment">root</span> <span class="comment">20480000</span> <span class="comment">Jul</span> <span class="comment">30</span> <span class="comment">02:41</span> <span class="comment">20M</span><span class="string">.</span><span class="comment">file</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="comment">rw</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span> <span class="comment">2</span> <span class="comment">root</span> <span class="comment">root</span> <span class="comment">20480000</span> <span class="comment">Jul</span> <span class="comment">30</span> <span class="comment">03:13</span> <span class="comment">20M</span><span class="string">.</span><span class="comment">file1</span></span><br><span class="line"><span class="comment"></span><span class="title">[</span><span class="comment">root@mystorage3</span> <span class="comment">~</span><span class="title">]</span><span class="comment">#</span> <span class="comment">ll</span> <span class="literal">-</span><span class="comment">hrt</span> <span class="comment">/storage/brick1</span></span><br><span class="line"><span class="comment">total</span> <span class="comment">49M</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="comment">rw</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span> <span class="comment">2</span> <span class="comment">root</span> <span class="comment">root</span> <span class="comment">9</span><span class="string">.</span><span class="comment">8M</span> <span class="comment">Jul</span> <span class="comment">30</span> <span class="comment">02:41</span> <span class="comment">10M</span><span class="string">.</span><span class="comment">file</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="comment">rw</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span> <span class="comment">2</span> <span class="comment">root</span> <span class="comment">root</span>  <span class="comment">30M</span> <span class="comment">Jul</span> <span class="comment">30</span> <span class="comment">02:41</span> <span class="comment">30M</span><span class="string">.</span><span class="comment">file</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="comment">rw</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span> <span class="comment">2</span> <span class="comment">root</span> <span class="comment">root</span> <span class="comment">9</span><span class="string">.</span><span class="comment">8M</span> <span class="comment">Jul</span> <span class="comment">30</span> <span class="comment">03:12</span> <span class="comment">10M</span><span class="string">.</span><span class="comment">file1</span></span><br><span class="line"><span class="comment"></span><span class="title">[</span><span class="comment">root@mystorage4</span> <span class="comment">~</span><span class="title">]</span><span class="comment">#</span> <span class="comment">ll</span> <span class="literal">-</span><span class="comment">hrt</span> <span class="comment">/storage/brick1</span></span><br><span class="line"><span class="comment">total</span> <span class="comment">49M</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="comment">rw</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span> <span class="comment">2</span> <span class="comment">root</span> <span class="comment">root</span> <span class="comment">9</span><span class="string">.</span><span class="comment">8M</span> <span class="comment">Jul</span> <span class="comment">30</span> <span class="comment">02:40</span> <span class="comment">10M</span><span class="string">.</span><span class="comment">file</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="comment">rw</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span> <span class="comment">2</span> <span class="comment">root</span> <span class="comment">root</span>  <span class="comment">30M</span> <span class="comment">Jul</span> <span class="comment">30</span> <span class="comment">02:40</span> <span class="comment">30M</span><span class="string">.</span><span class="comment">file</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="comment">rw</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span><span class="comment">r</span><span class="literal">-</span><span class="literal">-</span> <span class="comment">2</span> <span class="comment">root</span> <span class="comment">root</span> <span class="comment">9</span><span class="string">.</span><span class="comment">8M</span> <span class="comment">Jul</span> <span class="comment">30</span> <span class="comment">03:10</span> <span class="comment">10M</span><span class="string">.</span><span class="comment">file1</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#</span> <span class="comment">从上面可以看到</span> <span class="comment">20M</span><span class="string">.</span><span class="comment">file</span> <span class="comment">20M</span><span class="string">.</span><span class="comment">file1</span> <span class="comment">2</span> <span class="comment">个文件</span> <span class="comment">平衡到</span> <span class="comment">新加的</span> <span class="comment">2</span> <span class="comment">个</span> <span class="comment">brick</span> <span class="comment">中了</span></span><br></pre></td></tr></table></figure>
<p>每做一次扩容后都需要做一次磁盘平衡。 磁盘平衡是在万不得已的情况下再做的，一般再创建一个卷就可以了。</p>
<p><strong>移除 brick</strong></p>
<p>你可能想在线缩小卷的大小，例如：当硬件损坏或网络故障的时候，你可能想在卷中移除相关的 bricks。<br>注意：当你移除 bricks 的时候，你在 gluster 的挂载点将不能继续访问数据，只有配置文件中的信息移除后你才能继续访问 bricks 中的数据。当移除分布式复制卷或者分布式条带卷的时候，移除的 bricks 数目必须是 replica 或者 stripe 的倍数。<br>例如：一个分布式条带卷的 stripe 是 2，当你移除 bricks 的时候必须是 2、4、6、8 等。<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下面移除 gv2 卷的 2 个 bricks</span></span><br><span class="line"></span><br><span class="line">[root@mystorage1 ~]<span class="comment"># gluster volume stop gv2</span></span><br><span class="line">Stopping volume will make its data inaccessible. Do you want to <span class="keyword">continue</span>? (<span class="keyword">y</span>/n) <span class="keyword">y</span></span><br><span class="line">volume stop: gv2: success</span><br><span class="line">[root@mystorage1 ~]<span class="comment"># gluster volume remove-brick gv2 replica 2 mystorage3:/storage/brick1 mystorage4:/storage/brick1 force</span></span><br><span class="line">Removing brick(<span class="keyword">s</span>) can result in data loss. Do you want to Continue? (<span class="keyword">y</span>/n) <span class="keyword">y</span></span><br><span class="line">volume remove-brick commit force: success</span><br><span class="line">[root@mystorage1 ~]<span class="comment"># gluster volume start gv2</span></span><br><span class="line">volume start: gv2: success</span><br><span class="line">[root@mystorage1 ~]<span class="comment"># ll /gv2/</span></span><br><span class="line">total <span class="number">40000</span></span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">20480000</span> Jul <span class="number">30</span> <span class="number">02</span>:<span class="number">41</span> <span class="number">20</span>M.file</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">20480000</span> Jul <span class="number">30</span> <span class="number">03</span>:<span class="number">13</span> <span class="number">20</span>M.file1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果误操作删除了后，其实文件还在 /storage/brick1 里面的，加回来就可以了</span></span><br><span class="line">[root@mystorage1 ~]<span class="comment"># gluster volume stop gv2</span></span><br><span class="line">Stopping volume will make its data inaccessible. Do you want to <span class="keyword">continue</span>? (<span class="keyword">y</span>/n) <span class="keyword">y</span></span><br><span class="line">volume stop: gv2: success</span><br><span class="line">[root@mystorage1 ~]<span class="comment"># gluster volume add-brick gv2 replica 2 mystorage3:/storage/brick1 mystorage4:/storage/brick1 force</span></span><br><span class="line">volume add-brick: success</span><br><span class="line">[root@mystorage1 ~]<span class="comment"># gluster volume info gv2</span></span><br><span class="line"> </span><br><span class="line">Volume Name: gv2</span><br><span class="line">Type: Distributed-Replicate</span><br><span class="line">Volume ID: <span class="number">11928696</span>-<span class="number">263</span>a-<span class="number">4</span>c7a-a155-<span class="number">5115</span>af29221f</span><br><span class="line">Status: Stopped</span><br><span class="line">Number of Bricks: <span class="number">2</span> <span class="keyword">x</span> <span class="number">2</span> = <span class="number">4</span></span><br><span class="line">Transport-type: tcp</span><br><span class="line">Bricks:</span><br><span class="line">Brick1: mystorage1:<span class="regexp">/storage/brick</span>2</span><br><span class="line">Brick2: mystorage2:<span class="regexp">/storage/brick</span>2</span><br><span class="line">Brick3: mystorage3:<span class="regexp">/storage/brick</span>1</span><br><span class="line">Brick4: mystorage4:<span class="regexp">/storage/brick</span>1</span><br><span class="line">Options Reconfigured:</span><br><span class="line">performance.readdir-ahead: on</span><br><span class="line">[root@mystorage1 ~]<span class="comment"># gluster volume start gv2</span></span><br><span class="line">volume start: gv2: success</span><br><span class="line">[root@mystorage1 ~]<span class="comment"># ll /gv2/                   # 文件还在</span></span><br><span class="line">total <span class="number">90000</span></span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">10240000</span> Jul <span class="number">30</span> <span class="number">02</span>:<span class="number">40</span> <span class="number">10</span>M.file</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">10240000</span> Jul <span class="number">30</span> <span class="number">03</span>:<span class="number">10</span> <span class="number">10</span>M.file1</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">20480000</span> Jul <span class="number">30</span> <span class="number">02</span>:<span class="number">41</span> <span class="number">20</span>M.file</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">20480000</span> Jul <span class="number">30</span> <span class="number">03</span>:<span class="number">13</span> <span class="number">20</span>M.file1</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">30720000</span> Jul <span class="number">30</span> <span class="number">02</span>:<span class="number">40</span> <span class="number">30</span>M.file</span><br></pre></td></tr></table></figure></p>
<p><strong>删除卷</strong></p>
<p>一般会用在命名不规范的时候才会删除<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@mystorage1 ~]<span class="comment"># umount /gv1</span></span><br><span class="line">[root@mystorage1 ~]<span class="comment"># gluster volume stop gv1</span></span><br><span class="line">Stopping <span class="keyword">volume</span><span class="bash"> will make its data inaccessible. Do you want to <span class="built_in">continue</span>? (y/n) y</span></span><br><span class="line"><span class="bash">volume stop: gv1: success</span></span><br><span class="line"><span class="bash">[root@mystorage1 ~]<span class="comment"># gluster volume delete gv1</span></span></span><br><span class="line"><span class="bash">Deleting volume will erase all information about the volume. Do you want to <span class="built_in">continue</span>? (y/n) y</span></span><br><span class="line"><span class="bash">volume delete: gv1: success</span></span><br><span class="line"><span class="bash">[root@mystorage1 ~]<span class="comment"># gluster volume info gv1</span></span></span><br><span class="line"><span class="bash">Volume gv1 does not exist</span></span><br></pre></td></tr></table></figure></p>
<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><p><strong>1 NFS rpcbind 没启动</strong><br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@mystorage3 ~]<span class="comment"># mount -o mountproto=tcp -t nfs mystorage1:/gv1 /mnt/</span></span><br><span class="line">mount.nfs: rpc.statd <span class="keyword">is</span> <span class="keyword">not</span> <span class="built_in">running</span> <span class="keyword">but</span> <span class="keyword">is</span> required <span class="keyword">for</span> remote locking.</span><br><span class="line">mount.nfs: Either use '-o nolock' <span class="keyword">to</span> keep locks <span class="keyword">local</span>, <span class="keyword">or</span> start statd.</span><br><span class="line">mount.nfs: an incorrect mount option was specified</span><br><span class="line">[root@mystorage3 ~]<span class="comment"># gluster volume status gv1</span></span><br><span class="line">Status <span class="keyword">of</span> volume: gv1</span><br><span class="line">Gluster process                             TCP Port  RDMA Port  Online  Pid</span><br><span class="line"><span class="comment">------------------------------------------------------------------------------</span></span><br><span class="line">Brick mystorage1:/storage/brick1            <span class="number">49152</span>     <span class="number">0</span>          Y       <span class="number">3839</span> </span><br><span class="line">Brick mystorage2:/storage/brick1            <span class="number">49152</span>     <span class="number">0</span>          Y       <span class="number">3959</span> </span><br><span class="line">NFS Server <span class="keyword">on</span> localhost                     N/A       N/A        N       N/A  </span><br><span class="line">NFS Server <span class="keyword">on</span> mystorage1                    N/A       N/A        N       N/A  </span><br><span class="line">NFS Server <span class="keyword">on</span> mystorage2                    N/A       N/A        N       N/A  </span><br><span class="line">NFS Server <span class="keyword">on</span> mystorage4                    N/A       N/A        N       N/A  </span><br><span class="line"> </span><br><span class="line">Task Status <span class="keyword">of</span> Volume gv1</span><br><span class="line"><span class="comment">------------------------------------------------------------------------------</span></span><br><span class="line">There are no active volume tasks</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 rpcbind，重启 glusterd </span></span><br><span class="line">[root@mystorage3 ~]<span class="comment"># /etc/init.d/rpcbind start</span></span><br><span class="line">Starting rpcbind:                                          [  OK  ]</span><br><span class="line">[root@mystorage3 ~]<span class="comment"># /etc/init.d/glusterd restart</span></span><br><span class="line">Starting glusterd:                                         [  OK  ]</span><br></pre></td></tr></table></figure></p>
<p><strong>2 VMware Workstation 虚拟机在线增加硬盘，CentOS 没有自动识别</strong><br><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用如下命令，其中 host2 表示新增加的硬盘</span></span><br><span class="line">echo <span class="string">"- - -"</span> &gt;  /sys/<span class="class"><span class="keyword">class</span>/<span class="title">scsi_host</span>/<span class="title">host2</span>/<span class="title">scan</span></span></span><br><span class="line">fdisk -l</span><br></pre></td></tr></table></figure></p>
<h1 id="3-构建企业级分布式存储"><a href="#3-构建企业级分布式存储" class="headerlink" title="3. 构建企业级分布式存储"></a>3. 构建企业级分布式存储</h1><h2 id="3-1-硬件要求"><a href="#3-1-硬件要求" class="headerlink" title="3.1 硬件要求"></a>3.1 硬件要求</h2><p>一般选择 2U 机型，磁盘 SATA 盘 4TB，如果 IO 要求比较高，可以采购 SSD 固态硬盘。<br>为了充分保证系统的稳定性和性能，要求所有 glusterfs 服务器硬件配置尽量一致，尤其是硬盘数量和大小。<br>机器的 RAID 卡需要带电池，缓存越大，性能越好。一般情况下，建议做 RAID 10，如果出于空间要求的考虑，需要做 RAID 5，建议最好能有 1-2 块硬盘的热备盘。</p>
<h2 id="3-2-系统要求和分区划分"><a href="#3-2-系统要求和分区划分" class="headerlink" title="3.2 系统要求和分区划分"></a>3.2 系统要求和分区划分</h2><p>系统可以使用 CentOS 6.x x86_64，安装完成后升级到最新版本，安装的时候，不要使用 LV，<br>建议：/boot 分区 200M，/ 分区 100G，swap 分区和内存一样大小，剩余空间给 gluster 使用，划分单独的硬盘空间。<br>系统安装软件没有特殊要求，建议除了开发工具和基本的管理软件，其他软件一律不安装。</p>
<h2 id="3-3-网络环境"><a href="#3-3-网络环境" class="headerlink" title="3.3 网络环境"></a>3.3 网络环境</h2><p>网络要求全部千兆环境，gluster 服务器至少有 2 块网卡，1 块网卡绑定供 gluster 使用，剩余一块分配管理网络 IP，用于系统管理。<br>如果有条件购买万兆交换机，服务器配置万兆网卡，存储性能会更好。网络方面如果安全性要求较高，可以多网卡绑定。</p>
<p>跨地区机房配置 Gluster，在中国网络不适用。</p>
<h2 id="3-4-服务器摆放分布"><a href="#3-4-服务器摆放分布" class="headerlink" title="3.4 服务器摆放分布"></a>3.4 服务器摆放分布</h2><p>服务器主备机器要放在不同的机柜，连接不同的交换机，即使一个机柜出现问题，还有一份数据正常访问。</p>
<p><img src="/images/gluster-jiguibaifang-01.png" alt="11"><br><img src="/images/GlusterFS-Cabinet-02.png" alt="11"></p>
<h2 id="3-5-构建高性能、高可用存储"><a href="#3-5-构建高性能、高可用存储" class="headerlink" title="3.5 构建高性能、高可用存储"></a>3.5 构建高性能、高可用存储</h2><p>一般在企业中，采用的是分布式复制卷，因为有数据备份，数据相对安全，分布式条带卷目前对 gluster 来说没有完全成熟，存在一定的数据安全风险。</p>
<h2 id="3-5-1-开启防火墙端口"><a href="#3-5-1-开启防火墙端口" class="headerlink" title="3.5.1 开启防火墙端口"></a>3.5.1 开启防火墙端口</h2><p>一般在企业应用中 Linux 防火墙是打开的，这些 Gluster 服务器之间访问的端口如下：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -I INPUT -<span class="selector-tag">p</span> tcp –dport <span class="number">24007</span>:<span class="number">24011</span> -j ACCEPT</span><br><span class="line">iptables -I INPUT -<span class="selector-tag">p</span> tcp –dport <span class="number">38465</span>:<span class="number">38485</span> -j ACCEPT</span><br></pre></td></tr></table></figure></p>
<p>上面是卷的端口，下面是硬盘的端口，磁盘越多，端口越多</p>
<h2 id="3-5-2-GlusterFS-文件系统优化"><a href="#3-5-2-GlusterFS-文件系统优化" class="headerlink" title="3.5.2 GlusterFS 文件系统优化"></a>3.5.2 GlusterFS 文件系统优化</h2><table>
<thead>
<tr>
<th>参数项目</th>
<th>说明</th>
<th>缺省值</th>
<th>合法值</th>
</tr>
</thead>
<tbody>
<tr>
<td>Auth.allow</td>
<td>IP访问授权</td>
<td>*(allow all)</td>
<td>IP地址</td>
</tr>
<tr>
<td>Cluster.min-free-disk</td>
<td>剩余磁盘空间阈值</td>
<td>10%</td>
<td>百分比</td>
</tr>
<tr>
<td>Cluseer.stripe-block-size</td>
<td>条带大小</td>
<td>128KB</td>
<td>字节</td>
</tr>
<tr>
<td>Netwok.frame-timeout</td>
<td>请求等待时间</td>
<td>1800s</td>
<td>0-1800</td>
</tr>
<tr>
<td>Network.ping-timeout</td>
<td>客户端等待时间</td>
<td>42s</td>
<td>0-42</td>
</tr>
<tr>
<td>Nfs.disabled</td>
<td>关闭NFS服务</td>
<td>Off</td>
<td>Off丨on</td>
</tr>
<tr>
<td>Performance.io-thread-count</td>
<td>IO 线程数</td>
<td>16</td>
<td>0-65</td>
</tr>
<tr>
<td>Performance.cache-refresh-timeout</td>
<td>缓存校验周期</td>
<td>1s</td>
<td>0-61</td>
</tr>
<tr>
<td>Performance.cache-size</td>
<td>读缓存大小</td>
<td>32MB</td>
<td>字节</td>
</tr>
</tbody>
</table>
<ul>
<li>Performance.quick-read: 优化读取小文件的性能。</li>
<li>Performance.read-ahead: 用预读的方式提高读取的性能，有利于应用频繁持续性的访问文件，当应用完成当前数据块读取的时候，下一个数据块就已经准备好了。</li>
<li>Performance.write-behind: 在写数据时，先写入缓存内，再写入硬盘，以提高写入的性能。</li>
<li>Performance.io-cache: 缓存已经被读过的</li>
</ul>
<p>GlusterFS 性能参数调整方法<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gluster <span class="keyword">volume</span><span class="bash"> <span class="built_in">set</span> &lt;卷&gt; &lt;参数&gt;</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@mystorage1 ~]<span class="comment"># gluster volume set gv2 performance.read-ahead on</span></span><br><span class="line">volume <span class="keyword">set</span>: success</span><br><span class="line">[root@mystorage1 ~]<span class="comment"># gluster volume set gv2 performance.cache-size 256MB</span></span><br><span class="line">volume <span class="keyword">set</span>: success</span><br><span class="line">[root@mystorage1 ~]<span class="comment"># gluster volume info gv2</span></span><br><span class="line"> </span><br><span class="line">Volume Name: gv2</span><br><span class="line">Type: Distributed-Replicate</span><br><span class="line">Volume ID: <span class="number">11928696</span><span class="number">-263</span>a<span class="number">-4</span>c7a-a155<span class="number">-5115</span>af29221f</span><br><span class="line">Status: Started</span><br><span class="line">Number <span class="keyword">of</span> Bricks: <span class="number">2</span> x <span class="number">2</span> = <span class="number">4</span></span><br><span class="line">Transport-type: tcp</span><br><span class="line">Bricks:</span><br><span class="line">Brick1: mystorage1:/storage/brick2</span><br><span class="line">Brick2: mystorage2:/storage/brick2</span><br><span class="line">Brick3: mystorage3:/storage/brick1</span><br><span class="line">Brick4: mystorage4:/storage/brick1</span><br><span class="line">Options Reconfigured:</span><br><span class="line">performance.cache-size: <span class="number">256</span>MB</span><br><span class="line">performance.<span class="built_in">read</span>-ahead: <span class="keyword">on</span></span><br><span class="line">performance.readdir-ahead: <span class="keyword">on</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># GlusterFS 所有性能参数</span></span><br><span class="line">[root@mystorage1 ~]<span class="comment"># gluster volume set gv2 performance.</span></span><br><span class="line">performance.cache-max-<span class="built_in">file</span>-size              performance.force-readdirp                   performance.nfs.flush-<span class="keyword">behind</span>                 performance.<span class="built_in">read</span>-ahead</span><br><span class="line">performance.cache-min-<span class="built_in">file</span>-size              performance.high-prio-threads                performance.nfs.strict-o-direct              performance.<span class="built_in">read</span>-ahead-page-<span class="built_in">count</span></span><br><span class="line">performance.cache-priority                   performance.io-cache                         performance.nfs.strict-<span class="built_in">write</span>-ordering        performance.readdir-ahead</span><br><span class="line">performance.cache-refresh-<span class="keyword">timeout</span>            performance.io-thread-<span class="built_in">count</span>                  performance.nfs.<span class="built_in">write</span>-<span class="keyword">behind</span>                 performance.resync-failed-syncs-<span class="keyword">after</span>-fsync</span><br><span class="line">performance.cache-size                       performance.lazy-open                        performance.nfs.<span class="built_in">write</span>-<span class="keyword">behind</span>-window-size     performance.stat-prefetch</span><br><span class="line">performance.cache-swift-metadata             performance.least-prio-threads               performance.normal-prio-threads              performance.strict-o-direct</span><br><span class="line">performance.client-io-threads                performance.least-rate-limit                 performance.open-<span class="keyword">behind</span>                      performance.strict-<span class="built_in">write</span>-ordering</span><br><span class="line">performance.enable-least-priority            performance.low-prio-threads                 performance.quick-<span class="built_in">read</span>                       performance.<span class="built_in">write</span>-<span class="keyword">behind</span></span><br><span class="line">performance.flush-<span class="keyword">behind</span>                     performance.md-cache-<span class="keyword">timeout</span>                 performance.<span class="built_in">read</span>-<span class="keyword">after</span>-open                  performance.<span class="built_in">write</span>-<span class="keyword">behind</span>-window-size</span><br></pre></td></tr></table></figure>
<h2 id="3-6-监控及日常维护"><a href="#3-6-监控及日常维护" class="headerlink" title="3.6 监控及日常维护"></a>3.6 监控及日常维护</h2><p>可以使用 Zabbix 自带模板监控 CPU、内存、主机存活、磁盘空间、主机运行时间、系统 Load 等。<br>日常要注意服务器的监控值，遇到报警要及时处理。</p>
<p>以下大多数功能是针对分布式复制卷执行的。<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 查看卷的状态</span></span><br><span class="line"><span class="title">gluster</span> volume status gv2 </span><br><span class="line"></span><br><span class="line"><span class="meta"># 启动完全修复</span></span><br><span class="line"><span class="title">gluster</span> volume heal gv2 full</span><br><span class="line"></span><br><span class="line"><span class="meta"># 查看需要修复的文件</span></span><br><span class="line"><span class="title">gluster</span> volume heal gv2 info</span><br><span class="line"></span><br><span class="line"><span class="meta"># 查看修复成功的文件</span></span><br><span class="line"><span class="title">gluster</span> volume heal gv2 info healed</span><br><span class="line"></span><br><span class="line"><span class="meta"># 查看修复失败的文件</span></span><br><span class="line"><span class="title">gluster</span> volume heal gv2 info heal-failed</span><br><span class="line"></span><br><span class="line"><span class="meta"># 查看脑裂的文件</span></span><br><span class="line"><span class="title">gluster</span> volume heal gv2 info split-brain</span><br><span class="line"></span><br><span class="line"><span class="meta"># 激活 quota 功能</span></span><br><span class="line"><span class="title">gluster</span> volume quota gv2 enable</span><br><span class="line"></span><br><span class="line"><span class="meta"># 关闭 quota 功能</span></span><br><span class="line"><span class="title">gluster</span> volume quota gv2 disable</span><br><span class="line"></span><br><span class="line"><span class="meta"># 目录大小限制 /data 是相对卷挂载点的目录，下面是指 /gv2/data</span></span><br><span class="line"><span class="title">gluster</span> volume quota gv2 limit-usage /<span class="class"><span class="keyword">data</span> 30MB</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 写入 40MB 文件 测试 quota</span></span><br><span class="line"><span class="title">dd</span> <span class="keyword">if</span>=/dev/zero bs=<span class="number">1024</span> count=<span class="number">40000</span> <span class="keyword">of</span>=/gv2/<span class="class"><span class="keyword">data</span>/40M.file</span></span><br><span class="line"></span><br><span class="line">[root@mystorage1 ~]# dd <span class="keyword">if</span>=/dev/zero bs=<span class="number">1024</span> count=<span class="number">40000</span> <span class="keyword">of</span>=/gv2/<span class="class"><span class="keyword">data</span>/40M.file</span></span><br><span class="line"><span class="number">40000</span>+<span class="number">0</span> records <span class="keyword">in</span></span><br><span class="line"><span class="number">40000</span>+<span class="number">0</span> records out</span><br><span class="line"><span class="number">40960000</span> bytes (<span class="number">41</span> <span class="type">MB</span>) copied, <span class="number">7.53898</span> s, <span class="number">5.4</span> <span class="type">MB</span>/s</span><br><span class="line">[root@mystorage1 ~]# ll /gv2/<span class="class"><span class="keyword">data</span>/40M.file </span></span><br><span class="line">-rw-r<span class="comment">--r-- 1 root root 40960000 Jul 30 08:09 /gv2/data/40M.file</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 40 MB的文件竟然可以？下面继续写入一个大一些的文件</span></span><br><span class="line">[root@mystorage1 ~]# dd <span class="keyword">if</span>=/dev/zero bs=<span class="number">1024</span> count=<span class="number">80000</span> <span class="keyword">of</span>=/gv2/<span class="class"><span class="keyword">data</span>/80M.file</span></span><br><span class="line"><span class="title">dd</span>: opening `/gv2/<span class="class"><span class="keyword">data</span>/80M.file': <span class="type">Disk</span> quota exceeded</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 这次提示超过了 quota 不能写入，说明 quota 限制的目录大小并不是那么精确。</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># quota 信息列表</span></span><br><span class="line"><span class="title">gluster</span> volume quota gv2 list</span><br><span class="line"></span><br><span class="line">[root@mystorage1 ~]# gluster volume quota gv2 list</span><br><span class="line">                  <span class="type">Path</span>                   <span class="type">Hard</span>-limit  <span class="type">Soft</span>-limit      <span class="type">Used</span>  <span class="type">Available</span>  <span class="type">Soft</span>-limit exceeded? <span class="type">Hard</span>-limit exceeded?</span><br><span class="line"><span class="comment">-------------------------------------------------------------------------------------------------------------------------------</span></span><br><span class="line">/<span class="class"><span class="keyword">data</span>                                     30.0MB     80%(24.0MB)   0Bytes  30.0MB              <span class="type">No</span>                   <span class="type">No</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 限制目录的 quota 信息</span></span><br><span class="line"><span class="title">gluster</span> volume quota gv2 list /<span class="class"><span class="keyword">data</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 设置信息的超时时间</span></span><br><span class="line"><span class="title">gluster</span> volume set gv2 features.quota-timeout <span class="number">5</span> </span><br><span class="line"></span><br><span class="line"><span class="meta"># 删除某个目录的 quota 设置</span></span><br><span class="line"><span class="title">gluster</span> volume quota gv2 remove /<span class="class"><span class="keyword">data</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 备注：quota 功能，主要是对挂载点下的某个目录进行空间限额，而不是对组成卷组的空间进行限制。</span></span><br></pre></td></tr></table></figure></p>
<h1 id="4-生产环境常见故障处理"><a href="#4-生产环境常见故障处理" class="headerlink" title="4. 生产环境常见故障处理"></a>4. 生产环境常见故障处理</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">一般硬盘也要备用几块，因为随着发展，可能这些型号的硬盘不好买到了，一般的事故不会在开始一两年出，</span><br><span class="line">在硬件老化的时候出故障的频率高。</span><br></pre></td></tr></table></figure>
<h2 id="4-1-硬盘故障"><a href="#4-1-硬盘故障" class="headerlink" title="4.1 硬盘故障"></a>4.1 硬盘故障</h2><p>如果底层做了 RAID 配置，有硬件故障，直接更换硬盘，会自动同步数据。<br>如果没有做 RAID，处理方法如下：</p>
<p>正常节点上执行 gluster volume status，记录故障节点 uuid<br>执行：<code>getfattr -d -m &#39;.*&#39;  /brick</code> 记录 trusted.gluster.volume-id 及 trusted.gfid</p>
<p>以下为故障模拟及修复过程：</p>
<p>在 VMware Workstation 上移除 mystorage1 主机的第三块硬盘（对应 sdc /storage/brick2），相当于硬盘故障<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 系统提示如下：</span></span><br><span class="line">Message <span class="keyword">from</span> syslogd@linux-node01 at Jul 30 08:41:46 <span class="built_in">..</span>.</span><br><span class="line"> storage-brick2[5893]: [2016-07-30 00:41:46.729896] M [MSGID: 113075] [posix-helpers.c:1844:posix_health_check_thread_proc] 0-gv2-posix: health-check failed, going down</span><br><span class="line"></span><br><span class="line">Message <span class="keyword">from</span> syslogd@linux-node01 at Jul 30 08:42:16 <span class="built_in">..</span>.</span><br><span class="line"> storage-brick2[5893]: [2016-07-30 00:42:16.730518] M [MSGID: 113075] [posix-helpers.c:1850:posix_health_check_thread_proc] 0-gv2-posix: still alive! -&gt; SIGTERM</span><br><span class="line"></span><br><span class="line"> # 查看卷状态，mystorage1:/storage/brick2 不在线了，不过这是分布式复制卷，还可以访问另外 brick 上的数据</span><br><span class="line">[root@mystorage1 ~]# gluster volume status gv2 </span><br><span class="line">Status of volume: gv2</span><br><span class="line">Gluster process                             TCP<span class="built_in"> Port </span> RDMA<span class="built_in"> Port </span> Online  Pid</span><br><span class="line">------------------------------------------------------------------------------</span><br><span class="line">Brick mystorage1:/storage/brick2            N/A       N/A        N       N/A</span><br></pre></td></tr></table></figure></p>
<p>在 VMware Workstation 上新增 mystorage1 一块硬盘，相当于更换了新硬盘，下面先格式挂载新硬盘：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mkfs.xfs -f <span class="regexp">/dev/</span>sdc</span><br><span class="line">mkdir -p <span class="regexp">/storage/</span>brick2</span><br><span class="line">mount -a</span><br><span class="line">df -h</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新硬盘挂载后目录为空</span></span><br><span class="line">[root@mystorage1 ~]<span class="comment"># ll /storage/brick2</span></span><br><span class="line">total <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>开始手动配置新增硬盘的 gluster 参数<br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 mystorage2 是获取 glusterfs 相关参数：</span></span><br><span class="line">[root@mystorage2 tmp]<span class="comment"># getfattr -d -m '.*'  /storage/brick2</span></span><br><span class="line">getfattr: Removing leading '/' from absolute path names</span><br><span class="line"><span class="comment"># file: storage/brick2</span></span><br><span class="line">trusted.gfid=0sAAAAAAAAAAAAAAAAAAAAAQ==</span><br><span class="line">trusted.glusterfs.dht=0sAAAAAQAAAAAAAAAAf/<span class="string">///g==</span></span><br><span class="line">trusted.glusterfs.dht.commithash=<span class="string">"3168624641"</span></span><br><span class="line">trusted.glusterfs.quota.dirty=0sMAA=</span><br><span class="line">trusted.glusterfs.quota.size.1=0sAAAAAATiAAAAAAAAAAAAAwAAAAAAAAAE</span><br><span class="line">trusted.glusterfs.volume-id=0sEZKGliY6THqhVVEVrykiHw==</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 mystorage1 上执行配置 glusterfs 参数和上述一样</span></span><br><span class="line"></span><br><span class="line">setfattr -n trusted.gfid -v 0sAAAAAAAAAAAAAAAAAAAAAQ== <span class="string">/storage/brick2</span></span><br><span class="line">setfattr -n trusted.glusterfs.dht -v 0sAAAAAQAAAAAAAAAAf/<span class="string">///g==</span> <span class="string">/storage/brick2</span></span><br><span class="line">setfattr -n trusted.glusterfs.dht.commithash -v <span class="string">"3168624641"</span> <span class="string">/storage/brick2</span></span><br><span class="line">setfattr -n trusted.glusterfs.quota.dirty -v 0sMAA= <span class="string">/storage/brick2</span></span><br><span class="line">setfattr -n trusted.glusterfs.quota.size.1 -v 0sAAAAAATiAAAAAAAAAAAAAwAAAAAAAAAE <span class="string">/storage/brick2</span></span><br><span class="line">setfattr -n trusted.glusterfs.volume-id -v 0sEZKGliY6THqhVVEVrykiHw== <span class="string">/storage/brick2</span></span><br><span class="line"></span><br><span class="line">[root@mystorage1 ~]<span class="comment"># /etc/init.d/glusterd restart</span></span><br><span class="line">Starting glusterd:                                         [  OK  ]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@mystorage1 ~]<span class="comment"># gluster volume heal gv2 info</span></span><br><span class="line">Brick mystorage1:<span class="string">/storage/brick2</span></span><br><span class="line">Status: Connected</span><br><span class="line">Number of entries: 0</span><br><span class="line"></span><br><span class="line">Brick mystorage2:<span class="string">/storage/brick2</span></span><br><span class="line"><span class="string">/data</span> </span><br><span class="line">Status: Connected</span><br><span class="line">Number of entries: 1        <span class="comment"># 显示一个条目在修复，自动修复完成后会为 0</span></span><br><span class="line"></span><br><span class="line">Brick mystorage3:<span class="string">/storage/brick1</span></span><br><span class="line">Status: Connected</span><br><span class="line">Number of entries: 0</span><br><span class="line"></span><br><span class="line">Brick mystorage4:<span class="string">/storage/brick1</span></span><br><span class="line">Status: Connected</span><br><span class="line">Number of entries: 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自动修复同步完成后，查看新硬盘的数据同步过来了</span></span><br><span class="line">[root@mystorage1 ~]<span class="comment"># ll /storage/brick2</span></span><br><span class="line">total 40012</span><br><span class="line">-rw-r<span class="params">--r--</span> 2 root root 20480000 Jul 30 02<span class="function">:41</span> 20M.file</span><br><span class="line">-rw-r<span class="params">--r--</span> 2 root root 20480000 Jul 30 03<span class="function">:13</span> 20M.file1</span><br><span class="line">drwxr-xr-x 2 root root       21 Jul 30 09<span class="function">:14</span> data</span><br></pre></td></tr></table></figure></p>
<h2 id="4-2-一台主机故障"><a href="#4-2-一台主机故障" class="headerlink" title="4.2 一台主机故障"></a>4.2 一台主机故障</h2><p>一台节点故障的情况包含以下情况：</p>
<ul>
<li>物理故障</li>
<li>同时有多块硬盘故障，造成数据丢失</li>
<li>系统损坏不可修复<br>解决方法：</li>
</ul>
<p>找一台完全一样的机器，至少要保证硬盘数量和大小一致，安装系统，配置和故障机同样的 IP，安装 gluster 软件，<br>保证配置一样，在其他健康节点上执行命令 gluster peer status，查看故障服务器的 uuid<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@mystorage2 ~]# gluster<span class="built_in"> peer </span>status</span><br><span class="line">Number of Peers: 3</span><br><span class="line"></span><br><span class="line">Hostname: mystorage3</span><br><span class="line">Uuid: 36e4c45c-466f-47b0-b829-dcd4a69ca2e7</span><br><span class="line">State:<span class="built_in"> Peer </span><span class="keyword">in</span> Cluster (Connected)</span><br><span class="line"></span><br><span class="line">Hostname: mystorage4</span><br><span class="line">Uuid: c607f6c2-bdcb-4768-bc82-4bc2243b1b7a</span><br><span class="line">State:<span class="built_in"> Peer </span><span class="keyword">in</span> Cluster (Connected)</span><br><span class="line"></span><br><span class="line">Hostname: mystorage1</span><br><span class="line">Uuid: 6e6a84af-ac7a-44eb-85c9-50f1f46acef1</span><br><span class="line">State:<span class="built_in"> Peer </span><span class="keyword">in</span> Cluster (Disconnected)</span><br></pre></td></tr></table></figure></p>
<p>修改新加机器的 /var/lib/glusterd/glusterd.info 和 故障机器一样</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[root@mystorage1 ~]</span><span class="comment"># cat /var/lib/glusterd/glusterd.info</span></span><br><span class="line"><span class="attr">UUID</span>=<span class="number">6</span>e6a84af-ac7a-<span class="number">44</span>eb-<span class="number">85</span>c9-<span class="number">50</span>f1f46acef1</span><br><span class="line"><span class="attr">operating-version</span>=<span class="number">30712</span></span><br></pre></td></tr></table></figure>
<p>在信任存储池中任意节点执行<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gluster <span class="keyword">volume</span><span class="bash"> heal gv2 full</span></span><br></pre></td></tr></table></figure></p>
<p>就会自动开始同步，但在同步的时候会影响整个系统的性能。</p>
<p>可以查看状态<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gluster <span class="keyword">volume</span><span class="bash"> heal gv2 info</span></span><br></pre></td></tr></table></figure></p>
<p>转载自：<a href="https://jaminzhang.github.io/glusterfs/GlusterFS-01-Theory-Basis/" target="_blank" rel="noopener">https://jaminzhang.github.io/glusterfs/GlusterFS-01-Theory-Basis/</a></p>


                <hr>

                

                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/mogilefs/" data-toggle="tooltip" data-placement="top" title="MogileFS 分布式存储">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/lvm2/" data-toggle="tooltip" data-placement="top" title="LVM逻辑卷管理配置">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                

                

            </div>
    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->

            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#分布式" title="分布式">分布式</a>
                        
                          <a class="tag" href="/tags/#glusterfs" title="glusterfs">glusterfs</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="https://jaminzhang.github.io" target="_blank">JAMIN ZHANG</a></li>
                    
                        <li><a href="#" target="_blank">It helps SEO</a></li>
                    
                </ul>
                
            </div>

        </div>
    </div>
</article>







<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                

                

                

                
                    <li>
                        <a target="_blank"  href="https://github.com/sundayle">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; SundayLE 2020 
                    <br>
                    Theme by <a href="http://huangxuan.me">Hux</a> 
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span>
                    Ported by <a href="https://github.com/Kaijun/hexo-theme-huxblog">Kaijun</a>
            <!-- 
                    Ported by <a href="http://blog.kaijun.rocks">Kaijun</a> | 
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=kaijun&repo=hexo-theme-huxblog&type=star&count=true" >
                    </iframe>
            -->
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
     async("https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->


<script>
    // dynamic User by Hux
    var _gaId = 'UA-70699634-1';
    var _gaDomain = 'auto';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>




<!-- Baidu Tongji -->


<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog (selector) {
        var P = $('div.post-container'),a,n,t,l,i,c;
        a = P.find('h1,h2,h3,h4,h5,h6');
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#"+$(this).prop('id');
            t = $(this).text();
            c = $('<a href="'+i+'" rel="nofollow">'+t+'</a>');
            l = $('<li class="'+n+'_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;    
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function(e){
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>





<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
