<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Linux运维笔记">
    <meta name="keyword"  content="sunday,sundayhk,sundayle,sunday博客,Linxu,运维">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
          Kubernetes 1.14.2 二进制安装 - Sunday博客 | Sunday Blog
        
    </title>

    <link rel="canonical" href="http://www.sundayle.com/kubernetes-1-14-2-binary-installation/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Sunday</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/archives/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    
<!-- Image to hack wechat -->
<!-- <img src="http://www.sundayle.com/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="{{ site.baseurl }}/{% if page.header-img %}{{ page.header-img }}{% else %}{{ site.header-img }}{% endif %}" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        background-image: url('/img/home-bg.jpg')
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                    </div>
                    <h1>Kubernetes 1.14.2 二进制安装</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        Posted by Sunday on
                        2019-08-15
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <h1 id="配置策略"><a href="#配置策略" class="headerlink" title="配置策略"></a>配置策略</h1><blockquote>
<p>kube-apiserver</p>
</blockquote>
<ul>
<li>使用haproxy+keepalived实现高可用；</li>
<li>关闭非安全端口 8080 和匿名访问；</li>
<li>在安全端口 6443 接收 https 请求；</li>
<li>严格的认证和授权策略 (x509、token、RBAC)；</li>
<li>开启 bootstrap token 认证，支持 kubelet TLS bootstrapping；</li>
<li>使用 https 访问 kubelet、etcd，加密通信；</li>
</ul>
<blockquote>
<p>kube-controller-manager</p>
</blockquote>
<ul>
<li>3 节点高可用；</li>
<li>关闭非安全端口，在安全端口 10252 接收 https 请求；</li>
<li>使用 kubeconfig 访问 apiserver 的安全端口；</li>
<li>自动 approve kubelet 证书签名请求 (CSR)，证书过期后自动轮转；</li>
<li>各 controller 使用自己的 ServiceAccount 访问 apiserver；</li>
</ul>
<blockquote>
<p>kube-scheduler</p>
</blockquote>
<ul>
<li>3 节点高可用；</li>
<li>使用 kubeconfig 访问 apiserver 的安全端口；</li>
</ul>
<blockquote>
<p>kubelet</p>
</blockquote>
<ul>
<li>使用 kubeadm 动态创建 bootstrap token，而不是在 apiserver 中静态配置；</li>
<li>使用 TLS bootstrap 机制自动生成 client 和 server 证书，过期后自动轮转；</li>
<li>在 KubeletConfiguration 类型的 JSON 文件配置主要参数；</li>
<li>关闭只读端口，在安全端口 10250 接收 https 请求，对请求进行认证和授权，拒绝匿名访问和非授权访问；</li>
<li>使用 kubeconfig 访问 apiserver 的安全端口；</li>
</ul>
<blockquote>
<p>kube-proxy</p>
</blockquote>
<ul>
<li>使用 kubeconfig 访问 apiserver 的安全端口；</li>
<li>在 KubeProxyConfiguration 类型的 JSON 文件配置主要参数；</li>
<li>使用 ipvs 代理模式；</li>
</ul>
<blockquote>
<p>插件</p>
</blockquote>
<ul>
<li>DNS：使用功能、性能更好的 coredns；</li>
<li>Dashboard：支持登录认证；</li>
<li>Metric：metrics-server，使用 https 访问 kubelet 安全端口；</li>
<li>Log：Elasticsearch、Fluend、Kibana；</li>
<li>Registry 镜像库：docker-registry、harbor；</li>
</ul>
<h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><blockquote>
<p>OS: Centos7.5<br>Kubernetes: 1.14.2<br>Docker: 18.09<br>Flanneld: 0.11.0<br>Etcd: 3.3.13 </p>
</blockquote>
<table>
<thead>
<tr>
<th>主机名</th>
<th>IP / VIP</th>
<th>组件</th>
</tr>
</thead>
<tbody>
<tr>
<td>k8s-master</td>
<td>192.168.10.81 / 192.168.10.80</td>
<td>haproxy、keepalived、etcd、kube-apiserver、kube-controllet-manager、kube-scheduler、node</td>
</tr>
<tr>
<td>k8s-master</td>
<td>192.168.10.82 / 192.168.10.80</td>
<td>haproxy、keepalived、etcd、kube-apiserver、kube-controllet-manager、kube-scheduler、node</td>
</tr>
<tr>
<td>k8s-master</td>
<td>192.168.10.83 / 192.168.10.80</td>
<td>haproxy、keepalived、etcd、kube-apiserver、kube-controllet-manager、kube-scheduler、node</td>
</tr>
<tr>
<td>k8s-node01</td>
<td>192.168.10.84</td>
<td>kubelet、kube-proxy、docker、flanneld、core-dns</td>
</tr>
<tr>
<td>k8s-node02</td>
<td>192.168.10.85</td>
<td>kubelet、kube-proxy、docker、flanneld、core-dns</td>
</tr>
</tbody>
</table>
<p>1、集群证书制作、配置文件等都是在k8s-master01主机上操作<br>2、k8s-master01主机对所有主机配置免密钥登陆，方便证书及配置文件发送至各主机<br>3、创建以下目录<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta-keyword">/etc/</span>kubernetes/ssl      <span class="meta">#集群使用证书目录</span></span><br><span class="line"><span class="meta-keyword">/etc/</span>kubernetes/config   <span class="meta">#集群各组件加载配置文件存放路径</span></span><br><span class="line"><span class="meta-keyword">/opt/</span>k8s<span class="meta-keyword">/ssl/</span>            <span class="meta">#集群证书制作目录</span></span><br><span class="line"><span class="meta-keyword">/opt/</span>k8s<span class="meta-keyword">/cfg/</span>            <span class="meta">#集群组件配置文件制作目录</span></span><br><span class="line"><span class="meta-keyword">/opt/</span>k8s<span class="meta-keyword">/init/</span>           <span class="meta">#集群组件启动脚本制作目录</span></span><br><span class="line"><span class="meta-keyword">/opt/</span>k8s<span class="meta-keyword">/pkg/</span>            <span class="meta">#下载二进制包</span></span><br></pre></td></tr></table></figure></p>
<p>host解析<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt;<span class="literal">EOF</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.10</span><span class="number">.81</span>  k8s-master01</span><br><span class="line"><span class="number">192.168</span><span class="number">.10</span><span class="number">.82</span>  k8s-master02</span><br><span class="line"><span class="number">192.168</span><span class="number">.10</span><span class="number">.83</span>  k8s-master03</span><br><span class="line"><span class="number">192.168</span><span class="number">.10</span><span class="number">.84</span>  k8s-node01</span><br><span class="line"><span class="number">192.168</span><span class="number">.10</span><span class="number">.85</span>  k8s-node02</span><br><span class="line"><span class="literal">EOF</span></span><br></pre></td></tr></table></figure></p>
<p>配置免密钥登陆<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">yum install -y expect</span><br><span class="line">ssh-keygen -t rsa -P <span class="string">""</span> -f /root/.ssh/id_rsa</span><br><span class="line">export mypass=<span class="number">123456</span></span><br><span class="line">name=(k8s-master1 k8s-master2 k8s-master3 k8s-node1 k8s-node2)</span><br><span class="line"></span><br><span class="line">for i in $&#123;name[@]&#125;;do</span><br><span class="line">expect -c <span class="string">"</span></span><br><span class="line"><span class="string">spawn ssh-copy-id -i /root/.ssh/id_rsa.pub root@$i</span></span><br><span class="line"><span class="string">        expect &#123;</span></span><br><span class="line"><span class="string">                <span class="subst">\"</span>*yes/no*<span class="subst">\"</span> &#123;send <span class="subst">\"</span>yes\r<span class="subst">\"</span>; exp_continue&#125;</span></span><br><span class="line"><span class="string">                <span class="subst">\"</span>*password*<span class="subst">\"</span> &#123;send <span class="subst">\"</span>$mypass\r<span class="subst">\"</span>; exp_continue&#125;</span></span><br><span class="line"><span class="string">                <span class="subst">\"</span>*Password*<span class="subst">\"</span> &#123;send <span class="subst">\"</span>$mypass\r<span class="subst">\"</span>;&#125;</span></span><br><span class="line"><span class="string">        &#125;"</span></span><br><span class="line">done</span><br></pre></td></tr></table></figure></p>
<p>配置主机名<br><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">name=</span>(<span class="string">k8s-master01 </span><span class="string">k8s-master02 </span><span class="string">k8s-master03 </span><span class="string">k8s-node01 </span><span class="string">k8s-node02)</span></span><br><span class="line"><span class="string">for </span>i <span class="string">in </span>$&#123;<span class="string">name[</span>@]&#125;;<span class="string">do </span><span class="string">ssh </span><span class="string">root@</span>$i  <span class="string">hostnamectl </span><span class="built_in">set-hostname</span> $i;<span class="string">done</span></span><br></pre></td></tr></table></figure></p>
<p>关闭防火墙 selinux swap<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line">iptables -F &amp;&amp; iptables -X &amp;&amp; iptables -F -t nat &amp;&amp; iptables -X -t nat</span><br><span class="line">iptables -P FORWARD ACCEPT</span><br><span class="line">swapoff -a</span><br><span class="line">sed -<span class="selector-tag">i</span> <span class="string">'/ swap / s/^\(.*\)$/#\1/g'</span> /etc/fstab</span><br><span class="line">setenforce <span class="number">0</span></span><br><span class="line">sed -<span class="selector-tag">i</span> <span class="string">'s/^SELINUX=.*/SELINUX=disabled/'</span> /etc/selinux/config</span><br></pre></td></tr></table></figure></p>
<p>安装依赖<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y ntpdate<span class="built_in"> ntp </span>jq iptables curl sysstat libseccomp wget</span><br></pre></td></tr></table></figure></p>
<p>时间同步<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo <span class="string">"*/30 * * * * ntpdate time7.aliyun.com &gt;/dev/null 2&gt;&amp;1"</span> &gt;&gt; <span class="regexp">/var/</span>spool<span class="regexp">/cron/</span>root</span><br></pre></td></tr></table></figure></p>
<p>升级内核<br><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#Docker overlay2需要使用kernel <span class="number">4.</span>x版本</span><br><span class="line">rpm -Uvh http:<span class="comment">//www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm</span></span><br><span class="line">yum --enablerepo=elrepo-kernel install -y kernel-<span class="keyword">lt</span></span><br><span class="line">grub2-<span class="keyword">set</span>-default  <span class="comment">0</span>  </span><br><span class="line">grub2-mkconfig <span class="comment">-o</span> /etc/<span class="comment">grub2.cfg</span></span><br><span class="line">grubby <span class="comment">--default-kernel</span></span><br><span class="line">reboot</span><br></pre></td></tr></table></figure></p>
<p>优化内核参数<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/etc/sysctl.d/kubernetes.conf &lt;&lt;EOF</span><br><span class="line">net.bridge.<span class="attribute">bridge-nf-call-iptables</span>=1</span><br><span class="line">net.bridge.<span class="attribute">bridge-nf-call-ip6tables</span>=1</span><br><span class="line">net.ipv4.<span class="attribute">ip_forward</span>=1</span><br><span class="line">net.ipv4.<span class="attribute">tcp_tw_recycle</span>=0</span><br><span class="line">vm.<span class="attribute">swappiness</span>=0 # 禁止使用 swap 空间，只有当系统 OOM 时才允许使用它</span><br><span class="line">vm.<span class="attribute">overcommit_memory</span>=1 # 不检查物理内存是否够用</span><br><span class="line">vm.<span class="attribute">panic_on_oom</span>=0 # 开启 OOM</span><br><span class="line">fs.inotify.<span class="attribute">max_user_instances</span>=8192</span><br><span class="line">fs.inotify.<span class="attribute">max_user_watches</span>=1048576</span><br><span class="line">fs.<span class="attribute">file-max</span>=52706963</span><br><span class="line">fs.<span class="attribute">nr_open</span>=52706963</span><br><span class="line">net.ipv6.conf.all.<span class="attribute">disable_ipv6</span>=1</span><br><span class="line">net.netfilter.<span class="attribute">nf_conntrack_max</span>=2310720</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure></p>
<p>加载模块<br><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">yum install -y conntrack ipvsadm ipset </span><br><span class="line">cat &gt;/etc/modules-<span class="keyword">load</span>.d/ipvs.conf &lt;&lt; <span class="built_in">EOF</span></span><br><span class="line">ip_vs</span><br><span class="line">ip_vs_rr</span><br><span class="line">ip_vs_wrr</span><br><span class="line">ip_vs_sh</span><br><span class="line">nf_conntrack</span><br><span class="line"><span class="built_in">EOF</span></span><br><span class="line"></span><br><span class="line">modprobe ip_vs_rr nf_conntrack</span><br><span class="line">lsmod | egrep <span class="string">"ip_vs_rr|nf_conntrack"</span></span><br></pre></td></tr></table></figure></p>
<p>创建集群目录<br><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p <span class="regexp">/opt/k8s/</span>&#123;ssl,cfg,init&#125; <span class="comment">#k8s-master01配置</span></span><br><span class="line">mkdir -p <span class="regexp">/etc/kubernetes/</span>&#123;ssl,config&#125; <span class="comment">#每台配置</span></span><br></pre></td></tr></table></figure></p>
<p>环境变量<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/k8s/environment.sh &lt;&lt;<span class="string">"EOF"</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 生成 EncryptionConfig 所需的加密 key</span></span><br><span class="line">ENCRYPTION_KEY=<span class="variable">$(head -c 32 /dev/urandom | base64)</span></span><br><span class="line"><span class="comment"># 集群NODE机器IP、NAME数组</span></span><br><span class="line">NODE_IPS=(192.168.10.81 192.168.10.82 192.168.10.83 192.168.10.84 192.168.10.85)</span><br><span class="line">NODE_NAMES=(k8s-master01 k8s-master02 k8s-master03 k8s-node01 k8s-node02)</span><br><span class="line"><span class="comment"># 集群MASTER机器IP、NAME数组</span></span><br><span class="line">MASTER_IPS=(192.168.10.81 192.168.10.82 192.168.10.83)</span><br><span class="line">MASTER_NAMES=(k8s-master01 k8s-master02 k8s-master03)</span><br><span class="line"></span><br><span class="line"><span class="comment"># etcd 集群所有ETCD IP、NAME数组</span></span><br><span class="line">ETCD_IPS=(192.168.10.81 192.168.10.82 192.168.10.83)</span><br><span class="line">ETCD_NAMES=(etcd01 etcd02 etcd03)</span><br><span class="line"><span class="comment"># etcd 集群间通信的IP和端口</span></span><br><span class="line">ETCD_NODES=<span class="string">"etcd01=https://192.168.10.81:2380,etcd02=https://192.168.10.82:2380,etcd03=https://192.168.10.83:2380"</span></span><br><span class="line"><span class="comment"># etcd 集群服务地址列表</span></span><br><span class="line">ETCD_ENDPOINTS=<span class="string">"https://192.168.10.81:2379,https://192.168.10.82:2379,https://192.168.10.83:2379"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kube-apiserver 高可用VIP</span></span><br><span class="line">KUBE_APISERVER=<span class="string">"https://192.168.10.80:8443"</span></span><br><span class="line"><span class="comment"># 节点间互联网络接口名称</span></span><br><span class="line">IFACE=<span class="string">"eth0"</span></span><br><span class="line"><span class="comment"># etcd 数据目录</span></span><br><span class="line">ETCD_DATA_DIR=<span class="string">"/data/etcd/data"</span></span><br><span class="line"><span class="comment"># etcd WAL 目录，建议是 SSD 磁盘分区，或者和 ETCD_DATA_DIR 不同的磁盘分区</span></span><br><span class="line">ETCD_WAL_DIR=<span class="string">"/data/etcd/wal"</span></span><br><span class="line"><span class="comment"># k8s 各组件数据目录</span></span><br><span class="line">K8S_DIR=<span class="string">"/data/k8s"</span></span><br><span class="line"><span class="comment"># docker 数据目录</span></span><br><span class="line"><span class="comment">#DOCKER_DIR="/data/docker"</span></span><br><span class="line"><span class="comment">## 以下参数一般不需要修改</span></span><br><span class="line"><span class="comment"># TLS Bootstrapping 使用的 Token，可以使用命令 head -c 16 /dev/urandom | od -An -t x | tr -d ' ' 生成</span></span><br><span class="line"><span class="comment">#BOOTSTRAP_TOKEN="63fbf8e1f48805fb6ee221c03884c202"</span></span><br><span class="line"><span class="comment"># 服务网段</span></span><br><span class="line">SERVICE_CIDR=<span class="string">"10.247.0.0/16"</span></span><br><span class="line"><span class="comment"># pod 网段</span></span><br><span class="line">CLUSTER_CIDR=<span class="string">"172.30.0.0/16"</span></span><br><span class="line"><span class="comment"># 服务端口范围(Node Range)</span></span><br><span class="line">NODE_PORT_RANGE=<span class="string">"1024-32767"</span></span><br><span class="line"><span class="comment"># flanneld 网络配置前缀</span></span><br><span class="line">FLANNEL_ETCD_PREFIX=<span class="string">"/kubernetes/network"</span></span><br><span class="line"><span class="comment"># kubernetes 服务 IP (一般是 SERVICE_CIDR 中第一个IP)</span></span><br><span class="line">CLUSTER_KUBERNETES_SVC_IP=<span class="string">"10.247.0.1"</span></span><br><span class="line"><span class="comment"># 集群 DNS 服务 IP (从 SERVICE_CIDR 中预分配)</span></span><br><span class="line">CLUSTER_DNS_SVC_IP=<span class="string">"10.247.0.2"</span></span><br><span class="line"><span class="comment"># 集群 DNS 域名（末尾不带点号）</span></span><br><span class="line">CLUSTER_DNS_DOMAIN=<span class="string">"cluster.local"</span></span><br><span class="line"><span class="comment"># 将二进制目录加到 PATH 中</span></span><br><span class="line"><span class="keyword">export</span> PATH=/usr/local/k8s/bin:$PATH</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<h1 id="部署cfssl"><a href="#部署cfssl" class="headerlink" title="部署cfssl"></a>部署cfssl</h1><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl https:<span class="regexp">//</span>pkg.cfssl.org<span class="regexp">/R1.2/</span>cfssl_linux-amd64 -o <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>cfssl</span><br><span class="line">curl https:<span class="regexp">//</span>pkg.cfssl.org<span class="regexp">/R1.2/</span>cfssljson_linux-amd64 -o <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>cfssljson</span><br><span class="line">curl https:<span class="regexp">//</span>pkg.cfssl.org<span class="regexp">/R1.2/</span>cfssl-certinfo_linux-amd64 -o <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>cfssl-certinfo</span><br><span class="line">chmod +x <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>cfssl*</span><br></pre></td></tr></table></figure>
<h1 id="配置CA"><a href="#配置CA" class="headerlink" title="配置CA"></a>配置CA</h1><blockquote>
<p>只需创建一个CA证书，后续创建的所有证书(kubernetes+etcd)都是由它签名</p>
</blockquote>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> /opt/k8s/ssl/ </span><br><span class="line"><span class="keyword">cat</span> &gt; <span class="keyword">ca</span>-config.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"signing"</span>: &#123;</span><br><span class="line">    <span class="string">"default"</span>: &#123;</span><br><span class="line">      <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"profiles"</span>: &#123;</span><br><span class="line">      <span class="string">"kubernetes"</span>: &#123;</span><br><span class="line">        <span class="string">"usages"</span>: [</span><br><span class="line">            <span class="string">"signing"</span>,</span><br><span class="line">            <span class="string">"key encipherment"</span>,</span><br><span class="line">            <span class="string">"server auth"</span>,</span><br><span class="line">            <span class="string">"client auth"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">#创建证书签名请求文件</span><br><span class="line"><span class="keyword">cat</span> &gt; <span class="keyword">ca</span>-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"GuangZhou"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"GuangZhou"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"ca"</span>: &#123;</span><br><span class="line">    <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">#生成<span class="keyword">CA</span>证书和私钥</span><br><span class="line">cfssl gencert -initca <span class="keyword">ca</span>-csr.json | cfssljson -bare <span class="keyword">ca</span></span><br><span class="line"></span><br><span class="line">#分发证书</span><br><span class="line"></span><br><span class="line">source /opt/k8s/environment.<span class="keyword">sh</span></span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;MASTER_IPS</span>[@]&#125;;<span class="keyword">do</span></span><br><span class="line">    echo <span class="string">"&gt;&gt;&gt; $&#123;node_ip&#125;"</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"mkdir -p /etc/kubernetes/ssl"</span></span><br><span class="line">    scp <span class="keyword">ca</span>*.pem <span class="keyword">ca</span>-csr.json <span class="keyword">ca</span>-key.pem root@<span class="variable">$&#123;node_ip&#125;</span>:/etc/kubernetes/ssl</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h1 id="部署etcd集群"><a href="#部署etcd集群" class="headerlink" title="部署etcd集群"></a>部署etcd集群</h1><p>etcd 是k8s集群最重要的组件，用来存储k8s的所有服务信息， etcd 挂了，集群就挂了，我们这里把etcd部署在master三台节点上做高可用，etcd集群采用raft算法选举Leader， 由于Raft算法在做决策时需要多数节点的投票，所以etcd一般部署集群推荐奇数个节点，推荐的数量为3、5或者7个节点构成一个集群</p>
<p>创建etcd证书和私钥<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/ssl</span><br><span class="line">cat &gt; etcd-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"etcd"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [</span><br><span class="line">    <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="string">"192.168.10.81"</span>,</span><br><span class="line">    <span class="string">"192.168.10.82"</span>,</span><br><span class="line">    <span class="string">"192.168.10.83"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: <span class="number">2048</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"GuangZhou"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"GuangZhou"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#生成证书和私钥</span></span><br><span class="line">cfssl gencert -ca=<span class="regexp">/opt/k</span>8s/ssl/ca.pem \</span><br><span class="line">    -ca-key=<span class="regexp">/opt/k</span>8s/ssl/ca-key.pem \</span><br><span class="line">    -config=<span class="regexp">/opt/k</span>8s/ssl/ca-config.json \</span><br><span class="line">    -profile=kubernetes etcd-csr.json | cfssljson -bare etcd</span><br><span class="line"></span><br><span class="line"><span class="comment">#分发证书和私钥</span></span><br><span class="line">source /opt/k8s/environment.sh</span><br><span class="line">cd /opt/k8s/ssl</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;</span>ETCD_IPS[@]&#125;;<span class="keyword">do</span></span><br><span class="line">    echo <span class="string">"&gt;&gt;&gt; $&#123;node_ip&#125;"</span></span><br><span class="line">    ssh root@<span class="variable">$node_ip</span> <span class="string">"mkdir -p /etc/etcd/ssl"</span></span><br><span class="line">    scp etcd*pem ca.pem root@<span class="variable">$&#123;</span>node_ip&#125;<span class="symbol">:/etc/etcd/ssl/</span></span><br><span class="line">done</span><br></pre></td></tr></table></figure></p>
<p><a href="https://github.com/coreos/etcd/releases" target="_blank" rel="noopener">https://github.com/coreos/etcd/releases</a><br>下载和分发etcd二进制文件<br> <figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/pkg/</span><br><span class="line">wget <span class="symbol">https:</span>/<span class="regexp">/github.com/etcd</span>-io/etcd/releases/download/v3.<span class="number">3.13</span>/etcd-v3.<span class="number">3.13</span>-linux-amd64.tar.gz</span><br><span class="line">tar xf etcd-v3.<span class="number">3.13</span>-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">source /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;</span>ETCD_IPS[@]&#125;;<span class="keyword">do</span></span><br><span class="line">    echo <span class="string">"&gt;&gt;&gt; $&#123;node_ip&#125;"</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;</span>node_ip&#125; <span class="string">"mkdir -p /usr/local/k8s/bin"</span></span><br><span class="line">    scp etcd-v3.<span class="number">3.13</span>-linux-amd64/etc* root@<span class="variable">$&#123;</span>node_ip&#125;<span class="symbol">:/usr/local/k8s/bin/</span></span><br><span class="line">done</span><br></pre></td></tr></table></figure></p>
<p>创建etcd的启动文件<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">source /opt/k8s/environment.sh</span><br><span class="line">cd /opt/k8s/init </span><br><span class="line">cat &gt; etcd.service.template &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line"><span class="attribute">Description</span>=Etcd Server</span><br><span class="line"><span class="attribute">After</span>=network.target</span><br><span class="line"><span class="attribute">After</span>=network-online.target</span><br><span class="line"><span class="attribute">Wants</span>=network-online.target</span><br><span class="line"><span class="attribute">Documentation</span>=https://github.com/coreos</span><br><span class="line">[Service]</span><br><span class="line"><span class="attribute">Type</span>=notify</span><br><span class="line"><span class="attribute">WorkingDirectory</span>=<span class="variable">$&#123;ETCD_DATA_DIR&#125;</span></span><br><span class="line"><span class="attribute">ExecStart</span>=/usr/local/k8s/bin/etcd \\</span><br><span class="line">  <span class="attribute">--data-dir</span>=<span class="variable">$&#123;ETCD_DATA_DIR&#125;</span> \\</span><br><span class="line">  <span class="attribute">--wal-dir</span>=<span class="variable">$&#123;ETCD_WAL_DIR&#125;</span> \\</span><br><span class="line">  <span class="attribute">--name</span>=##NODE_NAME## \\</span><br><span class="line">  <span class="attribute">--trusted-ca-file</span>=/etc/kubernetes/ssl/ca.pem \\</span><br><span class="line">  <span class="attribute">--cert-file</span>=/etc/etcd/ssl/etcd.pem \\</span><br><span class="line">  <span class="attribute">--key-file</span>=/etc/etcd/ssl/etcd-key.pem \\</span><br><span class="line">  <span class="attribute">--peer-trusted-ca-file</span>=/etc/etcd/ssl/ca.pem \\</span><br><span class="line">  <span class="attribute">--peer-cert-file</span>=/etc/etcd/ssl/etcd.pem \\</span><br><span class="line">  <span class="attribute">--peer-key-file</span>=/etc/etcd/ssl/etcd-key.pem \\</span><br><span class="line">  --peer-client-cert-auth \\</span><br><span class="line">  --client-cert-auth \\</span><br><span class="line">  <span class="attribute">--listen-peer-urls</span>=https://##NODE_IP##:2380 \\</span><br><span class="line">  <span class="attribute">--initial-advertise-peer-urls</span>=https://##NODE_IP##:2380 \\</span><br><span class="line">  <span class="attribute">--listen-client-urls</span>=https://##NODE_IP##:2379,http://127.0.0.1:2379 \\</span><br><span class="line">  <span class="attribute">--advertise-client-urls</span>=https://##NODE_IP##:2379 \\</span><br><span class="line">  <span class="attribute">--initial-cluster-token</span>=etcd-cluster-0 \\</span><br><span class="line">  <span class="attribute">--initial-cluster</span>=<span class="variable">$&#123;ETCD_NODES&#125;</span> \\</span><br><span class="line">  <span class="attribute">--initial-cluster-state</span>=new \\</span><br><span class="line">  <span class="attribute">--auto-compaction-mode</span>=periodic \\</span><br><span class="line">  <span class="attribute">--auto-compaction-retention</span>=1 \\</span><br><span class="line">  <span class="attribute">--max-request-bytes</span>=33554432 \\</span><br><span class="line">  <span class="attribute">--quota-backend-bytes</span>=6442450944 \\</span><br><span class="line">  <span class="attribute">--heartbeat-interval</span>=250 \\</span><br><span class="line">  <span class="attribute">--election-timeout</span>=2000</span><br><span class="line"><span class="attribute">Restart</span>=on-failure</span><br><span class="line"><span class="attribute">RestartSec</span>=5</span><br><span class="line"><span class="attribute">LimitNOFILE</span>=65536</span><br><span class="line">[Install]</span><br><span class="line"><span class="attribute">WantedBy</span>=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#NODE_NAMES 和 NODE_IPS 变量替换</span></span><br><span class="line">source /opt/k8s/environment.sh</span><br><span class="line">cd /opt/k8s/init</span><br><span class="line"><span class="keyword">for</span> (( <span class="attribute">i</span>=0; i &lt; 3; i++ ));<span class="keyword">do</span></span><br><span class="line">    sed -e <span class="string">"s/##NODE_NAME##/<span class="variable">$&#123;ETCD_NAMES[i]&#125;</span>/"</span> -e <span class="string">"s/##NODE_IP##/<span class="variable">$&#123;ETCD_IPS[i]&#125;</span>/"</span> etcd.service.template &gt; etcd-<span class="variable">$&#123;ETCD_IPS[i]&#125;</span>.service </span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"><span class="comment">#分发etcd service</span></span><br><span class="line">cd /opt/k8s/init </span><br><span class="line">source /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;ETCD_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    echo <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">    scp etcd-<span class="variable">$&#123;node_ip&#125;</span>.service root@<span class="variable">$&#123;node_ip&#125;</span>:/etc/systemd/system/etcd.service</span><br><span class="line">    ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"mkdir -p /data/etcd/&#123;data,wal&#125;"</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"systemctl daemon-reload &amp;&amp; systemctl enable etcd &amp;&amp; systemctl restart etcd"</span></span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"><span class="comment">#etcd首次进程启动会等待其他节点加入etcd集群，执行启动命令会卡顿一会，为正常现象</span></span><br></pre></td></tr></table></figure></p>
<p>检查启动状态<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;MASTER_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"systemctl status etcd|grep Active"</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#journalctl -fu etcd 查看报错</span></span><br></pre></td></tr></table></figure></p>
<p>验证ETCD集群状态<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">source /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;ETCD_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    echo <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">    <span class="attribute">ETCDCTL_API</span>=3 /usr/local/k8s/bin/etcdctl \</span><br><span class="line">    <span class="attribute">--endpoints</span>=https://$&#123;node_ip&#125;:2379 \</span><br><span class="line">    <span class="attribute">--cacert</span>=/etc/etcd/ssl/ca.pem \</span><br><span class="line">    <span class="attribute">--cert</span>=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">    <span class="attribute">--key</span>=/etc/etcd/ssl/etcd-key.pem endpoint health</span><br><span class="line">done</span><br></pre></td></tr></table></figure></p>
<p>查看etcd集群leader<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">source /opt/k8s/environment.sh</span><br><span class="line">ETCDCTL_API=3 /usr/local/k8s/bin/etcdctl \</span><br><span class="line">    -<span class="ruby">w table --cacert=<span class="regexp">/etc/etcd</span><span class="regexp">/ssl/ca</span>.pem \</span></span><br><span class="line"><span class="ruby">    --cert=<span class="regexp">/etc/etcd</span><span class="regexp">/ssl/etcd</span>.pem \</span></span><br><span class="line"><span class="ruby">    --key=<span class="regexp">/etc/etcd</span><span class="regexp">/ssl/etcd</span>-key.pem \</span></span><br><span class="line"><span class="ruby">    --endpoints=$&#123;ETCD_ENDPOINTS&#125; endpoint status</span></span><br></pre></td></tr></table></figure></p>
<h1 id="部署master组件"><a href="#部署master组件" class="headerlink" title="部署master组件"></a>部署master组件</h1><blockquote>
<p>master节点组件：kube-apiserver、etcd、kube-controller-manager、kube-scheduler、kubectl<br>node节点组件：kubelet、kube-proxy、docker、coredns、calico</p>
</blockquote>
<p>分发master二进制<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/pkg</span><br><span class="line">wget <span class="symbol">https:</span>/<span class="regexp">/storage.googleapis.com/kubernetes</span>-release/release/v1.<span class="number">14.2</span>/kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">tar -xf kubernetes-server-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">cd /opt/k8s/pkg</span><br><span class="line">source /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;</span>MASTER_IPS[@]&#125;;<span class="keyword">do</span></span><br><span class="line">    echo <span class="string">"&gt;&gt;&gt; $&#123;node_ip&#125;"</span></span><br><span class="line">    scp kubernetes/server/bin/&#123;kube-apiserver,kube-controller-manager,kube-scheduler,kubeadm,kubectl&#125; root@<span class="variable">$&#123;</span>node_ip&#125;<span class="symbol">:/usr/local/k8s/bin/</span></span><br><span class="line">done</span><br></pre></td></tr></table></figure></p>
<h1 id="部署kubectl"><a href="#部署kubectl" class="headerlink" title="部署kubectl"></a>部署kubectl</h1><p>创建admin证书和私钥<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/ssl</span><br><span class="line">cat &gt; admin-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"admin"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: <span class="number">2048</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"GuangZhou"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"GuangZhou"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"system:masters"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># O 为<span class="keyword">system</span>:masters，kube-apiserver收到该证书后将请求的Group设置为<span class="keyword">system</span>:masters</span><br><span class="line"># 预定的ClusterRoleBinding cluster-admin将Group <span class="keyword">system</span>:masters与Role cluster-admin绑定，该Role授予API的权限</span><br><span class="line"># 该证书只有被kubectl当做client证书使用，所以hosts字段为空</span><br></pre></td></tr></table></figure></p>
<p>生成证书和私钥<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> /<span class="keyword">opt</span>/k8s/ssl</span><br><span class="line">cfssl gencert -<span class="keyword">ca</span>=/<span class="keyword">opt</span>/k8s/ssl/<span class="keyword">ca</span>.pem \</span><br><span class="line">  -<span class="keyword">ca</span>-key=/<span class="keyword">opt</span>/k8s/ssl/<span class="keyword">ca</span>-key.pem \</span><br><span class="line">  -config=/<span class="keyword">opt</span>/k8s/ssl/<span class="keyword">ca</span>-config.json \</span><br><span class="line">  -<span class="keyword">profile</span>=kubernetes admin-csr.json | cfssljson -bare admin</span><br></pre></td></tr></table></figure></p>
<p>生成kubeconfig 配置文件<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/cfg</span><br><span class="line">source /opt/k8s/environment.sh</span><br><span class="line"><span class="comment"># 设置集群参数</span></span><br><span class="line">kubectl<span class="built_in"> config </span>set-cluster kubernetes \</span><br><span class="line">  <span class="attribute">--certificate-authority</span>=/opt/k8s/ssl/ca.pem \</span><br><span class="line">  <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line">  <span class="attribute">--server</span>=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=kubectl.config</span><br><span class="line"><span class="comment">#设置客户端认证参数</span></span><br><span class="line">kubectl<span class="built_in"> config </span>set-credentials admin \</span><br><span class="line">  <span class="attribute">--client-certificate</span>=/opt/k8s/ssl/admin.pem \</span><br><span class="line">  <span class="attribute">--client-key</span>=/opt/k8s/ssl/admin-key.pem \</span><br><span class="line">  <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=kubectl.config</span><br><span class="line"><span class="comment"># 设置上下文参数</span></span><br><span class="line">kubectl<span class="built_in"> config </span>set-context kubernetes \</span><br><span class="line">  <span class="attribute">--cluster</span>=kubernetes \</span><br><span class="line">  <span class="attribute">--user</span>=admin \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=kubectl.config</span><br><span class="line"><span class="comment"># 设置默认上下文</span></span><br><span class="line">kubectl<span class="built_in"> config </span>use-context kubernetes <span class="attribute">--kubeconfig</span>=kubectl.config</span><br><span class="line"></span><br><span class="line"><span class="comment">###</span></span><br><span class="line">--server为api-server ip</span><br><span class="line">--certificate-authority 验证kube-apiserver证书的根证书</span><br><span class="line">--client-certificate、--client-key 刚生成的admin证书和私钥，连接kube-apiserver时使用</span><br><span class="line"><span class="attribute">--embed-certs</span>=<span class="literal">true</span> 将ca.pem和admin.pem证书嵌入到生成的kubectl.config文件中 (如果不加入，写入的是证书文件路径，后续拷贝kubeconfig到其它机器时，还需要单独拷贝证书)</span><br></pre></td></tr></table></figure></p>
<p>分发kubeconfig文件<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/cfg</span><br><span class="line">source /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    echo <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"mkdir -p ~/.kube"</span></span><br><span class="line">    scp kubectl.config root@<span class="variable">$&#123;node_ip&#125;</span>:~/.kube/config</span><br><span class="line">done</span><br></pre></td></tr></table></figure></p>
<h1 id="部署kube-apiserver"><a href="#部署kube-apiserver" class="headerlink" title="部署kube-apiserver"></a>部署kube-apiserver</h1><p>创建kube-apiserver证书和私钥<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/ssl</span><br><span class="line">source /opt/k8s/environment.sh</span><br><span class="line">cat &gt; kube-apiserver-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [</span><br><span class="line">    <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="string">"192.168.10.81"</span>,</span><br><span class="line">    <span class="string">"192.168.10.82"</span>,</span><br><span class="line">    <span class="string">"192.168.10.83"</span>,</span><br><span class="line">    <span class="string">"192.168.10.80"</span>,</span><br><span class="line">    <span class="string">"$&#123;CLUSTER_KUBERNETES_SVC_IP&#125;"</span>,</span><br><span class="line">    <span class="string">"kubernetes"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default.svc"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default.svc.cluster"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default.svc.cluster.local."</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: <span class="number">2048</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"GuangZhou"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"GuangZhou"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#hosts 字段指定授权使用该证书的 IP 和域名列表，这里列出了 master 节点 IP、kubernetes 服务的 IP 和域名</span></span><br><span class="line"><span class="comment">#kubernetes 服务 IP 是 apiserver 自动创建的，一般是 --service-cluster-ip-range 参数指定的网段的第一个IP</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#生成证书和私钥</span></span><br><span class="line">cfssl gencert -ca=<span class="regexp">/opt/k</span>8s/ssl/ca.pem \</span><br><span class="line">      -ca-key=<span class="regexp">/opt/k</span>8s/ssl/ca-key.pem \</span><br><span class="line">      -config=<span class="regexp">/opt/k</span>8s/ssl/ca-config.json \</span><br><span class="line">      -profile=kubernetes kube-apiserver-csr.json | cfssljson -bare kube-apiserver</span><br><span class="line"></span><br><span class="line"><span class="comment">#分发</span></span><br><span class="line">cd /opt/k8s/ssl</span><br><span class="line">source /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;</span>MASTER_IPS[@]&#125;;<span class="keyword">do</span></span><br><span class="line">    echo <span class="string">"&gt;&gt;&gt; $&#123;node_ip&#125;"</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;</span>node_ip&#125; <span class="string">"mkdir -p /etc/kubernetes/ssl"</span></span><br><span class="line">    scp kube-apiserver*.pem root@<span class="variable">$&#123;</span>node_ip&#125;<span class="symbol">:/etc/kubernetes/ssl/</span></span><br><span class="line">done</span><br></pre></td></tr></table></figure></p>
<p>创建加密配置文件<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cd</span> <span class="string">/opt/k8s/cfg</span></span><br><span class="line"><span class="string">source</span> <span class="string">/opt/k8s/environment.sh</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt; encryption-config.yaml &lt;&lt;EOF</span></span><br><span class="line"><span class="string"></span><span class="attr">kind:</span> <span class="string">EncryptionConfig</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">resources:</span></span><br><span class="line"><span class="attr">  - resources:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">secrets</span></span><br><span class="line"><span class="attr">    providers:</span></span><br><span class="line"><span class="attr">      - aescbc:</span></span><br><span class="line"><span class="attr">          keys:</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">key1</span></span><br><span class="line"><span class="attr">              secret:</span> <span class="string">$&#123;ENCRYPTION_KEY&#125;</span></span><br><span class="line"><span class="attr">      - identity:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure></p>
<p>创建审计策略文件<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/cfg</span><br><span class="line">source /opt/k8s/environment.sh</span><br><span class="line">cat &gt; audit-policy.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: audit.k8s.io/v1beta1</span><br><span class="line">kind: Policy</span><br><span class="line">rules:</span><br><span class="line">  # The following requests were manually identified as high-volume and low-risk, so drop them.</span><br><span class="line">  -<span class="ruby"> <span class="symbol">level:</span> None</span></span><br><span class="line"><span class="ruby">    <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> <span class="string">""</span></span></span><br><span class="line"><span class="ruby">        <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">          - endpoints</span></span><br><span class="line"><span class="ruby">          - services</span></span><br><span class="line"><span class="ruby">          - services/status</span></span><br><span class="line"><span class="ruby">    <span class="symbol">users:</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'system:kube-proxy'</span></span></span><br><span class="line"><span class="ruby">    <span class="symbol">verbs:</span></span></span><br><span class="line"><span class="ruby">      - watch</span></span><br><span class="line"><span class="ruby">  - <span class="symbol">level:</span> None</span></span><br><span class="line"><span class="ruby">    <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> <span class="string">""</span></span></span><br><span class="line"><span class="ruby">        <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">          - nodes</span></span><br><span class="line"><span class="ruby">          - nodes/status</span></span><br><span class="line"><span class="ruby">    <span class="symbol">userGroups:</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'system:nodes'</span></span></span><br><span class="line"><span class="ruby">    <span class="symbol">verbs:</span></span></span><br><span class="line"><span class="ruby">      - get</span></span><br><span class="line"><span class="ruby">  - <span class="symbol">level:</span> None</span></span><br><span class="line"><span class="ruby">    <span class="symbol">namespaces:</span></span></span><br><span class="line"><span class="ruby">      - kube-system</span></span><br><span class="line"><span class="ruby">    <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> <span class="string">""</span></span></span><br><span class="line"><span class="ruby">        <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">          - endpoints</span></span><br><span class="line"><span class="ruby">    <span class="symbol">users:</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'system:kube-controller-manager'</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'system:kube-scheduler'</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'system:serviceaccount:kube-system:endpoint-controller'</span></span></span><br><span class="line"><span class="ruby">    <span class="symbol">verbs:</span></span></span><br><span class="line"><span class="ruby">      - get</span></span><br><span class="line"><span class="ruby">      - update</span></span><br><span class="line"><span class="ruby">  - <span class="symbol">level:</span> None</span></span><br><span class="line"><span class="ruby">    <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> <span class="string">""</span></span></span><br><span class="line"><span class="ruby">        <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">          - namespaces</span></span><br><span class="line"><span class="ruby">          - namespaces/status</span></span><br><span class="line"><span class="ruby">          - namespaces/finalize</span></span><br><span class="line"><span class="ruby">    <span class="symbol">users:</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'system:apiserver'</span></span></span><br><span class="line"><span class="ruby">    <span class="symbol">verbs:</span></span></span><br><span class="line"><span class="ruby">      - get</span></span><br><span class="line"><span class="ruby">  <span class="comment"># Don't log HPA fetching metrics.</span></span></span><br><span class="line"><span class="ruby">  - <span class="symbol">level:</span> None</span></span><br><span class="line"><span class="ruby">    <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> metrics.k8s.io</span></span><br><span class="line"><span class="ruby">    <span class="symbol">users:</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'system:kube-controller-manager'</span></span></span><br><span class="line"><span class="ruby">    <span class="symbol">verbs:</span></span></span><br><span class="line"><span class="ruby">      - get</span></span><br><span class="line"><span class="ruby">      - list</span></span><br><span class="line"><span class="ruby">  <span class="comment"># Don't log these read-only URLs.</span></span></span><br><span class="line"><span class="ruby">  - <span class="symbol">level:</span> None</span></span><br><span class="line"><span class="ruby">    <span class="symbol">nonResourceURLs:</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'/healthz*'</span></span></span><br><span class="line"><span class="ruby">      - <span class="regexp">/version</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'/swagger*'</span></span></span><br><span class="line"><span class="ruby">  <span class="comment"># Don't log events requests.</span></span></span><br><span class="line"><span class="ruby">  - <span class="symbol">level:</span> None</span></span><br><span class="line"><span class="ruby">    <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> <span class="string">""</span></span></span><br><span class="line"><span class="ruby">        <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">          - events</span></span><br><span class="line"><span class="ruby">  <span class="comment"># node and pod status calls from nodes are high-volume and can be large, don't log responses for expected updates from nodes</span></span></span><br><span class="line"><span class="ruby">  - <span class="symbol">level:</span> Request</span></span><br><span class="line"><span class="ruby">    <span class="symbol">omitStages:</span></span></span><br><span class="line"><span class="ruby">      - RequestReceived</span></span><br><span class="line"><span class="ruby">    <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> <span class="string">""</span></span></span><br><span class="line"><span class="ruby">        <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">          - nodes/status</span></span><br><span class="line"><span class="ruby">          - pods/status</span></span><br><span class="line"><span class="ruby">    <span class="symbol">users:</span></span></span><br><span class="line"><span class="ruby">      - kubelet</span></span><br><span class="line"><span class="ruby">      - <span class="string">'system:node-problem-detector'</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'system:serviceaccount:kube-system:node-problem-detector'</span></span></span><br><span class="line"><span class="ruby">    <span class="symbol">verbs:</span></span></span><br><span class="line"><span class="ruby">      - update</span></span><br><span class="line"><span class="ruby">      - patch</span></span><br><span class="line"><span class="ruby">  - <span class="symbol">level:</span> Request</span></span><br><span class="line"><span class="ruby">    <span class="symbol">omitStages:</span></span></span><br><span class="line"><span class="ruby">      - RequestReceived</span></span><br><span class="line"><span class="ruby">    <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> <span class="string">""</span></span></span><br><span class="line"><span class="ruby">        <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">          - nodes/status</span></span><br><span class="line"><span class="ruby">          - pods/status</span></span><br><span class="line"><span class="ruby">    <span class="symbol">userGroups:</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'system:nodes'</span></span></span><br><span class="line"><span class="ruby">    <span class="symbol">verbs:</span></span></span><br><span class="line"><span class="ruby">      - update</span></span><br><span class="line"><span class="ruby">      - patch</span></span><br><span class="line"><span class="ruby">  <span class="comment"># deletecollection calls can be large, don't log responses for expected namespace deletions</span></span></span><br><span class="line"><span class="ruby">  - <span class="symbol">level:</span> Request</span></span><br><span class="line"><span class="ruby">    <span class="symbol">omitStages:</span></span></span><br><span class="line"><span class="ruby">      - RequestReceived</span></span><br><span class="line"><span class="ruby">    <span class="symbol">users:</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'system:serviceaccount:kube-system:namespace-controller'</span></span></span><br><span class="line"><span class="ruby">    <span class="symbol">verbs:</span></span></span><br><span class="line"><span class="ruby">      - deletecollection</span></span><br><span class="line"><span class="ruby">  <span class="comment"># Secrets, ConfigMaps, and TokenReviews can contain sensitive &amp; binary data,</span></span></span><br><span class="line"><span class="ruby">  <span class="comment"># so only log at the Metadata level.</span></span></span><br><span class="line"><span class="ruby">  - <span class="symbol">level:</span> Metadata</span></span><br><span class="line"><span class="ruby">    <span class="symbol">omitStages:</span></span></span><br><span class="line"><span class="ruby">      - RequestReceived</span></span><br><span class="line"><span class="ruby">    <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> <span class="string">""</span></span></span><br><span class="line"><span class="ruby">        <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">          - secrets</span></span><br><span class="line"><span class="ruby">          - configmaps</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> authentication.k8s.io</span></span><br><span class="line"><span class="ruby">        <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">          - tokenreviews</span></span><br><span class="line"><span class="ruby">  <span class="comment"># Get repsonses can be large; skip them.</span></span></span><br><span class="line"><span class="ruby">  - <span class="symbol">level:</span> Request</span></span><br><span class="line"><span class="ruby">    <span class="symbol">omitStages:</span></span></span><br><span class="line"><span class="ruby">      - RequestReceived</span></span><br><span class="line"><span class="ruby">    <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> <span class="string">""</span></span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> admissionregistration.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> apiextensions.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> apiregistration.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> apps</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> authentication.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> authorization.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> autoscaling</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> batch</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> certificates.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> extensions</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> metrics.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> networking.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> policy</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> rbac.authorization.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> scheduling.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> settings.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> storage.k8s.io</span></span><br><span class="line"><span class="ruby">    <span class="symbol">verbs:</span></span></span><br><span class="line"><span class="ruby">      - get</span></span><br><span class="line"><span class="ruby">      - list</span></span><br><span class="line"><span class="ruby">      - watch</span></span><br><span class="line"><span class="ruby">  <span class="comment"># Default level for known APIs</span></span></span><br><span class="line"><span class="ruby">  - <span class="symbol">level:</span> RequestResponse</span></span><br><span class="line"><span class="ruby">    <span class="symbol">omitStages:</span></span></span><br><span class="line"><span class="ruby">      - RequestReceived</span></span><br><span class="line"><span class="ruby">    <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> <span class="string">""</span></span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> admissionregistration.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> apiextensions.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> apiregistration.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> apps</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> authentication.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> authorization.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> autoscaling</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> batch</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> certificates.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> extensions</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> metrics.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> networking.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> policy</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> rbac.authorization.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> scheduling.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> settings.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> storage.k8s.io</span></span><br><span class="line"><span class="ruby">  <span class="comment"># Default level for all other requests.</span></span></span><br><span class="line"><span class="ruby">  - <span class="symbol">level:</span> Metadata</span></span><br><span class="line"><span class="ruby">    <span class="symbol">omitStages:</span></span></span><br><span class="line"><span class="ruby">      - RequestReceived</span></span><br><span class="line"><span class="ruby">EOF</span></span><br></pre></td></tr></table></figure></p>
<p>分发<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/cfg</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;MASTER_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">    scp encryption-config.yaml audit-policy.yaml root@<span class="variable">$&#123;node_ip&#125;</span>:/etc/kubernetes/</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure></p>
<p>创建访问 metrics-server证书签名请求<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/ssl</span><br><span class="line">cat &gt; proxy-client-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"aggregator"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: <span class="number">2048</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"GuangZhou"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"GuangZhou"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#CN名称需要位于kube-apiserver的--requestheader-allowed-names参数中，否则后续访问metrics时会提示权限不足</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#生成证书和私钥</span></span><br><span class="line">cd /opt/k8s/ssl</span><br><span class="line">cfssl gencert -ca=<span class="regexp">/opt/k</span>8s/ssl/ca.pem \</span><br><span class="line">  -ca-key=<span class="regexp">/opt/k</span>8s/ssl/ca-key.pem  \</span><br><span class="line">  -config=<span class="regexp">/opt/k</span>8s/ssl/ca-config.json  \</span><br><span class="line">  -profile=kubernetes proxy-client-csr.json | cfssljson -bare proxy-client</span><br><span class="line"></span><br><span class="line"><span class="comment">#分发</span></span><br><span class="line">cd /opt/k8s/ssl</span><br><span class="line">source /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;</span>MASTER_IPS[@]&#125;;<span class="keyword">do</span></span><br><span class="line">    echo <span class="string">"&gt;&gt;&gt; $&#123;node_ip&#125;"</span></span><br><span class="line">    scp proxy-client*.pem root@<span class="variable">$&#123;</span>node_ip&#125;<span class="symbol">:/etc/kubernetes/ssl/</span></span><br><span class="line">done</span><br></pre></td></tr></table></figure></p>
<p>创建kube-apiserver启动文件<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/init</span><br><span class="line">source /opt/k8s/environment.sh</span><br><span class="line">cat &gt; kube-apiserver.service.template &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=$&#123;K8S_DIR&#125;/kube-apiserver</span><br><span class="line">ExecStart=/usr/local/k8s/bin/kube-apiserver \\</span><br><span class="line">  -<span class="ruby">-advertise-address=<span class="comment">##NODE_IP## \\</span></span></span><br><span class="line"><span class="ruby">  --default-<span class="keyword">not</span>-ready-toleration-seconds=<span class="number">360</span> \\</span></span><br><span class="line"><span class="ruby">  --default-unreachable-toleration-seconds=<span class="number">360</span> \\</span></span><br><span class="line"><span class="ruby">  --feature-gates=DynamicAuditing=<span class="literal">true</span> \\</span></span><br><span class="line"><span class="ruby">  --max-mutating-requests-inflight=<span class="number">2000</span> \\</span></span><br><span class="line"><span class="ruby">  --max-requests-inflight=<span class="number">4000</span> \\</span></span><br><span class="line"><span class="ruby">  --default-watch-cache-size=<span class="number">200</span> \\</span></span><br><span class="line"><span class="ruby">  --delete-collection-workers=<span class="number">2</span> \\</span></span><br><span class="line"><span class="ruby">  --encryption-provider-config=<span class="regexp">/etc/kubernetes</span><span class="regexp">/encryption-config.yaml \\</span></span></span><br><span class="line"><span class="ruby">  --etcd-cafile=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/ca</span>.pem \\</span></span><br><span class="line"><span class="ruby">  --etcd-certfile=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/kube</span>-apiserver.pem \\</span></span><br><span class="line"><span class="ruby">  --etcd-keyfile=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/kube</span>-apiserver-key.pem \\</span></span><br><span class="line"><span class="ruby">  --etcd-servers=$&#123;ETCD_ENDPOINTS&#125; \\</span></span><br><span class="line"><span class="ruby">  --bind-address=<span class="comment">##NODE_IP## \\</span></span></span><br><span class="line"><span class="ruby">  --secure-port=<span class="number">6443</span> \\</span></span><br><span class="line"><span class="ruby">  --tls-cert-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/kube</span>-apiserver.pem \\</span></span><br><span class="line"><span class="ruby">  --tls-private-key-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/kube</span>-apiserver-key.pem \\</span></span><br><span class="line"><span class="ruby">  --insecure-port=<span class="number">0</span> \\</span></span><br><span class="line"><span class="ruby">  --audit-dynamic-configuration \\</span></span><br><span class="line"><span class="ruby">  --audit-log-maxage=<span class="number">15</span> \\</span></span><br><span class="line"><span class="ruby">  --audit-log-maxbackup=<span class="number">3</span> \\</span></span><br><span class="line"><span class="ruby">  --audit-log-maxsize=<span class="number">100</span> \\</span></span><br><span class="line"><span class="ruby">  --audit-log-truncate-enabled \\</span></span><br><span class="line"><span class="ruby">  --audit-log-path=$&#123;K8S_DIR&#125;/kube-apiserver/audit.log \\</span></span><br><span class="line"><span class="ruby">  --audit-policy-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/audit-policy.yaml \\</span></span></span><br><span class="line"><span class="ruby">  --profiling \\</span></span><br><span class="line"><span class="ruby">  --anonymous-auth=<span class="literal">false</span> \\</span></span><br><span class="line"><span class="ruby">  --client-ca-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/ca</span>.pem \\</span></span><br><span class="line"><span class="ruby">  --enable-bootstrap-token-auth \\</span></span><br><span class="line"><span class="ruby">  --requestheader-allowed-names=<span class="string">"aggregator"</span> \\</span></span><br><span class="line"><span class="ruby">  --requestheader-client-ca-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/ca</span>.pem \\</span></span><br><span class="line"><span class="ruby">  --requestheader-extra-headers-prefix=<span class="string">"X-Remote-Extra-"</span> \\</span></span><br><span class="line"><span class="ruby">  --requestheader-group-headers=X-Remote-Group \\</span></span><br><span class="line"><span class="ruby">  --requestheader-username-headers=X-Remote-User \\</span></span><br><span class="line"><span class="ruby">  --service-account-key-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/ca</span>.pem \\</span></span><br><span class="line"><span class="ruby">  --authorization-mode=Node,RBAC \\</span></span><br><span class="line"><span class="ruby">  --runtime-config=api/all=<span class="literal">true</span> \\</span></span><br><span class="line"><span class="ruby">  --enable-admission-plugins=NodeRestriction \\</span></span><br><span class="line"><span class="ruby">  --allow-privileged=<span class="literal">true</span> \\</span></span><br><span class="line"><span class="ruby">  --apiserver-count=<span class="number">3</span> \\</span></span><br><span class="line"><span class="ruby">  --event-ttl=<span class="number">168</span>h \\</span></span><br><span class="line"><span class="ruby">  --kubelet-certificate-authority=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/ca</span>.pem \\</span></span><br><span class="line"><span class="ruby">  --kubelet-client-certificate=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/kube</span>-apiserver.pem \\</span></span><br><span class="line"><span class="ruby">  --kubelet-client-key=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/kube</span>-apiserver-key.pem \\</span></span><br><span class="line"><span class="ruby">  --kubelet-https=<span class="literal">true</span> \\</span></span><br><span class="line"><span class="ruby">  --kubelet-timeout=<span class="number">10</span>s \\</span></span><br><span class="line"><span class="ruby">  --proxy-client-cert-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/proxy</span>-client.pem \\</span></span><br><span class="line"><span class="ruby">  --proxy-client-key-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/proxy</span>-client-key.pem \\</span></span><br><span class="line"><span class="ruby">  --service-cluster-ip-range=$&#123;SERVICE_CIDR&#125; \\</span></span><br><span class="line"><span class="ruby">  --service-node-port-range=$&#123;NODE_PORT_RANGE&#125; \\</span></span><br><span class="line"><span class="ruby">  --logtostderr=<span class="literal">true</span> \\</span></span><br><span class="line"><span class="ruby">  --v=<span class="number">2</span></span></span><br><span class="line"><span class="ruby">Restart=on-failure</span></span><br><span class="line"><span class="ruby">RestartSec=<span class="number">10</span></span></span><br><span class="line"><span class="ruby">Type=notify</span></span><br><span class="line"><span class="ruby">LimitNOFILE=<span class="number">65536</span></span></span><br><span class="line"><span class="ruby">[Install]</span></span><br><span class="line"><span class="ruby">WantedBy=multi-user.target</span></span><br><span class="line"><span class="ruby">EOF</span></span><br></pre></td></tr></table></figure></p>
<p>参数配置说明<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby">-advertise-address：apiserver 对外通告的 IP（kubernetes 服务后端节点 IP）；</span></span><br><span class="line"><span class="ruby">--default-*-toleration-seconds：设置节点异常相关的阈值；</span></span><br><span class="line"><span class="ruby">--max-*-requests-inflight：请求相关的最大阈值；</span></span><br><span class="line"><span class="ruby">--etcd-*：访问 etcd 的证书和 etcd 服务器地址；</span></span><br><span class="line"><span class="ruby">--experimental-encryption-provider-config：指定用于加密 etcd 中 secret 的配置；</span></span><br><span class="line"><span class="ruby">--bind-address： https 监听的 IP，不能为 <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>，否则外界不能访问它的安全端口 <span class="number">6443</span>；</span></span><br><span class="line"><span class="ruby">--secret-port：https 监听端口；</span></span><br><span class="line"><span class="ruby">--insecure-port=<span class="number">0</span>：关闭监听 http 非安全端口(<span class="number">8080</span>)；</span></span><br><span class="line"><span class="ruby">--tls-*-file：指定 apiserver 使用的证书、私钥和 CA 文件；</span></span><br><span class="line"><span class="ruby">--audit-*：配置审计策略和审计日志文件相关的参数；</span></span><br><span class="line"><span class="ruby">--client-ca-file：验证 client (kue-controller-manager、kube-scheduler、kubelet、kube-proxy 等)请求所带的证书；</span></span><br><span class="line"><span class="ruby">--enable-bootstrap-token-auth：启用 kubelet bootstrap 的 token 认证；</span></span><br><span class="line"><span class="ruby">--requestheader-*：kube-apiserver 的 aggregator layer 相关的配置参数，proxy-client &amp; HPA 需要使用；</span></span><br><span class="line"><span class="ruby">--requestheader-client-ca-file：用于签名 --proxy-client-cert-file 和 --proxy-client-key-file 指定的证书；在启用了 metric aggregator 时使用；</span></span><br><span class="line"><span class="ruby">--requestheader-allowed-names：不能为空，值为逗号分割的 --proxy-client-cert-file 证书的 CN 名称，这里设置为 <span class="string">"aggregator"</span>；</span></span><br><span class="line"><span class="ruby">--service-account-key-file：签名 ServiceAccount Token 的公钥文件，kube-controller-manager 的 --service-account-private-key-file 定私钥文件，两者配对使用；</span></span><br><span class="line"><span class="ruby">--runtime-config=api/all=<span class="literal">true</span>： 启用所有版本的 APIs，如 autoscaling/v2alpha1；</span></span><br><span class="line"><span class="ruby">--authorization-mode=Node,RBAC、--anonymous-auth=<span class="literal">false</span>： 开启 Node 和 RBAC 授权模式，拒绝未授权的请求；</span></span><br><span class="line"><span class="ruby">--enable-admission-plugins：启用一些默认关闭的 plugins；</span></span><br><span class="line"><span class="ruby">--allow-privileged：运行执行 privileged 权限的容器；</span></span><br><span class="line"><span class="ruby">--apiserver-count=<span class="number">3</span>：指定 apiserver 实例的数量；</span></span><br><span class="line"><span class="ruby">--event-ttl：指定 events 的保存时间；</span></span><br><span class="line"><span class="ruby">--kubelet-：如果指定，则使用 https 访问 kubelet APIs；需要为证书对应的用户(上面 kubernetes.pem 证书的用户为 kubernetes) 用户定义 RBAC 规则，否则访问 kubelet API 时提示未授权；</span></span><br><span class="line"><span class="ruby">--proxy-client-*：apiserver 访问 metrics-server 使用的证书；</span></span><br><span class="line"><span class="ruby">--service-cluster-ip-range： 指定 Service Cluster IP 地址段；</span></span><br><span class="line"><span class="ruby">--service-node-port-range： 指定 NodePort 的端口范围；</span></span><br><span class="line"><span class="ruby">如果 kube-apiserver 机器没有运行 kube-proxy，则还需要添加 --enable-aggregator-routing=<span class="literal">true</span> 参数；</span></span><br><span class="line"><span class="ruby"> 关于 --requestheader-XXX 相关参数，参考：</span></span><br><span class="line"><span class="ruby"><span class="symbol">https:</span>/<span class="regexp">/github.com/kubernetes</span>-incubator/apiserver-builder/blob/master/docs/concepts/auth.md</span></span><br><span class="line"><span class="ruby"><span class="symbol">https:</span>/<span class="regexp">/docs.bitnami.com/kubernetes</span><span class="regexp">/how-to/configure</span>-autoscaling-custom-metrics/</span></span><br></pre></td></tr></table></figure></p>
<p>注意: requestheader-client-ca-file指定的CA证书，必须具有client auth and server auth<br>如果--requestheader-allowed-names为空，或者--proxy-client-cert-file证书的CN名称不在allowed-names中，则后续查看node或者Pods的metrics失败<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/init</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> (( i=0; i &lt; 3; i++ ));<span class="keyword">do</span> </span><br><span class="line">    sed -e <span class="string">"s/##NODE_NAME##/<span class="variable">$&#123;MASTER_NAMES[i]&#125;</span>/"</span> -e <span class="string">"s/##NODE_IP##/<span class="variable">$&#123;MASTER_IPS[i]&#125;</span>/"</span> kube-apiserver.service.template &gt; kube-apiserver-<span class="variable">$&#123;MASTER_IPS[i]&#125;</span>.service </span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#分发</span></span><br><span class="line"><span class="built_in">cd</span> /opt/k8s/init</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;MASTER_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">    scp kube-apiserver-<span class="variable">$&#123;node_ip&#125;</span>.service root@<span class="variable">$&#123;node_ip&#125;</span>:/etc/systemd/system/kube-apiserver.service</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure></p>
<p>启动apiserver<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;MASTER_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"mkdir -p <span class="variable">$&#123;K8S_DIR&#125;</span>/kube-apiserver"</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"systemctl daemon-reload &amp;&amp; systemctl enable kube-apiserver &amp;&amp; systemctl restart kube-apiserver"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure></p>
<p>检查服务是否正常<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;MASTER_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"systemctl status kube-apiserver |grep 'Active:'"</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#确保状态为active (running)，否则查看日志，确认原因</span></span><br><span class="line"> journalctl -u kube-apiserver</span><br></pre></td></tr></table></figure></p>
<p>打印kube-apiserver写入etcd数据<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">source /opt/k8s/environment.sh</span><br><span class="line">ETCDCTL_API=3 etcdctl \</span><br><span class="line">    -<span class="ruby">-endpoints=$&#123;ETCD_ENDPOINTS&#125; \</span></span><br><span class="line"><span class="ruby">    --cacert=<span class="regexp">/opt/k</span>8s/ssl/ca.pem \</span></span><br><span class="line"><span class="ruby">    --cert=<span class="regexp">/opt/k</span>8s/ssl/etcd.pem \</span></span><br><span class="line"><span class="ruby">    --key=<span class="regexp">/opt/k</span>8s/ssl/etcd-key.pem \</span></span><br><span class="line"><span class="ruby">    get /registry/ --prefix --keys-only</span></span><br></pre></td></tr></table></figure></p>
<p>检查kube-apiserver监听的端口<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 init]# netstat -lntup|grep kube</span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">192.168</span><span class="meta">.10</span><span class="meta">.81</span>:<span class="number">6443</span>      <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:*               LISTEN      <span class="number">2069</span>/kube-apiserver</span><br></pre></td></tr></table></figure></p>
<p>#检查集群信息<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 cfg]#  kubectl cluster-info</span><br><span class="line">Kubernetes master is running <span class="meta">at</span> https://<span class="number">192.168</span><span class="meta">.10</span><span class="meta">.80</span>:<span class="number">8443</span></span><br><span class="line"></span><br><span class="line">To further debug <span class="keyword">and</span> diagnose cluster problems, use <span class="string">'kubectl cluster-info dump'</span>.</span><br><span class="line"></span><br><span class="line">[root@k8s-master01 cert]# kubectl get all --all-namespaces</span><br><span class="line">NAMESPACE   NAME                 TYPE        CLUSTER-<span class="built_in">IP</span>   EXTERNAL-<span class="built_in">IP</span>   PORT(S)   AGE</span><br><span class="line"><span class="meta">default</span>     service/kubernetes   ClusterIP   <span class="number">10.247</span><span class="meta">.0</span><span class="meta">.1</span>   &lt;none&gt;        <span class="number">443</span>/TCP   57m</span><br><span class="line"></span><br><span class="line">[root@k8s-master01 cert]# kubectl get <span class="built_in">cs</span></span><br><span class="line">NAME                 STATUS      MESSAGE                                                                                     ERROR</span><br><span class="line">controller-manager   Unhealthy   Get http://<span class="number">127.0</span><span class="meta">.0</span><span class="meta">.1</span>:<span class="number">10252</span>/healthz: dial tcp <span class="number">127.0</span><span class="meta">.0</span><span class="meta">.1</span>:<span class="number">10252</span>: connect: connection refused   </span><br><span class="line">scheduler            Unhealthy   Get http://<span class="number">127.0</span><span class="meta">.0</span><span class="meta">.1</span>:<span class="number">10251</span>/healthz: dial tcp <span class="number">127.0</span><span class="meta">.0</span><span class="meta">.1</span>:<span class="number">10251</span>: connect: connection refused   </span><br><span class="line">etcd-<span class="number">0</span>               Healthy     &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;                                                                           </span><br><span class="line">etcd-<span class="number">2</span>               Healthy     &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;                                                                           </span><br><span class="line">etcd-<span class="number">1</span>               Healthy     &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125; </span><br><span class="line"></span><br><span class="line">#如果提示有报错，请检查~/.kube/config以及配置证书是否有问题</span><br></pre></td></tr></table></figure></p>
<p>授权kube-apiserver访问kubelet API的权限<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding kube-apiserver:kubelet-apis --<span class="attr">clusterrole=</span>system:kubelet-api-admin --<span class="keyword">user</span> <span class="title">kubernetes</span></span><br></pre></td></tr></table></figure></p>
<h1 id="部署kube-apiserver高可用"><a href="#部署kube-apiserver高可用" class="headerlink" title="部署kube-apiserver高可用"></a>部署kube-apiserver高可用</h1><p><strong>部署haproxy</strong></p>
<ul>
<li>使用haproxy实现k8s节点(master节点和node节点)高可用访问kube-apiserver的步骤</li>
<li>控制节点的kube-controller-manager、kube-scheduler是多实例部署，所以只要一个实例正常，就可以保证集群高可用</li>
<li>集群内的Pod使用k8s服务域名kubernetes访问kube-apiserver，kube-dns会自动解析多个kube-apiserver节点的IP，所以也是高可用的</li>
</ul>
<p>配置haproxy<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/cfg</span><br><span class="line">cat &gt; haproxy.cfg &lt;&lt;EOF</span><br><span class="line">global</span><br><span class="line">    log         127.0.0.1 local2</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">   <span class="built_in"> user </span>       haproxy</span><br><span class="line">   <span class="built_in"> group </span>      haproxy</span><br><span class="line">    daemon</span><br><span class="line"></span><br><span class="line">    # turn on stats unix socket</span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line"></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># common defaults that all the 'listen' and 'backend' sections will</span></span><br><span class="line"><span class="comment"># use if not designated in their block</span></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line">defaults</span><br><span class="line">    mode                    http</span><br><span class="line">    log                     global</span><br><span class="line">    option                  httplog</span><br><span class="line">    option                  dontlognull</span><br><span class="line">    option http-server-close</span><br><span class="line">    option forwardfor       except 127.0.0.0/8</span><br><span class="line">    option                  redispatch</span><br><span class="line">    retries                 3</span><br><span class="line">    timeout http-request    10s</span><br><span class="line">    timeout<span class="built_in"> queue </span>          1m</span><br><span class="line">    timeout connect         10s</span><br><span class="line">    timeout<span class="built_in"> client </span>         1m</span><br><span class="line">    timeout<span class="built_in"> server </span>         1m</span><br><span class="line">    timeout http-keep-alive 10s</span><br><span class="line">    timeout check           10s</span><br><span class="line">    maxconn                 3000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># kubernetes apiserver frontend which proxys to the backends</span></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line">frontend kubernetes-apiserver</span><br><span class="line">    mode                 tcp</span><br><span class="line">    bind                 *:8443</span><br><span class="line">    option               tcplog</span><br><span class="line">    default_backend      kubernetes-apiserver</span><br><span class="line"></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># round robin balancing between the various backends</span></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line">backend kubernetes-apiserver</span><br><span class="line">    mode        tcp</span><br><span class="line">    balance     roundrobin</span><br><span class="line">   <span class="built_in"> server </span>     k8s01 192.168.10.81:6443 check</span><br><span class="line">   <span class="built_in"> server </span>     k8s02 192.168.10.82:6443 check</span><br><span class="line">   <span class="built_in"> server </span>     k8s03 192.168.10.83:6443 check</span><br><span class="line"></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># collection haproxy statistics message</span></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line">listen stats</span><br><span class="line">    bind                 *:1080</span><br><span class="line">    stats auth           admin:sunday</span><br><span class="line">    stats refresh        5s</span><br><span class="line">    stats realm          HAProxy\ Statistics</span><br><span class="line">    stats uri            /haproxy-stats</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#分发</span></span><br><span class="line">source /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;MASTER_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    echo <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"yum  install -y haproxy"</span></span><br><span class="line">    scp /opt/k8s/cfg/haproxy.cfg <span class="variable">$&#123;node_ip&#125;</span>:/etc/haproxy/</span><br><span class="line">    ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"systemctl enable --now haproxy"</span></span><br><span class="line">done</span><br></pre></td></tr></table></figure></p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ss -tunlp <span class="string">|grep 8443</span></span><br></pre></td></tr></table></figure>
<p><strong>部署keeplived</strong><br>高可用方案需要一个VIP，供集群内部访问</p>
<p>配置keeplived服务<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/cfg</span><br><span class="line">cat &gt; keepalived.conf &lt;&lt;EOF</span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id keepalived</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check_haproxy &#123;</span><br><span class="line">   <span class="built_in"> script </span><span class="string">"killall -0 haproxy"</span></span><br><span class="line">    interval 2</span><br><span class="line">    weight -3</span><br><span class="line">    fall 2</span><br><span class="line">    rise 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">   <span class="built_in"> interface </span>eth0</span><br><span class="line">    virtual_router_id 247</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass Sunday</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.10.80</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_haproxy</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#分发安装</span></span><br><span class="line">source /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;MASTER_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    echo <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"yum  install -y keepalived  psmisc"</span></span><br><span class="line">    scp  /opt/k8s/cfg/keepalived.conf <span class="variable">$node_ip</span>:/etc/keepalived/keepalived.conf</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"><span class="comment">#替换状态和权重</span></span><br><span class="line"></span><br><span class="line">ssh root@192.168.10.82 <span class="string">"sed -i -e 's#MASTER#BACKUP#g' -e 's#priority 100#priority 99#g' /etc/keepalived/keepalived.conf"</span></span><br><span class="line">ssh root@192.168.10.83 <span class="string">"sed -i -e 's#MASTER#BACKUP#g' -e 's#priority 100#priority 98#g' /etc/keepalived/keepalived.conf"</span></span><br></pre></td></tr></table></figure></p>
<p>启动keeplived<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">source /opt/k8s/environment.sh</span><br><span class="line">for NODE in $&#123;MASTER_IPS[@]&#125;; do</span><br><span class="line">    echo &quot;--- $NODE ---&quot;</span><br><span class="line">    ssh $NODE &apos;systemctl enable --now keepalived&apos;</span><br><span class="line">done</span><br></pre></td></tr></table></figure></p>
<p>启动完毕后ping 192.168.10.80 (VIP)<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 cfg]#<span class="built_in"> ping </span>-c 2 192.168.10.80</span><br><span class="line">PING 192.168.10.80 (192.168.10.80) 56(84) bytes of data.</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.10.80: <span class="attribute">icmp_seq</span>=1 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.045 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.10.80: <span class="attribute">icmp_seq</span>=2 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.052 ms</span><br></pre></td></tr></table></figure></p>
<h1 id="部署kube-controller-manager"><a href="#部署kube-controller-manager" class="headerlink" title="部署kube-controller-manager"></a>部署kube-controller-manager</h1><p>三台 kube-controller-manager 集群，启动后通过竞争选举机制产生一个leader节点，其他节点为阻塞状态。当leader节点不可用时，阻塞节点将会在此选举产生新的leader，从而保证服务的高可用。</p>
<p>创建kube-controller-manager证书和私钥<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> /<span class="keyword">opt</span>/k8s/ssl</span><br><span class="line"><span class="keyword">cat</span> &gt; kube-controller-manager-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"system:kube-controller-manager"</span>,</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: <span class="number">2048</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"hosts"</span>: [</span><br><span class="line">      <span class="string">"127.0.0.1"</span>,</span><br><span class="line">      <span class="string">"192.168.10.81"</span>,</span><br><span class="line">      <span class="string">"192.168.10.82"</span>,</span><br><span class="line">      <span class="string">"192.168.10.83"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">        <span class="string">"ST"</span>: <span class="string">"GuangZhou"</span>,</span><br><span class="line">        <span class="string">"L"</span>: <span class="string">"GuangZhou"</span>,</span><br><span class="line">        <span class="string">"O"</span>: <span class="string">"system:kube-controller-manager"</span>,</span><br><span class="line">        <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">#生成证书和私钥</span><br><span class="line"><span class="keyword">cd</span> /<span class="keyword">opt</span>/k8s/ssl</span><br><span class="line">cfssl gencert -<span class="keyword">ca</span>=/<span class="keyword">opt</span>/k8s/ssl/<span class="keyword">ca</span>.pem \</span><br><span class="line">  -<span class="keyword">ca</span>-key=/<span class="keyword">opt</span>/k8s/ssl/<span class="keyword">ca</span>-key.pem \</span><br><span class="line">  -config=/<span class="keyword">opt</span>/k8s/ssl/<span class="keyword">ca</span>-config.json \</span><br><span class="line">  -<span class="keyword">profile</span>=kubernetes kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager</span><br></pre></td></tr></table></figure></p>
<p>创建kube-controller-manager.kubeconfig文件<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/cfg</span><br><span class="line">kubectl<span class="built_in"> config </span>set-cluster kubernetes \</span><br><span class="line">  <span class="attribute">--certificate-authority</span>=/opt/k8s/ssl/ca.pem \</span><br><span class="line">  <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line">  <span class="attribute">--server</span>=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=kube-controller-manager.kubeconfig</span><br><span class="line">kubectl<span class="built_in"> config </span>set-credentials system:kube-controller-manager \</span><br><span class="line">  <span class="attribute">--client-certificate</span>=/opt/k8s/ssl/kube-controller-manager.pem \</span><br><span class="line">  <span class="attribute">--client-key</span>=/opt/k8s/ssl/kube-controller-manager-key.pem \</span><br><span class="line">  <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=kube-controller-manager.kubeconfig</span><br><span class="line">kubectl<span class="built_in"> config </span>set-context system:kube-controller-manager \</span><br><span class="line">  <span class="attribute">--cluster</span>=kubernetes \</span><br><span class="line">  <span class="attribute">--user</span>=system:kube-controller-manager \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=kube-controller-manager.kubeconfig</span><br><span class="line">kubectl<span class="built_in"> config </span>use-context system:kube-controller-manager <span class="attribute">--kubeconfig</span>=kube-controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment">#kube-controller-manager使用kubeconfig文件访问apiserver</span></span><br><span class="line"><span class="comment">#该文件提供了apiserver地址、嵌入的CA证书和kube-controller-manager证书</span></span><br></pre></td></tr></table></figure></p>
<p>将生成的证书和私钥分发到所有master节点<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">source /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;</span>MASTER_IPS[@]&#125;;<span class="keyword">do</span></span><br><span class="line">    echo <span class="string">"&gt;&gt;&gt; $&#123;node_ip&#125;"</span></span><br><span class="line">    scp /opt/k8s/ssl/kube-controller-manager*.pem root@<span class="variable">$&#123;</span>node_ip&#125;<span class="symbol">:/etc/kubernetes/ssl/</span></span><br><span class="line">    scp /opt/k8s/cfg/kube-controller-manager.kubeconfig root@<span class="variable">$&#123;</span>node_ip&#125;<span class="symbol">:/etc/kubernetes/</span></span><br><span class="line">done</span><br></pre></td></tr></table></figure></p>
<p>创建kube-controller-manager启动文件<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/init</span><br><span class="line">cat &gt; kube-controller-manager.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=$&#123;K8S_DIR&#125;/kube-controller-manager</span><br><span class="line">ExecStart=/usr/local/k8s/bin/kube-controller-manager \\</span><br><span class="line">  -<span class="ruby">-profiling \\</span></span><br><span class="line"><span class="ruby">  --cluster-name=kubernetes \\</span></span><br><span class="line"><span class="ruby">  --controllers=*,bootstrapsigner,tokencleaner \\</span></span><br><span class="line"><span class="ruby">  --kube-api-qps=<span class="number">1000</span> \\</span></span><br><span class="line"><span class="ruby">  --kube-api-burst=<span class="number">2000</span> \\</span></span><br><span class="line"><span class="ruby">  --leader-elect \\</span></span><br><span class="line"><span class="ruby">  --use-service-account-credentials\\</span></span><br><span class="line"><span class="ruby">  --concurrent-service-syncs=<span class="number">2</span> \\</span></span><br><span class="line"><span class="ruby">  --bind-address=<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span> \\</span></span><br><span class="line"><span class="ruby">  <span class="comment">#--secure-port=10252 \\</span></span></span><br><span class="line"><span class="ruby">  --tls-cert-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/kube</span>-controller-manager.pem \\</span></span><br><span class="line"><span class="ruby">  --tls-private-key-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/kube</span>-controller-manager-key.pem \\</span></span><br><span class="line"><span class="ruby">  <span class="comment">#--port=0 \\</span></span></span><br><span class="line"><span class="ruby">  --authentication-kubeconfig=<span class="regexp">/etc/kubernetes</span><span class="regexp">/kube-controller-manager.kubeconfig \\</span></span></span><br><span class="line"><span class="ruby">  --client-ca-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/ca</span>.pem \\</span></span><br><span class="line"><span class="ruby">  --requestheader-allowed-names=<span class="string">""</span> \\</span></span><br><span class="line"><span class="ruby">  --requestheader-client-ca-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/ca</span>.pem \\</span></span><br><span class="line"><span class="ruby">  --requestheader-extra-headers-prefix=<span class="string">"X-Remote-Extra-"</span> \\</span></span><br><span class="line"><span class="ruby">  --requestheader-group-headers=X-Remote-Group \\</span></span><br><span class="line"><span class="ruby">  --requestheader-username-headers=X-Remote-User \\</span></span><br><span class="line"><span class="ruby">  --authorization-kubeconfig=<span class="regexp">/etc/kubernetes</span><span class="regexp">/kube-controller-manager.kubeconfig \\</span></span></span><br><span class="line"><span class="ruby">  --cluster-signing-cert-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/ca</span>.pem \\</span></span><br><span class="line"><span class="ruby">  --cluster-signing-key-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/ca</span>-key.pem \\</span></span><br><span class="line"><span class="ruby">  --experimental-cluster-signing-duration=<span class="number">87600</span>h \\</span></span><br><span class="line"><span class="ruby">  --horizontal-pod-autoscaler-sync-period=<span class="number">10</span>s \\</span></span><br><span class="line"><span class="ruby">  --concurrent-deployment-syncs=<span class="number">10</span> \\</span></span><br><span class="line"><span class="ruby">  --concurrent-gc-syncs=<span class="number">30</span> \\</span></span><br><span class="line"><span class="ruby">  --node-cidr-mask-size=<span class="number">24</span> \\</span></span><br><span class="line"><span class="ruby">  --service-cluster-ip-range=$&#123;SERVICE_CIDR&#125; \\</span></span><br><span class="line"><span class="ruby">  --pod-eviction-timeout=<span class="number">6</span>m \\</span></span><br><span class="line"><span class="ruby">  --terminated-pod-gc-threshold=<span class="number">10000</span> \\</span></span><br><span class="line"><span class="ruby">  --root-ca-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/ca</span>.pem \\</span></span><br><span class="line"><span class="ruby">  --service-account-private-key-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/ca</span>-key.pem \\</span></span><br><span class="line"><span class="ruby">  --kubeconfig=<span class="regexp">/etc/kubernetes</span><span class="regexp">/kube-controller-manager.kubeconfig \\</span></span></span><br><span class="line"><span class="ruby">  --logtostderr=<span class="literal">true</span> \\</span></span><br><span class="line"><span class="ruby">  --v=<span class="number">2</span></span></span><br><span class="line"><span class="ruby">Restart=on-failure</span></span><br><span class="line"><span class="ruby">RestartSec=<span class="number">5</span></span></span><br><span class="line"><span class="ruby">[Install]</span></span><br><span class="line"><span class="ruby">WantedBy=multi-user.target</span></span><br><span class="line"><span class="ruby">EOF</span></span><br></pre></td></tr></table></figure></p>
<p>参数解释</p>
<ul>
<li>--port=0：关闭监听非安全端口（http），同时 --address 参数无效，--bind-address 参数有效；</li>
<li>--secure-port=10252、--bind-address=0.0.0.0: 在所有网络接口监听 10252 端口的 https /metrics 请求；</li>
<li>--kubeconfig：指定 kubeconfig 文件路径，kube-controller-manager 使用它连接和验证 kube-apiserver；</li>
<li>--authentication-kubeconfig 和 –authorization-kubeconfig：kube-controller-manager 使用它连接 apiserver，对 client 的请求进行认证和授权。kube-controller-manager 不再使用 –tls-ca-file 对请求 https metrics 的 Client 证书进行校验。如果没有配置这两个 kubeconfig 参数，则 client 连接 kube-controller-manager https 端口的请求会被拒绝(提示权限不足)。</li>
<li>--cluster-signing-*-file：签名 TLS Bootstrap 创建的证书；</li>
<li>--experimental-cluster-signing-duration：指定 TLS Bootstrap 证书的有效期；</li>
<li>--root-ca-file：放置到容器 ServiceAccount 中的 CA 证书，用来对 kube-apiserver 的证书进行校验；</li>
<li>--service-account-private-key-file：签名 ServiceAccount 中 Token 的私钥文件，必须和 kube-apiserver 的 –service-account-key-file 指定的公钥文件配对使用；</li>
<li>--service-cluster-ip-range ：指定 Service Cluster IP 网段，必须和 kube-apiserver 中的同名参数一致；</li>
<li>--leader-elect=true：集群运行模式，启用选举功能；被选为 leader 的节点负责处理工作，其它节点为阻塞状态；</li>
<li>--controllers=*,bootstrapsigner,tokencleaner：启用的控制器列表，tokencleaner 用于自动清理过期的 Bootstrap token；</li>
<li>--horizontal-pod-autoscaler-*：custom metrics 相关参数，支持 autoscaling/v2alpha1；</li>
<li>--tls-cert-file、–tls-private-key-file：使用 https 输出 metrics 时使用的 Server 证书和秘钥；</li>
<li>--use-service-account-credentials=true: kube-controller-manager 中各 controller 使用 serviceaccount 访问 kube-apiserver；</li>
</ul>
<p>分发到所有master节点</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">source /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;</span>MASTER_IPS[@]&#125;;<span class="keyword">do</span></span><br><span class="line">    echo <span class="string">"&gt;&gt;&gt; $&#123;node_ip&#125;"</span></span><br><span class="line">    scp kube-controller-manager.service root@<span class="variable">$&#123;</span>node_ip&#125;<span class="symbol">:/etc/systemd/system/kube-controller-manager</span>.service</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p>启动服务<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;MASTER_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"mkdir -p <span class="variable">$&#123;K8S_DIR&#125;</span>/kube-controller-manager"</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"systemctl daemon-reload &amp;&amp; systemctl enable kube-controller-manager &amp;&amp; systemctl restart kube-controller-manager"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure></p>
<p>检查运行状态<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;MASTER_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"systemctl status kube-controller-manager|grep Active"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure></p>
<p>检查服务状态<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">netstat -lnpt | grep kube-cont</span><br><span class="line">tcp6       <span class="number">0</span>      <span class="number">0</span> :::<span class="number">10252</span>                :::*                    LISTEN      <span class="number">110807</span>/kube-control </span><br><span class="line">tcp6       <span class="number">0</span>      <span class="number">0</span> :::<span class="number">10257</span>                :::*                    LISTEN      <span class="number">110807</span>/kube-control</span><br></pre></td></tr></table></figure></p>
<p>kube-controller-manager 创建权限</p>
<p>ClusteRole system:kube-controller-manager的权限太小，只能创建secret、serviceaccount等资源,将controller的权限分散到ClusterRole system:controller:xxx中<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="keyword">describe</span> clusterrole <span class="keyword">system</span>:kube-controller-manager</span><br><span class="line"><span class="keyword">Name</span>:         <span class="keyword">system</span>:kube-controller-manager</span><br><span class="line">Labels:       kubernetes.io/bootstrapping=rbac-<span class="keyword">defaults</span></span><br><span class="line">Annotations:  rbac.authorization.kubernetes.io/autoupdate: <span class="literal">true</span></span><br><span class="line">PolicyRule:</span><br><span class="line">  Resources                                  Non-<span class="keyword">Resource</span> URLs  <span class="keyword">Resource</span> <span class="keyword">Names</span>  Verbs</span><br><span class="line">  <span class="comment">---------                                  -----------------  --------------  -----</span></span><br><span class="line">  secrets                                    []                 []              [<span class="keyword">create</span> <span class="keyword">delete</span> <span class="keyword">get</span> <span class="keyword">update</span>]</span><br><span class="line">  endpoints                                  []                 []              [<span class="keyword">create</span> <span class="keyword">get</span> <span class="keyword">update</span>]</span><br><span class="line">  serviceaccounts                            []                 []              [<span class="keyword">create</span> <span class="keyword">get</span> <span class="keyword">update</span>]</span><br><span class="line">  <span class="keyword">events</span>                                     []                 []              [<span class="keyword">create</span> <span class="keyword">patch</span> <span class="keyword">update</span>]</span><br><span class="line">  tokenreviews.authentication.k8s.io         []                 []              [<span class="keyword">create</span>]</span><br><span class="line">  subjectaccessreviews.authorization.k8s.io  []                 []              [<span class="keyword">create</span>]</span><br><span class="line">  configmaps                                 []                 []              [<span class="keyword">get</span>]</span><br><span class="line">  namespaces                                 []                 []              [<span class="keyword">get</span>]</span><br><span class="line">  *.*                                        []                 []              [<span class="keyword">list</span> watch]</span><br></pre></td></tr></table></figure></p>
<p>需要在 kube-controller-manager 的启动参数中添加 --use-service-account-credentials=true 参数，这样 main controller 会为各 controller 创建对应的 ServiceAccount XXX-controller。内置的 ClusterRoleBinding system:controller:XXX 将赋予各 XXX-controller ServiceAccount 对应的 ClusterRole system:controller:XXX 权限。<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get clusterrole|grep controller</span><br><span class="line"><span class="string">system:</span><span class="string">controller:</span>attachdetach-controller                              <span class="number">22</span>m</span><br><span class="line"><span class="string">system:</span><span class="string">controller:</span>certificate-controller                               <span class="number">22</span>m</span><br><span class="line"><span class="string">system:</span><span class="string">controller:</span>clusterrole-aggregation-controller                   <span class="number">22</span>m</span><br><span class="line"><span class="string">system:</span><span class="string">controller:</span>cronjob-controller                                   <span class="number">22</span>m</span><br><span class="line"><span class="string">system:</span><span class="string">controller:</span>daemon-set-controller                                <span class="number">22</span>m</span><br><span class="line"><span class="string">system:</span><span class="string">controller:</span>deployment-controller                                <span class="number">22</span>m</span><br><span class="line"><span class="string">system:</span><span class="string">controller:</span>disruption-controller                                <span class="number">22</span>m</span><br><span class="line"><span class="string">system:</span><span class="string">controller:</span>endpoint-controller                                  <span class="number">22</span>m</span><br><span class="line"><span class="string">system:</span><span class="string">controller:</span>expand-controller                                    <span class="number">22</span>m</span><br><span class="line"><span class="string">system:</span><span class="string">controller:</span>generic-garbage-collector                            <span class="number">22</span>m</span><br><span class="line"><span class="string">system:</span><span class="string">controller:</span>horizontal-pod-autoscaler                            <span class="number">22</span>m</span><br><span class="line"><span class="string">system:</span><span class="string">controller:</span>job-controller                                       <span class="number">22</span>m</span><br><span class="line"><span class="string">system:</span><span class="string">controller:</span>namespace-controller                                 <span class="number">22</span>m</span><br><span class="line"><span class="string">system:</span><span class="string">controller:</span>node-controller                                      <span class="number">22</span>m</span><br><span class="line"><span class="string">system:</span><span class="string">controller:</span>persistent-volume-binder                             <span class="number">22</span>m</span><br><span class="line"><span class="string">system:</span><span class="string">controller:</span>pod-garbage-collector                                <span class="number">22</span>m</span><br><span class="line"><span class="string">system:</span><span class="string">controller:</span>pv-protection-controller                             <span class="number">22</span>m</span><br><span class="line"><span class="string">system:</span><span class="string">controller:</span>pvc-protection-controller                            <span class="number">22</span>m</span><br><span class="line"><span class="string">system:</span><span class="string">controller:</span>replicaset-controller                                <span class="number">22</span>m</span><br><span class="line"><span class="string">system:</span><span class="string">controller:</span>replication-controller                               <span class="number">22</span>m</span><br><span class="line"><span class="string">system:</span><span class="string">controller:</span>resourcequota-controller                             <span class="number">22</span>m</span><br><span class="line"><span class="string">system:</span><span class="string">controller:</span>route-controller                                     <span class="number">22</span>m</span><br><span class="line"><span class="string">system:</span><span class="string">controller:</span>service-account-controller                           <span class="number">22</span>m</span><br><span class="line"><span class="string">system:</span><span class="string">controller:</span>service-controller                                   <span class="number">22</span>m</span><br><span class="line"><span class="string">system:</span><span class="string">controller:</span>statefulset-controller                               <span class="number">22</span>m</span><br><span class="line"><span class="string">system:</span><span class="string">controller:</span>ttl-controller                                       <span class="number">22</span>m</span><br><span class="line"><span class="string">system:</span>kube-controller-manager                                         <span class="number">22</span>m</span><br></pre></td></tr></table></figure></p>
<p>以 deployment controller 为例：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="keyword">describe</span> clusterrole <span class="keyword">system</span>:controller:deployment-controller</span><br><span class="line"><span class="keyword">Name</span>:         <span class="keyword">system</span>:controller:deployment-controller</span><br><span class="line">Labels:       kubernetes.io/bootstrapping=rbac-<span class="keyword">defaults</span></span><br><span class="line">Annotations:  rbac.authorization.kubernetes.io/autoupdate: <span class="literal">true</span></span><br><span class="line">PolicyRule:</span><br><span class="line">  Resources                          Non-<span class="keyword">Resource</span> URLs  <span class="keyword">Resource</span> <span class="keyword">Names</span>  Verbs</span><br><span class="line">  <span class="comment">---------                          -----------------  --------------  -----</span></span><br><span class="line">  replicasets.apps                   []                 []              [<span class="keyword">create</span> <span class="keyword">delete</span> <span class="keyword">get</span> <span class="keyword">list</span> <span class="keyword">patch</span> <span class="keyword">update</span> watch]</span><br><span class="line">  replicasets.extensions             []                 []              [<span class="keyword">create</span> <span class="keyword">delete</span> <span class="keyword">get</span> <span class="keyword">list</span> <span class="keyword">patch</span> <span class="keyword">update</span> watch]</span><br><span class="line">  <span class="keyword">events</span>                             []                 []              [<span class="keyword">create</span> <span class="keyword">patch</span> <span class="keyword">update</span>]</span><br><span class="line">  pods                               []                 []              [<span class="keyword">get</span> <span class="keyword">list</span> <span class="keyword">update</span> watch]</span><br><span class="line">  deployments.apps                   []                 []              [<span class="keyword">get</span> <span class="keyword">list</span> <span class="keyword">update</span> watch]</span><br><span class="line">  deployments.extensions             []                 []              [<span class="keyword">get</span> <span class="keyword">list</span> <span class="keyword">update</span> watch]</span><br><span class="line">  deployments.apps/finalizers        []                 []              [<span class="keyword">update</span>]</span><br><span class="line">  deployments.apps/<span class="keyword">status</span>            []                 []              [<span class="keyword">update</span>]</span><br><span class="line">  deployments.extensions/finalizers  []                 []              [<span class="keyword">update</span>]</span><br><span class="line">  deployments.extensions/<span class="keyword">status</span>      []                 []              [<span class="keyword">update</span>]</span><br></pre></td></tr></table></figure></p>
<p>查看当前的 leader<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">get</span> endpoints kube-controller-manager --namespace=kube-<span class="built_in">system</span> -o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Endpoints</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    control-plane.alpha.kubernetes.io/leader: '&#123;<span class="string">"holderIdentity"</span>:<span class="string">"k8s-master01_e225d712-c25f-11e9-831f-000c29b1069b"</span>,<span class="string">"leaseDurationSeconds"</span>:<span class="number">15</span>,<span class="string">"acquireTime"</span>:<span class="string">"2019-08-19T09:01:08Z"</span>,<span class="string">"renewTime"</span>:<span class="string">"2019-08-19T09:02:05Z"</span>,<span class="string">"leaderTransitions"</span>:<span class="number">0</span>&#125;'</span><br><span class="line">  creationTimestamp: <span class="string">"2019-08-19T09:01:08Z"</span></span><br><span class="line">  name: kube-controller-manager</span><br><span class="line">  namespace: kube-<span class="built_in">system</span></span><br><span class="line">  resourceVersion: <span class="string">"1925"</span></span><br><span class="line">  selfLink: /api/v1/namespaces/kube-<span class="built_in">system</span>/endpoints/kube-controller-manager</span><br><span class="line">  uid: e2299e08-c25f-<span class="number">11e9</span>-b490-<span class="number">000c29b1069b</span></span><br></pre></td></tr></table></figure></p>
<h1 id="部署kube-scheduler"><a href="#部署kube-scheduler" class="headerlink" title="部署kube-scheduler"></a>部署kube-scheduler</h1><p>创建 kube-scheduler 证书和私钥</p>
<p>创建证书签名请求<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/ssl/</span><br><span class="line">cat &gt; kube-scheduler-csr<span class="selector-class">.json</span> &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"system:kube-scheduler"</span>,</span><br><span class="line">    <span class="string">"hosts"</span>: [</span><br><span class="line">      <span class="string">"127.0.0.1"</span>,</span><br><span class="line">      <span class="string">"192.168.10.81"</span>,</span><br><span class="line">      <span class="string">"192.168.10.82"</span>,</span><br><span class="line">      <span class="string">"192.168.10.83"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: <span class="number">2048</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">        <span class="string">"ST"</span>: <span class="string">"GuangZhou"</span>,</span><br><span class="line">        <span class="string">"L"</span>: <span class="string">"GuangZhou"</span>,</span><br><span class="line">        <span class="string">"O"</span>: <span class="string">"system:kube-scheduler"</span>,</span><br><span class="line">        <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#hosts</span> 列表包含所有 kube-scheduler 节点 IP；</span><br><span class="line"><span class="selector-id">#CN</span> 和 O 均为 system:kube-scheduler，kubernetes 内置的 ClusterRoleBindings system:kube-scheduler 将赋予 kube-scheduler 工作所需的权限</span><br></pre></td></tr></table></figure></p>
<p>生成证书和私钥<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> /<span class="keyword">opt</span>/k8s/ssl</span><br><span class="line">cfssl gencert -<span class="keyword">ca</span>=/<span class="keyword">opt</span>/k8s/ssl/<span class="keyword">ca</span>.pem \</span><br><span class="line">  -<span class="keyword">ca</span>-key=/<span class="keyword">opt</span>/k8s/ssl/<span class="keyword">ca</span>-key.pem \</span><br><span class="line">  -config=/<span class="keyword">opt</span>/k8s/ssl/<span class="keyword">ca</span>-config.json \</span><br><span class="line">  -<span class="keyword">profile</span>=kubernetes kube-scheduler-csr.json | cfssljson -bare kube-scheduler</span><br></pre></td></tr></table></figure></p>
<p>生成kube-scheduler.kubeconfig 文件<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/cfg</span><br><span class="line">kubectl<span class="built_in"> config </span>set-cluster kubernetes \</span><br><span class="line">  <span class="attribute">--certificate-authority</span>=/opt/k8s/ssl/ca.pem \</span><br><span class="line">  <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line">  <span class="attribute">--server</span>=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=kube-scheduler.kubeconfig</span><br><span class="line">kubectl<span class="built_in"> config </span>set-credentials system:kube-scheduler \</span><br><span class="line">  <span class="attribute">--client-certificate</span>=/opt/k8s/ssl/kube-scheduler.pem \</span><br><span class="line">  <span class="attribute">--client-key</span>=/opt/k8s/ssl/kube-scheduler-key.pem \</span><br><span class="line">  <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=kube-scheduler.kubeconfig</span><br><span class="line">kubectl<span class="built_in"> config </span>set-context system:kube-scheduler \</span><br><span class="line">  <span class="attribute">--cluster</span>=kubernetes \</span><br><span class="line">  <span class="attribute">--user</span>=system:kube-scheduler \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=kube-scheduler.kubeconfig</span><br><span class="line">kubectl<span class="built_in"> config </span>use-context system:kube-scheduler <span class="attribute">--kubeconfig</span>=kube-scheduler.kubeconfig</span><br></pre></td></tr></table></figure></p>
<p>分发证书和私钥kubeconfig到所有 master 节点<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">source /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;</span>MASTER_IPS[@]&#125;;<span class="keyword">do</span></span><br><span class="line">    echo <span class="string">"&gt;&gt;&gt; $&#123;node_ip&#125;"</span></span><br><span class="line">    scp /opt/k8s/ssl/kube-scheduler*.pem root@<span class="variable">$&#123;</span>node_ip&#125;<span class="symbol">:/etc/kubernetes/ssl/</span></span><br><span class="line">    scp /opt/k8s/cfg/kube-scheduler.kubeconfig root@<span class="variable">$&#123;</span>node_ip&#125;<span class="symbol">:/etc/kubernetes/</span></span><br><span class="line">done</span><br></pre></td></tr></table></figure></p>
<p>创建 kube-scheduler 配置文件<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cd</span> <span class="string">/opt/k8s/cfg</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;kube-scheduler.yaml</span> <span class="string">&lt;&lt;EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubescheduler.config.k8s.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeSchedulerConfiguration</span></span><br><span class="line"><span class="attr">bindTimeoutSeconds:</span> <span class="number">600</span></span><br><span class="line"><span class="attr">clientConnection:</span></span><br><span class="line"><span class="attr">  burst:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">  kubeconfig:</span> <span class="string">"/etc/kubernetes/kube-scheduler.kubeconfig"</span></span><br><span class="line"><span class="attr">  qps:</span> <span class="number">100</span></span><br><span class="line"><span class="attr">enableContentionProfiling:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">enableProfiling:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">hardPodAffinitySymmetricWeight:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">healthzBindAddress:</span><span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:10251</span></span><br><span class="line"><span class="attr">leaderElection:</span></span><br><span class="line"><span class="attr">  leaderElect:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">metricsBindAddress:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:10251</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>--kubeconfig：指定 kubeconfig 文件路径，kube-scheduler 使用它连接和验证 kube-apiserver；</li>
<li>--leader-elect=true：集群运行模式，启用选举功能；被选为 leader 的节点负责处理工作，其它节点为阻塞状态；</li>
</ul>
<p>创建kube-scheduler启动文件<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/init</span><br><span class="line">cat &gt; kube-scheduler.service.template &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line"><span class="attribute">Description</span>=Kubernetes Scheduler</span><br><span class="line"><span class="attribute">Documentation</span>=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">[Service]</span><br><span class="line"><span class="attribute">WorkingDirectory</span>=<span class="variable">$&#123;K8S_DIR&#125;</span>/kube-scheduler</span><br><span class="line"><span class="attribute">ExecStart</span>=/usr/local/k8s/bin/kube-scheduler \\</span><br><span class="line">  <span class="attribute">--config</span>=/etc/kubernetes/kube-scheduler.yaml \\</span><br><span class="line">  <span class="attribute">--bind-address</span>=##NODE_IP## \\</span><br><span class="line">  <span class="attribute">--secure-port</span>=10259 \\</span><br><span class="line">  <span class="attribute">--port</span>=0 \\</span><br><span class="line">  <span class="attribute">--tls-cert-file</span>=/etc/kubernetes/ssl/kube-scheduler.pem \\</span><br><span class="line">  <span class="attribute">--tls-private-key-file</span>=/etc/kubernetes/ssl/kube-scheduler-key.pem \\</span><br><span class="line">  <span class="attribute">--authentication-kubeconfig</span>=/etc/kubernetes/kube-scheduler.kubeconfig \\</span><br><span class="line">  <span class="attribute">--client-ca-file</span>=/etc/kubernetes/ssl/ca.pem \\</span><br><span class="line">  <span class="attribute">--requestheader-allowed-names</span>=<span class="string">""</span> \\</span><br><span class="line">  <span class="attribute">--requestheader-client-ca-file</span>=/etc/kubernetes/ssl/ca.pem \\</span><br><span class="line">  <span class="attribute">--requestheader-extra-headers-prefix</span>=<span class="string">"X-Remote-Extra-"</span> \\</span><br><span class="line">  <span class="attribute">--requestheader-group-headers</span>=X-Remote-Group \\</span><br><span class="line">  <span class="attribute">--requestheader-username-headers</span>=X-Remote-User \\</span><br><span class="line">  <span class="attribute">--authorization-kubeconfig</span>=/etc/kubernetes/kube-scheduler.kubeconfig \\</span><br><span class="line">  <span class="attribute">--logtostderr</span>=<span class="literal">true</span> \\</span><br><span class="line">  <span class="attribute">--v</span>=2</span><br><span class="line"><span class="attribute">Restart</span>=always</span><br><span class="line"><span class="attribute">RestartSec</span>=5</span><br><span class="line"><span class="attribute">StartLimitInterval</span>=0</span><br><span class="line">[Install]</span><br><span class="line"><span class="attribute">WantedBy</span>=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<p>替换变量<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/init</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> (( i=0; i &lt; 3; i++ ));<span class="keyword">do</span></span><br><span class="line">    sed -e <span class="string">"s/##NODE_NAME##/<span class="variable">$&#123;MASTER_NAMES[i]&#125;</span>/"</span> -e <span class="string">"s/##NODE_IP##/<span class="variable">$&#123;MASTER_IPS[i]&#125;</span>/"</span> kube-scheduler.service.template &gt; kube-scheduler-<span class="variable">$&#123;MASTER_IPS[i]&#125;</span>.service </span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure></p>
<p>分发配置文件<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">source /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;</span>MASTER_IPS[@]&#125;;<span class="keyword">do</span></span><br><span class="line">    echo <span class="string">"&gt;&gt;&gt; $&#123;node_ip&#125;"</span></span><br><span class="line">    scp /opt/k8s/cfg/kube-scheduler.yaml root@<span class="variable">$&#123;</span>node_ip&#125;<span class="symbol">:/etc/kubernetes/kube-scheduler</span>.yaml</span><br><span class="line">    scp /opt/k8s/init/kube-scheduler-<span class="variable">$&#123;</span>node_ip&#125;.service root@<span class="variable">$&#123;</span>node_ip&#125;<span class="symbol">:/etc/systemd/system/kube-scheduler</span>.service</span><br><span class="line">done</span><br></pre></td></tr></table></figure></p>
<p>启动kube-scheduler<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;MASTER_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"mkdir -p <span class="variable">$&#123;K8S_DIR&#125;</span>/kube-scheduler"</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"systemctl daemon-reload &amp;&amp; systemctl enable kube-scheduler &amp;&amp; systemctl restart kube-scheduler"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure></p>
<p>检查服务运行状态<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;MASTER_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"systemctl status kube-scheduler|grep Active"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure></p>
<p>查看输出的 metrics</p>
<p>注意：以下命令在 kube-scheduler 节点上执行。</p>
<p>kube-scheduler 监听 10251 和 10251 端口：<br>10251：接收 http 请求，非安全端口，不需要认证授权；<br>10259：接收 https 请求，安全端口，需要认证授权；<br>两个接口都对外提供 /metrics 和 /healthz 的访问。<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">curl -s http:<span class="comment">//192.168.10.81:10251/metrics|head</span></span><br><span class="line"><span class="meta"># HELP apiserver_audit_event_total Counter of audit events generated and sent to the audit backend.</span></span><br><span class="line"><span class="meta"># TYPE apiserver_audit_event_total counter</span></span><br><span class="line">apiserver_audit_event_total <span class="number">0</span></span><br><span class="line"><span class="meta"># HELP apiserver_audit_requests_rejected_total Counter of apiserver requests rejected due to an error in audit logging backend.</span></span><br><span class="line"><span class="meta"># TYPE apiserver_audit_requests_rejected_total counter</span></span><br><span class="line">apiserver_audit_requests_rejected_total <span class="number">0</span></span><br><span class="line"><span class="meta"># HELP apiserver_client_certificate_expiration_seconds Distribution of the remaining lifetime on the certificate used to authenticate a request.</span></span><br><span class="line"><span class="meta"># TYPE apiserver_client_certificate_expiration_seconds histogram</span></span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"0"</span>&#125; <span class="number">0</span></span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"1800"</span>&#125; <span class="number">0</span></span><br></pre></td></tr></table></figure></p>
<p>查看当前leader<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">get</span> endpoints kube-scheduler --namespace=kube-<span class="built_in">system</span>  -o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Endpoints</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    control-plane.alpha.kubernetes.io/leader: '&#123;<span class="string">"holderIdentity"</span>:<span class="string">"k8s-master02_6360c5c0-c262-11e9-a2b9-000c29e02350"</span>,<span class="string">"leaseDurationSeconds"</span>:<span class="number">15</span>,<span class="string">"acquireTime"</span>:<span class="string">"2019-08-19T09:19:21Z"</span>,<span class="string">"renewTime"</span>:<span class="string">"2019-08-19T09:19:51Z"</span>,<span class="string">"leaderTransitions"</span>:<span class="number">1</span>&#125;'</span><br><span class="line">  creationTimestamp: <span class="string">"2019-08-19T09:18:54Z"</span></span><br><span class="line">  name: kube-scheduler</span><br><span class="line">  namespace: kube-<span class="built_in">system</span></span><br><span class="line">  resourceVersion: <span class="string">"2799"</span></span><br><span class="line">  selfLink: /api/v1/namespaces/kube-<span class="built_in">system</span>/endpoints/kube-scheduler</span><br><span class="line">  uid: 5da1ecf2-c262-<span class="number">11e9</span>-b490-<span class="number">000c29b1069b</span></span><br></pre></td></tr></table></figure></p>
<h1 id="部署node组件"><a href="#部署node组件" class="headerlink" title="部署node组件"></a>部署node组件</h1><p>分发node二进制<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/pkg</span><br><span class="line">source /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;</span>NODE_IPS[@]&#125;;<span class="keyword">do</span></span><br><span class="line">    echo <span class="string">"&gt;&gt;&gt; $&#123;node_ip&#125;"</span></span><br><span class="line">    ssh root@<span class="variable">$node_ip</span> <span class="string">"mkdir -p /usr/local/k8s/bin"</span></span><br><span class="line">    scp kubernetes/server/bin/&#123;kube-proxy,kubelet&#125; root@<span class="variable">$&#123;</span>node_ip&#125;<span class="symbol">:/usr/local/k8s/bin/</span></span><br><span class="line">done</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>Docker步骤需要在所有node节点安装</p>
</blockquote>
<p>若是需要master也作为node节点加入集群，也需要在master节点部署docker、kubelet、kube-proxy。<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -<span class="keyword">y</span> yum-utils device-mapper-persistent-data lvm2</span><br><span class="line">yum-config-manager --<span class="built_in">add</span>-repo http://mirrors.aliyun.<span class="keyword">com</span>/docker-<span class="keyword">ce</span>/linux/centos/docker-<span class="keyword">ce</span>.repo</span><br><span class="line">yum -<span class="keyword">y</span> install docker-<span class="keyword">ce</span></span><br></pre></td></tr></table></figure></p>
<p>创建配置文件<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> /<span class="keyword">opt</span>/k8s/cfg</span><br><span class="line"><span class="keyword">cat</span> &gt; daemon.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"exec-opts"</span>: [<span class="string">"native.cgroupdriver=systemd"</span>],</span><br><span class="line">  <span class="string">"registry-mirrors"</span>: [<span class="string">"https://docker.mirrors.ustc.edu.cn"</span>,<span class="string">"https://hub-mirror.c.163.com"</span>],</span><br><span class="line">  <span class="string">"log-driver"</span>: <span class="string">"json-file"</span>,</span><br><span class="line">  <span class="string">"log-opts"</span>: &#123;</span><br><span class="line">    <span class="string">"max-size"</span>: <span class="string">"100m"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"storage-driver"</span>: <span class="string">"overlay2"</span></span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<p>启动docker服务<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">source /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;</span>NODE_IPS[@]&#125;;<span class="keyword">do</span></span><br><span class="line">    echo <span class="string">"&gt;&gt;&gt; $&#123;node_ip&#125;"</span></span><br><span class="line">    scp /opt/k8s/cfg/daemon.json root@<span class="variable">$&#123;</span>node_ip&#125;<span class="symbol">:/etc/docker/daemon</span>.json</span><br><span class="line">    ssh root@<span class="variable">$&#123;</span>node_ip&#125; <span class="string">"systemctl daemon-reload &amp;&amp; systemctl enable docker &amp;&amp; systemctl restart docker"</span></span><br><span class="line">done</span><br></pre></td></tr></table></figure></p>
<h1 id="部署kubelet组件"><a href="#部署kubelet组件" class="headerlink" title="部署kubelet组件"></a>部署kubelet组件</h1><p>kubelet运行在每个worker节点上，接收kube-apiserver发送的请求，管理Pod容器，执行交互命令<br>kubelet启动时自动向kube-apiserver注册节点信息，内置的cAdivsor统计和监控节点的资源使用资源情况。为确保安全，部署时关闭了kubelet的非安全http端口，对请求进行认证和授权，拒绝未授权的访问</p>
<p>创建kubelet-bootstrap-kubeconfig文件<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/cfg</span><br><span class="line">source /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_name <span class="keyword">in</span> <span class="variable">$&#123;NODE_NAMES[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    echo <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_name&#125;</span>"</span></span><br><span class="line">    # 创建 token</span><br><span class="line">    <span class="builtin-name">export</span> <span class="attribute">BOOTSTRAP_TOKEN</span>=$(kubeadm token create \</span><br><span class="line">      --description kubelet-bootstrap-token \</span><br><span class="line">      --groups system:bootstrappers:<span class="variable">$&#123;node_name&#125;</span> \</span><br><span class="line">      --kubeconfig ~/.kube/config)</span><br><span class="line">    # 设置集群参数</span><br><span class="line">    kubectl<span class="built_in"> config </span>set-cluster kubernetes \</span><br><span class="line">      <span class="attribute">--certificate-authority</span>=/opt/k8s/ssl/ca.pem \</span><br><span class="line">      <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line">      <span class="attribute">--server</span>=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">      <span class="attribute">--kubeconfig</span>=kubelet-bootstrap-$&#123;node_name&#125;.kubeconfig</span><br><span class="line">    # 设置客户端认证参数</span><br><span class="line">    kubectl<span class="built_in"> config </span>set-credentials kubelet-bootstrap \</span><br><span class="line">      <span class="attribute">--token</span>=<span class="variable">$&#123;BOOTSTRAP_TOKEN&#125;</span> \</span><br><span class="line">      <span class="attribute">--kubeconfig</span>=kubelet-bootstrap-$&#123;node_name&#125;.kubeconfig</span><br><span class="line">    # 设置上下文参数</span><br><span class="line">    kubectl<span class="built_in"> config </span>set-context<span class="built_in"> default </span>\</span><br><span class="line">      <span class="attribute">--cluster</span>=kubernetes \</span><br><span class="line">      <span class="attribute">--user</span>=kubelet-bootstrap \</span><br><span class="line">      <span class="attribute">--kubeconfig</span>=kubelet-bootstrap-$&#123;node_name&#125;.kubeconfig</span><br><span class="line">    # 设置默认上下文</span><br><span class="line">    kubectl<span class="built_in"> config </span>use-context<span class="built_in"> default </span><span class="attribute">--kubeconfig</span>=kubelet-bootstrap-$&#123;node_name&#125;.kubeconfig</span><br><span class="line">done</span><br></pre></td></tr></table></figure></p>
<p>查看kubeadm为各个节点创建的token<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@k8s-master01 cfg]</span># <span class="selector-tag">kubeadm</span> <span class="selector-tag">token</span> <span class="selector-tag">list</span> <span class="selector-tag">--kubeconfig</span> ~/<span class="selector-class">.kube</span>/<span class="selector-tag">config</span></span><br><span class="line"><span class="selector-tag">TOKEN</span>                     <span class="selector-tag">TTL</span>       <span class="selector-tag">EXPIRES</span>                     <span class="selector-tag">USAGES</span>                   <span class="selector-tag">DESCRIPTION</span>               <span class="selector-tag">EXTRA</span> <span class="selector-tag">GROUPS</span></span><br><span class="line"><span class="selector-tag">2wpre5</span><span class="selector-class">.7w2lu07fys9m70ix</span>   <span class="selector-tag">23h</span>       <span class="selector-tag">2019-08-24T07</span><span class="selector-pseudo">:20</span><span class="selector-pseudo">:04-04</span><span class="selector-pseudo">:00</span>   <span class="selector-tag">authentication</span>,<span class="selector-tag">signing</span>   <span class="selector-tag">kubelet-bootstrap-token</span>   <span class="selector-tag">system</span><span class="selector-pseudo">:bootstrappers</span><span class="selector-pseudo">:k8s-node02</span></span><br><span class="line"><span class="selector-tag">c6h4x1</span><span class="selector-class">.8rsetjp05ooj43vq</span>   <span class="selector-tag">23h</span>       <span class="selector-tag">2019-08-24T07</span><span class="selector-pseudo">:20</span><span class="selector-pseudo">:03-04</span><span class="selector-pseudo">:00</span>   <span class="selector-tag">authentication</span>,<span class="selector-tag">signing</span>   <span class="selector-tag">kubelet-bootstrap-token</span>   <span class="selector-tag">system</span><span class="selector-pseudo">:bootstrappers</span><span class="selector-pseudo">:k8s-master01</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>token有效期为1天，超期后将不能被用来bootstrap kubelet，且会被kube-controller-manager的token cleaner清理<br>kube-apiserver接收kubelet的bootstrap token后，将请求的user设置为system:bootstrap; group设置为system:bootstrappers，后续将为这个group设置ClusterRoleBinding<br>查看各token关联的Secret<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 cfg]#  kubectl get secrets  -<span class="keyword">n</span> kube-system|grep <span class="keyword">bootstrap</span>-<span class="keyword">token</span></span><br><span class="line"><span class="keyword">bootstrap</span>-<span class="keyword">token</span>-2wpre5                           <span class="keyword">bootstrap</span>.kubernetes.io/<span class="keyword">token</span>         7      51s</span><br><span class="line"><span class="keyword">bootstrap</span>-<span class="keyword">token</span>-c6h4x1                           <span class="keyword">bootstrap</span>.kubernetes.io/<span class="keyword">token</span>         7      52s</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>分发 bootstrap kubeconfig 文件到所有node节点<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/cfg</span><br><span class="line">source /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_name <span class="keyword">in</span> <span class="variable">$&#123;</span>NODE_NAMES[@]&#125;;<span class="keyword">do</span></span><br><span class="line">    echo <span class="string">"&gt;&gt;&gt; $&#123;node_name&#125;"</span></span><br><span class="line">    scp kubelet-bootstrap-<span class="variable">$&#123;</span>node_name&#125;.kubeconfig root@<span class="variable">$&#123;</span>node_name&#125;<span class="symbol">:/etc/kubernetes/kubelet-bootstrap</span>.kubeconfig</span><br><span class="line">done</span><br></pre></td></tr></table></figure></p>
<p>创建kubelet参数配置<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">cd <span class="regexp">/opt/</span>k8s/cfg</span><br><span class="line">source <span class="regexp">/opt/</span>k8s/environment.sh</span><br><span class="line">cat &gt; kubelet-config.yaml.template &lt;&lt;EOF</span><br><span class="line"><span class="string">kind:</span> KubeletConfiguration</span><br><span class="line"><span class="string">apiVersion:</span> kubelet.config.k8s.io/v1beta1</span><br><span class="line"><span class="string">address:</span> <span class="string">"##NODE_IP##"</span></span><br><span class="line"><span class="string">staticPodPath:</span> <span class="string">""</span></span><br><span class="line"><span class="string">syncFrequency:</span> <span class="number">1</span>m</span><br><span class="line"><span class="string">fileCheckFrequency:</span> <span class="number">20</span>s</span><br><span class="line"><span class="string">httpCheckFrequency:</span> <span class="number">20</span>s</span><br><span class="line"><span class="string">staticPodURL:</span> <span class="string">""</span></span><br><span class="line"><span class="string">port:</span> <span class="number">10250</span></span><br><span class="line"><span class="string">readOnlyPort:</span> <span class="number">0</span></span><br><span class="line"><span class="string">rotateCertificates:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">serverTLSBootstrap:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">authentication:</span></span><br><span class="line"><span class="symbol">  anonymous:</span></span><br><span class="line"><span class="symbol">    enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="symbol">  webhook:</span></span><br><span class="line"><span class="symbol">    enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="symbol">  x509:</span></span><br><span class="line"><span class="symbol">    clientCAFile:</span> <span class="string">"/etc/kubernetes/ssl/ca.pem"</span></span><br><span class="line"><span class="string">authorization:</span></span><br><span class="line"><span class="symbol">  mode:</span> Webhook</span><br><span class="line"><span class="string">registryPullQPS:</span> <span class="number">0</span></span><br><span class="line"><span class="string">registryBurst:</span> <span class="number">20</span></span><br><span class="line"><span class="string">eventRecordQPS:</span> <span class="number">0</span></span><br><span class="line"><span class="string">eventBurst:</span> <span class="number">20</span></span><br><span class="line"><span class="string">enableDebuggingHandlers:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">enableContentionProfiling:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">healthzPort:</span> <span class="number">10248</span></span><br><span class="line"><span class="string">healthzBindAddress:</span> <span class="string">"##NODE_IP##"</span></span><br><span class="line"><span class="string">clusterDomain:</span> <span class="string">"$&#123;CLUSTER_DNS_DOMAIN&#125;"</span></span><br><span class="line"><span class="string">clusterDNS:</span></span><br><span class="line">  - <span class="string">"$&#123;CLUSTER_DNS_SVC_IP&#125;"</span></span><br><span class="line"><span class="string">nodeStatusUpdateFrequency:</span> <span class="number">10</span>s</span><br><span class="line"><span class="string">nodeStatusReportFrequency:</span> <span class="number">1</span>m</span><br><span class="line"><span class="string">imageMinimumGCAge:</span> <span class="number">2</span>m</span><br><span class="line"><span class="string">imageGCHighThresholdPercent:</span> <span class="number">85</span></span><br><span class="line"><span class="string">imageGCLowThresholdPercent:</span> <span class="number">80</span></span><br><span class="line"><span class="string">volumeStatsAggPeriod:</span> <span class="number">1</span>m</span><br><span class="line"><span class="string">kubeletCgroups:</span> <span class="string">""</span></span><br><span class="line"><span class="string">systemCgroups:</span> <span class="string">""</span></span><br><span class="line"><span class="string">cgroupRoot:</span> <span class="string">""</span></span><br><span class="line"><span class="string">cgroupsPerQOS:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">cgroupDriver:</span> systemd</span><br><span class="line"><span class="string">runtimeRequestTimeout:</span> <span class="number">10</span>m</span><br><span class="line"><span class="string">hairpinMode:</span> promiscuous-bridge</span><br><span class="line"><span class="string">maxPods:</span> <span class="number">220</span></span><br><span class="line"><span class="string">podCIDR:</span> <span class="string">"$&#123;CLUSTER_CIDR&#125;"</span></span><br><span class="line"><span class="string">podPidsLimit:</span> <span class="number">-1</span></span><br><span class="line"><span class="string">resolvConf:</span> <span class="regexp">/etc/</span>resolv.conf</span><br><span class="line"><span class="string">maxOpenFiles:</span> <span class="number">1000000</span></span><br><span class="line"><span class="string">kubeAPIQPS:</span> <span class="number">1000</span></span><br><span class="line"><span class="string">kubeAPIBurst:</span> <span class="number">2000</span></span><br><span class="line"><span class="string">serializeImagePulls:</span> <span class="literal">false</span></span><br><span class="line"><span class="string">evictionHard:</span></span><br><span class="line">  memory.<span class="string">available:</span>  <span class="string">"100Mi"</span></span><br><span class="line">nodefs.<span class="string">available:</span>  <span class="string">"10%"</span></span><br><span class="line">nodefs.<span class="string">inodesFree:</span> <span class="string">"5%"</span></span><br><span class="line">imagefs.<span class="string">available:</span> <span class="string">"15%"</span></span><br><span class="line"><span class="string">evictionSoft:</span> &#123;&#125;</span><br><span class="line"><span class="string">enableControllerAttachDetach:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">failSwapOn:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">containerLogMaxSize:</span> <span class="number">20</span>Mi</span><br><span class="line"><span class="string">containerLogMaxFiles:</span> <span class="number">10</span></span><br><span class="line"><span class="string">systemReserved:</span> &#123;&#125;</span><br><span class="line"><span class="string">kubeReserved:</span> &#123;&#125;</span><br><span class="line"><span class="string">systemReservedCgroup:</span> <span class="string">""</span></span><br><span class="line"><span class="string">kubeReservedCgroup:</span> <span class="string">""</span></span><br><span class="line"><span class="string">enforceNodeAllocatable:</span> [<span class="string">"pods"</span>]</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">address：kubelet 安全端口（https，<span class="number">10250</span>）监听的地址，不能为 <span class="number">127.0</span>.<span class="number">0.1</span>，否则 kube-apiserver、heapster 等不能调用 kubelet 的 API；</span><br><span class="line">readOnlyPort=<span class="number">0</span>：关闭只读端口(默认 <span class="number">10255</span>)，等效为未指定；</span><br><span class="line">authentication<span class="selector-class">.anonymous</span><span class="selector-class">.enabled</span>：设置为 false，不允许匿访问 <span class="number">10250</span> 端口；</span><br><span class="line">authentication<span class="selector-class">.x509</span><span class="selector-class">.clientCAFile</span>：指定签名客户端证书的 CA 证书，开启 HTTP 证书认证；</span><br><span class="line">authentication<span class="selector-class">.webhook</span><span class="selector-class">.enabled</span>=true：开启 HTTPs bearer token 认证；</span><br><span class="line">对于未通过 x509 证书和 webhook 认证的请求(kube-apiserver 或其他客户端)，将被拒绝，提示 Unauthorized；</span><br><span class="line">authroization.mode=Webhook：kubelet 使用 SubjectAccessReview API 查询 kube-apiserver 某 user、group 是否具有操作资源的权限(RBAC)；</span><br><span class="line">featureGates.RotateKubeletClientCertificate、featureGates.RotateKubeletServerCertificate：自动 rotate 证书，证书的有效期取决于 kube-controller-manager 的 --experimental-cluster-signing-duration 参数；</span><br></pre></td></tr></table></figure>
<p>变量替换分发<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/cfg</span><br><span class="line">source /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;</span>NODE_IPS[@]&#125;;<span class="keyword">do</span> </span><br><span class="line">    echo <span class="string">"&gt;&gt;&gt; $&#123;node_ip&#125;"</span></span><br><span class="line">    sed -e <span class="string">"s/##NODE_IP##/$&#123;node_ip&#125;/"</span> kubelet-config.yaml.template &gt; kubelet-config-<span class="variable">$&#123;</span>node_ip&#125;.yaml.template</span><br><span class="line">    scp kubelet-config-<span class="variable">$&#123;</span>node_ip&#125;.yaml.template root@<span class="variable">$&#123;</span>node_ip&#125;<span class="symbol">:/etc/kubernetes/kubelet-config</span>.yaml</span><br><span class="line">    scp /opt/k8s/ssl/ca.pem root@<span class="variable">$&#123;</span>node_ip&#125;<span class="symbol">:/etc/kubernetes/ssl/</span></span><br><span class="line">done</span><br></pre></td></tr></table></figure></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/init</span><br><span class="line">source /opt/k8s/environment.sh</span><br><span class="line">cat &gt; kubelet.service.template &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line"><span class="attribute">Description</span>=Kubernetes Kubelet</span><br><span class="line"><span class="attribute">Documentation</span>=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"><span class="attribute">After</span>=docker.service</span><br><span class="line"><span class="attribute">Requires</span>=docker.service</span><br><span class="line">[Service]</span><br><span class="line"><span class="attribute">WorkingDirectory</span>=<span class="variable">$&#123;K8S_DIR&#125;</span>/kubelet</span><br><span class="line"><span class="attribute">ExecStart</span>=/usr/local/k8s/bin/kubelet \\</span><br><span class="line">  <span class="attribute">--allow-privileged</span>=<span class="literal">true</span> \\</span><br><span class="line">  <span class="attribute">--bootstrap-kubeconfig</span>=/etc/kubernetes/kubelet-bootstrap.kubeconfig \\</span><br><span class="line">  <span class="attribute">--cert-dir</span>=/etc/kubernetes/ssl \\</span><br><span class="line">  <span class="attribute">--cni-conf-dir</span>=/etc/cni/net.d \\</span><br><span class="line">  <span class="attribute">--container-runtime</span>=docker \\</span><br><span class="line">  <span class="attribute">--container-runtime-endpoint</span>=unix:///var/run/dockershim.sock \\</span><br><span class="line">  <span class="attribute">--root-dir</span>=<span class="variable">$&#123;K8S_DIR&#125;</span>/kubelet \\</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=/etc/kubernetes/kubelet.kubeconfig \\</span><br><span class="line">  <span class="attribute">--config</span>=/etc/kubernetes/kubelet-config.yaml \\</span><br><span class="line">  <span class="attribute">--hostname-override</span>=##NODE_NAME## \\</span><br><span class="line">  <span class="attribute">--pod-infra-container-image</span>=gcr.azk8s.cn/google_containers/pause-amd64:3.1 \\</span><br><span class="line">  <span class="attribute">--image-pull-progress-deadline</span>=15m \\</span><br><span class="line">  <span class="attribute">--volume-plugin-dir</span>=<span class="variable">$&#123;K8S_DIR&#125;</span>/kubelet/kubelet-plugins/volume/exec/ \\</span><br><span class="line">  <span class="attribute">--logtostderr</span>=<span class="literal">true</span> \\</span><br><span class="line">  <span class="attribute">--v</span>=2</span><br><span class="line"><span class="attribute">Restart</span>=always</span><br><span class="line"><span class="attribute">RestartSec</span>=5</span><br><span class="line"><span class="attribute">StartLimitInterval</span>=0</span><br><span class="line">[Install]</span><br><span class="line"><span class="attribute">WantedBy</span>=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>变量替换分发<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/init</span><br><span class="line">source /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_name <span class="keyword">in</span> <span class="variable">$&#123;NODE_NAMES[@]&#125;</span>;<span class="keyword">do</span> </span><br><span class="line">    echo <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_name&#125;</span>"</span></span><br><span class="line">    sed -e <span class="string">"s/##NODE_NAME##/<span class="variable">$&#123;node_name&#125;</span>/"</span> kubelet.service.template &gt; kubelet-<span class="variable">$&#123;node_name&#125;</span>.service</span><br><span class="line">    scp kubelet-<span class="variable">$&#123;node_name&#125;</span>.service root@<span class="variable">$&#123;node_name&#125;</span>:/etc/systemd/system/kubelet.service</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"><span class="comment">#Bootstrap Token Auth 和授予权限 kubelet 启动时查找 --kubeletconfig</span></span><br><span class="line">参数对应的文件是否存在，如果不存在则使用 --bootstrap-kubeconfig 指定的 kubeconfig 文件向</span><br><span class="line">kube-apiserver 发送证书签名请求 (CSR)。 kube-apiserver 收到 CSR 请求后，对其中的 Token</span><br><span class="line">进行认证，认证通过后将请求的<span class="built_in"> user </span>设置为 system:bootstrap:，group 设置为</span><br><span class="line">system:bootstrappers，这一过程称为 Bootstrap Token Auth。</span><br></pre></td></tr></table></figure></p>
<p>创建user和group的CSR权限，不创建kubelet会启动失败<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding kubelet-bootstrap --<span class="attr">clusterrole=</span>system:<span class="keyword">node</span><span class="title">-bootstrapper</span> --<span class="attr">group=</span>system:bootstrappers</span><br></pre></td></tr></table></figure></p>
<p>启动 kubelet 服务<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"mkdir -p <span class="variable">$&#123;K8S_DIR&#125;</span>/kubelet/kubelet-plugins/volume/exec/"</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"systemctl daemon-reload &amp;&amp; systemctl enable kubelet &amp;&amp; systemctl restart kubelet"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cd</span> <span class="string">/opt/k8s/cfg</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt; csr-crb.yaml &lt;&lt;EOF</span></span><br><span class="line"><span class="string"> # Approve all CSRs for the group "system:bootstrappers"</span></span><br><span class="line"><span class="string"></span><span class="attr"> kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr"> apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr"> metadata:</span></span><br><span class="line"><span class="attr">   name:</span> <span class="string">auto-approve-csrs-for-group</span></span><br><span class="line"><span class="attr"> subjects:</span></span><br><span class="line"><span class="attr"> - kind:</span> <span class="string">Group</span></span><br><span class="line"><span class="attr">   name:</span> <span class="attr">system:bootstrappers</span></span><br><span class="line"><span class="attr">   apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr"> roleRef:</span></span><br><span class="line"><span class="attr">   kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">   name:</span> <span class="attr">system:certificates.k8s.io:certificatesigningrequests:nodeclient</span></span><br><span class="line"><span class="attr">   apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"> <span class="comment"># To let a node of the group "system:nodes" renew its own credentials</span></span><br><span class="line"><span class="attr"> kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr"> apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr"> metadata:</span></span><br><span class="line"><span class="attr">   name:</span> <span class="string">node-client-cert-renewal</span></span><br><span class="line"><span class="attr"> subjects:</span></span><br><span class="line"><span class="attr"> - kind:</span> <span class="string">Group</span></span><br><span class="line"><span class="attr">   name:</span> <span class="attr">system:nodes</span></span><br><span class="line"><span class="attr">   apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr"> roleRef:</span></span><br><span class="line"><span class="attr">   kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">   name:</span> <span class="attr">system:certificates.k8s.io:certificatesigningrequests:selfnodeclient</span></span><br><span class="line"><span class="attr">   apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># A ClusterRole which instructs the CSR approver to approve a node requesting a</span></span><br><span class="line"><span class="comment"># serving cert matching its client cert.</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">approve-node-server-renewal-csr</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">- apiGroups:</span> <span class="string">["certificates.k8s.io"]</span></span><br><span class="line"><span class="attr">  resources:</span> <span class="string">["certificatesigningrequests/selfnodeserver"]</span></span><br><span class="line"><span class="attr">  verbs:</span> <span class="string">["create"]</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"> <span class="comment"># To let a node of the group "system:nodes" renew its own server credentials</span></span><br><span class="line"><span class="attr"> kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr"> apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr"> metadata:</span></span><br><span class="line"><span class="attr">   name:</span> <span class="string">node-server-cert-renewal</span></span><br><span class="line"><span class="attr"> subjects:</span></span><br><span class="line"><span class="attr"> - kind:</span> <span class="string">Group</span></span><br><span class="line"><span class="attr">   name:</span> <span class="attr">system:nodes</span></span><br><span class="line"><span class="attr">   apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr"> roleRef:</span></span><br><span class="line"><span class="attr">   kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">   name:</span> <span class="string">approve-node-server-renewal-csr</span></span><br><span class="line"><span class="attr">   apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="bullet">-f</span> <span class="string">csr-crb.yaml</span></span><br></pre></td></tr></table></figure>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 cfg]<span class="comment"># kubectl get csr</span></span><br><span class="line">NAME        AGE     REQUESTOR                 CONDITION</span><br><span class="line">csr-<span class="number">4h</span>wzt   <span class="number">3m</span>20s   system:<span class="keyword">node</span><span class="title">:k8s-node01</span>    Pending</span><br><span class="line">csr-ft87k   <span class="number">12m</span>     system:bootstrap:<span class="number">2</span>wpre5   Approved,Issued</span><br><span class="line">csr-mn4mb   <span class="number">2s</span>      system:<span class="keyword">node</span><span class="title">:k8s-node02</span>    Pending</span><br><span class="line">csr-wknjd   <span class="number">12m</span>     system:bootstrap:c6h4x1   Approved,Issued</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 cfg]# kubectl get nodes</span><br><span class="line">NAME         STATUS   ROLES    AGE     VERSION</span><br><span class="line">k8s-node01   Ready    &lt;none&gt;   <span class="number">3</span>m41s   v1<span class="number">.14</span><span class="number">.2</span></span><br><span class="line">k8s-node02   Ready    &lt;none&gt;   <span class="number">3</span>m41s   v1<span class="number">.14</span><span class="number">.2</span></span><br><span class="line">k8s-master01   Ready    &lt;none&gt;   <span class="number">3</span>m41s   v1<span class="number">.14</span><span class="number">.2</span> </span><br><span class="line">k8s-master02   Ready    &lt;none&gt;   <span class="number">3</span>m41s   v1<span class="number">.14</span><span class="number">.2</span> </span><br><span class="line">k8s-master03   Ready    &lt;none&gt;   <span class="number">3</span>m41s   v1<span class="number">.14</span><span class="number">.2</span></span><br></pre></td></tr></table></figure>
<p>手动approve server cert csr<br>基于安全考虑，CSR approving controllers不会自动approve kubelet server证书签名请求，需要手动approve<br><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get csr | <span class="type">grep</span> Pending | <span class="type">awk</span> '&#123;print $<span class="number">1</span>&#125;' | <span class="type">xargs</span> kubectl certificate approve</span><br></pre></td></tr></table></figure></p>
<p>bear token认证和授权<br>创建一个ServiceAccount，将它和ClusterRole system:kubelet-api-admin绑定，从而具有调用kubelet API的权限<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl create <span class="keyword">sa</span> kubelet-api-<span class="keyword">test</span></span><br><span class="line">kubectl create clusterrolebinding kubelet-api-<span class="keyword">test</span> --clusterrole=system:kubelet-api-admin --serviceaccount=default:kubelet-api-<span class="keyword">test</span></span><br><span class="line">SECRET=$(kubectl get secrets | grep kubelet-api-<span class="keyword">test</span> | awk '&#123;<span class="keyword">print</span> <span class="variable">$1&#125;</span>')</span><br><span class="line"><span class="keyword">TOKEN</span>=$(kubectl <span class="keyword">describe</span> secret <span class="variable">$&#123;SECRET&#125;</span> | grep -<span class="keyword">E</span> '^<span class="keyword">token</span>' | awk '&#123;<span class="keyword">print</span> <span class="variable">$2&#125;</span>')</span><br><span class="line">echo <span class="variable">$&#123;TOKEN&#125;</span></span><br></pre></td></tr></table></figure></p>
<h1 id="部署kube-proxy"><a href="#部署kube-proxy" class="headerlink" title="部署kube-proxy"></a>部署kube-proxy</h1><blockquote>
<p>确保已加载ipvs conntrack 模块</p>
</blockquote>
<p>kube-proxy运行在所有worker节点上，它监听apiserver中service和endpoint的变化情况，创建路由规则提供服务IP和负载均衡功能。这里使用ipvs模式的kube-proxy进行部署</p>
<p>创建 kube-proxy 证书<br>创建证书签名请求</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> /<span class="keyword">opt</span>/k8s/ssl</span><br><span class="line"><span class="keyword">cat</span> &gt; kube-proxy-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"system:kube-proxy"</span>,</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: <span class="number">2048</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"GuangZhou"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"GuangZhou"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>CN：指定该证书的 User 为 system:kube-proxy；</li>
<li>预定义的 RoleBinding system:node-proxier 将User system:kube-proxy 与 Role system:node-proxier 绑定，该 Role 授予了调用 kube-apiserver Proxy 相关 API 的权限；</li>
<li>该证书只会被 kube-proxy 当做 client 证书使用，所以 hosts 字段为空</li>
</ul>
<p>生成证书和私钥<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> /<span class="keyword">opt</span>/k8s/ssl</span><br><span class="line">cfssl gencert -<span class="keyword">ca</span>=/<span class="keyword">opt</span>/k8s/ssl/<span class="keyword">ca</span>.pem \</span><br><span class="line">  -<span class="keyword">ca</span>-key=/<span class="keyword">opt</span>/k8s/ssl/<span class="keyword">ca</span>-key.pem \</span><br><span class="line">  -config=/<span class="keyword">opt</span>/k8s/ssl/<span class="keyword">ca</span>-config.json \</span><br><span class="line">  -<span class="keyword">profile</span>=kubernetes  kube-proxy-csr.json | cfssljson -bare kube-proxy</span><br></pre></td></tr></table></figure></p>
<p>创建kube-proxy.kubeconfig<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/cfg</span><br><span class="line">source /opt/k8s/environment.sh</span><br><span class="line">kubectl<span class="built_in"> config </span>set-cluster kubernetes \</span><br><span class="line">  <span class="attribute">--certificate-authority</span>=/opt/k8s/ssl/ca.pem \</span><br><span class="line">  <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line">  <span class="attribute">--server</span>=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=kube-proxy.kubeconfig</span><br><span class="line">kubectl<span class="built_in"> config </span>set-credentials kube-proxy \</span><br><span class="line">  <span class="attribute">--client-certificate</span>=/opt/k8s/ssl/kube-proxy.pem \</span><br><span class="line">  <span class="attribute">--client-key</span>=/opt/k8s/ssl/kube-proxy-key.pem \</span><br><span class="line">  <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=kube-proxy.kubeconfig</span><br><span class="line">kubectl<span class="built_in"> config </span>set-context<span class="built_in"> default </span>\</span><br><span class="line">  <span class="attribute">--cluster</span>=kubernetes \</span><br><span class="line">  <span class="attribute">--user</span>=kube-proxy \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=kube-proxy.kubeconfig</span><br><span class="line">kubectl<span class="built_in"> config </span>use-context<span class="built_in"> default </span><span class="attribute">--kubeconfig</span>=kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure></p>
<p>--embed-certs=true：将 ca.pem 和 admin.pem 证书内容嵌入到生成的kubectl-proxy.kubeconfig文件中(不加时，写入的是证书文件路径)；</p>
<p>分发 kube-proxy.kubeconfig 文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/cfg</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_name <span class="keyword">in</span> <span class="variable">$&#123;NODE_NAMES[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_name&#125;</span>"</span></span><br><span class="line">    scp kube-proxy.kubeconfig root@<span class="variable">$&#123;node_name&#125;</span>:/etc/kubernetes/</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure></p>
<p>创建kube-proxy配置文件<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cd</span> <span class="string">/opt/k8s/cfg</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt; kube-proxy-config.yaml.template &lt;&lt;EOF</span></span><br><span class="line"><span class="string"></span><span class="attr">kind:</span> <span class="string">KubeProxyConfiguration</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeproxy.config.k8s.io/v1alpha1</span></span><br><span class="line"><span class="attr">clientConnection:</span></span><br><span class="line"><span class="attr">  burst:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">  kubeconfig:</span> <span class="string">"/etc/kubernetes/kube-proxy.kubeconfig"</span></span><br><span class="line"><span class="attr">  qps:</span> <span class="number">100</span></span><br><span class="line"><span class="attr">bindAddress:</span> <span class="comment">##NODE_IP##</span></span><br><span class="line"><span class="attr">healthzBindAddress:</span> <span class="comment">##NODE_IP##:10256</span></span><br><span class="line"><span class="attr">metricsBindAddress:</span> <span class="comment">##NODE_IP##:10249</span></span><br><span class="line"><span class="attr">enableProfiling:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">clusterCIDR:</span> <span class="string">$&#123;CLUSTER_CIDR&#125;</span></span><br><span class="line"><span class="attr">hostnameOverride:</span> <span class="comment">##NODE_NAME##</span></span><br><span class="line"><span class="attr">mode:</span> <span class="string">"ipvs"</span></span><br><span class="line"><span class="attr">portRange:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">kubeProxyIPTablesConfiguration:</span></span><br><span class="line"><span class="attr">  masqueradeAll:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">kubeProxyIPVSConfiguration:</span></span><br><span class="line"><span class="attr">  scheduler:</span> <span class="string">rr</span></span><br><span class="line"><span class="attr">  excludeCIDRs:</span> <span class="string">[]</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#从v1.10开始，kube-proxy部分参数可以配置在文件中，可以使用–write-config-to选项生成该配置文件</span></span><br><span class="line"><span class="attr">bindAddress:</span> <span class="string">监听地址；</span></span><br><span class="line"><span class="string">clientConnection.kubeconfig:</span> <span class="string">连接</span> <span class="string">apiserver</span> <span class="string">的</span> <span class="string">kubeconfig</span> <span class="string">文件；</span></span><br><span class="line"><span class="attr">--clusterCIDR:</span> <span class="string">kube-proxy</span> <span class="string">根据</span> <span class="bullet">--cluster-cidr判断集群内部和外部流量，指定</span> <span class="bullet">--cluster-cidr</span> <span class="string">或</span> <span class="string">–masquerade-all</span> <span class="string">选项后</span> <span class="bullet">--kube-proxy</span> <span class="string">才会对访问</span> <span class="string">Service</span> <span class="string">IP</span> <span class="string">的请求做</span> <span class="string">SNAT；</span></span><br><span class="line"><span class="attr">hostnameOverride:</span> <span class="string">参数值必须与</span> <span class="string">kubelet</span> <span class="string">的值一致，否则</span> <span class="string">kube-proxy</span> <span class="string">启动后会找不到该</span> <span class="string">Node，从而不会创建任何</span> <span class="string">ipvs</span> <span class="string">规则；</span></span><br><span class="line"><span class="attr">mode:</span> <span class="string">使用</span> <span class="string">ipvs</span> <span class="string">模式</span></span><br></pre></td></tr></table></figure></p>
<p>分发和创建kube-proxy配置文件<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/cfg</span><br><span class="line">source /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> (( i=<span class="number">0</span>; i &lt; <span class="number">5</span>; i++ ));<span class="keyword">do</span> </span><br><span class="line">    echo <span class="string">"&gt;&gt;&gt; $&#123;NODE_NAMES[i]&#125;"</span></span><br><span class="line">    sed -e <span class="string">"s/##NODE_NAME##/$&#123;NODE_NAMES[i]&#125;/"</span> -e <span class="string">"s/##NODE_IP##/$&#123;NODE_IPS[i]&#125;/"</span> kube-proxy-config.yaml.template &gt; kube-proxy-config-<span class="variable">$&#123;</span>NODE_NAMES[i]&#125;.yaml.template</span><br><span class="line">    scp kube-proxy-config-<span class="variable">$&#123;</span>NODE_NAMES[i]&#125;.yaml.template root@<span class="variable">$&#123;</span>NODE_NAMES[i]&#125;<span class="symbol">:/etc/kubernetes/kube-proxy-config</span>.yaml</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"><span class="comment">###</span></span><br><span class="line"><span class="comment">#我这里一共有2个节点要运行,这是整个集群的node节点的数量！ 这里一定要注意修改！！</span></span><br></pre></td></tr></table></figure></p>
<p>创建和分发 kube-proxy启动<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/init</span><br><span class="line">source /opt/k8s/environment.sh</span><br><span class="line">cat &gt; kube-proxy.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line"><span class="attribute">Description</span>=Kubernetes Kube-Proxy Server</span><br><span class="line"><span class="attribute">Documentation</span>=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"><span class="attribute">After</span>=network.target</span><br><span class="line">[Service]</span><br><span class="line"><span class="attribute">WorkingDirectory</span>=<span class="variable">$&#123;K8S_DIR&#125;</span>/kube-proxy</span><br><span class="line"><span class="attribute">ExecStart</span>=/usr/local/k8s/bin/kube-proxy \\</span><br><span class="line">  <span class="attribute">--config</span>=/etc/kubernetes/kube-proxy-config.yaml \\</span><br><span class="line">  <span class="attribute">--logtostderr</span>=<span class="literal">true</span> \\</span><br><span class="line">  <span class="attribute">--v</span>=2</span><br><span class="line"><span class="attribute">Restart</span>=on-failure</span><br><span class="line"><span class="attribute">RestartSec</span>=5</span><br><span class="line"><span class="attribute">LimitNOFILE</span>=65536</span><br><span class="line">[Install]</span><br><span class="line"><span class="attribute">WantedBy</span>=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<p>分发 kube-proxy 启动文件<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/init</span><br><span class="line">source /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_name <span class="keyword">in</span> <span class="variable">$&#123;</span>NODE_NAMES[@]&#125;;<span class="keyword">do</span> </span><br><span class="line">    echo <span class="string">"&gt;&gt;&gt; $&#123;node_name&#125;"</span></span><br><span class="line">    scp kube-proxy.service root@<span class="variable">$&#123;</span>node_name&#125;<span class="symbol">:/etc/systemd/system/</span></span><br><span class="line">done</span><br></pre></td></tr></table></figure></p>
<p>启动 kube-proxy 服务<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"mkdir -p <span class="variable">$&#123;K8S_DIR&#125;</span>/kube-proxy"</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"modprobe ip_vs_rr"</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"systemctl daemon-reload &amp;&amp; systemctl enable kube-proxy &amp;&amp; systemctl restart kube-proxy"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure></p>
<p>检查启动结果<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"systemctl status kube-proxy|grep Active"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure></p>
<p>检查监听端口<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ netstat -lnpt|grep kube-proxy</span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">192.168</span><span class="meta">.10</span><span class="meta">.81</span>:<span class="number">10256</span>     <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:*               LISTEN      <span class="number">1633</span>/kube-proxy     </span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">192.168</span><span class="meta">.10</span><span class="meta">.81</span>:<span class="number">10249</span>     <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:*               LISTEN      <span class="number">1633</span>/kube-proxy</span><br></pre></td></tr></table></figure></p>
<ul>
<li>10249：http prometheus metrics port</li>
<li>10256：http healthz port</li>
</ul>
<p>查看ipvs路由规则<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 init]# <span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">&gt;     echo <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">&gt;     ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"/usr/sbin/ipvsadm -ln"</span></span><br><span class="line">&gt; done</span><br><span class="line">&gt;&gt;&gt; 192.168.10.84</span><br><span class="line">IP Virtual<span class="built_in"> Server </span>version 1.2.1 (<span class="attribute">size</span>=4096)</span><br><span class="line">Prot LocalAddress:Port<span class="built_in"> Scheduler </span>Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  10.247.0.1:443 rr</span><br><span class="line">  -&gt; 192.168.10.81:6443           Masq    1      0          0         </span><br><span class="line">  -&gt; 192.168.10.82:6443           Masq    1      0          0         </span><br><span class="line">  -&gt; 192.168.10.83:6443           Masq    1      0          0         </span><br><span class="line">  <span class="built_in">..</span>.</span><br></pre></td></tr></table></figure></p>
<h1 id="部署flannel-网络"><a href="#部署flannel-网络" class="headerlink" title="部署flannel 网络"></a>部署flannel 网络</h1><p>kubernetes 要求集群内各节点(包括 master 节点)能通过 Pod 网段互联互通。flannel 使用 vxlan 技术为各节点创建一个可以互通的 Pod 网络，使用的端口为 UDP 8472（需要开放该端口，如公有云 AWS 等）。</p>
<p>flanneld 第一次启动时，从 etcd 获取配置的 Pod 网段信息，为本节点分配一个未使用的地址段，然后创建 flannedl.1 网络接口（也可能是其它名称，如 flannel1 等）。</p>
<p>flannel 将分配给自己的 Pod 网段信息写入 /run/flannel/docker 文件，docker 后续使用这个文件中的环境变量设置 docker0 网桥，从而从这个地址段为本节点的所有 Pod 容器分配 IP。</p>
<p>#<a href="https://github.com/coreos/flannel/releases" target="_blank" rel="noopener">https://github.com/coreos/flannel/releases</a><br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/pkg</span><br><span class="line">wget <span class="symbol">https:</span>/<span class="regexp">/github.com/coreos</span><span class="regexp">/flannel/releases</span><span class="regexp">/download/v</span><span class="number">0</span>.<span class="number">11.0</span>/flannel-v<span class="number">0</span>.<span class="number">11.0</span>-linux-amd64.tar.gz</span><br><span class="line">tar -xzvf flannel-v<span class="number">0</span>.<span class="number">11.0</span>-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment">#分发二进制文件到集群所有节点</span></span><br><span class="line"></span><br><span class="line">cd /opt/k8s/pkg</span><br><span class="line">source /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;</span>NODE_IPS[@]&#125;;<span class="keyword">do</span></span><br><span class="line">    echo <span class="string">"&gt;&gt;&gt; $&#123;node_ip&#125;"</span></span><br><span class="line">    scp flanneld mk-docker-opts.sh root@<span class="variable">$&#123;</span>node_ip&#125;<span class="symbol">:/usr/local/k8s/bin/</span></span><br><span class="line">done</span><br></pre></td></tr></table></figure></p>
<p>创建 flannel 证书和私钥<br>flanneld 从 etcd 集群存取网段分配信息，而 etcd 集群启用了双向 x509 证书认证，所以需要为 flanneld 生成证书和私钥。<br>创建证书签名请求<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/ssl</span><br><span class="line">cat &gt; flanneld-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"flanneld"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: <span class="number">2048</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"GuangZhou"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"GuangZhou"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#该证书只会被 kubectl 当做 client 证书使用，所以 hosts 字段为空</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#生成证书和私钥 </span></span><br><span class="line"></span><br><span class="line">cd /opt/k8s/ssl</span><br><span class="line">cfssl gencert -ca=<span class="regexp">/opt/k</span>8s/ssl/ca.pem \</span><br><span class="line">  -ca-key=<span class="regexp">/opt/k</span>8s/ssl/ca-key.pem \</span><br><span class="line">  -config=<span class="regexp">/opt/k</span>8s/ssl/ca-config.json \</span><br><span class="line">  -profile=kubernetes flanneld-csr.json | cfssljson -bare flanneld </span><br><span class="line"></span><br><span class="line"><span class="comment">#分发</span></span><br><span class="line">source /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;</span>NODE_IPS[@]&#125;;<span class="keyword">do</span></span><br><span class="line">    echo <span class="string">"&gt;&gt;&gt; $&#123;node_ip&#125;"</span></span><br><span class="line">    scp flanneld*.pem root@<span class="variable">$&#123;</span>node_ip&#125;<span class="symbol">:/etc/kubernetes/ssl</span></span><br><span class="line">done</span><br></pre></td></tr></table></figure></p>
<p>向 etcd 写入集群 Pod 网段信息<br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">source <span class="string">/opt/k8s/environment.sh</span></span><br><span class="line">etcdctl \</span><br><span class="line">  <span class="params">--endpoints=</span>$&#123;ETCD_ENDPOINTS&#125; \</span><br><span class="line">  <span class="params">--ca-file=/opt/k8s/ssl/ca</span>.pem \</span><br><span class="line">  <span class="params">--cert-file=/opt/k8s/ssl/flanneld</span>.pem \</span><br><span class="line">  <span class="params">--key-file=/opt/k8s/ssl/flanneld-key</span>.pem \</span><br><span class="line">  mk $&#123;FLANNEL_ETCD_PREFIX&#125;<span class="string">/config</span> '&#123;<span class="string">"Network"</span>:<span class="string">"'$&#123;CLUSTER_CIDR&#125;'"</span>, <span class="string">"SubnetLen"</span>: 21, <span class="string">"Backend"</span>: &#123;<span class="string">"Type"</span>: <span class="string">"vxlan"</span>&#125;&#125;'</span><br><span class="line"></span><br><span class="line"><span class="comment">#输出</span></span><br><span class="line">&#123;<span class="string">"Network"</span>:<span class="string">"172.30.0.0/16"</span>, <span class="string">"SubnetLen"</span>: 21, <span class="string">"Backend"</span>: &#123;<span class="string">"Type"</span>: <span class="string">"vxlan"</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">###</span></span><br><span class="line">flanneld 当前版本 <span class="params">(v0.11.0)</span> 不支持 etcd v3，故使用 etcd v2 API 写入配置 key 和网段数据；</span><br><span class="line">写入的 Pod 网段 $&#123;CLUSTER_CIDR&#125; 地址段（如 <span class="string">/16</span>）必须小于 SubnetLen，必须与 kube-controller-manager 的 <span class="params">--cluster-cidr</span> 参数值一致；</span><br><span class="line">Error:  context deadline exceeded报错解决</span><br><span class="line"><span class="keyword">unset</span> http_proxy</span><br><span class="line"><span class="keyword">unset</span> https_proxy</span><br></pre></td></tr></table></figure></p>
<p>创建 flanneld 启动文件</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/init</span><br><span class="line">source /opt/k8s/environment.sh</span><br><span class="line">cat &gt; flanneld.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line"><span class="attribute">Description</span>=Flanneld overlay<span class="built_in"> address </span>etcd agent</span><br><span class="line"><span class="attribute">After</span>=network.target</span><br><span class="line"><span class="attribute">After</span>=network-online.target</span><br><span class="line"><span class="attribute">Wants</span>=network-online.target</span><br><span class="line"><span class="attribute">After</span>=etcd.service</span><br><span class="line"><span class="attribute">Before</span>=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line"><span class="attribute">Type</span>=notify</span><br><span class="line"><span class="attribute">ExecStart</span>=/usr/local/k8s/bin/flanneld \\</span><br><span class="line">  <span class="attribute">-etcd-cafile</span>=/etc/kubernetes/ssl/ca.pem \\</span><br><span class="line">  <span class="attribute">-etcd-certfile</span>=/etc/kubernetes/ssl/flanneld.pem \\</span><br><span class="line">  <span class="attribute">-etcd-keyfile</span>=/etc/kubernetes/ssl/flanneld-key.pem \\</span><br><span class="line">  <span class="attribute">-etcd-endpoints</span>=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> \\</span><br><span class="line">  <span class="attribute">-etcd-prefix</span>=<span class="variable">$&#123;FLANNEL_ETCD_PREFIX&#125;</span> \\</span><br><span class="line">  <span class="attribute">-iface</span>=<span class="variable">$&#123;IFACE&#125;</span> \\</span><br><span class="line">  -ip-masq</span><br><span class="line"><span class="attribute">ExecStartPost</span>=/usr/local/k8s/bin/mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS -d /run/flannel/docker</span><br><span class="line"><span class="attribute">Restart</span>=always</span><br><span class="line"><span class="attribute">RestartSec</span>=5</span><br><span class="line"><span class="attribute">StartLimitInterval</span>=0</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line"><span class="attribute">WantedBy</span>=multi-user.target</span><br><span class="line"><span class="attribute">RequiredBy</span>=docker.service</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>mk-docker-opts.sh 脚本将分配给 flanneld 的 Pod 子网段信息写入 /run/flannel/docker 文件，后续 docker 启动时使用这个文件中的环境变量配置 docker0 网桥；</li>
<li>flanneld 使用系统缺省路由所在的接口与其它节点通信，对于有多个网络接口（如内网和公网）的节点，可以用 --iface 参数指定通信接口;</li>
<li>flanneld 运行时需要 root 权限；</li>
<li>--ip-masq: flanneld 为访问 Pod 网络外的流量设置 SNAT 规则，同时将传递给 Docker 的变量 –ip-masq（/run/flannel/docker 文件中）设置为 false，这样 Docker 将不再创建 SNAT 规则； Docker 的 –ip-masq 为 true 时，创建的 SNAT 规则比较“暴力”：将所有本节点 Pod 发起的、访问非 docker0 接口的请求做 SNAT，这样访问其他节点 Pod 的请求来源 IP 会被设置为 flannel.1 接口的 IP，导致目的 Pod 看不到真实的来源 Pod IP。 flanneld 创建的 SNAT 规则比较温和，只对访问非 Pod 网段的请求做 SNAT。</li>
</ul>
<p>分发flanneld启动文件<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/init</span><br><span class="line">source /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;</span>NODE_IPS[@]&#125;;<span class="keyword">do</span></span><br><span class="line">    echo <span class="string">"&gt;&gt;&gt; $&#123;node_ip&#125;"</span></span><br><span class="line">    scp flanneld.service root@<span class="variable">$&#123;</span>node_ip&#125;<span class="symbol">:/etc/systemd/system/</span></span><br><span class="line">done</span><br></pre></td></tr></table></figure></p>
<p>修改docker service 添加 EnvironmentFile 和 $DOCKER_NETWORK_OPTIONS<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/init</span><br><span class="line">cat &gt; docker.service &lt;&lt;<span class="string">"EOF"</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">BindsTo=containerd.service</span><br><span class="line">After=network-online.target firewalld.service containerd.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line">Requires=docker.socket</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line"><span class="comment"># the default is not to use systemd for cgroups because the delegate issues still</span></span><br><span class="line"><span class="comment"># exists and systemd currently does not support the cgroup feature set required</span></span><br><span class="line"><span class="comment"># for containers run by docker</span></span><br><span class="line"><span class="comment">#ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock</span></span><br><span class="line">EnvironmentFile=-/run/flannel/docker</span><br><span class="line">ExecStart=/usr/bin/dockerd $DOCKER_NETWORK_OPTIONS -H fd:// --containerd=/run/containerd/containerd.sock</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line">TimeoutSec=0</span><br><span class="line">RestartSec=2</span><br><span class="line">Restart=always</span><br><span class="line"></span><br><span class="line"><span class="comment"># Note that StartLimit* options were moved from "Service" to "Unit" in systemd 229.</span></span><br><span class="line"><span class="comment"># Both the old, and new location are accepted by systemd 229 and up, so using the old location</span></span><br><span class="line"><span class="comment"># to make them work for either version of systemd.</span></span><br><span class="line">StartLimitBurst=3</span><br><span class="line"></span><br><span class="line"><span class="comment"># Note that StartLimitInterval was renamed to StartLimitIntervalSec in systemd 230.</span></span><br><span class="line"><span class="comment"># Both the old, and new name are accepted by systemd 230 and up, so using the old name to make</span></span><br><span class="line"><span class="comment"># this option work for either version of systemd.</span></span><br><span class="line">StartLimitInterval=60s</span><br><span class="line"></span><br><span class="line"><span class="comment"># Having non-zero Limit*s causes performance problems due to accounting overhead</span></span><br><span class="line"><span class="comment"># in the kernel. We recommend using cgroups to do container-local accounting.</span></span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line"></span><br><span class="line"><span class="comment"># Comment TasksMax if your systemd version does not support it.</span></span><br><span class="line"><span class="comment"># Only systemd 226 and above support this option.</span></span><br><span class="line">TasksMax=infinity</span><br><span class="line"></span><br><span class="line"><span class="comment"># set delegate yes so that systemd does not reset the cgroups of docker containers</span></span><br><span class="line">Delegate=yes</span><br><span class="line"></span><br><span class="line"><span class="comment"># kill only the docker process, not all processes in the cgroup</span></span><br><span class="line">KillMode=process</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<p>启动flanneld<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">source /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;</span>NODE_IPS[@]&#125;;<span class="keyword">do</span></span><br><span class="line">    echo <span class="string">"&gt;&gt;&gt; $&#123;node_ip&#125;"</span></span><br><span class="line">    scp  /opt/k8s/init/docker.service root@<span class="variable">$node_ip</span><span class="symbol">:/usr/lib/systemd/system/docker</span>.service</span><br><span class="line">    ssh root@<span class="variable">$&#123;</span>node_ip&#125; <span class="string">"systemctl daemon-reload &amp;&amp; systemctl enable flanneld \</span></span><br><span class="line"><span class="string">    &amp;&amp; systemctl restart flanneld &amp;&amp; systemctl restart docker kube-proxy kubelet"</span></span><br><span class="line">done</span><br></pre></td></tr></table></figure></p>
<p>检查启动结果<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"systemctl status flanneld|grep Active"</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#journalctl -u flanneld</span></span><br></pre></td></tr></table></figure></p>
<p>检查分配给各 flanneld 的 Pod 网段信息<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">source /opt/k8s/environment.sh</span><br><span class="line">etcdctl \</span><br><span class="line">  <span class="attribute">--endpoints</span>=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> \</span><br><span class="line">  <span class="attribute">--ca-file</span>=/opt/k8s/ssl/ca.pem \</span><br><span class="line">  <span class="attribute">--cert-file</span>=/opt/k8s/ssl/flanneld.pem \</span><br><span class="line">  <span class="attribute">--key-file</span>=/opt/k8s/ssl/flanneld-key.pem \</span><br><span class="line">  <span class="builtin-name">get</span> <span class="variable">$&#123;FLANNEL_ETCD_PREFIX&#125;</span>/config</span><br><span class="line"></span><br><span class="line"><span class="comment">#输出</span></span><br><span class="line">&#123;<span class="string">"Network"</span>:<span class="string">"172.30.0.0/16"</span>, <span class="string">"SubnetLen"</span>: 21, <span class="string">"Backend"</span>: &#123;<span class="string">"Type"</span>: <span class="string">"vxlan"</span>&#125;&#125;</span><br></pre></td></tr></table></figure></p>
<p>查看已分配的 Pod 子网段列表(/24):<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">source <span class="meta-keyword">/opt/</span>k8s/environment.sh</span><br><span class="line">etcdctl \</span><br><span class="line">  --endpoints=$&#123;ETCD_ENDPOINTS&#125; \</span><br><span class="line">  --ca-file=<span class="meta-keyword">/opt/</span>k8s<span class="meta-keyword">/ssl/</span>ca.pem \</span><br><span class="line">  --cert-file=<span class="meta-keyword">/opt/</span>k8s<span class="meta-keyword">/ssl/</span>flanneld.pem \</span><br><span class="line">  --key-file=<span class="meta-keyword">/opt/</span>k8s<span class="meta-keyword">/ssl/</span>flanneld-key.pem \</span><br><span class="line">  ls $&#123;FLANNEL_ETCD_PREFIX&#125;/subnets</span><br><span class="line"></span><br><span class="line"><span class="meta">#输出</span></span><br><span class="line"><span class="meta-keyword">/kubernetes/</span>network<span class="meta-keyword">/subnets/</span><span class="number">172.30</span><span class="number">.144</span><span class="number">.0</span><span class="number">-21</span></span><br><span class="line"><span class="meta-keyword">/kubernetes/</span>network<span class="meta-keyword">/subnets/</span><span class="number">172.30</span><span class="number">.72</span><span class="number">.0</span><span class="number">-21</span></span><br></pre></td></tr></table></figure></p>
<p>查看某一 Pod 网段对应的节点 IP 和 flannel 接口地址:<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">source /opt/k8s/environment.sh</span><br><span class="line">etcdctl \</span><br><span class="line">  <span class="attribute">--endpoints</span>=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> \</span><br><span class="line">  <span class="attribute">--ca-file</span>=/opt/k8s/ssl/ca.pem \</span><br><span class="line">  <span class="attribute">--cert-file</span>=/opt/k8s/ssl/flanneld.pem \</span><br><span class="line">  <span class="attribute">--key-file</span>=/opt/k8s/ssl/flanneld-key.pem \</span><br><span class="line">  <span class="builtin-name">get</span> <span class="variable">$&#123;FLANNEL_ETCD_PREFIX&#125;</span>/subnets/172.30.72.0-21</span><br><span class="line"></span><br><span class="line"><span class="comment">#输出</span></span><br><span class="line">&#123;<span class="string">"PublicIP"</span>:<span class="string">"192.168.10.85"</span>,<span class="string">"BackendType"</span>:<span class="string">"vxlan"</span>,<span class="string">"BackendData"</span>:&#123;<span class="string">"VtepMAC"</span>:<span class="string">"6e:c7:a8:95:59:5c"</span>&#125;&#125;</span><br></pre></td></tr></table></figure></p>
<p>检查节点 flannel 网络信息<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ip</span> addr show | grep flannel<span class="meta">.1</span></span><br><span class="line"><span class="number">5</span>: flannel<span class="meta">.1</span>: &lt;BROADCAST,MULTICAST,<span class="meta">UP</span>,LOWER_UP&gt; mtu <span class="number">1450</span> qdisc noqueue state UNKNOWN group <span class="meta">default</span> </span><br><span class="line">    inet <span class="number">172.30</span><span class="meta">.128</span><span class="meta">.0</span>/<span class="number">32</span> scope <span class="meta">global</span> flannel<span class="meta">.1</span></span><br><span class="line">$ <span class="built_in">ip</span> route show | grep flannel<span class="meta">.1</span></span><br><span class="line"><span class="number">172.30</span><span class="meta">.24</span><span class="meta">.0</span>/<span class="number">21</span> via <span class="number">172.30</span><span class="meta">.24</span><span class="meta">.0</span> dev flannel<span class="meta">.1</span> onlink </span><br><span class="line"><span class="number">172.30</span><span class="meta">.80</span><span class="meta">.0</span>/<span class="number">21</span> via <span class="number">172.30</span><span class="meta">.80</span><span class="meta">.0</span> dev flannel<span class="meta">.1</span> onlink </span><br><span class="line"><span class="number">172.30</span><span class="meta">.88</span><span class="meta">.0</span>/<span class="number">21</span> via <span class="number">172.30</span><span class="meta">.88</span><span class="meta">.0</span> dev flannel<span class="meta">.1</span> onlink </span><br><span class="line"><span class="number">172.30</span><span class="meta">.232</span><span class="meta">.0</span>/<span class="number">21</span> via <span class="number">172.30</span><span class="meta">.232</span><span class="meta">.0</span> dev flannel<span class="meta">.1</span> onlink</span><br></pre></td></tr></table></figure></p>
<p>验证各节点能通过 Pod 网段互通<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">    ssh <span class="variable">$&#123;node_ip&#125;</span> <span class="string">"/usr/sbin/ip addr show flannel.1|grep -w inet"</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="comment">#输出</span></span><br><span class="line">&gt;&gt;&gt; 192.168.10.84</span><br><span class="line">    inet 172.30.144.0/32 scope global flannel.1</span><br><span class="line">&gt;&gt;&gt; 192.168.10.85</span><br><span class="line">    inet 172.30.72.0/32 scope global flannel.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在各节点上 ping 所有 flannel 接口 IP，确保能通</span></span><br><span class="line"><span class="built_in">source</span> /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">    ssh <span class="variable">$&#123;node_ip&#125;</span> <span class="string">"ping -c 1 172.30.144.0"</span></span><br><span class="line">    ssh <span class="variable">$&#123;node_ip&#125;</span> <span class="string">"ping -c 1 172.30.72.0"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure></p>
<p>检查overlay2<br>检查docker0和flannel.1 同网段<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"/usr/bin/docker info | grep overlay2"</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"/usr/sbin/ip addr show flannel.1 &amp;&amp; /usr/sbin/ip addr show docker0"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure></p>
<h1 id="验证集群功能"><a href="#验证集群功能" class="headerlink" title="验证集群功能"></a>验证集群功能</h1><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get node</span><br><span class="line">NAME         STATUS   ROLES    AGE     VERSION</span><br><span class="line">k8s-node01   Ready    &lt;none&gt;   <span class="number">2</span>d21h   v1<span class="number">.14</span><span class="number">.2</span></span><br><span class="line">k8s-node02   Ready    &lt;none&gt;   <span class="number">2</span>d21h   v1<span class="number">.14</span><span class="number">.2</span></span><br></pre></td></tr></table></figure>
<p>创建执行yaml<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cd</span> <span class="string">/opt/k8s/cfg</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt; nginx-ds.yml &lt;&lt;EOF</span></span><br><span class="line"><span class="string"></span><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-ds</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">nginx-ds</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">nginx-ds</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-ds</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line">    <span class="string">addonmanager.kubernetes.io/mode:</span> <span class="string">Reconcile</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">nginx-ds</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">my-nginx</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">daocloud.io/library/nginx:1.13.0-alpine</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="bullet">-f</span> <span class="string">nginx-ds.yml</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 cfg]# kubectl get pod -o wide</span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE   IP             NODE         NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-ds-bhtv9   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">30</span>s   <span class="number">172.30</span><span class="number">.144</span><span class="number">.2</span>   k8s-node01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-ds-zsjkv   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">30</span>s   <span class="number">172.30</span><span class="number">.72</span><span class="number">.2</span>    k8s-node02   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<p>检查各节点的Pod IP 连通性</p>
<p>这里看到pod的IP，我们将ip复制一下<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">    ssh <span class="variable">$&#123;node_ip&#125;</span> <span class="string">"ping -c 1 172.30.144.2"</span></span><br><span class="line">    ssh <span class="variable">$&#123;node_ip&#125;</span> <span class="string">"ping -c 1 172.30.72.2 "</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure></p>
<p>检查服务IP和端口可达性<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 cfg]# kubectl <span class="built_in">get</span> svc |<span class="keyword">grep</span> nginx-<span class="keyword">ds</span></span><br><span class="line">nginx-<span class="keyword">ds</span>     NodePort    <span class="number">10.247</span>.<span class="number">217.203</span>   <span class="symbol">&lt;none&gt;</span>        <span class="number">80</span>:<span class="number">32686</span>/TCP   <span class="number">90</span>s</span><br></pre></td></tr></table></figure></p>
<p>我们在任意节点访问server IP<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /opt/k8s/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">    ssh <span class="variable">$&#123;node_ip&#125;</span> <span class="string">"curl -s 10.247.217.203"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure></p>
<h1 id="部署coredns"><a href="#部署coredns" class="headerlink" title="部署coredns"></a>部署coredns</h1><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> /<span class="keyword">opt</span>/k8s/pkg/kubernetes/</span><br><span class="line">tar -xzvf kubernetes-src.tar.gz</span><br><span class="line"><span class="keyword">cp</span> /<span class="keyword">opt</span>/k8s/pkg/kubernetes/cluster/addons/dns/coredns/coredns.yaml.base /<span class="keyword">opt</span>/k8s/cfg/coredns.yaml</span><br><span class="line"></span><br><span class="line">#更换镜像源 http://mirror.azure.<span class="keyword">cn</span>/<span class="keyword">help</span>/gcr-proxy-cache.html</span><br><span class="line"><span class="keyword">source</span> /<span class="keyword">opt</span>/k8s/environment.<span class="keyword">sh</span></span><br><span class="line"><span class="keyword">cd</span>  /<span class="keyword">opt</span>/k8s/cfg</span><br><span class="line">sed -i <span class="string">'s#k8s.gcr.io#gcr.azk8s.cn/google_containers#g'</span> coredns.yaml</span><br><span class="line">sed -i -<span class="keyword">e</span> <span class="string">"s/__PILLAR__DNS__DOMAIN__/$&#123;CLUSTER_DNS_DOMAIN&#125;/"</span> -<span class="keyword">e</span> <span class="string">"s/__PILLAR__DNS__SERVER__/$&#123;CLUSTER_DNS_SVC_IP&#125;/"</span> coredns.yaml</span><br><span class="line"></span><br><span class="line">#创建 coredns</span><br><span class="line">kubectl create -<span class="keyword">f</span> coredns.yaml</span><br><span class="line"></span><br><span class="line">#replicas默认<span class="number">1</span>,可以修改多个</span><br><span class="line">spec:</span><br><span class="line">  replica<span class="variable">s:</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line">#检查coredns状态</span><br><span class="line">[root@k8s-master01 cfg]# kubectl <span class="built_in">get</span> svc -nkube-<span class="built_in">system</span></span><br><span class="line">NAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE</span><br><span class="line">kube-dns   ClusterIP   <span class="number">10.247</span>.<span class="number">0.2</span>   <span class="symbol">&lt;none&gt;</span>        <span class="number">53</span>/UDP,<span class="number">53</span>/TCP,<span class="number">9153</span>/TCP   <span class="number">39</span>s</span><br></pre></td></tr></table></figure>
<p>测试corsdns<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat&lt;&lt;EOF</span> <span class="string">| kubectl apply -f -</span></span><br><span class="line"><span class="string"></span><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">    image:</span> <span class="attr">busybox:1.28.3</span></span><br><span class="line"><span class="attr">    command:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">sleep</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"3600"</span></span><br><span class="line"><span class="attr">    imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">  restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 cfg]# kubectl <span class="builtin-name">get</span> pod | grep busybox</span><br><span class="line">busybox          1/1     Running   0          2m43s</span><br><span class="line"></span><br><span class="line">[root@k8s-master01 cfg]# kubectl exec -ti busybox -- nslookup kubernetes</span><br><span class="line">Server:    10.247.0.2</span><br><span class="line">Address 1: 10.247.0.2 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      kubernetes</span><br><span class="line">Address 1: 10.247.0.1 kubernetes.default.svc.cluster.local</span><br></pre></td></tr></table></figure>
<h1 id="部署dashboard"><a href="#部署dashboard" class="headerlink" title="部署dashboard"></a>部署dashboard</h1><p>先前已解压的 kubernetes-server-linux-amd64.tar.gz<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp -r <span class="meta-keyword">/opt/</span>k8s<span class="meta-keyword">/pkg/</span>kubernetes<span class="meta-keyword">/cluster/</span>addons/dashboard <span class="meta-keyword">/opt/</span>k8s<span class="meta-keyword">/cfg/</span></span><br><span class="line">cd <span class="meta-keyword">/opt/</span>k8s<span class="meta-keyword">/cfg/</span>dashboard</span><br></pre></td></tr></table></figure></p>
<p>service添加NodePort，使外界可以通过地址 NodeIP:NodePort 访问 dashboard<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">apiVersion</span>: v1</span><br><span class="line"><span class="attribute">kind</span>: Service</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">  <span class="attribute">name</span>: kubernetes-dashboard</span><br><span class="line">  <span class="attribute">namespace</span>: kube-system</span><br><span class="line">  <span class="attribute">labels</span>:</span><br><span class="line">    <span class="attribute">k8s-app</span>: kubernetes-dashboard</span><br><span class="line">    kubernetes.io/<span class="attribute">cluster-service</span>: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/<span class="attribute">mode</span>: Reconcile</span><br><span class="line"><span class="attribute">spec</span>:</span><br><span class="line">  <span class="attribute">type</span>: NodePort #增加此行</span><br><span class="line">  <span class="attribute">selector</span>:</span><br><span class="line">    <span class="attribute">k8s-app</span>: kubernetes-dashboard</span><br><span class="line">  <span class="attribute">ports</span>:</span><br><span class="line">  - <span class="attribute">port</span>: <span class="number">443</span></span><br><span class="line">    <span class="attribute">targetPort</span>: <span class="number">8443</span></span><br><span class="line">    <span class="attribute">nodePort</span>: <span class="number">30001</span> #指定端口</span><br></pre></td></tr></table></figure></p>
<p>更换微软镜像源、执行<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ls *.yaml</span><br><span class="line">dashboard-configmap<span class="selector-class">.yaml</span>  dashboard-controller<span class="selector-class">.yaml</span>  dashboard-rbac<span class="selector-class">.yaml</span>  dashboard-secret<span class="selector-class">.yaml</span>  dashboard-service.yaml</span><br><span class="line">$ sed -<span class="selector-tag">i</span> <span class="string">'s#k8s.gcr.io#gcr.azk8s.cn/google_containers#'</span> dashboard-controller<span class="selector-class">.yaml</span> </span><br><span class="line">$ kubectl apply -f  .</span><br></pre></td></tr></table></figure></p>
<p>查看pod 、service<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="builtin-name">get</span> pods -o wide -nkube-system | grep dashboard</span><br><span class="line">kubernetes-dashboard-64ffdff795-vgwrg   1/1     Running   0          77s   172.30.144.4   k8s-node01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ kubectl <span class="builtin-name">get</span> services kubernetes-dashboard -n kube-system</span><br><span class="line">NAME                  <span class="built_in"> TYPE </span>      CLUSTER-IP      EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">kubernetes-dashboard   NodePort   10.247.91.150   &lt;none&gt;        443:30001/TCP   2m15s</span><br></pre></td></tr></table></figure></p>
<p>浏览器访问kube-apiserver<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl cluster-info</span><br><span class="line">Kubernetes master <span class="keyword">is</span> running at http<span class="variable">s:</span>//<span class="number">192.168</span>.<span class="number">10.80</span>:<span class="number">8443</span></span><br><span class="line">CoreDNS <span class="keyword">is</span> running at http<span class="variable">s:</span>//<span class="number">192.168</span>.<span class="number">10.80</span>:<span class="number">8443</span>/api/v1/namespaces/kube-<span class="built_in">system</span>/services/kube-dn<span class="variable">s:dns</span>/proxy</span><br><span class="line">kubernetes-dashboard <span class="keyword">is</span> running at http<span class="variable">s:</span>//<span class="number">192.168</span>.<span class="number">10.80</span>:<span class="number">8443</span>/api/v1/namespaces/kube-<span class="built_in">system</span>/services/http<span class="variable">s:kubernetes</span>-dashboard:/proxy</span><br></pre></td></tr></table></figure></p>
<p><a href="http://mirror.azure.cn/help/gcr-proxy-cache.html" target="_blank" rel="noopener">微软云GCR Proxy Cache</a></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; dashboard.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"dashboard"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"GuangZhou"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"GuangZhou"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cd /opt/k8s/ssl</span><br><span class="line">cfssl gencert <span class="attribute">-ca</span>=/opt/k8s/ssl/ca.pem \</span><br><span class="line">  <span class="attribute">-ca-key</span>=/opt/k8s/ssl/ca-key.pem \</span><br><span class="line">  <span class="attribute">-config</span>=/opt/k8s/ssl/ca-config.json \</span><br><span class="line">  <span class="attribute">-profile</span>=kubernetes dashboard.json | cfssljson -bare dashboard</span><br><span class="line"></span><br><span class="line">cp dashboard.pem /etc/kubernetes/ssl/dashboard.crt</span><br><span class="line">cp dashboard-key.pem /etc/kubernetes/ssl/dashboard.key</span><br><span class="line"></span><br><span class="line"><span class="comment">#create secret</span></span><br><span class="line">cd /etc/kubernetes/ssl</span><br><span class="line">kubectl create<span class="built_in"> secret </span>generic kubernetes-dashboard-certs <span class="attribute">--from-file</span>=<span class="string">"dashboard.crt,dashboard.key"</span> -n kube-system</span><br><span class="line">kubectl <span class="builtin-name">get</span><span class="built_in"> secret </span>-n kube-system | grep dashboard</span><br><span class="line"></span><br><span class="line"><span class="comment">#导出证书至windows</span></span><br><span class="line">cd /opt/k8s/ssl/</span><br><span class="line">openssl pkcs12 -<span class="builtin-name">export</span> -certfile ca.pem -in dashboard.pem -inkey dashboard-key.pem -out dashboard.pfx</span><br><span class="line">openssl pkcs12 -<span class="builtin-name">export</span> -in ca.pem -inkey ca-key.pem  -out dashboard.pfx</span><br><span class="line"></span><br><span class="line">openssl pkcs12 -<span class="builtin-name">export</span> -out dashboard.pfx -inkey dashboard-key.pem -in dashboard.pem -certfile ca.pem</span><br><span class="line">openssl pkcs12 -<span class="builtin-name">export</span> -out admin.pfx -inkey admin-key.pem -in admin.pem -certfile ca.pem</span><br></pre></td></tr></table></figure>
<ol>
<li>kubernetes-dashboard service 暴露了 NodePort，可以使用 <a href="https://NodeIP:NodePort" target="_blank" rel="noopener">https://NodeIP:NodePort</a> 地址访问 dashboard</li>
<li>通过 kube-apiserver 访问 dashboard</li>
<li>通过 kubectl proxy 访问 dashboard</li>
</ol>


                <hr>

                

                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/kubernets-taint/" data-toggle="tooltip" data-placement="top" title="kubernets 污点">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/nginx-allows-multiple-domain-cors/" data-toggle="tooltip" data-placement="top" title="Nginx 允许多个域名跨域访问">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                

                

            </div>
    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->

            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="https://jaminzhang.github.io" target="_blank">JAMIN ZHANG</a></li>
                    
                        <li><a href="#" target="_blank">It helps SEO</a></li>
                    
                </ul>
                
            </div>

        </div>
    </div>
</article>







<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                

                

                

                
                    <li>
                        <a target="_blank"  href="https://github.com/sundayle">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Sunday 2019 
                    <br>
                    Theme by <a href="http://huangxuan.me">Hux</a> 
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span>
                    Ported by <a href="https://github.com/Kaijun/hexo-theme-huxblog">Kaijun</a>
            <!-- 
                    Ported by <a href="http://blog.kaijun.rocks">Kaijun</a> | 
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=kaijun&repo=hexo-theme-huxblog&type=star&count=true" >
                    </iframe>
            -->
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
     async("https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->


<script>
    // dynamic User by Hux
    var _gaId = 'UA-70699634-1';
    var _gaDomain = 'auto';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>




<!-- Baidu Tongji -->


<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog (selector) {
        var P = $('div.post-container'),a,n,t,l,i,c;
        a = P.find('h1,h2,h3,h4,h5,h6');
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#"+$(this).prop('id');
            t = $(this).text();
            c = $('<a href="'+i+'" rel="nofollow">'+t+'</a>');
            l = $('<li class="'+n+'_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;    
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function(e){
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>





<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
