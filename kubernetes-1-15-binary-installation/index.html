<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Linux运维笔记">
    <meta name="keyword"  content="sunday,sundayhk,sundayle,sunday博客,Linxu,运维">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
          Kubernetes 1.15.4 二进制高可用安装 - Sunday博客 | Sunday Blog
        
    </title>

    <link rel="canonical" href="http://www.sundayle.com/kubernetes-1-15-binary-installation/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">SundayLe</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/archives/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    
<!-- Image to hack wechat -->
<!-- <img src="http://www.sundayle.com/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="{{ site.baseurl }}/{% if page.header-img %}{{ page.header-img }}{% else %}{{ site.header-img }}{% endif %}" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        background-image: url('/img/home-bg.jpg')
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                    </div>
                    <h1>Kubernetes 1.15.4 二进制高可用安装</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        Posted by Sunday on
                        2019-08-15
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><blockquote>
<p>OS: CentOS 7.5<br>Kubernetes: 1.15.4<br>Docker: 18.09<br>Etcd: 3.4.1 </p>
</blockquote>
<table>
<thead>
<tr>
<th>主机名</th>
<th>IP / VIP</th>
<th>组件</th>
</tr>
</thead>
<tbody>
<tr>
<td>k8s-master</td>
<td>192.168.10.81 / 192.168.10.80</td>
<td>haproxy、keepalived、etcd、kube-apiserver、kube-controllet-manager、kube-scheduler、node</td>
</tr>
<tr>
<td>k8s-master</td>
<td>192.168.10.82 / 192.168.10.80</td>
<td>haproxy、keepalived、etcd、kube-apiserver、kube-controllet-manager、kube-scheduler、node</td>
</tr>
<tr>
<td>k8s-master</td>
<td>192.168.10.83 / 192.168.10.80</td>
<td>haproxy、keepalived、etcd、kube-apiserver、kube-controllet-manager、kube-scheduler、node</td>
</tr>
<tr>
<td>k8s-node01</td>
<td>192.168.10.84</td>
<td>kubelet、kube-proxy、docker、flanneld、core-dns</td>
</tr>
<tr>
<td>k8s-node02</td>
<td>192.168.10.85</td>
<td>kubelet、kube-proxy、docker、flanneld、core-dns</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>服务</th>
<th>网络</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>service network | 10.96.0.0/12<br>service dns | 10.96.0.10<br>pod network | 10.244.0.0/16</p>
<p>host解析<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt;<span class="literal">EOF</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.10</span><span class="number">.81</span>  k8s-master01</span><br><span class="line"><span class="number">192.168</span><span class="number">.10</span><span class="number">.82</span>  k8s-master02</span><br><span class="line"><span class="number">192.168</span><span class="number">.10</span><span class="number">.83</span>  k8s-master03</span><br><span class="line"><span class="number">192.168</span><span class="number">.10</span><span class="number">.84</span>  k8s-node01</span><br><span class="line"><span class="number">192.168</span><span class="number">.10</span><span class="number">.85</span>  k8s-node02</span><br><span class="line"><span class="literal">EOF</span></span><br></pre></td></tr></table></figure></p>
<p>配置免密钥登陆<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">yum install -y expect</span><br><span class="line">ssh-keygen -t rsa -P <span class="string">""</span> -f /root/.ssh/id_rsa</span><br><span class="line">export mypass=<span class="number">123456</span></span><br><span class="line">name=(k8s-master1 k8s-master2 k8s-master3 k8s-node1 k8s-node2)</span><br><span class="line"></span><br><span class="line">for i in $&#123;name[@]&#125;;do</span><br><span class="line">expect -c <span class="string">"</span></span><br><span class="line"><span class="string">spawn ssh-copy-id -i /root/.ssh/id_rsa.pub root@$i</span></span><br><span class="line"><span class="string">  expect &#123;</span></span><br><span class="line"><span class="string">    <span class="subst">\"</span>*yes/no*<span class="subst">\"</span> &#123;send <span class="subst">\"</span>yes\r<span class="subst">\"</span>; exp_continue&#125;</span></span><br><span class="line"><span class="string">    <span class="subst">\"</span>*password*<span class="subst">\"</span> &#123;send <span class="subst">\"</span>$mypass\r<span class="subst">\"</span>; exp_continue&#125;</span></span><br><span class="line"><span class="string">    <span class="subst">\"</span>*Password*<span class="subst">\"</span> &#123;send <span class="subst">\"</span>$mypass\r<span class="subst">\"</span>;&#125;</span></span><br><span class="line"><span class="string">  &#125;"</span></span><br><span class="line">done</span><br></pre></td></tr></table></figure></p>
<p>配置主机名<br><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">name=</span>(<span class="string">k8s-master01 </span><span class="string">k8s-master02 </span><span class="string">k8s-master03 </span><span class="string">k8s-node01 </span><span class="string">k8s-node02)</span></span><br><span class="line"><span class="string">for </span>i <span class="string">in </span>$&#123;<span class="string">name[</span>@]&#125;;<span class="string">do </span><span class="string">ssh </span><span class="string">root@</span>$i  <span class="string">hostnamectl </span><span class="built_in">set-hostname</span> $i;<span class="string">done</span></span><br></pre></td></tr></table></figure></p>
<p>关闭防火墙、selinux、swap<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line">iptables -F &amp;&amp; iptables -X &amp;&amp; iptables -F -t nat &amp;&amp; iptables -X -t nat</span><br><span class="line">iptables -P FORWARD ACCEPT</span><br><span class="line">swapoff -a</span><br><span class="line">sed -<span class="selector-tag">i</span> <span class="string">'/ swap / s/^\(.*\)$/#\1/g'</span> /etc/fstab</span><br><span class="line">setenforce <span class="number">0</span></span><br><span class="line">sed -<span class="selector-tag">i</span> <span class="string">'s/^SELINUX=.*/SELINUX=disabled/'</span> /etc/selinux/config</span><br></pre></td></tr></table></figure></p>
<p>安装依赖<br><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> -y ntpdate curl wget</span><br></pre></td></tr></table></figure></p>
<p>时间同步<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo <span class="string">"*/30 * * * * ntpdate time7.aliyun.com &gt;/dev/null 2&gt;&amp;1"</span> &gt;&gt; <span class="regexp">/var/</span>spool<span class="regexp">/cron/</span>root</span><br></pre></td></tr></table></figure></p>
<p>升级内核<br><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#Docker overlay2需要使用kernel <span class="number">4.</span>x版本</span><br><span class="line">rpm -Uvh http:<span class="comment">//www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm</span></span><br><span class="line">yum --enablerepo=elrepo-kernel install -y kernel-<span class="keyword">lt</span></span><br><span class="line">grub2-<span class="keyword">set</span>-default  <span class="comment">0</span>  </span><br><span class="line">grub2-mkconfig <span class="comment">-o</span> /etc/<span class="comment">grub2.cfg</span></span><br><span class="line">grubby <span class="comment">--default-kernel</span></span><br><span class="line">reboot</span><br></pre></td></tr></table></figure></p>
<p>优化内核参数<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/etc/sysctl.d/kubernetes.conf &lt;&lt;EOF</span><br><span class="line">net.bridge.<span class="attribute">bridge-nf-call-iptables</span>=1</span><br><span class="line">net.bridge.<span class="attribute">bridge-nf-call-ip6tables</span>=1</span><br><span class="line">net.ipv4.<span class="attribute">ip_forward</span>=1</span><br><span class="line">net.ipv4.<span class="attribute">tcp_tw_recycle</span>=0</span><br><span class="line">vm.<span class="attribute">swappiness</span>=0 # 禁止使用 swap 空间，只有当系统 OOM 时才允许使用它</span><br><span class="line">vm.<span class="attribute">overcommit_memory</span>=1 # 不检查物理内存是否够用</span><br><span class="line">vm.<span class="attribute">panic_on_oom</span>=0 # 开启 OOM</span><br><span class="line">fs.inotify.<span class="attribute">max_user_instances</span>=8192</span><br><span class="line">fs.inotify.<span class="attribute">max_user_watches</span>=1048576</span><br><span class="line">fs.<span class="attribute">file-max</span>=52706963</span><br><span class="line">fs.<span class="attribute">nr_open</span>=52706963</span><br><span class="line">net.ipv6.conf.all.<span class="attribute">disable_ipv6</span>=1</span><br><span class="line">net.netfilter.<span class="attribute">nf_conntrack_max</span>=2310720</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure></p>
<p>IPVS<br><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">yum install -y conntrack ipvsadm ipset </span><br><span class="line">cat &gt;/etc/modules-<span class="keyword">load</span>.d/ipvs.conf &lt;&lt; <span class="built_in">EOF</span></span><br><span class="line">ip_vs</span><br><span class="line">ip_vs_rr</span><br><span class="line">ip_vs_wrr</span><br><span class="line">ip_vs_sh</span><br><span class="line">nf_conntrack</span><br><span class="line"><span class="built_in">EOF</span></span><br><span class="line"></span><br><span class="line">modprobe ip_vs_rr nf_conntrack</span><br><span class="line">lsmod | egrep <span class="string">"ip_vs_rr|nf_conntrack"</span></span><br></pre></td></tr></table></figure></p>
<h1 id="环境变量文件"><a href="#环境变量文件" class="headerlink" title="环境变量文件"></a>环境变量文件</h1><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/kubernetes</span><br><span class="line">cat &lt;&lt; <span class="string">"EOF"</span> &gt; env.sh</span><br><span class="line"><span class="builtin-name">export</span> MASTER_IPS=(192.168.10.81 192.168.10.82 192.168.10.83)</span><br><span class="line"><span class="builtin-name">export</span> NODE_IPS=(192.168.10.81 192.168.10.82 192.168.10.83 192.168.10.84 192.168.10.85)</span><br><span class="line">NODE_NAMES=(k8s-master01 k8s-master02 k8s-master03 k8s-node01 k8s-node02)</span><br><span class="line"></span><br><span class="line"><span class="builtin-name">export</span> ETCD_IPS=(192.168.10.81 192.168.10.82 192.168.10.83)</span><br><span class="line"><span class="builtin-name">export</span> ETCD_NAMES=(<span class="string">"etcd-0"</span> <span class="string">"etcd-1"</span> <span class="string">"etcd-2"</span>)</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">ETCD_ENDPOINTS</span>=<span class="string">"https://192.168.10.81:2379,https://192.168.10.82:2379,https://192.168.10.83:2379"</span></span><br><span class="line"></span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">KUBE_SERVICE_IP</span>=<span class="string">"10.96.0.1"</span> #<span class="attribute">SERVICE_CIDR</span>=<span class="string">"10.96.0.0/12"</span>中第一个IP</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">KUBE_APISERVER_IP</span>=<span class="string">"192.168.10.80"</span> #高可用IP</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">KUBE_APISERVER_URL</span>=<span class="string">"https://192.168.10.80:8443"</span> #高可用URL</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">ELB_APISERVER_DOMAIN</span>=<span class="string">"kube-apiserver.elb.sundayle.com"</span> # ELB域名</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">SERVICE_CIDR</span>=<span class="string">"10.96.0.0/12"</span></span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">POD_CIDR</span>=<span class="string">"10.244.0.0/16"</span></span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">NODE_PORT_RANGE</span>=<span class="string">"30000-32767"</span></span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">DNS_SERVICE_IP</span>=<span class="string">"10.96.0.10"</span></span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">GCR_MIRROR</span>=<span class="string">"gcr.azk8s.cn/google_containers"</span></span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">QUAY_MIRROR</span>=<span class="string">"quay.azk8s.cn"</span></span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">DNS_DOMAIN</span>=<span class="string">"cluster.local"</span></span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">ENCRYPTION_KEY</span>=$(head -c 32 /dev/urandom | base64)</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h1 id="部署cfssl"><a href="#部署cfssl" class="headerlink" title="部署cfssl"></a>部署cfssl</h1><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -s -L -o <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>cfssl https:<span class="regexp">//</span>pkg.cfssl.org<span class="regexp">/R1.2/</span>cfssl_linux-amd64</span><br><span class="line">curl -s -L -o <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>cfssljson https:<span class="regexp">//</span>pkg.cfssl.org<span class="regexp">/R1.2/</span>cfssljson_linux-amd64</span><br><span class="line">chmod +x <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>&#123;cfssl,cfssljson&#125;</span><br></pre></td></tr></table></figure>
<h1 id="配置证书"><a href="#配置证书" class="headerlink" title="配置证书"></a>配置证书</h1><blockquote>
<p>只需创建一个CA证书，后续创建的所有证书(kubernetes+etcd)都是由它签名</p>
</blockquote>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mkdir</span> -p /etc/kubernetes/ssl</span><br><span class="line"><span class="keyword">cd</span> /etc/kubernetes/ssl</span><br><span class="line"><span class="keyword">cat</span> &gt; <span class="keyword">ca</span>-config.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"signing"</span>: &#123;</span><br><span class="line">    <span class="string">"default"</span>: &#123;</span><br><span class="line">      <span class="string">"expiry"</span>: <span class="string">"876000h"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"profiles"</span>: &#123;</span><br><span class="line">      <span class="string">"kubernetes"</span>: &#123;</span><br><span class="line">        <span class="string">"usages"</span>: [</span><br><span class="line">            <span class="string">"signing"</span>,</span><br><span class="line">            <span class="string">"key encipherment"</span>,</span><br><span class="line">            <span class="string">"server auth"</span>,</span><br><span class="line">            <span class="string">"client auth"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"expiry"</span>: <span class="string">"876000h"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 创建证书签名请求文件</span><br><span class="line"><span class="keyword">cat</span> &gt; <span class="keyword">ca</span>-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"Guangzhou"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"Guangzhou"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"ca"</span>: &#123;</span><br><span class="line">    <span class="string">"expiry"</span>: <span class="string">"876000h"</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 生成<span class="keyword">CA</span>证书和私钥</span><br><span class="line">cfssl gencert -initca <span class="keyword">ca</span>-csr.json | cfssljson -bare <span class="keyword">ca</span></span><br><span class="line"></span><br><span class="line">source /etc/kubernetes/env.<span class="keyword">sh</span></span><br><span class="line"><span class="keyword">for</span> NODE <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS</span>[@]&#125;;<span class="keyword">do</span></span><br><span class="line">    ssh root@<span class="variable">$NODE</span> <span class="string">"mkdir -p /etc/kubernetes/ssl"</span></span><br><span class="line">    rsync /etc/kubernetes/ssl/<span class="keyword">ca</span>.pem  root@<span class="variable">$&#123;NODE&#125;</span>:/etc/etcd/ssl/</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p>etcd证书<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/kubernetes/ssl</span><br><span class="line">cat &gt; etcd-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"etcd"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [</span><br><span class="line">    <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="string">"192.168.10.81"</span>,</span><br><span class="line">    <span class="string">"192.168.10.82"</span>,</span><br><span class="line">    <span class="string">"192.168.10.83"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"Guangzhou"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"Guangzhou"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成证书和私钥</span></span><br><span class="line">cfssl gencert <span class="attribute">-ca</span>=ca.pem \</span><br><span class="line">    <span class="attribute">-ca-key</span>=ca-key.pem \</span><br><span class="line">    <span class="attribute">-config</span>=ca-config.json \</span><br><span class="line">    <span class="attribute">-profile</span>=kubernetes etcd-csr.json | cfssljson -bare etcd</span><br></pre></td></tr></table></figure></p>
<p>分发至etcd master<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">source /etc/kubernetes/env.sh</span><br><span class="line"><span class="keyword">for</span> NODE <span class="keyword">in</span> <span class="variable">$&#123;</span>ETCD_IPS[@]&#125;;<span class="keyword">do</span></span><br><span class="line">    ssh root@<span class="variable">$NODE</span> <span class="string">"mkdir -p /etc/etcd/ssl"</span></span><br><span class="line">    rsync /etc/kubernetes/ssl/ca*.pem  root@<span class="variable">$&#123;</span>NODE&#125;<span class="symbol">:/etc/etcd/ssl/</span></span><br><span class="line">    rsync /etc/etcd/ssl/etcd*.pem root@<span class="variable">$&#123;</span>NODE&#125;<span class="symbol">:/etc/etcd/ssl/</span></span><br><span class="line">done</span><br></pre></td></tr></table></figure></p>
<h1 id="部署etcd集群"><a href="#部署etcd集群" class="headerlink" title="部署etcd集群"></a>部署etcd集群</h1><p>etcd 是k8s集群最重要的组件，用来存储k8s的所有服务信息， etcd 挂了，集群就挂了，我们这里把etcd部署在master三台节点上做高可用，etcd集群采用raft算法选举Leader， 由于Raft算法在做决策时需要多数节点的投票，所以etcd一般部署集群推荐奇数个节点，推荐的数量为3、5或者7个节点构成一个集群</p>
<p><a href="https://github.com/coreos/etcd/releases" target="_blank" rel="noopener">https://github.com/coreos/etcd/releases</a><br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载和分发</span></span><br><span class="line">cd /usr/local/src</span><br><span class="line">wget <span class="symbol">https:</span>/<span class="regexp">/github.com/etcd</span>-io/etcd/releases/download/v3.<span class="number">4.1</span>/etcd-v3.<span class="number">4.1</span>-linux-amd64.tar.gz</span><br><span class="line">tar xf etcd-v3.<span class="number">4.1</span>-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">source /etc/kubernetes/env.sh</span><br><span class="line"><span class="keyword">for</span> NODE <span class="keyword">in</span> <span class="variable">$&#123;</span>ETCD_IPS[@]&#125;;<span class="keyword">do</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;</span>NODE&#125; <span class="string">"mkdir -p /usr/local/k8s/bin"</span></span><br><span class="line">    rsync etcd-v3.<span class="number">4.1</span>-linux-amd64/etc* root@<span class="variable">$&#123;</span>NODE&#125;<span class="symbol">:/usr/local/k8s/bin/</span></span><br><span class="line">done</span><br></pre></td></tr></table></figure></p>
<p>etcd.service<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">source /etc/kubernetes/env.sh</span><br><span class="line">#ETCD_IPS=(192.168.10.81 192.168.10.82 192.168.10.83)</span><br><span class="line">#ETCD_NAMES=("etcd-0" "etcd-1" "etcd-2")</span><br><span class="line">for i in "$&#123;!ETCD_IPS[@]&#125;"; do</span><br><span class="line">HOST=$&#123;ETCD_IPS[$i]&#125;</span><br><span class="line">NAME=$&#123;ETCD_NAMES[$i]&#125;</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt; ~/etcd.service.$&#123;HOST&#125;</span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">ExecStart=/usr/local/k8s/bin/etcd \\</span><br><span class="line">  -<span class="ruby">-data-dir=<span class="regexp">/data/etcd</span> \\</span></span><br><span class="line"><span class="ruby">  --name=$&#123;NAME&#125; \\</span></span><br><span class="line"><span class="ruby">  --trusted-ca-file=<span class="regexp">/etc/etcd</span><span class="regexp">/ssl/ca</span>.pem \\</span></span><br><span class="line"><span class="ruby">  --cert-file=<span class="regexp">/etc/etcd</span><span class="regexp">/ssl/etcd</span>.pem \\</span></span><br><span class="line"><span class="ruby">  --key-file=<span class="regexp">/etc/etcd</span><span class="regexp">/ssl/etcd</span>-key.pem \\</span></span><br><span class="line"><span class="ruby">  --peer-trusted-ca-file=<span class="regexp">/etc/etcd</span><span class="regexp">/ssl/ca</span>.pem \\</span></span><br><span class="line"><span class="ruby">  --peer-cert-file=<span class="regexp">/etc/etcd</span><span class="regexp">/ssl/etcd</span>.pem \\</span></span><br><span class="line"><span class="ruby">  --peer-key-file=<span class="regexp">/etc/etcd</span><span class="regexp">/ssl/etcd</span>-key.pem \\</span></span><br><span class="line"><span class="ruby">  --peer-client-cert-auth \\</span></span><br><span class="line"><span class="ruby">  --client-cert-auth \\</span></span><br><span class="line"><span class="ruby">  --listen-peer-urls=<span class="symbol">https:</span>/<span class="regexp">/$&#123;HOST&#125;:2380 \\</span></span></span><br><span class="line"><span class="ruby">  --initial-advertise-peer-urls=<span class="symbol">https:</span>/<span class="regexp">/$&#123;HOST&#125;:2380 \\</span></span></span><br><span class="line"><span class="ruby">  --listen-client-urls=<span class="symbol">https:</span>/<span class="regexp">/$&#123;HOST&#125;:2379,http:/</span><span class="regexp">/127.0.0.1:2379 \\</span></span></span><br><span class="line"><span class="ruby">  --advertise-client-urls=<span class="symbol">https:</span>/<span class="regexp">/$&#123;HOST&#125;:2379 \\</span></span></span><br><span class="line"><span class="ruby">  --initial-cluster-token=etcd-cluster-<span class="number">0</span> \\</span></span><br><span class="line"><span class="ruby">  --initial-cluster=$&#123;ETCD_NAMES[<span class="number">0</span>]&#125;=<span class="symbol">https:</span>/<span class="regexp">/$&#123;ETCD_IPS[0]&#125;:2380,$&#123;ETCD_NAMES[1]&#125;=https:/</span><span class="regexp">/$&#123;ETCD_IPS[1]&#125;:2380,$&#123;ETCD_NAMES[2]&#125;=https:/</span><span class="regexp">/$&#123;ETCD_IPS[2]&#125;:2380 \\</span></span></span><br><span class="line"><span class="ruby">  --initial-cluster-state=new \\</span></span><br><span class="line"><span class="ruby">  --auto-compaction-mode=periodic \\</span></span><br><span class="line"><span class="ruby">  --auto-compaction-retention=<span class="number">1</span> \\</span></span><br><span class="line"><span class="ruby">  --max-request-bytes=<span class="number">33554432</span> \\</span></span><br><span class="line"><span class="ruby">  --quota-backend-bytes=<span class="number">6442450944</span> \\</span></span><br><span class="line"><span class="ruby">  --heartbeat-interval=<span class="number">250</span> \\</span></span><br><span class="line"><span class="ruby">  --election-timeout=<span class="number">2000</span></span></span><br><span class="line"><span class="ruby">Restart=on-failure</span></span><br><span class="line"><span class="ruby">RestartSec=<span class="number">5</span></span></span><br><span class="line"><span class="ruby">LimitNOFILE=<span class="number">65536</span></span></span><br><span class="line"><span class="ruby">[Install]</span></span><br><span class="line"><span class="ruby">WantedBy=multi-user.target</span></span><br><span class="line"><span class="ruby">EOF</span></span><br><span class="line"><span class="ruby">done</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby"><span class="comment"># 分发</span></span></span><br><span class="line"><span class="ruby">source /etc/kubernetes/env.sh</span></span><br><span class="line"><span class="ruby"><span class="keyword">for</span> NODE <span class="keyword">in</span> $&#123;ETCD_IPS[@]&#125;;<span class="keyword">do</span></span></span><br><span class="line"><span class="ruby">    rsync ~<span class="regexp">/etcd.service.$&#123;NODE&#125; root@$&#123;NODE&#125;:/etc</span><span class="regexp">/systemd/system</span><span class="regexp">/etcd.service</span></span></span><br><span class="line"><span class="ruby">    ssh root@$&#123;NODE&#125; <span class="string">"mkdir -p /data/etcd"</span></span></span><br><span class="line"><span class="ruby">done</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby"><span class="keyword">for</span> NODE <span class="keyword">in</span> $&#123;ETCD_IPS[@]&#125;;<span class="keyword">do</span></span></span><br><span class="line"><span class="ruby">    ssh root@$&#123;NODE&#125; <span class="string">"systemctl enable etcd --now"</span></span></span><br><span class="line"><span class="ruby">done</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby"><span class="comment">#etcd首次进程启动会等待其他节点加入etcd集群，执行启动命令会卡顿一会，为正常现象</span></span></span><br><span class="line"><span class="ruby"><span class="comment">#journalctl -fu etcd 查看报错</span></span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby"><span class="comment"># 验证ETCD集群状态</span></span></span><br><span class="line"><span class="ruby">source /etc/kubernetes/env.sh</span></span><br><span class="line"><span class="ruby">ETCDCTL_API=<span class="number">3</span> /usr/local/k8s/bin/etcdctl \</span></span><br><span class="line"><span class="ruby">    --endpoints=$&#123;ETCD_ENDPOINTS&#125; \</span></span><br><span class="line"><span class="ruby">    --cacert=<span class="regexp">/etc/etcd</span><span class="regexp">/ssl/ca</span>.pem \</span></span><br><span class="line"><span class="ruby">    --cert=<span class="regexp">/etc/etcd</span><span class="regexp">/ssl/etcd</span>.pem \</span></span><br><span class="line"><span class="ruby">    --key=<span class="regexp">/etc/etcd</span><span class="regexp">/ssl/etcd</span>-key.pem endpoint health</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby"><span class="comment"># 查看etcd集群leader</span></span></span><br><span class="line"><span class="ruby">source /etc/kubernetes/env.sh</span></span><br><span class="line"><span class="ruby">ETCDCTL_API=<span class="number">3</span> /usr/local/k8s/bin/etcdctl \</span></span><br><span class="line"><span class="ruby">    -w table --cacert=<span class="regexp">/etc/etcd</span><span class="regexp">/ssl/ca</span>.pem \</span></span><br><span class="line"><span class="ruby">    --cert=<span class="regexp">/etc/etcd</span><span class="regexp">/ssl/etcd</span>.pem \</span></span><br><span class="line"><span class="ruby">    --key=<span class="regexp">/etc/etcd</span><span class="regexp">/ssl/etcd</span>-key.pem \</span></span><br><span class="line"><span class="ruby">    --endpoints=$&#123;ETCD_ENDPOINTS&#125; endpoint status</span></span><br></pre></td></tr></table></figure></p>
<h1 id="备份etcd"><a href="#备份etcd" class="headerlink" title="备份etcd"></a>备份etcd</h1><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="attribute">BACKUP_DIR</span>=/data/bak/etcd</span><br><span class="line"><span class="attribute">DATE</span>=$(date +%Y%m%d%H%M)</span><br><span class="line">[[ ! -d <span class="variable">$BACKUP_DIR</span> ]] &amp;&amp; mkdir -p <span class="variable">$BACKUP_DIR</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">ETCD_ENDPOINTS</span>=<span class="string">"https://192.168.10.21:2379"</span></span><br><span class="line"><span class="attribute">ETCDCTL_API</span>=3 /usr/local/k8s/bin/etcdctl \</span><br><span class="line">    <span class="attribute">--endpoints</span>=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> \</span><br><span class="line">    <span class="attribute">--cacert</span>=/etc/etcd/ssl/ca.pem \</span><br><span class="line">    <span class="attribute">--cert</span>=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">    <span class="attribute">--key</span>=/etc/etcd/ssl/etcd-key.pem snapshot save <span class="variable">$BACKUP_DIR</span>/snap-<span class="variable">$DATE</span>.db</span><br><span class="line"></span><br><span class="line"><span class="attribute">result</span>=$?</span><br><span class="line">[ <span class="string">"<span class="variable">$result</span>"</span> == 0 ] &amp;&amp; <span class="builtin-name">find</span> <span class="variable">$BACKUP_DIR</span> -mtime +7 | xargs rm -rf</span><br></pre></td></tr></table></figure>
<h1 id="部署高可用"><a href="#部署高可用" class="headerlink" title="部署高可用"></a>部署高可用</h1><p><strong>部署haproxy</strong></p>
<ul>
<li>使用haproxy实现k8s节点(master节点和node节点)高可用访问kube-apiserver的步骤</li>
<li>控制节点的kube-controller-manager、kube-scheduler是多实例部署，所以只要一个实例正常，就可以保证集群高可用</li>
<li>集群内的Pod使用k8s服务域名kubernetes访问kube-apiserver，kube-dns会自动解析多个kube-apiserver节点的IP，所以也是高可用的</li>
</ul>
<p>配置haproxy<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">yum install -y haproxy</span><br><span class="line">cat &gt; /etc/haproxy/haproxy.cfg &lt;&lt;EOF</span><br><span class="line">global</span><br><span class="line">    log         127.0.0.1 local2</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">   <span class="built_in"> user </span>       haproxy</span><br><span class="line">   <span class="built_in"> group </span>      haproxy</span><br><span class="line">    daemon</span><br><span class="line"></span><br><span class="line">    # turn on stats unix socket</span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    mode                    http</span><br><span class="line">    log                     global</span><br><span class="line">    option                  httplog</span><br><span class="line">    option                  dontlognull</span><br><span class="line">    option http-server-close</span><br><span class="line">    option forwardfor       except 127.0.0.0/8</span><br><span class="line">    option                  redispatch</span><br><span class="line">    retries                 3</span><br><span class="line">    timeout http-request    10s</span><br><span class="line">    timeout<span class="built_in"> queue </span>          1m</span><br><span class="line">    timeout connect         10s</span><br><span class="line">    timeout<span class="built_in"> client </span>         1m</span><br><span class="line">    timeout<span class="built_in"> server </span>         1m</span><br><span class="line">    timeout http-keep-alive 10s</span><br><span class="line">    timeout check           10s</span><br><span class="line">    maxconn                 3000</span><br><span class="line"></span><br><span class="line">frontend kubernetes-apiserver</span><br><span class="line">    mode                 tcp</span><br><span class="line">    bind                 *:8443</span><br><span class="line">    option               tcplog</span><br><span class="line">    default_backend      kubernetes-apiserver</span><br><span class="line"></span><br><span class="line">backend kubernetes-apiserver</span><br><span class="line">    mode        tcp</span><br><span class="line">    balance     roundrobin</span><br><span class="line">   <span class="built_in"> server </span>     k8s01 192.168.10.81:6443 check</span><br><span class="line">   <span class="built_in"> server </span>     k8s02 192.168.10.82:6443 check</span><br><span class="line">   <span class="built_in"> server </span>     k8s03 192.168.10.83:6443 check</span><br><span class="line"></span><br><span class="line">listen stats</span><br><span class="line">    bind                 *:1080</span><br><span class="line">    stats auth           admin:sunday</span><br><span class="line">    stats refresh        5s</span><br><span class="line">    stats realm          HAProxy\ Statistics</span><br><span class="line">    stats uri            /haproxy-stats</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分发</span></span><br><span class="line">source /etc/kubernetes/env.sh</span><br><span class="line"><span class="keyword">for</span> NODE <span class="keyword">in</span> <span class="variable">$&#123;MASTER_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;NODE&#125;</span> <span class="string">"yum  install -y haproxy"</span></span><br><span class="line">    rsync /etc/haproxy/haproxy.cfg <span class="variable">$&#123;NODE&#125;</span>:/etc/haproxy/</span><br><span class="line">    ssh root@<span class="variable">$&#123;NODE&#125;</span> <span class="string">"systemctl enable --now haproxy"</span></span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">ss -tunlp |grep 8443</span><br></pre></td></tr></table></figure></p>
<p><strong>部署keeplived</strong><br>高可用方案需要一个VIP，供集群内部访问</p>
<p>配置keeplived服务<br><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">yum install -y keepalived psmisc</span><br><span class="line">cat &gt; /etc/keepalived/keepalived.conf &lt;&lt;EOF</span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id keepalived</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check_haproxy &#123;</span><br><span class="line">    script <span class="string">"killall -0 haproxy"</span></span><br><span class="line">    interval <span class="number">2</span></span><br><span class="line">    weight -<span class="number">3</span></span><br><span class="line">    fall <span class="number">2</span></span><br><span class="line">    rise <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id <span class="number">247</span></span><br><span class="line">    priority <span class="number">100</span></span><br><span class="line">    advert_int <span class="number">1</span></span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass Sunday</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        <span class="number">192.168</span>.<span class="number">10.80</span></span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_haproxy</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分发</span></span><br><span class="line">source /etc/kubernetes/env.sh</span><br><span class="line"><span class="keyword">for</span> NODE <span class="keyword">in</span> $&#123;MASTER_IPS[@]&#125;;<span class="keyword">do</span></span><br><span class="line">    ssh root@$&#123;NODE&#125; <span class="string">"yum  install -y keepalived psmisc"</span></span><br><span class="line">    rsync  /etc/keepalived/keepalived.conf $NODE:/etc/keepalived/keepalived.conf</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"><span class="comment"># 替换</span></span><br><span class="line">ssh root@<span class="number">192.168</span>.<span class="number">10.82</span> <span class="string">"sed -i -e 's<span class="subst">#MASTER</span><span class="subst">#BACKUP</span><span class="subst">#g</span>' -e 's<span class="subst">#priority</span> 100<span class="subst">#priority</span> 99<span class="subst">#g</span>' /etc/keepalived/keepalived.conf"</span></span><br><span class="line">ssh root@<span class="number">192.168</span>.<span class="number">10.83</span> <span class="string">"sed -i -e 's<span class="subst">#MASTER</span><span class="subst">#BACKUP</span><span class="subst">#g</span>' -e 's<span class="subst">#priority</span> 100<span class="subst">#priority</span> 98<span class="subst">#g</span>' /etc/keepalived/keepalived.conf"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动keeplived</span></span><br><span class="line">source /etc/kubernetes/env.sh</span><br><span class="line"><span class="keyword">for</span> NODE <span class="keyword">in</span> $&#123;MASTER_IPS[@]&#125;; <span class="keyword">do</span></span><br><span class="line">    ssh $NODE <span class="string">'systemctl enable --now keepalived'</span></span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动完毕后ping 192.168.10.80 (VIP)</span></span><br><span class="line"><span class="comment"># ping -c 2 192.168.10.80</span></span><br><span class="line">PING <span class="number">192.168</span>.<span class="number">10.80</span> (<span class="number">192.168</span>.<span class="number">10.80</span>) <span class="number">56</span>(<span class="number">84</span>) bytes <span class="keyword">of</span> data.</span><br><span class="line"><span class="number">64</span> bytes <span class="keyword">from</span> <span class="number">192.168</span>.<span class="number">10.80</span>: icmp_seq=<span class="number">1</span> ttl=<span class="number">64</span> time=<span class="number">0.045</span> ms</span><br><span class="line"><span class="number">64</span> bytes <span class="keyword">from</span> <span class="number">192.168</span>.<span class="number">10.80</span>: icmp_seq=<span class="number">2</span> ttl=<span class="number">64</span> time=<span class="number">0.052</span> ms</span><br></pre></td></tr></table></figure></p>
<h1 id="部署master二进制"><a href="#部署master二进制" class="headerlink" title="部署master二进制"></a>部署master二进制</h1><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat <span class="params">&lt;&lt; EOF &gt;</span> <span class="meta-keyword">/etc/</span>profile.d/k8s.sh </span><br><span class="line">export PATH=<span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/k8s/</span>bin:\$PATH</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>分发master二进制<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/src/</span><br><span class="line">wget <span class="symbol">https:</span>/<span class="regexp">/storage.googleapis.com/kubernetes</span>-release/release/v1.<span class="number">15.4</span>/kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">tar -xf kubernetes-server-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">source /etc/kubernetes/env.sh</span><br><span class="line"><span class="keyword">for</span> NODE <span class="keyword">in</span> <span class="variable">$&#123;</span>MASTER_IPS[@]&#125;;<span class="keyword">do</span></span><br><span class="line">    rsync /etc/profile.d/k8s.sh root@<span class="variable">$&#123;</span>NODE&#125;<span class="symbol">:/etc/profile</span>.d/</span><br><span class="line">    rsync kubernetes/server/bin/&#123;kube-apiserver,kube-controller-manager,kube-scheduler,kubeadm,kubectl&#125; root@<span class="variable">$&#123;</span>NODE&#125;<span class="symbol">:/usr/local/k8s/bin/</span></span><br><span class="line">done</span><br></pre></td></tr></table></figure></p>
<h1 id="部署kubectl"><a href="#部署kubectl" class="headerlink" title="部署kubectl"></a>部署kubectl</h1><p>创建admin证书<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/kubernetes/ssl/</span><br><span class="line">cat &gt; admin-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"admin"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"Guangzhou"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"Guangzhou"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"system:masters"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#生成证书和私钥</span></span><br><span class="line">cfssl gencert <span class="attribute">-ca</span>=ca.pem \</span><br><span class="line">  <span class="attribute">-ca-key</span>=ca-key.pem \</span><br><span class="line">  <span class="attribute">-config</span>=ca-config.json \</span><br><span class="line">  <span class="attribute">-profile</span>=kubernetes admin-csr.json | cfssljson -bare admin</span><br></pre></td></tr></table></figure></p>
<p>生成kubeconfig 配置文件<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/kubernetes/ssl</span><br><span class="line">source /etc/kubernetes/env.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置集群参数</span></span><br><span class="line">kubectl<span class="built_in"> config </span>set-cluster kubernetes \</span><br><span class="line">  <span class="attribute">--certificate-authority</span>=ca.pem \</span><br><span class="line">  <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line">  <span class="attribute">--server</span>=<span class="variable">$&#123;KUBE_APISERVER_URL&#125;</span> \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=/etc/kubernetes/kubectl.config</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置客户端认证参数</span></span><br><span class="line">kubectl<span class="built_in"> config </span>set-credentials admin \</span><br><span class="line">  <span class="attribute">--client-certificate</span>=admin.pem \</span><br><span class="line">  <span class="attribute">--client-key</span>=admin-key.pem \</span><br><span class="line">  <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=/etc/kubernetes/kubectl.config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置上下文参数</span></span><br><span class="line">kubectl<span class="built_in"> config </span>set-context kubernetes \</span><br><span class="line">  <span class="attribute">--cluster</span>=kubernetes \</span><br><span class="line">  <span class="attribute">--user</span>=admin \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=/etc/kubernetes/kubectl.config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置默认上下文</span></span><br><span class="line">kubectl<span class="built_in"> config </span>use-context kubernetes <span class="attribute">--kubeconfig</span>=/etc/kubernetes/kubectl.config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分发</span></span><br><span class="line">source /etc/kubernetes/env.sh</span><br><span class="line"><span class="keyword">for</span> NODE <span class="keyword">in</span> <span class="variable">$&#123;MASTER_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;NODE&#125;</span> <span class="string">"mkdir -p ~/.kube"</span></span><br><span class="line">    rsync /etc/kubernetes/kubectl.config root@<span class="variable">$&#123;NODE&#125;</span>:~/.kube/config</span><br><span class="line">    rsync /etc/kubernetes/ssl/admin*.pem root@<span class="variable">$&#123;NODE&#125;</span>:/etc/kubernetes/ssl/</span><br><span class="line">done</span><br></pre></td></tr></table></figure></p>
<h1 id="部署kube-apiserver"><a href="#部署kube-apiserver" class="headerlink" title="部署kube-apiserver"></a>部署kube-apiserver</h1><p>创建kube-apiserver证书和私钥<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">source /etc/kubernetes/env.sh</span><br><span class="line">cd /etc/kubernetes/ssl/</span><br><span class="line">cat &gt; kube-apiserver-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [</span><br><span class="line">    <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="string">"192.168.10.81"</span>,</span><br><span class="line">    <span class="string">"192.168.10.82"</span>,</span><br><span class="line">    <span class="string">"192.168.10.83"</span>,</span><br><span class="line">    <span class="string">"192.168.10.84"</span>,</span><br><span class="line">    <span class="string">"192.168.10.85"</span>,</span><br><span class="line">    <span class="string">"192.168.10.86"</span>,</span><br><span class="line">    <span class="string">"192.168.10.87"</span>,</span><br><span class="line">    <span class="string">"192.168.10.89"</span>,</span><br><span class="line">    <span class="string">"192.168.10.90"</span>,</span><br><span class="line">    <span class="string">"<span class="variable">$&#123;ELB_APISERVER_DOMAIN&#125;</span>"</span>,</span><br><span class="line">    <span class="string">"<span class="variable">$&#123;KUBE_APISERVER_IP&#125;</span>"</span>,</span><br><span class="line">    <span class="string">"<span class="variable">$&#123;KUBE_SERVICE_IP&#125;</span>"</span>,</span><br><span class="line">    <span class="string">"kubernetes"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default.svc"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default.svc.cluster"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default.svc.cluster.local."</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"Guangzhou"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"Guangzhou"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成证书和私钥</span></span><br><span class="line">cfssl gencert <span class="attribute">-ca</span>=ca.pem \</span><br><span class="line">      <span class="attribute">-ca-key</span>=ca-key.pem \</span><br><span class="line">      <span class="attribute">-config</span>=ca-config.json \</span><br><span class="line">      <span class="attribute">-profile</span>=kubernetes kube-apiserver-csr.json | cfssljson -bare kube-apiserver</span><br></pre></td></tr></table></figure></p>
<p>创建访问 metrics-server 证书<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/kubernetes/ssl/</span><br><span class="line">cat &gt; proxy-client-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"aggregator"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"Guangzhou"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"Guangzhou"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成证书和私钥</span></span><br><span class="line">cfssl gencert <span class="attribute">-ca</span>=ca.pem \</span><br><span class="line">  <span class="attribute">-ca-key</span>=ca-key.pem  \</span><br><span class="line">  <span class="attribute">-config</span>=ca-config.json  \</span><br><span class="line">  <span class="attribute">-profile</span>=kubernetes proxy-client-csr.json | cfssljson -bare proxy-client</span><br></pre></td></tr></table></figure></p>
<p>创建加密配置文件<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt; /etc/kubernetes/encryption-config.yaml &lt;&lt;EOF</span></span><br><span class="line"><span class="string"></span><span class="attr">kind:</span> <span class="string">EncryptionConfig</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">resources:</span></span><br><span class="line"><span class="attr">  - resources:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">secrets</span></span><br><span class="line"><span class="attr">    providers:</span></span><br><span class="line"><span class="attr">      - aescbc:</span></span><br><span class="line"><span class="attr">          keys:</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">key1</span></span><br><span class="line"><span class="attr">              secret:</span> <span class="string">$&#123;ENCRYPTION_KEY&#125;</span></span><br><span class="line"><span class="attr">      - identity:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure></p>
<p>创建审计策略文件<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/kubernetes/audit-policy.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: audit.k8s.io/v1beta1</span><br><span class="line">kind: Policy</span><br><span class="line">rules:</span><br><span class="line">  # The following requests were manually identified as high-volume and low-risk, so drop them.</span><br><span class="line">  -<span class="ruby"> <span class="symbol">level:</span> None</span></span><br><span class="line"><span class="ruby">    <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> <span class="string">""</span></span></span><br><span class="line"><span class="ruby">        <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">          - endpoints</span></span><br><span class="line"><span class="ruby">          - services</span></span><br><span class="line"><span class="ruby">          - services/status</span></span><br><span class="line"><span class="ruby">    <span class="symbol">users:</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'system:kube-proxy'</span></span></span><br><span class="line"><span class="ruby">    <span class="symbol">verbs:</span></span></span><br><span class="line"><span class="ruby">      - watch</span></span><br><span class="line"><span class="ruby">  - <span class="symbol">level:</span> None</span></span><br><span class="line"><span class="ruby">    <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> <span class="string">""</span></span></span><br><span class="line"><span class="ruby">        <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">          - nodes</span></span><br><span class="line"><span class="ruby">          - nodes/status</span></span><br><span class="line"><span class="ruby">    <span class="symbol">userGroups:</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'system:nodes'</span></span></span><br><span class="line"><span class="ruby">    <span class="symbol">verbs:</span></span></span><br><span class="line"><span class="ruby">      - get</span></span><br><span class="line"><span class="ruby">  - <span class="symbol">level:</span> None</span></span><br><span class="line"><span class="ruby">    <span class="symbol">namespaces:</span></span></span><br><span class="line"><span class="ruby">      - kube-system</span></span><br><span class="line"><span class="ruby">    <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> <span class="string">""</span></span></span><br><span class="line"><span class="ruby">        <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">          - endpoints</span></span><br><span class="line"><span class="ruby">    <span class="symbol">users:</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'system:kube-controller-manager'</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'system:kube-scheduler'</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'system:serviceaccount:kube-system:endpoint-controller'</span></span></span><br><span class="line"><span class="ruby">    <span class="symbol">verbs:</span></span></span><br><span class="line"><span class="ruby">      - get</span></span><br><span class="line"><span class="ruby">      - update</span></span><br><span class="line"><span class="ruby">  - <span class="symbol">level:</span> None</span></span><br><span class="line"><span class="ruby">    <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> <span class="string">""</span></span></span><br><span class="line"><span class="ruby">        <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">          - namespaces</span></span><br><span class="line"><span class="ruby">          - namespaces/status</span></span><br><span class="line"><span class="ruby">          - namespaces/finalize</span></span><br><span class="line"><span class="ruby">    <span class="symbol">users:</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'system:apiserver'</span></span></span><br><span class="line"><span class="ruby">    <span class="symbol">verbs:</span></span></span><br><span class="line"><span class="ruby">      - get</span></span><br><span class="line"><span class="ruby">  <span class="comment"># Don't log HPA fetching metrics.</span></span></span><br><span class="line"><span class="ruby">  - <span class="symbol">level:</span> None</span></span><br><span class="line"><span class="ruby">    <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> metrics.k8s.io</span></span><br><span class="line"><span class="ruby">    <span class="symbol">users:</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'system:kube-controller-manager'</span></span></span><br><span class="line"><span class="ruby">    <span class="symbol">verbs:</span></span></span><br><span class="line"><span class="ruby">      - get</span></span><br><span class="line"><span class="ruby">      - list</span></span><br><span class="line"><span class="ruby">  <span class="comment"># Don't log these read-only URLs.</span></span></span><br><span class="line"><span class="ruby">  - <span class="symbol">level:</span> None</span></span><br><span class="line"><span class="ruby">    <span class="symbol">nonResourceURLs:</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'/healthz*'</span></span></span><br><span class="line"><span class="ruby">      - <span class="regexp">/version</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'/swagger*'</span></span></span><br><span class="line"><span class="ruby">  <span class="comment"># Don't log events requests.</span></span></span><br><span class="line"><span class="ruby">  - <span class="symbol">level:</span> None</span></span><br><span class="line"><span class="ruby">    <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> <span class="string">""</span></span></span><br><span class="line"><span class="ruby">        <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">          - events</span></span><br><span class="line"><span class="ruby">  <span class="comment"># node and pod status calls from nodes are high-volume and can be large, don't log responses for expected updates from nodes</span></span></span><br><span class="line"><span class="ruby">  - <span class="symbol">level:</span> Request</span></span><br><span class="line"><span class="ruby">    <span class="symbol">omitStages:</span></span></span><br><span class="line"><span class="ruby">      - RequestReceived</span></span><br><span class="line"><span class="ruby">    <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> <span class="string">""</span></span></span><br><span class="line"><span class="ruby">        <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">          - nodes/status</span></span><br><span class="line"><span class="ruby">          - pods/status</span></span><br><span class="line"><span class="ruby">    <span class="symbol">users:</span></span></span><br><span class="line"><span class="ruby">      - kubelet</span></span><br><span class="line"><span class="ruby">      - <span class="string">'system:node-problem-detector'</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'system:serviceaccount:kube-system:node-problem-detector'</span></span></span><br><span class="line"><span class="ruby">    <span class="symbol">verbs:</span></span></span><br><span class="line"><span class="ruby">      - update</span></span><br><span class="line"><span class="ruby">      - patch</span></span><br><span class="line"><span class="ruby">  - <span class="symbol">level:</span> Request</span></span><br><span class="line"><span class="ruby">    <span class="symbol">omitStages:</span></span></span><br><span class="line"><span class="ruby">      - RequestReceived</span></span><br><span class="line"><span class="ruby">    <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> <span class="string">""</span></span></span><br><span class="line"><span class="ruby">        <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">          - nodes/status</span></span><br><span class="line"><span class="ruby">          - pods/status</span></span><br><span class="line"><span class="ruby">    <span class="symbol">userGroups:</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'system:nodes'</span></span></span><br><span class="line"><span class="ruby">    <span class="symbol">verbs:</span></span></span><br><span class="line"><span class="ruby">      - update</span></span><br><span class="line"><span class="ruby">      - patch</span></span><br><span class="line"><span class="ruby">  <span class="comment"># deletecollection calls can be large, don't log responses for expected namespace deletions</span></span></span><br><span class="line"><span class="ruby">  - <span class="symbol">level:</span> Request</span></span><br><span class="line"><span class="ruby">    <span class="symbol">omitStages:</span></span></span><br><span class="line"><span class="ruby">      - RequestReceived</span></span><br><span class="line"><span class="ruby">    <span class="symbol">users:</span></span></span><br><span class="line"><span class="ruby">      - <span class="string">'system:serviceaccount:kube-system:namespace-controller'</span></span></span><br><span class="line"><span class="ruby">    <span class="symbol">verbs:</span></span></span><br><span class="line"><span class="ruby">      - deletecollection</span></span><br><span class="line"><span class="ruby">  <span class="comment"># Secrets, ConfigMaps, and TokenReviews can contain sensitive &amp; binary data,</span></span></span><br><span class="line"><span class="ruby">  <span class="comment"># so only log at the Metadata level.</span></span></span><br><span class="line"><span class="ruby">  - <span class="symbol">level:</span> Metadata</span></span><br><span class="line"><span class="ruby">    <span class="symbol">omitStages:</span></span></span><br><span class="line"><span class="ruby">      - RequestReceived</span></span><br><span class="line"><span class="ruby">    <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> <span class="string">""</span></span></span><br><span class="line"><span class="ruby">        <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">          - secrets</span></span><br><span class="line"><span class="ruby">          - configmaps</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> authentication.k8s.io</span></span><br><span class="line"><span class="ruby">        <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">          - tokenreviews</span></span><br><span class="line"><span class="ruby">  <span class="comment"># Get repsonses can be large; skip them.</span></span></span><br><span class="line"><span class="ruby">  - <span class="symbol">level:</span> Request</span></span><br><span class="line"><span class="ruby">    <span class="symbol">omitStages:</span></span></span><br><span class="line"><span class="ruby">      - RequestReceived</span></span><br><span class="line"><span class="ruby">    <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> <span class="string">""</span></span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> admissionregistration.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> apiextensions.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> apiregistration.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> apps</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> authentication.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> authorization.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> autoscaling</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> batch</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> certificates.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> extensions</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> metrics.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> networking.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> policy</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> rbac.authorization.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> scheduling.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> settings.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> storage.k8s.io</span></span><br><span class="line"><span class="ruby">    <span class="symbol">verbs:</span></span></span><br><span class="line"><span class="ruby">      - get</span></span><br><span class="line"><span class="ruby">      - list</span></span><br><span class="line"><span class="ruby">      - watch</span></span><br><span class="line"><span class="ruby">  <span class="comment"># Default level for known APIs</span></span></span><br><span class="line"><span class="ruby">  - <span class="symbol">level:</span> RequestResponse</span></span><br><span class="line"><span class="ruby">    <span class="symbol">omitStages:</span></span></span><br><span class="line"><span class="ruby">      - RequestReceived</span></span><br><span class="line"><span class="ruby">    <span class="symbol">resources:</span></span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> <span class="string">""</span></span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> admissionregistration.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> apiextensions.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> apiregistration.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> apps</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> authentication.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> authorization.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> autoscaling</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> batch</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> certificates.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> extensions</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> metrics.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> networking.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> policy</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> rbac.authorization.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> scheduling.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> settings.k8s.io</span></span><br><span class="line"><span class="ruby">      - <span class="symbol">group:</span> storage.k8s.io</span></span><br><span class="line"><span class="ruby">  <span class="comment"># Default level for all other requests.</span></span></span><br><span class="line"><span class="ruby">  - <span class="symbol">level:</span> Metadata</span></span><br><span class="line"><span class="ruby">    <span class="symbol">omitStages:</span></span></span><br><span class="line"><span class="ruby">      - RequestReceived</span></span><br><span class="line"><span class="ruby">EOF</span></span><br></pre></td></tr></table></figure></p>
<p>kube-apiserver.service<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">source /etc/kubernetes/env.sh</span><br><span class="line">for i in "$&#123;!MASTER_IPS[@]&#125;"; do</span><br><span class="line">NODE=$&#123;MASTER_IPS[$i]&#125;</span><br><span class="line">cat &gt; ~/kube-apiserver.service.$NODE &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/k8s/bin/kube-apiserver \\</span><br><span class="line">  -<span class="ruby">-advertise-address=$&#123;NODE&#125; \\</span></span><br><span class="line"><span class="ruby">  --default-<span class="keyword">not</span>-ready-toleration-seconds=<span class="number">300</span> \\</span></span><br><span class="line"><span class="ruby">  --default-unreachable-toleration-seconds=<span class="number">300</span> \\</span></span><br><span class="line"><span class="ruby">  --feature-gates=DynamicAuditing=<span class="literal">true</span> \\</span></span><br><span class="line"><span class="ruby">  --max-mutating-requests-inflight=<span class="number">2000</span> \\</span></span><br><span class="line"><span class="ruby">  --max-requests-inflight=<span class="number">4000</span> \\</span></span><br><span class="line"><span class="ruby">  --default-watch-cache-size=<span class="number">200</span> \\</span></span><br><span class="line"><span class="ruby">  --delete-collection-workers=<span class="number">2</span> \\</span></span><br><span class="line"><span class="ruby">  --encryption-provider-config=<span class="regexp">/etc/kubernetes</span><span class="regexp">/encryption-config.yaml \\</span></span></span><br><span class="line"><span class="ruby">  --etcd-cafile=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/ca</span>.pem \\</span></span><br><span class="line"><span class="ruby">  --etcd-certfile=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/kube</span>-apiserver.pem \\</span></span><br><span class="line"><span class="ruby">  --etcd-keyfile=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/kube</span>-apiserver-key.pem \\</span></span><br><span class="line"><span class="ruby">  --etcd-servers=$&#123;ETCD_ENDPOINTS&#125; \\</span></span><br><span class="line"><span class="ruby">  --bind-address=$&#123;NODE&#125; \\</span></span><br><span class="line"><span class="ruby">  --secure-port=<span class="number">6443</span> \\</span></span><br><span class="line"><span class="ruby">  --tls-cert-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/kube</span>-apiserver.pem \\</span></span><br><span class="line"><span class="ruby">  --tls-private-key-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/kube</span>-apiserver-key.pem \\</span></span><br><span class="line"><span class="ruby">  --insecure-port=<span class="number">0</span> \\</span></span><br><span class="line"><span class="ruby">  --audit-dynamic-configuration \\</span></span><br><span class="line"><span class="ruby">  --audit-log-maxage=<span class="number">15</span> \\</span></span><br><span class="line"><span class="ruby">  --audit-log-maxbackup=<span class="number">3</span> \\</span></span><br><span class="line"><span class="ruby">  --audit-log-maxsize=<span class="number">100</span> \\</span></span><br><span class="line"><span class="ruby">  --audit-log-truncate-enabled \\</span></span><br><span class="line"><span class="ruby">  --audit-log-path=<span class="regexp">/data/logs</span><span class="regexp">/kube-apiserver/audit</span>.log \\</span></span><br><span class="line"><span class="ruby">  --audit-policy-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/audit-policy.yaml \\</span></span></span><br><span class="line"><span class="ruby">  --profiling \\</span></span><br><span class="line"><span class="ruby">  --anonymous-auth=<span class="literal">false</span> \\</span></span><br><span class="line"><span class="ruby">  --client-ca-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/ca</span>.pem \\</span></span><br><span class="line"><span class="ruby">  --enable-bootstrap-token-auth \\</span></span><br><span class="line"><span class="ruby">  --requestheader-allowed-names=<span class="string">"aggregator"</span> \\</span></span><br><span class="line"><span class="ruby">  --requestheader-client-ca-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/ca</span>.pem \\</span></span><br><span class="line"><span class="ruby">  --requestheader-extra-headers-prefix=<span class="string">"X-Remote-Extra-"</span> \\</span></span><br><span class="line"><span class="ruby">  --requestheader-group-headers=X-Remote-Group \\</span></span><br><span class="line"><span class="ruby">  --requestheader-username-headers=X-Remote-User \\</span></span><br><span class="line"><span class="ruby">  --service-account-key-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/ca</span>.pem \\</span></span><br><span class="line"><span class="ruby">  --authorization-mode=Node,RBAC \\</span></span><br><span class="line"><span class="ruby">  --runtime-config=api/all=<span class="literal">true</span> \\</span></span><br><span class="line"><span class="ruby">  --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction \\</span></span><br><span class="line"><span class="ruby">  --allow-privileged=<span class="literal">true</span> \\</span></span><br><span class="line"><span class="ruby">  --apiserver-count=<span class="number">3</span> \\</span></span><br><span class="line"><span class="ruby">  --event-ttl=<span class="number">168</span>h \\</span></span><br><span class="line"><span class="ruby">  --kubelet-certificate-authority=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/ca</span>.pem \\</span></span><br><span class="line"><span class="ruby">  --kubelet-client-certificate=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/kube</span>-apiserver.pem \\</span></span><br><span class="line"><span class="ruby">  --kubelet-client-key=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/kube</span>-apiserver-key.pem \\</span></span><br><span class="line"><span class="ruby">  --kubelet-https=<span class="literal">true</span> \\</span></span><br><span class="line"><span class="ruby">  --kubelet-timeout=<span class="number">10</span>s \\</span></span><br><span class="line"><span class="ruby">  --proxy-client-cert-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/proxy</span>-client.pem \\</span></span><br><span class="line"><span class="ruby">  --proxy-client-key-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/proxy</span>-client-key.pem \\</span></span><br><span class="line"><span class="ruby">  --service-cluster-ip-range=$&#123;SERVICE_CIDR&#125; \\</span></span><br><span class="line"><span class="ruby">  --service-node-port-range=$&#123;NODE_PORT_RANGE&#125; \\</span></span><br><span class="line"><span class="ruby">  --logtostderr=<span class="literal">true</span> \\</span></span><br><span class="line"><span class="ruby">  --v=<span class="number">2</span></span></span><br><span class="line"><span class="ruby">Restart=on-failure</span></span><br><span class="line"><span class="ruby">RestartSec=<span class="number">10</span></span></span><br><span class="line"><span class="ruby">Type=notify</span></span><br><span class="line"><span class="ruby">LimitNOFILE=<span class="number">65536</span></span></span><br><span class="line"><span class="ruby">[Install]</span></span><br><span class="line"><span class="ruby">WantedBy=multi-user.target</span></span><br><span class="line"><span class="ruby">EOF</span></span><br><span class="line"><span class="ruby">done</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 分发</span></span><br><span class="line"><span class="built_in">cd</span> /etc/kubernetes/ssl</span><br><span class="line"><span class="keyword">for</span> NODE <span class="keyword">in</span> <span class="variable">$&#123;MASTER_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    rsync /etc/kubernetes/ssl/ca*.pem root@<span class="variable">$&#123;NODE&#125;</span>:/etc/kubernetes/ssl/</span><br><span class="line">    rsync proxy-client*.pem root@<span class="variable">$&#123;NODE&#125;</span>:/etc/kubernetes/ssl/</span><br><span class="line">    rsync /etc/kubernetes/ssl/kube-apiserver*.pem root@<span class="variable">$&#123;NODE&#125;</span>:/etc/kubernetes/ssl/</span><br><span class="line">    rsync encryption-config.yaml audit-policy.yaml root@<span class="variable">$&#123;NODE&#125;</span>:/etc/kubernetes/</span><br><span class="line">    rsync ~/kube-apiserver.service.<span class="variable">$&#123;NODE&#125;</span> root@<span class="variable">$&#123;NODE&#125;</span>:/etc/systemd/system/kube-apiserver.service</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动apiserver</span></span><br><span class="line"><span class="keyword">for</span> NODE <span class="keyword">in</span> <span class="variable">$&#123;MASTER_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;NODE&#125;</span> <span class="string">"mkdir -p /data/logs/kube-apiserver"</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;NODE&#125;</span> <span class="string">"systemctl daemon-reload &amp;&amp; systemctl enable kube-apiserver --now"</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查服务是否正常</span></span><br><span class="line"><span class="keyword">for</span> NODE <span class="keyword">in</span> <span class="variable">$&#123;MASTER_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;NODE&#125;</span> <span class="string">"systemctl status kube-apiserver |grep 'Active:'"</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 确保状态为active (running)，否则查看日志，确认原因</span></span><br><span class="line"> journalctl -u kube-apiserver</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印kube-apiserver写入etcd数据</span></span><br><span class="line"><span class="built_in">source</span> /etc/kubernetes/env.sh</span><br><span class="line">ETCDCTL_API=3 etcdctl \</span><br><span class="line">    --endpoints=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> \</span><br><span class="line">    --cacert=/etc/etcd/ssl/ca.pem \</span><br><span class="line">    --cert=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">    --key=/etc/etcd/ssl/etcd-key.pem \</span><br><span class="line">    get /registry/ --prefix --keys-only</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查kube-apiserver监听的端口</span></span><br><span class="line"><span class="comment"># netstat -lntup|grep kube</span></span><br><span class="line">tcp        0      0 192.168.10.81:6443      0.0.0.0:*               LISTEN      2069/kube-apiserver</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查集群信息</span></span><br><span class="line"><span class="comment"># kubectl cluster-info</span></span><br><span class="line">Kubernetes master is running at https://192.168.10.80:8443</span><br><span class="line"></span><br><span class="line">To further debug and diagnose cluster problems, use <span class="string">'kubectl cluster-info dump'</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get all --all-namespaces</span></span><br><span class="line">NAMESPACE   NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">default     service/kubernetes   ClusterIP   10.96.0.1   &lt;none&gt;        443/TCP   57m</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get cs</span></span><br><span class="line">NAME                 STATUS      MESSAGE                                                                                     ERROR</span><br><span class="line">controller-manager   Unhealthy   Get http://127.0.0.1:10252/healthz: dial tcp 127.0.0.1:10252: connect: connection refused   </span><br><span class="line">scheduler            Unhealthy   Get http://127.0.0.1:10251/healthz: dial tcp 127.0.0.1:10251: connect: connection refused   </span><br><span class="line">etcd-0               Healthy     &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;                                                                           </span><br><span class="line">etcd-2               Healthy     &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;                                                                           </span><br><span class="line">etcd-1               Healthy     &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">#如果提示有报错，请检查~/.kube/config以及配置证书是否有问题</span></span><br></pre></td></tr></table></figure>
<p>授权kube-apiserver访问kubelet API的权限<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding kube-apiserver:kubelet-apis --<span class="attr">clusterrole=</span>system:kubelet-api-admin --<span class="keyword">user</span> <span class="title">kubernetes</span></span><br></pre></td></tr></table></figure></p>
<h1 id="部署kube-controller-manager"><a href="#部署kube-controller-manager" class="headerlink" title="部署kube-controller-manager"></a>部署kube-controller-manager</h1><p>三台 kube-controller-manager 集群，启动后通过竞争选举机制产生一个leader节点，其他节点为阻塞状态。当leader节点不可用时，阻塞节点将会在此选举产生新的leader，从而保证服务的高可用。</p>
<p>创建kube-controller-manager证书<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/kubernetes/ssl/</span><br><span class="line">cat &gt; kube-controller-manager-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"system:kube-controller-manager"</span>,</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"hosts"</span>: [</span><br><span class="line">      <span class="string">"127.0.0.1"</span>,</span><br><span class="line">      <span class="string">"192.168.10.81"</span>,</span><br><span class="line">      <span class="string">"192.168.10.82"</span>,</span><br><span class="line">      <span class="string">"192.168.10.83"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">        <span class="string">"ST"</span>: <span class="string">"Guangzhou"</span>,</span><br><span class="line">        <span class="string">"L"</span>: <span class="string">"Guangzhou"</span>,</span><br><span class="line">        <span class="string">"O"</span>: <span class="string">"system:kube-controller-manager"</span>,</span><br><span class="line">        <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成证书和私钥</span></span><br><span class="line">cfssl gencert <span class="attribute">-ca</span>=ca.pem \</span><br><span class="line">  <span class="attribute">-ca-key</span>=ca-key.pem \</span><br><span class="line">  <span class="attribute">-config</span>=ca-config.json \</span><br><span class="line">  <span class="attribute">-profile</span>=kubernetes kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager</span><br></pre></td></tr></table></figure></p>
<p>kube-controller-manager.kubeconfig<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/kubernetes/ssl/</span><br><span class="line">source /etc/kubernetes/env.sh </span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>set-cluster kubernetes \</span><br><span class="line">  <span class="attribute">--certificate-authority</span>=ca.pem \</span><br><span class="line">  <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line">  <span class="attribute">--server</span>=<span class="variable">$&#123;KUBE_APISERVER_URL&#125;</span> \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=/etc/kubernetes/kube-controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>set-credentials system:kube-controller-manager \</span><br><span class="line">  <span class="attribute">--client-certificate</span>=kube-controller-manager.pem \</span><br><span class="line">  <span class="attribute">--client-key</span>=kube-controller-manager-key.pem \</span><br><span class="line">  <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=/etc/kubernetes/kube-controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>set-context system:kube-controller-manager \</span><br><span class="line">  <span class="attribute">--cluster</span>=kubernetes \</span><br><span class="line">  <span class="attribute">--user</span>=system:kube-controller-manager \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=/etc/kubernetes/kube-controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>use-context system:kube-controller-manager <span class="attribute">--kubeconfig</span>=/etc/kubernetes/kube-controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment">#kube-controller-manager使用kubeconfig文件访问apiserver</span></span><br><span class="line"><span class="comment">#该文件提供了apiserver地址、嵌入的CA证书和kube-controller-manager证书</span></span><br></pre></td></tr></table></figure></p>
<p>kube-controller-manager.service<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">source /etc/kubernetes/env.sh</span><br><span class="line">cat &gt; ~/kube-controller-manager.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/k8s/bin/kube-controller-manager \\</span><br><span class="line">  -<span class="ruby">-profiling \\</span></span><br><span class="line"><span class="ruby">  --cluster-name=kubernetes \\</span></span><br><span class="line"><span class="ruby">  --controllers=*,bootstrapsigner,tokencleaner \\</span></span><br><span class="line"><span class="ruby">  --kube-api-qps=<span class="number">1000</span> \\</span></span><br><span class="line"><span class="ruby">  --kube-api-burst=<span class="number">2000</span> \\</span></span><br><span class="line"><span class="ruby">  --leader-elect \\</span></span><br><span class="line"><span class="ruby">  --use-service-account-credentials\\</span></span><br><span class="line"><span class="ruby">  --concurrent-service-syncs=<span class="number">2</span> \\</span></span><br><span class="line"><span class="ruby">  --bind-address=<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span> \\</span></span><br><span class="line"><span class="ruby">  <span class="comment">#--secure-port=10252 \\</span></span></span><br><span class="line"><span class="ruby">  --tls-cert-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/kube</span>-controller-manager.pem \\</span></span><br><span class="line"><span class="ruby">  --tls-private-key-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/kube</span>-controller-manager-key.pem \\</span></span><br><span class="line"><span class="ruby">  <span class="comment">#--port=0 \\</span></span></span><br><span class="line"><span class="ruby">  --authentication-kubeconfig=<span class="regexp">/etc/kubernetes</span><span class="regexp">/kube-controller-manager.kubeconfig \\</span></span></span><br><span class="line"><span class="ruby">  --client-ca-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/ca</span>.pem \\</span></span><br><span class="line"><span class="ruby">  --requestheader-allowed-names=<span class="string">""</span> \\</span></span><br><span class="line"><span class="ruby">  --requestheader-client-ca-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/ca</span>.pem \\</span></span><br><span class="line"><span class="ruby">  --requestheader-extra-headers-prefix=<span class="string">"X-Remote-Extra-"</span> \\</span></span><br><span class="line"><span class="ruby">  --requestheader-group-headers=X-Remote-Group \\</span></span><br><span class="line"><span class="ruby">  --requestheader-username-headers=X-Remote-User \\</span></span><br><span class="line"><span class="ruby">  --authorization-kubeconfig=<span class="regexp">/etc/kubernetes</span><span class="regexp">/kube-controller-manager.kubeconfig \\</span></span></span><br><span class="line"><span class="ruby">  --cluster-signing-cert-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/ca</span>.pem \\</span></span><br><span class="line"><span class="ruby">  --cluster-signing-key-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/ca</span>-key.pem \\</span></span><br><span class="line"><span class="ruby">  --experimental-cluster-signing-duration=<span class="number">87600</span>h \\</span></span><br><span class="line"><span class="ruby">  --horizontal-pod-autoscaler-sync-period=<span class="number">10</span>s \\</span></span><br><span class="line"><span class="ruby">  --concurrent-deployment-syncs=<span class="number">10</span> \\</span></span><br><span class="line"><span class="ruby">  --concurrent-gc-syncs=<span class="number">30</span> \\</span></span><br><span class="line"><span class="ruby">  --node-cidr-mask-size=<span class="number">24</span> \\</span></span><br><span class="line"><span class="ruby">  --service-cluster-ip-range=$&#123;SERVICE_CIDR&#125; \\</span></span><br><span class="line"><span class="ruby">  --pod-eviction-timeout=<span class="number">6</span>m \\</span></span><br><span class="line"><span class="ruby">  --terminated-pod-gc-threshold=<span class="number">10000</span> \\</span></span><br><span class="line"><span class="ruby">  --root-ca-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/ca</span>.pem \\</span></span><br><span class="line"><span class="ruby">  --service-account-private-key-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/ca</span>-key.pem \\</span></span><br><span class="line"><span class="ruby">  --kubeconfig=<span class="regexp">/etc/kubernetes</span><span class="regexp">/kube-controller-manager.kubeconfig \\</span></span></span><br><span class="line"><span class="ruby">  --logtostderr=<span class="literal">true</span> \\</span></span><br><span class="line"><span class="ruby">  --v=<span class="number">2</span></span></span><br><span class="line"><span class="ruby">Restart=on-failure</span></span><br><span class="line"><span class="ruby">RestartSec=<span class="number">5</span></span></span><br><span class="line"><span class="ruby">[Install]</span></span><br><span class="line"><span class="ruby">WantedBy=multi-user.target</span></span><br><span class="line"><span class="ruby">EOF</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 分发</span></span><br><span class="line"><span class="built_in">source</span> /etc/kubernetes/env.sh</span><br><span class="line"><span class="keyword">for</span> NODE <span class="keyword">in</span> <span class="variable">$&#123;MASTER_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    rsync /etc/kubernetes/ssl/kube-controller-manager*.pem root@<span class="variable">$&#123;NODE&#125;</span>:/etc/kubernetes/ssl/</span><br><span class="line">    rsync /etc/kubernetes/kube-controller-manager.kubeconfig root@<span class="variable">$&#123;NODE&#125;</span>:/etc/kubernetes/</span><br><span class="line">    rsync ~/kube-controller-manager.service root@<span class="variable">$&#123;NODE&#125;</span>:/etc/systemd/system/kube-controller-manager.service</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动服务</span></span><br><span class="line"><span class="keyword">for</span> NODE <span class="keyword">in</span> <span class="variable">$&#123;MASTER_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;NODE&#125;</span> <span class="string">"systemctl daemon-reload &amp;&amp; systemctl enable kube-controller-manager --now"</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查运行状态</span></span><br><span class="line"><span class="keyword">for</span> NODE <span class="keyword">in</span> <span class="variable">$&#123;MASTER_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;NODE&#125;</span> <span class="string">"systemctl status kube-controller-manager|grep Active"</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查服务状态</span></span><br><span class="line">netstat -lnpt | grep kube-cont</span><br><span class="line">tcp6       0      0 :::10252                :::*                    LISTEN      110807/kube-control </span><br><span class="line">tcp6       0      0 :::10257                :::*                    LISTEN      110807/kube-control</span><br></pre></td></tr></table></figure>
<p>kube-controller-manager 创建权限</p>
<p>ClusteRole system:kube-controller-manager的权限太小，只能创建secret、serviceaccount等资源,将controller的权限分散到ClusterRole system:controller:xxx中<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># kubectl describe clusterrole system:kube-controller-manager</span><br><span class="line">Name:         system:kube-controller-manager</span><br><span class="line">Labels:       kubernetes.io/bootstrapping=rbac-defaults</span><br><span class="line">Annotations:  rbac.authorization.kubernetes.io/autoupdate: true</span><br><span class="line">PolicyRule:</span><br><span class="line">  Resources                                  Non-Resource URLs  Resource Names  Verbs</span><br><span class="line">  ---------                                  -----------------  --------------  -----</span><br><span class="line">  secrets                                    <span class="string">[]</span>                 <span class="string">[]</span>              <span class="string">[create delete get update]</span></span><br><span class="line">  endpoints                                  <span class="string">[]</span>                 <span class="string">[]</span>              <span class="string">[create get update]</span></span><br><span class="line">  serviceaccounts                            <span class="string">[]</span>                 <span class="string">[]</span>              <span class="string">[create get update]</span></span><br><span class="line">  events                                     <span class="string">[]</span>                 <span class="string">[]</span>              <span class="string">[create patch update]</span></span><br><span class="line">  tokenreviews.authentication.k8s.io         <span class="string">[]</span>                 <span class="string">[]</span>              <span class="string">[create]</span></span><br><span class="line">  subjectaccessreviews.authorization.k8s.io  <span class="string">[]</span>                 <span class="string">[]</span>              <span class="string">[create]</span></span><br><span class="line">  configmaps                                 <span class="string">[]</span>                 <span class="string">[]</span>              <span class="string">[get]</span></span><br><span class="line">  namespaces                                 <span class="string">[]</span>                 <span class="string">[]</span>              <span class="string">[get]</span></span><br><span class="line">  *.*                                        <span class="string">[]</span>                 <span class="string">[]</span>              <span class="string">[list watch]</span></span><br></pre></td></tr></table></figure></p>
<p>需要在 kube-controller-manager 的启动参数中添加 --use-service-account-credentials=true 参数，这样 main controller 会为各 controller 创建对应的 ServiceAccount XXX-controller。内置的 ClusterRoleBinding system:controller:XXX 将赋予各 XXX-controller ServiceAccount 对应的 ClusterRole system:controller:XXX 权限。<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl get clusterrole|grep controller</span></span><br><span class="line"><span class="attr">system:</span><span class="attr">controller:attachdetach-controller</span>                              <span class="number">22</span><span class="string">m</span></span><br><span class="line"><span class="attr">system:</span><span class="attr">controller:certificate-controller</span>                               <span class="number">22</span><span class="string">m</span></span><br><span class="line"><span class="attr">system:</span><span class="attr">controller:clusterrole-aggregation-controller</span>                   <span class="number">22</span><span class="string">m</span></span><br><span class="line"><span class="attr">system:</span><span class="attr">controller:cronjob-controller</span>                                   <span class="number">22</span><span class="string">m</span></span><br><span class="line"><span class="attr">system:</span><span class="attr">controller:daemon-set-controller</span>                                <span class="number">22</span><span class="string">m</span></span><br><span class="line"><span class="attr">system:</span><span class="attr">controller:deployment-controller</span>                                <span class="number">22</span><span class="string">m</span></span><br><span class="line"><span class="attr">system:</span><span class="attr">controller:disruption-controller</span>                                <span class="number">22</span><span class="string">m</span></span><br><span class="line"><span class="attr">system:</span><span class="attr">controller:endpoint-controller</span>                                  <span class="number">22</span><span class="string">m</span></span><br><span class="line"><span class="attr">system:</span><span class="attr">controller:expand-controller</span>                                    <span class="number">22</span><span class="string">m</span></span><br><span class="line"><span class="attr">system:</span><span class="attr">controller:generic-garbage-collector</span>                            <span class="number">22</span><span class="string">m</span></span><br><span class="line"><span class="attr">system:</span><span class="attr">controller:horizontal-pod-autoscaler</span>                            <span class="number">22</span><span class="string">m</span></span><br><span class="line"><span class="attr">system:</span><span class="attr">controller:job-controller</span>                                       <span class="number">22</span><span class="string">m</span></span><br><span class="line"><span class="attr">system:</span><span class="attr">controller:namespace-controller</span>                                 <span class="number">22</span><span class="string">m</span></span><br><span class="line"><span class="attr">system:</span><span class="attr">controller:node-controller</span>                                      <span class="number">22</span><span class="string">m</span></span><br><span class="line"><span class="attr">system:</span><span class="attr">controller:persistent-volume-binder</span>                             <span class="number">22</span><span class="string">m</span></span><br><span class="line"><span class="attr">system:</span><span class="attr">controller:pod-garbage-collector</span>                                <span class="number">22</span><span class="string">m</span></span><br><span class="line"><span class="attr">system:</span><span class="attr">controller:pv-protection-controller</span>                             <span class="number">22</span><span class="string">m</span></span><br><span class="line"><span class="attr">system:</span><span class="attr">controller:pvc-protection-controller</span>                            <span class="number">22</span><span class="string">m</span></span><br><span class="line"><span class="attr">system:</span><span class="attr">controller:replicaset-controller</span>                                <span class="number">22</span><span class="string">m</span></span><br><span class="line"><span class="attr">system:</span><span class="attr">controller:replication-controller</span>                               <span class="number">22</span><span class="string">m</span></span><br><span class="line"><span class="attr">system:</span><span class="attr">controller:resourcequota-controller</span>                             <span class="number">22</span><span class="string">m</span></span><br><span class="line"><span class="attr">system:</span><span class="attr">controller:route-controller</span>                                     <span class="number">22</span><span class="string">m</span></span><br><span class="line"><span class="attr">system:</span><span class="attr">controller:service-account-controller</span>                           <span class="number">22</span><span class="string">m</span></span><br><span class="line"><span class="attr">system:</span><span class="attr">controller:service-controller</span>                                   <span class="number">22</span><span class="string">m</span></span><br><span class="line"><span class="attr">system:</span><span class="attr">controller:statefulset-controller</span>                               <span class="number">22</span><span class="string">m</span></span><br><span class="line"><span class="attr">system:</span><span class="attr">controller:ttl-controller</span>                                       <span class="number">22</span><span class="string">m</span></span><br><span class="line"><span class="attr">system:</span><span class="string">kube-controller-manager</span>                                         <span class="number">22</span><span class="string">m</span></span><br></pre></td></tr></table></figure></p>
<p>以 deployment controller 为例：<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># kubectl describe clusterrole system:controller:deployment-controller</span><br><span class="line">Name:         system:controller:deployment-controller</span><br><span class="line">Labels:       kubernetes.io/bootstrapping=rbac-defaults</span><br><span class="line">Annotations:  rbac.authorization.kubernetes.io/autoupdate: true</span><br><span class="line">PolicyRule:</span><br><span class="line">  Resources                          Non-Resource URLs  Resource Names  Verbs</span><br><span class="line">  ---------                          -----------------  --------------  -----</span><br><span class="line">  replicasets.apps                   <span class="string">[]</span>                 <span class="string">[]</span>              <span class="string">[create delete get list patch update watch]</span></span><br><span class="line">  replicasets.extensions             <span class="string">[]</span>                 <span class="string">[]</span>              <span class="string">[create delete get list patch update watch]</span></span><br><span class="line">  events                             <span class="string">[]</span>                 <span class="string">[]</span>              <span class="string">[create patch update]</span></span><br><span class="line">  pods                               <span class="string">[]</span>                 <span class="string">[]</span>              <span class="string">[get list update watch]</span></span><br><span class="line">  deployments.apps                   <span class="string">[]</span>                 <span class="string">[]</span>              <span class="string">[get list update watch]</span></span><br><span class="line">  deployments.extensions             <span class="string">[]</span>                 <span class="string">[]</span>              <span class="string">[get list update watch]</span></span><br><span class="line">  deployments.apps/finalizers        <span class="string">[]</span>                 <span class="string">[]</span>              <span class="string">[update]</span></span><br><span class="line">  deployments.apps/status            <span class="string">[]</span>                 <span class="string">[]</span>              <span class="string">[update]</span></span><br><span class="line">  deployments.extensions/finalizers  <span class="string">[]</span>                 <span class="string">[]</span>              <span class="string">[update]</span></span><br><span class="line">  deployments.extensions/status      <span class="string">[]</span>                 <span class="string">[]</span>              <span class="string">[update]</span></span><br></pre></td></tr></table></figure></p>
<p>查看当前的 leader<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl get endpoints kube-controller-manager --namespace=kube-system -o yaml</span></span><br><span class="line"><span class="section">apiVersion: v1</span></span><br><span class="line"><span class="section">kind: Endpoints</span></span><br><span class="line"><span class="section">metadata:</span></span><br><span class="line">  annotations:</span><br><span class="line">    control-plane.alpha.kubernetes.io/leader: '&#123;<span class="string">"holderIdentity"</span>:<span class="string">"k8s-master01_e225d712-c25f-11e9-831f-000c29b1069b"</span>,<span class="string">"leaseDurationSeconds"</span>:15,<span class="string">"acquireTime"</span>:<span class="string">"2019-08-19T09:01:08Z"</span>,<span class="string">"renewTime"</span>:<span class="string">"2019-08-19T09:02:05Z"</span>,<span class="string">"leaderTransitions"</span>:0&#125;'</span><br><span class="line">  creationTimestamp: <span class="string">"2019-08-19T09:01:08Z"</span></span><br><span class="line">  name: kube-controller-manager</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  resourceVersion: <span class="string">"1925"</span></span><br><span class="line">  selfLink: /api/v1/namespaces/kube-system/endpoints/kube-controller-manager</span><br><span class="line">  uid: e2299e08-c25f-11e9-b490-000c29b1069b</span><br></pre></td></tr></table></figure></p>
<h1 id="部署kube-scheduler"><a href="#部署kube-scheduler" class="headerlink" title="部署kube-scheduler"></a>部署kube-scheduler</h1><p>创建 kube-scheduler 证书<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">cd  /etc/kubernetes/ssl/</span><br><span class="line">cat &gt; kube-scheduler-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"system:kube-scheduler"</span>,</span><br><span class="line">    <span class="string">"hosts"</span>: [</span><br><span class="line">      <span class="string">"127.0.0.1"</span>,</span><br><span class="line">      <span class="string">"192.168.10.81"</span>,</span><br><span class="line">      <span class="string">"192.168.10.82"</span>,</span><br><span class="line">      <span class="string">"192.168.10.83"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">        <span class="string">"ST"</span>: <span class="string">"Guangzhou"</span>,</span><br><span class="line">        <span class="string">"L"</span>: <span class="string">"Guangzhou"</span>,</span><br><span class="line">        <span class="string">"O"</span>: <span class="string">"system:kube-scheduler"</span>,</span><br><span class="line">        <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成证书和私钥</span></span><br><span class="line">cfssl gencert <span class="attribute">-ca</span>=ca.pem \</span><br><span class="line">  <span class="attribute">-ca-key</span>=ca-key.pem \</span><br><span class="line">  <span class="attribute">-config</span>=ca-config.json \</span><br><span class="line">  <span class="attribute">-profile</span>=kubernetes kube-scheduler-csr.json | cfssljson -bare kube-scheduler</span><br></pre></td></tr></table></figure></p>
<p>kube-scheduler.kubeconfig<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/kubernetes/ssl</span><br><span class="line">source /etc/kubernetes/env.sh</span><br><span class="line">kubectl<span class="built_in"> config </span>set-cluster kubernetes \</span><br><span class="line">  <span class="attribute">--certificate-authority</span>=ca.pem \</span><br><span class="line">  <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line">  <span class="attribute">--server</span>=<span class="variable">$&#123;KUBE_APISERVER_URL&#125;</span> \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=/etc/kubernetes/kube-scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>set-credentials system:kube-scheduler \</span><br><span class="line">  <span class="attribute">--client-certificate</span>=kube-scheduler.pem \</span><br><span class="line">  <span class="attribute">--client-key</span>=kube-scheduler-key.pem \</span><br><span class="line">  <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=/etc/kubernetes/kube-scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>set-context system:kube-scheduler \</span><br><span class="line">  <span class="attribute">--cluster</span>=kubernetes \</span><br><span class="line">  <span class="attribute">--user</span>=system:kube-scheduler \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=/etc/kubernetes/kube-scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>use-context system:kube-scheduler <span class="attribute">--kubeconfig</span>=/etc/kubernetes/kube-scheduler.kubeconfig</span><br></pre></td></tr></table></figure></p>
<p>kube-scheduler.yaml<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt; /etc/kubernetes/kube-scheduler.yaml &lt;&lt;EOF</span></span><br><span class="line"><span class="string"></span><span class="attr">apiVersion:</span> <span class="string">kubescheduler.config.k8s.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeSchedulerConfiguration</span></span><br><span class="line"><span class="attr">bindTimeoutSeconds:</span> <span class="number">600</span></span><br><span class="line"><span class="attr">clientConnection:</span></span><br><span class="line"><span class="attr">  burst:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">  kubeconfig:</span> <span class="string">"/etc/kubernetes/kube-scheduler.kubeconfig"</span></span><br><span class="line"><span class="attr">  qps:</span> <span class="number">100</span></span><br><span class="line"><span class="attr">enableContentionProfiling:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">enableProfiling:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">hardPodAffinitySymmetricWeight:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">healthzBindAddress:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:10251</span></span><br><span class="line"><span class="attr">leaderElection:</span></span><br><span class="line"><span class="attr">  leaderElect:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">metricsBindAddress:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:10251</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure></p>
<p>kube-scheduler.service<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">source /etc/kubernetes/env.sh</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">"<span class="variable">$&#123;!MASTER_IPS[@]&#125;</span>"</span>; <span class="keyword">do</span></span><br><span class="line"><span class="attribute">NODE</span>=<span class="variable">$&#123;MASTER_IPS[$i]&#125;</span></span><br><span class="line">cat &gt; ~/kube-scheduler.service.<span class="variable">$&#123;NODE&#125;</span> &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line"><span class="attribute">Description</span>=Kubernetes Scheduler</span><br><span class="line"><span class="attribute">Documentation</span>=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">[Service]</span><br><span class="line"><span class="attribute">ExecStart</span>=/usr/local/k8s/bin/kube-scheduler \\</span><br><span class="line">  <span class="attribute">--config</span>=/etc/kubernetes/kube-scheduler.yaml \\</span><br><span class="line">  <span class="attribute">--bind-address</span>=<span class="variable">$&#123;NODE&#125;</span> \\</span><br><span class="line">  <span class="attribute">--secure-port</span>=10259 \\</span><br><span class="line">  <span class="attribute">--port</span>=0 \\</span><br><span class="line">  <span class="attribute">--tls-cert-file</span>=/etc/kubernetes/ssl/kube-scheduler.pem \\</span><br><span class="line">  <span class="attribute">--tls-private-key-file</span>=/etc/kubernetes/ssl/kube-scheduler-key.pem \\</span><br><span class="line">  <span class="attribute">--authentication-kubeconfig</span>=/etc/kubernetes/kube-scheduler.kubeconfig \\</span><br><span class="line">  <span class="attribute">--client-ca-file</span>=/etc/kubernetes/ssl/ca.pem \\</span><br><span class="line">  <span class="attribute">--requestheader-allowed-names</span>=<span class="string">""</span> \\</span><br><span class="line">  <span class="attribute">--requestheader-client-ca-file</span>=/etc/kubernetes/ssl/ca.pem \\</span><br><span class="line">  <span class="attribute">--requestheader-extra-headers-prefix</span>=<span class="string">"X-Remote-Extra-"</span> \\</span><br><span class="line">  <span class="attribute">--requestheader-group-headers</span>=X-Remote-Group \\</span><br><span class="line">  <span class="attribute">--requestheader-username-headers</span>=X-Remote-User \\</span><br><span class="line">  <span class="attribute">--authorization-kubeconfig</span>=/etc/kubernetes/kube-scheduler.kubeconfig \\</span><br><span class="line">  <span class="attribute">--logtostderr</span>=<span class="literal">true</span> \\</span><br><span class="line">  <span class="attribute">--v</span>=2</span><br><span class="line"><span class="attribute">Restart</span>=always</span><br><span class="line"><span class="attribute">RestartSec</span>=5</span><br><span class="line"><span class="attribute">StartLimitInterval</span>=0</span><br><span class="line">[Install]</span><br><span class="line"><span class="attribute">WantedBy</span>=multi-user.target</span><br><span class="line">EOF</span><br><span class="line">done</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 分发</span></span><br><span class="line"><span class="built_in">source</span> /etc/kubernetes/env.sh</span><br><span class="line"><span class="keyword">for</span> NODE <span class="keyword">in</span> <span class="variable">$&#123;MASTER_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    rsync /etc/kubernetes/ssl/kube-scheduler*.pem root@<span class="variable">$&#123;NODE&#125;</span>:/etc/kubernetes/ssl/</span><br><span class="line">    rsync /etc/kubernetes/kube-scheduler.kubeconfig root@<span class="variable">$&#123;NODE&#125;</span>:/etc/kubernetes/</span><br><span class="line">    rsync /etc/kubernetes/kube-scheduler.yaml root@<span class="variable">$&#123;NODE&#125;</span>:/etc/kubernetes/kube-scheduler.yaml</span><br><span class="line">    rsync ~/kube-scheduler.service.<span class="variable">$&#123;NODE&#125;</span> root@<span class="variable">$&#123;NODE&#125;</span>:/etc/systemd/system/kube-scheduler.service</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动kube-scheduler</span></span><br><span class="line"><span class="keyword">for</span> NODE <span class="keyword">in</span> <span class="variable">$&#123;MASTER_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;NODE&#125;</span> <span class="string">"systemctl daemon-reload &amp;&amp; systemctl enable kube-scheduler --now"</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查服务运行状态</span></span><br><span class="line"><span class="keyword">for</span> NODE <span class="keyword">in</span> <span class="variable">$&#123;MASTER_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;NODE&#125;</span> <span class="string">"systemctl status kube-scheduler|grep Active"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">查看输出的 metrics</span><br><span class="line">注意：以下命令在 kube-scheduler 节点上执行。</span><br><span class="line">kube-scheduler 监听 10251 和 10251 端口：</span><br><span class="line">10251：接收 http 请求，非安全端口，不需要认证授权；</span><br><span class="line">10259：接收 https 请求，安全端口，需要认证授权；</span><br><span class="line">两个接口都对外提供 <span class="string">/metrics</span> 和 <span class="string">/healthz</span> 的访问。</span><br><span class="line"></span><br><span class="line">curl -s http:<span class="string">//192.168.10.81</span><span class="function">:10251</span>/metrics|head</span><br><span class="line"><span class="comment"># HELP apiserver_audit_event_total Counter of audit events generated and sent to the audit backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_event_total counter</span></span><br><span class="line">apiserver_audit_event_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_audit_requests_rejected_total Counter of apiserver requests rejected due to an error in audit logging backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_requests_rejected_total counter</span></span><br><span class="line">apiserver_audit_requests_rejected_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_client_certificate_expiration_seconds Distribution of the remaining lifetime on the certificate used to authenticate a request.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_client_certificate_expiration_seconds histogram</span></span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"0"</span>&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"1800"</span>&#125; 0</span><br></pre></td></tr></table></figure>
<p>查看当前leader<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl get endpoints kube-scheduler --namespace=kube-system -o yaml</span></span><br><span class="line"><span class="section">apiVersion: v1</span></span><br><span class="line"><span class="section">kind: Endpoints</span></span><br><span class="line"><span class="section">metadata:</span></span><br><span class="line">  annotations:</span><br><span class="line">    control-plane.alpha.kubernetes.io/leader: '&#123;<span class="string">"holderIdentity"</span>:<span class="string">"k8s-master02_6360c5c0-c262-11e9-a2b9-000c29e02350"</span>,<span class="string">"leaseDurationSeconds"</span>:15,<span class="string">"acquireTime"</span>:<span class="string">"2019-08-19T09:19:21Z"</span>,<span class="string">"renewTime"</span>:<span class="string">"2019-08-19T09:19:51Z"</span>,<span class="string">"leaderTransitions"</span>:1&#125;'</span><br><span class="line">  creationTimestamp: <span class="string">"2019-08-19T09:18:54Z"</span></span><br><span class="line">  name: kube-scheduler</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  resourceVersion: <span class="string">"2799"</span></span><br><span class="line">  selfLink: /api/v1/namespaces/kube-system/endpoints/kube-scheduler</span><br><span class="line">  uid: 5da1ecf2-c262-11e9-b490-000c29b1069b</span><br></pre></td></tr></table></figure></p>
<h1 id="部署node"><a href="#部署node" class="headerlink" title="部署node"></a>部署node</h1><p>分发node二进制<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">source /etc/kubernetes/env.sh</span><br><span class="line"><span class="keyword">for</span> NODE <span class="keyword">in</span> <span class="variable">$&#123;</span>NODE_IPS[@]&#125;;<span class="keyword">do</span></span><br><span class="line">    ssh root@<span class="variable">$NODE</span> <span class="string">"mkdir -p /usr/local/k8s/bin"</span></span><br><span class="line">    rsync kubernetes/server/bin/&#123;kube-proxy,kubelet,kubectl&#125; root@<span class="variable">$&#123;</span>NODE&#125;<span class="symbol">:/usr/local/k8s/bin/</span></span><br><span class="line">done</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>Docker步骤需要在所有node节点安装</p>
</blockquote>
<p>若是需要master也作为node节点加入集群，也需要在master节点部署docker、kubelet、kube-proxy。<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -<span class="keyword">y</span> yum-utils device-mapper-persistent-data lvm2</span><br><span class="line">yum-config-manager --<span class="built_in">add</span>-repo http://mirrors.aliyun.<span class="keyword">com</span>/docker-<span class="keyword">ce</span>/linux/centos/docker-<span class="keyword">ce</span>.repo</span><br><span class="line">yum -<span class="keyword">y</span> install docker-<span class="keyword">ce</span></span><br></pre></td></tr></table></figure></p>
<p>创建配置文件<br><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/docker/daemon.json &lt;&lt;<span class="built_in">EOF</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"exec-opts"</span>: [<span class="string">"native.cgroupdriver=cgroupfs"</span>],</span><br><span class="line">  <span class="string">"registry-mirrors"</span>: [<span class="string">"https://hub-mirror.c.163.com"</span>],</span><br><span class="line">  <span class="string">"log-driver"</span>: <span class="string">"json-file"</span>,</span><br><span class="line">  <span class="string">"log-opts"</span>: &#123;</span><br><span class="line">    <span class="string">"max-size"</span>: <span class="string">"100m"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"storage-driver"</span>: <span class="string">"overlay2"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">EOF</span></span><br></pre></td></tr></table></figure></p>
<p>启动docker服务<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">source /etc/kubernetes/env.sh</span><br><span class="line"><span class="keyword">for</span> NODE <span class="keyword">in</span> <span class="variable">$&#123;</span>NODE_IPS[@]&#125;;<span class="keyword">do</span></span><br><span class="line">    rsync /etc/docker/daemon.json root@<span class="variable">$&#123;</span>NODE&#125;<span class="symbol">:/etc/docker/daemon</span>.json</span><br><span class="line">    ssh root@<span class="variable">$&#123;</span>NODE&#125; <span class="string">"systemctl daemon-reload &amp;&amp; systemctl enable docker &amp;&amp; systemctl restart docker"</span></span><br><span class="line">done</span><br></pre></td></tr></table></figure></p>
<h1 id="部署kubelet"><a href="#部署kubelet" class="headerlink" title="部署kubelet"></a>部署kubelet</h1><p>kubelet-config.yaml<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">source <span class="regexp">/etc/</span>kubernetes/env.sh</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">"$&#123;!NODE_IPS[@]&#125;"</span>; do</span><br><span class="line">NODE=$&#123;NODE_IPS[$i]&#125;</span><br><span class="line">cat &gt; ~/kubelet-config.yaml.$&#123;NODE&#125; &lt;&lt;EOF</span><br><span class="line"><span class="string">kind:</span> KubeletConfiguration</span><br><span class="line"><span class="string">apiVersion:</span> kubelet.config.k8s.io/v1beta1</span><br><span class="line"><span class="string">address:</span> <span class="string">"$&#123;NODE&#125;"</span></span><br><span class="line"><span class="string">staticPodPath:</span> <span class="string">""</span></span><br><span class="line"><span class="string">syncFrequency:</span> <span class="number">1</span>m</span><br><span class="line"><span class="string">fileCheckFrequency:</span> <span class="number">20</span>s</span><br><span class="line"><span class="string">httpCheckFrequency:</span> <span class="number">20</span>s</span><br><span class="line"><span class="string">staticPodURL:</span> <span class="string">""</span></span><br><span class="line"><span class="string">port:</span> <span class="number">10250</span></span><br><span class="line"><span class="string">readOnlyPort:</span> <span class="number">0</span></span><br><span class="line"><span class="string">rotateCertificates:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">serverTLSBootstrap:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">authentication:</span></span><br><span class="line"><span class="symbol">  anonymous:</span></span><br><span class="line"><span class="symbol">    enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="symbol">  webhook:</span></span><br><span class="line"><span class="symbol">    enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="symbol">  x509:</span></span><br><span class="line"><span class="symbol">    clientCAFile:</span> <span class="string">"/etc/kubernetes/ssl/ca.pem"</span></span><br><span class="line"><span class="string">authorization:</span></span><br><span class="line"><span class="symbol">  mode:</span> Webhook</span><br><span class="line"><span class="string">registryPullQPS:</span> <span class="number">0</span></span><br><span class="line"><span class="string">registryBurst:</span> <span class="number">20</span></span><br><span class="line"><span class="string">eventRecordQPS:</span> <span class="number">0</span></span><br><span class="line"><span class="string">eventBurst:</span> <span class="number">20</span></span><br><span class="line"><span class="string">enableDebuggingHandlers:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">enableContentionProfiling:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">healthzPort:</span> <span class="number">10248</span></span><br><span class="line"><span class="string">healthzBindAddress:</span> <span class="string">"$&#123;NODE&#125;"</span></span><br><span class="line"><span class="string">clusterDomain:</span> <span class="string">"cluster.local"</span></span><br><span class="line"><span class="string">clusterDNS:</span></span><br><span class="line">  - <span class="string">"$&#123;DNS_SERVICE_IP&#125;"</span></span><br><span class="line"><span class="string">nodeStatusUpdateFrequency:</span> <span class="number">10</span>s</span><br><span class="line"><span class="string">nodeStatusReportFrequency:</span> <span class="number">1</span>m</span><br><span class="line"><span class="string">imageMinimumGCAge:</span> <span class="number">2</span>m</span><br><span class="line"><span class="string">imageGCHighThresholdPercent:</span> <span class="number">85</span></span><br><span class="line"><span class="string">imageGCLowThresholdPercent:</span> <span class="number">80</span></span><br><span class="line"><span class="string">volumeStatsAggPeriod:</span> <span class="number">1</span>m</span><br><span class="line"><span class="string">kubeletCgroups:</span> <span class="string">""</span></span><br><span class="line"><span class="string">systemCgroups:</span> <span class="string">""</span></span><br><span class="line"><span class="string">cgroupRoot:</span> <span class="string">""</span></span><br><span class="line"><span class="string">cgroupsPerQOS:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">cgroupDriver:</span> systemd</span><br><span class="line"><span class="string">runtimeRequestTimeout:</span> <span class="number">10</span>m</span><br><span class="line"><span class="string">hairpinMode:</span> promiscuous-bridge</span><br><span class="line"><span class="string">maxPods:</span> <span class="number">220</span></span><br><span class="line"><span class="string">podCIDR:</span> <span class="string">"$&#123;POD_CIDR&#125;"</span></span><br><span class="line"><span class="string">podPidsLimit:</span> <span class="number">-1</span></span><br><span class="line"><span class="string">resolvConf:</span> <span class="regexp">/etc/</span>resolv.conf</span><br><span class="line"><span class="string">maxOpenFiles:</span> <span class="number">1000000</span></span><br><span class="line"><span class="string">kubeAPIQPS:</span> <span class="number">1000</span></span><br><span class="line"><span class="string">kubeAPIBurst:</span> <span class="number">2000</span></span><br><span class="line"><span class="string">serializeImagePulls:</span> <span class="literal">false</span></span><br><span class="line"><span class="string">evictionHard:</span></span><br><span class="line">  memory.<span class="string">available:</span>  <span class="string">"100Mi"</span></span><br><span class="line">nodefs.<span class="string">available:</span>  <span class="string">"10%"</span></span><br><span class="line">nodefs.<span class="string">inodesFree:</span> <span class="string">"5%"</span></span><br><span class="line">imagefs.<span class="string">available:</span> <span class="string">"15%"</span></span><br><span class="line"><span class="string">evictionSoft:</span> &#123;&#125;</span><br><span class="line"><span class="string">enableControllerAttachDetach:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">failSwapOn:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">containerLogMaxSize:</span> <span class="number">20</span>Mi</span><br><span class="line"><span class="string">containerLogMaxFiles:</span> <span class="number">10</span></span><br><span class="line"><span class="string">systemReserved:</span> &#123;&#125;</span><br><span class="line"><span class="string">kubeReserved:</span> &#123;&#125;</span><br><span class="line"><span class="string">systemReservedCgroup:</span> <span class="string">""</span></span><br><span class="line"><span class="string">kubeReservedCgroup:</span> <span class="string">""</span></span><br><span class="line"><span class="string">enforceNodeAllocatable:</span> [<span class="string">"pods"</span>]</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<p>kubelet.service<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">source /etc/kubernetes/env.sh</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">"<span class="variable">$&#123;!NODE_IPS[@]&#125;</span>"</span>; <span class="keyword">do</span></span><br><span class="line"><span class="attribute">NODE</span>=<span class="variable">$&#123;NODE_IPS[$i]&#125;</span></span><br><span class="line"><span class="attribute">NODE_NAME</span>=<span class="variable">$&#123;NODE_NAMES[$i]&#125;</span></span><br><span class="line">cat &gt; ~/kubelet.service.<span class="variable">$&#123;NODE&#125;</span> &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line"><span class="attribute">Description</span>=Kubernetes Kubelet</span><br><span class="line"><span class="attribute">Documentation</span>=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"><span class="attribute">After</span>=docker.service</span><br><span class="line"><span class="attribute">Requires</span>=docker.service</span><br><span class="line">[Service]</span><br><span class="line"><span class="attribute">ExecStart</span>=/usr/local/k8s/bin/kubelet \\</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=/etc/kubernetes/kubelet.kubeconfig \\</span><br><span class="line">  <span class="attribute">--bootstrap-kubeconfig</span>=/etc/kubernetes/kubelet-bootstrap.kubeconfig \\</span><br><span class="line">  <span class="attribute">--config</span>=/etc/kubernetes/kubelet-config.yaml \\</span><br><span class="line">  <span class="attribute">--cert-dir</span>=/etc/kubernetes/ssl \\</span><br><span class="line">  <span class="attribute">--network-plugin</span>=cni \\</span><br><span class="line">  <span class="attribute">--cni-conf-dir</span>=/etc/cni/net.d \\</span><br><span class="line">  <span class="attribute">--hostname-override</span>=<span class="variable">$&#123;NODE_NAME&#125;</span> \\</span><br><span class="line">  <span class="attribute">--pod-infra-container-image</span>=gcr.azk8s.cn/google_containers/pause-amd64:3.1 \\</span><br><span class="line">  <span class="attribute">--image-pull-progress-deadline</span>=15m \\</span><br><span class="line">  <span class="attribute">--logtostderr</span>=<span class="literal">true</span> \\</span><br><span class="line">  <span class="attribute">--cgroup-driver</span>=cgroupfs \\</span><br><span class="line">  <span class="attribute">--v</span>=2</span><br><span class="line"><span class="attribute">Restart</span>=always</span><br><span class="line"><span class="attribute">RestartSec</span>=5</span><br><span class="line"><span class="attribute">StartLimitInterval</span>=0</span><br><span class="line">[Install]</span><br><span class="line"><span class="attribute">WantedBy</span>=multi-user.target</span><br><span class="line">EOF</span><br><span class="line">done</span><br></pre></td></tr></table></figure></p>
<p>kubelet-bootstrap-kubeconfig<br>注意查看token是否过期,如是重新创建<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/kubernetes/ssl</span><br><span class="line">source /etc/kubernetes/env.sh</span><br><span class="line"><span class="comment"># 创建 token</span></span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">BOOTSTRAP_TOKEN</span>=$(kubeadm token create \</span><br><span class="line">  --description kubelet-bootstrap-token \</span><br><span class="line">  --groups system:bootstrappers:kubernetes-clientgroup \</span><br><span class="line">  --kubeconfig ~/.kube/config)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置集群参数</span></span><br><span class="line">kubectl<span class="built_in"> config </span>set-cluster kubernetes \</span><br><span class="line">  <span class="attribute">--certificate-authority</span>=ca.pem \</span><br><span class="line">  <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line">  <span class="attribute">--server</span>=<span class="variable">$&#123;KUBE_APISERVER_URL&#125;</span> \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=/etc/kubernetes/kubelet-bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置客户端认证参数</span></span><br><span class="line">kubectl<span class="built_in"> config </span>set-credentials kubelet-bootstrap \</span><br><span class="line">  <span class="attribute">--token</span>=<span class="variable">$&#123;BOOTSTRAP_TOKEN&#125;</span> \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=/etc/kubernetes/kubelet-bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置上下文参数</span></span><br><span class="line">kubectl<span class="built_in"> config </span>set-context<span class="built_in"> default </span>\</span><br><span class="line">  <span class="attribute">--cluster</span>=kubernetes \</span><br><span class="line">  <span class="attribute">--user</span>=kubelet-bootstrap \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=/etc/kubernetes/kubelet-bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置默认上下文</span></span><br><span class="line">kubectl<span class="built_in"> config </span>use-context<span class="built_in"> default </span><span class="attribute">--kubeconfig</span>=/etc/kubernetes/kubelet-bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># grep token /etc/kubernetes/kubelet-bootstrap.kubeconfig </span></span><br><span class="line">    token: 2wpre5.7w2lu07fys9m70ix</span><br></pre></td></tr></table></figure></p>
<p>查看kubeadm创建的token<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># <span class="selector-tag">kubeadm</span> <span class="selector-tag">token</span> <span class="selector-tag">list</span> <span class="selector-tag">--kubeconfig</span> ~/<span class="selector-class">.kube</span>/<span class="selector-tag">config</span></span><br><span class="line"><span class="selector-tag">TOKEN</span>                     <span class="selector-tag">TTL</span>       <span class="selector-tag">EXPIRES</span>                     <span class="selector-tag">USAGES</span>                   <span class="selector-tag">DESCRIPTION</span>               <span class="selector-tag">EXTRA</span> <span class="selector-tag">GROUPS</span></span><br><span class="line"><span class="selector-tag">2wpre5</span><span class="selector-class">.7w2lu07fys9m70ix</span>   <span class="selector-tag">23h</span>       <span class="selector-tag">2019-08-24T07</span><span class="selector-pseudo">:20</span><span class="selector-pseudo">:04-04</span><span class="selector-pseudo">:00</span>   <span class="selector-tag">authentication</span>,<span class="selector-tag">signing</span>   <span class="selector-tag">kubelet-bootstrap-token</span>   <span class="selector-tag">system</span><span class="selector-pseudo">:bootstrappers</span><span class="selector-pseudo">:kubernetes-clientgroup</span></span><br></pre></td></tr></table></figure></p>
<p>token有效期为1天，超期后将不能被用来bootstrap kubelet，且会被kube-controller-manager的token cleaner清理<br>kube-apiserver接收kubelet的bootstrap token后，将请求的user设置为system:bootstrap; group设置为system:bootstrappers，后续将为这个group设置ClusterRoleBinding<br>查看各token关联的Secret<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># kubectl get secrets -<span class="keyword">n</span> kube-system|grep <span class="keyword">bootstrap</span>-<span class="keyword">token</span></span><br><span class="line"><span class="keyword">bootstrap</span>-<span class="keyword">token</span>-2wpre5                           <span class="keyword">bootstrap</span>.kubernetes.io/<span class="keyword">token</span>         7      51s</span><br></pre></td></tr></table></figure></p>
<p>创建user和group的CSR权限，不创建kubelet会启动失败<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding kubelet-bootstrap --<span class="attr">clusterrole=</span>system:<span class="keyword">node</span><span class="title">-bootstrapper</span> --<span class="attr">group=</span>system:bootstrappers</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 分发</span></span><br><span class="line"><span class="built_in">source</span> /etc/kubernetes/env.sh</span><br><span class="line"><span class="keyword">for</span> NODE <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;NODE&#125;</span> <span class="string">"mkdir -p /etc/kubernetes"</span></span><br><span class="line">    rsync  /etc/kubernetes/kubelet.kubeconfig root@<span class="variable">$&#123;NODE&#125;</span>:/etc/kubernetes/</span><br><span class="line">    rsync ~/kubelet-config.yaml.<span class="variable">$&#123;NODE&#125;</span> root@<span class="variable">$&#123;NODE&#125;</span>:/etc/kubernetes/kubelet-config.yaml</span><br><span class="line">    rsync ~/kubelet.service.<span class="variable">$&#123;NODE&#125;</span> root@<span class="variable">$&#123;NODE&#125;</span>:/etc/systemd/system/kubelet.service</span><br><span class="line">    rsync /etc/kubernetes/kubelet-bootstrap.kubeconfig root@<span class="variable">$&#123;NODE&#125;</span>:/etc/kubernetes/kubelet-bootstrap.kubeconfig</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p>启动 kubelet 服务<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /etc/kubernetes/env.sh</span><br><span class="line"><span class="keyword">for</span> NODE <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;NODE&#125;</span> <span class="string">"systemctl daemon-reload &amp;&amp; systemctl enable kubelet --now"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure></p>
<p>csr-crb.yaml<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cd</span> <span class="string">/etc/kubernetes/</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt; csr-crb.yaml &lt;&lt;EOF</span></span><br><span class="line"><span class="string"> # Approve all CSRs for the group "system:bootstrappers"</span></span><br><span class="line"><span class="string"></span><span class="attr"> kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr"> apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr"> metadata:</span></span><br><span class="line"><span class="attr">   name:</span> <span class="string">auto-approve-csrs-for-group</span></span><br><span class="line"><span class="attr"> subjects:</span></span><br><span class="line"><span class="attr"> - kind:</span> <span class="string">Group</span></span><br><span class="line"><span class="attr">   name:</span> <span class="attr">system:bootstrappers</span></span><br><span class="line"><span class="attr">   apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr"> roleRef:</span></span><br><span class="line"><span class="attr">   kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">   name:</span> <span class="attr">system:certificates.k8s.io:certificatesigningrequests:nodeclient</span></span><br><span class="line"><span class="attr">   apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"> <span class="comment"># To let a node of the group "system:nodes" renew its own credentials</span></span><br><span class="line"><span class="attr"> kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr"> apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr"> metadata:</span></span><br><span class="line"><span class="attr">   name:</span> <span class="string">node-client-cert-renewal</span></span><br><span class="line"><span class="attr"> subjects:</span></span><br><span class="line"><span class="attr"> - kind:</span> <span class="string">Group</span></span><br><span class="line"><span class="attr">   name:</span> <span class="attr">system:nodes</span></span><br><span class="line"><span class="attr">   apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr"> roleRef:</span></span><br><span class="line"><span class="attr">   kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">   name:</span> <span class="attr">system:certificates.k8s.io:certificatesigningrequests:selfnodeclient</span></span><br><span class="line"><span class="attr">   apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># A ClusterRole which instructs the CSR approver to approve a node requesting a</span></span><br><span class="line"><span class="comment"># serving cert matching its client cert.</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">approve-node-server-renewal-csr</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">- apiGroups:</span> <span class="string">["certificates.k8s.io"]</span></span><br><span class="line"><span class="attr">  resources:</span> <span class="string">["certificatesigningrequests/selfnodeserver"]</span></span><br><span class="line"><span class="attr">  verbs:</span> <span class="string">["create"]</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"> <span class="comment"># To let a node of the group "system:nodes" renew its own server credentials</span></span><br><span class="line"><span class="attr"> kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr"> apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr"> metadata:</span></span><br><span class="line"><span class="attr">   name:</span> <span class="string">node-server-cert-renewal</span></span><br><span class="line"><span class="attr"> subjects:</span></span><br><span class="line"><span class="attr"> - kind:</span> <span class="string">Group</span></span><br><span class="line"><span class="attr">   name:</span> <span class="attr">system:nodes</span></span><br><span class="line"><span class="attr">   apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr"> roleRef:</span></span><br><span class="line"><span class="attr">   kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">   name:</span> <span class="string">approve-node-server-renewal-csr</span></span><br><span class="line"><span class="attr">   apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="bullet">-f</span> <span class="string">csr-crb.yaml</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl get csr</span></span><br><span class="line">NAME        AGE     REQUESTOR                 CONDITION</span><br><span class="line">csr-<span class="number">4h</span>wzt   <span class="number">3m</span>20s   system:<span class="keyword">node</span><span class="title">:k8s-node01</span>    Pending</span><br><span class="line">csr-ft87k   <span class="number">12m</span>     system:bootstrap:<span class="number">2</span>wpre5   Approved,Issued</span><br><span class="line">csr-mn4mb   <span class="number">2s</span>      system:<span class="keyword">node</span><span class="title">:k8s-node02</span>    Pending</span><br><span class="line">csr-wknjd   <span class="number">12m</span>     system:bootstrap:c6h4x1   Approved,Issued</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">#kubelet get csr </span></span><br><span class="line">No resources found.</span><br><span class="line">请检查命令kubeadm token list的Token和 文件/etc/kubernetes/kubelet-bootstrap.kubeconfig中token是否一致。</span><br></pre></td></tr></table></figure>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># kubectl get nodes</span><br><span class="line">NAME         STATUS   ROLES    AGE     VERSION</span><br><span class="line">k8s-node01   Ready    &lt;none&gt;   <span class="number">3</span>m41s   v1<span class="number">.15</span><span class="number">.4</span></span><br><span class="line">k8s-node02   Ready    &lt;none&gt;   <span class="number">3</span>m41s   v1<span class="number">.15</span><span class="number">.4</span></span><br><span class="line">k8s-master01   Ready    &lt;none&gt;   <span class="number">3</span>m41s   v1<span class="number">.15</span><span class="number">.4</span> </span><br><span class="line">k8s-master02   Ready    &lt;none&gt;   <span class="number">3</span>m41s   v1<span class="number">.15</span><span class="number">.4</span> </span><br><span class="line">k8s-master03   Ready    &lt;none&gt;   <span class="number">3</span>m41s   v1<span class="number">.15</span><span class="number">.4</span></span><br></pre></td></tr></table></figure>
<p>手动approve server cert csr<br>基于安全考虑，CSR approving controllers不会自动approve kubelet server证书签名请求，需要手动approve<br><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get csr | <span class="type">grep</span> Pending | <span class="type">awk</span> '&#123;print $<span class="number">1</span>&#125;' | <span class="type">xargs</span> kubectl certificate approve</span><br></pre></td></tr></table></figure></p>
<p>bear token认证和授权<br>创建一个ServiceAccount，将它和ClusterRole system:kubelet-api-admin绑定，从而具有调用kubelet API的权限<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl create <span class="keyword">sa</span> kubelet-api-<span class="keyword">test</span></span><br><span class="line">kubectl create clusterrolebinding kubelet-api-<span class="keyword">test</span> --clusterrole=system:kubelet-api-admin --serviceaccount=default:kubelet-api-<span class="keyword">test</span></span><br><span class="line">SECRET=$(kubectl get secrets | grep kubelet-api-<span class="keyword">test</span> | awk '&#123;<span class="keyword">print</span> <span class="variable">$1&#125;</span>')</span><br><span class="line"><span class="keyword">TOKEN</span>=$(kubectl <span class="keyword">describe</span> secret <span class="variable">$&#123;SECRET&#125;</span> | grep -<span class="keyword">E</span> '^<span class="keyword">token</span>' | awk '&#123;<span class="keyword">print</span> <span class="variable">$2&#125;</span>')</span><br><span class="line">echo <span class="variable">$&#123;TOKEN&#125;</span></span><br></pre></td></tr></table></figure></p>
<h1 id="部署kube-proxy"><a href="#部署kube-proxy" class="headerlink" title="部署kube-proxy"></a>部署kube-proxy</h1><blockquote>
<p>确保已加载ipvs conntrack 模块</p>
</blockquote>
<p>kube-proxy运行在所有worker节点上，它监听apiserver中service和endpoint的变化情况，创建路由规则提供服务IP和负载均衡功能。这里使用ipvs模式的kube-proxy进行部署</p>
<p>创建 kube-proxy 证书<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/kubernetes/ssl/kube-proxy-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"system:kube-proxy"</span>,</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"Guangzhou"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"Guangzhou"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成证书和私钥</span></span><br><span class="line">cfssl gencert <span class="attribute">-ca</span>=ca.pem \</span><br><span class="line">  <span class="attribute">-ca-key</span>=ca-key.pem \</span><br><span class="line">  <span class="attribute">-config</span>=ca-config.json \</span><br><span class="line">  <span class="attribute">-profile</span>=kubernetes  kube-proxy-csr.json | cfssljson -bare kube-proxy</span><br></pre></td></tr></table></figure></p>
<p>kube-proxy.kubeconfig<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">source /etc/kubernetes/env.sh</span><br><span class="line">cd /etc/kubernetes/ssl</span><br><span class="line">kubectl<span class="built_in"> config </span>set-cluster kubernetes \</span><br><span class="line">  <span class="attribute">--certificate-authority</span>=ca.pem \</span><br><span class="line">  <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line">  <span class="attribute">--server</span>=<span class="variable">$&#123;KUBE_APISERVER_URL&#125;</span> \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=/etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>set-credentials kube-proxy \</span><br><span class="line">  <span class="attribute">--client-certificate</span>=kube-proxy.pem \</span><br><span class="line">  <span class="attribute">--client-key</span>=kube-proxy-key.pem \</span><br><span class="line">  <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=/etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>set-context<span class="built_in"> default </span>\</span><br><span class="line">  <span class="attribute">--cluster</span>=kubernetes \</span><br><span class="line">  <span class="attribute">--user</span>=kube-proxy \</span><br><span class="line">  <span class="attribute">--kubeconfig</span>=/etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>use-context<span class="built_in"> default </span><span class="attribute">--kubeconfig</span>=/etc/kubernetes/kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure></p>
<p>kube-proxy-config.yaml<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">source /etc/kubernetes/env.sh</span><br><span class="line">for i <span class="keyword">in</span> <span class="string">"$&#123;!NODE_IPS[@]&#125;"</span>; do</span><br><span class="line"><span class="keyword">NODE</span><span class="title">=$</span>&#123;NODE_IPS[$i]&#125;</span><br><span class="line"><span class="attr">NODE_NAME=</span>$&#123;NODE_NAMES[$i]&#125;</span><br><span class="line"></span><br><span class="line">cat &gt; ~/kube-proxy-config.yaml.$&#123;<span class="keyword">NODE</span><span class="title">&#125;&lt;&lt;EOF</span></span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">clientConnection:</span><br><span class="line">  burst: <span class="number">200</span></span><br><span class="line">  kubeconfig: <span class="string">"/etc/kubernetes/kube-proxy.kubeconfig"</span></span><br><span class="line">  qps: <span class="number">100</span></span><br><span class="line">bindAddress: $&#123;<span class="keyword">NODE</span><span class="title">&#125;</span></span><br><span class="line"><span class="title">healthzBindAddress</span>: $&#123;<span class="keyword">NODE</span><span class="title">&#125;:10256</span></span><br><span class="line">metricsBindAddress: $&#123;<span class="keyword">NODE</span><span class="title">&#125;:10249</span></span><br><span class="line">enableProfiling: <span class="literal">true</span></span><br><span class="line">clusterCIDR: $&#123;CLUSTER_CIDR&#125;</span><br><span class="line">hostnameOverride: $&#123;NODE_NAME&#125;</span><br><span class="line">mode: <span class="string">"ipvs"</span></span><br><span class="line">portRange: <span class="string">""</span></span><br><span class="line">kubeProxyIPTablesConfiguration:</span><br><span class="line">  masqueradeAll: <span class="literal">false</span></span><br><span class="line">kubeProxyIPVSConfiguration:</span><br><span class="line">  scheduler: rr</span><br><span class="line">  excludeCIDRs: []</span><br><span class="line">EOF</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"><span class="comment">#从v1.10开始，kube-proxy部分参数可以配置在文件中，可以使用–write-config-to选项生成该配置文件</span></span><br><span class="line">bindAddress: 监听地址；</span><br><span class="line">clientConnection.kubeconfig: 连接 apiserver 的 kubeconfig 文件；</span><br><span class="line">--clusterCIDR: kube-proxy 根据 --cluster-cidr判断集群内部和外部流量，指定 --cluster-cidr 或 –masquerade-all 选项后 --kube-proxy 才会对访问 Service IP 的请求做 SNAT；</span><br><span class="line">hostnameOverride: 参数值必须与 kubelet 的值一致，否则 kube-proxy 启动后会找不到该 <span class="keyword">Node</span><span class="title">，从而不会创建任何 ipvs</span> 规则；</span><br><span class="line">mode: 使用ipvs模式</span><br></pre></td></tr></table></figure></p>
<p>kube-proxy.service<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ~/kube-proxy.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line"><span class="attribute">Description</span>=Kubernetes Kube-Proxy Server</span><br><span class="line"><span class="attribute">Documentation</span>=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"><span class="attribute">After</span>=network.target</span><br><span class="line">[Service]</span><br><span class="line"><span class="attribute">ExecStart</span>=/usr/local/k8s/bin/kube-proxy \\</span><br><span class="line">  <span class="attribute">--config</span>=/etc/kubernetes/kube-proxy-config.yaml \\</span><br><span class="line">  <span class="attribute">--logtostderr</span>=<span class="literal">true</span> \\</span><br><span class="line">  <span class="attribute">--v</span>=2</span><br><span class="line"><span class="attribute">Restart</span>=on-failure</span><br><span class="line"><span class="attribute">RestartSec</span>=5</span><br><span class="line"><span class="attribute">LimitNOFILE</span>=65536</span><br><span class="line">[Install]</span><br><span class="line"><span class="attribute">WantedBy</span>=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 分发</span></span><br><span class="line">source /etc/kubernetes/env.sh</span><br><span class="line"><span class="keyword">for</span> NODE <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    rsync /etc/kubernetes/ssl/ca.pem root@<span class="variable">$&#123;NODE&#125;</span>:/etc/kubernetes/ssl/</span><br><span class="line">    rsync /etc/kubernetes/kube-proxy.kubeconfig root@<span class="variable">$&#123;NODE&#125;</span>:/etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line">    rsync ~/kube-proxy-config.yaml.<span class="variable">$&#123;NODE&#125;</span> root@<span class="variable">$&#123;NODE&#125;</span>:/etc/kubernetes/kube-proxy-config.yaml</span><br><span class="line">    rsync ~/kube-proxy.service root@<span class="variable">$&#123;NODE&#125;</span>:/etc/systemd/system/</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 kube-proxy 服务</span></span><br><span class="line">source /etc/kubernetes/env.sh</span><br><span class="line"><span class="keyword">for</span> NODE <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;NODE&#125;</span> <span class="string">"modprobe ip_vs_rr"</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;NODE&#125;</span> <span class="string">"systemctl daemon-reload &amp;&amp; systemctl enable kube-proxy --now"</span></span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查启动结果</span></span><br><span class="line"><span class="keyword">for</span> NODE <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">    echo <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;NODE&#125;</span>"</span></span><br><span class="line">    ssh root@<span class="variable">$&#123;NODE&#125;</span> <span class="string">"systemctl status kube-proxy|grep Active"</span></span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查监听端口</span></span><br><span class="line"><span class="comment"># netstat -lnpt|grep kube-proxy</span></span><br><span class="line">tcp        0      0 192.168.10.81:10256     0.0.0.0:*               LISTEN      1633/kube-proxy     </span><br><span class="line">tcp        0      0 192.168.10.81:10249     0.0.0.0:*               LISTEN      1633/kube-proxy </span><br><span class="line"><span class="comment">#10249：http prometheus metrics port</span></span><br><span class="line"><span class="comment">#10256：http healthz port</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看ipvs路由规则</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ipvsadm -ln</span></span><br><span class="line">IP Virtual<span class="built_in"> Server </span>version 1.2.1 (<span class="attribute">size</span>=4096)</span><br><span class="line">Prot LocalAddress:Port<span class="built_in"> Scheduler </span>Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  10.96.0.1:443 rr</span><br><span class="line">  -&gt; 192.168.10.81:6443           Masq    1      0          0         </span><br><span class="line">  -&gt; 192.168.10.82:6443           Masq    1      0          0         </span><br><span class="line">  -&gt; 192.168.10.83:6443           Masq    1      0          0         </span><br><span class="line">  <span class="built_in">..</span>.</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="重新创建token"><a href="#重新创建token" class="headerlink" title="重新创建token"></a>重新创建token</h1><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-id">#kubeadm</span> <span class="selector-tag">token</span> <span class="selector-tag">create</span> <span class="selector-tag">--print-join-command</span></span><br><span class="line"><span class="selector-tag">kubeadm</span> <span class="selector-tag">token</span> <span class="selector-tag">create</span></span><br><span class="line"><span class="selector-tag">kubeadm</span> <span class="selector-tag">token</span> <span class="selector-tag">list</span></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">TOKEN</span>                     <span class="selector-tag">TTL</span>         <span class="selector-tag">EXPIRES</span>                     <span class="selector-tag">USAGES</span>                   <span class="selector-tag">DESCRIPTION</span>               <span class="selector-tag">EXTRA</span> <span class="selector-tag">GROUPS</span></span><br><span class="line"><span class="selector-tag">j5p01w</span><span class="selector-class">.ksoigbibr5t4ufte</span>   &lt;<span class="selector-tag">invalid</span>&gt;   2019<span class="selector-tag">-11-16T14</span><span class="selector-pseudo">:32</span><span class="selector-pseudo">:11+08</span><span class="selector-pseudo">:00</span>   <span class="selector-tag">authentication</span>,<span class="selector-tag">signing</span>   <span class="selector-tag">kubelet-bootstrap-token</span>   <span class="selector-tag">system</span><span class="selector-pseudo">:bootstrappers</span><span class="selector-pseudo">:kubernetes-clientgroup</span></span><br><span class="line"><span class="selector-tag">th32rs</span><span class="selector-class">.bspeftc5qko8ntrn</span>   23<span class="selector-tag">h</span>         2019<span class="selector-tag">-11-21T18</span><span class="selector-pseudo">:37</span><span class="selector-pseudo">:15+08</span><span class="selector-pseudo">:00</span>   <span class="selector-tag">authentication</span>,<span class="selector-tag">signing</span>   &lt;<span class="selector-tag">none</span>&gt;                    <span class="selector-tag">system</span><span class="selector-pseudo">:bootstrappers</span><span class="selector-pseudo">:kubeadm</span><span class="selector-pseudo">:default-node-token</span></span><br></pre></td></tr></table></figure>
<h1 id="部署calico网络"><a href="#部署calico网络" class="headerlink" title="部署calico网络"></a>部署calico网络</h1><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">curl https:<span class="comment">//docs.projectcalico.org/v3.9/manifests/calico-etcd.yaml -o calico.yaml</span></span><br><span class="line">source /etc/kubernetes/env.<span class="keyword">sh</span></span><br><span class="line">ETCD_KEY_BASE64=$(<span class="keyword">cat</span> /etc/etcd/ssl/etcd-key.pem | base64 -w 0)</span><br><span class="line">ETCD_CERT_BASE64=$(<span class="keyword">cat</span> /etc/etcd/ssl/etcd.pem | base64 -w 0)</span><br><span class="line">ETCD_CA_BASE64=$(<span class="keyword">cat</span> /etc/etcd/ssl/<span class="keyword">ca</span>.pem | base64 -w 0) </span><br><span class="line"></span><br><span class="line">sed -i -<span class="keyword">e</span> <span class="string">"s?192.168.0.0/16?$POD_CIDR?g"</span> calico.yaml</span><br><span class="line">sed -i -<span class="keyword">e</span> <span class="string">"s?etcd_endpoints:.*?etcd_endpoints: \"</span><span class="variable">$ETCD_ENDPOINTS</span>\<span class="string">"?g"</span> calico.yaml</span><br><span class="line"></span><br><span class="line">sed -i -<span class="keyword">e</span> <span class="string">"s?# etcd-key:.*?etcd-key: $ETCD_KEY_BASE64?g"</span> calico.yaml</span><br><span class="line">sed -i -<span class="keyword">e</span> <span class="string">"s?# etcd-cert:.*?etcd-cert: $ETCD_CERT_BASE64?g"</span> calico.yaml </span><br><span class="line">sed -i -<span class="keyword">e</span> <span class="string">"s?# etcd-ca:.*?etcd-ca: $ETCD_CA_BASE64?g"</span> calico.yaml</span><br><span class="line"></span><br><span class="line">sed -i <span class="string">"s?etcd_ca: \"</span>?etcd_ca: \<span class="string">"/calico-secrets/etcd-ca?"</span> calico.yaml</span><br><span class="line">sed -i <span class="string">"s?etcd_cert: \"</span>?etcd_cert: \<span class="string">"/calico-secrets/etcd-cert?"</span> calico.yaml</span><br><span class="line">sed -i <span class="string">"s?etcd_key: \"</span>?etcd_key: \<span class="string">"/calico-secrets/etcd-key?"</span> calico.yaml</span><br><span class="line"></span><br><span class="line">kubectl apply -f calico.yaml</span><br></pre></td></tr></table></figure>
<p>多网卡可以指定接口<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># https://docs.projectcalico.org/v3<span class="meta">.9</span>/reference/node/configuration#<span class="built_in">ip</span>-autodetection-methods</span><br><span class="line"># 默认情况下采用 first-found 方式获取,即获取第一个有效网卡的 <span class="built_in">IP</span> 作为 node <span class="built_in">ip</span>；在某些多网卡机器上可能会出现问题；这里将值设置为 can-reach=<span class="number">192.168</span><span class="meta">.10</span><span class="meta">.81</span>，即使用第一个能够访问 master <span class="number">192.168</span><span class="meta">.1</span><span class="meta">.51</span> 的网卡地址作为 node <span class="built_in">ip</span></span><br><span class="line">- name: IP_AUTODETECTION_METHOD</span><br><span class="line"><span class="symbol">  value:</span> can-reach=<span class="number">192.168</span><span class="meta">.10</span><span class="meta">.81</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">calico.yaml</span> </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: calico/templates/calico-etcd-secrets.yaml</span></span><br><span class="line"><span class="comment"># The following contains k8s Secrets for use with a TLS enabled etcd cluster.</span></span><br><span class="line"><span class="comment"># For information on populating Secrets, see http://kubernetes.io/docs/user-guide/secrets/</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">calico-etcd-secrets</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="comment"># Populate the following with etcd TLS configuration if desired, but leave blank if</span></span><br><span class="line">  <span class="comment"># not using TLS for etcd.</span></span><br><span class="line">  <span class="comment"># The keys below should be uncommented and the values populated with the base64</span></span><br><span class="line">  <span class="comment"># encoded contents of each file that would be associated with the TLS data.</span></span><br><span class="line">  <span class="comment"># Example command for encoding a file contents: cat &lt;file&gt; | base64 -w 0</span></span><br><span class="line"><span class="attr">  etcd-key:</span> <span class="string">LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBOXpXODcxcGpKTSsydzd4NlR5TkIyS0YwcDNvYVFaUTE1RDNSTTF2V0R2cXNkU3VPCktuYUMxMHVFVnpFbllSeDVKWHRWMUJmQjFVRlFUTmExUlhNOStlSFY1cXo3Q3A0WnpHOCswVjB0dkdXRkwySksKT0RjWkFaTW9vakYyMHJnY3d2WVhKNzNVRm9JbzlDY3VRN0J5UElqVkdMdzBjNjJKbWdzUERReXFVaU4zaE1ycQozM1pQN2lPWWRVa3Z5RDhiOHpSekFvK0gxMVV1SWkzaEVsVkJxTjFjS2pJVTJ0MDFJWXllOFE3WDJscmtIL2RKCk92QlNqRnJmTmFpRjVhblFJbkFwRkRsbzZoMVZGVE96MitMZU1lZ1BZNDZnaWQ1Mi82clJrZHJ3WWNkM0JUeXMKYkJkZithNnNYSHc1L012WUZJWFhIaVRURG9wanB4RTJjcmxmT3dJREFRQUJBb0lCQVFEa1ZwaWJKUXZxbG9tawpKbFY2LzMvMGpyMW5iRnNRTTh2TGRHWGxZSEJLQ2JSOXphdFZBWDQ5U3AyRXcvd3hzTkVkazl4bE9VUnFyQmQxCndlUlJyKzZRL3M1S2NZQzMvK3lvYmlEQjFhVkhIU1oxNi8zT0N1Wm9FL3MyUlNZUjRNbUFNenFVRkx6dnhXMzYKaHE0dkM2Mll5SEs4bENxR3BzWXdxUUpQOVdEazE5amx4SFpNcmp1NXhvN2ZiekpyYjZjZ0FsVW5aZitYK3F0VApRcUptTTJ3QWtVRllSVVdCdWM1QVJiY2RWVHlWcFIrUDFvTHNEWWNsQTVxaklyL2s2Y2RCaGVJclJ3NDREWUlwClc5N0VLNVhYNkdORDhSUEZjZnFUcU1ZUDFMakVBd2dML1pjTWZIeVNkdHNVRno2SXJJMVVPVFFsUkNmK0VEMWQKTkJEQUlCd1JBb0dCQVBlcFRBTVgydXVyamV4dXdJdllTcDk2TEJYcWVxS1pib1BGZWdNM29mT0pHRFY4ZWFXOQpIY1k4Z0V2UURuU0dzSVZtNlRrZ1VWcno1aTczQ2NaMC8yZHliN2lUWlVhekhSR2tqWTZrcTZ0UktIVFBOL3FLCm8zZzVqNDFzZE5CNXdCS2hydGtxRmNDeGlueU5ocHk1MHJMR1dodUVDa25xckQ5K2tVMVA0ek5QQW9HQkFQK0kKak42T085YlpqU0tTM0c5WjFTbmw4TjdtcUFUb3F3ZlpiTjhDYitidGFmdG93RGRtRllDaGhPZkdXdU81ajVxRwpsZHk4WHZYQ0FkQUc0Q3FoWndHSERTdU9oRjRyV05PcjdtK1VLT005TDRIbHZ1M1VQVHlMYVF3enNydzFTUjZVCmlVRGtEbU91ckI0OHJ6Y2JCVzl0c1JibGNETzRwTnQwZ1pPK0k4cFZBb0dCQUtBSjZMSy9BWnIxT3pzanZvMGYKOGVqb1hBQzFpeFh6ckRTK3NiL09mWHNRaG5KWnc0cFVrUjcvRGJEdis4ZFZHbEM2VmMreWtLQURxQ1dGUWUzYQp3UWlxTElQTHk5QktBbWphT3hlSVZkN1pEUm1lcG4vaWd3dzN0Z29mb2NUdVNDNUNDT2tRaHdvRU1JZVlOUHFtCklmK2dxYTNLUDVQUWNBcC8wWWx5TEZHRkFvR0FGMnIyTGZjdStMT2JRWTNmOGJ4ejBwRW1EK2RuZ251b0lPSUcKSGpIaysyN0toYVhGNTgzTkxxcWV1WGJ1SVd5Q0FwRk83cG04d2h6emVaTUh2Q0JxaGpOUU82dWw2ZE5qSXBMaApHUXlrNnA1UzJqNnB6clhpbnNmUDZyUmFMdkZiTUJoQXM5ZXlrZVFTRmZ0TnUya1lpR3V2RFFBZDFqK1hyQnp6Ck93enp6cmtDZ1lBZlFYRGlXdjl0YlZHbWc1TkZJSHdLbzBTSEZHZThINERheCtUNTJOT3lDN1k4NmV5NWExVlgKK2V6ZU1pdHlFMkhtdXhtVFhkcVE4cGRhOUVqTmcraHRrTFRORXE0YXRSemwyc3hNdGZXcDRyejhUcjRxRjYvbgpydHFpSUxNdkovV0lWcWFqQW15TEZKQytwNVdzbmV6UG5YbkxxZ3pRNlVZTSthcTFUenIzeGc9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=</span></span><br><span class="line"><span class="attr">  etcd-cert:</span> <span class="string">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUVBRENDQXVpZ0F3SUJBZ0lVQVNVbDF1Qys1TmN0YmR5c1U5eldvejBvbHRrd0RRWUpLb1pJaHZjTkFRRUwKQlFBd2FURUxNQWtHQTFVRUJoTUNRMDR4RWpBUUJnTlZCQWdUQ1VkMVlXNW5XbWh2ZFRFU01CQUdBMVVFQnhNSgpSM1ZoYm1kYWFHOTFNUXd3Q2dZRFZRUUtFd05yT0hNeER6QU5CZ05WQkFzVEJsTjVjM1JsYlRFVE1CRUdBMVVFCkF4TUthM1ZpWlhKdVpYUmxjekFnRncweE9URXdNVFV4TURFMU1EQmFHQTh5TVRFNU1Ea3lNVEV3TVRVd01Gb3cKWXpFTE1Ba0dBMVVFQmhNQ1EwNHhFakFRQmdOVkJBZ1RDVWQxWVc1bldtaHZkVEVTTUJBR0ExVUVCeE1KUjNWaApibWRhYUc5MU1Rd3dDZ1lEVlFRS0V3TnJPSE14RHpBTkJnTlZCQXNUQmxONWMzUmxiVEVOTUFzR0ExVUVBeE1FClpYUmpaRENDQVNJd0RRWUpLb1pJaHZjTkFRRUJCUUFEZ2dFUEFEQ0NBUW9DZ2dFQkFQYzF2TzlhWXlUUHRzTzgKZWs4alFkaWhkS2Q2R2tHVU5lUTkwVE5iMWc3NnJIVXJqaXAyZ3RkTGhGY3hKMkVjZVNWN1ZkUVh3ZFZCVUV6Vwp0VVZ6UGZuaDFlYXMrd3FlR2N4dlB0RmRMYnhsaFM5aVNqZzNHUUdUS0tJeGR0SzRITUwyRnllOTFCYUNLUFFuCkxrT3djanlJMVJpOE5IT3RpWm9MRHcwTXFsSWpkNFRLNnQ5MlQrNGptSFZKTDhnL0cvTTBjd0tQaDlkVkxpSXQKNFJKVlFhamRYQ295Rk5yZE5TR01udkVPMTlwYTVCLzNTVHJ3VW94YTN6V29oZVdwMENKd0tSUTVhT29kVlJVegpzOXZpM2pIb0QyT09vSW5lZHYrcTBaSGE4R0hIZHdVOHJHd1hYL211ckZ4OE9mekwyQlNGMXg0azB3NktZNmNSCk5uSzVYenNDQXdFQUFhT0JvekNCb0RBT0JnTlZIUThCQWY4RUJBTUNCYUF3SFFZRFZSMGxCQll3RkFZSUt3WUIKQlFVSEF3RUdDQ3NHQVFVRkJ3TUNNQXdHQTFVZEV3RUIvd1FDTUFBd0hRWURWUjBPQkJZRUZNZmtmdnFnNmxPSApoMGpBVmRhZUIrOVd3VDBGTUI4R0ExVWRJd1FZTUJhQUZIcTFudFlQV29oQW4wOUNidTdSQzFGRDZGN2tNQ0VHCkExVWRFUVFhTUJpSEJIOEFBQUdIQk1Db0NoS0hCTUNvQ2hTSEJNQ29DaFV3RFFZSktvWklodmNOQVFFTEJRQUQKZ2dFQkFJbzN6Yyt4MTY0aEZldG0zTTFka2NFcWdOK2FmTWg5TWN2UElEL3V2QTFoQzBubkJ3MmxneWlUTkpqVQpYdlVFY21nNmNXOUJod2lDcUEyRmtvZCtQNUF1QU5KTWxsM3FoVVpPcXJ0bXowdm5wZXVnUUNaSG9uUjBneG1jCkJDbDBZSHNlWlRQekJMWnhRVmdBVW91VEt3K0d1TmRtZHBvdTFlK25WZ1FlTGt4dkNKSjJwRHlXbGpwTENkQ3UKNHVFWmtJRnU5OTlueEpaeGdyeXpwd0lsbGFiME9JYmozbnZGcVRWd24yM0JyaDIxTEdFcGcvOCtxL243VkJDMAp4aENMWGVPbnQybWpjQjgvYzZkYW1zeWZ6dlkvVFRFamVoMlhPUFNuNW5wT0piV2FMNk5lNTVkeW5nbUNhczhoCkpZcEtrNldFZTU3NHpoWVQwMkpBY1BYcEk5ND0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=</span></span><br><span class="line"><span class="attr">  etcd-ca:</span> <span class="string">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUR5RENDQXJDZ0F3SUJBZ0lVVzNMMFdEelp6UUJ3dm5id25CbG9GUUlHSWlzd0RRWUpLb1pJaHZjTkFRRUwKQlFBd2FURUxNQWtHQTFVRUJoTUNRMDR4RWpBUUJnTlZCQWdUQ1VkMVlXNW5XbWh2ZFRFU01CQUdBMVVFQnhNSgpSM1ZoYm1kYWFHOTFNUXd3Q2dZRFZRUUtFd05yT0hNeER6QU5CZ05WQkFzVEJsTjVjM1JsYlRFVE1CRUdBMVVFCkF4TUthM1ZpWlhKdVpYUmxjekFnRncweE9URXdNVFV4TURFeU1EQmFHQTh5TVRFNU1Ea3lNVEV3TVRJd01Gb3cKYVRFTE1Ba0dBMVVFQmhNQ1EwNHhFakFRQmdOVkJBZ1RDVWQxWVc1bldtaHZkVEVTTUJBR0ExVUVCeE1KUjNWaApibWRhYUc5MU1Rd3dDZ1lEVlFRS0V3TnJPSE14RHpBTkJnTlZCQXNUQmxONWMzUmxiVEVUTUJFR0ExVUVBeE1LCmEzVmlaWEp1WlhSbGN6Q0NBU0l3RFFZSktvWklodmNOQVFFQkJRQURnZ0VQQURDQ0FRb0NnZ0VCQU5iTzVqRjcKTVdPeDF4N0srNVBKUEt4c2VEeDh3eHgzWmdVdzhjbVFBbjRXcEowMDJVT1ZQZ1EzQjlFbjBXVFZLeUw4dDE0WQordHJlVVlQQW85akVhY1AwakxJY0JwRHFjYXpCUVVUQWg1bzY4bzFra1JuQ3QwcXNVL1NTTkJINHlGREk3ZEdzCjRZYzJxYkNVdm9XeU9JM1o2eXJhSmJ4Mm5POUI1am1IdXlsc1VqMlFSZ2pCUHRlT0dvSzZYc3VWYzd2R2ozOS8KZWV5RmlRVzZQb3ZlekhKYjdzU1g5WmFsMWs4TnBHQ2NuY0s5d0VycW5PcXlOMjFnaGdteCs3eGQ1ZENrNnBGRgo3L2FoU1I1czdVN3VDQktrL1NQVmJ3Y2w1STEzdzhCMFFSUVJOTmI5TW1Tc3RRNVFGNGlXODNtRURUR1piN09hCkVzU0FUUHlsZWdnTllWVUNBd0VBQWFObU1HUXdEZ1lEVlIwUEFRSC9CQVFEQWdFR01CSUdBMVVkRXdFQi93UUkKTUFZQkFmOENBUUl3SFFZRFZSME9CQllFRkhxMW50WVBXb2hBbjA5Q2J1N1JDMUZENkY3a01COEdBMVVkSXdRWQpNQmFBRkhxMW50WVBXb2hBbjA5Q2J1N1JDMUZENkY3a01BMEdDU3FHU0liM0RRRUJDd1VBQTRJQkFRQ094S1dxCkphWS9XeExjNGl3OHJRN05oNEYzTWpjbndEZ2E1MGM1cFg2ZXRZWGh2ZnFQbFQ4azZJWlZiSlBzL0s2bmVrTncKN2daUWRaenVnbXNIZ3lPdWVtOE1HcTlXREoyWVVnWkFGWm1INTl4K2t5VTBMSVZ1UHM5L01KKzlDZlN3YUVkNQpSbzVqUTBzTGtnekZkVFpFd1FoVWg4SEZvcVp6RXhNQ0ZKVVV5amZ3OW0xL0tRVjRFcE1IVEt1M1dLcjhJR2lWCncwcmFSY3JwdEkvdHNvb21HbWFPanE2cHR6dDVqUmZQYUpGQXM5UkU4S2tPRmFlWHNBS3R1V21rRFBrallWcloKakRGRkJCekpZdkV5NC9KL2dVU25raExFWjFDTmJJNkhsdjZiVUtyZHp5VGo3R1crQlFZd1Y3RWxvV1dpWDNOaApTalBNWEc2b01uTStTZDRUCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: calico/templates/calico-config.yaml</span></span><br><span class="line"><span class="comment"># This ConfigMap is used to configure a self-hosted Calico installation.</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">calico-config</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="comment"># Configure this with the location of your etcd cluster.</span></span><br><span class="line"><span class="attr">  etcd_endpoints:</span> <span class="string">"https://192.168.10.18:2379,https://192.168.10.20:2379,https://192.168.10.21:2379"</span></span><br><span class="line">  <span class="comment"># If you're using TLS enabled etcd uncomment the following.</span></span><br><span class="line">  <span class="comment"># You must also populate the Secret below with these files.</span></span><br><span class="line"><span class="attr">  etcd_ca:</span> <span class="string">"/calico-secrets/etcd-ca"</span> <span class="comment"># "/calico-secrets/etcd-ca"</span></span><br><span class="line"><span class="attr">  etcd_cert:</span> <span class="string">"/calico-secrets/etcd-cert"</span> <span class="comment"># "/calico-secrets/etcd-cert"</span></span><br><span class="line"><span class="attr">  etcd_key:</span> <span class="string">"/calico-secrets/etcd-key"</span> <span class="comment"># "/calico-secrets/etcd-key"</span></span><br><span class="line">  <span class="comment"># Typha is disabled.</span></span><br><span class="line"><span class="attr">  typha_service_name:</span> <span class="string">"none"</span></span><br><span class="line">  <span class="comment"># Configure the backend to use.</span></span><br><span class="line"><span class="attr">  calico_backend:</span> <span class="string">"bird"</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Configure the MTU to use</span></span><br><span class="line"><span class="attr">  veth_mtu:</span> <span class="string">"1440"</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># The CNI network configuration to install on each node.  The special</span></span><br><span class="line">  <span class="comment"># values in this config will be automatically populated.</span></span><br><span class="line"><span class="attr">  cni_network_config:</span> <span class="string">|-</span></span><br><span class="line">    <span class="string">&#123;</span></span><br><span class="line"><span class="attr">      "name":</span> <span class="string">"k8s-pod-network"</span><span class="string">,</span></span><br><span class="line"><span class="attr">      "cniVersion":</span> <span class="string">"0.3.1"</span><span class="string">,</span></span><br><span class="line"><span class="attr">      "plugins":</span> <span class="string">[</span></span><br><span class="line">        <span class="string">&#123;</span></span><br><span class="line"><span class="attr">          "type":</span> <span class="string">"calico"</span><span class="string">,</span></span><br><span class="line"><span class="attr">          "log_level":</span> <span class="string">"info"</span><span class="string">,</span></span><br><span class="line"><span class="attr">          "etcd_endpoints":</span> <span class="string">"__ETCD_ENDPOINTS__"</span><span class="string">,</span></span><br><span class="line"><span class="attr">          "etcd_key_file":</span> <span class="string">"__ETCD_KEY_FILE__"</span><span class="string">,</span></span><br><span class="line"><span class="attr">          "etcd_cert_file":</span> <span class="string">"__ETCD_CERT_FILE__"</span><span class="string">,</span></span><br><span class="line"><span class="attr">          "etcd_ca_cert_file":</span> <span class="string">"__ETCD_CA_CERT_FILE__"</span><span class="string">,</span></span><br><span class="line"><span class="attr">          "mtu":</span> <span class="string">__CNI_MTU__,</span></span><br><span class="line"><span class="attr">          "ipam":</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">              "type":</span> <span class="string">"calico-ipam"</span></span><br><span class="line">          <span class="string">&#125;,</span></span><br><span class="line"><span class="attr">          "policy":</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">              "type":</span> <span class="string">"k8s"</span></span><br><span class="line">          <span class="string">&#125;,</span></span><br><span class="line"><span class="attr">          "kubernetes":</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">              "kubeconfig":</span> <span class="string">"__KUBECONFIG_FILEPATH__"</span></span><br><span class="line">          <span class="string">&#125;</span></span><br><span class="line">        <span class="string">&#125;,</span></span><br><span class="line">        <span class="string">&#123;</span></span><br><span class="line"><span class="attr">          "type":</span> <span class="string">"portmap"</span><span class="string">,</span></span><br><span class="line"><span class="attr">          "snat":</span> <span class="literal">true</span><span class="string">,</span></span><br><span class="line"><span class="attr">          "capabilities":</span> <span class="string">&#123;"portMappings":</span> <span class="literal">true</span><span class="string">&#125;</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line">      <span class="string">]</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: calico/templates/rbac.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Include a clusterrole for the kube-controllers component,</span></span><br><span class="line"><span class="comment"># and bind it to the calico-kube-controllers serviceaccount.</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">calico-kube-controllers</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="comment"># Pods are monitored for changing labels.</span></span><br><span class="line">  <span class="comment"># The node controller monitors Kubernetes nodes.</span></span><br><span class="line">  <span class="comment"># Namespace and serviceaccount labels are used for policy.</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">pods</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">nodes</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">namespaces</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">serviceaccounts</span></span><br><span class="line"><span class="attr">    verbs:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">list</span></span><br><span class="line">  <span class="comment"># Watch for changes to Kubernetes NetworkPolicies.</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">["networking.k8s.io"]</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">networkpolicies</span></span><br><span class="line"><span class="attr">    verbs:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">list</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">calico-kube-controllers</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">calico-kube-controllers</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">calico-kube-controllers</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Include a clusterrole for the calico-node DaemonSet,</span></span><br><span class="line"><span class="comment"># and bind it to the calico-node serviceaccount.</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">calico-node</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="comment"># The CNI plugin needs to get pods, nodes, and namespaces.</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">pods</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">nodes</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">namespaces</span></span><br><span class="line"><span class="attr">    verbs:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">get</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">endpoints</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">services</span></span><br><span class="line"><span class="attr">    verbs:</span></span><br><span class="line">      <span class="comment"># Used to discover service IPs for advertisement.</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">list</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">nodes/status</span></span><br><span class="line"><span class="attr">    verbs:</span></span><br><span class="line">      <span class="comment"># Needed for clearing NodeNetworkUnavailable flag.</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">patch</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">calico-node</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">calico-node</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">calico-node</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: calico/templates/calico-node.yaml</span></span><br><span class="line"><span class="comment"># This manifest installs the calico-node container, as well</span></span><br><span class="line"><span class="comment"># as the CNI plugins and network config on</span></span><br><span class="line"><span class="comment"># each master and worker node in a Kubernetes cluster.</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">calico-node</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    k8s-app:</span> <span class="string">calico-node</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      k8s-app:</span> <span class="string">calico-node</span></span><br><span class="line"><span class="attr">  updateStrategy:</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">RollingUpdate</span></span><br><span class="line"><span class="attr">    rollingUpdate:</span></span><br><span class="line"><span class="attr">      maxUnavailable:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        k8s-app:</span> <span class="string">calico-node</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line">        <span class="comment"># This, along with the CriticalAddonsOnly toleration below,</span></span><br><span class="line">        <span class="comment"># marks the pod as a critical add-on, ensuring it gets</span></span><br><span class="line">        <span class="comment"># priority scheduling and that its resources are reserved</span></span><br><span class="line">        <span class="comment"># if it ever gets evicted.</span></span><br><span class="line">        <span class="string">scheduler.alpha.kubernetes.io/critical-pod:</span> <span class="string">''</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      nodeSelector:</span></span><br><span class="line">        <span class="string">beta.kubernetes.io/os:</span> <span class="string">linux</span></span><br><span class="line"><span class="attr">      hostNetwork:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      tolerations:</span></span><br><span class="line">        <span class="comment"># Make sure calico-node gets scheduled on all nodes.</span></span><br><span class="line"><span class="attr">        - effect:</span> <span class="string">NoSchedule</span></span><br><span class="line"><span class="attr">          operator:</span> <span class="string">Exists</span></span><br><span class="line">        <span class="comment"># Mark the pod as a critical add-on for rescheduling.</span></span><br><span class="line"><span class="attr">        - key:</span> <span class="string">CriticalAddonsOnly</span></span><br><span class="line"><span class="attr">          operator:</span> <span class="string">Exists</span></span><br><span class="line"><span class="attr">        - effect:</span> <span class="string">NoExecute</span></span><br><span class="line"><span class="attr">          operator:</span> <span class="string">Exists</span></span><br><span class="line"><span class="attr">      serviceAccountName:</span> <span class="string">calico-node</span></span><br><span class="line">      <span class="comment"># Minimize downtime during a rolling upgrade or deletion; tell Kubernetes to do a "force</span></span><br><span class="line">      <span class="comment"># deletion": https://kubernetes.io/docs/concepts/workloads/pods/pod/#termination-of-pods.</span></span><br><span class="line"><span class="attr">      terminationGracePeriodSeconds:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">      priorityClassName:</span> <span class="string">system-node-critical</span></span><br><span class="line"><span class="attr">      initContainers:</span></span><br><span class="line">        <span class="comment"># This container installs the CNI binaries</span></span><br><span class="line">        <span class="comment"># and CNI network config file on each node.</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">install-cni</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">calico/cni:v3.9.2</span></span><br><span class="line"><span class="attr">          command:</span> <span class="string">["/install-cni.sh"]</span></span><br><span class="line"><span class="attr">          env:</span></span><br><span class="line">            <span class="comment"># Name of the CNI config file to create.</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">CNI_CONF_NAME</span></span><br><span class="line"><span class="attr">              value:</span> <span class="string">"10-calico.conflist"</span></span><br><span class="line">            <span class="comment"># The CNI network config to install on each node.</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">CNI_NETWORK_CONFIG</span></span><br><span class="line"><span class="attr">              valueFrom:</span></span><br><span class="line"><span class="attr">                configMapKeyRef:</span></span><br><span class="line"><span class="attr">                  name:</span> <span class="string">calico-config</span></span><br><span class="line"><span class="attr">                  key:</span> <span class="string">cni_network_config</span></span><br><span class="line">            <span class="comment"># The location of the etcd cluster.</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">ETCD_ENDPOINTS</span></span><br><span class="line"><span class="attr">              valueFrom:</span></span><br><span class="line"><span class="attr">                configMapKeyRef:</span></span><br><span class="line"><span class="attr">                  name:</span> <span class="string">calico-config</span></span><br><span class="line"><span class="attr">                  key:</span> <span class="string">etcd_endpoints</span></span><br><span class="line">            <span class="comment"># CNI MTU Config variable</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">CNI_MTU</span></span><br><span class="line"><span class="attr">              valueFrom:</span></span><br><span class="line"><span class="attr">                configMapKeyRef:</span></span><br><span class="line"><span class="attr">                  name:</span> <span class="string">calico-config</span></span><br><span class="line"><span class="attr">                  key:</span> <span class="string">veth_mtu</span></span><br><span class="line">            <span class="comment"># Prevents the container from sleeping forever.</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">SLEEP</span></span><br><span class="line"><span class="attr">              value:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">          volumeMounts:</span></span><br><span class="line"><span class="attr">            - mountPath:</span> <span class="string">/host/opt/cni/bin</span></span><br><span class="line"><span class="attr">              name:</span> <span class="string">cni-bin-dir</span></span><br><span class="line"><span class="attr">            - mountPath:</span> <span class="string">/host/etc/cni/net.d</span></span><br><span class="line"><span class="attr">              name:</span> <span class="string">cni-net-dir</span></span><br><span class="line"><span class="attr">            - mountPath:</span> <span class="string">/calico-secrets</span></span><br><span class="line"><span class="attr">              name:</span> <span class="string">etcd-certs</span></span><br><span class="line">        <span class="comment"># Adds a Flex Volume Driver that creates a per-pod Unix Domain Socket to allow Dikastes</span></span><br><span class="line">        <span class="comment"># to communicate with Felix over the Policy Sync API.</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">flexvol-driver</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">calico/pod2daemon-flexvol:v3.9.2</span></span><br><span class="line"><span class="attr">          volumeMounts:</span></span><br><span class="line"><span class="attr">          - name:</span> <span class="string">flexvol-driver-host</span></span><br><span class="line"><span class="attr">            mountPath:</span> <span class="string">/host/driver</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line">        <span class="comment"># Runs calico-node container on each Kubernetes node.  This</span></span><br><span class="line">        <span class="comment"># container programs network policy and routes on each</span></span><br><span class="line">        <span class="comment"># host.</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">calico-node</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">calico/node:v3.9.2</span></span><br><span class="line"><span class="attr">          env:</span></span><br><span class="line">            <span class="comment"># The location of the etcd cluster.</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">ETCD_ENDPOINTS</span></span><br><span class="line"><span class="attr">              valueFrom:</span></span><br><span class="line"><span class="attr">                configMapKeyRef:</span></span><br><span class="line"><span class="attr">                  name:</span> <span class="string">calico-config</span></span><br><span class="line"><span class="attr">                  key:</span> <span class="string">etcd_endpoints</span></span><br><span class="line">            <span class="comment"># Location of the CA certificate for etcd.</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">ETCD_CA_CERT_FILE</span></span><br><span class="line"><span class="attr">              valueFrom:</span></span><br><span class="line"><span class="attr">                configMapKeyRef:</span></span><br><span class="line"><span class="attr">                  name:</span> <span class="string">calico-config</span></span><br><span class="line"><span class="attr">                  key:</span> <span class="string">etcd_ca</span></span><br><span class="line">            <span class="comment"># Location of the client key for etcd.</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">ETCD_KEY_FILE</span></span><br><span class="line"><span class="attr">              valueFrom:</span></span><br><span class="line"><span class="attr">                configMapKeyRef:</span></span><br><span class="line"><span class="attr">                  name:</span> <span class="string">calico-config</span></span><br><span class="line"><span class="attr">                  key:</span> <span class="string">etcd_key</span></span><br><span class="line">            <span class="comment"># Location of the client certificate for etcd.</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">ETCD_CERT_FILE</span></span><br><span class="line"><span class="attr">              valueFrom:</span></span><br><span class="line"><span class="attr">                configMapKeyRef:</span></span><br><span class="line"><span class="attr">                  name:</span> <span class="string">calico-config</span></span><br><span class="line"><span class="attr">                  key:</span> <span class="string">etcd_cert</span></span><br><span class="line">            <span class="comment"># Set noderef for node controller.</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">CALICO_K8S_NODE_REF</span></span><br><span class="line"><span class="attr">              valueFrom:</span></span><br><span class="line"><span class="attr">                fieldRef:</span></span><br><span class="line"><span class="attr">                  fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">            <span class="comment"># Choose the backend to use.</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">CALICO_NETWORKING_BACKEND</span></span><br><span class="line"><span class="attr">              valueFrom:</span></span><br><span class="line"><span class="attr">                configMapKeyRef:</span></span><br><span class="line"><span class="attr">                  name:</span> <span class="string">calico-config</span></span><br><span class="line"><span class="attr">                  key:</span> <span class="string">calico_backend</span></span><br><span class="line">            <span class="comment"># Cluster type to identify the deployment type</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">CLUSTER_TYPE</span></span><br><span class="line"><span class="attr">              value:</span> <span class="string">"k8s,bgp"</span></span><br><span class="line">            <span class="comment"># Auto-detect the BGP IP address.</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">IP</span></span><br><span class="line"><span class="attr">              value:</span> <span class="string">"autodetect"</span></span><br><span class="line">            <span class="comment"># Enable IPIP</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">CALICO_IPV4POOL_IPIP</span></span><br><span class="line"><span class="attr">              value:</span> <span class="string">"Always"</span></span><br><span class="line">            <span class="comment"># Set MTU for tunnel device used if ipip is enabled</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">FELIX_IPINIPMTU</span></span><br><span class="line"><span class="attr">              valueFrom:</span></span><br><span class="line"><span class="attr">                configMapKeyRef:</span></span><br><span class="line"><span class="attr">                  name:</span> <span class="string">calico-config</span></span><br><span class="line"><span class="attr">                  key:</span> <span class="string">veth_mtu</span></span><br><span class="line">            <span class="comment"># The default IPv4 pool to create on startup if none exists. Pod IPs will be</span></span><br><span class="line">            <span class="comment"># chosen from this range. Changing this value after installation will have</span></span><br><span class="line">            <span class="comment"># no effect. This should fall within `--cluster-cidr`.</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">CALICO_IPV4POOL_CIDR</span></span><br><span class="line"><span class="attr">              value:</span> <span class="string">"10.244.0.0/16"</span></span><br><span class="line">            <span class="comment"># Disable file logging so `kubectl logs` works.</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">CALICO_DISABLE_FILE_LOGGING</span></span><br><span class="line"><span class="attr">              value:</span> <span class="string">"true"</span></span><br><span class="line">            <span class="comment"># Set Felix endpoint to host default action to ACCEPT.</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">FELIX_DEFAULTENDPOINTTOHOSTACTION</span></span><br><span class="line"><span class="attr">              value:</span> <span class="string">"ACCEPT"</span></span><br><span class="line">            <span class="comment"># Disable IPv6 on Kubernetes.</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">FELIX_IPV6SUPPORT</span></span><br><span class="line"><span class="attr">              value:</span> <span class="string">"false"</span></span><br><span class="line">            <span class="comment"># Set Felix logging to "info"</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">FELIX_LOGSEVERITYSCREEN</span></span><br><span class="line"><span class="attr">              value:</span> <span class="string">"info"</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">FELIX_HEALTHENABLED</span></span><br><span class="line"><span class="attr">              value:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">IP_AUTODETECTION_METHOD</span></span><br><span class="line"><span class="attr">              value:</span> <span class="string">can-reach=192.168.10.81</span></span><br><span class="line"><span class="attr">          securityContext:</span></span><br><span class="line"><span class="attr">            privileged:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">          resources:</span></span><br><span class="line"><span class="attr">            requests:</span></span><br><span class="line"><span class="attr">              cpu:</span> <span class="number">250</span><span class="string">m</span></span><br><span class="line"><span class="attr">          livenessProbe:</span></span><br><span class="line"><span class="attr">            exec:</span></span><br><span class="line"><span class="attr">              command:</span></span><br><span class="line"><span class="bullet">              -</span> <span class="string">/bin/calico-node</span></span><br><span class="line"><span class="bullet">              -</span> <span class="bullet">-felix-live</span></span><br><span class="line"><span class="attr">            periodSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">            initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">            failureThreshold:</span> <span class="number">6</span></span><br><span class="line"><span class="attr">          readinessProbe:</span></span><br><span class="line"><span class="attr">            exec:</span></span><br><span class="line"><span class="attr">              command:</span></span><br><span class="line"><span class="bullet">              -</span> <span class="string">/bin/calico-node</span></span><br><span class="line"><span class="bullet">              -</span> <span class="bullet">-felix-ready</span></span><br><span class="line"><span class="bullet">              -</span> <span class="bullet">-bird-ready</span></span><br><span class="line"><span class="attr">            periodSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">          volumeMounts:</span></span><br><span class="line"><span class="attr">            - mountPath:</span> <span class="string">/lib/modules</span></span><br><span class="line"><span class="attr">              name:</span> <span class="string">lib-modules</span></span><br><span class="line"><span class="attr">              readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">            - mountPath:</span> <span class="string">/run/xtables.lock</span></span><br><span class="line"><span class="attr">              name:</span> <span class="string">xtables-lock</span></span><br><span class="line"><span class="attr">              readOnly:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">            - mountPath:</span> <span class="string">/var/run/calico</span></span><br><span class="line"><span class="attr">              name:</span> <span class="string">var-run-calico</span></span><br><span class="line"><span class="attr">              readOnly:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">            - mountPath:</span> <span class="string">/var/lib/calico</span></span><br><span class="line"><span class="attr">              name:</span> <span class="string">var-lib-calico</span></span><br><span class="line"><span class="attr">              readOnly:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">            - mountPath:</span> <span class="string">/calico-secrets</span></span><br><span class="line"><span class="attr">              name:</span> <span class="string">etcd-certs</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">policysync</span></span><br><span class="line"><span class="attr">              mountPath:</span> <span class="string">/var/run/nodeagent</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line">        <span class="comment"># Used by calico-node.</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">lib-modules</span></span><br><span class="line"><span class="attr">          hostPath:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/lib/modules</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">var-run-calico</span></span><br><span class="line"><span class="attr">          hostPath:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/var/run/calico</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">var-lib-calico</span></span><br><span class="line"><span class="attr">          hostPath:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/var/lib/calico</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">xtables-lock</span></span><br><span class="line"><span class="attr">          hostPath:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/run/xtables.lock</span></span><br><span class="line"><span class="attr">            type:</span> <span class="string">FileOrCreate</span></span><br><span class="line">        <span class="comment"># Used to install CNI.</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">cni-bin-dir</span></span><br><span class="line"><span class="attr">          hostPath:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/opt/cni/bin</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">cni-net-dir</span></span><br><span class="line"><span class="attr">          hostPath:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/etc/cni/net.d</span></span><br><span class="line">        <span class="comment"># Mount in the etcd TLS secrets with mode 400.</span></span><br><span class="line">        <span class="comment"># See https://kubernetes.io/docs/concepts/configuration/secret/</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">etcd-certs</span></span><br><span class="line"><span class="attr">          secret:</span></span><br><span class="line"><span class="attr">            secretName:</span> <span class="string">calico-etcd-secrets</span></span><br><span class="line"><span class="attr">            defaultMode:</span> <span class="number">0400</span></span><br><span class="line">        <span class="comment"># Used to create per-pod Unix Domain Sockets</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">policysync</span></span><br><span class="line"><span class="attr">          hostPath:</span></span><br><span class="line"><span class="attr">            type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/var/run/nodeagent</span></span><br><span class="line">        <span class="comment"># Used to install Flex Volume Driver</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">flexvol-driver-host</span></span><br><span class="line"><span class="attr">          hostPath:</span></span><br><span class="line"><span class="attr">            type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/usr/libexec/kubernetes/kubelet-plugins/volume/exec/nodeagent~uds</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">calico-node</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: calico/templates/calico-kube-controllers.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># See https://github.com/projectcalico/kube-controllers</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">calico-kube-controllers</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    k8s-app:</span> <span class="string">calico-kube-controllers</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># The controllers can only have a single active instance.</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      k8s-app:</span> <span class="string">calico-kube-controllers</span></span><br><span class="line"><span class="attr">  strategy:</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">Recreate</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">calico-kube-controllers</span></span><br><span class="line"><span class="attr">      namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        k8s-app:</span> <span class="string">calico-kube-controllers</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line">        <span class="string">scheduler.alpha.kubernetes.io/critical-pod:</span> <span class="string">''</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      nodeSelector:</span></span><br><span class="line">        <span class="string">beta.kubernetes.io/os:</span> <span class="string">linux</span></span><br><span class="line"><span class="attr">      tolerations:</span></span><br><span class="line">        <span class="comment"># Mark the pod as a critical add-on for rescheduling.</span></span><br><span class="line"><span class="attr">        - key:</span> <span class="string">CriticalAddonsOnly</span></span><br><span class="line"><span class="attr">          operator:</span> <span class="string">Exists</span></span><br><span class="line"><span class="attr">        - key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line"><span class="attr">          effect:</span> <span class="string">NoSchedule</span></span><br><span class="line"><span class="attr">      serviceAccountName:</span> <span class="string">calico-kube-controllers</span></span><br><span class="line"><span class="attr">      priorityClassName:</span> <span class="string">system-cluster-critical</span></span><br><span class="line">      <span class="comment"># The controllers must run in the host network namespace so that</span></span><br><span class="line">      <span class="comment"># it isn't governed by policy that would prevent it from working.</span></span><br><span class="line"><span class="attr">      hostNetwork:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">calico-kube-controllers</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">calico/kube-controllers:v3.9.2</span></span><br><span class="line"><span class="attr">          env:</span></span><br><span class="line">            <span class="comment"># The location of the etcd cluster.</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">ETCD_ENDPOINTS</span></span><br><span class="line"><span class="attr">              valueFrom:</span></span><br><span class="line"><span class="attr">                configMapKeyRef:</span></span><br><span class="line"><span class="attr">                  name:</span> <span class="string">calico-config</span></span><br><span class="line"><span class="attr">                  key:</span> <span class="string">etcd_endpoints</span></span><br><span class="line">            <span class="comment"># Location of the CA certificate for etcd.</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">ETCD_CA_CERT_FILE</span></span><br><span class="line"><span class="attr">              valueFrom:</span></span><br><span class="line"><span class="attr">                configMapKeyRef:</span></span><br><span class="line"><span class="attr">                  name:</span> <span class="string">calico-config</span></span><br><span class="line"><span class="attr">                  key:</span> <span class="string">etcd_ca</span></span><br><span class="line">            <span class="comment"># Location of the client key for etcd.</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">ETCD_KEY_FILE</span></span><br><span class="line"><span class="attr">              valueFrom:</span></span><br><span class="line"><span class="attr">                configMapKeyRef:</span></span><br><span class="line"><span class="attr">                  name:</span> <span class="string">calico-config</span></span><br><span class="line"><span class="attr">                  key:</span> <span class="string">etcd_key</span></span><br><span class="line">            <span class="comment"># Location of the client certificate for etcd.</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">ETCD_CERT_FILE</span></span><br><span class="line"><span class="attr">              valueFrom:</span></span><br><span class="line"><span class="attr">                configMapKeyRef:</span></span><br><span class="line"><span class="attr">                  name:</span> <span class="string">calico-config</span></span><br><span class="line"><span class="attr">                  key:</span> <span class="string">etcd_cert</span></span><br><span class="line">            <span class="comment"># Choose which controllers to run.</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">ENABLED_CONTROLLERS</span></span><br><span class="line"><span class="attr">              value:</span> <span class="string">policy,namespace,serviceaccount,workloadendpoint,node</span></span><br><span class="line"><span class="attr">          volumeMounts:</span></span><br><span class="line">            <span class="comment"># Mount in the etcd TLS secrets.</span></span><br><span class="line"><span class="attr">            - mountPath:</span> <span class="string">/calico-secrets</span></span><br><span class="line"><span class="attr">              name:</span> <span class="string">etcd-certs</span></span><br><span class="line"><span class="attr">          readinessProbe:</span></span><br><span class="line"><span class="attr">            exec:</span></span><br><span class="line"><span class="attr">              command:</span></span><br><span class="line"><span class="bullet">              -</span> <span class="string">/usr/bin/check-status</span></span><br><span class="line"><span class="bullet">              -</span> <span class="bullet">-r</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line">        <span class="comment"># Mount in the etcd TLS secrets with mode 400.</span></span><br><span class="line">        <span class="comment"># See https://kubernetes.io/docs/concepts/configuration/secret/</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">etcd-certs</span></span><br><span class="line"><span class="attr">          secret:</span></span><br><span class="line"><span class="attr">            secretName:</span> <span class="string">calico-etcd-secrets</span></span><br><span class="line"><span class="attr">            defaultMode:</span> <span class="number">0400</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">calico-kube-controllers</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: calico/templates/calico-typha.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: calico/templates/configure-canal.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: calico/templates/kdd-crds.yaml</span></span><br></pre></td></tr></table></figure>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#kubectl get deployment,pod -nkube-system</span><br><span class="line">NAME                                            READY   <span class="meta">UP</span>-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.extensions/calico-kube-controllers   <span class="number">1</span>/<span class="number">1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="number">17h</span></span><br><span class="line"></span><br><span class="line">NAME                                           READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/calico-kube-controllers-8576cc9448-dlhmp   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">17h</span></span><br><span class="line">pod/calico-node-kjp47                          <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">17h</span></span><br><span class="line">pod/calico-node-kngmg                          <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">17h</span></span><br><span class="line">pod/calico-node-nhkjt                          <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">17h</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"># ifconfig tunl0</span><br><span class="line">tunl0     Link encap:IPIP Tunnel  HWaddr   </span><br><span class="line">          inet addr:<span class="number">10.244</span><span class="meta">.42</span><span class="meta">.192</span>  Mask:<span class="number">255.255</span><span class="meta">.255</span><span class="meta">.255</span></span><br><span class="line">          <span class="meta">UP</span> RUNNING NOARP  MTU:<span class="number">1440</span>  Metric:<span class="number">1</span></span><br><span class="line">          RX packets:<span class="number">20</span> errors:<span class="number">0</span> dropped:<span class="number">0</span> overruns:<span class="number">0</span> frame:<span class="number">0</span></span><br><span class="line">          TX packets:<span class="number">20</span> errors:<span class="number">0</span> dropped:<span class="number">0</span> overruns:<span class="number">0</span> carrier:<span class="number">0</span></span><br><span class="line"><span class="symbol">          collisions:</span><span class="number">0</span> txqueuelen:<span class="number">1</span> </span><br><span class="line">          RX bytes:<span class="number">3754</span> (<span class="number">3.7</span> KB)  TX bytes:<span class="number">3530</span> (<span class="number">3.5</span> KB)</span><br><span class="line"></span><br><span class="line"># route -nv</span><br><span class="line">Kernel <span class="built_in">IP</span> routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line"><span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>         <span class="number">192.168</span><span class="meta">.10</span><span class="meta">.1</span>    <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>         UG    <span class="number">0</span>      <span class="number">0</span>        <span class="number">0</span> eno1</span><br><span class="line"><span class="number">10.244</span><span class="meta">.40</span><span class="meta">.64</span>    <span class="number">192.168</span><span class="meta">.10</span><span class="meta">.82</span>   <span class="number">255.255</span><span class="meta">.255</span><span class="meta">.192</span> UG    <span class="number">0</span>      <span class="number">0</span>        <span class="number">0</span> tunl0</span><br><span class="line"><span class="number">10.244</span><span class="meta">.42</span><span class="meta">.192</span>   <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>         <span class="number">255.255</span><span class="meta">.255</span><span class="meta">.192</span> U     <span class="number">0</span>      <span class="number">0</span>        <span class="number">0</span> *</span><br><span class="line"><span class="number">10.244</span><span class="meta">.42</span><span class="meta">.198</span>   <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>         <span class="number">255.255</span><span class="meta">.255</span><span class="meta">.255</span> UH    <span class="number">0</span>      <span class="number">0</span>        <span class="number">0</span> calic24aedbc670</span><br><span class="line"><span class="number">10.244</span><span class="meta">.134</span><span class="meta">.128</span>  <span class="number">192.168</span><span class="meta">.10</span><span class="meta">.83</span>   <span class="number">255.255</span><span class="meta">.255</span><span class="meta">.192</span> UG    <span class="number">0</span>      <span class="number">0</span>        <span class="number">0</span> tunl0</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>docker service 运行calico<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#https://docs.projectcalico.org/v3.9/getting-started/as-service</span></span><br><span class="line">source /etc/kubernetes/env.sh</span><br><span class="line">ETCD_ENDPOINTS=$&#123;ETCD_ENDPOINTS&#125;</span><br><span class="line">ETCD_CA_CERT_FILE=<span class="string">"/etc/etcd/ssl/ca.pem"</span></span><br><span class="line">ETCD_CERT_FILE=<span class="string">"/etc/etcd/ssl/etcd.pem"</span></span><br><span class="line">ETCD_KEY_FILE=<span class="string">".etc/etcd/ssl/etcd-key.pem"</span></span><br><span class="line">CALICO_NODENAME=<span class="string">""</span></span><br><span class="line">CALICO_NO_DEFAULT_POOLS=<span class="string">""</span></span><br><span class="line">CALICO_IP=<span class="string">""</span></span><br><span class="line">CALICO_IP6=<span class="string">""</span></span><br><span class="line">CALICO_AS=<span class="string">""</span></span><br><span class="line">CALICO_NETWORKING_BACKEND=bird</span><br></pre></td></tr></table></figure></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF&gt; calico-node.service </span><br><span class="line">[Unit]</span><br><span class="line"><span class="attribute">Description</span>=calico-node</span><br><span class="line"><span class="attribute">After</span>=docker.service</span><br><span class="line"><span class="attribute">Requires</span>=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line"><span class="attribute">EnvironmentFile</span>=/etc/calico/calico.env</span><br><span class="line"><span class="attribute">ExecStartPre</span>=-/usr/bin/docker rm -f calico-node</span><br><span class="line"><span class="attribute">ExecStart</span>=/usr/bin/docker <span class="builtin-name">run</span> <span class="attribute">--net</span>=host --privileged \</span><br><span class="line"> <span class="attribute">--name</span>=calico-node \</span><br><span class="line"> -e <span class="attribute">NODENAME</span>=<span class="variable">$&#123;CALICO_NODENAME&#125;</span> \</span><br><span class="line"> -e <span class="attribute">IP</span>=<span class="variable">$&#123;CALICO_IP&#125;</span> \</span><br><span class="line"> -e <span class="attribute">IP6</span>=<span class="variable">$&#123;CALICO_IP6&#125;</span> \</span><br><span class="line"> -e <span class="attribute">CALICO_NETWORKING_BACKEND</span>=<span class="variable">$&#123;CALICO_NETWORKING_BACKEND&#125;</span> \</span><br><span class="line"> -e <span class="attribute">AS</span>=<span class="variable">$&#123;CALICO_AS&#125;</span> \</span><br><span class="line"> -e <span class="attribute">NO_DEFAULT_POOLS</span>=<span class="variable">$&#123;CALICO_NO_DEFAULT_POOLS&#125;</span> \</span><br><span class="line"> -e <span class="attribute">ETCD_ENDPOINTS</span>=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> \</span><br><span class="line"> -e <span class="attribute">ETCD_CA_CERT_FILE</span>=<span class="variable">$&#123;ETCD_CA_CERT_FILE&#125;</span> \</span><br><span class="line"> -e <span class="attribute">ETCD_CERT_FILE</span>=<span class="variable">$&#123;ETCD_CERT_FILE&#125;</span> \</span><br><span class="line"> -e <span class="attribute">ETCD_KEY_FILE</span>=<span class="variable">$&#123;ETCD_KEY_FILE&#125;</span> \</span><br><span class="line"> -v /var/log/calico:/var/log/calico \</span><br><span class="line"> -v /run/docker/plugins:/run/docker/plugins \</span><br><span class="line"> -v /lib/modules:/lib/modules \</span><br><span class="line"> -v /var/run/calico:/var/run/calico \</span><br><span class="line"> calico/node:v3.9.2</span><br><span class="line"></span><br><span class="line"><span class="attribute">ExecStop</span>=-/usr/bin/docker stop calico-node</span><br><span class="line"></span><br><span class="line"><span class="attribute">Restart</span>=on-failure</span><br><span class="line"><span class="attribute">StartLimitBurst</span>=3</span><br><span class="line"><span class="attribute">StartLimitInterval</span>=60s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line"><span class="attribute">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>
<p>calicoctl<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#https://docs.projectcalico.org/master/getting-started/calicoctl/install</span></span><br><span class="line"><span class="comment">#calicoctl请github下载，官方在ubuntu 报错Segmentation fault</span></span><br><span class="line">cd /usr/local/k8s/bin</span><br><span class="line">wget https://github.com/projectcalico/calicoctl/releases/download/v3.9.2/calicoctl-linux-amd64 -o calicoctl </span><br><span class="line">chmod +x calicoctl </span><br><span class="line"></span><br><span class="line">mkdir /etc/calico</span><br><span class="line">cat <span class="variable">&lt;&lt;EOF&gt;</span> /etc/calico/calicoctl.cfg</span><br><span class="line"><span class="comment">#https://docs.projectcalico.org/master/getting-started/calicoctl/configure/</span></span><br><span class="line">apiVersion: projectcalico.org/v3</span><br><span class="line">kind: CalicoAPIConfig</span><br><span class="line">metadata:</span><br><span class="line">spec:</span><br><span class="line">  datastoreType: <span class="string">"etcdv3"</span></span><br><span class="line">  etcdEndpoints: <span class="string">"https://192.168.10.18:2379,https://192.168.10.20:2379,https://192.168.10.21:2379"</span></span><br><span class="line">  etcdKeyFile: <span class="string">"/etc/etcd/ssl/etcd-key.pem"</span></span><br><span class="line">  etcdCertFile: <span class="string">"/etc/etcd/ssl/etcd.pem"</span></span><br><span class="line">  etcdCACertFile: <span class="string">"/etc/etcd/ssl/ca.pem"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># calicoctl get node</span></span><br><span class="line">NAME     </span><br><span class="line">k8s-master01   </span><br><span class="line">k8s-master02</span><br><span class="line">k8s-master03</span><br><span class="line">k8s-node01</span><br><span class="line">k8s-node02</span><br><span class="line"></span><br><span class="line"><span class="comment">#  calicoctl node status</span></span><br><span class="line">Calico process is running.</span><br><span class="line"></span><br><span class="line">IPv4 BGP status</span><br><span class="line">+---------------+-------------------+-------+----------+-------------+</span><br><span class="line">|<span class="string"> PEER ADDRESS  </span>|<span class="string">     PEER TYPE     </span>|<span class="string"> STATE </span>|<span class="string">  SINCE   </span>|<span class="string">    INFO     </span>|</span><br><span class="line">+---------------+-------------------+-------+----------+-------------+</span><br><span class="line">|<span class="string"> 192.168.10.82 </span>|<span class="string"> node-to-node mesh </span>|<span class="string"> up    </span>|<span class="string"> 09:45:55 </span>|<span class="string"> Established </span>|</span><br><span class="line">|<span class="string"> 192.168.10.83 </span>|<span class="string"> node-to-node mesh </span>|<span class="string"> up    </span>|<span class="string"> 09:45:54 </span>|<span class="string"> Established </span>|</span><br><span class="line">|<span class="string"> 192.168.10.84 </span>|<span class="string"> node-to-node mesh </span>|<span class="string"> up    </span>|<span class="string"> 09:45:54 </span>|<span class="string"> Established </span>|</span><br><span class="line">|<span class="string"> 192.168.10.85 </span>|<span class="string"> node-to-node mesh </span>|<span class="string"> up    </span>|<span class="string"> 09:45:54 </span>|<span class="string"> Established </span>|</span><br><span class="line">+---------------+-------------------+-------+----------+-------------+</span><br><span class="line"></span><br><span class="line">IPv6 BGP status</span><br><span class="line">No IPv6 peers found.</span><br><span class="line"></span><br><span class="line"><span class="comment"># calicoctl get ippool -o wide</span></span><br><span class="line">NAME                  CIDR            NAT    IPIPMODE   VXLANMODE   DISABLED   SELECTOR   </span><br><span class="line">default-ipv4-ippool   10.244.0.0/16   true   Always     Never       false      all()</span><br></pre></td></tr></table></figure></p>
<h1 id="测试-my-nginx"><a href="#测试-my-nginx" class="headerlink" title="测试 my-nginx"></a>测试 my-nginx</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt; my-nginx.yaml &lt;&lt;EOF</span></span><br><span class="line"><span class="string"></span><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">my-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">my-nginx</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">my-nginx</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">my-nginx</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">daocloud.io/library/nginx:1.13.0-alpine</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">my-nginx</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">my-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">my-nginx</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">80</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># kubectl get pod -o wide</span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE   IP              NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">my-nginx<span class="number">-6487974967</span><span class="number">-49</span>tgj   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">72</span>s   <span class="number">10.244</span><span class="number">.40</span><span class="number">.70</span>    k8s-node01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">my-nginx<span class="number">-6487974967</span><span class="number">-75</span>pnt   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">72</span>s   <span class="number">10.244</span><span class="number">.42</span><span class="number">.198</span>   k8s-node02   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<p>检查服务IP和端口可达性<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl get svc my-nginx</span></span><br><span class="line">NAME      <span class="built_in"> TYPE </span>      CLUSTER-IP      EXTERNAL-IP   PORT(S)       AGE</span><br><span class="line">my-nginx   NodePort   10.110.21.241   &lt;none&gt;        83:9046/TCP   2m13s</span><br></pre></td></tr></table></figure></p>
<p>我们在任意节点访问server IP<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">ping</span> 10<span class="selector-class">.110</span><span class="selector-class">.21</span><span class="selector-class">.241</span></span><br></pre></td></tr></table></figure></p>
<h1 id="部署coredns"><a href="#部署coredns" class="headerlink" title="部署coredns"></a>部署coredns</h1><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/local/src/kubernetes/cluster/addons/dns/coredns/coredns.yaml.base coredns.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#更换镜像源 http://mirror.azure.cn/help/gcr-proxy-cache.html</span></span><br><span class="line">source /etc/kubernetes/env.sh</span><br><span class="line">sed -i <span class="string">"s#k8s.gcr.io#"</span><span class="variable">$GCR_MIRROR</span><span class="string">"#g"</span> coredns.yaml</span><br><span class="line">sed -i <span class="string">"s/__PILLAR__DNS__DOMAIN__/<span class="variable">$&#123;DNS_DOMAIN&#125;</span>/"</span> coredns.yaml</span><br><span class="line">sed -i <span class="string">"s/__PILLAR__DNS__SERVER__/<span class="variable">$&#123;DNS_SERVICE_IP&#125;</span>/"</span> coredns.yaml</span><br><span class="line">sed -i <span class="string">"s/__PILLAR__DNS__MEMORY__LIMIT__/150Mi/g"</span> coredns.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建 coredns</span></span><br><span class="line">kubectl create -f coredns.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#replicas默认1,可以修改多个</span></span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line"></span><br><span class="line"><span class="comment">#检查coredns状态</span></span><br><span class="line"><span class="comment"># kubectl get svc -nkube-system</span></span><br><span class="line">NAME      <span class="built_in"> TYPE </span>       CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE</span><br><span class="line">kube-dns   ClusterIP   10.96.0.10   &lt;none&gt;        53/UDP,53/TCP,9153/TCP   39s</span><br></pre></td></tr></table></figure>
<p>测试corsdns<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">cat&lt;&lt;EOF | kubectl apply -f -</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: busybox</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: busybox</span><br><span class="line">    image: busybox:1.28.3</span><br><span class="line">    command:</span><br><span class="line">      - sleep</span><br><span class="line">      - <span class="string">"3600"</span></span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get pod | grep busybox</span></span><br><span class="line">busybox          1/1     Running   0          2m43s</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl exec -ti busybox -- nslookup kubernetes</span></span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      kubernetes</span><br><span class="line">Address 1: 10.96.0.1 kubernetes.default.svc.cluster.local</span><br></pre></td></tr></table></figure></p>
<h1 id="部署coredns自动扩容"><a href="#部署coredns自动扩容" class="headerlink" title="部署coredns自动扩容"></a>部署coredns自动扩容</h1><p><a href="https://github.com/kubernetes-incubator/cluster-proportional-autoscaler/" target="_blank" rel="noopener">https://github.com/kubernetes-incubator/cluster-proportional-autoscaler/</a><br><a href="https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/dns-horizontal-autoscaler" target="_blank" rel="noopener">https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/dns-horizontal-autoscaler</a></p>
<h1 id="部署ingress-nginx"><a href="#部署ingress-nginx" class="headerlink" title="部署ingress-nginx"></a>部署ingress-nginx</h1><p><a href="https://github.com/kubernetes/ingress-nginx/blob/master/docs/deploy/index.md" target="_blank" rel="noopener">https://github.com/kubernetes/ingress-nginx/blob/master/docs/deploy/index.md</a><br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /etc/kubernetes/yaml/ingress-nginx</span><br><span class="line"><span class="keyword">cd</span> /etc/kubernetes/yaml/ingress-nginx</span><br><span class="line">http<span class="variable">s:</span>//raw.githubusercontent.<span class="keyword">com</span>/kubernetes/ingress-nginx/master/deploy/static/mandatory.yaml</span><br><span class="line">http<span class="variable">s:</span>//raw.githubusercontent.<span class="keyword">com</span>/kubernetes/ingress-nginx/master/deploy/static/provider/baremetal/service-nodeport.yaml</span><br><span class="line">sed -i <span class="string">'s/quay.io/quay.azk8s.cn/'</span> mandatory.yaml</span><br><span class="line">kubectl apply -<span class="keyword">f</span> .</span><br><span class="line"></span><br><span class="line">#kubectl <span class="built_in">get</span> pods --<span class="keyword">all</span>-namespaces -<span class="keyword">l</span> app.kubernetes.io/name=ingress-nginx --watch</span><br><span class="line">NAMESPACE       NAME                                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">ingress-nginx   nginx-ingress-controller-<span class="number">69969</span>b98db-shr6j   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">58</span><span class="keyword">m</span></span><br><span class="line"></span><br><span class="line"># kubectl <span class="built_in">get</span> svc -ningress-nginx</span><br><span class="line">NAME            TYPE       CLUSTER-IP    EXTERNAL-IP   PORT(S)                      AGE</span><br><span class="line">ingress-nginx   NodePort   <span class="number">10.98</span>.<span class="number">91.11</span>   <span class="symbol">&lt;none&gt;</span>        <span class="number">80</span>:<span class="number">32634</span>/TCP,<span class="number">443</span>:<span class="number">30871</span>/TCP   <span class="number">59</span><span class="keyword">m</span></span><br><span class="line"></span><br><span class="line">POD_NAMESPACE=ingress-nginx</span><br><span class="line">POD_NAME=$(kubectl <span class="built_in">get</span> pods -n $POD_NAMESPACE -<span class="keyword">l</span> app.kubernetes.io/name=ingress-nginx -<span class="keyword">o</span> jsonpath=<span class="string">'&#123;.items[0].metadata.name&#125;'</span>)</span><br><span class="line">kubectl exec -it $POD_NAME -n $POD_NAMESPACE -- /nginx-ingress-controller --<span class="keyword">version</span></span><br><span class="line"></span><br><span class="line">#curl <span class="number">10.98</span>.<span class="number">91.11</span>:<span class="number">443</span></span><br><span class="line"><span class="symbol">&lt;html&gt;</span></span><br><span class="line"><span class="symbol">&lt;head&gt;</span><span class="symbol">&lt;title&gt;</span><span class="number">404</span> Not Found&lt;/title&gt;&lt;/head&gt;</span><br><span class="line"><span class="symbol">&lt;body&gt;</span></span><br><span class="line"><span class="symbol">&lt;center&gt;</span><span class="symbol">&lt;h1&gt;</span><span class="number">404</span> Not Found&lt;/h1&gt;&lt;/<span class="keyword">center</span>&gt;</span><br><span class="line"><span class="symbol">&lt;hr&gt;</span><span class="symbol">&lt;center&gt;</span>openresty/<span class="number">1.15</span>.<span class="number">8.2</span>&lt;/<span class="keyword">center</span>&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<h1 id="部署dashboard"><a href="#部署dashboard" class="headerlink" title="部署dashboard"></a>部署dashboard</h1><p>先前已解压的 kubernetes-server-linux-amd64.tar.gz<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p <span class="meta-keyword">/etc/</span>kubernetes/dashboard</span><br><span class="line">cd <span class="meta-keyword">/etc/</span>kubernetes/dashboard</span><br><span class="line">cp -r <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/src/</span><span class="meta-keyword">/kubernetes/</span>cluster<span class="meta-keyword">/addons/</span>dashboard .</span><br></pre></td></tr></table></figure></p>
<p>service添加NodePort，使外界可以通过地址 NodeIP:NodePort 访问 dashboard<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">apiVersion</span>: v1</span><br><span class="line"><span class="attribute">kind</span>: Service</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">  <span class="attribute">name</span>: kubernetes-dashboard</span><br><span class="line">  <span class="attribute">namespace</span>: kube-system</span><br><span class="line">  <span class="attribute">labels</span>:</span><br><span class="line">    <span class="attribute">k8s-app</span>: kubernetes-dashboard</span><br><span class="line">    kubernetes.io/<span class="attribute">cluster-service</span>: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/<span class="attribute">mode</span>: Reconcile</span><br><span class="line"><span class="attribute">spec</span>:</span><br><span class="line">  <span class="attribute">type</span>: NodePort #增加此行</span><br><span class="line">  <span class="attribute">selector</span>:</span><br><span class="line">    <span class="attribute">k8s-app</span>: kubernetes-dashboard</span><br><span class="line">  <span class="attribute">ports</span>:</span><br><span class="line">  - <span class="attribute">port</span>: <span class="number">443</span></span><br><span class="line">    <span class="attribute">targetPort</span>: <span class="number">8443</span></span><br><span class="line">    <span class="attribute">nodePort</span>: <span class="number">30001</span> #指定端口</span><br></pre></td></tr></table></figure></p>
<p>更换微软镜像源、执行<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ls *.yaml</span></span><br><span class="line">dashboard-configmap.yaml  dashboard-controller.yaml  dashboard-rbac.yaml  dashboard-secret.yaml  dashboard-service.yaml</span><br><span class="line"><span class="meta">#</span><span class="bash"> sed -i <span class="string">"s#k8s.gcr.io#<span class="variable">$GCR_MIRROR</span>#"</span> dashboard-controller.yaml </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> kubectl apply -f  .</span></span><br></pre></td></tr></table></figure></p>
<p>查看pod 、service<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -o wide -nkube-system | grep dashboard</span></span><br><span class="line">kubernetes-dashboard-64ffdff795-vgwrg   1/1     Running   0          77s   10.244.40.74   k8s-node01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get services kubernetes-dashboard -n kube-system</span></span><br><span class="line">NAME                  <span class="built_in"> TYPE </span>      CLUSTER-IP      EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">kubernetes-dashboard   NodePort   10.101.91.150   &lt;none&gt;        443:30001/TCP   2m15s</span><br></pre></td></tr></table></figure></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span> <span class="string">&gt; admin.yaml</span></span><br><span class="line"><span class="string"></span><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">rbac.authorization.kubernetes.io/autoupdate:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line">    <span class="string">kubernetes.io/cluster-service:</span> <span class="string">"true"</span></span><br><span class="line">    <span class="string">addonmanager.kubernetes.io/mode:</span> <span class="string">Reconcile</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="bullet">-f</span> <span class="string">admin.yaml</span> </span><br><span class="line"><span class="string">admin_token=$(kubectl</span> <span class="string">get</span> <span class="string">secret</span> <span class="bullet">-n</span> <span class="string">kube-system|grep</span> <span class="string">admin-token|awk</span> <span class="string">'&#123;print $1&#125;'</span><span class="string">)</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">secret</span> <span class="string">$admin_token</span> <span class="bullet">-o</span> <span class="string">jsonpath=&#123;.data.token&#125;</span> <span class="bullet">-n</span> <span class="string">kube-system</span> <span class="string">|base64</span> <span class="bullet">-d</span></span><br><span class="line"><span class="string">eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3N.....</span></span><br></pre></td></tr></table></figure>
<p>浏览器访问kube-apiserver<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl cluster-info</span><br><span class="line">Kubernetes master <span class="keyword">is</span> running at http<span class="variable">s:</span>//<span class="number">192.168</span>.<span class="number">10.80</span>:<span class="number">8443</span></span><br><span class="line">CoreDNS <span class="keyword">is</span> running at http<span class="variable">s:</span>//<span class="number">192.168</span>.<span class="number">10.80</span>:<span class="number">8443</span>/api/v1/namespaces/kube-<span class="built_in">system</span>/services/kube-dn<span class="variable">s:dns</span>/proxy</span><br><span class="line">kubernetes-dashboard <span class="keyword">is</span> running at http<span class="variable">s:</span>//<span class="number">192.168</span>.<span class="number">10.80</span>:<span class="number">8443</span>/api/v1/namespaces/kube-<span class="built_in">system</span>/services/http<span class="variable">s:kubernetes</span>-dashboard:/proxy</span><br></pre></td></tr></table></figure></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; dashboard.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"dashboard"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"Guangzhou"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"Guangzhou"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">/etc/kubernetes/ssl/</span><br><span class="line">cfssl gencert <span class="attribute">-ca</span>=ca.pem \</span><br><span class="line">  <span class="attribute">-ca-key</span>=ca-key.pem \</span><br><span class="line">  <span class="attribute">-config</span>=ca-config.json \</span><br><span class="line">  <span class="attribute">-profile</span>=kubernetes dashboard.json | cfssljson -bare dashboard</span><br><span class="line"></span><br><span class="line">cp dashboard.pem /etc/kubernetes/ssl/dashboard.crt</span><br><span class="line">cp dashboard-key.pem /etc/kubernetes/ssl/dashboard.key</span><br><span class="line"></span><br><span class="line"><span class="comment">#create secret</span></span><br><span class="line">cd /etc/kubernetes/ssl</span><br><span class="line">kubectl create<span class="built_in"> secret </span>generic kubernetes-dashboard-certs <span class="attribute">--from-file</span>=<span class="string">"dashboard.crt,dashboard.key"</span> -n kube-system</span><br><span class="line">kubectl <span class="builtin-name">get</span><span class="built_in"> secret </span>-n kube-system | grep dashboard</span><br><span class="line"></span><br><span class="line"><span class="comment">#导出证书至windows</span></span><br><span class="line">cd /opt/k8s/ssl/</span><br><span class="line">openssl pkcs12 -<span class="builtin-name">export</span> -certfile ca.pem -in dashboard.pem -inkey dashboard-key.pem -out dashboard.pfx</span><br><span class="line">openssl pkcs12 -<span class="builtin-name">export</span> -in ca.pem -inkey ca-key.pem  -out dashboard.pfx</span><br><span class="line"></span><br><span class="line">openssl pkcs12 -<span class="builtin-name">export</span> -out dashboard.pfx -inkey dashboard-key.pem -in dashboard.pem -certfile ca.pem</span><br><span class="line">openssl pkcs12 -<span class="builtin-name">export</span> -out admin.pfx -inkey admin-key.pem -in admin.pem -certfile ca.pem</span><br></pre></td></tr></table></figure>
<ol>
<li>kubernetes-dashboard service 暴露了 NodePort，可以使用 <a href="https://NodeIP:NodePort" target="_blank" rel="noopener">https://NodeIP:NodePort</a> 地址访问 dashboard</li>
<li>通过 kube-apiserver 访问 dashboard</li>
<li>通过 kubectl proxy 访问 dashboard</li>
</ol>
<h1 id="gcr-quay镜像代理"><a href="#gcr-quay镜像代理" class="headerlink" title="gcr quay镜像代理"></a>gcr quay镜像代理</h1><p><a href="http://mirror.azure.cn/help/gcr-proxy-cache.html" target="_blank" rel="noopener">http://mirror.azure.cn/help/gcr-proxy-cache.html</a><br><a href="http://mirror.azure.cn/help/quay-proxy-cache.html" target="_blank" rel="noopener">http://mirror.azure.cn/help/quay-proxy-cache.html</a></p>
<p>gcr.azk8s.cn/google_containers/<br>registry.cn-hangzhou.aliyuncs.com/google_containers/</p>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a href="http://www.debugger.wiki/article/html/1559106039872285" target="_blank" rel="noopener">http://www.debugger.wiki/article/html/1559106039872285</a><br><a href="https://github.com/opsnull/follow-me-install-kubernetes-cluster" target="_blank" rel="noopener">https://github.com/opsnull/follow-me-install-kubernetes-cluster</a></p>


                <hr>

                

                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/kubernets-taint/" data-toggle="tooltip" data-placement="top" title="kubernets 污点和亲和性">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/nginx-allows-multiple-domain-cors/" data-toggle="tooltip" data-placement="top" title="Nginx 允许多个域名跨域访问">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                

                

            </div>
    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->

            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="https://jaminzhang.github.io" target="_blank">JAMIN ZHANG</a></li>
                    
                        <li><a href="#" target="_blank">It helps SEO</a></li>
                    
                </ul>
                
            </div>

        </div>
    </div>
</article>







<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                

                

                

                
                    <li>
                        <a target="_blank"  href="https://github.com/sundayle">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; SundayLe 2020 
                    <br>
                    Theme by <a href="http://huangxuan.me">Hux</a> 
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span>
                    Ported by <a href="https://github.com/Kaijun/hexo-theme-huxblog">Kaijun</a>
            <!-- 
                    Ported by <a href="http://blog.kaijun.rocks">Kaijun</a> | 
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=kaijun&repo=hexo-theme-huxblog&type=star&count=true" >
                    </iframe>
            -->
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
     async("https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->


<script>
    // dynamic User by Hux
    var _gaId = 'UA-70699634-1';
    var _gaDomain = 'auto';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>




<!-- Baidu Tongji -->


<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog (selector) {
        var P = $('div.post-container'),a,n,t,l,i,c;
        a = P.find('h1,h2,h3,h4,h5,h6');
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#"+$(this).prop('id');
            t = $(this).text();
            c = $('<a href="'+i+'" rel="nofollow">'+t+'</a>');
            l = $('<li class="'+n+'_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;    
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function(e){
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>





<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
