<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Linux运维笔记">
    <meta name="keyword"  content="sunday,sundayhk,sundayle,sunday博客,Linxu,运维">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
          MySQL 5.7 基于GTID及多线程主从复制 - Sunday博客 | Sunday Blog
        
    </title>

    <link rel="canonical" href="http://www.sundayle.com/mysql-gtid-relication/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Sunday</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/archives/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    
<!-- Image to hack wechat -->
<!-- <img src="http://www.sundayle.com/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="{{ site.baseurl }}/{% if page.header-img %}{{ page.header-img }}{% else %}{{ site.header-img }}{% endif %}" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        background-image: url('/img/home-bg.jpg')
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                          <a class="tag" href="/tags/#mysql" title="mysql">mysql</a>
                        
                          <a class="tag" href="/tags/#主从复制" title="主从复制">主从复制</a>
                        
                    </div>
                    <h1>MySQL 5.7 基于GTID及多线程主从复制</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        Posted by Sunday on
                        2018-04-20
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <h1 id="MySQL主从同步原理"><a href="#MySQL主从同步原理" class="headerlink" title="MySQL主从同步原理"></a>MySQL主从同步原理</h1><p>MySQL主从同步是在MySQL主从复制(Master-Slave Replication)基础上实现的，通过设置在Master MySQL上的binlog(使其处于打开状态)，Slave MySQL上通过一个I/O线程从Master MySQL上读取binlog，然后传输到Slave MySQL的中继日志中，然后Slave MySQL的SQL线程从中继日志中读取中继日志，然后应用到Slave MySQL的数据库中。这样实现了主从数据同步功能。</p>
<h1 id="MySQL中主从复制的优点"><a href="#MySQL中主从复制的优点" class="headerlink" title="MySQL中主从复制的优点"></a>MySQL中主从复制的优点</h1><ul>
<li><p>横向扩展解决方案<br>在多个从库之间扩展负载以提高性能。在这种环境中，所有写入和更新在主库上进行。但是，读取可能发生在一个或多个从库上。该模型可以提高写入的性能（由于主库专用于更新），同时在多个从库上读取，可以大大提高读取速度。</p>
</li>
<li><p>数据安全性<br>由于主库数据被复制到从库，从库可以暂停复制过程，可以在从库上运行备份服务，而不会破坏对应的主库数据。</p>
</li>
<li><p>分析<br>可以在主库上创建实时数据，而信息分析可以在从库上进行，而不会影响主服务器的性能。</p>
</li>
</ul>
<h1 id="Gtid概念"><a href="#Gtid概念" class="headerlink" title="Gtid概念"></a>Gtid概念</h1><p>从 MySQL 5.6.5 开始新增了一种基于 GTID 的复制方式。通过 GTID保证了每个在主库上提交的事务在集群中有一个唯一的ID。这种方式强化了数据库的主备一致性，故障恢复以及容错能力。<br>在原来基于二进制日志的复制中，从库需要告知主库要从哪个偏移量进行增量同步，如果指定错误会造成数据的遗漏，从而造成数据的不一致。借助GTID，在发生主备切换的情况下，MySQL的其它从库可以自动在新主库上找到正确的复制位置，这大大简化了复杂复制拓扑下集群的维护，也减少了人为设置复制位置发生误操作的风险。另外，基于GTID的复制可以忽略已经执行过的事务，减少了数据发生不一致的风险。</p>
<h2 id="什么是Gitd"><a href="#什么是Gitd" class="headerlink" title="什么是Gitd"></a>什么是Gitd</h2><p>GTID (Global Transaction ID) 是对于一个已提交事务的编号，并且是一个全局唯一的编号。 G<strong>TID 实际上 是由<br>UUID+TID 组成的。其中 UUID 是一个 MySQL 实例的唯一标识。TID代表了该实例上已经提交的事务数量，并且随着事务提交单调递增</strong>。<br>下面是一个GTID的具体形式：3E11FA47-71CA-11E1-9E33-C80AA9429562:23，冒号分割前边为uuid，后边为TID。</p>
<p>GTID 集合可以包含来自多个 MySQL 实例的事务，它们之间用逗号分隔。</p>
<p>如果来自同一MySQL实例的事务序号有多个范围区间，各组范围之间用冒号分隔。例如： e6954592-8dba-11e6-af0e-fa163e1cf111:1-5:11-18,e6954592-8dba-11e6-af0e-fa163e1cf3f2:1-27 可以使用show master status实时查看当前事务执行数</p>
<h2 id="Gtid的作用"><a href="#Gtid的作用" class="headerlink" title="Gtid的作用"></a>Gtid的作用</h2><p>Gtid采用了新的复制协议，旧协议是，首先从服务器上在一个特定的偏移量位置连接到主服务器上一个给定的二进制日志文件，然后主服务器再从给定的连接点开始发送所有的事件。<br>新协议有所不同，支持以全局统一事务ID (GTID)为基础的复制。当在主库上提交事务或者被从库应用时，可以定位和追踪每一个事务。GTID复制是全部以事务为基础，使得检查主从一致性变得非常简单。如果所有主库上提交的事务也同样提交到从库上，一致性就得到了保证。</p>
<h2 id="Gtid的工作原理"><a href="#Gtid的工作原理" class="headerlink" title="Gtid的工作原理"></a>Gtid的工作原理</h2><p>①当一个事务在主库端执行并提交时，产生GTID，一同记录到binlog日志中。<br>②binlog传输到slave,并存储到slave的relaylog后，读取这个GTID的这个值设置gtid_next变量，即告诉Slave，下一个要执行的GTID值。<br>③sql线程从relay log中获取GTID，然后对比slave端的binlog是否有该GTID。<br>④如果有记录，说明该GTID的事务已经执行，slave会忽略。<br>⑤如果没有记录，slave就会执行该GTID事务，并记录该GTID到自身的binlog，<br>在读取执行事务前会先检查其他session持有该GTID，确保不被重复执行。<br>⑥在解析过程中会判断是否有主键，如果没有就用二级索引，如果没有就用全部扫描。</p>
<h1 id="操作环境"><a href="#操作环境" class="headerlink" title="操作环境"></a>操作环境</h1><p>系统：CentOS 7<br>数据库：Percona MySQL 5.7<br>主库：192.168.11.31<br>从库：192.168.11.32</p>
<h1 id="主库配置"><a href="#主库配置" class="headerlink" title="主库配置"></a>主库配置</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">datadir</span>=/data/mysql/<span class="number">3306</span></span><br><span class="line"><span class="attr">socket</span>=/tmp/mysql.sock</span><br><span class="line"><span class="attr">symbolic-links</span>=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server_id</span>=<span class="number">31</span>                              #服务器ID</span><br><span class="line"><span class="attr">log-bin</span>=master-bin                        #二进制日志文件名</span><br><span class="line"><span class="attr">binlog_format</span> = row                       #强烈建议，其他格式可能造成数据不一致</span><br><span class="line"><span class="attr">log-slave-updates</span> = <span class="number">1</span>                     #是否记录从服务器同步数据动作</span><br><span class="line"><span class="attr">gtid-mode</span> = <span class="literal">on</span>                            #启用gitd功能</span><br><span class="line"><span class="attr">enforce-gtid-consistency</span> = <span class="number">1</span>              #开启强制GTID一致性</span><br><span class="line"><span class="attr">master-info-repository</span> = TABLE            #记录IO线程读取已经读取到的master binlog位置，用于slave宕机后IO线程根据文件中的POS点重新拉取binlog日志  </span><br><span class="line"><span class="attr">relay-log-info-repository</span> = TABLE         #记录SQL线程读取Master binlog的位置，用于Slave 宕机后根据文件中记录的pos点恢复Sql线程</span><br><span class="line"><span class="attr">sync-master-info</span> = <span class="number">1</span>                      #启用确保无信息丢失；任何一个事务提交后, 将二进制日志的文件名及事件位置记录到文件中</span><br><span class="line"><span class="attr">slave-parallel-workers</span> = <span class="number">2</span>                #设定从服务器的复制线程数；<span class="number">0</span>表示关闭多线程复制功能</span><br><span class="line"><span class="attr">binlog-checksum</span> = CRC32                   #设置binlog校验算法（循环冗余校验码）</span><br><span class="line"><span class="attr">master-verify-checksum</span> = <span class="number">1</span>                #设置主服务器是否校验</span><br><span class="line"><span class="attr">slave-sql-verify-checksum</span> = <span class="number">1</span>             #设置从服务器是否校验</span><br><span class="line"><span class="attr">binlog-rows-query-log_events</span> = <span class="number">1</span>          #用于在二进制日志记录事件相关的信息，可降低故障排除的复杂度</span><br><span class="line"><span class="attr">sync_binlog</span> = <span class="number">1</span>                           #保证master crash safe，该参数必须设置为<span class="number">1</span></span><br><span class="line"><span class="attr">innodb_flush_log_at_trx_commit</span> = <span class="number">1</span>        #保证master crash safe，该参数必须设置为<span class="number">1</span></span><br></pre></td></tr></table></figure>
<h1 id="从库配置"><a href="#从库配置" class="headerlink" title="从库配置"></a>从库配置</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">server_id</span> = <span class="number">32</span></span><br><span class="line"><span class="attr">log-bin</span>=mysql-bin</span><br><span class="line"><span class="attr">binlog_format</span> = row</span><br><span class="line"><span class="attr">gtid-mode</span> = <span class="literal">on</span></span><br><span class="line"><span class="attr">enforce-gtid-consistency</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">master-info-repository</span> = TABLE</span><br><span class="line"><span class="attr">relay-log-info-repository</span> = TABLE</span><br><span class="line"><span class="attr">sync-master-info</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">slave-parallel-workers</span> = <span class="number">4</span></span><br><span class="line"><span class="attr">binlog-checksum</span> = CRC32</span><br><span class="line"><span class="attr">master-verify-checksum</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">slave-sql-verify-checksum</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">binlog-rows-query-log_events</span> = <span class="number">1</span></span><br><span class="line"><span class="comment">#sync_binlog = 1</span></span><br><span class="line"><span class="comment">#innodb_flush_log_at_trx_commit = 1</span></span><br><span class="line"><span class="attr">log-slave-updates</span> = <span class="number">0</span> # crash safe slave <span class="number">5.6</span>版本需要开启</span><br><span class="line"><span class="attr">relay_log_recovery</span> = <span class="number">1</span>  # crash safe slave</span><br><span class="line"><span class="attr">read_only</span>=<span class="literal">on</span>        #设置一般用户为只读模式</span><br><span class="line"><span class="attr">super_read_only</span>=<span class="literal">on</span>       #设置super（root）用户为只读模式</span><br><span class="line"><span class="comment">#tx_read_only=on     #设置事务为只读模式</span></span><br></pre></td></tr></table></figure>
<h1 id="主库权限设置"><a href="#主库权限设置" class="headerlink" title="主库权限设置"></a>主库权限设置</h1><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">mysql</span> &gt; <span class="selector-tag">grant</span> <span class="selector-tag">replication</span> <span class="selector-tag">slave</span> <span class="selector-tag">on</span> *.* <span class="selector-tag">to</span> <span class="selector-tag">slave</span>@'<span class="keyword">192</span>.<span class="keyword">168</span>.<span class="keyword">11</span>.<span class="keyword">32</span>' identified by <span class="string">'slave123'</span>;</span><br><span class="line"><span class="selector-tag">mysql</span> &gt; <span class="selector-tag">flush</span> <span class="selector-tag">privileges</span>;</span><br></pre></td></tr></table></figure>
<h1 id="自动同步连接主库-方法一"><a href="#自动同步连接主库-方法一" class="headerlink" title="自动同步连接主库(方法一)"></a>自动同步连接主库(方法一)</h1><p>适用于master也是新建不久的情况。<br>1、如果你的master所有的binlog还在。可以安装slave，slave直接change master to到master端。<br>2、原理是直接获取master所有的GTID并执行。<br>3、优点：简单方便。<br>4、缺点：如果binlog太多，数据完全同步需要时间较长，并且master一开始就启用了GTUD。<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">change master to master_host='<span class="number">192.168</span><span class="number">.11</span><span class="number">.31</span>',master_user='slave',master_password='slave123',master_port=<span class="number">3306</span>,master_auto_position=<span class="number">1</span></span><br><span class="line">#master_auto_position=<span class="number">1</span> 从库自动找同步点</span><br></pre></td></tr></table></figure></p>
<h1 id="备份导入连接主库-方法二"><a href="#备份导入连接主库-方法二" class="headerlink" title="备份导入连接主库(方法二)"></a>备份导入连接主库(方法二)</h1><p>1、Xtrabackup_binlog_info文件中，包含global.gtid_purged=’XXXXXX:XXXX’的信息。<br>2、然后到slave去手工的 SET @@GLOBAL.GTID_PURGED=’XXXXXX:XXXX’。<br>3、恢复备份，开启change master to 命令。</p>
<h1 id="备份导入连接主库-方法三"><a href="#备份导入连接主库-方法三" class="headerlink" title="备份导入连接主库(方法三)"></a>备份导入连接主库(方法三)</h1><p>适用于拥有较大数据的情况。（推荐）<br>1、通过master或者其他slave的备份搭建新的slave。<br>2、原理：获取master的数据和这些数据对应的GTID范围，然后通过slave设置master_auto_position=1,自动同步，跳过备份包含的gtid。<br>3、缺点：相对来说有点复杂。</p>
<h2 id="将主库设为只读模式"><a href="#将主库设为只读模式" class="headerlink" title="将主库设为只读模式"></a>将主库设为只读模式</h2><p>注：生产环境会影响不能写入数据<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; flush tables <span class="keyword">with</span> <span class="built_in">read</span> lock;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">set</span> <span class="keyword">global</span> read_only=<span class="keyword">on</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<h2 id="主库使用mysqldump导出"><a href="#主库使用mysqldump导出" class="headerlink" title="主库使用mysqldump导出"></a>主库使用mysqldump导出</h2><p>可以同时导出多个数据库，如music、record<br><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">mysqldump</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">databases</span> &lt;<span class="comment">数据库名</span>&gt;  <span class="literal">-</span><span class="literal">-</span><span class="comment">single</span><span class="literal">-</span><span class="comment">transaction</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">order</span><span class="literal">-</span><span class="comment">by</span><span class="literal">-</span><span class="comment">primary</span> <span class="literal">-</span><span class="comment">r</span> &lt;<span class="comment">备份文件名</span>&gt; <span class="literal">-</span><span class="literal">-</span><span class="comment">routines</span> <span class="literal">-</span><span class="comment">h</span>&lt;<span class="comment">服务器地址</span>&gt;  <span class="literal">-</span><span class="comment">P</span>&lt;<span class="comment">端口号</span>&gt; <span class="literal">-</span><span class="comment">u</span>&lt;<span class="comment">用户名</span>&gt; <span class="literal">-</span><span class="comment">p</span>&lt;<span class="comment">密码</span>&gt;</span><br><span class="line"><span class="comment">mysqldump</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">default</span><span class="literal">-</span><span class="comment">character</span><span class="literal">-</span><span class="comment">set=utf8mb4</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">single</span><span class="literal">-</span><span class="comment">transaction</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">triggers</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">routines</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">events</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">hex</span><span class="literal">-</span><span class="comment">blob</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">databases</span> <span class="comment">muisc</span> <span class="comment">record</span> &gt; <span class="comment">music_record</span><span class="string">.</span><span class="comment">sql</span></span><br></pre></td></tr></table></figure></p>
<p>记录GTID_PURGED<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grep -r <span class="string">"GLOBAL.GTID_PURGED"</span> music_record.sql</span><br><span class="line"><span class="builtin-name">SET</span> @@GLOBAL.<span class="attribute">GTID_PURGED</span>=<span class="string">'3cdb9ce6-0d7e-11e8-abe4-001517b5a5f0:1-698887'</span>;</span><br></pre></td></tr></table></figure></p>
<p>[!NOTE]<br>mysql服务器内置的库包括mysql库和test库不需要导出。</p>
<h2 id="将主库设为可读写模式"><a href="#将主库设为可读写模式" class="headerlink" title="将主库设为可读写模式"></a>将主库设为可读写模式</h2><p>数据库导出完成后将主库重新设为可读写模式。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> <span class="built_in">set</span> global read_only=off;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> unlock tables;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="从库数据导入"><a href="#从库数据导入" class="headerlink" title="从库数据导入"></a>从库数据导入</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#mysql&gt; create database `music`;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#mysql -u root -p muisc &lt; /root/music.sql</span></span></span><br><span class="line">mysql -u root -p &lt; /root/music_record.sql </span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> reset slave all;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> reset master;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SET @@GLOBAL.GTID_PURGED=<span class="string">'3cdb9ce6-0d7e-11e8-abe4-001517b5a5f0:1-698887'</span>;</span></span><br></pre></td></tr></table></figure>
<h2 id="从库连接主库"><a href="#从库连接主库" class="headerlink" title="从库连接主库"></a>从库连接主库</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">change</span> <span class="keyword">master</span> <span class="keyword">to</span> master_host=<span class="string">'192.168.11.31'</span>,master_user=<span class="string">'slave'</span>,master_password=<span class="string">'slave123'</span>,master_port=<span class="number">3306</span>,master_auto_position=<span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<h1 id="从库启动复制线程"><a href="#从库启动复制线程" class="headerlink" title="从库启动复制线程"></a>从库启动复制线程</h1><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="literal">start</span> <span class="literal">slave</span>;</span><br></pre></td></tr></table></figure>
<h1 id="从库查看复制状态"><a href="#从库查看复制状态" class="headerlink" title="从库查看复制状态"></a>从库查看复制状态</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status\G;</span><br><span class="line">*************************** <span class="number">1.</span> row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line">                  Master_Host: <span class="number">192.168</span><span class="number">.11</span><span class="number">.31</span></span><br><span class="line">                  Master_User: slave</span><br><span class="line">                  Master_Port: <span class="number">3306</span></span><br><span class="line">                Connect_Retry: <span class="number">60</span></span><br><span class="line">              Master_Log_File: master-bin<span class="number">.000002</span></span><br><span class="line">          Read_Master_Log_Pos: <span class="number">149375983</span></span><br><span class="line">               Relay_Log_File: db2-relay-bin<span class="number">.000002</span></span><br><span class="line">                Relay_Log_Pos: <span class="number">321</span></span><br><span class="line">        Relay_Master_Log_File: master-bin<span class="number">.000002</span></span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: <span class="number">0</span></span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: <span class="number">0</span></span><br><span class="line">          Exec_Master_Log_Pos: <span class="number">149375983</span></span><br><span class="line">              Relay_Log_Space: <span class="number">526</span></span><br><span class="line">              Until_Condition: <span class="keyword">None</span></span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: <span class="number">0</span></span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: <span class="number">0</span></span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: <span class="number">0</span></span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: <span class="number">0</span></span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: <span class="number">31</span></span><br><span class="line">                  Master_UUID: <span class="number">834449</span>ff<span class="number">-4487</span><span class="number">-11e8</span><span class="number">-8</span>b27<span class="number">-000</span>c294b06ca</span><br><span class="line">             Master_Info_File: mysql.slave_master_info</span><br><span class="line">                    SQL_Delay: <span class="number">0</span></span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting <span class="keyword">for</span> more updates</span><br><span class="line">           Master_Retry_Count: <span class="number">86400</span></span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: </span><br><span class="line">            Executed_Gtid_Set: </span><br><span class="line">                Auto_Position: <span class="number">0</span></span><br><span class="line">         Replicate_Rewrite_DB: </span><br><span class="line">                 Channel_Name: </span><br><span class="line">           Master_TLS_Version: </span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">ERROR: </span><br><span class="line">No query specified</span><br></pre></td></tr></table></figure>
<p>检查主从复制通信状态</p>
<p>Slave_IO_State #从站的当前状态<br>Slave_IO_Running： Yes #读取主程序二进制日志的I/O线程是否正在运行<br>Slave_SQL_Running： Yes #执行读取主服务器中二进制日志事件的SQL线程是否正在运行。与I/O线程一样<br>Seconds_Behind_Master #是否为0，0就是已经同步了</p>
<p>如果再次查询状态仍然 发现Slave_IO_Running 或者Slave_SQL_Running 不同时为YES,尝试执行<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> stop slave;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> reset slave;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> start slave;</span></span><br></pre></td></tr></table></figure></p>
<h1 id="主库查看状态"><a href="#主库查看状态" class="headerlink" title="主库查看状态"></a>主库查看状态</h1><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show master status;</span><br><span class="line">+-------------------+-----------+--------------+------------------+--------------------------------------------+</span><br><span class="line"><span class="params">| File              |</span> Position  <span class="params">| Binlog_Do_DB |</span> Binlog_Ignore_DB <span class="params">| Executed_Gtid_Set                          |</span></span><br><span class="line">+-------------------+-----------+--------------+------------------+--------------------------------------------+</span><br><span class="line"><span class="params">| master-bin.000002 |</span> <span class="number">149375983</span> <span class="params">|              |</span>                  <span class="params">| 834449ff-4487-11e8-8b27-000c294b06ca:1-254 |</span></span><br><span class="line">+-------------------+-----------+--------------+------------------+--------------------------------------------+</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> set (<span class="number">0</span>.<span class="number">00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show slave hosts;</span><br><span class="line">+-----------+------+------+-----------+--------------------------------------+</span><br><span class="line"><span class="params">| Server_id |</span> Host <span class="params">| Port |</span> Master_id <span class="params">| Slave_UUID                           |</span></span><br><span class="line">+-----------+------+------+-----------+--------------------------------------+</span><br><span class="line"><span class="params">|        32 |</span>      <span class="params">| 3306 |</span>        <span class="number">31</span> <span class="params">| 68303133-4489-11e8-84e9-000c293eaee6 |</span></span><br><span class="line">+-----------+------+------+-----------+--------------------------------------+</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> set (<span class="number">0</span>.<span class="number">00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show global variables like <span class="string">'%gtid%'</span>;</span><br><span class="line">+----------------------------------+--------------------------------------------+</span><br><span class="line"><span class="params">| Variable_name                    |</span> Value                                      <span class="params">|</span></span><br><span class="line"><span class="params">+----------------------------------+--------------------------------------------+</span></span><br><span class="line"><span class="params">|</span> binlog_gtid_simple_recovery      <span class="params">| ON                                         |</span></span><br><span class="line"><span class="params">| enforce_gtid_consistency         |</span> ON                                         <span class="params">|</span></span><br><span class="line"><span class="params">|</span> gtid_executed                    <span class="params">| 834449ff-4487-11e8-8b27-000c294b06ca:1-255 |</span></span><br><span class="line"><span class="params">| gtid_executed_compression_period |</span> <span class="number">1000</span>                                       <span class="params">|</span></span><br><span class="line"><span class="params">|</span> gtid_mode                        <span class="params">| ON                                         |</span></span><br><span class="line"><span class="params">| gtid_owned                       |</span>                                            <span class="params">|</span></span><br><span class="line"><span class="params">|</span> gtid_purged                      <span class="params">|                                            |</span></span><br><span class="line"><span class="params">| session_track_gtids              |</span> OFF                                        <span class="params">|</span></span><br><span class="line"><span class="params">+----------------------------------+--------------------------------------------+</span></span><br><span class="line"><span class="params">8 rows <span class="keyword">in</span> set (0.00 sec)</span></span><br></pre></td></tr></table></figure>
<h1 id="其他命令"><a href="#其他命令" class="headerlink" title="其他命令"></a>其他命令</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show binlog events;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show binlog events <span class="keyword">in</span> <span class="string">'master-bin.000001'</span>;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show master logs;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show processlist</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show full processlist;</span></span><br></pre></td></tr></table></figure>
<h1 id="GTID与crash-safe-slave"><a href="#GTID与crash-safe-slave" class="headerlink" title="GTID与crash safe slave"></a>GTID与crash safe slave</h1><p>查看错误<br>mysql&gt; select * from performance_schema.replication_applier_status_by_worker where LAST_ERROR_NUMBER=1007\G;</p>
<p><a href="https://docs.azure.cn/zh-cn/mysql/mysql-database-data-replication" target="_blank" rel="noopener">https://docs.azure.cn/zh-cn/mysql/mysql-database-data-replication</a><br><a href="https://segmentfault.com/a/1190000010362745#articleHeader1" target="_blank" rel="noopener">GTID原理和一些问题解答</a><br><a href="http://www.cnblogs.com/zhoujinyi/p/5704567.html" target="_blank" rel="noopener">MySQL 5.7 Replication 相关新功能说明</a></p>


                <hr>

                

                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/mysql-gtid-error-1062/" data-toggle="tooltip" data-placement="top" title="Mysql 5.7 gtid主从复制错误处理">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/mysqld-multi/" data-toggle="tooltip" data-placement="top" title="MySQL 多实例配置">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                

                

            </div>
    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->

            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#mysql" title="mysql">mysql</a>
                        
                          <a class="tag" href="/tags/#主从复制" title="主从复制">主从复制</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="https://jaminzhang.github.io" target="_blank">JAMIN ZHANG</a></li>
                    
                        <li><a href="#" target="_blank">It helps SEO</a></li>
                    
                </ul>
                
            </div>

        </div>
    </div>
</article>







<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                

                

                

                
                    <li>
                        <a target="_blank"  href="https://github.com/sundayle">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Sunday 2018 
                    <br>
                    Theme by <a href="http://huangxuan.me">Hux</a> 
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span>
                    Ported by <a href="https://github.com/Kaijun/hexo-theme-huxblog">Kaijun</a>
            <!-- 
                    Ported by <a href="http://blog.kaijun.rocks">Kaijun</a> | 
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=kaijun&repo=hexo-theme-huxblog&type=star&count=true" >
                    </iframe>
            -->
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->




<!-- Baidu Tongji -->

<script>
    // dynamic User by Hux
    var _baId = 'e5a8fe97a11d3eaa24842213e1d7d092';

    // Originial
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?" + _baId;
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
</script>


<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog (selector) {
        var P = $('div.post-container'),a,n,t,l,i,c;
        a = P.find('h1,h2,h3,h4,h5,h6');
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#"+$(this).prop('id');
            t = $(this).text();
            c = $('<a href="'+i+'" rel="nofollow">'+t+'</a>');
            l = $('<li class="'+n+'_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;    
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function(e){
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>





<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
