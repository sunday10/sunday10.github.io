<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Linux运维笔记">
    <meta name="keyword"  content="sunday,sundayhk,sundayle,sunday博客,Linxu,运维">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
          Redis 3.2 安装及主从复制详细配置 - Sunday博客 | Sunday Blog
        
    </title>

    <link rel="canonical" href="http://www.sundayle.com/redis-install/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Sunday</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/archives/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    
<!-- Image to hack wechat -->
<!-- <img src="http://www.sundayle.com/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="{{ site.baseurl }}/{% if page.header-img %}{{ page.header-img }}{% else %}{{ site.header-img }}{% endif %}" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        background-image: url('/img/home-bg.jpg')
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                          <a class="tag" href="/tags/#redis" title="redis">redis</a>
                        
                    </div>
                    <h1>Redis 3.2 安装及主从复制详细配置</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        Posted by Sunday on
                        2018-09-28
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <h1 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h1><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> /usr/<span class="keyword">local</span>/src</span><br><span class="line">wget http:<span class="comment">//download.redis.io/releases/redis-3.2.12.tar.gz</span></span><br><span class="line">tar xf redis-3.2.10.tar.gz</span><br><span class="line"><span class="keyword">cd</span> redis-3.2.10</span><br><span class="line">make PREFIX=/usr/<span class="keyword">local</span>/redis install</span><br><span class="line"></span><br><span class="line">useradd -s /bin/false -<span class="keyword">M</span> redis</span><br><span class="line"><span class="keyword">mkdir</span> /data/redis</span><br><span class="line">chown redis.redis /data/redis</span><br><span class="line">chmod 755 /data/redis</span><br><span class="line"></span><br><span class="line">cp redis.<span class="keyword">conf</span> /etc/redis/6379.<span class="keyword">conf</span></span><br><span class="line">cp utils/redis_init_script /etc/init.<span class="keyword">d</span>/redis</span><br><span class="line">sed -i 's#^PIDFILE.*#PIDFILE=/<span class="keyword">var</span>/<span class="keyword">run</span>/redis/redis_<span class="variable">$&#123;REDISPORT&#125;</span>.pid#<span class="keyword">g</span>' /etc/init.<span class="keyword">d</span>/redis</span><br><span class="line"></span><br><span class="line"><span class="keyword">mkdir</span> -pv /<span class="keyword">var</span>/&#123;<span class="keyword">run</span>,<span class="keyword">log</span>&#125;/redis</span><br><span class="line">chown redis.redis /<span class="keyword">var</span>/&#123;<span class="keyword">run</span>,<span class="keyword">log</span>&#125;/redis</span><br></pre></td></tr></table></figure>
<h1 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h1><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">daemonize</span> <span class="literal">yes</span> <span class="comment"># 后台运行</span></span><br><span class="line">bind <span class="number">127.0.0.1</span> <span class="number">192.168.1.41</span> <span class="comment"># 绑定多IP</span></span><br><span class="line">requirepass MbGlEnjqZ2Op+2HeLETjm<span class="variable">@IT</span> <span class="comment"># 设置登陆密码</span></span><br><span class="line">logfile <span class="string">"/var/log/redis/redis.log"</span> <span class="comment"># 日志</span></span><br><span class="line">dir /data/redis <span class="comment"># 数据目录</span></span><br><span class="line">appendonly <span class="literal">yes</span> <span class="comment"># 开启aof 持久存储</span></span><br><span class="line">masterauth MbGlEnjqZ2Op+2HeLETjm<span class="variable">@IT</span> <span class="comment"># 主从密码</span></span><br></pre></td></tr></table></figure>
<h1 id="启动脚本"><a href="#启动脚本" class="headerlink" title="启动脚本"></a>启动脚本</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### BEGIN INIT INFO</span></span><br><span class="line"><span class="comment"># Provides:          redis</span></span><br><span class="line"><span class="comment"># Required-Start:    $local_fs $network</span></span><br><span class="line"><span class="comment"># Required-Stop:     $local_fs $network</span></span><br><span class="line"><span class="comment"># Default-Start:     2 3 4 5</span></span><br><span class="line"><span class="comment"># Default-Stop:      0 1 6</span></span><br><span class="line"><span class="comment"># Short-Description: redis-server - Persistent key-value db</span></span><br><span class="line"><span class="comment"># Description:       redis-server - Persistent key-value db</span></span><br><span class="line"><span class="comment">### END INIT INFO</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># chkconfig: 2345 90 10</span></span><br><span class="line"></span><br><span class="line">REDISPORT=6379</span><br><span class="line">EXEC=/usr/<span class="built_in">local</span>/redis/bin/redis-server</span><br><span class="line">CLIEXEC=/usr/<span class="built_in">local</span>/redis/bin/redis-cli</span><br><span class="line"></span><br><span class="line">PIDFILE=/var/run/redis/redis_<span class="variable">$&#123;REDISPORT&#125;</span>.pid</span><br><span class="line">CONF=<span class="string">"/etc/redis/<span class="variable">$&#123;REDISPORT&#125;</span>.conf"</span></span><br><span class="line">SUDOUSER=<span class="string">"sudo -u redis"</span></span><br><span class="line">PASSWORD=<span class="string">"-a MbGlEnjqZ2Op+2HeLETjm@IT"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> -f /sys/kernel/mm/transparent_hugepage/enabled; <span class="keyword">then</span></span><br><span class="line">   <span class="built_in">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></span><br><span class="line">    start)</span><br><span class="line">        <span class="keyword">if</span> [ -f <span class="variable">$PIDFILE</span> ]</span><br><span class="line">        <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">"<span class="variable">$PIDFILE</span> exists, process is already running or crashed"</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">"Starting Redis server..."</span></span><br><span class="line">                <span class="comment">#$EXEC $CONF</span></span><br><span class="line">                <span class="variable">$SUDOUSER</span> <span class="variable">$EXEC</span> <span class="variable">$CONF</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        ;;</span><br><span class="line">    stop)</span><br><span class="line">        <span class="keyword">if</span> [ ! -f <span class="variable">$PIDFILE</span> ]</span><br><span class="line">        <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">"<span class="variable">$PIDFILE</span> does not exist, process is not running"</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">                PID=$(cat <span class="variable">$PIDFILE</span>)</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">"Stopping ..."</span></span><br><span class="line">                <span class="comment">#$CLIEXEC -p $REDISPORT shutdown</span></span><br><span class="line">                <span class="variable">$CLIEXEC</span> -p <span class="variable">$REDISPORT</span> <span class="variable">$PASSWORD</span> shutdown</span><br><span class="line">                <span class="keyword">while</span> [ -x /proc/<span class="variable">$&#123;PID&#125;</span> ]</span><br><span class="line">                <span class="keyword">do</span></span><br><span class="line">                    <span class="built_in">echo</span> <span class="string">"Waiting for Redis to shutdown ..."</span></span><br><span class="line">                    sleep 1</span><br><span class="line">                <span class="keyword">done</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">"Redis stopped"</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        ;;</span><br><span class="line">    restart)</span><br><span class="line">        <span class="variable">$0</span> stop;</span><br><span class="line">        <span class="variable">$0</span> start;</span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Please use start or stop as first argument"</span></span><br><span class="line">        ;;</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">chkconfig --<span class="keyword">add</span><span class="bash"> redis <span class="comment"># CentOS</span></span></span><br><span class="line"><span class="bash">chkconfig redis on</span></span><br><span class="line"><span class="bash"><span class="comment"># update-rc.d redis enable # Ubuntu</span></span></span><br><span class="line"><span class="bash"><span class="comment"># update-rc.d redis defaults</span></span></span><br></pre></td></tr></table></figure>
<h1 id="修改内核参数"><a href="#修改内核参数" class="headerlink" title="修改内核参数"></a>修改内核参数</h1><figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tail /var/log/redis/redis.log </span><br><span class="line"><span class="number">8989</span>:S <span class="number">17</span> Aug <span class="number">15</span>:<span class="number">33</span>:<span class="number">05.472</span> # WARNING: The TCP backlog setting of <span class="number">511</span> cannot be enforced because /<span class="keyword">proc</span>/sys/net/core/somaxconn<span class="title"> is</span> set<span class="title"> to</span> the<span class="title"> lower</span> value<span class="title"> of</span> 128.</span><br><span class="line">8989:S 17<span class="title"> Aug</span> 15:33:05.472 #<span class="title"> Server</span> started,<span class="title"> Redis</span> version 3.2.3</span><br><span class="line">8989:S 17<span class="title"> Aug</span> 15:33:05.472 #<span class="title"> WARNING</span> overcommit_memory<span class="title"> is</span> set<span class="title"> to</span> 0!<span class="title"> Background</span> save<span class="title"> may</span> fail<span class="title"> under</span> low<span class="title"> memory</span> condition.<span class="title"> To</span> fix<span class="title"> this</span> issue<span class="title"> add</span> 'vm.overcommit_memory = 1'<span class="title"> to</span> /etc/sysctl.conf<span class="title"> and</span> then<span class="title"> reboot</span> or<span class="title"> run</span> the<span class="title"> command</span> 'sysctl<span class="title"> vm.overcommit_memory=1'</span> for<span class="title"> this</span> to<span class="title"> take</span> effect.</span><br><span class="line">8989:S 17<span class="title"> Aug</span> 15:33:05.472 #<span class="title"> WARNING</span> you<span class="title"> have</span> Transparent<span class="title"> Huge</span> Pages (THP)<span class="title"> support</span> enabled<span class="title"> in</span> your<span class="title"> kernel.</span> This<span class="title"> will</span> create<span class="title"> latency</span> and<span class="title"> memory</span> usage<span class="title"> issues</span> with<span class="title"> Redis.</span> To<span class="title"> fix</span> this<span class="title"> issue</span> run<span class="title"> the</span> command 'echo<span class="title"> never</span> &gt; /sys/kernel/mm/transparent_hugepage/enabled'<span class="title"> as</span> root,<span class="title"> and</span> add<span class="title"> it</span> to<span class="title"> your</span> /etc/rc.local<span class="title"> in</span> order<span class="title"> to</span> retain<span class="title"> the</span> setting<span class="title"> after</span> a<span class="title"> reboot.</span> Redis<span class="title"> must</span> be<span class="title"> restarted</span> after<span class="title"> THP</span> is<span class="title"> disabled.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF &gt;&gt; /etc/sysctl.conf</span><br><span class="line">net<span class="selector-class">.core</span><span class="selector-class">.somaxconn</span> = <span class="number">262144</span>  #最大队列长度，应付突发的大并发连接请求，默认为<span class="number">128</span></span><br><span class="line">net<span class="selector-class">.core</span><span class="selector-class">.netdev_max_backlog</span> = <span class="number">262144</span>  #半连接队列长度，此值受限于内存大小，默认为<span class="number">1024</span></span><br><span class="line">vm<span class="selector-class">.overcommit_memory</span> = <span class="number">1</span> </span><br><span class="line">EOF</span><br><span class="line">sysctl -<span class="selector-tag">p</span> #参数生效</span><br></pre></td></tr></table></figure>
<p>vm.overcommit_memory不同的值说明：<br><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">0 </span>表示检查是否有足够的内存可用，如果是，允许分配；如果内存不够，拒绝该请求，并返回一个错误给应用程序。</span><br><span class="line"><span class="symbol">1 </span>允许分配超出物理内存加上交换内存的请求</span><br><span class="line"><span class="symbol">2 </span>内核总是返回true</span><br></pre></td></tr></table></figure></p>
<p><strong> redis的数据回写机制分为两种 </strong></p>
<p>同步回写即SAVE命令。redis主进程直接写数据到磁盘。当数据量大时，这个命令将阻塞，响应时间长<br>异步回写即BGSAVE命令。redis 主进程fork一个子进程，复制主进程的内存并通过子进程回写数据到磁盘。<br>由于RDB文件写的时候fork一个子进程。相当于复制了一个内存镜像。当时系统的内存是4G，而redis占用了<br>近3G的内存，因此肯定会报内存无法分配。如果 「vm.overcommit_memory」设置为0，在可用内存不足的情况<br>下，就无法分配新的内存。如果 「vm.overcommit_memory」设置为1。 那么redis将使用交换内存。</p>
<p><strong> 关闭透明内存 </strong><br><code>Transparent Huge Pages (THP)</code>告警，这是一个关于透明内存巨页的话题。简单来说内存可管理的最小<br>单位是page，一个page通常是4kb，那1M内存就会有256个page，CPU通过内置的内存管理单元管理page表<br>记录。Huge Pages就是表示page的大小已超过4kb了，一般是2M到1G，它的出现主要是为了管理超大内存。<br>个人理解上TB的内存。而THP就是管理Huge Pages的一个抽象层次，根据一些资料显示THP会导致内存锁<br>影响性能，所以一般建议关闭此功能。</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat <span class="meta-keyword">/sys/</span>kernel<span class="meta-keyword">/mm/</span>transparent_hugepage/enabled</span><br><span class="line">always [madvise] never</span><br><span class="line"><span class="meta"># always 尽量使用透明内存，扫描内存，有512个 4k页面可以整合，就整合成一个2M的页面</span></span><br><span class="line"><span class="meta"># never 关闭，不使用透明内存</span></span><br><span class="line"><span class="meta"># madvise 避免改变内存占用</span></span><br><span class="line"></span><br><span class="line">echo never &gt; <span class="meta-keyword">/sys/</span>kernel<span class="meta-keyword">/mm/</span>transparent_hugepage/enabled &gt;&gt; <span class="meta-keyword">/etc/</span>rc.local <span class="meta">#在开机脚本里追加此命令</span></span><br></pre></td></tr></table></figure>
<h1 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h1><p><strong> RDB模式 </strong><br>RDB是redis对数据进行持久化而保存到硬盘的数据文件。(默认)</p>
<p><strong> 工作原理 </strong><br>当redis生成dump.rdb文件时，工作过程如下：<br>redis主进程fork一个子进程<br>fork出来的子进程将内存的数据集dump到临时的RDB中<br>当子进程对临时的RDB文件写入完毕，redis用新的RDB文件代替旧的RDB文件</p>
<p>默认情况下相关配置如下：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">save <span class="number">900</span> <span class="number">1</span></span><br><span class="line">save <span class="number">300</span> <span class="number">10</span></span><br><span class="line">save <span class="number">60</span> <span class="number">10000</span></span><br></pre></td></tr></table></figure></p>
<p>其意义为：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">当<span class="number">1</span>个<span class="type">key</span>更新值时每<span class="number">900</span>秒保存一次数据到硬盘</span><br><span class="line">当<span class="number">10</span>个<span class="type">key</span>更新值时每<span class="number">300</span>秒保存一次到硬盘</span><br><span class="line">当<span class="number">10000</span>个<span class="type">key</span>更新值时每<span class="number">60</span>秒保存一次到硬盘</span><br></pre></td></tr></table></figure></p>
<p>换句话说，当你重启服务器时数据是可能会丢失的，如果数据量小的时候，你会丢失5分钟以内的数据；如果数据量大的时候，你会丢失一分钟以内的数据。</p>
<p>所以set name 1后重启服务器，get name时的结果会是nil，如果你想避免这种情况发生，那么可以save后重启服务器。</p>
<p>然而大多数情况下我们需要防止的是服务器突发情况下的重启，这时候可能没有机会save，所以还是会造成数据的丢失。所以你可以设置save “”这样的话会每次写操作到保存到硬盘，但是redis作为缓存却需要每次到保存到硬盘已丧失了其作为缓存的意义，因此这种方法是不可取的。</p>
<p>还有一种方式，在每次写操作时使用bgsave命令，可以直接返回操作结果并异步将其保存到硬盘。</p>
<p>rdb方式的优点是保存的数据存储量小（只有数据）重启速度很快；缺点是可能会造成数据的丢失。</p>
<p><strong> AOF模式 </strong><br>aof本质是redis操作（写操作）日志文件。aof默认是未开启的，需要在配置文件中进行设置，在配置文件中将这一行改为appendonly yes就可以了。</p>
<p><strong> 工作原理 </strong><br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">AOF ：<span class="keyword">append</span> <span class="keyword">only</span> <span class="keyword">file</span>。</span><br><span class="line">每当Redis执行一个改变数据集的命令时，这个命令都会被追加到AOF文件的末尾。</span><br><span class="line">当redis重新启动时，程序可以通过AOF文件恢复数据。</span><br></pre></td></tr></table></figure></p>
<p>那么会在什么时候append到文件末尾呢？有三种方式：<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#appendfsync always</span></span><br><span class="line"><span class="attribute">appendfsync</span> everysec</span><br><span class="line"><span class="comment">#appendfsync no </span></span><br><span class="line"></span><br><span class="line">appendfsync always 每次有新命令追加到 AOF 文件时就执行一次 fsync ：非常慢，也非常安全</span><br><span class="line">appendfsync everysec 每秒 fsync 一次：足够快（和使用 RDB 持久化差不多），并且在故障时只会丢失 <span class="number">1</span> 秒钟的数据。</span><br><span class="line">appendfsync <span class="literal">no</span> <span class="comment"># 从不 fsync 将数据交给操作系统来处理。更快，也更不安全的选择。</span></span><br><span class="line"></span><br><span class="line">推荐默认appendfsync everysec 每秒 fsync 一次， 这种 fsync 策略可以兼顾速度和安全性。</span><br></pre></td></tr></table></figure></p>
<p>aof能够保证数据的安全，但是在重启时比较耗时，而且aof文件的体积比rdb文件大。</p>
<p><strong> 使用 </strong><br>在同时开启rdb和aof模式时，会采用aof模式来读取数据。在正常的使用中，如果不是十分在乎短时间内的数据丢失的时候，使用rdb方式会使服务器的效率更高，更节省cpu和硬盘；如果担心数据丢失的话，aof方式无疑会是更好的选择。</p>
<h1 id="在线动态从RDB切换为AOF"><a href="#在线动态从RDB切换为AOF" class="headerlink" title="在线动态从RDB切换为AOF"></a>在线动态从RDB切换为AOF</h1><p>切勿修改配置文件重启，这样会丢失所有数据的。<br>正确的操作方式如下<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">config <span class="builtin-name">set</span> appendonly <span class="literal">yes</span></span><br><span class="line">config <span class="builtin-name">set</span> save <span class="string">""</span>（可选）</span><br><span class="line">然后修改配置文件appendonly <span class="literal">yes</span></span><br></pre></td></tr></table></figure></p>
<h1 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h1><p><strong> 1、概述 </strong></p>
<p>Redis的replication机制允许slave从master那里通过网络传输拷贝到完整的数据备份。具有以下特点：</p>
<ul>
<li><p>1.异步复制，从2.8版本开始，slave能不时地从master那里获取到数据。* </p>
</li>
<li><p>2.允许单个master配置多个slave* </p>
</li>
<li><p>3.slave允许其它slave连接到自己。一个slave除了可以连接master外，它还可以连接其它的slave。形成一个图状的架构。* </p>
</li>
<li><p>4.master在进行replication时是非阻塞的，这意味着在replication期间，master依然能够处理客户端的请求。* </p>
</li>
<li><p>5.slave在replication期间也是非阻塞的，也可以接受来自客户端的请求，但是它用的是之前的旧数据。可以通过配置来决定slave是否在进行replication时用旧数据响应客户端的请求，如果配置为否，那么slave将会返回一个错误消息给客户端。不过当新的数据接收完全后，必须将新数据与旧数据替换，即删除旧数据，在替换数据的这个时间窗口内，slave将会拒绝客户端的请求和连接。* </p>
</li>
<li><p>6.一般使用replication来可以实现扩展性，例如说，可以将多个slave配置为“只读”，或者是纯粹的数据冗余备份。* </p>
</li>
<li><p>7.能够通过replication来避免master每次持久化时都将整个数据集持久化到硬盘中。只需把master配置为不进行持久化操作(把配置文件中持久化相关的配置项注释掉即可)，然后连接上一个slave，这个slave则被配置持久化选项。不过需要注意的是，在这个方案中，必须确保master不会自动启动。</p>
</li>
</ul>
<p><strong> 2、Master持久化功能关闭时Replication的安全性 </strong></p>
<p>当有需要使用到replication机制时，一般都会强烈建议把master的持久化开关打开。即使为了避免持久化带来的延迟影响，不把持久化开关打开，那么也应该把master配置为不会自动启动的。</p>
<p>为了更好地理解当一个不进行持久化的master如果允许自动启动所带来的危险性。可以看看下面这种失败情形：</p>
<p>假设我们有一个redis节点A，设置为master，并且关闭持久化功能，另外两个节点B和C是它的slave，并从A复制数据。<br>如果A节点崩溃了导致所有的数据都丢失了，它会有重启系统来重启进程。但是由于持久化功能被关闭了，所以即使它重启了，它的数据集是空的。<br>而B和C依然会通过replication机制从A复制数据，所以B和C会从A那里复制到一份空的数据集，并用这份空的数据集将自己本身的非空的数据集替换掉。于是就相当于丢失了所有的数据。</p>
<p>即使使用一些HA工具，比如说sentinel来监控master-slaves集群，也会发生上述的情形，因为master可能崩溃后迅速恢复。速度太快而导致sentinel无法察觉到一个failure的发生。</p>
<p>当数据的安全很重要、持久化开关被关闭并且有replication发生的时候，那么应该<strong>禁止实例的自启动</strong>。</p>
<p><strong> 3、replication工作原理 </strong><br>如果你为master配置了一个slave，不管这个slave是否是第一次连接上Master，它都会发送一个SYNC命令给master请求复制数据。</p>
<p>master收到SYNC命令后，会在后台进行数据持久化，持久化期间，master会继续接收客户端的请求，它会把这些可能修改数据集的请求缓存在内存中。当持久化进行完毕以后，master会把这份数据集发送给slave，slave会把接收到的数据进行持久化，然后再加载到内存中。然后，master再将之前缓存在内存中的命令发送给slave。</p>
<p>当master与slave之间的连接由于某些原因而断开时，slave能够自动重连master，如果master收到了多个slave并发连接请求，它只会进行一次持久化，而不是一个连接一次，然后再把这一份持久化的数据发送给多个并发连接的slave。</p>
<p>当master和slave断开重连后，一般都会对整份数据进行复制。但从redis2.8版本开始，支持部分复制。</p>
<p><strong> 4、数据部分复制 </strong><br>从2.8版本开始，slave与master能够在网络连接断开重连后只进行部分数据复制。</p>
<p>master会在其内存中创建一个复制流的等待队列，master和它所有的slave都维护了复制的数据下标和master的进程id，因此，当网络连接断开后，slave会请求master继续进行未完成的复制，从所记录的数据下标开始。如果进程id变化了，或者数据下标不可用，那么将会进行一次全部数据的复制。</p>
<p><strong> 5、支持部分数据复制的命令是PSYNC </strong></p>
<p>不需硬盘参与的Replication<br>一般情况下，一次复制需要将内存的数据写到硬盘中，再将数据从硬盘读进内存，再发送给slave。</p>
<p>对于速度比较慢的硬盘，这个操作会给master带来性能上的损失。Redis2.8版本开始，实验性地加上了无硬盘复制的功能。这个功能能将数据从内存中直接发送到slave，而不用经过硬盘的存储。</p>
<p>不过这个功能目前处于实验阶段，还未正式发布。</p>
<p><strong> 6、主从配置 </strong><br>slave节点配置文件<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">slaveof <span class="number">192.168</span><span class="number">.1</span><span class="number">.41</span> <span class="number">6379</span></span><br><span class="line">masterauth MbGlEnjqZ2Op+<span class="number">2</span>HeLETjm@IT #若master通过requirepass配置了密码，则需要配置此项</span><br></pre></td></tr></table></figure></p>
<p><strong> 7、只读的slave </strong><br>从redis2.6版本开始，slave支持只读模式，而且是默认的。可以通过配置项slave-read-only来进行配置，并且支持客户端使用CONFIG SET命令来动态修改配置。</p>
<p>只读的slave会拒绝所有的写请求，只读的slave并不是为了防范不可信的客户端，毕竟一些管理命令例如DEBUG和CONFIG在只读模式下还是可以使用的。如果确实要确保安全性，那么可以在配置文件中将一些命令重新命名。</p>
<p>也许你会感到很奇怪，为什么能够将一个只读模式的slave恢复为可写的呢，尽管可写，但是只要slave一同步master的数据，就会丢失那些写在slave的数据。不过还是有一些合法的应用场景需要存储瞬时数据会用到这个特性。<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">slave</span>-<span class="keyword">read</span>-only yes</span><br></pre></td></tr></table></figure></p>
<p><strong> 8、至少N个slave才允许向master写数据 </strong><br>从redis2.8版本开始，master可以被配置为，只有当master当前有至少N个slave连接着的时候才接受写数据的请求。</p>
<p>然而，由于redis是异步复制的，所以它并不能保证slave会受到一个写请求，所以总有一个数据丢失的时间窗口存在。</p>
<p>这个机制的工作原理如下所示：</p>
<ul>
<li>slave每秒发送ping心跳给master，询问当前复制了多少数据。</li>
<li>master会记录下它上次收到某个slave的ping心跳是什么时候。</li>
<li>使用者可以配置一个时间，来指定ping心跳的发送不应超过的一个超时时间</li>
<li>如果master有至少N个slave，并且ping心跳的超时不超过M秒，那么它就会接收写请求。</li>
</ul>
<p>也许你会认为这情形好似CAP理论中弱化版的C(consistency)，因为写请求并不能保证数据的一致性，但这样做，至少数据丢失被限制在了限定的时间内。即M秒。</p>
<p>如果N和M的条件都无法达到，那么master会回复一个错误信息。写请求也不会被处理。</p>
<p>有两个配置项用来配置上文中提到的N和M：<br><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">min</span>-slaves-<span class="built_in">to</span>-<span class="built_in">write</span> &lt;<span class="built_in">number</span> <span class="keyword">of</span> slaves&gt;</span><br><span class="line"><span class="built_in">min</span>-slaves-<span class="built_in">max</span>-lag &lt;<span class="built_in">number</span> <span class="keyword">of</span> <span class="built_in">seconds</span>&gt;</span><br></pre></td></tr></table></figure></p>
<h1 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h1><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">auth</span> <span class="selector-tag">Passwd</span> # 登录,密码验证 <span class="selector-id">#redis-cli</span> <span class="selector-tag">-a</span> <span class="selector-tag">Passwd</span></span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt;<span class="selector-tag">info</span> # 查看数据库状态</span><br><span class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt;<span class="selector-tag">info</span> <span class="selector-tag">replication</span> # 查看<span class="selector-tag">slave</span>的复制状态</span><br><span class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt;<span class="selector-tag">set</span> <span class="selector-tag">key</span> 123 # 插入数据</span><br><span class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt;<span class="selector-tag">keys</span> * # 列出数据</span><br><span class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt;<span class="selector-tag">flushdb</span> # 清空当前数据</span><br><span class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt;<span class="selector-tag">flushall</span> # 清除所有数据库</span><br><span class="line"></span><br><span class="line"># 判断主从是否完全一致</span><br><span class="line"><span class="selector-tag">dbsize</span> #查看<span class="selector-tag">key</span> 的数目</span><br><span class="line"><span class="selector-tag">debug</span> <span class="selector-tag">digest</span> #对整个数据库的数据，产生一个摘要，可用于验证两个<span class="selector-tag">redis</span>数据库数据是否一致 </span><br><span class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">debug</span> <span class="selector-tag">digest</span> 7164<span class="selector-tag">ae8b6730c8bcade46532e5e4a8015d4cccfb</span> </span><br><span class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">debug</span> <span class="selector-tag">digest</span> 7164<span class="selector-tag">ae8b6730c8bcade46532e5e4a8015d4cccfb</span></span><br></pre></td></tr></table></figure>
<h1 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h1><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sed -<span class="selector-tag">i</span> <span class="string">'s#^daemonize.*#daemonize yes#'</span> /etc/redis/<span class="number">6379</span>.conf</span><br><span class="line">sed -<span class="selector-tag">i</span> <span class="string">'s#^logfile.*#logfile "/var/log/redis/redis.log"#'</span> /etc/redis/<span class="number">6379</span>.conf</span><br><span class="line">sed -<span class="selector-tag">i</span> <span class="string">'s#^pidfile.*#pidfile /var/run/redis/redis_6379.pid#'</span> /etc/redis/<span class="number">6379</span>.conf</span><br><span class="line">sed -<span class="selector-tag">i</span> <span class="string">'s#^dir ./#dir /data/redis#'</span> /etc/redis/<span class="number">6379</span>.conf</span><br><span class="line">sed -<span class="selector-tag">i</span> <span class="string">'s#^appendonly.*#appendonly yes#'</span> /etc/redis/<span class="number">6379</span>.conf</span><br><span class="line">sed -<span class="selector-tag">i</span> <span class="string">'s!# requirepass foobared!# requirepass foobared\nrequirepass MbGlEnjqZ2Op+2HeLETjm@IT'</span> /etc/redis/<span class="number">6379</span>.conf</span><br><span class="line">sed -<span class="selector-tag">i</span> <span class="string">'s!# masterauth.*#masterauth MbGlEnjqZ2Op+2HeLETjm@IT'</span> /etc/redis/<span class="number">6379</span>.conf</span><br></pre></td></tr></table></figure>
<p><a href="https://segmentfault.com/a/1190000006619753#articleHeader0" target="_blank" rel="noopener">https://segmentfault.com/a/1190000006619753#articleHeader0</a><br><a href="https://www.imooc.com/article/69685?block_id=tuijian_wz" target="_blank" rel="noopener">https://www.imooc.com/article/69685?block_id=tuijian_wz</a></p>


                <hr>

                

                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/iis-8-5-configure-high-concurrency/" data-toggle="tooltip" data-placement="top" title="IIS 8.5 高并发配置">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/sql-server-replication/" data-toggle="tooltip" data-placement="top" title="Windows SQL Server 主从复制">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                

                

            </div>
    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->

            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#redis" title="redis">redis</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="https://jaminzhang.github.io" target="_blank">JAMIN ZHANG</a></li>
                    
                        <li><a href="#" target="_blank">It helps SEO</a></li>
                    
                </ul>
                
            </div>

        </div>
    </div>
</article>







<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                

                

                

                
                    <li>
                        <a target="_blank"  href="https://github.com/sundayle">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Sunday 2018 
                    <br>
                    Theme by <a href="http://huangxuan.me">Hux</a> 
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span>
                    Ported by <a href="https://github.com/Kaijun/hexo-theme-huxblog">Kaijun</a>
            <!-- 
                    Ported by <a href="http://blog.kaijun.rocks">Kaijun</a> | 
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=kaijun&repo=hexo-theme-huxblog&type=star&count=true" >
                    </iframe>
            -->
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
     async("https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->


<script>
    // dynamic User by Hux
    var _gaId = 'UA-70699634-1';
    var _gaDomain = 'auto';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>




<!-- Baidu Tongji -->


<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog (selector) {
        var P = $('div.post-container'),a,n,t,l,i,c;
        a = P.find('h1,h2,h3,h4,h5,h6');
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#"+$(this).prop('id');
            t = $(this).text();
            c = $('<a href="'+i+'" rel="nofollow">'+t+'</a>');
            l = $('<li class="'+n+'_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;    
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function(e){
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>





<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
