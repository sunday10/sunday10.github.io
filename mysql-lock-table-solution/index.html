<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="SundayLE IT运维技术记录">
    <meta name="keyword"  content="sunday,sundayhk,sundayle,sunday博客,Linxu,运维">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
          MySQL 锁表后快速解决方法 及 锁表原因 - Sunday博客 | Sunday Blog
        
    </title>

    <link rel="canonical" href="http://www.sundayle.com/mysql-lock-table-solution/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">SundayLe</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/archives/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    
<!-- Image to hack wechat -->
<!-- <img src="http://www.sundayle.com/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="{{ site.baseurl }}/{% if page.header-img %}{{ page.header-img }}{% else %}{{ site.header-img }}{% endif %}" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        background-image: url('/img/home-bg.jpg')
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                          <a class="tag" href="/tags/#mysql" title="mysql">mysql</a>
                        
                    </div>
                    <h1>MySQL 锁表后快速解决方法 及 锁表原因</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        Posted by Sunday on
                        2020-05-20
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <p>前几天同事在晚上上线的时候执行sql语句造成锁表，想总结一下以避免后续发生。</p>
<h1 id="1-遇到锁表快速解决办法"><a href="#1-遇到锁表快速解决办法" class="headerlink" title="(1) 遇到锁表快速解决办法"></a>(1) 遇到锁表快速解决办法</h1><p>依次执行1-6步，运行第6步生成的语句即可。<br>如果特别着急，运行 1 2 6 步 以及第6步生成的kill语句 即可。</p>
<p>1.　 <strong>第1步　查看表是否在使用</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">open</span> <span class="keyword">tables</span> <span class="keyword">where</span> in_use  <span class="number">0</span> ;</span><br><span class="line">如果查询结果为空。则证明表没有在使用。结束。</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql  <span class="keyword">show</span> <span class="keyword">open</span> <span class="keyword">tables</span> <span class="keyword">where</span> in_use  <span class="number">0</span> ;</span><br><span class="line">Empty <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line">如果查询结果不为空，继续后续的步骤。</span><br></pre></td></tr></table></figure>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="code"> mysql  show open tables where in_use  0 ;</span></span><br><span class="line"><span class="code">+----------+</span>-------<span class="code">+--------+</span>-------------+</span><br><span class="line">| Database | Table | In<span class="emphasis">_use | Name_</span>locked |</span><br><span class="line"><span class="code">+----------+</span>-------<span class="code">+--------+</span>-------------+</span><br><span class="line">| test     | t     |      1 |           0 |</span><br><span class="line"><span class="code">+----------+</span>-------<span class="code">+--------+</span>-------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>2.　 <strong>第2步　查看数据库当前的进程，看一下有无正在执行的慢SQL记录线程。</strong></p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">processlist</span>;</span><br></pre></td></tr></table></figure>
<p>3.　 <strong>第3步　当前运行的所有事务</strong></p>
 <figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> information_schema.INNODB_TRX;</span><br></pre></td></tr></table></figure>
<p>4.　 <strong>第4步　当前出现的锁</strong></p>
 <figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> information_schema.INNODB_LOCKs;</span><br></pre></td></tr></table></figure>
<p>5.　 <strong>第5步　锁等待的对应关系</strong></p>
 <figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> information_schema.INNODB_LOCK_waits;</span><br></pre></td></tr></table></figure>
<p> 看事务表INNODB_TRX，里面是否有正在锁定的事务线程，看看ID是否在show processlist里面的sleep线程中，如果是，就证明这个sleep的线程事务一直没有commit或者rollback而是卡住了，我们需要手动kill掉。<br> 搜索的结果是在事务表发现了很多任务，这时候最好都kill掉。</p>
<p>6.　 <strong>第6步　批量删除事务表中的事务</strong></p>
<p> 这里用的方法是：通过information_schema.processlist表中的连接信息生成需要处理掉的MySQL连接的语句临时文件，然后执行临时文件中生成的指令。</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">concat</span>(<span class="string">'KILL '</span>,<span class="keyword">id</span>,<span class="string">';'</span>) <span class="keyword">FROM</span> information_schema.processlist p <span class="keyword">INNER</span> <span class="keyword">JOIN</span>  information_schema.INNODB_TRX x <span class="keyword">ON</span> p.id=x.trx_mysql_thread_id <span class="keyword">WHERE</span> db=<span class="string">'test'</span>;</span><br></pre></td></tr></table></figure>
<p> 记得修改对应的数据库名。</p>
<p> 这个语句执行后结果如下：</p>
 <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;  SELECT concat(<span class="emphasis">'KILL '</span>,id,<span class="emphasis">';'</span>)  FROM information<span class="emphasis">_schema.processlist p  INNER JOIN  information_</span>schema.INNODB<span class="emphasis">_TRX x  ON p.id=x.trx_</span>mysql<span class="emphasis">_thread_</span>id  WHERE db=<span class="emphasis">'test'</span>;</span><br><span class="line"><span class="code">+------------------------+</span></span><br><span class="line">| concat(<span class="emphasis">'KILL '</span>,id,<span class="emphasis">';'</span>) |</span><br><span class="line"><span class="code">+------------------------+</span></span><br><span class="line">| KILL 42;               |</span><br><span class="line">| KILL 40;               |</span><br><span class="line"><span class="code">+------------------------+</span></span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p> 执行结果里的两个kill语句即可解决锁表。</p>
<ol>
<li>MySQL里有哪些锁？</li>
<li>如何造成锁表？</li>
<li>如何造成死锁？</li>
<li>全局锁加锁方法的执行命令是什么?主要的应用场景是什么?</li>
<li>做整库备份时为什么要加全局锁?</li>
<li>MySQL的自带备份工具, 使用什么参数可以确保一致性视图, 在什么场景下不适用?</li>
<li>不建议使用set global readonly = true的方法加全局锁有哪两点原因?</li>
<li>表级锁有哪两种类型? 各自的使用场景是什么?</li>
<li>MDL中读写锁之间的互斥关系怎样的?</li>
<li>如何安全的给小表增加字段?</li>
</ol>
<h1 id="2-复盘"><a href="#2-复盘" class="headerlink" title="(2) 复盘"></a>(2) 复盘</h1><p>自己创建了一个测试的表<code>t</code>，插入了两条数据。然后手动构造锁表和死锁模拟。</p>
<h2 id="2-1-创建表t并插入2条数据"><a href="#2-1-创建表t并插入2条数据" class="headerlink" title="(2.1) 创建表t并插入2条数据"></a>(2.1) 创建表t并插入2条数据</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`t`</span> (  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  <span class="string">`c`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`t`</span> (<span class="keyword">id</span>, c)<span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">1</span>),(<span class="number">2</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<h2 id="2-2-准备多个shell模拟锁表"><a href="#2-2-准备多个shell模拟锁表" class="headerlink" title="(2.2) 准备多个shell模拟锁表"></a>(2.2) 准备多个shell模拟锁表</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">可以看到我打开三个shell，用root创建了三个连接，分别是 15  40  41 </span><br><span class="line">mysql&gt; show processlist ;</span><br><span class="line">+----+-------------+-----------------+------+---------+------+--------------------------+------------------+----------+</span><br><span class="line">| Id |<span class="built_in"> User </span>       | Host            | db   | Command | Time | State                    | <span class="builtin-name">Info</span>             | Progress |</span><br><span class="line">+----+-------------+-----------------+------+---------+------+--------------------------+------------------+----------+</span><br><span class="line">|  1 |<span class="built_in"> system user </span>|                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | InnoDB purge worker      | <span class="literal">NULL</span>             |    0.000 |</span><br><span class="line">|  2 |<span class="built_in"> system user </span>|                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | InnoDB purge worker      | <span class="literal">NULL</span>             |    0.000 |</span><br><span class="line">|  3 |<span class="built_in"> system user </span>|                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | InnoDB purge coordinator | <span class="literal">NULL</span>             |    0.000 |</span><br><span class="line">|  4 |<span class="built_in"> system user </span>|                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | InnoDB purge worker      | <span class="literal">NULL</span>             |    0.000 |</span><br><span class="line">|  5 |<span class="built_in"> system user </span>|                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | InnoDB shutdown handler  | <span class="literal">NULL</span>             |    0.000 |</span><br><span class="line">| 15 | root        | localhost:49914 | <span class="literal">NULL</span> | Query   |    0 | Init                     | show processlist |    0.000 |</span><br><span class="line">+----+-------------+-----------------+------+---------+------+--------------------------+------------------+----------+</span><br><span class="line">6 rows <span class="keyword">in</span> <span class="builtin-name">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br><span class="line">mysql&gt; show processlist ;</span><br><span class="line">+----+-------------+-----------------+------+---------+------+--------------------------+------------------+----------+</span><br><span class="line">| Id |<span class="built_in"> User </span>       | Host            | db   | Command | Time | State                    | <span class="builtin-name">Info</span>             | Progress |</span><br><span class="line">+----+-------------+-----------------+------+---------+------+--------------------------+------------------+----------+</span><br><span class="line">|  1 |<span class="built_in"> system user </span>|                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | InnoDB purge worker      | <span class="literal">NULL</span>             |    0.000 |</span><br><span class="line">|  2 |<span class="built_in"> system user </span>|                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | InnoDB purge worker      | <span class="literal">NULL</span>             |    0.000 |</span><br><span class="line">|  3 |<span class="built_in"> system user </span>|                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | InnoDB purge coordinator | <span class="literal">NULL</span>             |    0.000 |</span><br><span class="line">|  4 |<span class="built_in"> system user </span>|                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | InnoDB purge worker      | <span class="literal">NULL</span>             |    0.000 |</span><br><span class="line">|  5 |<span class="built_in"> system user </span>|                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | InnoDB shutdown handler  | <span class="literal">NULL</span>             |    0.000 |</span><br><span class="line">| 15 | root        | localhost:49914 | <span class="literal">NULL</span> | Query   |    0 | Init                     | show processlist |    0.000 |</span><br><span class="line">| 40 | root        | localhost:50872 | test | Sleep   |   41 |                          | <span class="literal">NULL</span>             |    0.000 |</span><br><span class="line">+----+-------------+-----------------+------+---------+------+--------------------------+------------------+----------+</span><br><span class="line">7 rows <span class="keyword">in</span> <span class="builtin-name">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br><span class="line">mysql&gt; show processlist ;</span><br><span class="line">+----+-------------+-----------------+------+---------+------+--------------------------+------------------+----------+</span><br><span class="line">| Id |<span class="built_in"> User </span>       | Host            | db   | Command | Time | State                    | <span class="builtin-name">Info</span>             | Progress |</span><br><span class="line">+----+-------------+-----------------+------+---------+------+--------------------------+------------------+----------+</span><br><span class="line">|  1 |<span class="built_in"> system user </span>|                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | InnoDB purge worker      | <span class="literal">NULL</span>             |    0.000 |</span><br><span class="line">|  2 |<span class="built_in"> system user </span>|                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | InnoDB purge worker      | <span class="literal">NULL</span>             |    0.000 |</span><br><span class="line">|  3 |<span class="built_in"> system user </span>|                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | InnoDB purge coordinator | <span class="literal">NULL</span>             |    0.000 |</span><br><span class="line">|  4 |<span class="built_in"> system user </span>|                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | InnoDB purge worker      | <span class="literal">NULL</span>             |    0.000 |</span><br><span class="line">|  5 |<span class="built_in"> system user </span>|                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | InnoDB shutdown handler  | <span class="literal">NULL</span>             |    0.000 |</span><br><span class="line">| 15 | root        | localhost:49914 | <span class="literal">NULL</span> | Query   |    0 | Init                     | show processlist |    0.000 |</span><br><span class="line">| 40 | root        | localhost:50872 | test | Sleep   |   64 |                          | <span class="literal">NULL</span>             |    0.000 |</span><br><span class="line">| 41 | root        | localhost:50888 | test | Sleep   |    5 |                          | <span class="literal">NULL</span>             |    0.000 |</span><br><span class="line">+----+-------------+-----------------+------+---------+------+--------------------------+------------------+----------+</span><br><span class="line">8 rows <span class="keyword">in</span> <span class="builtin-name">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>
<h2 id="2-3-模拟锁表"><a href="#2-3-模拟锁表" class="headerlink" title="(2.3) 模拟锁表"></a>(2.3) 模拟锁表</h2><p>在第一个shell里观察</p>
<p>在第二个shell里执行 <code>start transaction; delete from t where c=1 ;</code> 故意打开事务，然后执行语句不提交，占用写锁。</p>
<p>在第三个shell里执行 <code>delete from t where c=1 ;</code> 执行删除语句，造成锁表。</p>
<p>这个时候 session3在等待session2释放写锁。这个时候已经锁表了。</p>
<p>如果再在 第三个shell里执行 <code>delete from t where c=2 ;</code></p>
<p>在 第二个shell里执行 <code>delete from t where c=1 ;</code></p>
<p>就会相互等待，造成死锁。</p>
<h2 id="2-4-锁表后查看"><a href="#2-4-锁表后查看" class="headerlink" title="(2.4) 锁表后查看"></a>(2.4) 锁表后查看</h2><p>然后在第一个shell里查看</p>
<h3 id="2-4-1-查看是否锁表"><a href="#2-4-1-查看是否锁表" class="headerlink" title="(2.4.1)查看是否锁表"></a>(2.4.1)查看是否锁表</h3><p>可以看到下面的查询语句有结果，确实是锁表了。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;  show open tables where in<span class="emphasis">_use &gt; 0 ;</span></span><br><span class="line"><span class="emphasis">+----------+-------+--------+-------------+</span></span><br><span class="line"><span class="emphasis">| Database | Table | In_</span>use | Name<span class="emphasis">_locked |</span></span><br><span class="line"><span class="emphasis">+----------+-------+--------+-------------+</span></span><br><span class="line"><span class="emphasis">| test     | t     |      1 |           0 |</span></span><br><span class="line"><span class="emphasis">+----------+-------+--------+-------------+</span></span><br><span class="line"><span class="emphasis">1 row in set (0.00 sec)</span></span><br></pre></td></tr></table></figure>
<h3 id="2-4-2-查看数据库当前的进程"><a href="#2-4-2-查看数据库当前的进程" class="headerlink" title="(2.4.2) 查看数据库当前的进程"></a>(2.4.2) 查看数据库当前的进程</h3><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show processlist ;</span><br><span class="line">+----+-------------+-----------------+------+---------+------+--------------------------+-------------------------+----------+</span><br><span class="line">|<span class="string"> Id </span>|<span class="string"> User        </span>|<span class="string"> Host            </span>|<span class="string"> db   </span>|<span class="string"> Command </span>|<span class="string"> Time </span>|<span class="string"> State                    </span>|<span class="string"> Info                    </span>|<span class="string"> Progress </span>|</span><br><span class="line">+----+-------------+-----------------+------+---------+------+--------------------------+-------------------------+----------+</span><br><span class="line">|<span class="string">  1 </span>|<span class="string"> system user </span>|<span class="string">                 </span>|<span class="string"> NULL </span>|<span class="string"> Daemon  </span>|<span class="string"> NULL </span>|<span class="string"> InnoDB purge worker      </span>|<span class="string"> NULL                    </span>|<span class="string">    0.000 </span>|</span><br><span class="line">|<span class="string">  2 </span>|<span class="string"> system user </span>|<span class="string">                 </span>|<span class="string"> NULL </span>|<span class="string"> Daemon  </span>|<span class="string"> NULL </span>|<span class="string"> InnoDB purge worker      </span>|<span class="string"> NULL                    </span>|<span class="string">    0.000 </span>|</span><br><span class="line">|<span class="string">  3 </span>|<span class="string"> system user </span>|<span class="string">                 </span>|<span class="string"> NULL </span>|<span class="string"> Daemon  </span>|<span class="string"> NULL </span>|<span class="string"> InnoDB purge coordinator </span>|<span class="string"> NULL                    </span>|<span class="string">    0.000 </span>|</span><br><span class="line">|<span class="string">  4 </span>|<span class="string"> system user </span>|<span class="string">                 </span>|<span class="string"> NULL </span>|<span class="string"> Daemon  </span>|<span class="string"> NULL </span>|<span class="string"> InnoDB purge worker      </span>|<span class="string"> NULL                    </span>|<span class="string">    0.000 </span>|</span><br><span class="line">|<span class="string">  5 </span>|<span class="string"> system user </span>|<span class="string">                 </span>|<span class="string"> NULL </span>|<span class="string"> Daemon  </span>|<span class="string"> NULL </span>|<span class="string"> InnoDB shutdown handler  </span>|<span class="string"> NULL                    </span>|<span class="string">    0.000 </span>|</span><br><span class="line">|<span class="string"> 15 </span>|<span class="string"> root        </span>|<span class="string"> localhost:49914 </span>|<span class="string"> NULL </span>|<span class="string"> Query   </span>|<span class="string">    0 </span>|<span class="string"> Init                     </span>|<span class="string"> show processlist        </span>|<span class="string">    0.000 </span>|</span><br><span class="line">|<span class="string"> 40 </span>|<span class="string"> root        </span>|<span class="string"> localhost:50872 </span>|<span class="string"> test </span>|<span class="string"> Sleep   </span>|<span class="string">   15 </span>|<span class="string">                          </span>|<span class="string"> NULL                    </span>|<span class="string">    0.000 </span>|</span><br><span class="line">|<span class="string"> 41 </span>|<span class="string"> root        </span>|<span class="string"> localhost:50888 </span>|<span class="string"> test </span>|<span class="string"> Query   </span>|<span class="string">   11 </span>|<span class="string"> Updating                 </span>|<span class="string"> delete from t where c=1 </span>|<span class="string">    0.000 </span>|</span><br><span class="line">+----+-------------+-----------------+------+---------+------+--------------------------+-------------------------+----------+</span><br><span class="line">8 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<h3 id="2-4-3-当前运行的所有事务"><a href="#2-4-3-当前运行的所有事务" class="headerlink" title="(2.4.3) 当前运行的所有事务"></a>(2.4.3) 当前运行的所有事务</h3><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;  SELECT * FROM information_schema.INNODB_TRX;</span><br><span class="line">+--------+-----------+---------------------+-----------------------+---------------------+------------+---------------------+-------------------------+---------------------+-------------------+-------------------+------------------+-----------------------+-----------------+-------------------+-------------------------+---------------------+-------------------+------------------------+----------------------------+------------------+----------------------------+</span><br><span class="line">| <span class="type">trx_id</span> | <span class="type">trx_state</span> | <span class="type">trx_started</span>         | <span class="type">trx_requested_lock_id</span> | <span class="type">trx_wait_started</span>    | <span class="type">trx_weight</span> | <span class="type">trx_mysql_thread_id</span> | <span class="type">trx_query</span>               | <span class="type">trx_operation_state</span> | <span class="type">trx_tables_in_use</span> | <span class="type">trx_tables_locked</span> | <span class="type">trx_lock_structs</span> | <span class="type">trx_lock_memory_bytes</span> | <span class="type">trx_rows_locked</span> | <span class="type">trx_rows_modified</span> | <span class="type">trx_concurrency_tickets</span> | <span class="type">trx_isolation_level</span> | <span class="type">trx_unique_checks</span> | <span class="type">trx_foreign_key_checks</span> | <span class="type">trx_last_foreign_key_error</span> | <span class="type">trx_is_read_only</span> | <span class="type">trx_autocommit_non_locking</span> |<span class="type"></span></span><br><span class="line"><span class="type">+--------+-----------+---------------------+-----------------------+---------------------+------------+---------------------+-------------------------+---------------------+-------------------+-------------------+------------------+-----------------------+-----------------+-------------------+-------------------------+---------------------+-------------------+------------------------+----------------------------+------------------+----------------------------+</span></span><br><span class="line"><span class="type">| 23312</span>  | <span class="type">LOCK</span> WAIT | <span class="type">2019</span><span class="number">-09</span><span class="number">-05</span> <span class="number">23</span>:<span class="number">16</span>:<span class="number">18</span> | <span class="type">23312</span>:<span class="number">78</span>:<span class="number">3</span>:<span class="number">2</span>          | <span class="type">2019</span><span class="number">-09</span><span class="number">-05</span> <span class="number">23</span>:<span class="number">16</span>:<span class="number">18</span> |          <span class="type">2</span> |                  <span class="type">41</span> | <span class="type">delete</span> from t <span class="keyword">where</span> c=<span class="number">1</span> | <span class="type">starting</span> index read |                 <span class="type">1</span> |                 <span class="type">1</span> |                <span class="type">2</span> |                  <span class="type">1136</span> |               <span class="type">1</span> |                 <span class="type">0</span> |                       <span class="type">0</span> | <span class="type">REPEATABLE</span> READ</span><br><span class="line">     |                 <span class="type">1</span> |                      <span class="type">1</span> | <span class="type">NULL</span>                       |                <span class="type">0</span> |                          <span class="type">0</span> |<span class="type"></span></span><br><span class="line"><span class="type">| 23311</span>  | <span class="type">RUNNING</span>   | <span class="type">2019</span><span class="number">-09</span><span class="number">-05</span> <span class="number">23</span>:<span class="number">16</span>:<span class="number">13</span> | <span class="type">NULL</span>                  | <span class="type">NULL</span>                |          <span class="type">3</span> |                  <span class="type">40</span> | <span class="type">NULL</span>                    | <span class="type">NULL</span></span><br><span class="line">    |                 <span class="type">0</span> |                 <span class="type">1</span> |                <span class="type">2</span> |                  <span class="type">1136</span> |               <span class="type">3</span> |                 <span class="type">1</span> |                       <span class="type">0</span> | <span class="type">REPEATABLE</span> READ</span><br><span class="line">     |                 <span class="type">1</span> |                      <span class="type">1</span> | <span class="type">NULL</span>                       |                <span class="type">0</span> |                          <span class="type">0</span> |<span class="type"></span></span><br><span class="line"><span class="type">+--------+-----------+---------------------+-----------------------+---------------------+------------+---------------------+-------------------------+---------------------+-------------------+-------------------+------------------+-----------------------+-----------------+-------------------+-------------------------+---------------------+-------------------+------------------------+----------------------------+------------------+----------------------------+</span></span><br><span class="line"><span class="type">2</span> rows <span class="built_in">in</span> <span class="built_in">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<h3 id="2-4-4-当前出现的锁"><a href="#2-4-4-当前出现的锁" class="headerlink" title="(2.4.4) 当前出现的锁"></a>(2.4.4) 当前出现的锁</h3><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;  SELECT * FROM information_schema.INNODB_LOCKs;</span><br><span class="line">+--------------+-------------+-----------+-----------+------------+------------+------------+-----------+----------+-----------+</span><br><span class="line">| <span class="type">lock_id</span>      | <span class="type">lock_trx_id</span> | <span class="type">lock_mode</span> | <span class="type">lock_type</span> | <span class="type">lock_table</span> | <span class="type">lock_index</span> | <span class="type">lock_space</span> | <span class="type">lock_page</span> | <span class="type">lock_rec</span> | <span class="type">lock_data</span> |<span class="type"></span></span><br><span class="line"><span class="type">+--------------+-------------+-----------+-----------+------------+------------+------------+-----------+----------+-----------+</span></span><br><span class="line"><span class="type">| 23312</span>:<span class="number">78</span>:<span class="number">3</span>:<span class="number">2</span> | <span class="type">23312</span>       | <span class="type">X</span>         | <span class="type">RECORD</span>    | <span class="type">`test</span>`.`t` | <span class="type">PRIMARY</span>    |         <span class="type">78</span> |         <span class="type">3</span> |        <span class="type">2</span> | <span class="type">1</span>         |<span class="type"></span></span><br><span class="line"><span class="type">| 23311</span>:<span class="number">78</span>:<span class="number">3</span>:<span class="number">2</span> | <span class="type">23311</span>       | <span class="type">X</span>         | <span class="type">RECORD</span>    | <span class="type">`test</span>`.`t` | <span class="type">PRIMARY</span>    |         <span class="type">78</span> |         <span class="type">3</span> |        <span class="type">2</span> | <span class="type">1</span>         |<span class="type"></span></span><br><span class="line"><span class="type">+--------------+-------------+-----------+-----------+------------+------------+------------+-----------+----------+-----------+</span></span><br><span class="line"><span class="type">2</span> rows <span class="built_in">in</span> <span class="built_in">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<h3 id="2-4-5-锁等待的对应关系"><a href="#2-4-5-锁等待的对应关系" class="headerlink" title="(2.4.5) 锁等待的对应关系"></a>(2.4.5) 锁等待的对应关系</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;  SELECT * FROM information<span class="emphasis">_schema.INNODB_</span>LOCK<span class="emphasis">_waits;</span></span><br><span class="line"><span class="emphasis">+-------------------+-------------------+-----------------+------------------+</span></span><br><span class="line"><span class="emphasis">| requesting_</span>trx<span class="emphasis">_id | requested_</span>lock<span class="emphasis">_id | blocking_</span>trx<span class="emphasis">_id | blocking_</span>lock<span class="emphasis">_id |</span></span><br><span class="line"><span class="emphasis">+-------------------+-------------------+-----------------+------------------+</span></span><br><span class="line"><span class="emphasis">| 23312             | 23312:78:3:2      | 23311           | 23311:78:3:2     |</span></span><br><span class="line"><span class="emphasis">+-------------------+-------------------+-----------------+------------------+</span></span><br><span class="line"><span class="emphasis">1 row in set (0.00 sec)</span></span><br></pre></td></tr></table></figure>
<h3 id="2-4-6-删除事务表中的事务"><a href="#2-4-6-删除事务表中的事务" class="headerlink" title="(2.4.6) 删除事务表中的事务"></a>(2.4.6) 删除事务表中的事务</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;   SELECT   p.id,   p.time,         i.trx<span class="emphasis">_id,       i.trx_</span>state,    p.info FROM     INFORMATION<span class="emphasis">_SCHEMA.PROCESSLIST p,       INFORMATION_</span>SCHEMA.INNODB<span class="emphasis">_TRX  i WHERE p.id = i.trx_</span>mysql<span class="emphasis">_thread_</span>id    AND i.trx<span class="emphasis">_state = 'LOCK WAIT';</span></span><br><span class="line"><span class="emphasis">+----+------+--------+-----------+-------------------------+</span></span><br><span class="line"><span class="emphasis">| id | time | trx_</span>id | trx<span class="emphasis">_state | info                    |</span></span><br><span class="line"><span class="emphasis">+----+------+--------+-----------+-------------------------+</span></span><br><span class="line"><span class="emphasis">| 41 |   27 | 23312  | LOCK WAIT | delete from t where c=1 |</span></span><br><span class="line"><span class="emphasis">+----+------+--------+-----------+-------------------------+</span></span><br><span class="line"><span class="emphasis">1 row in set (0.01 sec)</span></span><br></pre></td></tr></table></figure>
<h3 id="2-4-7-kill掉锁表的语句"><a href="#2-4-7-kill掉锁表的语句" class="headerlink" title="(2.4.7) kill掉锁表的语句"></a>(2.4.7) kill掉锁表的语句</h3><p>这儿有两种观点，一种是只kill掉后面等待的那个语句。还有一种是把两个语句都kill掉。这个根据实际情况处理。</p>
<figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; kill <span class="number">41</span> ;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> <span class="built_in">sec</span>)</span><br><span class="line"></span><br><span class="line">mysql&gt;   SELECT   p.id,   p.time,         <span class="built_in">i</span>.trx_id,       <span class="built_in">i</span>.trx_state,    p.info FROM     INFORMATION_SCHEMA.PROCESSLIST p,       INFORMATION_SCHEMA.INNODB_TRX  <span class="built_in">i</span> WHERE p.id = <span class="built_in">i</span>.trx_mysql_thread_id    AND <span class="built_in">i</span>.trx_state = <span class="string">'LOCK WAIT'</span>;</span><br><span class="line">Empty set (<span class="number">0.01</span> <span class="built_in">sec</span>)</span><br></pre></td></tr></table></figure>
<p>杀掉41</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show processlist ;</span><br><span class="line">+----+-------------+-----------------+------+---------+------+--------------------------+------------------+----------+</span><br><span class="line">| Id |<span class="built_in"> User </span>       | Host            | db   | Command | Time | State                    | <span class="builtin-name">Info</span>             | Progress |</span><br><span class="line">+----+-------------+-----------------+------+---------+------+--------------------------+------------------+----------+</span><br><span class="line">|  1 |<span class="built_in"> system user </span>|                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | InnoDB purge worker      | <span class="literal">NULL</span>             |    0.000 |</span><br><span class="line">|  2 |<span class="built_in"> system user </span>|                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | InnoDB purge worker      | <span class="literal">NULL</span>             |    0.000 |</span><br><span class="line">|  3 |<span class="built_in"> system user </span>|                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | InnoDB purge coordinator | <span class="literal">NULL</span>             |    0.000 |</span><br><span class="line">|  4 |<span class="built_in"> system user </span>|                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | InnoDB purge worker      | <span class="literal">NULL</span>             |    0.000 |</span><br><span class="line">|  5 |<span class="built_in"> system user </span>|                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | InnoDB shutdown handler  | <span class="literal">NULL</span>             |    0.000 |</span><br><span class="line">| 15 | root        | localhost:49914 | <span class="literal">NULL</span> | Query   |    0 | Init                     | show processlist |    0.000 |</span><br><span class="line">| 40 | root        | localhost:50872 | test | Sleep   |   56 |                          | <span class="literal">NULL</span>             |    0.000 |</span><br><span class="line">+----+-------------+-----------------+------+---------+------+--------------------------+------------------+----------+</span><br><span class="line">7 rows <span class="keyword">in</span> <span class="builtin-name">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>然后到第3个shell窗口查看，可以看到</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql delete from t where c=1 ;</span><br><span class="line"><span class="keyword">ERROR </span>1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure>
<p>因为第3个shell里执行的语句被kill掉了。</p>
<p>到这儿可以看到死锁解决了。</p>
<p>但其实有个问题。第3个shell里的语句被kill掉了。但第2个shell里的语句还在执行。如果第二个shell里的事务不提交或者kill，在第3个shell里执行删除语句还会造成锁表。</p>
<p>第二种观点的办法</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">SELECT</span><br><span class="line">	p.id,</span><br><span class="line">	p.time,</span><br><span class="line">	<span class="keyword">x</span>.trx_id,</span><br><span class="line">	<span class="keyword">x</span>.trx_state,</span><br><span class="line">	p.info </span><br><span class="line">FROM</span><br><span class="line">	INFORMATION_SCHEMA.PROCESSLIST p,</span><br><span class="line">	INFORMATION_SCHEMA.INNODB_TRX  <span class="keyword">x</span> </span><br><span class="line">WHERE</span><br><span class="line">	p.id = <span class="keyword">x</span>.trx_mysql_thread_id  <span class="comment">;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT   p.id,   p.time,         x.trx<span class="emphasis">_id,       x.trx_</span>state,    p.info FROM     INFORMATION<span class="emphasis">_SCHEMA.PROCESSLIST p,       INFORMATION_</span>SCHEMA.INNODB<span class="emphasis">_TRX  x WHERE</span></span><br><span class="line"><span class="emphasis">p.id = x.trx_</span>mysql<span class="emphasis">_thread_</span>id  ;</span><br><span class="line"><span class="code">+----+</span>------<span class="code">+--------+</span>-----------<span class="code">+-------------------------+</span></span><br><span class="line">| id | time | trx<span class="emphasis">_id | trx_</span>state | info                    |</span><br><span class="line"><span class="code">+----+</span>------<span class="code">+--------+</span>-----------<span class="code">+-------------------------+</span></span><br><span class="line">| 42 |    3 | 23317  | LOCK WAIT | delete from t where c=1 |</span><br><span class="line">| 40 | 1792 | 23311  | RUNNING   | NULL                    |</span><br><span class="line"><span class="code">+----+</span>------<span class="code">+--------+</span>-----------<span class="code">+-------------------------+</span></span><br><span class="line">2 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure>
<p>然后同时杀掉 40 42 就可以。</p>
<h1 id="3-MySQL中的锁"><a href="#3-MySQL中的锁" class="headerlink" title="(3) MySQL中的锁"></a>(3) MySQL中的锁</h1><p> 数据库锁设计的初衷是处理并发问题。作为多用户共享的资源，当出现并发访问的时候，数据库需要合理地控制资源的访问规则。而锁就是用来实现这些访问规则的重要数据结构。<br> 根据加锁的范围，MySQL 里面的锁大致可以分成全局锁、表级锁和行锁三类。</p>
<h2 id="3-1-全局锁"><a href="#3-1-全局锁" class="headerlink" title="(3.1) 全局锁"></a>(3.1) 全局锁</h2><p>全局锁就是对整个数据库实例加锁。MySQL 提供了一个加全局读锁的方法，命令是 Flush tables with read lock (FTWRL)。当你需要让整个库处于只读状态的时候，可以使用这个命令，之后其他线程的以下语句会被阻塞：数据更新语句（数据的增删改）、数据定义语句（包括建表、修改表结构等）和更新类事务的提交语句。</p>
<p><strong>全局锁的典型使用场景是，做全库逻辑备份。</strong> 也就是把整库每个表都 select 出来存成文本。</p>
<p>风险：<br>1.如果在主库备份，在备份期间不能更新，业务停摆<br>2.如果在从库备份，备份期间不能执行主库同步的binlog，导致主从延迟</p>
<p>官方自带的逻辑备份工具是 mysqldump。当 mysqldump 使用参数–single-transaction 的时候，导数据之前就会启动一个事务，来确保拿到一致性视图。而由于 MVCC 的支持，这个过程中数据是可以正常更新的。<br>你一定在疑惑，有了mysqldump这个功能，为什么还需要 FTWRL 呢？一致性读是好，但前提是引擎要支持这个隔离级别。比如，对于 MyISAM 这种不支持事务的引擎，如果备份过程中有更新，总是只能取到最新的数据，那么就破坏了备份的一致性。这时，我们就需要使用 FTWRL 命令了。<br>比如，对于 MyISAM 这种不支持事务的引擎，如果备份过程中有更新，总是只能取到最新的数据，那么就破坏了备份的一致性。这时，我们就需要使用 FTWRL 命令了。<br>single-transaction 方法只适用于所有的表使用事务引擎的库。如果有的表使用了不支持事务的引擎，那么备份就只能通过 FTWRL 方法。这往往是 DBA 要求业务开发人员使用 InnoDB 替代 MyISAM 的原因之一。</p>
<p>全局锁主要用在逻辑备份过程中。对于全部是 InnoDB 引擎的库，建议你选择使用 <code>–single-transaction</code> 参数，对应用会更友好。</p>
<h2 id="3-2-表级锁"><a href="#3-2-表级锁" class="headerlink" title="(3.2) 表级锁"></a>(3.2) 表级锁</h2><p>MySQL 里面表级别的锁有两种：一种是表锁，一种是元数据锁（meta data lock，MDL)。</p>
<p>表锁是在Server层实现的。ALTER TABLE之类的语句会使用表锁，忽略存储引擎的锁机制。</p>
<p><strong>表锁的语法是 lock tables … read/write。</strong> 与 FTWRL 类似，可以用 unlock tables 主动释放锁，也可以在客户端断开的时候自动释放。需要注意，lock tables 语法除了会限制别的线程的读写外，也限定了本线程接下来的操作对象。</p>
<p>举个例子, 如果在某个线程 A 中执行 lock tables t1 read, t2 write; 这个语句，则其他线程写 t1、读写 t2 的语句都会被阻塞。同时，线程 A 在执行 unlock tables 之前，也只能执行读 t1、读写 t2 的操作。连写 t1 都不允许，自然也不能访问其他表。</p>
<p>在还没有出现更细粒度的锁的时候，表锁是最常用的处理并发的方式。而对于 InnoDB 这种支持行锁的引擎，一般不使用 lock tables 命令来控制并发，毕竟锁住整个表的影响面还是太大。</p>
<p><strong>另一类表级的锁是 MDL（metadata lock)。</strong><br>MDL 不需要显式使用，在访问一个表的时候会被自动加上。MDL 的作用是，保证读写的正确性。你可以想象一下，如果一个查询正在遍历一个表中的数据，而执行期间另一个线程对这个表结构做变更，删了一列，那么查询线程拿到的结果跟表结构对不上，肯定是不行的。</p>
<p>因此，在 MySQL 5.5 版本中引入了 MDL，当对一个表做增删改查操作的时候，加 MDL 读锁；当要对表做结构变更操作的时候，加 MDL 写锁。</p>
<p>读锁之间不互斥，因此你可以有多个线程同时对一张表增删改查。</p>
<p>读写锁之间、写锁之间是互斥的，用来保证变更表结构操作的安全性。因此，如果有两个线程要同时给一个表加字段，其中一个要等另一个执行完才能开始执行。</p>
<p>你现在应该知道了，事务中的 MDL 锁，在语句执行开始时申请，但是语句结束后并不会马上释放，而会等到整个事务提交后再释放。</p>
<p>给一个表加字段，或者修改字段，或者加索引，需要扫描全表的数据。在对大表操作的时候，你肯定会特别小心，以免对线上服务造成影响。而实际上，即使是小表，操作不慎也会出问题。在修改表的时候会持有MDL写锁，如果这个表上的查询语句频繁，而且客户端有重试机制，也就是说超时后会再起一个新 session 再请求的话，这个库的线程很快就会爆满。</p>
<p>如何安全地给表加字段？<br>首先我们要解决长事务，事务不提交，就会一直占着 MDL 锁。在 MySQL 的 information_schema 库的 innodb_trx 表中，你可以查到当前执行中的事务。如果你要做 DDL 变更的表刚好有长事务在执行，要考虑先暂停 DDL，或者 kill 掉这个长事务。<br>这时候 kill 可能未必管用，因为新的请求马上就来了。比较理想的机制是，在 alter table 语句里面设定等待时间，如果在这个指定的等待时间里面能够拿到 MDL 写锁最好，拿不到也不要阻塞后面的业务语句，先放弃。之后开发人员或者 DBA 再通过重试命令重复这个过程。<br>MariaDB 已经合并了 AliSQL 的这个功能，所以这两个开源分支目前都支持 DDL NOWAIT/WAIT n 这个语法。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> tbl_name <span class="keyword">NOWAIT</span> <span class="keyword">add</span> <span class="keyword">column</span> ...ALTER <span class="keyword">TABLE</span> tbl_name <span class="keyword">WAIT</span> N <span class="keyword">add</span> <span class="keyword">column</span> ...</span><br></pre></td></tr></table></figure>
<p>MDL 是并发情况下维护数据的一致性,在表上有事务的时候,不可以对元数据经行写入操作,并且这个是在server层面实现的<br>当你做 dml 时候增加的 MDL 读锁, update table set id=Y where id=X; 并且由于隔离级别的原因 读锁之间不冲突</p>
<p>当你DDL 时候 增加对表的写锁, 同时操作两个alter table 操作 这个要出现等待情况。</p>
<p>但是 如果是 dml 与ddl 之间的交互 就更容易出现不可读写情况,这个情况容易session 爆满,session是占用内存的,也会导致内存升高<br>MDL 释放的情况就是 事务提交.</p>
<h2 id="3-3-行锁"><a href="#3-3-行锁" class="headerlink" title="(3.3) 行锁"></a>(3.3) 行锁</h2><p>MySQL 的行锁是在引擎层由各个引擎自己实现的。但并不是所有的引擎都支持行锁，比如 MyISAM 引擎就不支持行锁。不支持行锁意味着并发控制只能使用表锁，对于这种引擎的表，同一张表上任何时刻只能有一个更新在执行，这就会影响到业务并发度。InnoDB 是支持行锁的，这也是 MyISAM 被 InnoDB 替代的重要原因之一。</p>
<p>在 InnoDB 事务中，行锁是在需要的时候才加上的，但并不是不需要了就立刻释放，而是要等到事务结束时才释放。这个就是两阶段锁协议。<br>知道了这个设定，对我们使用事务有什么帮助呢？那就是，如果你的事务中需要锁多个行，要把最可能造成锁冲突、最可能影响并发度的锁尽量往后放。</p>
<p>假设你负责实现一个电影票在线交易业务，顾客 A 要在影院 B 购买电影票。我们简化一点，这个业务需要涉及到以下操作：</p>
<ol>
<li><p>从顾客 A 账户余额中扣除电影票价；</p>
</li>
<li><p>给影院 B 的账户余额增加这张电影票价；</p>
</li>
<li><p>记录一条交易日志。</p>
<p>试想如果同时有另外一个顾客 C 要在影院 B 买票，那么这两个事务冲突的部分就是语句 2 了。因为它们要更新同一个影院账户的余额，需要修改同一行数据。<br>根据两阶段锁协议，不论你怎样安排语句顺序，所有的操作需要的行锁都是在事务提交的时候才释放的。所以，如果你把语句 2 安排在最后，比如按照 3、1、2 这样的顺序，那么影院账户余额这一行的锁时间就最少。这就最大程度地减少了事务之间的锁等待，提升了并发度。</p>
</li>
</ol>
<p>当并发系统中不同线程出现循环资源依赖，涉及的线程都在等待别的线程释放资源时，就会导致这几个线程都进入无限等待的状态，称为死锁。这里我用数据库中的行锁举个例子。</p>
<p>当出现死锁以后，有两种策略：</p>
<ol>
<li><p>一种策略是，直接进入等待，直到超时。这个超时时间可以通过参数 <code>innodb_lock_wait_timeout</code> 来设置。</p>
</li>
<li><p>另一种策略是，发起死锁检测，发现死锁后，主动回滚死锁链条中的某一个事务，让其他事务得以继续执行。将参数 <code>innodb_deadlock_detect</code> 设置为 on，表示开启这个逻辑。</p>
<p>在 InnoDB 中，innodb_lock_wait_timeout 的默认值是 50s，意味着如果采用第一个策略，当出现死锁以后，第一个被锁住的线程要过 50s 才会超时退出，然后其他线程才有可能继续执行。对于在线服务来说，这个等待时间往往是无法接受的。</p>
</li>
</ol>
<p>你可以考虑通过将一行改成逻辑上的多行来减少锁冲突。还是以影院账户为例，可以考虑放在多条记录上，比如 10 个记录，影院的账户总额等于这 10 个记录的值的总和。这样每次要给影院账户加金额的时候，随机选其中一条记录来加。这样每次冲突概率变成原来的 1/10，可以减少锁等待个数，也就减少了死锁检测的 CPU 消耗。</p>
<h1 id="4-可能遇到的问题"><a href="#4-可能遇到的问题" class="headerlink" title="(4) 可能遇到的问题"></a>(4) 可能遇到的问题</h1><h2 id="4-1-备份一般都会在备库上执行，你在用–single-transaction-方法做逻辑备份的过程中，如果主库上的一个小表做了一个-DDL，比如给一个表上加了一列。这时候，从备库上会看到什么现象呢？"><a href="#4-1-备份一般都会在备库上执行，你在用–single-transaction-方法做逻辑备份的过程中，如果主库上的一个小表做了一个-DDL，比如给一个表上加了一列。这时候，从备库上会看到什么现象呢？" class="headerlink" title="(4.1) 备份一般都会在备库上执行，你在用–single-transaction 方法做逻辑备份的过程中，如果主库上的一个小表做了一个 DDL，比如给一个表上加了一列。这时候，从备库上会看到什么现象呢？"></a>(4.1) 备份一般都会在备库上执行，你在用–single-transaction 方法做逻辑备份的过程中，如果主库上的一个小表做了一个 DDL，比如给一个表上加了一列。这时候，从备库上会看到什么现象呢？</h2><p>备份一般都会在备库上执行，你在用–single-transaction 方法做逻辑备份的过程中，如果主库上的一个小表做了一个 DDL，比如给一个表上加了一列。这时候，从备库上会看到什么现象呢？</p>
<p>假设这个 DDL 是针对表 t1 的， 这里我把备份过程中几个关键的语句列出来：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Q1:<span class="keyword">SET</span> <span class="keyword">SESSION</span> <span class="keyword">TRANSACTION</span> <span class="keyword">ISOLATION</span> <span class="keyword">LEVEL</span> REPEATABLE <span class="keyword">READ</span>;Q2:<span class="keyword">START</span> <span class="keyword">TRANSACTION</span>  <span class="keyword">WITH</span> <span class="keyword">CONSISTENT</span> <span class="keyword">SNAPSHOT</span>；<span class="comment">/* other tables */</span>Q3:<span class="keyword">SAVEPOINT</span> sp;<span class="comment">/* 时刻 1 */</span>Q4:<span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> <span class="string">`t1`</span>;<span class="comment">/* 时刻 2 */</span>Q5:<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="string">`t1`</span>;<span class="comment">/* 时刻 3 */</span>Q6:<span class="keyword">ROLLBACK</span> <span class="keyword">TO</span> <span class="keyword">SAVEPOINT</span> sp;<span class="comment">/* 时刻 4 */</span><span class="comment">/* other tables */</span></span><br></pre></td></tr></table></figure>
<p>在备份开始的时候，为了确保 RR（可重复读）隔离级别，再设置一次 RR 隔离级别 (Q1);<br>启动事务，这里用 WITH CONSISTENT SNAPSHOT 确保这个语句执行完就可以得到一个一致性视图（Q2)；<br>设置一个保存点，这个很重要（Q3）；<br>show create 是为了拿到表结构 (Q4)，然后正式导数据 （Q5），回滚到 SAVEPOINT sp，在这里的作用是释放 t1 的 MDL 锁 （Q6）。当然这部分属于“超纲”，上文正文里面都没提到。<br>DDL 从主库传过来的时间按照效果不同，我打了四个时刻。题目设定为小表，我们假定到达后，如果开始执行，则很快能够执行完成。</p>
<p>参考答案如下：</p>
<ol>
<li><p>如果在 Q4 语句执行之前到达，现象：没有影响，备份拿到的是 DDL 后的表结构。</p>
</li>
<li><p>如果在“时刻 2”到达，则表结构被改过，Q5 执行的时候，报 Table definition has changed, please retry transaction，现象：mysqldump 终止；</p>
</li>
<li><p>如果在“时刻 2”和“时刻 3”之间到达，mysqldump 占着 t1 的 MDL 读锁，binlog 被阻塞，现象：主从延迟，直到 Q6 执行完成。</p>
</li>
<li><p>从“时刻 4”开始，mysqldump 释放了 MDL 读锁，现象：没有影响，备份拿到的是 DDL 前的表结构。</p>
</li>
</ol>
<h2 id="4-2-删数据问题"><a href="#4-2-删数据问题" class="headerlink" title="(4.2) 删数据问题"></a>(4.2) 删数据问题</h2><p>如果你要删除一个表里面的前 10000 行数据，有以下三种方法可以做到：<br>第一种，直接执行 delete from T limit 10000;<br>第二种，在一个连接中循环执行 20 次 delete from T limit 500;<br>第三种，在 20 个连接中同时执行 delete from T limit 500。</p>
<p>你会选择哪一种方法呢？为什么呢？</p>
<p>方案一，事务相对较长，则占用锁的时间较长，会导致其他客户端等待资源时间较长。<br>方案二，串行化执行，将相对长的事务分成多次相对短的事务，则每次事务占用锁的时间相对较短，其他客户端在等待相应资源的时间也较短。这样的操作，同时也意味着将资源分片使用（每次执行使用不同片段的资源），可以提高并发性。<br>方案三，人为自己制造锁竞争，加剧并发量。</p>
<h2 id="4-3-问题3"><a href="#4-3-问题3" class="headerlink" title="(4.3) 问题3"></a>(4.3) 问题3</h2><p>1.如何在死锁发生时,就把发生的sql语句抓出来？<br>2.在使用连接池的情况下,连接会复用.比如一个业务使用连接set sql_select_limit=1,释放掉以后.其他业务复用该连接时,这个参数也生效.请问怎么避免这种情况,或者怎么禁止业务set session？<br>3.很好奇双11的成交额,是通过redis累加的嘛？<br>4.不会改源码能成为专家嘛？</p>
<ol>
<li>show engine innodb status 里面有信息，不过不是很全…</li>
<li>5.7的reset_connection接口可以考虑一下</li>
<li>用redis的话，为了避免超卖需要增加了很多机制来保证。修改都在数据库里执行就方便点。前提是要解决热点问题</li>
<li>我认识几位处理问题和分析问题经验非常丰富的专家，不用懂源码，但是原理还是要很清楚的</li>
</ol>
<h2 id="4-4-转义导致死锁问题"><a href="#4-4-转义导致死锁问题" class="headerlink" title="(4.4) 转义导致死锁问题"></a>(4.4) 转义导致死锁问题</h2><p>前天在开发中，还遇到过一次死锁，是在一个批处理中，要删除1000条数据，5个线程，200条数据commit一次，<br>sol：delete from 表A where id =15426169754750004759008 STORAGEDB<br>(id是主键)<br>我同事解决了，说原因是id 是char 类型，但是没有加单引号，所以没有进入id索引中，然后锁表了，所以导致死锁。</p>
<p>这个问题的出现，应该是人为只要并发导致锁冲突吧？但是为什么不加单引号会死锁，加了单引号就能正常跑呢？</p>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><p>[1] <a href="https://blog.csdn.net/dujianxiong/article/details/90770301" target="_blank" rel="noopener">Mysql 锁、事务强制手动kill/释放</a><br>[2] <a href="https://time.geekbang.org/column/article/74687" target="_blank" rel="noopener">19 | 为什么我只查一行的语句，也执行这么慢？MySQL实战45讲</a><br>[3] <a href="https://time.geekbang.org/column/article/69862" target="_blank" rel="noopener">06 | 全局锁和表锁 ：给表加个字段怎么有这么多阻碍？MySQL实战45讲</a><br>[4] <a href="https://time.geekbang.org/column/article/70215" target="_blank" rel="noopener">07 | 行锁功过：怎么减少行锁对性能的影响？MySQL实战45讲</a><br>[5] <a href="https://dev.mysql.com/doc/refman/5.7/en/lock-tables.html" target="_blank" rel="noopener">mysql 5.7 lock-tables</a><br>[6] 《高性能MySQL》 O’REILLY</p>
<p>转发自： <a href="http://weikeqin.com/2019/09/05/mysql-lock-table-solution/" target="_blank" rel="noopener">MySQL 锁表后快速解决方法 及 锁表原因</a></p>


                <hr>

                

                <ul class="pager">
                    
                    
                        <li class="next">
                            <a href="/acme-sh-and-win-acme/" data-toggle="tooltip" data-placement="top" title="Linux acme.sh 和 Windows win-acme 免费SSL证书">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                

                

            </div>
    <!-- Side Catalog Container -->
        

    <!-- Sidebar Container -->

            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#mysql" title="mysql">mysql</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="https://jaminzhang.github.io" target="_blank">JAMIN ZHANG</a></li>
                    
                        <li><a href="#" target="_blank">It helps SEO</a></li>
                    
                </ul>
                
            </div>

        </div>
    </div>
</article>







<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcdn.net/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                

                

                

                
                    <li>
                        <a target="_blank"  href="https://github.com/sundayle">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    版本所有 &copy; SundayLe 2020 
                    <br>
                    Theme by <a href="http://huangxuan.me">Hux</a> 
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span>
                    <!-- Ported by <a href="https://github.com/Kaijun/hexo-theme-huxblog">Kaijun</a> -->
                    <a href="http://www.beian.miit.gov.cn">粤ICP备18160044号</a>
            <!-- 
                    Ported by <a href="http://blog.kaijun.rocks">Kaijun</a> | 
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=kaijun&repo=hexo-theme-huxblog&type=star&count=true" >
                    </iframe>
            -->
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
     async("https://cdn.bootcdn.net/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->


<script>
    // dynamic User by Hux
    var _gaId = 'UA-70699634-1';
    var _gaDomain = 'auto';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>




<!-- Baidu Tongji -->


<!-- Side Catalog -->





<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
