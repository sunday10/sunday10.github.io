<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Linux运维笔记">
    <meta name="keyword"  content="sunday,sundayhk,sundayle,sunday博客,Linxu,运维">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
          MogileFS 分布式存储 - Sunday博客 | Sunday Blog
        
    </title>

    <link rel="canonical" href="http://www.sundayle.com/mogilefs/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Sunday</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/archives/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    
<!-- Image to hack wechat -->
<!-- <img src="http://www.sundayle.com/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="{{ site.baseurl }}/{% if page.header-img %}{{ page.header-img }}{% else %}{{ site.header-img }}{% endif %}" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        background-image: url('/img/home-bg.jpg')
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                          <a class="tag" href="/tags/#分布式" title="分布式">分布式</a>
                        
                          <a class="tag" href="/tags/#mogilefs" title="mogilefs">mogilefs</a>
                        
                    </div>
                    <h1>MogileFS 分布式存储</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        Posted by Sunday on
                        2018-09-07
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <h1 id="什么是分布式存储"><a href="#什么是分布式存储" class="headerlink" title="什么是分布式存储"></a>什么是分布式存储</h1><p>分布式存储系统，是将数据分散存储在多台独立的设备上。传统的网络存储系统采用集中的存储服务器存放所有数据，存储服务器成为系统性能的瓶颈，也是可靠性和安全性的焦点，不能满足大规模存储应用的需要。分布式网络存储系统采用可扩展的系统结构，利用多台存储服务器分担存储负荷，利用位置服务器定位存储信息，它不但提高了系统的可靠性、可用性和存取效率，还易于扩展</p>
<h1 id="CAP理论"><a href="#CAP理论" class="headerlink" title="CAP理论"></a>CAP理论</h1><p>C：Consistency（一致性） 任何一个读操作总是能够读取之前完成的写操作。<br>A：Availability（可用性） 每一次操作总是能够在确定的时间返回。<br>P： Partition Tolerance ( 分区容错性 ) 在出现网络分区的情况下，仍然能够满足一致性和可用性。</p>
<p>有科学家都在致力于 CAP 三元素并存的时候，Eric.Brewer教授指出 CAP 永远无法兼顾，只能根据具体应用来权衡和取舍，并且至多两个元素可以共存，后来由两位麻省理工学院的科学家证明此观点是具有前瞻性的，由此形成Brewer的 CAP定理 。</p>
<p>正所谓鱼和熊掌不可兼得，关注一致性就需要处理因系统不可用而带来写操作失败的情况，反之关注可用性就无法保证每次都能读取到最新的写入操作。传统 关系型数据库 侧重于CA ，而 非关系型键值数据库 则侧重于 AP 。</p>
<p><strong> 强一致性(ACID) </strong>：在单机环境中，强一致性可以由数据库的事务来保证；在分布式环境中，强一致性很难做到，即便是做到也会因为分布式事物所带来的性能低下，不适合在互联网的环境中应用。</p>
<p><strong> 弱一致性(包括最终一致性) </strong>： 系统不能保证后续访问返回最新的值，在访问到最新值之前这段时间称之为 不一致窗口 。</p>
<p><strong> 最终一致性 </strong>：是弱一致性的一种特例，存储系统保证如果对象有多次更新，在渡过 不一致窗口之后必将放回最后更新的值。</p>
<h1 id="MogilesFS介绍"><a href="#MogilesFS介绍" class="headerlink" title="MogilesFS介绍"></a>MogilesFS介绍</h1><p><strong> MogilesFS简介 </strong></p>
<p>MogileFS是一个开源的分布式文件系统，用于组建分布式文件集群，由LiveJournal旗下DangaInteractive公司开发，Danga团队开发了包括 Memcached、MogileFS、Perlbal等不错的开源项目：(注：Perlbal是一个强大的Perl写的反向代理服务器)。MogileFS是一个开源的分布式文件系统。<br>目前使用 MogileFS 的公司非常多,比如国外的一些公司,日本前几名的公司基本都在使用这个，国内所知道的使用 MogileFS 的公司有图片托管网站 yupoo又拍,digg, 土豆, 豆瓣,1 号店, 大众点评,搜狗,安居客等等网站.分别为所在的组织或公司管理着海量的图片。</p>
<p><strong> MogileFS特性 </strong></p>
<p>1 ) 支持多节点冗余<br>2）可实现自动的文件复制<br>3）使用名称空间（命名空间），每个文件通过key来确定，比如123.jpg是一个key，真正存储的位置可能是/000/000/00/01/md5hash.fid<br>4）不需要RAID，应用层可直接实现RAID，不共享任何东西，通过”集群接口”提供服务<br>5）工作于应用层，没有特殊的组件要求<br>6）不用共享任何数据，MogileFS不需要依靠昂贵的SAN来共享磁盘，每个机器只用维护好自己的磁盘</p>
<p><strong> MogileFS的工作原理 </strong><br><img src="http://himg.sundayle.com/static/images/mogilefs-33.jpg"></p>
<p><strong> MogileFS的架构 </strong><br>MogileFS主要由三部分构成：tracker节点、database节点、storage节点</p>
<p>1）<code>Tracker–跟踪器，调度器</code><br>MogileFS的核心，是一个调度器，mogilefsd进程就是trackers进程程序,trackers的主要职责有：删除数据、复制数据、监控、查询等等，这个是基于事件的( event-based ) 父进程/消息总线来管理所有来自于客户端应用的交互, 包括将请求负载平衡到多个”query workers”中,然后让 mogilefs的子进程去处理，mogadm,mogtool的所有操作都要跟trackers打交道,Client的一些操作也需要定义好trackers,因此最好同时运行多个trackers来做负载均衡，trackers也可以只运行在一台机器上，使用负载均衡时可以使用一些简单的负载均衡解决方案，如haproxy，lvs，nginx等，tarcker的配置文件为/etc/mogilefs/mogilefsd.conf，监听在TCP的7001端口</p>
<p>2）<code>Database–数据库部分</code><br>主要用来存储mogilefs的元数据（命名空间和文件在哪里等），是trackers来操作和管理它，可以用mogdbsetup程序来初始化数据库，所有的元数据都存储在数据库中，因此，这个数据相当重要，如果数据库挂掉，所有的数据都不能用于访问，因此，建议应该对数据库做高可用</p>
<p>3）<code>storage–存储节点</code><br>这个是MogileFS存储数据的真正节点，也是mogstored节点，也叫storage server，一台存储节点要启动一个mogstored服务，扩容就是增加这些主机节点实际存放数据的地方<br>配置文件为/etc/mogilefs/mogstored.conf，监听在TCP的7500端口</p>
<p><strong> MogileFS管理 </strong><br>1、Domain:一个mogilefs可以有多个domain，用来存放不同文件（大小、类型），同一个domain内key必须唯一，不同domain内key可以是相同的<br>2、每个存储节点称为一个host主机，一个主机上可以有多个存储设备dev（单独的硬盘），每个设备都有一个ID号，Domain+Fid来定位文件<br>3、Class：文件属性管理，复制文件的最小单位不是文件，而是class，定位文件存储在不同设备上的份数，也就是定义副本的数量</p>
<h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><p>准备三台主机</p>
<blockquote>
<p>node1: tracker节点、database节点、storage节点<br>node2: storage节点<br>node3: storage节点<br>注意关掉防火墙和selinux，iptables -F &amp;&amp; setenforce 0</p>
</blockquote>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p><strong> 安装 mogilefs-server </strong><br>三台主机下载安装 MogileFS rpm<br>链接: <a href="https://pan.baidu.com/s/1lJqligm7yQlaD6dQM2DcMg" target="_blank" rel="noopener">https://pan.baidu.com/s/1lJqligm7yQlaD6dQM2DcMg</a> 密码: m4m3<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@node0 mogilefs]# ls -l</span><br><span class="line">total <span class="number">648</span></span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root   <span class="number">1916</span> Feb <span class="number">21</span>  <span class="number">2017</span> MogileFS-Server<span class="number">-2.46</span><span class="number">-2.</span>el6.noarch.rpm</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">176308</span> Feb <span class="number">21</span>  <span class="number">2017</span> MogileFS-Server-mogilefsd<span class="number">-2.46</span><span class="number">-2.</span>el6.noarch.rpm</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root  <span class="number">26872</span> Feb <span class="number">21</span>  <span class="number">2017</span> MogileFS-Server-mogstoraged<span class="number">-2.46</span><span class="number">-2.</span>el6.noarch.rpm</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root  <span class="number">75916</span> Feb <span class="number">21</span>  <span class="number">2017</span> MogileFS-Utils<span class="number">-2.19</span><span class="number">-1.</span>el6.noarch.rpm</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root   <span class="number">5880</span> Feb <span class="number">21</span>  <span class="number">2017</span> Perlbal<span class="number">-1.78</span><span class="number">-1.</span>el6.noarch.rpm</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root   <span class="number">1624</span> Feb <span class="number">21</span>  <span class="number">2017</span> Perlbal-doc<span class="number">-1.78</span><span class="number">-1.</span>el6.noarch.rpm</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root  <span class="number">28111</span> Feb <span class="number">21</span>  <span class="number">2017</span> perl-Danga-Socket<span class="number">-1.61</span><span class="number">-1.</span>el6.rf.noarch.rpm</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root  <span class="number">30312</span> Feb <span class="number">21</span>  <span class="number">2017</span> perl-MogileFS-Client<span class="number">-1.14</span><span class="number">-1.</span>el6.noarch.rpm</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root  <span class="number">25140</span> Feb <span class="number">21</span>  <span class="number">2017</span> perl-Net-Netmask<span class="number">-1.9015</span><span class="number">-8.</span>el6.noarch.rpm</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">268620</span> Feb <span class="number">21</span>  <span class="number">2017</span> perl-Perlbal<span class="number">-1.78</span><span class="number">-1.</span>el6.noarch.rpm</span><br></pre></td></tr></table></figure></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> -y perl-Net-Netmask perl-IO-<span class="keyword">String</span> perl-<span class="keyword">Sys</span>-Syslog perl-IO-AIO</span><br><span class="line">yum <span class="keyword">install</span> -y .<span class="comment">/*</span></span><br></pre></td></tr></table></figure>
<h1 id="配置-tracker"><a href="#配置-tracker" class="headerlink" title="配置 tracker"></a>配置 tracker</h1><p><strong> tracker配置 </strong><br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/mogilefs/mogilefsd.conf </span><br><span class="line"></span><br><span class="line">db_dsn = DBI:mysql:mogilefs:host=192.168.10.101</span><br><span class="line">db_user = mogilefs</span><br><span class="line">db_pass = mogilefs</span><br><span class="line">listen = 192.168.10.101:7001</span><br></pre></td></tr></table></figure></p>
<p><strong> MySQL配置 </strong><br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">yum</span> install -y mariadb-server</span><br><span class="line">systemctl start mariadb</span><br><span class="line">MySQL [(<span class="literal">none</span>)]&gt; grant all privileges <span class="literal">on</span> <span class="regexp">mogilefs.*</span> to <span class="string">'mogilefs'</span>@<span class="string">'192.168.10.101'</span> identified by <span class="string">'mogilefs'</span>;</span><br><span class="line"><span class="attribute">MySQL</span> [(<span class="literal">none</span>)]&gt; flush privileges；</span><br><span class="line"></span><br><span class="line">mogdbsetup --dbpass=mogilefs <span class="comment">#一路按Y即可 </span></span><br><span class="line">MySQL [(<span class="literal">none</span>)]&gt; use mogilefs;</span><br><span class="line"><span class="attribute">MySQL</span> [mogilefs]&gt; show tables; <span class="comment">#查看到有表就成功了</span></span><br></pre></td></tr></table></figure></p>
<p><strong> 启动tracker服务 </strong><br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="literal">start</span> mogilefsd</span><br></pre></td></tr></table></figure></p>
<h1 id="配置-storage"><a href="#配置-storage" class="headerlink" title="配置 storage"></a>配置 storage</h1><p><strong> 创建存储目录 </strong><br>storage节点添加设备，生产环境最好单独挂载一个新的磁盘，专门用来存储数据<br>node1创建目录dev1，node2创建目录dev2，node3创建目录dev3<br>注：dev 1、2、3为设备的ID号,必须唯一。<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">mkdir</span> -p /<span class="class"><span class="keyword">data</span>/mogdata</span></span><br><span class="line"><span class="title">chown</span> -<span class="type">R</span> mogilefs.mogilefs  /<span class="class"><span class="keyword">data</span>/mogdata</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">mkdir</span> /<span class="class"><span class="keyword">data</span>/mogdata/dev1</span></span><br><span class="line"><span class="title">chown</span> -<span class="type">R</span> mogilefs.mogilefs  /<span class="class"><span class="keyword">data</span>/mogdata/dev1</span></span><br></pre></td></tr></table></figure>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/mogilefs/mogstoraged.conf </span><br><span class="line"></span><br><span class="line">maxconns = 10000</span><br><span class="line">httplisten = 0.0.0.0:7500</span><br><span class="line">mgmtlisten = 0.0.0.0:7501</span><br><span class="line">docroot = /data/mogdata</span><br></pre></td></tr></table></figure>
<p><strong> 启动storaged服务 </strong><br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="literal">start</span> mogstoraged</span><br></pre></td></tr></table></figure></p>
<h1 id="添加-管理-storage-节点"><a href="#添加-管理-storage-节点" class="headerlink" title="添加 管理 storage 节点"></a>添加 管理 storage 节点</h1><p><strong> 添加storage节点 </strong><br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mogadm <span class="attribute">--tracker</span>=192.168.10.101:7001 host <span class="builtin-name">add</span> node1 <span class="attribute">--ip</span>=192.168.10.101 <span class="attribute">--port</span>=7500 <span class="attribute">--status</span>=alive</span><br><span class="line">mogadm <span class="attribute">--tracker</span>=192.168.10.101:7001 host <span class="builtin-name">add</span> node2 <span class="attribute">--ip</span>=192.168.10.102 <span class="attribute">--port</span>=7500 <span class="attribute">--status</span>=alive</span><br><span class="line">mogadm <span class="attribute">--tracker</span>=192.168.10.101:7001 host <span class="builtin-name">add</span> node3 <span class="attribute">--ip</span>=192.168.10.103 <span class="attribute">--port</span>=7500 <span class="attribute">--status</span>=alive</span><br></pre></td></tr></table></figure></p>
<p><strong> 添加存储设备 </strong><br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mogadm <span class="attribute">--tracker</span>=192.168.10.101:7001 device <span class="builtin-name">add</span> node1 1</span><br><span class="line">mogadm <span class="attribute">--tracker</span>=192.168.10.101:7001 device <span class="builtin-name">add</span> node2 2</span><br><span class="line">mogadm <span class="attribute">--tracker</span>=192.168.10.101:7001 device <span class="builtin-name">add</span> node3 3</span><br></pre></td></tr></table></figure></p>
<p><strong>查看状态</strong><br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mogadm <span class="params">--tracker=192</span>.168.10.101<span class="function">:7001</span> check</span><br><span class="line">Checking trackers.<span class="string">..</span></span><br><span class="line">  192.168.10.101<span class="function">:7001</span> <span class="string">...</span> OK</span><br><span class="line"></span><br><span class="line">Checking hosts.<span class="string">..</span></span><br><span class="line">  [ 1] node1 <span class="string">...</span> OK</span><br><span class="line">  [ 2] node2 <span class="string">...</span> OK</span><br><span class="line">  [ 3] node3 <span class="string">...</span> OK</span><br><span class="line"></span><br><span class="line">Checking devices.<span class="string">..</span></span><br><span class="line">  host device         size<span class="params">(G)</span>    used<span class="params">(G)</span>    free<span class="params">(G)</span>   use%   ob state   I/O%</span><br><span class="line">  <span class="params">----</span> <span class="params">------------</span> <span class="params">----------</span> <span class="params">----------</span> <span class="params">----------</span> <span class="params">------</span> <span class="params">----------</span> <span class="params">-----</span></span><br><span class="line">  [ 1] dev1            16.986      2.636     14.350  15.52%  writeable   N/A</span><br><span class="line">  [ 2] dev2            16.986      1.796     15.191  10.57%  writeable   N/A</span><br><span class="line">  [ 3] dev3            16.986      1.739     15.247  10.24%  writeable   N/A</span><br><span class="line">  <span class="params">----</span> <span class="params">------------</span> <span class="params">----------</span> <span class="params">----------</span> <span class="params">----------</span> <span class="params">------</span></span><br><span class="line">             total:    50.959      6.171     44.788  12.11%</span><br></pre></td></tr></table></figure></p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mogadm --tracker=<span class="number">192.168</span><span class="meta">.10</span><span class="meta">.101</span>:<span class="number">7001</span> host list</span><br><span class="line">node1 [<span class="number">1</span>]: alive</span><br><span class="line"><span class="symbol">  IP:</span>       <span class="number">192.168</span><span class="meta">.10</span><span class="meta">.101</span>:<span class="number">7500</span></span><br><span class="line"></span><br><span class="line">node2 [<span class="number">2</span>]: alive</span><br><span class="line"><span class="symbol">  IP:</span>       <span class="number">192.168</span><span class="meta">.10</span><span class="meta">.102</span>:<span class="number">7500</span></span><br><span class="line"></span><br><span class="line">node3 [<span class="number">3</span>]: alive</span><br><span class="line"><span class="symbol">  IP:</span>       <span class="number">192.168</span><span class="meta">.10</span><span class="meta">.103</span>:<span class="number">7500</span></span><br></pre></td></tr></table></figure>
<p><strong>修改storage节点</strong><br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mogadm --trackers=<span class="number">192.168</span><span class="meta">.10</span><span class="meta">.101</span>:<span class="number">7001</span> host mark node3 <span class="meta">down</span></span><br><span class="line">mogadm --trackers=<span class="number">192.168</span><span class="meta">.10</span><span class="meta">.101</span>:<span class="number">7001</span> host list | grep node3</span><br><span class="line">node3 [<span class="number">3</span>]: <span class="meta">down</span></span><br><span class="line">mogadm --trackers=<span class="number">192.168</span><span class="meta">.10</span><span class="meta">.101</span>:<span class="number">7001</span> host mark node3 alive</span><br></pre></td></tr></table></figure></p>
<h1 id="创建域"><a href="#创建域" class="headerlink" title="创建域"></a>创建域</h1><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mogadm <span class="attribute">--trackers</span>=192.168.10.101:7001 domain <span class="builtin-name">add</span> file</span><br><span class="line">mogadm <span class="attribute">--trackers</span>=192.168.10.101:7001 domain <span class="builtin-name">add</span> img</span><br><span class="line">mogadm <span class="attribute">--trackers</span>=192.168.10.101:7001 domain list</span><br><span class="line"> domain               class                mindevcount   replpolicy   hashtype</span><br><span class="line">-------------------- -------------------- ------------- ------------ -------</span><br><span class="line"> file                <span class="built_in"> default </span>                  2        MultipleHosts() NONE   </span><br><span class="line"></span><br><span class="line"> img              <span class="built_in"> default </span>                  2        MultipleHosts() NONE</span><br></pre></td></tr></table></figure>
<p>domain：区域<br>class：复制文件的最小单位 （最大为64M,如果一个单文件超出此大小将拆分为多个class存储）<br>mindevcount：最小复制文件的份数<br>replpolicy：复制份数<br>hashtype：采用的hash的类型</p>
<h1 id="创建类"><a href="#创建类" class="headerlink" title="创建类"></a>创建类</h1><p><strong> 默认最小复制文件的份数 </strong><br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mogadm <span class="attribute">--trackers</span>=192.168.10.101:7001 class <span class="builtin-name">add</span> img png</span><br></pre></td></tr></table></figure></p>
<p><strong> 指定默认最小复制文件为3份 </strong><br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mogadm <span class="attribute">--trackers</span>=192.168.10.101:7001 class <span class="builtin-name">add</span> img jpeg <span class="attribute">--mindevcount</span>=3</span><br></pre></td></tr></table></figure></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mogadm <span class="attribute">--trackers</span>=192.168.10.101:7001 class list</span><br><span class="line"> domain               class                mindevcount   replpolicy   hashtype</span><br><span class="line">-------------------- -------------------- ------------- ------------ -------</span><br><span class="line"> file                <span class="built_in"> default </span>                  2        MultipleHosts() NONE   </span><br><span class="line"></span><br><span class="line"> img                 <span class="built_in"> default </span>                  2        MultipleHosts() NONE   </span><br><span class="line"> img                  png                       2        MultipleHosts() NONE</span><br><span class="line"> img                  jpeg                      3        MultipleHosts() NONE</span><br></pre></td></tr></table></figure>
<p><strong> class限制，不要副本 </strong><br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mogadm <span class="attribute">--trackers</span>=192.168.10.101:7001 class <span class="builtin-name">add</span> file text <span class="attribute">--mindevcount</span>=1</span><br><span class="line">mogadm <span class="attribute">--trackers</span>=192.168.10.101:7001 class list | grep text</span><br><span class="line"> file                 text                      1        MultipleHosts() NONE</span><br></pre></td></tr></table></figure></p>
<p><strong> 设置class至少3个保留副本 </strong><br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mogadm <span class="attribute">--trackers</span>=192.168.10.101:7001 class <span class="builtin-name">add</span> file html <span class="attribute">--replpolicy</span>=<span class="string">"MultipleHosts(3)"</span></span><br><span class="line">mogadm <span class="attribute">--trackers</span>=192.168.10.101:7001 class list </span><br><span class="line"> domain               class                mindevcount   replpolicy   hashtype</span><br><span class="line">-------------------- -------------------- ------------- ------------ -------</span><br><span class="line"> file                <span class="built_in"> default </span>                  2        MultipleHosts() NONE   </span><br><span class="line"> file                 html                      2        MultipleHosts(3) NONE   </span><br><span class="line"> file                 text                      1        MultipleHosts() NONE   </span><br><span class="line"></span><br><span class="line"> img                 <span class="built_in"> default </span>                  2        MultipleHosts() NONE   </span><br><span class="line"> img                  jpeg                      3        MultipleHosts() NONE   </span><br><span class="line"> img                  png                       2        MultipleHosts() NONE</span><br></pre></td></tr></table></figure></p>
<h1 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h1><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mogupload --trackers=<span class="number">192.168</span>.<span class="number">10.101</span> --domain=<span class="selector-tag">img</span> --class=png --key=<span class="string">'1.jpg'</span> --file=<span class="string">'/root/clara.jpg'</span></span><br><span class="line">mogfileinfo --trackers=<span class="number">192.168</span>.<span class="number">10.101</span>:<span class="number">7001</span> --domain=<span class="selector-tag">img</span> --key=<span class="string">'1.jpg'</span></span><br><span class="line">- file: <span class="number">1</span>.jpg</span><br><span class="line">     class:                  png</span><br><span class="line">  devcount:                    <span class="number">2</span></span><br><span class="line">    domain:                  img</span><br><span class="line">       fid:                   <span class="number">35</span></span><br><span class="line">       key:               <span class="number">1</span>.jpg</span><br><span class="line">    length:               <span class="number">183975</span></span><br><span class="line"> - http:<span class="comment">//192.168.10.101:7500/dev1/0/000/000/0000000035.fid</span></span><br><span class="line"> - http:<span class="comment">//192.168.10.103:7500/dev3/0/000/000/0000000035.fid</span></span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mogupload --trackers=<span class="number">192.168</span>.<span class="number">10.101</span>:<span class="number">7001</span> --domain=<span class="selector-tag">img</span> --class=jpeg --key=<span class="string">'2.jpg'</span> --file=<span class="string">'/root/clara.jpg'</span></span><br><span class="line">mogfileinfo --trackers=<span class="number">192.168</span>.<span class="number">10.101</span>:<span class="number">7001</span> --domain=<span class="selector-tag">img</span> --key=<span class="string">'2.jpg'</span></span><br><span class="line">- file: <span class="number">2</span>.jpg</span><br><span class="line">     class:                 jpeg</span><br><span class="line">  devcount:                    <span class="number">3</span></span><br><span class="line">    domain:                  img</span><br><span class="line">       fid:                   <span class="number">36</span></span><br><span class="line">       key:               <span class="number">2</span>.jpg</span><br><span class="line">    length:               <span class="number">183975</span></span><br><span class="line"> - http:<span class="comment">//192.168.10.103:7500/dev3/0/000/000/0000000036.fid</span></span><br><span class="line"> - http:<span class="comment">//192.168.10.102:7500/dev2/0/000/000/0000000036.fid</span></span><br><span class="line"> - http:<span class="comment">//192.168.10.101:7500/dev1/0/000/000/0000000036.fid</span></span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mogupload --trackers=<span class="number">192.168</span>.<span class="number">10.101</span>:<span class="number">7001</span> --domain=file --class=<span class="selector-tag">html</span> --key=<span class="string">'fstab.txt'</span> --file=<span class="string">'/etc/fstab'</span></span><br><span class="line">mogfileinfo --trackers=<span class="number">192.168</span>.<span class="number">10.101</span>:<span class="number">7001</span> --domain=file --key=<span class="string">'fstab.txt'</span></span><br><span class="line">- file: fstab.txt</span><br><span class="line">     class:                 html</span><br><span class="line">  devcount:                    <span class="number">3</span></span><br><span class="line">    domain:                 file</span><br><span class="line">       fid:                   <span class="number">38</span></span><br><span class="line">       key:           fstab.txt</span><br><span class="line">    length:                  <span class="number">529</span></span><br><span class="line"> - http:<span class="comment">//192.168.10.102:7500/dev2/0/000/000/0000000038.fid</span></span><br><span class="line"> - http:<span class="comment">//192.168.10.103:7500/dev3/0/000/000/0000000038.fid</span></span><br><span class="line"> - http:<span class="comment">//192.168.10.101:7500/dev1/0/000/000/0000000038.fid</span></span><br></pre></td></tr></table></figure>
<h1 id="如何解决MogileFS的无法复制-bug问题"><a href="#如何解决MogileFS的无法复制-bug问题" class="headerlink" title="如何解决MogileFS的无法复制 bug问题"></a>如何解决MogileFS的无法复制 bug问题</h1><p>注：MogileFS在centos7上有个致命的错误，就是没有复制副本到其他的节点上，解决如下（每台）<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum install -<span class="keyword">y</span> <span class="keyword">make</span> gcc unzip <span class="keyword">perl</span>-DBD-MySQL <span class="keyword">perl</span> <span class="keyword">perl</span>-CPAN <span class="keyword">perl</span>-YAML <span class="keyword">perl</span>-Time-HiRes</span><br><span class="line">wget http://pkgs.fedoraproject.org/repo/pkgs/<span class="keyword">perl</span>-Sys-Syscall/Sys-Syscall-<span class="number">0.23</span>.tar.gz/be6dc2d791684a6f8abb3dd39ff2d1de/Sys-Syscall-<span class="number">0.23</span>.tar.gz</span><br><span class="line">tar -xf Sys-Syscall-<span class="number">0.23</span>.tar.gz </span><br><span class="line"><span class="keyword">cd</span> Sys-Syscall-<span class="number">0.23</span>/</span><br><span class="line"><span class="keyword">perl</span> Makefile.PL</span><br><span class="line"><span class="keyword">make</span> &amp;&amp; <span class="keyword">make</span> install</span><br></pre></td></tr></table></figure></p>
<p>若mogilefs已配置运行，重启这两个服务，重新上传文件就可以生效<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">restart</span> mogilefsd </span><br><span class="line">systemctl <span class="built_in">restart</span> mogstoraged</span><br></pre></td></tr></table></figure></p>
<h1 id="MogileFS的只读模式和耗尽-Drain-模式"><a href="#MogileFS的只读模式和耗尽-Drain-模式" class="headerlink" title="MogileFS的只读模式和耗尽(Drain) 模式"></a>MogileFS的只读模式和耗尽(Drain) 模式</h1><p>如果你想要冻结设备上所有的文件,你要使用只读模式就行了。这将停掉 MogileFS 存放新文件到这个设备上，但它也将阻止删除文件，代替的删除的操作是会给这些内容放到队列中等待为您标记为’alive’着或’drain’。<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mogadm device <span class="selector-tag">mark</span> node1 <span class="number">1</span> readonly</span><br><span class="line">mogadm device <span class="selector-tag">mark</span> node2 <span class="number">2</span> drain</span><br></pre></td></tr></table></figure></p>
<p>耗尽(Drain) 模式, 在 2.40 和更高以上,告诉 MogileFS不会有新的文件应写入设备. 但是在耗尽(Drain) 模式文件可能被删除,所以如果你不希望写文件到这个设备上,可以设置为drain 的模式<br>注:耗尽(Drain) 模式在 MogileFS 的早期版本，将会从设备删除 FIDS现在它已经被重新均衡的功能取代。<br>重新复制文件<br>如果有一个硬盘坏了,MogileFS 可以自动的让请求不在访问这个设备,但是不会自动的重新复制这个硬盘的文件,你必须通过 mogadm 来手工来标志成 ‘dead’. 只要你这样做, MogileFS 将开始删除设备上的文件,并试图在集群间重新复制它们到其它的设备上.</p>
<h1 id="MogileFS的rebalance功能"><a href="#MogileFS的rebalance功能" class="headerlink" title="MogileFS的rebalance功能"></a>MogileFS的rebalance功能</h1><p>MogileFS的rebalance功能可以平衡各个storage节点磁盘的使用情况，将磁盘剩余空间很少的磁盘中的数据搬到磁盘剩余空间大的磁盘上，使磁盘的使用率基本达到平衡<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 dev1]#mogadm check</span><br><span class="line">Checking trackers<span class="built_in">..</span>.</span><br><span class="line">  192.168.10.101:7001 <span class="built_in">..</span>. OK</span><br><span class="line"></span><br><span class="line">Checking hosts<span class="built_in">..</span>.</span><br><span class="line">  [ 1] node1 <span class="built_in">..</span>. OK</span><br><span class="line">  [ 2] node2 <span class="built_in">..</span>. OK</span><br><span class="line">  [ 3] node3 <span class="built_in">..</span>. OK</span><br><span class="line"></span><br><span class="line">Checking devices<span class="built_in">..</span>.</span><br><span class="line">  host device         size(G)    used(G)    free(G)   use%   ob state   I/O%</span><br><span class="line">  ---- ------------ ---------- ---------- ---------- ------ ---------- -----</span><br><span class="line">  [ 1] dev1            49.976      0.039     49.936   0.08%  writeable   0.2</span><br><span class="line">  [ 2] dev2            49.976      0.531     49.445   1.06%  writeable   N/A</span><br><span class="line">  [ 3] dev3            49.976      0.065     49.911   0.13%  writeable   0.0</span><br><span class="line">[root@node1 app]#mogadm rebalance<span class="built_in"> policy </span><span class="attribute">--options</span>=<span class="string">"from_hosts=2 to_percent_free=99"</span> #设置rebalance策略，表示从设备id为2，搬到剩余空间为99%的存储设备</span><br><span class="line">[root@node1 app]#mogadm rebalance test #查看一下策略</span><br><span class="line">Tested rebalance policy<span class="built_in">..</span>.</span><br><span class="line">Policy: <span class="attribute">from_hosts</span>=2 <span class="attribute">to_percent_free</span>=99</span><br><span class="line">Source devices:</span><br><span class="line"> - 2</span><br><span class="line">Destination devices:</span><br><span class="line"> - 1</span><br><span class="line"> - 3</span><br><span class="line">[root@node1 app]#mogadm rebalance start #运行此策略</span><br><span class="line">[root@node1 app]#mogadm rebalance stop #停止rebalance策略</span><br></pre></td></tr></table></figure></p>
<h1 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h1><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">列出所有keys</span><br><span class="line">moglistkeys <span class="attribute">--trackers</span>=192.168.10.101:7001 <span class="attribute">--domain</span>=img</span><br><span class="line"></span><br><span class="line">列出所有fid</span><br><span class="line">moglistfids <span class="attribute">--trackers</span>=192.168.10.101:7001</span><br><span class="line"></span><br><span class="line">上传</span><br><span class="line">mogupload <span class="attribute">--trackers</span>=192.168.10.101:7001 <span class="attribute">--domain</span>=img <span class="attribute">--class</span>=jpeg <span class="attribute">--key</span>=<span class="string">'1.jpg'</span> <span class="attribute">--file</span>=<span class="string">'/root/clara.jpg'</span></span><br><span class="line"></span><br><span class="line">下载</span><br><span class="line">mogfetch <span class="attribute">--trackers</span>=192.168.10.101:7001 <span class="attribute">--domain</span>=img <span class="attribute">--key</span>=<span class="string">'1.jpg'</span> <span class="attribute">--file</span>=<span class="string">'1.jpg'</span></span><br><span class="line"></span><br><span class="line">查看</span><br><span class="line">mogfileinfo <span class="attribute">--trackers</span>=192.168.10.101:7001 <span class="attribute">--domain</span>=file <span class="attribute">--key</span>=<span class="string">'1.jpg'</span></span><br><span class="line"></span><br><span class="line">重命名</span><br><span class="line">mogrename <span class="attribute">--trackers</span>=192.168.10.101 <span class="attribute">--domain</span>=img <span class="attribute">--old_key</span>=<span class="string">'1.jpg'</span> <span class="attribute">--new_key</span>=<span class="string">'11.jpg'</span></span><br><span class="line"></span><br><span class="line">删除</span><br><span class="line">mogdelete <span class="attribute">--trackers</span>=192.168.10.101:7001 <span class="attribute">--domain</span>=img <span class="attribute">--key</span>=<span class="string">'11.jpg'</span></span><br><span class="line"></span><br><span class="line">查看状态、统计数据</span><br><span class="line">mogstats <span class="attribute">--db_dsn</span>=<span class="string">"DBI:mysql:mogilefs:host=192.168.10.101"</span> <span class="attribute">--db_user</span>=<span class="string">'mogilefs'</span> <span class="attribute">--db_pass</span>=<span class="string">'mogilefs'</span> --verbose <span class="attribute">--stats</span>=<span class="string">'devices,files'</span></span><br><span class="line">mogstats <span class="attribute">--db_dsn</span>=<span class="string">"DBI:mysql:mogilefs:host=192.168.10.101"</span> <span class="attribute">--db_user</span>=<span class="string">'mogilefs'</span> <span class="attribute">--db_pass</span>=<span class="string">'mogilefs'</span> --verbose <span class="attribute">--stats</span>=<span class="string">'all'</span></span><br></pre></td></tr></table></figure>
<h1 id="删除操作"><a href="#删除操作" class="headerlink" title="删除操作"></a>删除操作</h1><p><strong> 先删除文件 </strong> 全部<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mogdelete <span class="attribute">--trackers</span>=192.168.10.101:7001 <span class="attribute">--domain</span>=img <span class="attribute">--key</span>=<span class="string">'11.jpg'</span></span><br><span class="line"><span class="built_in">..</span>.</span><br></pre></td></tr></table></figure></p>
<p><strong> 删除类 </strong> 全部</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mogadm <span class="attribute">--trackers</span>=192.168.10.101:7001 class delete img jpg</span><br><span class="line"><span class="built_in">..</span>.</span><br></pre></td></tr></table></figure>
<p><strong> 删除域 </strong><br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mogadm <span class="built_in">domain</span> <span class="built_in">delete</span> img</span><br></pre></td></tr></table></figure></p>
<p><strong> 删除storaged节点 </strong><br><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mogadm --tracker=192.168.10.101:7001 host mark node3 down</span><br><span class="line">mogadm --tracker=192.168.10.101:7001 host delete node3</span><br><span class="line"><span class="keyword">Failure </span>deleting host: host_not_empty Unable to delete host; it contains devices still #需删除数据库信息，才能移除</span><br><span class="line"></span><br><span class="line">mysql -e "delete from mogilefs.device where hostid!=4"</span><br><span class="line">mogadm --tracker=192.168.10.101:7001 host delete node3</span><br></pre></td></tr></table></figure></p>
<h1 id="nginx-mogilefs-module"><a href="#nginx-mogilefs-module" class="headerlink" title="nginx-mogilefs-module"></a>nginx-mogilefs-module</h1><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> <span class="string">/usr/local/src/nginx_module</span></span><br><span class="line">wget http:<span class="string">//www.grid.net.ru/nginx/download/nginx_mogilefs_module-1.0.4.tar.gz</span></span><br><span class="line"><span class="string">./configure</span> <span class="params">--prefix=/usr/local/webserver/nginx</span> <span class="params">--with-file-aio</span> <span class="params">--with-poll_module</span> <span class="params">--with-http_realip_module</span> <span class="params">--with-http_image_filter_module</span> <span class="params">--with-http_gzip_static_module</span> <span class="params">--with-http_addition_module</span> <span class="params">--with-http_sub_module</span> <span class="params">--with-http_dav_module</span> <span class="params">--with-http_flv_module</span> <span class="params">--with-http_slice_module</span> <span class="params">--with-http_mp4_module</span> <span class="params">--with-http_random_index_module</span> <span class="params">--with-http_secure_link_module</span> <span class="params">--with-http_degradation_module</span> <span class="params">--with-http_ssl_module</span> <span class="params">--with-http_stub_status_module</span> <span class="params">--add-module=/usr/local/src/nginx_module/nginx_mogilefs_module-1</span>.0.4</span><br><span class="line">make </span><br><span class="line">sed -i 's<span class="comment">#^CFLAGS(.*)-Werror -g#CFLAGS\1-g#' objs/Makefile</span></span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<p><a href="http://www.grid.net.ru/nginx/mogilefs.en.html" target="_blank" rel="noopener">http://www.grid.net.ru/nginx/mogilefs.en.html</a><br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">upstream trackers &#123;</span><br><span class="line"> <span class="built_in"> server </span>192.168.10.101:7001;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server&#123;</span><br><span class="line">  listen       80;</span><br><span class="line">  server_name 192.168.10.101;</span><br><span class="line"></span><br><span class="line">  location /upload/img/ &#123;</span><br><span class="line">      allow 192.168.2.0/24;</span><br><span class="line">      deny all;</span><br><span class="line"></span><br><span class="line">      mogilefs_tracker trackers;</span><br><span class="line">      #mogilefs_domain img;</span><br><span class="line">      mogilefs_methods <span class="builtin-name">GET</span> PUT DELETE;</span><br><span class="line">      #mogilefs_class jpeg png;</span><br><span class="line">      mogilefs_noverify on;</span><br><span class="line">      mogilefs_pass &#123;</span><br><span class="line">          proxy_pass <span class="variable">$mogilefs_path</span>;</span><br><span class="line">          proxy_hide_header Content-Type;</span><br><span class="line">          proxy_buffering off;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  location /upload/file/ &#123;</span><br><span class="line">      mogilefs_tracker 192.168.10.101:7001;</span><br><span class="line">      mogilefs_domain file;</span><br><span class="line">      mogilefs_methods <span class="builtin-name">GET</span> PUT DELETE;</span><br><span class="line">      mogilefs_noverify on;</span><br><span class="line">      mogilefs_pass &#123;</span><br><span class="line">          proxy_pass <span class="variable">$mogilefs_path</span>;</span><br><span class="line">          proxy_hide_header Content-Type;</span><br><span class="line">          proxy_buffering off;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>访问：<br><a href="http://192.168.10.101/upload/img/1.jpg" target="_blank" rel="noopener">http://192.168.10.101/upload/img/1.jpg</a><br><a href="http://192.168.10.101/upload/file/fstab.txt" target="_blank" rel="noopener">http://192.168.10.101/upload/file/fstab.txt</a><br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -X PUT -T <span class="string">'./3.jpg'</span> <span class="symbol">http:</span>/<span class="regexp">/192.168.10.101/upload</span><span class="regexp">/img/</span><span class="number">3</span>.jpg <span class="comment">#上传不能实现 </span></span><br><span class="line">curl -X DELETE <span class="symbol">http:</span>/<span class="regexp">/192.168.10.101/upload</span><span class="regexp">/img/</span><span class="number">1</span>.jpg <span class="comment">#删除可以实现的</span></span><br></pre></td></tr></table></figure></p>
<h1 id="坑"><a href="#坑" class="headerlink" title="坑"></a>坑</h1><p>若上传的--key指定/,则nginx localtion img后不带/<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mogupload <span class="attribute">--trackers</span>=192.168.10.101:7001 <span class="attribute">--domain</span>=img <span class="attribute">--class</span>=jpeg <span class="attribute">--key</span>=<span class="string">'2.jpg'</span> <span class="attribute">--file</span>=<span class="string">'/root/clara.jpg'</span></span><br><span class="line">location ~* /img &#123;</span><br><span class="line"><span class="built_in">..</span>.</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>若上传的--key未指定/,则localtion ~* /img { } img需带/<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mogupload <span class="attribute">--trackers</span>=192.168.10.101:7001 <span class="attribute">--domain</span>=img <span class="attribute">--class</span>=jpeg <span class="attribute">--key</span>=<span class="string">'2.jpg'</span> <span class="attribute">--file</span>=<span class="string">'/root/clara.jpg'</span></span><br><span class="line">location ~* /img/ &#123;</span><br><span class="line"><span class="built_in">..</span>.</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="报错解决"><a href="#报错解决" class="headerlink" title="报错解决"></a>报错解决</h1><p>启动报错<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">journalctl -xe</span><br><span class="line">Sep <span class="number">07</span> <span class="number">11</span>:<span class="number">48</span>:<span class="number">08</span> node1 systemd[<span class="number">1</span>]: PID file /var/<span class="keyword">run</span><span class="bash">/mogilefsd/mogstoraged.pid not readable (yet?) after start.</span></span><br><span class="line"><span class="bash">Sep 07 11:48:08 node1 systemd[1]: Failed to start SYSV: MogileFS storage.</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">解决：</span></span><br><span class="line"><span class="bash">mkdir /var/run/mogilefsd/</span></span><br><span class="line"><span class="bash">chown -R mogilefs.mogilefs /var/run/mogilefsd/</span></span><br></pre></td></tr></table></figure></p>
<p>nginx-mogilefs-module报错<br><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/<span class="string">usr/</span><span class="string">local/</span><span class="string">src/</span><span class="string">nginx_module/</span><span class="string">nginx_module/</span><span class="string">nginx_mogilefs_module-1.</span>0.4/<span class="string">ngx_http_mogilefs_module.</span>c: <span class="string">In </span><span class="string">function </span>‘<span class="string">ngx_http_mogilefs_create_request’</span>:</span><br><span class="line">/<span class="string">usr/</span><span class="string">local/</span><span class="string">src/</span><span class="string">nginx_module/</span><span class="string">nginx_module/</span><span class="string">nginx_mogilefs_module-1.</span>0.<span class="string">4ngx_http_mogilefs_module.</span><span class="string">c:748:</span><span class="string">37:</span> <span class="string">error:</span> <span class="string">variable </span>‘<span class="string">request’</span> <span class="string">set </span><span class="string">but </span><span class="string">not </span><span class="string">used </span>[-<span class="string">Werror=</span><span class="string">unused-but-</span><span class="built_in">set-variable]</span></span><br><span class="line"><span class="built_in"></span>     <span class="string">ngx_str_t </span>                      <span class="string">request,</span> <span class="string">domain;</span></span><br><span class="line">                                     ^</span><br><span class="line">/<span class="string">usr/</span><span class="string">local/</span><span class="string">src/</span><span class="string">nginx_module/</span><span class="string">nginx_module/</span><span class="string">nginx_mogilefs_module-1.</span>0.4/<span class="string">ngx_http_mogilefs_module.</span>c: <span class="string">In </span><span class="string">function </span>‘<span class="string">ngx_http_mogilefs_create_spare_location’</span>:</span><br><span class="line">/<span class="string">usr/</span><span class="string">local/</span><span class="string">src/</span><span class="string">nginx_module/</span><span class="string">nginx_module/</span><span class="string">nginx_mogilefs_module-1.</span>0.4/<span class="string">ngx_http_mogilefs_module.</span><span class="string">c:1541:</span><span class="string">39:</span> <span class="string">error:</span> <span class="string">variable </span>‘<span class="string">pclcf’</span> <span class="string">set </span><span class="string">but </span><span class="string">not </span><span class="string">used </span>[-<span class="string">Werror=</span><span class="string">unused-but-</span><span class="built_in">set-variable]</span></span><br><span class="line"><span class="built_in"></span>     <span class="string">ngx_http_core_loc_conf_t </span> *<span class="string">clcf,</span> *<span class="string">pclcf,</span> *<span class="string">rclcf;</span></span><br><span class="line"></span><br><span class="line"><span class="string">vim </span><span class="string">objs/</span><span class="string">Makefile</span></span><br><span class="line"><span class="string">CFLAGS </span>=  -<span class="string">pipe </span> -O -W -<span class="string">Wall </span>-<span class="string">Wpointer-arith </span>-<span class="string">Wno-unused-</span><span class="string">parameter </span>-<span class="string">Werror </span>-g</span><br><span class="line">修改为</span><br><span class="line"><span class="string">CFLAGS </span>=  -<span class="string">pipe </span> -O -W -<span class="string">Wall </span>-<span class="string">Wpointer-arith </span>-<span class="string">Wno-unused-</span><span class="string">parameter </span>-g</span><br></pre></td></tr></table></figure></p>
<p><a href="https://www.jianshu.com/p/f3b47de0d9c0" target="_blank" rel="noopener">https://www.jianshu.com/p/f3b47de0d9c0</a></p>


                <hr>

                

                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/distributed-file-system-fastdfs/" data-toggle="tooltip" data-placement="top" title="分布式文件系统FastDFS详解">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/glusterfs/" data-toggle="tooltip" data-placement="top" title="企业级分布式存储 Glusterfs">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                

                

            </div>
    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->

            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#分布式" title="分布式">分布式</a>
                        
                          <a class="tag" href="/tags/#mogilefs" title="mogilefs">mogilefs</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="https://jaminzhang.github.io" target="_blank">JAMIN ZHANG</a></li>
                    
                        <li><a href="#" target="_blank">It helps SEO</a></li>
                    
                </ul>
                
            </div>

        </div>
    </div>
</article>







<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                

                

                

                
                    <li>
                        <a target="_blank"  href="https://github.com/sundayle">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Sunday 2019 
                    <br>
                    Theme by <a href="http://huangxuan.me">Hux</a> 
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span>
                    Ported by <a href="https://github.com/Kaijun/hexo-theme-huxblog">Kaijun</a>
            <!-- 
                    Ported by <a href="http://blog.kaijun.rocks">Kaijun</a> | 
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=kaijun&repo=hexo-theme-huxblog&type=star&count=true" >
                    </iframe>
            -->
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
     async("https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->


<script>
    // dynamic User by Hux
    var _gaId = 'UA-70699634-1';
    var _gaDomain = 'auto';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>




<!-- Baidu Tongji -->


<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog (selector) {
        var P = $('div.post-container'),a,n,t,l,i,c;
        a = P.find('h1,h2,h3,h4,h5,h6');
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#"+$(this).prop('id');
            t = $(this).text();
            c = $('<a href="'+i+'" rel="nofollow">'+t+'</a>');
            l = $('<li class="'+n+'_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;    
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function(e){
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>





<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
